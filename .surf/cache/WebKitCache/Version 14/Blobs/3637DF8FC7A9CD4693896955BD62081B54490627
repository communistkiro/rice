System.register("src/gui/base/TimePicker.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","./TextFieldN","../theme","../../calendar/CalendarUtils","../../misc/ClientDetector"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,TextFieldN,TextFieldType,theme,parseTime,timeStringFromParts,client,TimePicker;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_TextFieldN){TextFieldN=_TextFieldN.TextFieldN,TextFieldType=_TextFieldN.Type},function(_theme){theme=_theme.theme},function(_calendarCalendarUtils){parseTime=_calendarCalendarUtils.parseTime,timeStringFromParts=_calendarCalendarUtils.timeStringFromParts},function(_miscClientDetector){client=_miscClientDetector.client}],execute:function(){_export("TimePicker",TimePicker=function(){function TimePicker(_ref){var attrs=_ref.attrs;_classCallCheck(this,TimePicker),this._focused=!1;for(var times=[],hour=0;hour<24;hour++)for(var minute=0;minute<60;minute+=30)times.push(timeStringFromParts(hour,minute,attrs.amPmFormat));this._values=times}return _createClass(TimePicker,[{key:"view",value:function(_ref2){var _this=this,attrs=_ref2.attrs,parsedTime=parseTime(attrs.value());return parsedTime&&(this._previousSelectedIndex=this._selectedIndex,this._selectedIndex=this._values.indexOf(timeStringFromParts(parsedTime.hours,parsedTime.minutes,attrs.amPmFormat))),client.isMobileDevice()?(this._oldValue!==attrs.value()&&this._onSelected(attrs),this._oldValue=attrs.value(),m(TextFieldN,{label:"emptyString_msg",value:stream(parsedTime&&timeStringFromParts(parsedTime.hours,parsedTime.minutes,!1)||""),type:TextFieldType.Time,oninput:function(value){return attrs.value(value)},disabled:attrs.disabled})):[m(TextFieldN,{label:"emptyString_msg",value:attrs.value,disabled:attrs.disabled,onfocus:function(dom,input){_this._focused=!0,input.select()},onblur:function(e){_this._focused&&_this._onSelected(attrs),e.redraw=!1},keyHandler:function(key){return 13===key.keyCode&&(_this._onSelected(attrs),document.activeElement&&document.activeElement.blur()),!0}}),this._focused?m(".fixed.flex.col.mt-s",{oncreate:function(vnode){return _this._setScrollTop(attrs,vnode)},onupdate:function(vnode){return _this._setScrollTop(attrs,vnode)},style:{width:"100px",height:"400px","z-index":"3",background:theme.content_bg,overflow:"auto","box-shadow":"0 4px 5px 2px rgba(0,0,0,0.14), 0 4px 5px 2px rgba(0,0,0,0.14), 0 4px 5px 2px rgba(0,0,0,0.14)"}},this._values.map(function(t,i){return m("pr-s.pl-s.darker-hover",{key:t,style:{"background-color":_this._selectedIndex===i?theme.list_bg:theme.list_alternate_bg,flex:"1 0 auto","line-height":"44px"},onmousedown:function(){_this._focused=!1,attrs.onselected(t)}},t)})):null]}},{key:"_onSelected",value:function(attrs){this._focused=!1;var parsedTime=parseTime(attrs.value()),timeString=parsedTime&&timeStringFromParts(parsedTime.hours,parsedTime.minutes,attrs.amPmFormat);attrs.onselected(timeString||attrs.value())}},{key:"_setScrollTop",value:function(attrs,vnode){var _this2=this;-1!==this._selectedIndex&&requestAnimationFrame(function(){vnode.dom.scrollTop=44*_this2._selectedIndex})}}]),TimePicker}()),_export("TimePicker",TimePicker)}}}),System.register("src/calendar/CalendarEventDialog.js",["../api/common/utils/DateUtils","mithril/stream/stream.js","../gui/base/DatePicker","../gui/base/Dialog","./CalendarView","mithril","../gui/base/TextFieldN","../gui/base/CheckboxN","../misc/LanguageViewModel","../gui/base/DropDownSelectorN","../gui/base/icons/Icons","../api/entities/tutanota/CalendarEvent","../api/main/Entity","../api/common/utils/Utils","../gui/base/ButtonN","../api/common/TutanotaConstants","../api/common/utils/ArrayUtils","./CalendarModel","luxon","../api/entities/sys/AlarmInfo","../api/common/EntityFunctions","../api/main/LoginController","../api/entities/sys/UserAlarmInfo","./CalendarUtils","../api/common/utils/CommonCalendarUtils","../api/main/WorkerClient","../api/common/error/RestError","../gui/base/TimePicker","../misc/WindowFacade","../misc/ClientDetector"],function(_export,_context){"use strict";var incrementDate,stream,DatePicker,Dialog,LIMIT_PAST_EVENTS_YEARS,m,TextFieldN,Type,CheckboxN,lang,DropDownSelectorN,Icons,createCalendarEvent,erase,load,downcast,neverNull,noOp,ButtonN,ButtonType,AlarmInterval,EndType,RepeatPeriod,ShareCapability,TimeFormat,last,lastThrow,numberRange,remove,incrementByRepeatPeriod,DateTime,createAlarmInfo,isSameId,listIdPart,logins,UserAlarmInfoTypeRef,createEventId,createRepeatRuleWithValues,generateUid,getAllDayDateForTimezone,getAllDayDateUTCFromZone,getCalendarName,getDiffInDays,getEventEnd,getEventStart,getStartOfDayWithZone,getStartOfNextDayWithZone,getStartOfTheWeekOffsetForUser,getTimeZone,hasCapabilityOnGroup,parseTime,timeString,timeStringFromParts,generateEventElementId,isAllDayEvent,worker,NotFoundError,TimePicker,windowFacade,client,TIMESTAMP_ZERO_YEAR,intervalValues;function createCalendarAlarm(identifier,trigger){var calendarAlarmInfo=createAlarmInfo();return calendarAlarmInfo.alarmIdentifier=identifier,calendarAlarmInfo.trigger=trigger,calendarAlarmInfo}function createEndCountPicker(){return{label:"emptyString_msg",items:intervalValues,selectedValue:stream(intervalValues[0].value),icon:Icons.Edit}}return _export("showCalendarEventDialog",function(date,calendars,existingEvent){var summary=stream(""),calendarArray=Array.from(calendars.values()),readOnly=!1;if(existingEvent){var calendarInfoForEvent=calendars.get(neverNull(existingEvent._ownerGroup));calendarInfoForEvent&&(readOnly=!hasCapabilityOnGroup(logins.getUserController().user,calendarInfoForEvent.group,ShareCapability.Write))}else calendarArray=calendarArray.filter(function(calendarInfo){return hasCapabilityOnGroup(logins.getUserController().user,calendarInfo.group,ShareCapability.Write)});var zone=getTimeZone(),selectedCalendar=stream(calendarArray[0]),startOfTheWeekOffset=getStartOfTheWeekOffsetForUser(),startDatePicker=new DatePicker(startOfTheWeekOffset,"dateFrom_label","emptyString_msg",!0,readOnly);startDatePicker.setDate(getStartOfDayWithZone(date,zone));var disabled,repeatValues,endDatePicker=new DatePicker(startOfTheWeekOffset,"dateTo_label","emptyString_msg",!0,readOnly),amPmFormat=logins.getUserController().userSettingsGroupRoot.timeFormat===TimeFormat.TWELVE_HOURS,startTime=stream(timeString(date,amPmFormat)),endTime=stream(),allDay=stream(!1),locationValue=stream(""),notesValue=stream(""),repeatPickerAttrs=(disabled=readOnly,{label:"calendarRepeating_label",items:repeatValues=[{name:lang.get("calendarRepeatIntervalNoRepeat_label"),value:null},{name:lang.get("calendarRepeatIntervalDaily_label"),value:RepeatPeriod.DAILY},{name:lang.get("calendarRepeatIntervalWeekly_label"),value:RepeatPeriod.WEEKLY},{name:lang.get("calendarRepeatIntervalMonthly_label"),value:RepeatPeriod.MONTHLY},{name:lang.get("calendarRepeatIntervalAnnually_label"),value:RepeatPeriod.ANNUALLY}],selectedValue:stream(repeatValues[0].value),icon:Icons.Edit,disabled:disabled}),repeatIntervalPickerAttrs=function(disabled){return{label:"interval_title",items:intervalValues,selectedValue:stream(intervalValues[0].value),icon:Icons.Edit,disabled:disabled}}(readOnly),endTypePickerAttrs=function(disabled){var stopConditionValues=[{name:lang.get("calendarRepeatStopConditionNever_label"),value:EndType.Never},{name:lang.get("calendarRepeatStopConditionOccurrences_label"),value:EndType.Count},{name:lang.get("calendarRepeatStopConditionDate_label"),value:EndType.UntilDate}];return{label:function(){return lang.get("calendarRepeatStopCondition_label")},items:stopConditionValues,selectedValue:stream(stopConditionValues[0].value),icon:Icons.Edit,disabled:disabled}}(readOnly),repeatEndDatePicker=new DatePicker(startOfTheWeekOffset,"emptyString_msg","emptyString_msg",!0),endCountPickerAttrs=createEndCountPicker(),alarmPickerAttrs=[],alarmIntervalItems=[{name:lang.get("comboBoxSelectionNone_msg"),value:null},{name:lang.get("calendarReminderIntervalFiveMinutes_label"),value:AlarmInterval.FIVE_MINUTES},{name:lang.get("calendarReminderIntervalTenMinutes_label"),value:AlarmInterval.TEN_MINUTES},{name:lang.get("calendarReminderIntervalThirtyMinutes_label"),value:AlarmInterval.THIRTY_MINUTES},{name:lang.get("calendarReminderIntervalOneHour_label"),value:AlarmInterval.ONE_HOUR},{name:lang.get("calendarReminderIntervalOneDay_label"),value:AlarmInterval.ONE_DAY},{name:lang.get("calendarReminderIntervalTwoDays_label"),value:AlarmInterval.TWO_DAYS},{name:lang.get("calendarReminderIntervalThreeDays_label"),value:AlarmInterval.THREE_DAYS},{name:lang.get("calendarReminderIntervalOneWeek_label"),value:AlarmInterval.ONE_WEEK}];alarmPickerAttrs.push(function createAlarmPicker(){var selectedValue=stream(null),attrs={label:function(){return lang.get("reminderBeforeEvent_label")},items:alarmIntervalItems,selectedValue:selectedValue,icon:Icons.Edit};return selectedValue.map(function(v){var lastAttrs=last(alarmPickerAttrs);attrs===lastAttrs&&null!=selectedValue()?alarmPickerAttrs.push(createAlarmPicker()):null==v&&alarmPickerAttrs.some(function(a){return a!==attrs&&null==a.selectedValue()})&&remove(alarmPickerAttrs,attrs)}),attrs}());var user=logins.getUserController().user;if(existingEvent){summary(existingEvent.summary);var calendarForGroup=calendars.get(neverNull(existingEvent._ownerGroup));if(calendarForGroup&&selectedCalendar(calendarForGroup),startTime(timeString(getEventStart(existingEvent,zone),amPmFormat)),allDay(existingEvent&&isAllDayEvent(existingEvent)),allDay()?endDatePicker.setDate(incrementDate(getEventEnd(existingEvent,zone),-1)):endDatePicker.setDate(getStartOfDayWithZone(getEventEnd(existingEvent,zone),zone)),endTime(timeString(getEventEnd(existingEvent,zone),amPmFormat)),existingEvent.repeatRule){var existingRule=existingEvent.repeatRule;if(repeatPickerAttrs.selectedValue(downcast(existingRule.frequency)),repeatIntervalPickerAttrs.selectedValue(Number(existingRule.interval)),endTypePickerAttrs.selectedValue(downcast(existingRule.endType)),endCountPickerAttrs.selectedValue(existingRule.endType===EndType.Count?Number(existingRule.endValue):1),existingRule.endType===EndType.UntilDate){var rawEndDate=new Date(Number(existingRule.endValue)),localDate=allDay()?getAllDayDateForTimezone(rawEndDate,zone):rawEndDate,shownDate=incrementByRepeatPeriod(localDate,RepeatPeriod.DAILY,-1,zone);repeatEndDatePicker.setDate(shownDate)}else repeatEndDatePicker.setDate(null)}else repeatPickerAttrs.selectedValue(null);locationValue(existingEvent.location),notesValue(existingEvent.description);var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=existingEvent.alarmInfos[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var alarmInfoId=_step.value;isSameId(listIdPart(alarmInfoId),neverNull(user.alarmInfoList).alarms)&&load(UserAlarmInfoTypeRef,alarmInfoId).then(function(userAlarmInfo){lastThrow(alarmPickerAttrs).selectedValue(downcast(userAlarmInfo.alarmInfo.trigger)),m.redraw()})}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}else{var endTimeDate=new Date(date);endTimeDate.setMinutes(endTimeDate.getMinutes()+30),endDatePicker.setDate(getStartOfDayWithZone(date,zone)),endTime(timeString(endTimeDate,amPmFormat)),m.redraw()}endTypePickerAttrs.selectedValue.map(function(endType){if(endType===EndType.UntilDate&&!repeatEndDatePicker.date()){var newRepeatEnd=incrementByRepeatPeriod(neverNull(startDatePicker.date()),neverNull(repeatPickerAttrs.selectedValue()),neverNull(repeatIntervalPickerAttrs.selectedValue()),DateTime.local().zoneName);repeatEndDatePicker.setDate(newRepeatEnd)}});var eventTooOld=!1;stream.scan(function(oldStartDate,startDate){if(startDate&&startDate.getFullYear()<TIMESTAMP_ZERO_YEAR){var thisYear=(new Date).getFullYear(),newDate=new Date(startDate);return newDate.setFullYear(thisYear),startDatePicker.setDate(newDate),newDate}var endDate=endDatePicker.date();if(eventTooOld=!!startDate&&-DateTime.fromJSDate(startDate).diffNow("year").years>LIMIT_PAST_EVENTS_YEARS,startDate&&endDate){var diff=getDiffInDays(endDate,neverNull(oldStartDate));endDatePicker.setDate(DateTime.fromJSDate(startDate).plus({days:diff}).toJSDate())}return startDate},startDatePicker.date(),startDatePicker.date);var oldStartTime=startTime();function onStartTimeSelected(value){startTime(value);var startDate=neverNull(startDatePicker.date()),endDate=neverNull(endDatePicker.date());startDate.getTime()===endDate.getTime()&&function(){var parsedOldStartTime=oldStartTime&&parseTime(oldStartTime),parsedStartTime=parseTime(startTime()),parsedEndTime=parseTime(endTime());if(parsedStartTime&&parsedEndTime&&parsedOldStartTime){var endTotalMinutes=60*parsedEndTime.hours+parsedEndTime.minutes,startTotalMinutes=60*parsedStartTime.hours+parsedStartTime.minutes,diff=Math.abs(endTotalMinutes-60*parsedOldStartTime.hours-parsedOldStartTime.minutes),newEndTotalMinutes=startTotalMinutes+diff,newEndHours=Math.floor(newEndTotalMinutes/60);newEndHours>23&&(newEndHours=23),endTime(timeStringFromParts(newEndHours,newEndTotalMinutes%60,amPmFormat)),oldStartTime=startTime(),m.redraw()}}()}var windowCloseUnsubscribe=void 0,dialog=Dialog.createActionDialog({title:function(){return lang.get("createEvent_label")},child:function(){return m("",{oncreate:function(vnode){return windowCloseUnsubscribe=windowFacade.addWindowCloseListener(function(){})},onremove:function(vnode){return windowCloseUnsubscribe()}},[m(TextFieldN,{label:"title_placeholder",value:summary,disabled:readOnly}),m(".flex",[m(".flex-grow.mr-s",m(startDatePicker)),allDay()?null:m(".time-field",m(TimePicker,{value:startTime,onselected:onStartTimeSelected,amPmFormat:amPmFormat,disabled:readOnly}))]),m(".flex",[m(".flex-grow.mr-s",m(endDatePicker)),allDay()?null:m(".time-field",m(TimePicker,{value:endTime,onselected:endTime,amPmFormat:amPmFormat,disabled:readOnly}))]),m(CheckboxN,{checked:allDay,disabled:readOnly,label:function(){return lang.get("allDay_label")}}),eventTooOld?null:[m(".flex",[m(".flex-grow",m(DropDownSelectorN,repeatPickerAttrs)),m(".flex-grow.ml-s"+(repeatPickerAttrs.selectedValue()?"":".hidden"),m(DropDownSelectorN,repeatIntervalPickerAttrs))]),repeatPickerAttrs.selectedValue()?m(".flex",[m(".flex-grow",m(DropDownSelectorN,endTypePickerAttrs)),m(".flex-grow.ml-s",null==repeatPickerAttrs.selectedValue()||endTypePickerAttrs.selectedValue()===EndType.Never?null:endTypePickerAttrs.selectedValue()===EndType.Count?m(DropDownSelectorN,endCountPickerAttrs):endTypePickerAttrs.selectedValue()===EndType.UntilDate?m(repeatEndDatePicker):null)]):null],readOnly?null:m(".flex.col.mt.mb",alarmPickerAttrs.map(function(attrs){return m(DropDownSelectorN,attrs)})),m(DropDownSelectorN,{label:"calendar_label",items:calendarArray.map(function(calendarInfo){return{name:getCalendarName(calendarInfo.groupInfo,calendarInfo.shared),value:calendarInfo}}),selectedValue:selectedCalendar,icon:Icons.Edit,disabled:readOnly}),m(TextFieldN,{label:"location_label",value:locationValue,disabled:readOnly,injectionsRight:function(){var address=encodeURIComponent(locationValue());return""==address?null:m(ButtonN,{label:"showAddress_alt",icon:function(){return Icons.Pin},click:function(){window.open("https://www.openstreetmap.org/search?query="+address,"_blank")}})}}),m(TextFieldN,{label:"description_label",value:notesValue,type:Type.Area,disabled:readOnly}),existingEvent&&!readOnly?m(".mr-negative-s.float-right.flex-end-on-child",m(ButtonN,{label:"delete_action",type:ButtonType.Primary,click:function(){(neverNull(existingEvent).repeatRule?Dialog.confirm("deleteRepeatingEventConfirmation_msg"):Promise.resolve(!0)).then(function(answer){answer&&(erase(existingEvent).catch(NotFoundError,noOp),dialog.close())})}})):null])},okAction:readOnly?null:function(dialog){return requestAnimationFrame(function(){return function(dialog){var newEvent=createCalendarEvent();if(startDatePicker.date()&&endDatePicker.date()){var startDate=new Date(neverNull(startDatePicker.date())),endDate=new Date(neverNull(endDatePicker.date()));if(allDay())startDate=getAllDayDateUTCFromZone(startDate,zone),endDate=getAllDayDateUTCFromZone(getStartOfNextDayWithZone(endDate,zone),zone);else{var parsedStartTime=parseTime(startTime()),parsedEndTime=parseTime(endTime());if(!parsedStartTime||!parsedEndTime)return void Dialog.error("timeFormatInvalid_msg");startDate.setHours(parsedStartTime.hours),startDate.setMinutes(parsedStartTime.minutes),endDate.setHours(parsedEndTime.hours),endDate.setMinutes(parsedEndTime.minutes)}if(endDate.getTime()<=startDate.getTime())Dialog.error("startAfterEnd_label");else{newEvent.startTime=startDate,newEvent.description=notesValue(),newEvent.summary=summary(),newEvent.location=locationValue(),newEvent.endTime=endDate;var groupRoot=selectedCalendar().groupRoot;newEvent._ownerGroup=selectedCalendar().groupRoot._id,newEvent.uid=existingEvent&&existingEvent.uid?existingEvent.uid:generateUid(newEvent,Date.now());var repeatFrequency=repeatPickerAttrs.selectedValue();if(null==repeatFrequency||eventTooOld)newEvent.repeatRule=null;else{var interval=repeatIntervalPickerAttrs.selectedValue()||1,repeatRule=createRepeatRuleWithValues(repeatFrequency,interval);newEvent.repeatRule=repeatRule;var stopType=neverNull(endTypePickerAttrs.selectedValue());if(repeatRule.endType=stopType,stopType===EndType.Count){var count=endCountPickerAttrs.selectedValue();isNaN(count)||Number(count)<1?repeatRule.endType=EndType.Never:repeatRule.endValue=String(count)}else if(stopType===EndType.UntilDate){var repeatEndDate=getStartOfNextDayWithZone(neverNull(repeatEndDatePicker.date()),zone);if(repeatEndDate.getTime()<getEventStart(newEvent,zone))return void Dialog.error("startAfterEnd_label");repeatRule.endValue=String((allDay()?getAllDayDateUTCFromZone(repeatEndDate,zone):repeatEndDate).getTime())}}var newAlarms=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=alarmPickerAttrs[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var alarmValue=_step2.value.selectedValue();if(alarmValue){var newAlarm=createCalendarAlarm(generateEventElementId(Date.now()),alarmValue);newAlarms.push(newAlarm)}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}null!=existingEvent&&existingEvent._ownerGroup===newEvent._ownerGroup&&newEvent.startTime.getTime()===existingEvent.startTime.getTime()&&function(repeatRule,repeatRule2){return null==repeatRule&&null==repeatRule2||null!=repeatRule&&null!=repeatRule2&&repeatRule.endType===repeatRule2.endType&&repeatRule.endValue===repeatRule2.endValue&&repeatRule.frequency===repeatRule2.frequency&&repeatRule.interval===repeatRule2.interval&&repeatRule.timeZone===repeatRule2.timeZone}(newEvent.repeatRule,existingEvent.repeatRule)?worker.updateCalendarEvent(newEvent,newAlarms,existingEvent):(createEventId(newEvent,zone,groupRoot),worker.createCalendarEvent(newEvent,newAlarms,existingEvent)),dialog.close()}}else Dialog.error("timeFormatInvalid_msg")}(dialog)})}});client.isMobileDevice()&&dialog.setFocusOnLoadFunction(function(){}),dialog.show()}),_export("createEndCountPicker",createEndCountPicker),{setters:[function(_apiCommonUtilsDateUtils){incrementDate=_apiCommonUtilsDateUtils.incrementDate},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseDatePicker){DatePicker=_guiBaseDatePicker.DatePicker},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_CalendarView){LIMIT_PAST_EVENTS_YEARS=_CalendarView.LIMIT_PAST_EVENTS_YEARS},function(_mithril){m=_mithril.default},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN,Type=_guiBaseTextFieldN.Type},function(_guiBaseCheckboxN){CheckboxN=_guiBaseCheckboxN.CheckboxN},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiEntitiesTutanotaCalendarEvent){createCalendarEvent=_apiEntitiesTutanotaCalendarEvent.createCalendarEvent},function(_apiMainEntity){erase=_apiMainEntity.erase,load=_apiMainEntity.load},function(_apiCommonUtilsUtils){downcast=_apiCommonUtilsUtils.downcast,neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_apiCommonTutanotaConstants){AlarmInterval=_apiCommonTutanotaConstants.AlarmInterval,EndType=_apiCommonTutanotaConstants.EndType,RepeatPeriod=_apiCommonTutanotaConstants.RepeatPeriod,ShareCapability=_apiCommonTutanotaConstants.ShareCapability,TimeFormat=_apiCommonTutanotaConstants.TimeFormat},function(_apiCommonUtilsArrayUtils){last=_apiCommonUtilsArrayUtils.last,lastThrow=_apiCommonUtilsArrayUtils.lastThrow,numberRange=_apiCommonUtilsArrayUtils.numberRange,remove=_apiCommonUtilsArrayUtils.remove},function(_CalendarModel){incrementByRepeatPeriod=_CalendarModel.incrementByRepeatPeriod},function(_luxon){DateTime=_luxon.DateTime},function(_apiEntitiesSysAlarmInfo){createAlarmInfo=_apiEntitiesSysAlarmInfo.createAlarmInfo},function(_apiCommonEntityFunctions){isSameId=_apiCommonEntityFunctions.isSameId,listIdPart=_apiCommonEntityFunctions.listIdPart},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiEntitiesSysUserAlarmInfo){UserAlarmInfoTypeRef=_apiEntitiesSysUserAlarmInfo.UserAlarmInfoTypeRef},function(_CalendarUtils){createEventId=_CalendarUtils.createEventId,createRepeatRuleWithValues=_CalendarUtils.createRepeatRuleWithValues,generateUid=_CalendarUtils.generateUid,getAllDayDateForTimezone=_CalendarUtils.getAllDayDateForTimezone,getAllDayDateUTCFromZone=_CalendarUtils.getAllDayDateUTCFromZone,getCalendarName=_CalendarUtils.getCalendarName,getDiffInDays=_CalendarUtils.getDiffInDays,getEventEnd=_CalendarUtils.getEventEnd,getEventStart=_CalendarUtils.getEventStart,getStartOfDayWithZone=_CalendarUtils.getStartOfDayWithZone,getStartOfNextDayWithZone=_CalendarUtils.getStartOfNextDayWithZone,getStartOfTheWeekOffsetForUser=_CalendarUtils.getStartOfTheWeekOffsetForUser,getTimeZone=_CalendarUtils.getTimeZone,hasCapabilityOnGroup=_CalendarUtils.hasCapabilityOnGroup,parseTime=_CalendarUtils.parseTime,timeString=_CalendarUtils.timeString,timeStringFromParts=_CalendarUtils.timeStringFromParts},function(_apiCommonUtilsCommonCalendarUtils){generateEventElementId=_apiCommonUtilsCommonCalendarUtils.generateEventElementId,isAllDayEvent=_apiCommonUtilsCommonCalendarUtils.isAllDayEvent},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiBaseTimePicker){TimePicker=_guiBaseTimePicker.TimePicker},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_miscClientDetector){client=_miscClientDetector.client}],execute:function(){TIMESTAMP_ZERO_YEAR=1970,intervalValues=numberRange(1,256).map(function(n){return{name:String(n),value:n}})}}}),System.register("src/calendar/CalendarMonthView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/size","../api/common/TutanotaConstants","./CalendarEventBubble","./CalendarUtils","../api/common/utils/DateUtils","../api/common/utils/ArrayUtils","../gui/theme","./ContinuingCalendarEventBubble","../gui/styles","../misc/Formatter","../api/common/utils/CommonCalendarUtils","../misc/WindowFacade","../api/common/utils/Utils","../gui/base/Icon","../gui/base/icons/Icons","../gui/base/PageView"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,px,size,EventTextTimeOption,CalendarEventBubble,CALENDAR_EVENT_HEIGHT,getAllDayDateForTimezone,getCalendarMonth,getDiffInDays,getEventColor,getEventEnd,getStartOfDayWithZone,getStartOfNextDayWithZone,getStartOfTheWeekOffset,getTimeZone,getWeekNumber,layOutEvents,getDateIndicator,incrementDate,lastThrow,theme,ContinuingCalendarEventBubble,styles,formatMonthWithFullYear,isAllDayEvent,isAllDayEventByTimes,windowFacade,neverNull,Icon,Icons,PageView,dayHeight,spaceBetweenEvents,CalendarMonthView;function getDiffInDaysFast(left,right){return left.getMonth()===right.getMonth()?left.getDate()-right.getDate():getDiffInDays(left,right)}return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiSize){px=_guiSize.px,size=_guiSize.size},function(_apiCommonTutanotaConstants){EventTextTimeOption=_apiCommonTutanotaConstants.EventTextTimeOption},function(_CalendarEventBubble){CalendarEventBubble=_CalendarEventBubble.CalendarEventBubble},function(_CalendarUtils){CALENDAR_EVENT_HEIGHT=_CalendarUtils.CALENDAR_EVENT_HEIGHT,getAllDayDateForTimezone=_CalendarUtils.getAllDayDateForTimezone,getCalendarMonth=_CalendarUtils.getCalendarMonth,getDiffInDays=_CalendarUtils.getDiffInDays,getEventColor=_CalendarUtils.getEventColor,getEventEnd=_CalendarUtils.getEventEnd,getStartOfDayWithZone=_CalendarUtils.getStartOfDayWithZone,getStartOfNextDayWithZone=_CalendarUtils.getStartOfNextDayWithZone,getStartOfTheWeekOffset=_CalendarUtils.getStartOfTheWeekOffset,getTimeZone=_CalendarUtils.getTimeZone,getWeekNumber=_CalendarUtils.getWeekNumber,layOutEvents=_CalendarUtils.layOutEvents},function(_apiCommonUtilsDateUtils){getDateIndicator=_apiCommonUtilsDateUtils.getDateIndicator,incrementDate=_apiCommonUtilsDateUtils.incrementDate},function(_apiCommonUtilsArrayUtils){lastThrow=_apiCommonUtilsArrayUtils.lastThrow},function(_guiTheme){theme=_guiTheme.theme},function(_ContinuingCalendarEventBubble){ContinuingCalendarEventBubble=_ContinuingCalendarEventBubble.ContinuingCalendarEventBubble},function(_guiStyles){styles=_guiStyles.styles},function(_miscFormatter){formatMonthWithFullYear=_miscFormatter.formatMonthWithFullYear},function(_apiCommonUtilsCommonCalendarUtils){isAllDayEvent=_apiCommonUtilsCommonCalendarUtils.isAllDayEvent,isAllDayEventByTimes=_apiCommonUtilsCommonCalendarUtils.isAllDayEventByTimes},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBasePageView){PageView=_guiBasePageView.PageView}],execute:function(){dayHeight=function(){return styles.isDesktopLayout()?32:24},spaceBetweenEvents=function(){return styles.isDesktopLayout()?2:1},_export("CalendarMonthView",CalendarMonthView=function(){function CalendarMonthView(){_classCallCheck(this,CalendarMonthView),this._resizeListener=m.redraw,this._zone=getTimeZone(),this._lastHeight=0,this._lastHeight=0}return _createClass(CalendarMonthView,[{key:"oncreate",value:function(){windowFacade.addResizeListener(this._resizeListener)}},{key:"onremove",value:function(){windowFacade.removeResizeListener(this._resizeListener)}},{key:"view",value:function(_ref){var attrs=_ref.attrs,previousMonthDate=new Date(attrs.selectedDate);previousMonthDate.setMonth(previousMonthDate.getMonth()-1);var nextMonthDate=new Date(attrs.selectedDate);return nextMonthDate.setMonth(nextMonthDate.getMonth()+1),m(PageView,{previousPage:{key:previousMonthDate.getTime(),nodes:this._monthDom?this._renderCalendar(attrs,previousMonthDate,this._zone):null},currentPage:{key:attrs.selectedDate.getTime(),nodes:this._renderCalendar(attrs,attrs.selectedDate,this._zone)},nextPage:{key:nextMonthDate.getTime(),nodes:this._monthDom?this._renderCalendar(attrs,nextMonthDate,this._zone):null},onChangePage:function(next){return attrs.onChangeMonth(next)}})}},{key:"onbeforeupdate",value:function(newVnode,oldVnode){var dom=this._monthDom,different=!dom||oldVnode.attrs.eventsForDays!==newVnode.attrs.eventsForDays||oldVnode.attrs.selectedDate!==newVnode.attrs.selectedDate||oldVnode.attrs.amPmFormat!==newVnode.attrs.amPmFormat||oldVnode.attrs.groupColors!==newVnode.attrs.groupColors||oldVnode.attrs.hiddenCalendars!==newVnode.attrs.hiddenCalendars||dom.offsetWidth!==this._lastWidth||dom.offsetHeight!==this._lastHeight;return dom&&(this._lastWidth=dom.offsetWidth,this._lastHeight=dom.offsetHeight),different}},{key:"_renderCalendar",value:function(attrs,date,zone){var _this=this,startOfTheWeekOffset=getStartOfTheWeekOffset(attrs.startOfTheWeek),_getCalendarMonth=getCalendarMonth(date,startOfTheWeekOffset,!1),weekdays=_getCalendarMonth.weekdays,weeks=_getCalendarMonth.weeks,today=getStartOfDayWithZone(new Date,getTimeZone());return m(".fill-absolute.flex.col.margin-are-inset-lr",[styles.isDesktopLayout()?m(".mt-s.pr-l.flex.row.items-center",[m("button.calendar-switch-button",{onclick:function(){return attrs.onChangeMonth(!1)}},m(Icon,{icon:Icons.ArrowDropLeft,class:"icon-large switch-month-button"})),m("button.calendar-switch-button",{onclick:function(){return attrs.onChangeMonth(!0)}},m(Icon,{icon:Icons.ArrowDropRight,class:"icon-large switch-month-button"})),m("h1",formatMonthWithFullYear(date))]):m(".pt-s"),m(".flex.mb-s",weekdays.map(function(wd){return m(".flex-grow",m(".calendar-day-indicator.b",wd))})),m(".flex.col.flex-grow",{oncreate:function(vnode){date===attrs.selectedDate&&(_this._monthDom=vnode.dom,m.redraw())},onupdate:function(vnode){date===attrs.selectedDate&&(_this._monthDom=vnode.dom)}},weeks.map(function(week){return m(".flex.flex-grow.rel",[week.map(function(d,i){return _this._renderDay(attrs,d,today,i)}),_this._monthDom?_this._renderWeekEvents(attrs,week,zone):null])}))])}},{key:"_renderDay",value:function(attrs,d,today,weekDayNumber){return m(".calendar-day.calendar-column-border.flex-grow.rel.overflow-hidden.fill-absolute"+(d.paddingDay?".calendar-alternate-background":""),{key:d.date.getTime(),onclick:function(){return attrs.onDateSelected(new Date(d.date))},oncontextmenu:function(e){if(styles.isDesktopLayout()){var newDate=new Date(d.date),hour=(new Date).getHours();hour<23&&hour++,newDate.setHours(hour,0),attrs.onNewEvent(newDate)}else attrs.onDateSelected(new Date(d.date));e.preventDefault()}},[m(".calendar-day-indicator.calendar-day-number"+getDateIndicator(d.date,null,today),String(d.day)),0===weekDayNumber?m(".calendar-month-week-number.abs",getWeekNumber(d.date)):null])}},{key:"_renderWeekEvents",value:function(attrs,week,zone){var _this2=this,events=new Set;week.forEach(function(day){var dayEvents=attrs.eventsForDays.get(day.date.getTime());dayEvents&&dayEvents.forEach(function(e){attrs.hiddenCalendars.has(neverNull(e._ownerGroup))||events.add(e)})});var firstDayOfWeek=week[0].date,lastDayOfWeek=lastThrow(week),dayWidth=this._getWidthForDay(),weekHeight=this._getHeightForWeek(),eventHeight=size.calendar_line_height+spaceBetweenEvents(),maxEventsPerDay=(weekHeight-dayHeight())/eventHeight,eventsPerDay=Math.floor(maxEventsPerDay)-1,moreEventsForDay=[0,0,0,0,0,0,0],eventMargin=styles.isDesktopLayout()?size.calendar_event_margin:size.calendar_event_margin_mobile,firstDayOfNextWeek=getStartOfNextDayWithZone(lastDayOfWeek.date,zone);return layOutEvents(Array.from(events),zone,function(columns){return columns.map(function(events,columnIndex){return events.map(function(event){if(columnIndex<eventsPerDay){var eventIsAllDay=isAllDayEventByTimes(event.startTime,event.endTime),eventStart=eventIsAllDay?getAllDayDateForTimezone(event.startTime,zone):event.startTime,eventEnd=eventIsAllDay?incrementDate(getEventEnd(event,zone),-1):event.endTime,position=_this2._getEventPosition(eventStart,eventEnd,firstDayOfWeek,firstDayOfNextWeek,dayWidth,dayHeight(),columnIndex);return m(".abs.overflow-hidden",{key:event._id[0]+event._id[1]+event.startTime.getTime(),style:{top:px(position.top),height:px(CALENDAR_EVENT_HEIGHT),left:px(position.left),right:px(position.right)}},_this2._renderEvent(attrs,event,eventStart<firstDayOfWeek,firstDayOfNextWeek<eventEnd))}return week.forEach(function(dayInWeek,index){var eventsForDay=attrs.eventsForDays.get(dayInWeek.date.getTime());eventsForDay&&-1!==eventsForDay.indexOf(event)&&moreEventsForDay[index]++}),null})}).concat(moreEventsForDay.map(function(moreEventsCount,weekday){var day=week[weekday],isPadding=day.paddingDay;return moreEventsCount>0?m(".abs.darker-hover"+(isPadding?".calendar-bubble-more-padding-day":""),{style:{bottom:px(1),height:px(CALENDAR_EVENT_HEIGHT),left:px(weekday*dayWidth+eventMargin),width:px(dayWidth-2-2*eventMargin)}},m(CalendarEventBubble,{text:"+"+moreEventsCount,color:isPadding?theme.list_bg.substring(1):theme.content_bg.substring(1),onEventClicked:function(){attrs.onDateSelected(day.date)},hasAlarm:!1})):null}))},!0)}},{key:"_getEventPosition",value:function(eventStart,eventEnd,firstDayOfWeek,firstDayOfNextWeek,calendarDayWidth,calendarDayHeight,columnIndex){var top=(size.calendar_line_height+spaceBetweenEvents())*columnIndex+calendarDayHeight,dayOfStartDateInWeek=getDiffInDaysFast(eventStart,firstDayOfWeek),dayOfEndDateInWeek=getDiffInDaysFast(eventEnd,firstDayOfWeek),calendarEventMargin=styles.isDesktopLayout()?size.calendar_event_margin:size.calendar_event_margin_mobile;return{top:top,left:(eventStart<firstDayOfWeek?0:dayOfStartDateInWeek*calendarDayWidth)+calendarEventMargin,right:(eventEnd>firstDayOfNextWeek?0:(6-dayOfEndDateInWeek)*calendarDayWidth)+calendarEventMargin}}},{key:"_renderEvent",value:function(attrs,event,startsBeforeWeek,endsAfterWeek){return m(ContinuingCalendarEventBubble,{event:event,startsBefore:startsBeforeWeek,endsAfter:endsAfterWeek,color:getEventColor(event,attrs.groupColors),showTime:styles.isDesktopLayout()&&!isAllDayEvent(event)?EventTextTimeOption.START_TIME:EventTextTimeOption.NO_TIME,onEventClicked:function(e){attrs.onEventClicked(event)}})}},{key:"_getHeightForWeek",value:function(){return this._monthDom?this._monthDom.offsetHeight/6:1}},{key:"_getWidthForDay",value:function(){return this._monthDom?this._monthDom.offsetWidth/7:1}}]),CalendarMonthView}()),_export("CalendarMonthView",CalendarMonthView)}}}),System.register("src/calendar/CalendarAgendaView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./CalendarEventBubble","../api/common/TutanotaConstants","../api/common/utils/DateUtils","../gui/styles","../misc/LanguageViewModel","../misc/Formatter","./CalendarUtils","../api/common/utils/CommonCalendarUtils","../api/common/utils/Utils","../gui/size","../api/common/utils/ArrayUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,CalendarEventBubble,EventTextTimeOption,incrementDate,styles,lang,formatDate,formatDateWithWeekday,eventEndsAfterDay,eventStartsBefore,getEventColor,getEventText,getStartOfDayWithZone,getTimeZone,hasAlarmsForTheUser,isAllDayEvent,neverNull,px,size,lastThrow,CalendarAgendaView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_CalendarEventBubble){CalendarEventBubble=_CalendarEventBubble.CalendarEventBubble},function(_apiCommonTutanotaConstants){EventTextTimeOption=_apiCommonTutanotaConstants.EventTextTimeOption},function(_apiCommonUtilsDateUtils){incrementDate=_apiCommonUtilsDateUtils.incrementDate},function(_guiStyles){styles=_guiStyles.styles},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_miscFormatter){formatDate=_miscFormatter.formatDate,formatDateWithWeekday=_miscFormatter.formatDateWithWeekday},function(_CalendarUtils){eventEndsAfterDay=_CalendarUtils.eventEndsAfterDay,eventStartsBefore=_CalendarUtils.eventStartsBefore,getEventColor=_CalendarUtils.getEventColor,getEventText=_CalendarUtils.getEventText,getStartOfDayWithZone=_CalendarUtils.getStartOfDayWithZone,getTimeZone=_CalendarUtils.getTimeZone,hasAlarmsForTheUser=_CalendarUtils.hasAlarmsForTheUser},function(_apiCommonUtilsCommonCalendarUtils){isAllDayEvent=_apiCommonUtilsCommonCalendarUtils.isAllDayEvent},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_guiSize){px=_guiSize.px,size=_guiSize.size},function(_apiCommonUtilsArrayUtils){lastThrow=_apiCommonUtilsArrayUtils.lastThrow}],execute:function(){_export("CalendarAgendaView",CalendarAgendaView=function(){function CalendarAgendaView(){_classCallCheck(this,CalendarAgendaView)}return _createClass(CalendarAgendaView,[{key:"view",value:function(_ref){var attrs=_ref.attrs,now=new Date,zone=getTimeZone(),today=getStartOfDayWithZone(now,zone),tomorrow=incrementDate(new Date(today),1),days=function(startOfToday){for(var calculationDate=new Date(startOfToday),days=[],i=0;i<14;i++)days.push(new Date(calculationDate.getTime())),calculationDate=incrementDate(calculationDate,1);return days}(today),lastDay=lastThrow(days),title=void 0;title=days[0].getMonth()===lastDay.getMonth()?lang.formats.dateWithWeekdayWoMonth.format(days[0])+" - "+lang.formats.dateWithWeekdayAndYear.format(lastDay):lang.formats.dateWithWeekday.format(days[0])+" - "+lang.formats.dateWithWeekdayAndYear.format(lastDay);var lastDayFormatted=formatDate(lastDay);return m(".fill-absolute.flex.col.margin-are-inset-lr",[m(".mt-s.pr-l",[styles.isDesktopLayout()?[m("h1.flex.row",{style:{"margin-left":px(size.calendar_hour_width)}},[lang.get("agenda_label"),m(".ml-m.no-wrap.overflow-hidden",title)]),m("hr.hr.mt-s")]:null]),m(".scroll.pt-s",days.map(function(day){var events=(attrs.eventsForDays.get(day.getTime())||[]).filter(function(e){return!attrs.hiddenCalendars.has(neverNull(e._ownerGroup))});if(day===today)events=events.filter(function(ev){return isAllDayEvent(ev)||now<ev.endTime});else if(day.getTime()>tomorrow.getTime()&&0===events.length)return null;var dateDescription=day.getTime()===today.getTime()?lang.get("today_label"):day.getTime()===tomorrow.getTime()?lang.get("tomorrow_label"):formatDateWithWeekday(day);return m(".flex.mlr-l.calendar-agenda-row.mb-s.col",{key:day},[m("button.pb-s.b",{onclick:function(){return attrs.onDateSelected(new Date(day))}},dateDescription),m(".flex-grow",{style:{"max-width":"600px"}},0===events.length?m(".mb-s",lang.get("noEntries_msg")):events.map(function(ev){var startsBefore=eventStartsBefore(day,zone,ev),endsAfter=eventEndsAfterDay(day,zone,ev),textOption=void 0;return textOption=isAllDayEvent(ev)||startsBefore&&endsAfter?EventTextTimeOption.ALL_DAY:startsBefore&&!endsAfter?EventTextTimeOption.END_TIME:!startsBefore&&endsAfter?EventTextTimeOption.START_TIME:EventTextTimeOption.START_END_TIME,m(".darker-hover.mb-s",{key:ev._id},m(CalendarEventBubble,{text:getEventText(ev,textOption),secondLineText:ev.location,color:getEventColor(ev,attrs.groupColors),hasAlarm:!startsBefore&&hasAlarmsForTheUser(ev),onEventClicked:function(){return attrs.onEventClicked(ev)},height:38,verticalPadding:2}))}))])}).filter(Boolean).concat(m(".mlr-l",{key:"events_until"},lang.get("showingEventsUntil_msg",{"{untilDay}":lastDayFormatted}))))])}}]),CalendarAgendaView}()),_export("CalendarAgendaView",CalendarAgendaView)}}}),System.register("src/calendar/EditCalendarDialog.js",["../gui/base/Dialog","mithril","mithril/stream/stream.js","../gui/base/TextFieldN","../misc/LanguageViewModel"],function(_export,_context){"use strict";var Dialog,m,stream,TextFieldN,lang;function showEditCalendarDialog(_ref,titleTextId,shared,_okAction,okTextId,warningMessage){var name=_ref.name,color=_ref.color,nameStream=stream(name),colorStream=stream("#"+color);Dialog.showActionDialog({title:function(){return lang.get(titleTextId)},allowOkWithReturn:!0,child:{view:function(){return m(".flex.col",[warningMessage?warningMessage():null,m(TextFieldN,{value:nameStream,label:"calendarName_label"}),m(".small.mt.mb-xs",lang.get("color_label")),m("input.color-picker",{oncreate:function(_ref2){var dom=_ref2.dom;return dom},type:"color",value:colorStream(),oninput:function(inputEvent){colorStream(inputEvent.target.value)}})])}},okActionTextId:okTextId,okAction:function(dialog){_okAction(dialog,{name:nameStream(),color:colorStream().substring(1)})}})}return{setters:[function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang}],execute:function(){_export("showEditCalendarDialog",showEditCalendarDialog)}}}),System.register("src/calendar/CalendarDayEventsView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/theme","../gui/size","../api/common/utils/DateUtils","../api/common/utils/ArrayUtils","./CalendarUtils","./CalendarEventBubble","../api/common/TutanotaConstants","../api/common/utils/Utils","../api/common/utils/CommonCalendarUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,theme,px,size,DAY_IN_MILLIS,numberRange,expandEvent,getEventColor,getEventText,getTimeZone,hasAlarmsForTheUser,layOutEvents,CalendarEventBubble,EventTextTimeOption,neverNull,isAllDayEvent,calendarDayTimes,allHoursHeight,CalendarDayEventsView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiTheme){theme=_guiTheme.theme},function(_guiSize){px=_guiSize.px,size=_guiSize.size},function(_apiCommonUtilsDateUtils){DAY_IN_MILLIS=_apiCommonUtilsDateUtils.DAY_IN_MILLIS},function(_apiCommonUtilsArrayUtils){numberRange=_apiCommonUtilsArrayUtils.numberRange},function(_CalendarUtils){expandEvent=_CalendarUtils.expandEvent,getEventColor=_CalendarUtils.getEventColor,getEventText=_CalendarUtils.getEventText,getTimeZone=_CalendarUtils.getTimeZone,hasAlarmsForTheUser=_CalendarUtils.hasAlarmsForTheUser,layOutEvents=_CalendarUtils.layOutEvents},function(_CalendarEventBubble){CalendarEventBubble=_CalendarEventBubble.CalendarEventBubble},function(_apiCommonTutanotaConstants){EventTextTimeOption=_apiCommonTutanotaConstants.EventTextTimeOption},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiCommonUtilsCommonCalendarUtils){isAllDayEvent=_apiCommonUtilsCommonCalendarUtils.isAllDayEvent}],execute:function(){_export("calendarDayTimes",calendarDayTimes=numberRange(0,23).map(function(n){var d=new Date;return d.setHours(n,0,0,0),d})),_export("calendarDayTimes",calendarDayTimes),allHoursHeight=size.calendar_hour_height*calendarDayTimes.length,_export("CalendarDayEventsView",CalendarDayEventsView=function(){function CalendarDayEventsView(){_classCallCheck(this,CalendarDayEventsView)}return _createClass(CalendarDayEventsView,[{key:"view",value:function(vnode){var _this=this;return m(".col.rel",{oncreate:function(vnode){_this._dayDom=vnode.dom,m.redraw()}},[calendarDayTimes.map(function(n){return m(".calendar-hour.flex",{onclick:function(e){e.stopPropagation(),vnode.attrs.onTimePressed(n.getHours(),n.getMinutes())},oncontextmenu:function(e){vnode.attrs.onTimeContextPressed(n.getHours(),n.getMinutes()),e.preventDefault()}})}),this._dayDom?this._renderEvents(vnode.attrs,vnode.attrs.events):null,this._renderTimeIndicator(vnode.attrs)])}},{key:"_renderTimeIndicator",value:function(attrs){var now=new Date;if(!attrs.displayTimeIndicator)return null;var top=function(now){return 60*(60*now.getHours()+now.getMinutes())*1e3/DAY_IN_MILLIS*allHoursHeight}(now);return[m(".abs",{"aria-hidden":"true",style:{top:px(top),left:0,right:0,height:"2px",background:theme.content_accent}}),m(".abs",{"aria-hidden":"true",style:{top:px(top),left:0,height:"12px",width:"12px","border-radius":"50%",background:theme.content_accent,"margin-top":"-5px","margin-left":"-7px"}})]}},{key:"_renderEvents",value:function(attrs,events){var _this2=this;return layOutEvents(events,getTimeZone(),function(columns){return _this2._renderColumns(attrs,columns)},!1)}},{key:"_renderEvent",value:function(attrs,ev,columnIndex,columns,columnWidth){var startTime=60*(60*ev.startTime.getHours()+ev.startTime.getMinutes())*1e3,height=(ev.endTime.getTime()-ev.startTime.getTime())/36e5*size.calendar_hour_height,colSpan=expandEvent(ev,columnIndex,columns);return m(".abs.darker-hover",{style:{left:px(columnWidth*columnIndex),width:px(columnWidth*colSpan),top:px(startTime/DAY_IN_MILLIS*allHoursHeight),height:px(height)}},m(CalendarEventBubble,{text:getEventText(ev,isAllDayEvent(ev)?EventTextTimeOption.NO_TIME:EventTextTimeOption.START_TIME),color:getEventColor(ev,attrs.groupColors),onEventClicked:function(){return attrs.onEventClicked(ev)},height:height-2,hasAlarm:hasAlarmsForTheUser(ev),verticalPadding:2}))}},{key:"_renderColumns",value:function(attrs,columns){var _this3=this,columnWidth=neverNull(this._dayDom).scrollWidth/columns.length;return columns.map(function(column,index){return column.map(function(event){return _this3._renderEvent(attrs,event,index,columns,Math.floor(columnWidth))})})}}]),CalendarDayEventsView}()),_export("CalendarDayEventsView",CalendarDayEventsView)}}}),System.register("src/calendar/CalendarEventBubble.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./CalendarUtils","../gui/size","../gui/base/Icon","../gui/base/icons/Icons"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,colorForBg,px,size,Icon,Icons,defaultBubbleHeight,CalendarEventBubble;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_CalendarUtils){colorForBg=_CalendarUtils.colorForBg},function(_guiSize){px=_guiSize.px,size=_guiSize.size},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons}],execute:function(){defaultBubbleHeight=size.calendar_line_height,_export("CalendarEventBubble",CalendarEventBubble=function(){function CalendarEventBubble(){_classCallCheck(this,CalendarEventBubble)}return _createClass(CalendarEventBubble,[{key:"view",value:function(_ref){var attrs=_ref.attrs;return m(".calendar-event.small.overflow-hidden.flex.fade-in"+(attrs.noBorderLeft?".event-continues-left":"")+(attrs.noBorderRight?".event-continues-right":""),{style:{background:"#"+attrs.color,color:colorForBg(attrs.color),minHeight:px(defaultBubbleHeight),height:px(attrs.height?attrs.height:defaultBubbleHeight),"padding-top":px(attrs.verticalPadding)},onclick:function(e){e.stopPropagation(),attrs.onEventClicked(e)}},[attrs.hasAlarm?m(Icon,{icon:Icons.Notifications,style:{fill:colorForBg(attrs.color),"padding-top":"2px","padding-right":"2px"},class:"icon-small"}):null,m(".flex.col",[m("",{style:{lineHeight:px(defaultBubbleHeight)}},attrs.text),attrs.secondLineText?m("",attrs.secondLineText):null])])}}]),CalendarEventBubble}()),_export("CalendarEventBubble",CalendarEventBubble)}}}),System.register("src/calendar/ContinuingCalendarEventBubble.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./CalendarUtils","./CalendarEventBubble"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,getEventText,hasAlarmsForTheUser,CalendarEventBubble,ContinuingCalendarEventBubble;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_CalendarUtils){getEventText=_CalendarUtils.getEventText,hasAlarmsForTheUser=_CalendarUtils.hasAlarmsForTheUser},function(_CalendarEventBubble){CalendarEventBubble=_CalendarEventBubble.CalendarEventBubble}],execute:function(){_export("ContinuingCalendarEventBubble",ContinuingCalendarEventBubble=function(){function ContinuingCalendarEventBubble(){_classCallCheck(this,ContinuingCalendarEventBubble)}return _createClass(ContinuingCalendarEventBubble,[{key:"view",value:function(_ref){var attrs=_ref.attrs;return m(".flex.calendar-event-cont.darker-hover",[attrs.startsBefore?m(".event-continues-right-arrow",{style:{"border-left-color":"transparent","border-top-color":"#"+attrs.color,"border-bottom-color":"#"+attrs.color}}):null,m(".flex-grow.overflow-hidden",m(CalendarEventBubble,{text:getEventText(attrs.event,attrs.showTime),color:attrs.color,onEventClicked:function(){return attrs.onEventClicked(attrs.event)},noBorderLeft:attrs.startsBefore,noBorderRight:attrs.endsAfter,hasAlarm:hasAlarmsForTheUser(attrs.event)})),attrs.endsAfter?m(".event-continues-right-arrow",{style:{"border-left-color":"#"+attrs.color}}):null])}}]),ContinuingCalendarEventBubble}()),_export("ContinuingCalendarEventBubble",ContinuingCalendarEventBubble)}}}),System.register("src/gui/base/PageView.js",["node_modules/systemjs-plugin-babel/babel-helpers/possibleConstructorReturn.js","node_modules/systemjs-plugin-babel/babel-helpers/get.js","node_modules/systemjs-plugin-babel/babel-helpers/inherits.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./SwipeHandler","../animation/Animations"],function(_export,_context){"use strict";var _possibleConstructorReturn,_get,_inherits,_classCallCheck,_createClass,m,SwipeHandler,animations,transform,PageView,PageSwipeHandler;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersPossibleConstructorReturnJs){_possibleConstructorReturn=_node_modulesSystemjsPluginBabelBabelHelpersPossibleConstructorReturnJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersGetJs){_get=_node_modulesSystemjsPluginBabelBabelHelpersGetJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersInheritsJs){_inherits=_node_modulesSystemjsPluginBabelBabelHelpersInheritsJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_SwipeHandler2){SwipeHandler=_SwipeHandler2.SwipeHandler},function(_animationAnimations){animations=_animationAnimations.animations,transform=_animationAnimations.transform}],execute:function(){_export("PageView",PageView=function(){function PageView(){_classCallCheck(this,PageView)}return _createClass(PageView,[{key:"view",value:function(_ref){var _this=this,attrs=_ref.attrs;return this._onChangePage=function(next){return attrs.onChangePage(next)},m(".fill-absolute",{oncreate:function(vnode){_this._viewDom=vnode.dom,_this._swipeHandler=new PageSwipeHandler(vnode.dom,function(next){return _this._onChangePage(next)})}},[m(".abs",{"aria-hidden":"true",key:attrs.previousPage.key,style:this._viewDom&&this._viewDom.offsetWidth>0&&{width:this._viewDom.offsetWidth+"px",height:this._viewDom.offsetHeight+"px",transform:"translateX("+-this._viewDom.offsetWidth+"px)"}},attrs.previousPage.nodes),m(".fill-absolute",{key:attrs.currentPage.key},attrs.currentPage.nodes),m(".abs",{"aria-hidden":"true",key:attrs.nextPage.key,style:this._viewDom&&this._viewDom.offsetWidth>0&&{width:this._viewDom.offsetWidth+"px",height:this._viewDom.offsetHeight+"px",transform:"translateX("+this._viewDom.offsetWidth+"px)"}},attrs.nextPage.nodes)])}}]),PageView}()),_export("PageView",PageView),_export("PageSwipeHandler",PageSwipeHandler=function(_SwipeHandler){function PageSwipeHandler(touchArea,onGestureCompleted){_classCallCheck(this,PageSwipeHandler);var _this2=_possibleConstructorReturn(this,(PageSwipeHandler.__proto__||Object.getPrototypeOf(PageSwipeHandler)).call(this,touchArea));return _this2._xoffset=0,touchArea.style.transformStyle="preserve-3d",touchArea.style.backfaceVisibility="hidden",_this2._onGestureCompleted=onGestureCompleted,_this2}return _inherits(PageSwipeHandler,SwipeHandler),_createClass(PageSwipeHandler,[{key:"onHorizontalDrag",value:function(xDelta,yDelta){this._xoffset=Math.abs(xDelta)>40?xDelta:0,this.touchArea.style.transform="translateX("+this._xoffset+"px)"}},{key:"onHorizontalGestureCompleted",value:function(delta){var _this3=this;return Math.abs(delta.x)>100?(this._xoffset=0,animations.add(this.touchArea,transform(transform.type.translateX,delta.x,this.touchArea.offsetWidth*(delta.x>0?1:-1))).then(function(){_this3._onGestureCompleted(delta.x<0),requestAnimationFrame(function(){_this3.touchArea.style.transform=""})})):this.reset(delta)}},{key:"reset",value:function(delta){return Math.abs(this._xoffset)>40?animations.add(this.touchArea,transform(transform.type.translateX,delta.x,0)):this.touchArea.style.transform="",this._xoffset=0,_get(PageSwipeHandler.prototype.__proto__||Object.getPrototypeOf(PageSwipeHandler.prototype),"reset",this).call(this,delta)}}]),PageSwipeHandler}()),_export("PageSwipeHandler",PageSwipeHandler)}}}),System.register("src/calendar/CalendarWeekView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/common/utils/DateUtils","../gui/styles","../misc/Formatter","./CalendarUtils","./CalendarDayEventsView","../api/common/utils/Utils","../api/common/utils/MapUtils","../api/common/utils/CommonCalendarUtils","../gui/theme","../gui/size","./ContinuingCalendarEventBubble","../api/common/TutanotaConstants","../api/common/utils/ArrayUtils","../gui/base/Icon","../gui/base/icons/Icons","../misc/LanguageViewModel","../gui/base/PageView","./CalendarView"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,getStartOfDay,incrementDate,styles,formatTime,CALENDAR_EVENT_HEIGHT,eventEndsAfterDay,eventStartsBefore,getCalendarWeek,getDiffInDays,getEventColor,getEventEnd,getEventStart,getTimeZone,getWeekNumber,layOutEvents,CalendarDayEventsView,calendarDayTimes,neverNull,isAllDayEvent,theme,px,size,ContinuingCalendarEventBubble,EventTextTimeOption,lastThrow,Icon,Icons,lang,PageView,DEFAULT_HOUR_OF_DAY,CalendarWeekView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiCommonUtilsDateUtils){getStartOfDay=_apiCommonUtilsDateUtils.getStartOfDay,incrementDate=_apiCommonUtilsDateUtils.incrementDate},function(_guiStyles){styles=_guiStyles.styles},function(_miscFormatter){formatTime=_miscFormatter.formatTime},function(_CalendarUtils){CALENDAR_EVENT_HEIGHT=_CalendarUtils.CALENDAR_EVENT_HEIGHT,eventEndsAfterDay=_CalendarUtils.eventEndsAfterDay,eventStartsBefore=_CalendarUtils.eventStartsBefore,getCalendarWeek=_CalendarUtils.getCalendarWeek,getDiffInDays=_CalendarUtils.getDiffInDays,getEventColor=_CalendarUtils.getEventColor,getEventEnd=_CalendarUtils.getEventEnd,getEventStart=_CalendarUtils.getEventStart,getTimeZone=_CalendarUtils.getTimeZone,getWeekNumber=_CalendarUtils.getWeekNumber,layOutEvents=_CalendarUtils.layOutEvents},function(_CalendarDayEventsView){CalendarDayEventsView=_CalendarDayEventsView.CalendarDayEventsView,calendarDayTimes=_CalendarDayEventsView.calendarDayTimes},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiCommonUtilsMapUtils){_apiCommonUtilsMapUtils.getFromMap},function(_apiCommonUtilsCommonCalendarUtils){isAllDayEvent=_apiCommonUtilsCommonCalendarUtils.isAllDayEvent},function(_guiTheme){theme=_guiTheme.theme},function(_guiSize){px=_guiSize.px,size=_guiSize.size},function(_ContinuingCalendarEventBubble){ContinuingCalendarEventBubble=_ContinuingCalendarEventBubble.ContinuingCalendarEventBubble},function(_apiCommonTutanotaConstants){EventTextTimeOption=_apiCommonTutanotaConstants.EventTextTimeOption},function(_apiCommonUtilsArrayUtils){lastThrow=_apiCommonUtilsArrayUtils.lastThrow},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBasePageView){PageView=_guiBasePageView.PageView},function(_CalendarView){DEFAULT_HOUR_OF_DAY=_CalendarView.DEFAULT_HOUR_OF_DAY}],execute:function(){_export("CalendarWeekView",CalendarWeekView=function(){function CalendarWeekView(){_classCallCheck(this,CalendarWeekView),this._domElements=[],this._scrollPosition=size.calendar_hour_height*DEFAULT_HOUR_OF_DAY}return _createClass(CalendarWeekView,[{key:"view",value:function(vnode){var previousWeek=getCalendarWeek(incrementDate(new Date(vnode.attrs.selectedDate),-7),vnode.attrs.startOfTheWeek),currentWeek=getCalendarWeek(vnode.attrs.selectedDate,vnode.attrs.startOfTheWeek),nextWeek=getCalendarWeek(incrementDate(new Date(vnode.attrs.selectedDate),7),vnode.attrs.startOfTheWeek),previousPageEvents=this._getEventsForWeek(previousWeek,vnode.attrs),currentPageEvents=this._getEventsForWeek(currentWeek,vnode.attrs),nextPageEvents=this._getEventsForWeek(nextWeek,vnode.attrs);return m(PageView,{previousPage:{key:previousWeek[0].getTime(),nodes:this._renderWeek(vnode.attrs,previousPageEvents,currentPageEvents)},currentPage:{key:currentWeek[0].getTime(),nodes:this._renderWeek(vnode.attrs,currentPageEvents,currentPageEvents)},nextPage:{key:nextWeek[0].getTime(),nodes:this._renderWeek(vnode.attrs,nextPageEvents,currentPageEvents)},onChangePage:function(next){return vnode.attrs.onChangeWeek(next)}})}},{key:"_renderWeek",value:function(attrs,thisWeek,mainWeek){var _this=this,firstDate=thisWeek.week[0],lastDate=lastThrow(thisWeek.week),title=void 0;title=firstDate.getMonth()!==lastDate.getMonth()?lang.formats.monthLong.format(firstDate)+" - "+lang.formats.monthLong.format(lastDate)+" "+lang.formats.yearNumeric.format(firstDate):lang.formats.monthLong.format(firstDate)+" "+lang.formats.yearNumeric.format(firstDate);var todayTimestamp=getStartOfDay(new Date).getTime(),marginForWeekEvents=0===mainWeek.eventsForWeek.size?0:6;return m(".fill-absolute.flex.col.calendar-column-border.margin-are-inset-lr",{oncreate:function(){_this._redrawIntervalId=setInterval(m.redraw,6e4)},onremove:function(){null!=_this._redrawIntervalId&&(clearInterval(_this._redrawIntervalId),_this._redrawIntervalId=null)}},[m(".calendar-long-events-header.mt-s.flex-fixed",{style:{height:px(69+mainWeek.longEvents.maxColumns*CALENDAR_EVENT_HEIGHT+marginForWeekEvents+8)}},[m(".pr-l.flex.row.items-center",[m("button.calendar-switch-button",{onclick:function(){return attrs.onChangeWeek(!1)}},m(Icon,{icon:Icons.ArrowDropLeft,class:"icon-large switch-month-button"})),m("button.calendar-switch-button",{onclick:function(){return attrs.onChangeWeek(!0)}},m(Icon,{icon:Icons.ArrowDropRight,class:"icon-large switch-month-button"})),m("h1",title),m(".ml-m.content-message-bg.small",{style:{padding:"2px 4px"}},lang.get("weekNumber_label",{"{week}":String(getWeekNumber(firstDate))}))]),m(".flex",{style:{margin:"0 0 "+px(marginForWeekEvents)+" "+px(size.calendar_hour_width)}},thisWeek.week.map(function(wd){return m(".flex.center-horizontally.flex-grow.center.b.",[m(".calendar-day-indicator",{style:{"margin-right":"4px"}},lang.formats.weekdayShort.format(wd)+" "),m(".calendar-day-indicator.calendar-day-number"+(todayTimestamp===wd.getTime()?".date-current":""),{style:{margin:"0"}},wd.getDate())])})),m(".calendar-hour-margin.flex.row",{oncreate:function(vnode){mainWeek===thisWeek&&(_this._longEventsDom=vnode.dom),m.redraw()},onupdate:function(vnode){mainWeek===thisWeek&&(_this._longEventsDom=vnode.dom)}},m(".rel.mb-s",{style:{height:px(mainWeek.longEvents.maxColumns*CALENDAR_EVENT_HEIGHT),width:"100%"}},thisWeek.longEvents.children))]),m("",{style:{"border-bottom":"1px solid "+theme.content_border}}),m(".flex.scroll",{oncreate:function(vnode){vnode.dom.scrollTop=_this._scrollPosition,_this._domElements.push(vnode.dom)},onscroll:function(event){thisWeek===mainWeek&&(_this._domElements.forEach(function(dom){dom!==event.target&&(dom.scrollTop=event.target.scrollTop)}),_this._scrollPosition=event.target.scrollTop)}},[m(".flex.col",calendarDayTimes.map(function(n){return m(".calendar-hour.flex",m(".center.small",{style:{"line-height":px(size.calendar_hour_height),width:px(size.calendar_hour_width),height:px(size.calendar_hour_height),"border-right":"2px solid "+theme.content_border}},formatTime(n)))})),m(".flex.flex-grow",thisWeek.week.map(function(weekday,i){var events=thisWeek.eventsPerDay[i],newEventHandler=function(hours,minutes){var eventDate=new Date(weekday);eventDate.setHours(hours,minutes),attrs.onNewEvent(eventDate)};return m(".flex-grow.calendar-column-border",{style:{height:px(calendarDayTimes.length*size.calendar_hour_height)}},m(CalendarDayEventsView,{onEventClicked:attrs.onEventClicked,groupColors:attrs.groupColors,events:events,displayTimeIndicator:weekday.getTime()===todayTimestamp,onTimePressed:newEventHandler,onTimeContextPressed:newEventHandler}))}))])])}},{key:"_getEventsForWeek",value:function(week,attrs){var eventsForWeek=new Set,eventsPerDay=[];week.forEach(function(wd){var weekdayDate=wd,eventsForWeekDay=[];(attrs.eventsForDays.get(wd.getTime())||[]).forEach(function(event){attrs.hiddenCalendars.has(neverNull(event._ownerGroup))||eventsForWeek.has(event)||(!isAllDayEvent(event)&&!eventStartsBefore(weekdayDate,getTimeZone(),event)&&!eventEndsAfterDay(weekdayDate,getTimeZone(),event)?eventsForWeekDay.push(event):eventsForWeek.add(event))}),eventsPerDay.push(eventsForWeekDay)});var longEvents=this._renderLongEvents(week,eventsForWeek,attrs);return{week:week,eventsForWeek:eventsForWeek,eventsPerDay:eventsPerDay,longEvents:longEvents}}},{key:"_renderLongEvents",value:function(week,eventsForWeek,attrs){if(null==this._longEventsDom)return{children:null,maxColumns:0};var dayWidth=this._longEventsDom.offsetWidth/7,maxColumns=0,firstDayOfWeek=week[0],lastDayOfWeek=lastThrow(week),calendarEventMargin=styles.isDesktopLayout()?size.calendar_event_margin:size.calendar_event_margin_mobile,zone=getTimeZone();return{children:layOutEvents(Array.from(eventsForWeek),zone,function(columns){return maxColumns=Math.max(maxColumns,columns.length),columns.map(function(rows,c){return rows.map(function(event){var zone=getTimeZone(),eventEnd=isAllDayEvent(event)?incrementDate(getEventEnd(event,zone),-1):event.endTime,dayOfStartDateInWeek=getDiffInDays(getEventStart(event,zone),firstDayOfWeek),dayOfEndDateInWeek=getDiffInDays(eventEnd,firstDayOfWeek),startsBefore=eventStartsBefore(firstDayOfWeek,zone,event),endsAfter=eventEndsAfterDay(lastDayOfWeek,zone,event),left=startsBefore?0:dayOfStartDateInWeek*dayWidth,right=endsAfter?0:(6-dayOfEndDateInWeek)*dayWidth+calendarEventMargin;return m(".abs",{style:{top:px(c*CALENDAR_EVENT_HEIGHT),left:px(left),right:px(right)},key:event._id[0]+event._id[1]+event.startTime.getTime()},m(ContinuingCalendarEventBubble,{event:event,startsBefore:startsBefore,endsAfter:endsAfter,color:getEventColor(event,attrs.groupColors),onEventClicked:attrs.onEventClicked,showTime:isAllDayEvent(event)?EventTextTimeOption.NO_TIME:EventTextTimeOption.START_TIME}))})})},!0),maxColumns:maxColumns}}}]),CalendarWeekView}()),_export("CalendarWeekView",CalendarWeekView)}}}),System.register("src/calendar/WindowsZones.js",[],function(_export,_context){"use strict";return{setters:[],execute:function(){_export("default",{"Afghanistan Standard Time":"Asia/Kabul","Alaskan Standard Time":"America/Anchorage","Aleutian Standard Time":"America/Adak","Altai Standard Time":"Asia/Barnaul","Arab Standard Time":"Asia/Riyadh","Arabian Standard Time":"Asia/Dubai","Arabic Standard Time":"Asia/Baghdad","Argentina Standard Time":"America/Buenos_Aires","Astrakhan Standard Time":"Europe/Astrakhan","Atlantic Standard Time":"America/Halifax","AUS Central Standard Time":"Australia/Darwin","Aus Central W. Standard Time":"Australia/Eucla","AUS Eastern Standard Time":"Australia/Sydney","Azerbaijan Standard Time":"Asia/Baku","Azores Standard Time":"Atlantic/Azores","Bahia Standard Time":"America/Bahia","Bangladesh Standard Time":"Asia/Dhaka","Belarus Standard Time":"Europe/Minsk","Bougainville Standard Time":"Pacific/Bougainville","Canada Central Standard Time":"America/Regina","Cape Verde Standard Time":"Atlantic/Cape_Verde","Caucasus Standard Time":"Asia/Yerevan","Cen. Australia Standard Time":"Australia/Adelaide","Central America Standard Time":"America/Guatemala","Central Asia Standard Time":"Asia/Almaty","Central Brazilian Standard Time":"America/Cuiaba","Central Europe Standard Time":"Europe/Budapest","Central European Standard Time":"Europe/Warsaw","Central Pacific Standard Time":"Pacific/Guadalcanal","Central Standard Time":"America/Chicago","Central Standard Time (Mexico)":"America/Mexico_City","Chatham Islands Standard Time":"Pacific/Chatham","China Standard Time":"Asia/Shanghai","Cuba Standard Time":"America/Havana","Dateline Standard Time":"Etc/GMT+12","E. Africa Standard Time":"Africa/Nairobi","E. Australia Standard Time":"Australia/Brisbane","E. Europe Standard Time":"Europe/Chisinau","E. South America Standard Time":"America/Sao_Paulo","Easter Island Standard Time":"Pacific/Easter","Eastern Standard Time":"America/New_York","Eastern Standard Time (Mexico)":"America/Cancun","Egypt Standard Time":"Africa/Cairo","Ekaterinburg Standard Time":"Asia/Yekaterinburg","Fiji Standard Time":"Pacific/Fiji","FLE Standard Time":"Europe/Kiev","Georgian Standard Time":"Asia/Tbilisi","GMT Standard Time":"Europe/London","Greenland Standard Time":"America/Godthab","Greenwich Standard Time":"Atlantic/Reykjavik","GTB Standard Time":"Europe/Bucharest","Haiti Standard Time":"America/Port-au-Prince","Hawaiian Standard Time":"Pacific/Honolulu","India Standard Time":"Asia/Calcutta","Iran Standard Time":"Asia/Tehran","Israel Standard Time":"Asia/Jerusalem","Jordan Standard Time":"Asia/Amman","Kaliningrad Standard Time":"Europe/Kaliningrad","Korea Standard Time":"Asia/Seoul","Libya Standard Time":"Africa/Tripoli","Line Islands Standard Time":"Pacific/Kiritimati","Lord Howe Standard Time":"Australia/Lord_Howe","Magadan Standard Time":"Asia/Magadan","Magallanes Standard Time":"America/Punta_Arenas","Marquesas Standard Time":"Pacific/Marquesas","Mauritius Standard Time":"Indian/Mauritius","Middle East Standard Time":"Asia/Beirut","Montevideo Standard Time":"America/Montevideo","Morocco Standard Time":"Africa/Casablanca","Mountain Standard Time":"America/Denver","Mountain Standard Time (Mexico)":"America/Chihuahua","Myanmar Standard Time":"Asia/Rangoon","N. Central Asia Standard Time":"Asia/Novosibirsk","Namibia Standard Time":"Africa/Windhoek","Nepal Standard Time":"Asia/Katmandu","New Zealand Standard Time":"Pacific/Auckland","Newfoundland Standard Time":"America/St_Johns","Norfolk Standard Time":"Pacific/Norfolk","North Asia East Standard Time":"Asia/Irkutsk","North Asia Standard Time":"Asia/Krasnoyarsk","North Korea Standard Time":"Asia/Pyongyang","Omsk Standard Time":"Asia/Omsk","Pacific SA Standard Time":"America/Santiago","Pacific Standard Time":"America/Los_Angeles","Pacific Standard Time (Mexico)":"America/Tijuana","Pakistan Standard Time":"Asia/Karachi","Paraguay Standard Time":"America/Asuncion","Romance Standard Time":"Europe/Paris","Russia Time Zone 3":"Europe/Samara","Russia Time Zone 10":"Asia/Srednekolymsk","Russia Time Zone 11":"Asia/Kamchatka","Russian Standard Time":"Europe/Moscow","SA Eastern Standard Time":"America/Cayenne","SA Pacific Standard Time":"America/Bogota","SA Western Standard Time":"America/La_Paz","Saint Pierre Standard Time":"America/Miquelon","Sakhalin Standard Time":"Asia/Sakhalin","Samoa Standard Time":"Pacific/Apia","Sao Tome Standard Time":"Africa/Sao_Tome","Saratov Standard Time":"Europe/Saratov","SE Asia Standard Time":"Asia/Bangkok","Singapore Standard Time":"Asia/Singapore","South Africa Standard Time":"Africa/Johannesburg","Sri Lanka Standard Time":"Asia/Colombo","Sudan Standard Time":"Africa/Khartoum","Syria Standard Time":"Asia/Damascus","Taipei Standard Time":"Asia/Taipei","Tasmania Standard Time":"Australia/Hobart","Tocantins Standard Time":"America/Araguaina","Tokyo Standard Time":"Asia/Tokyo","Tomsk Standard Time":"Asia/Tomsk","Tonga Standard Time":"Pacific/Tongatapu","Transbaikal Standard Time":"Asia/Chita","Turkey Standard Time":"Europe/Istanbul","Turks And Caicos Standard Time":"America/Grand_Turk","Ulaanbaatar Standard Time":"Asia/Ulaanbaatar","US Eastern Standard Time":"America/Indianapolis","US Mountain Standard Time":"America/Phoenix",UTC:"Etc/GMT","UTC-02":"Etc/GMT+2","UTC-08":"Etc/GMT+8","UTC-09":"Etc/GMT+9","UTC-11":"Etc/GMT+11","UTC+12":"Etc/GMT-12","UTC+13":"Etc/GMT-13","Venezuela Standard Time":"America/Caracas","Vladivostok Standard Time":"Asia/Vladivostok","W. Australia Standard Time":"Australia/Perth","W. Central Africa Standard Time":"Africa/Lagos","W. Europe Standard Time":"Europe/Berlin","W. Mongolia Standard Time":"Asia/Hovd","West Asia Standard Time":"Asia/Tashkent","West Bank Standard Time":"Asia/Hebron","West Pacific Standard Time":"Pacific/Port_Moresby","Yakutsk Standard Time":"Asia/Yakutsk"})}}}),System.register("src/calendar/CalendarParser.js",["node_modules/systemjs-plugin-babel/babel-helpers/slicedToArray.js","../api/common/utils/Utils","luxon","../api/entities/tutanota/CalendarEvent","../api/common/TutanotaConstants","../api/entities/sys/RepeatRule","../api/entities/sys/AlarmInfo","../api/common/utils/DateUtils","../misc/parsing","./WindowsZones"],function(_export,_context){"use strict";var _slicedToArray,downcast,neverNull,DateTime,IANAZone,createCalendarEvent,AlarmInterval,EndType,RepeatPeriod,reverse,createRepeatRule,createAlarmInfo,DAY_IN_MILLIS,combineParsers,makeCharacterParser,makeEitherParser,makeSeparatedByParser,mapParser,maybeParse,numberParser,ParserError,StringIterator,WindowsZones,parameterStringValueParser,escapedStringValueParser,propertyParametersKeyValueParser,parsePropertyParameters,iCalReplacements,anyStringUnescapeParser,propertyStringValueParser,propertySequenceParser,propertyKeyValueParser,valuesSeparatedBySemicolonParser,icalToTutaFrequency,tutaToIcalFrequency,secondDurationParser,minuteDurationParser,hourDurationParser,durationTimeParser,durationDayParser,durationWeekParser,durationDateParser,durationParser;function parseDateString(dateString){return{year:parseInt(dateString.slice(0,4)),month:parseInt(dateString.slice(4,6)),day:parseInt(dateString.slice(6,8))}}function getProp(obj,tag){var prop=obj.properties.find(function(p){return p.name===tag});if(null==prop)throw new ParserError("Missing prop "+tag);return prop}function parseProperty(data){var sequence=propertySequenceParser(new StringIterator(data)),name=sequence[0],params={};sequence[1]&&sequence[1][1].forEach(function(_ref){var _ref2=_slicedToArray(_ref,3),name=_ref2[0],value=(_ref2[1],_ref2[2]);params[name]=value});var value=sequence[3];return{name:name,params:params,value:value}}function parsePropertyKeyValue(data){var value=valuesSeparatedBySemicolonParser(new StringIterator(data)),result={};return value.forEach(function(_ref3){var _ref4=_slicedToArray(_ref3,3),key=_ref4[0],value=(_ref4[1],_ref4[2]);result[key]=value}),result}function parseRrule(rruleProp,tzId){var rruleValue=void 0;try{rruleValue=parsePropertyKeyValue(rruleProp.value)}catch(e){throw e instanceof ParserError?new ParserError("RRULE is not an object "+e.message):e}var value,frequency=(value=rruleValue.FREQ,icalToTutaFrequency[value]),until=rruleValue.UNTIL?parseUntilRruleTime(rruleValue.UNTIL,tzId):null,count=rruleValue.COUNT?parseInt(rruleValue.COUNT):null,endType=null!=until?EndType.UntilDate:null!=count?EndType.Count:EndType.Never,interval=rruleValue.INTERVAL?parseInt(rruleValue.INTERVAL):1,repeatRule=createRepeatRule();return repeatRule.endValue=until?String(until.getTime()):count?String(count):null,repeatRule.endType=endType,repeatRule.interval=String(interval),repeatRule.frequency=frequency,"string"==typeof tzId&&(repeatRule.timeZone=tzId),repeatRule}function getTzId(prop){var tzId=null,tzIdValue=prop.params.TZID;return tzIdValue&&(IANAZone.isValidZone(tzIdValue)?tzId=tzIdValue:tzIdValue in WindowsZones&&(tzId=WindowsZones[tzIdValue])),tzId}function oneDayDurationEnd(startTime,allDay,tzId,zone){return DateTime.fromJSDate(startTime,{zone:allDay?"UTC":tzId||zone}).plus({day:1}).toJSDate()}function parseTimeIntoComponents(value){if(/[0-9]{8}T[0-9]{6}Z/.test(value)){var _parseDateString=parseDateString(value);return{year:_parseDateString.year,month:_parseDateString.month,day:_parseDateString.day,hour:parseInt(value.slice(9,11)),minute:parseInt(value.slice(11,13)),zone:"UTC"}}if(/[0-9]{8}T[0-9]{6}/.test(value)){var _parseDateString2=parseDateString(value);return{year:_parseDateString2.year,month:_parseDateString2.month,day:_parseDateString2.day,hour:parseInt(value.slice(9,11)),minute:parseInt(value.slice(11,13))}}if(/[0-9]{8}/.test(value))return Object.assign({},parseDateString(value));throw new ParserError("Failed to parse time: "+value)}function parseUntilRruleTime(value,zone){var components=parseTimeIntoComponents(value),filledComponents=Object.assign({},components,{zone:"minute"in components?zone:"UTC"});return toValidJSDate(DateTime.fromObject(filledComponents).plus({day:1}).startOf("day"),value,components.zone)}function parseTime(value,zone){var components=parseTimeIntoComponents(value),allDay=!("minute"in components),filledComponents=Object.assign({},allDay?{hour:0,minute:0,second:0,millisecond:0,zone:"UTC"}:{zone:zone},components);return{date:toValidJSDate(DateTime.fromObject(filledComponents),value,zone),allDay:allDay}}function toValidJSDate(dateTime,value,zone){if(!dateTime.isValid)throw new ParserError("Date value "+value+" is invalid in zone "+String(zone));return dateTime.toJSDate()}function parsePropertyName(iterator){for(var text="";iterator.peek()&&/[a-zA-Z0-9-]/.test(iterator.peek());)text+=neverNull(iterator.next().value);if(""===text)throw new ParserError("could not parse property name: "+iterator.peek());return text}function parseDuration(value){var iterator=new StringIterator(value),duration=durationParser(iterator);if(iterator.peek())throw new ParserError("Could not parse duration completely");return duration}return _export("parseProperty",parseProperty),_export("parsePropertyKeyValue",parsePropertyKeyValue),_export("parseICalendar",function(stringData){var iterator=stringData.replace(/\r?\n\s/g,"").split(/\r?\n/).values(),firstLine=iterator.next();if("BEGIN:VCALENDAR"!==firstLine.value)throw new ParserError("Not a VCALENDAR: "+String(firstLine.value));return function parseIcalObject(tag,iterator){for(var iteration=iterator.next(),properties=[],children=[];!iteration.done&&iteration.value;){var property=parseProperty(iteration.value);if("END"===property.name&&property.value===tag)return{type:tag,properties:properties,children:children};if("BEGIN"===property.name){if("string"!=typeof property.value)throw new ParserError("BEGIN with array value");children.push(parseIcalObject(property.value,iterator))}else properties.push(property);iteration=iterator.next()}throw new ParserError("no end for tag "+tag)}("VCALENDAR",iterator)}),_export("parseCalendarEvents",function(icalObject,zone){return icalObject.children.filter(function(obj){return"VEVENT"===obj.type}).map(function(eventObj){var event=createCalendarEvent(),startProp=getProp(eventObj,"DTSTART");if("string"!=typeof startProp.value)throw new ParserError("DTSTART value is not a string");var tzId=getTzId(startProp),_parseTime=parseTime(startProp.value,tzId),startTime=_parseTime.date,allDay=_parseTime.allDay;event.startTime=startTime;var endProp=eventObj.properties.find(function(p){return"DTEND"===p.name});if(endProp){if("string"!=typeof endProp.value)throw new ParserError("DTEND value is not a string");var endTzId=getTzId(endProp);event.endTime=parseTime(endProp.value,"string"==typeof endTzId?endTzId:null).date,event.endTime<=event.startTime&&(event.endTime=oneDayDurationEnd(startTime,allDay,tzId,zone))}else{var durationProp=eventObj.properties.find(function(p){return"DURATION"===p.name});durationProp?function(durationProp,event){if("string"!=typeof durationProp.value)throw new ParserError("DURATION value is not a string");var duration=parseDuration(durationProp.value),durationInMillis=0;duration.week&&(durationInMillis+=7*DAY_IN_MILLIS*duration.week),duration.day&&(durationInMillis+=DAY_IN_MILLIS*duration.day),duration.hour&&(durationInMillis+=36e5*duration.hour),duration.minute&&(durationInMillis+=6e4*duration.minute),event.endTime=new Date(event.startTime.getTime()+durationInMillis)}(durationProp,event):event.endTime=oneDayDurationEnd(startTime,allDay,tzId,zone)}var summaryProp=eventObj.properties.find(function(p){return"SUMMARY"===p.name});summaryProp&&"string"==typeof summaryProp.value&&(event.summary=summaryProp.value);var locationProp=eventObj.properties.find(function(p){return"LOCATION"===p.name});if(locationProp){if("string"!=typeof locationProp.value)throw new ParserError("LOCATION value is not a string");event.location=locationProp.value}var rruleProp=eventObj.properties.find(function(p){return"RRULE"===p.name});null!=rruleProp&&(event.repeatRule=parseRrule(rruleProp,tzId));var descriptionProp=eventObj.properties.find(function(p){return"DESCRIPTION"===p.name});if(descriptionProp){if("string"!=typeof descriptionProp.value)throw new ParserError("DESCRIPTION value is not a string");event.description=descriptionProp.value}var alarms=[];return eventObj.children.forEach(function(alarmChild){if("VALARM"===alarmChild.type){var newAlarm=function(alarmObject,event){var triggerProp=getProp(alarmObject,"TRIGGER");if("DISPLAY"!==getProp(alarmObject,"ACTION").value)return null;var triggerValue=triggerProp.value;if("string"!=typeof triggerValue)throw new ParserError("expected TRIGGER property to be a string: "+JSON.stringify(triggerProp));var trigger=void 0;if(triggerValue.endsWith("Z")){var triggerTime=parseTime(triggerValue).date,tillEvent=event.startTime.getTime()-triggerTime.getTime();if(tillEvent>=7*DAY_IN_MILLIS)trigger=AlarmInterval.ONE_WEEK;else if(tillEvent>=3*DAY_IN_MILLIS)trigger=AlarmInterval.THREE_DAYS;else if(tillEvent>=2*DAY_IN_MILLIS)trigger=AlarmInterval.TWO_DAYS;else if(tillEvent>=DAY_IN_MILLIS)trigger=AlarmInterval.ONE_DAY;else if(tillEvent>=36e5)trigger=AlarmInterval.ONE_HOUR;else if(tillEvent>=18e5)trigger=AlarmInterval.THIRTY_MINUTES;else if(tillEvent>=6e5)trigger=AlarmInterval.TEN_MINUTES;else{if(!(tillEvent>=0))return null;trigger=AlarmInterval.FIVE_MINUTES}}else{var duration=parseDuration(triggerValue);if(duration.positive)return null;trigger=duration.week?AlarmInterval.ONE_WEEK:duration.day?duration.day>=3?AlarmInterval.THREE_DAYS:2===duration.day?AlarmInterval.TWO_DAYS:AlarmInterval.ONE_DAY:duration.hour?duration.hour>1?AlarmInterval.ONE_DAY:AlarmInterval.ONE_HOUR:duration.minute?duration.minute>30?AlarmInterval.ONE_HOUR:duration.minute>10?AlarmInterval.THIRTY_MINUTES:duration.minute>5?AlarmInterval.TEN_MINUTES:AlarmInterval.FIVE_MINUTES:AlarmInterval.THREE_DAYS}return Object.assign(createAlarmInfo(),{trigger:trigger})}(alarmChild,event);newAlarm&&alarms.push(newAlarm)}}),event.uid=function(obj,tag){var prop=getProp(obj,tag);if("string"!=typeof prop.value)throw new ParserError("value of "+tag+" is not of type string");return prop.value}(eventObj,"UID"),{event:event,alarms:alarms}})}),_export("parseTimeIntoComponents",parseTimeIntoComponents),_export("parseUntilRruleTime",parseUntilRruleTime),_export("parseTime",parseTime),_export("parseDuration",parseDuration),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs){_slicedToArray=_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs.default},function(_apiCommonUtilsUtils){downcast=_apiCommonUtilsUtils.downcast,neverNull=_apiCommonUtilsUtils.neverNull},function(_luxon){DateTime=_luxon.DateTime,IANAZone=_luxon.IANAZone},function(_apiEntitiesTutanotaCalendarEvent){createCalendarEvent=_apiEntitiesTutanotaCalendarEvent.createCalendarEvent},function(_apiCommonTutanotaConstants){AlarmInterval=_apiCommonTutanotaConstants.AlarmInterval,EndType=_apiCommonTutanotaConstants.EndType,RepeatPeriod=_apiCommonTutanotaConstants.RepeatPeriod,reverse=_apiCommonTutanotaConstants.reverse},function(_apiEntitiesSysRepeatRule){createRepeatRule=_apiEntitiesSysRepeatRule.createRepeatRule},function(_apiEntitiesSysAlarmInfo){createAlarmInfo=_apiEntitiesSysAlarmInfo.createAlarmInfo},function(_apiCommonUtilsDateUtils){DAY_IN_MILLIS=_apiCommonUtilsDateUtils.DAY_IN_MILLIS},function(_miscParsing){combineParsers=_miscParsing.combineParsers,makeCharacterParser=_miscParsing.makeCharacterParser,makeEitherParser=_miscParsing.makeEitherParser,makeSeparatedByParser=_miscParsing.makeSeparatedByParser,mapParser=_miscParsing.mapParser,maybeParse=_miscParsing.maybeParse,numberParser=_miscParsing.numberParser,ParserError=_miscParsing.ParserError,StringIterator=_miscParsing.StringIterator},function(_WindowsZones){WindowsZones=_WindowsZones.default}],execute:function(){parameterStringValueParser=function(iterator){for(var value="";iterator.peek()&&!1===/[:;,]/.test(iterator.peek());)value+=neverNull(iterator.next().value);return value},escapedStringValueParser=function(iterator){if('"'!==iterator.next().value)throw new ParserError("Not a quoted value");for(var value="";iterator.peek()&&'"'!==iterator.peek();)value+=neverNull(iterator.next().value);if(""===!iterator.peek())throw new Error("Not a quoted value, does not end with quote: "+value);return iterator.next(),value},propertyParametersKeyValueParser=combineParsers(parsePropertyName,makeCharacterParser("="),makeEitherParser(escapedStringValueParser,parameterStringValueParser)),parsePropertyParameters=combineParsers(makeCharacterParser(";"),makeSeparatedByParser(makeCharacterParser(";"),propertyParametersKeyValueParser)),_export("iCalReplacements",iCalReplacements={";":"\\;","\\":"\\\\","\n":"\\n"}),_export("iCalReplacements",iCalReplacements),anyStringUnescapeParser=function(iterator){for(var value="",lastCharacter=null;iterator.peek();){if("\\"===(lastCharacter=iterator.next().value)){if(iterator.peek()in iCalReplacements)continue;if("n"===iterator.peek()){iterator.next(),value+="\n";continue}}value+=neverNull(lastCharacter)}return value},propertyStringValueParser=function(iterator){for(var value="";iterator.peek()&&!1===/[;]/.test(iterator.peek());)value+=neverNull(iterator.next().value);return value},_export("propertySequenceParser",propertySequenceParser=combineParsers(parsePropertyName,maybeParse(parsePropertyParameters),makeCharacterParser(":"),anyStringUnescapeParser)),_export("propertySequenceParser",propertySequenceParser),propertyKeyValueParser=combineParsers(parsePropertyName,makeCharacterParser("="),propertyStringValueParser),valuesSeparatedBySemicolonParser=makeSeparatedByParser(makeCharacterParser(";"),propertyKeyValueParser),icalToTutaFrequency={DAILY:RepeatPeriod.DAILY,WEEKLY:RepeatPeriod.WEEKLY,MONTHLY:RepeatPeriod.MONTHLY,YEARLY:RepeatPeriod.ANNUALLY},_export("tutaToIcalFrequency",tutaToIcalFrequency=reverse(icalToTutaFrequency)),_export("tutaToIcalFrequency",tutaToIcalFrequency),secondDurationParser=combineParsers(numberParser,makeCharacterParser("S")),minuteDurationParser=combineParsers(numberParser,makeCharacterParser("M"),maybeParse(secondDurationParser)),hourDurationParser=combineParsers(numberParser,makeCharacterParser("H"),maybeParse(minuteDurationParser)),durationTimeParser=mapParser(combineParsers(makeCharacterParser("T"),makeEitherParser(hourDurationParser,makeEitherParser(minuteDurationParser,secondDurationParser))),function(_ref5){var _ref6=_slicedToArray(_ref5,2),value=(_ref6[0],_ref6[1]),minuteTuple=void 0,secondTuple=void 0,hour=void 0,minute=void 0,second=void 0;return"H"===value[1]?(hour=value[0],minuteTuple=downcast(value)[2]):"M"===value[1]?minuteTuple=value:"S"===value[1]&&(secondTuple=value),minuteTuple&&(minute=minuteTuple[0],secondTuple=downcast(minuteTuple)[2]),secondTuple&&(second=secondTuple[0]),{type:"time",hour:hour,minute:minute,second:second}}),durationDayParser=combineParsers(numberParser,makeCharacterParser("D")),durationWeekParser=mapParser(combineParsers(numberParser,makeCharacterParser("W")),function(parsed){return{type:"week",week:parsed[0]}}),durationDateParser=mapParser(combineParsers(durationDayParser,maybeParse(durationTimeParser)),function(parsed){return{type:"date",day:parsed[0][0],time:parsed[1]}}),durationParser=mapParser(combineParsers(maybeParse(makeEitherParser(makeCharacterParser("+"),makeCharacterParser("-"))),makeCharacterParser("P"),makeEitherParser(durationDateParser,makeEitherParser(durationTimeParser,durationWeekParser))),function(_ref7){var _ref8=_slicedToArray(_ref7,3),sign=_ref8[0],durationValue=(_ref8[1],_ref8[2]),positive="-"!==sign,day=void 0,timeDuration=void 0,week=void 0,hour=void 0,minute=void 0;switch(durationValue.type){case"date":day=durationValue.day,timeDuration=durationValue.time;break;case"time":timeDuration=durationValue;break;case"week":week=durationValue.week}return timeDuration&&(hour=timeDuration.hour,minute=timeDuration.minute),{positive:positive,day:day,hour:hour,minute:minute,week:week}})}}}),System.register("src/misc/parsing.js",["node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/possibleConstructorReturn.js","node_modules/systemjs-plugin-babel/babel-helpers/inherits.js","../api/common/utils/Utils","../api/common/error/TutanotaError"],function(_export,_context){"use strict";var _createClass,_classCallCheck,_possibleConstructorReturn,_inherits,downcast,TutanotaError,ParserError,combineParsers,numberParser,StringIterator;function mapParser(parser,mapper){return function(iterator){return mapper(parser(iterator))}}return _export("makeCharacterParser",function(character){return function(iterator){var value=iterator.peek();if(value===character)return iterator.next(),value;throw new ParserError("expected character "+character)}}),_export("mapParser",mapParser),_export("maybeParse",function(parser){return function(iterator){try{return parser(iterator)}catch(e){return null}}}),_export("makeSeparatedByParser",function(separatorParser,valueParser){return function(iterator){var result=[];for(result.push(valueParser(iterator));;){try{separatorParser(iterator)}catch(e){break}result.push(valueParser(iterator))}return result}}),_export("makeEitherParser",function(parserA,parserB){return function(iterator){var iteratorPosition=iterator.position;try{return parserA(iterator)}catch(e){if(e instanceof ParserError)return iterator.position=iteratorPosition,parserB(iterator);throw e}}}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersPossibleConstructorReturnJs){_possibleConstructorReturn=_node_modulesSystemjsPluginBabelBabelHelpersPossibleConstructorReturnJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersInheritsJs){_inherits=_node_modulesSystemjsPluginBabelBabelHelpersInheritsJs.default},function(_apiCommonUtilsUtils){downcast=_apiCommonUtilsUtils.downcast},function(_apiCommonErrorTutanotaError){TutanotaError=_apiCommonErrorTutanotaError.TutanotaError}],execute:function(){var anotherParser,allowed;_export("ParserError",ParserError=function(_TutanotaError){function ParserError(message,filename){_classCallCheck(this,ParserError);var _this=_possibleConstructorReturn(this,(ParserError.__proto__||Object.getPrototypeOf(ParserError)).call(this,"ParserError",message));return _this.filename=filename,_this}return _inherits(ParserError,TutanotaError),ParserError}()),_export("ParserError",ParserError),_export("combineParsers",combineParsers=downcast(function(){for(var _len=arguments.length,parsers=Array(_len),_key=0;_key<_len;_key++)parsers[_key]=arguments[_key];return function(iterator){return parsers.map(function(p){return p(iterator)})}})),_export("combineParsers",combineParsers),_export("numberParser",numberParser=mapParser((allowed=["0","1","2","3","4","5","6","7","8","9"],mapParser((anotherParser=function(iterator){var value=iterator.peek();if(allowed.includes(value))return iterator.next(),value;throw new ParserError("Expected one of "+String(allowed)+", got "+value)},function(iterator){var result=[];try{for(var parseResult=anotherParser(iterator);;)result.push(parseResult),parseResult=anotherParser(iterator)}catch(e){}return result}),function(value){if(0===value.length)throw new ParserError("Expected at least one value, got none");return value})),function(values){return parseInt(values.join(""),10)})),_export("numberParser",numberParser),_export("StringIterator",StringIterator=function(){function StringIterator(iteratee){_classCallCheck(this,StringIterator),this.position=-1,this.iteratee=iteratee}return _createClass(StringIterator,[{key:"next",value:function(){return{value:this.iteratee[++this.position],done:this.position>=this.iteratee.length}}},{key:"peek",value:function(){return this.iteratee[this.position+1]}}]),StringIterator}()),_export("StringIterator",StringIterator)}}}),System.register("src/calendar/CalendarImporter.js",["node_modules/systemjs-plugin-babel/babel-helpers/toConsumableArray.js","../file/FileController","../api/common/utils/Encoding","./CalendarParser","../api/common/utils/CommonCalendarUtils","../api/main/WorkerClient","./CalendarUtils","../gui/base/ProgressDialog","../api/main/Entity","../api/entities/tutanota/CalendarEvent","../api/entities/tutanota/File","../api/common/DataFile","../api/common/utils/StringUtils","../api/common/TutanotaConstants","../api/common/utils/Utils","../api/common/EntityFunctions","../api/entities/sys/UserAlarmInfo","mithril/stream/stream.js","../misc/parsing","../gui/base/Dialog","../misc/LanguageViewModel","../api/common/utils/DateUtils","luxon"],function(_export,_context){"use strict";var _toConsumableArray,fileController,stringToUtf8Uint8Array,utf8Uint8ArrayToString,iCalReplacements,parseCalendarEvents,parseICalendar,tutaToIcalFrequency,generateEventElementId,isAllDayEvent,worker,createEventId,generateUid,getTimeZone,showProgressDialog,loadAll,loadMultiple,CalendarEventTypeRef,createFile,createDataFile,pad,AlarmInterval,EndType,SECOND_MS,downcast,neverNull,ProgressMonitor,elementIdPart,isSameId,listIdPart,UserAlarmInfoTypeRef,stream,ParserError,Dialog,lang,incrementDate,DateTime;function parseFile(file){try{return parseCalendarStringData(utf8Uint8ArrayToString(file.data),getTimeZone())}catch(e){throw e instanceof ParserError?new ParserError(e.message,file.name):e}}function parseCalendarStringData(value,zone){var tree=parseICalendar(value);return parseCalendarEvents(tree,zone)}function loadAllEvents(groupRoot){return loadAll(CalendarEventTypeRef,groupRoot.longEvents).then(function(longEvents){return loadAll(CalendarEventTypeRef,groupRoot.shortEvents).then(function(shortEvents){return shortEvents.concat(longEvents)})})}function serializeCalendar(versionNumber,events,now,zone){var value=["BEGIN:VCALENDAR","PRODID:-//Tutao GmbH//Tutanota "+versionNumber+"//EN","VERSION:2.0","CALSCALE:GREGORIAN","METHOD:PUBLISH"],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=events[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var _ref3=_step2.value,_event=_ref3.event,_alarms=_ref3.alarms;value.push.apply(value,_toConsumableArray(serializeEvent(_event,_alarms,now,zone)))}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return value.push.apply(value,["END:VCALENDAR"]),value.join("\r\n")}function serializeAlarm(event,alarm){return["BEGIN:VALARM","ACTION:DISPLAY","DESCRIPTION:This is an event reminder","TRIGGER:"+function(alarmInterval){switch(alarmInterval){case AlarmInterval.FIVE_MINUTES:return"-PT05M";case AlarmInterval.TEN_MINUTES:return"-PT10M";case AlarmInterval.THIRTY_MINUTES:return"-PT30M";case AlarmInterval.ONE_HOUR:return"-PT01H";case AlarmInterval.ONE_DAY:return"-P1D";case AlarmInterval.TWO_DAYS:return"-P2D";case AlarmInterval.THREE_DAYS:return"-P3D";case AlarmInterval.ONE_WEEK:return"-P1W";default:throw new Error("unknown alarm interval: "+alarmInterval)}}(downcast(alarm.alarmInfo.trigger)),"END:VALARM"]}function serializeEvent(event,alarms,now,timeZone){var _concat$concat$concat,repeatRule=event.repeatRule,isAllDay=isAllDayEvent(event),dateStart=void 0,dateEnd=void 0;return isAllDay?(dateStart="DTSTART;VALUE=DATE:"+formatDate(event.startTime,timeZone),dateEnd="DTEND;VALUE=DATE:"+formatDate(event.endTime,timeZone)):repeatRule?(dateStart="DTSTART;TZID="+repeatRule.timeZone+":"+formatDateTime(event.startTime,repeatRule.timeZone),dateEnd="DTEND;TZID="+repeatRule.timeZone+":"+formatDateTime(event.endTime,repeatRule.timeZone)):(dateStart="DTSTART:"+formatDateTimeUTC(event.startTime),dateEnd="DTEND:"+formatDateTimeUTC(event.endTime)),(_concat$concat$concat=["BEGIN:VEVENT",dateStart,dateEnd,"DTSTAMP:"+formatDateTimeUTC(now),"UID:"+(event.uid?event.uid:generateUid(event,now.getTime())),"SUMMARY:"+escapeSemicolons(event.summary)].concat(event.description&&""!==event.description?"DESCRIPTION:"+escapeSemicolons(event.description):[]).concat(function(repeatRule,isAllDayEvent,localTimeZone){if(repeatRule){var endType="";if(repeatRule.endType===EndType.Count)endType=";COUNT="+neverNull(repeatRule.endValue);else if(repeatRule.endType===EndType.UntilDate){var date=new Date(Number(repeatRule.endValue));endType=";UNTIL="+(isAllDayEvent?formatDate(incrementDate(date,-1),localTimeZone):formatDateTimeUTC(new Date(date.getTime()-SECOND_MS)))}return["RRULE:FREQ="+tutaToIcalFrequency[repeatRule.frequency]+";INTERVAL="+repeatRule.interval+endType]}return[]}(repeatRule,isAllDay,timeZone)).concat(event.location&&event.location.length>0?"LOCATION:"+escapeSemicolons(event.location):[])).concat.apply(_concat$concat$concat,_toConsumableArray(alarms.map(function(alarm){return serializeAlarm(0,alarm)}))).concat("END:VEVENT")}function escapeSemicolons(value){return value.replace(/[;\\\n]/g,function(ch){return iCalReplacements[ch]})}function pad2(number){return pad(number,2)}function formatDateTime(date,timeZone){var dateTime=DateTime.fromJSDate(date,{zone:timeZone});return""+dateTime.year+pad2(dateTime.month)+pad2(dateTime.day)+"T"+pad2(dateTime.hour)+pad2(dateTime.minute)+pad2(dateTime.second)}function formatDateTimeUTC(date){return""+date.getUTCFullYear()+pad2(date.getUTCMonth()+1)+pad2(date.getUTCDate())+"T"+pad2(date.getUTCHours())+pad2(date.getUTCMinutes())+pad2(date.getUTCSeconds())+"Z"}function formatDate(date,timeZone){var dateTime=DateTime.fromJSDate(date,{zone:timeZone});return""+dateTime.year+pad2(dateTime.month)+pad2(dateTime.day)}return _export("showCalendarImportDialog",function(calendarGroupRoot){fileController.showFileChooser(!0,["ical","ics","ifb","icalendar"]).then(function(dataFiles){var parsedEvents=dataFiles.map(parseFile),totalCount=parsedEvents.reduce(function(acc,eventsWithAlarms){return acc+eventsWithAlarms.length},0),progress=stream(0),progressMonitor=new ProgressMonitor(totalCount,progress),zone=getTimeZone(),importPromise=loadAllEvents(calendarGroupRoot).then(function(events){var uidToEvent=new Map;return events.forEach(function(event){event.uid&&uidToEvent.set(event.uid,event)}),Promise.each(parsedEvents,function(events){return Promise.each(events,function(_ref){var event=_ref.event,alarms=_ref.alarms;if(!event.uid||!uidToEvent.has(event.uid)){var repeatRule=event.repeatRule;createEventId(event,zone,calendarGroupRoot),event._ownerGroup=calendarGroupRoot._id,repeatRule&&""===repeatRule.timeZone&&(repeatRule.timeZone=getTimeZone());var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=alarms[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)_step.value.alarmIdentifier=generateEventElementId(Date.now())}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return createEventId(event,zone,calendarGroupRoot),worker.createCalendarEvent(event,alarms,null).then(function(){return progressMonitor.workDone(1)}).delay(100)}})})});return showProgressDialog("importCalendar_label",importPromise.then(function(){return progress(100)}),progress)}).catch(ParserError,function(e){console.log("Failed to parse file",e),Dialog.error(function(){return lang.get("importReadFileError_msg",{"{filename}":e.filename})})})}),_export("parseCalendarStringData",parseCalendarStringData),_export("exportCalendar",function(calendarName,groupRoot,userAlarmInfos,now,zone){showProgressDialog("pleaseWait_msg",loadAllEvents(groupRoot).then(function(allEvents){return Promise.map(allEvents,function(event){var thisUserAlarms=event.alarmInfos.filter(function(alarmInfoId){return isSameId(userAlarmInfos,listIdPart(alarmInfoId))});return thisUserAlarms.length>0?loadMultiple(UserAlarmInfoTypeRef,userAlarmInfos,thisUserAlarms.map(elementIdPart)).then(function(alarms){return{event:event,alarms:alarms}}):{event:event,alarms:[]}})}).then(function(eventsWithAlarms){return function(calendarName,events,now,zone){var stringValue=serializeCalendar(env.versionNumber,events,now,zone),data=stringToUtf8Uint8Array(stringValue),tmpFile=createFile();return tmpFile.name=""===calendarName?"export.ics":calendarName+"-export.ics",tmpFile.mimeType="text/calendar",tmpFile.size=String(data.byteLength),fileController.open(createDataFile(tmpFile,data))}(calendarName,eventsWithAlarms,now,zone)}))}),_export("serializeCalendar",serializeCalendar),_export("serializeEvent",serializeEvent),_export("formatDateTime",formatDateTime),_export("formatDateTimeUTC",formatDateTimeUTC),_export("formatDate",formatDate),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs){_toConsumableArray=_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs.default},function(_fileFileController){fileController=_fileFileController.fileController},function(_apiCommonUtilsEncoding){stringToUtf8Uint8Array=_apiCommonUtilsEncoding.stringToUtf8Uint8Array,utf8Uint8ArrayToString=_apiCommonUtilsEncoding.utf8Uint8ArrayToString},function(_CalendarParser){iCalReplacements=_CalendarParser.iCalReplacements,parseCalendarEvents=_CalendarParser.parseCalendarEvents,parseICalendar=_CalendarParser.parseICalendar,tutaToIcalFrequency=_CalendarParser.tutaToIcalFrequency},function(_apiCommonUtilsCommonCalendarUtils){generateEventElementId=_apiCommonUtilsCommonCalendarUtils.generateEventElementId,isAllDayEvent=_apiCommonUtilsCommonCalendarUtils.isAllDayEvent},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_CalendarUtils){createEventId=_CalendarUtils.createEventId,generateUid=_CalendarUtils.generateUid,getTimeZone=_CalendarUtils.getTimeZone},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiMainEntity){loadAll=_apiMainEntity.loadAll,loadMultiple=_apiMainEntity.loadMultiple},function(_apiEntitiesTutanotaCalendarEvent){CalendarEventTypeRef=_apiEntitiesTutanotaCalendarEvent.CalendarEventTypeRef},function(_apiEntitiesTutanotaFile){createFile=_apiEntitiesTutanotaFile.createFile},function(_apiCommonDataFile){createDataFile=_apiCommonDataFile.createDataFile},function(_apiCommonUtilsStringUtils){pad=_apiCommonUtilsStringUtils.pad},function(_apiCommonTutanotaConstants){AlarmInterval=_apiCommonTutanotaConstants.AlarmInterval,EndType=_apiCommonTutanotaConstants.EndType,SECOND_MS=_apiCommonTutanotaConstants.SECOND_MS},function(_apiCommonUtilsUtils){downcast=_apiCommonUtilsUtils.downcast,neverNull=_apiCommonUtilsUtils.neverNull,ProgressMonitor=_apiCommonUtilsUtils.ProgressMonitor},function(_apiCommonEntityFunctions){elementIdPart=_apiCommonEntityFunctions.elementIdPart,isSameId=_apiCommonEntityFunctions.isSameId,listIdPart=_apiCommonEntityFunctions.listIdPart},function(_apiEntitiesSysUserAlarmInfo){UserAlarmInfoTypeRef=_apiEntitiesSysUserAlarmInfo.UserAlarmInfoTypeRef},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_miscParsing){ParserError=_miscParsing.ParserError},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonUtilsDateUtils){incrementDate=_apiCommonUtilsDateUtils.incrementDate},function(_luxon){DateTime=_luxon.DateTime}],execute:function(){}}}),System.register("src/calendar/CalendarSharingDialog.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","node_modules/systemjs-plugin-babel/babel-helpers/slicedToArray.js","../gui/base/Dialog","mithril","mithril/stream/stream.js","../api/entities/sys/GroupMember","../api/main/Entity","../gui/base/TableN","../api/common/utils/Utils","../gui/base/icons/Icons","../misc/LanguageViewModel","../gui/base/BubbleTextField","../misc/MailAddressBubbleHandler","../mail/MailUtils","../gui/base/DropdownN","../gui/base/ButtonN","../api/common/utils/ArrayUtils","../gui/base/ProgressDialog","../api/entities/sys/Group","../api/common/TutanotaConstants","../api/common/EntityFunctions","./CalendarUtils","../api/main/WorkerClient","../gui/base/DropDownSelectorN","../api/entities/sys/SentGroupInvitation","../api/common/error/RestError","../subscription/WhitelabelAndSharingBuyDialog","../api/main/LoginController","../api/common/error/RecipientsNotFoundError","../api/main/EventController","../api/main/MainLocator","./CalendarSharingUtils","../gui/base/TextFieldN","../subscription/PriceUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,_slicedToArray,Dialog,DialogType,m,stream,GroupMemberTypeRef,load,loadAll,ColumnWidth,TableN,downcast,neverNull,Icons,lang,Bubble,BubbleTextField,MailAddressBubbleHandler,createRecipientInfo,getDisplayText,attachDropdown,ButtonType,findAndRemove,remove,showProgressDialog,GroupTypeRef,OperationType,ShareCapability,getElementId,isSameId,getCalendarName,getCapabilityText,hasCapabilityOnGroup,isSharedGroupOwner,worker,DropDownSelectorN,SentGroupInvitationTypeRef,NotFoundError,PreconditionFailedError,showSharingBuyDialog,logins,RecipientsNotFoundError,isUpdateForTypeRef,locator,loadGroupInfoForMember,loadGroupMembers,sendShareNotificationEmail,TextFieldN,premiumSubscriptionActive,CalendarSharingDialogContent;function showAddParticipantDialog(sharedGroupInfo){var invitePeopleValueTextField=new BubbleTextField("shareWithEmailRecipient_label",new MailAddressBubbleHandler({createBubble:function(name,mailAddress,contact){var _this3=this,recipientInfo=createRecipientInfo(mailAddress,name,contact,!1),bubbleWrapper={};return bubbleWrapper.buttonAttrs=attachDropdown({label:function(){return getDisplayText(recipientInfo.name,mailAddress,!1)},type:ButtonType.TextBubble,isSelected:function(){return!1}},function(){return _this3._createBubbleContextButtons(recipientInfo.name,mailAddress)}),bubbleWrapper.bubble=new Bubble(recipientInfo,neverNull(bubbleWrapper.buttonAttrs),mailAddress),bubbleWrapper.bubble},_createBubbleContextButtons:function(name,mailAddress){var buttonAttrs=[mailAddress];return buttonAttrs.push({label:"remove_action",type:ButtonType.Secondary,click:function(){var bubbleToRemove=invitePeopleValueTextField.bubbles.find(function(bubble){return bubble.entity.mailAddress===mailAddress});bubbleToRemove&&remove(invitePeopleValueTextField.bubbles,bubbleToRemove)}}),buttonAttrs}})),capapility=stream(ShareCapability.Read),realCalendarName=getCalendarName(sharedGroupInfo,!1),customCalendarName=getCalendarName(sharedGroupInfo,!0),dialog=Dialog.showActionDialog({type:DialogType.EditMedium,title:function(){return lang.get("addParticipant_action")},child:function(){return[m(".pt",lang.get("shareCalendarWarning_msg")+" "+lang.get("shareCalendarWarningAliases_msg")),m(invitePeopleValueTextField),m(DropDownSelectorN,{label:"permissions_label",items:[{name:getCapabilityText(ShareCapability.Invite),value:ShareCapability.Invite},{name:getCapabilityText(ShareCapability.Write),value:ShareCapability.Write},{name:getCapabilityText(ShareCapability.Read),value:ShareCapability.Read}],selectedValue:capapility,dropdownWidth:300}),m(TextFieldN,{value:stream(realCalendarName),label:"calendarName_label",disabled:!0,helpLabel:function(){return m("",customCalendarName===realCalendarName?null:lang.get("customName_label",{"{customName}":customCalendarName}))}})]},okAction:function(){if(invitePeopleValueTextField.createBubbles(),0===invitePeopleValueTextField.bubbles.length)return Dialog.error("noRecipients_msg");var recipients=invitePeopleValueTextField.bubbles.map(function(b){return b.entity});(function(sharedGroupInfo,recipients,capability){return premiumSubscriptionActive(!1).then(function(ok){return ok?showProgressDialog("calendarInvitationProgress_msg",worker.sendGroupInvitation(sharedGroupInfo,getCalendarName(sharedGroupInfo,!1),recipients,capability)).then(function(groupInvitationReturn){if(groupInvitationReturn.existingMailAddresses.length>0||groupInvitationReturn.invalidMailAddresses.length>0){var existingMailAddresses=groupInvitationReturn.existingMailAddresses.map(function(ma){return ma.address}).join("\n"),invalidMailAddresses=groupInvitationReturn.invalidMailAddresses.map(function(ma){return ma.address}).join("\n");Dialog.error(function(){var msg="";return msg+=0===existingMailAddresses.length?"":lang.get("existingMailAddress_msg")+"\n"+existingMailAddresses,msg+=0===existingMailAddresses.length&&0===invalidMailAddresses.length?"":"\n\n",msg+=0===invalidMailAddresses.length?"":lang.get("invalidMailAddress_msg")+"\n"+invalidMailAddresses})}return groupInvitationReturn.invitedMailAddresses}).catch(PreconditionFailedError,function(e){return logins.getUserController().isGlobalAdmin()?Dialog.confirm("sharingFeatureNotOrderedAdmin_msg").then(function(confirmed){confirmed&&showSharingBuyDialog(!0)}).return([]):Dialog.error("sharingFeatureNotOrderedUser_msg").return([])}).catch(RecipientsNotFoundError,function(e){var invalidRecipients=e.message.join("\n");return Dialog.error(function(){return lang.get("invalidRecipients_msg")+"\n"+invalidRecipients}).return([])}):Promise.resolve([])})})(sharedGroupInfo,recipients,capapility()).then(function(invitedMailAddresses){invitedMailAddresses.length>0&&(dialog.close(),sendShareNotificationEmail(sharedGroupInfo,invitedMailAddresses.map(function(ma){return createRecipientInfo(ma.address,null,null,!0)})))})},okActionTextId:"invite_alt"}).setCloseHandler(function(){dialog.close()})}return _export("showCalendarSharingDialog",function(groupInfo,allowGroupNameOverride){showProgressDialog("loading_msg",function(groupInfo){return load(GroupTypeRef,groupInfo.group).then(function(group){return Promise.all([loadAll(SentGroupInvitationTypeRef,group.invitations),loadGroupMembers(group)]).then(function(_ref){var _ref2=_slicedToArray(_ref,2),invitations=_ref2[0],memberInfos=_ref2[1];return{group:group,info:groupInfo,memberInfos:memberInfos,sentGroupInvitations:invitations}})})}(groupInfo)).then(function(groupDetails){var eventListener=function(updates,eventOwnerGroupId){updates.forEach(function(update){isSameId(eventOwnerGroupId,groupDetails.group._id)&&(isUpdateForTypeRef(SentGroupInvitationTypeRef,update)?(update.operation===OperationType.CREATE&&isSameId(update.instanceListId,groupDetails.group.invitations)&&load(SentGroupInvitationTypeRef,[update.instanceListId,update.instanceId]).then(function(instance){instance&&(groupDetails.sentGroupInvitations.push(instance),m.redraw())}).catch(NotFoundError,function(e){return console.log("sent invitation not found",update)}),update.operation===OperationType.DELETE&&(findAndRemove(groupDetails.sentGroupInvitations,function(sentGroupInvitation){return isSameId(getElementId(sentGroupInvitation),update.instanceId)}),m.redraw())):isUpdateForTypeRef(GroupMemberTypeRef,update)&&(console.log("update received in share dialog",update),update.operation===OperationType.CREATE&&isSameId(update.instanceListId,groupDetails.group.members)&&load(GroupMemberTypeRef,[update.instanceListId,update.instanceId]).then(function(instance){if(instance)return loadGroupInfoForMember(instance).then(function(groupMemberInfo){console.log("new member",groupMemberInfo),groupDetails.memberInfos.push(groupMemberInfo),m.redraw()})}).catch(NotFoundError,function(e){return console.log("group member not found",update)}),update.operation===OperationType.DELETE&&(findAndRemove(groupDetails.memberInfos,function(memberInfo){return isSameId(getElementId(memberInfo.member),update.instanceId)}),m.redraw())))})};locator.eventController.addEntityListener(eventListener),Dialog.showActionDialog({title:lang.get("sharing_label"),type:DialogType.EditMedium,child:function(){return m(CalendarSharingDialogContent,{groupDetails:groupDetails,allowGroupNameOverride:allowGroupNameOverride})},okAction:null,cancelAction:function(){return locator.eventController.removeEntityListener(eventListener)},cancelActionTextId:"close_alt"})})}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs){_slicedToArray=_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiEntitiesSysGroupMember){GroupMemberTypeRef=_apiEntitiesSysGroupMember.GroupMemberTypeRef},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth,TableN=_guiBaseTableN.TableN},function(_apiCommonUtilsUtils){downcast=_apiCommonUtilsUtils.downcast,neverNull=_apiCommonUtilsUtils.neverNull},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseBubbleTextField){Bubble=_guiBaseBubbleTextField.Bubble,BubbleTextField=_guiBaseBubbleTextField.BubbleTextField},function(_miscMailAddressBubbleHandler){MailAddressBubbleHandler=_miscMailAddressBubbleHandler.MailAddressBubbleHandler},function(_mailMailUtils){createRecipientInfo=_mailMailUtils.createRecipientInfo,getDisplayText=_mailMailUtils.getDisplayText},function(_guiBaseDropdownN){attachDropdown=_guiBaseDropdownN.attachDropdown},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType},function(_apiCommonUtilsArrayUtils){findAndRemove=_apiCommonUtilsArrayUtils.findAndRemove,remove=_apiCommonUtilsArrayUtils.remove},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiEntitiesSysGroup){GroupTypeRef=_apiEntitiesSysGroup.GroupTypeRef},function(_apiCommonTutanotaConstants){OperationType=_apiCommonTutanotaConstants.OperationType,ShareCapability=_apiCommonTutanotaConstants.ShareCapability},function(_apiCommonEntityFunctions){getElementId=_apiCommonEntityFunctions.getElementId,isSameId=_apiCommonEntityFunctions.isSameId},function(_CalendarUtils){getCalendarName=_CalendarUtils.getCalendarName,getCapabilityText=_CalendarUtils.getCapabilityText,hasCapabilityOnGroup=_CalendarUtils.hasCapabilityOnGroup,isSharedGroupOwner=_CalendarUtils.isSharedGroupOwner},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN},function(_apiEntitiesSysSentGroupInvitation){SentGroupInvitationTypeRef=_apiEntitiesSysSentGroupInvitation.SentGroupInvitationTypeRef},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_subscriptionWhitelabelAndSharingBuyDialog){showSharingBuyDialog=_subscriptionWhitelabelAndSharingBuyDialog.showSharingBuyDialog},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonErrorRecipientsNotFoundError){RecipientsNotFoundError=_apiCommonErrorRecipientsNotFoundError.RecipientsNotFoundError},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_CalendarSharingUtils){loadGroupInfoForMember=_CalendarSharingUtils.loadGroupInfoForMember,loadGroupMembers=_CalendarSharingUtils.loadGroupMembers,sendShareNotificationEmail=_CalendarSharingUtils.sendShareNotificationEmail},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_subscriptionPriceUtils){premiumSubscriptionActive=_subscriptionPriceUtils.premiumSubscriptionActive}],execute:function(){CalendarSharingDialogContent=function(){function CalendarSharingDialogContent(){_classCallCheck(this,CalendarSharingDialogContent)}return _createClass(CalendarSharingDialogContent,[{key:"view",value:function(vnode){var calendarName=getCalendarName(vnode.attrs.groupDetails.info,vnode.attrs.allowGroupNameOverride);return m(".flex.col.pt-s",[m(TableN,{columnHeading:[function(){return lang.get("participants_label",{"{name}":calendarName})}],columnWidths:[ColumnWidth.Largest,ColumnWidth.Largest],lines:this._renderMemberInfos(vnode.attrs.groupDetails,calendarName).concat(this._renderGroupInvitations(vnode.attrs.groupDetails,calendarName)),showActionButtonColumn:!0,addButtonAttrs:{label:"addParticipant_action",click:function(){return showAddParticipantDialog(vnode.attrs.groupDetails.info)},icon:function(){return Icons.Add},isVisible:function(){return hasCapabilityOnGroup(logins.getUserController().user,vnode.attrs.groupDetails.group,ShareCapability.Invite)}}})])}},{key:"_renderGroupInvitations",value:function(groupDetails,calendarName){var _this=this;return groupDetails.sentGroupInvitations.map(function(sentGroupInvitation){return{cells:function(){return[{main:sentGroupInvitation.inviteeMailAddress,info:lang.get("invited_label")+", "+getCapabilityText(downcast(sentGroupInvitation.capability)),mainStyle:".i"}]},actionButtonAttrs:{label:"remove_action",click:function(){var message=lang.get("removeCalendarParticipantConfirm_msg",{"{participant}":sentGroupInvitation.inviteeMailAddress,"{calendarName}":calendarName});Dialog.confirm(function(){return message}).then(function(confirmed){confirmed&&worker.rejectGroupInvitation(neverNull(sentGroupInvitation.receivedInvitation))})},icon:function(){return Icons.Cancel},isVisible:function(){return _this._isDeleteInvitationButtonVisible(groupDetails.group,sentGroupInvitation)}}}})}},{key:"_renderMemberInfos",value:function(groupDetails,calendarName){var _this2=this;return groupDetails.memberInfos.map(function(memberInfo){return{cells:function(){return[{main:getDisplayText(memberInfo.info.name,neverNull(memberInfo.info.mailAddress),!1),info:(isSharedGroupOwner(groupDetails.group,memberInfo.member.user)?lang.get("owner_label"):lang.get("participant_label"))+", "+getCapabilityText(_this2._getMemberCabability(memberInfo,groupDetails))}]},actionButtonAttrs:{label:"delete_action",icon:function(){return Icons.Cancel},click:function(){var message=lang.get("removeCalendarParticipantConfirm_msg",{"{participant}":memberInfo.info.mailAddress,"{calendarName}":calendarName});Dialog.confirm(function(){return message}).then(function(confirmed){confirmed&&worker.removeUserFromGroup(memberInfo.member.user,groupDetails.group._id)})},isVisible:function(){return _this2._isDeleteMembershipVisible(groupDetails.group,memberInfo)}}}})}},{key:"_getMemberCabability",value:function(memberInfo,groupDetails){return isSharedGroupOwner(groupDetails.group,memberInfo.member.user)?ShareCapability.Invite:downcast(memberInfo.member.capability)}},{key:"_isDeleteInvitationButtonVisible",value:function(group,sentGroupInvitation){return hasCapabilityOnGroup(logins.getUserController().user,group,ShareCapability.Invite)||isSharedGroupOwner(group,logins.getUserController().user._id)}},{key:"_isDeleteMembershipVisible",value:function(group,memberInfo){return(hasCapabilityOnGroup(logins.getUserController().user,group,ShareCapability.Invite)||isSameId(logins.getUserController().user._id,memberInfo.member.user))&&!isSharedGroupOwner(group,memberInfo.member.user)}}]),CalendarSharingDialogContent}()}}}),System.register("src/calendar/CalendarInvitationDialog.js",["../api/main/WorkerClient","./CalendarSharingUtils","../mail/MailUtils","../api/main/LoginController","../api/entities/tutanota/GroupSettings","../api/main/Entity","mithril","../misc/LanguageViewModel","../gui/base/TextFieldN","mithril/stream/stream.js","./CalendarUtils","../api/common/utils/Utils","../gui/base/Dialog","../gui/base/ButtonN","../api/common/EntityFunctions","../subscription/PriceUtils"],function(_export,_context){"use strict";var worker,sendAcceptNotificationEmail,sendRejectNotificationEmail,getDisplayText,logins,createGroupSettings,update,m,lang,TextFieldN,stream,getCapabilityText,downcast,Dialog,ButtonN,ButtonType,isSameId,premiumSubscriptionActive;return _export("showInvitationDialog",function(invitation){var userSettingsGroupRoot=logins.getUserController().userSettingsGroupRoot,existingGroupSettings=userSettingsGroupRoot.groupSettings.find(function(gc){return gc.group===invitation.sharedGroup}),color=existingGroupSettings?existingGroupSettings.color:Math.random().toString(16).slice(-6),colorStream=stream("#"+color),isMember=logins.getUserController().getCalendarMemberships().find(function(ms){return isSameId(ms.group,invitation.sharedGroup)}),dialog=Dialog.showActionDialog({title:function(){return lang.get("invitation_label")},child:{view:function(){return m(".flex.col",[m(".pt.selectable",isMember?lang.get("alreadyMember_msg"):lang.get("shareCalendarWarning_msg")+" "+lang.get("shareCalendarWarningAliases_msg")),m(TextFieldN,{value:stream(invitation.sharedGroupName),label:"calendarName_label",disabled:!0}),m(TextFieldN,{value:stream(getDisplayText(invitation.inviterName,invitation.inviterMailAddress,!1)),label:"sender_label",disabled:!0}),m(TextFieldN,{value:stream(invitation.inviteeMailAddress),label:"to_label",disabled:!0}),m(TextFieldN,{value:stream(getCapabilityText(downcast(invitation.capability))),label:"permissions_label",disabled:!0}),m(".small.mt.mb-xs",lang.get("color_label")),m("input.mb.color-picker",{oncreate:function(_ref){var dom=_ref.dom;return dom},type:"color",value:colorStream(),oninput:function(inputEvent){console.log("new color",inputEvent.target.value),colorStream(inputEvent.target.value)}}),isMember?null:m(ButtonN,{label:"acceptInvitation_action",type:ButtonType.Login,click:function(){premiumSubscriptionActive(!1).then(function(ok){ok&&function(invitation){return worker.acceptGroupInvitation(invitation).then(function(){sendAcceptNotificationEmail(invitation)})}(invitation).then(function(){dialog.close();var newColor=colorStream().substring(1);if(existingGroupSettings)existingGroupSettings.color=newColor,console.log("existing group color",newColor);else{var groupSettings=Object.assign(createGroupSettings(),{group:invitation.sharedGroup,color:newColor});userSettingsGroupRoot.groupSettings.push(groupSettings),console.log("existing group color",newColor)}return update(userSettingsGroupRoot)})})}})])}},okActionTextId:"decline_action",okAction:function(dialog){dialog.close(),function(invitation){worker.rejectGroupInvitation(invitation._id).then(function(){sendRejectNotificationEmail(invitation)})}(invitation)},cancelActionTextId:"close_alt"})}),{setters:[function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_CalendarSharingUtils){sendAcceptNotificationEmail=_CalendarSharingUtils.sendAcceptNotificationEmail,sendRejectNotificationEmail=_CalendarSharingUtils.sendRejectNotificationEmail},function(_mailMailUtils){getDisplayText=_mailMailUtils.getDisplayText},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiEntitiesTutanotaGroupSettings){createGroupSettings=_apiEntitiesTutanotaGroupSettings.createGroupSettings},function(_apiMainEntity){update=_apiMainEntity.update},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_CalendarUtils){getCapabilityText=_CalendarUtils.getCapabilityText},function(_apiCommonUtilsUtils){downcast=_apiCommonUtilsUtils.downcast},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_apiCommonEntityFunctions){isSameId=_apiCommonEntityFunctions.isSameId},function(_subscriptionPriceUtils){premiumSubscriptionActive=_subscriptionPriceUtils.premiumSubscriptionActive}],execute:function(){}}}),System.register("src/calendar/CalendarSharingUtils.js",["../mail/MailEditor","../mail/MailModel","../mail/MailUtils","./CalendarUtils","../misc/LanguageViewModel","../api/main/Entity","../api/entities/sys/GroupInfo","../api/entities/sys/GroupMember"],function(_export,_context){"use strict";var MailEditor,mailModel,getDefaultSender,getEnabledMailAddresses,getCalendarName,lang,load,loadAll,GroupInfoTypeRef,GroupMemberTypeRef;function _sendNotificationEmail(recipients,subject,body,senderMailAddress,replacements){mailModel.getUserMailboxDetails().then(function(mailboxDetails){var editor=new MailEditor(mailboxDetails),sender=getEnabledMailAddresses(mailboxDetails).includes(senderMailAddress)?senderMailAddress:getDefaultSender(mailboxDetails),subjectString=lang.get(subject),bodyString=lang.get(body,replacements);editor.initWithTemplate(recipients,subjectString,bodyString,!0,sender),editor.send(!1,"tooManyMailsAuto_msg")})}function loadGroupInfoForMember(groupMember){return load(GroupInfoTypeRef,groupMember.userGroupInfo).then(function(userGroupInfo){return{member:groupMember,info:userGroupInfo}})}return _export("sendShareNotificationEmail",function(sharedGroupInfo,recipients){mailModel.getUserMailboxDetails().then(function(mailboxDetails){var senderMailAddress=getDefaultSender(mailboxDetails),replacements={"{inviter}":senderMailAddress,"{calendarName}":getCalendarName(sharedGroupInfo,!1)};_sendNotificationEmail({bcc:recipients.map(function(_ref){return{name:_ref.name,address:_ref.mailAddress}})},"shareCalendarInvitationEmailSubject_msg","shareCalendarInvitationEmailBody_msg",senderMailAddress,replacements)})}),_export("sendAcceptNotificationEmail",function(invitation){var replacements={"{invitee}":invitation.inviteeMailAddress,"{calendarName}":invitation.sharedGroupName,"{recipientName}":invitation.inviterMailAddress};_sendNotificationEmail({to:[{name:invitation.inviterName,address:invitation.inviterMailAddress}]},"shareCalendarAcceptEmailSubject_msg","shareCalendarAcceptEmailBody_msg",invitation.inviteeMailAddress,replacements)}),_export("sendRejectNotificationEmail",function(invitation){var replacements={"{invitee}":invitation.inviteeMailAddress,"{calendarName}":invitation.sharedGroupName,"{recipientName}":invitation.inviterMailAddress};_sendNotificationEmail({to:[{name:invitation.inviterName,address:invitation.inviterMailAddress}]},"shareCalendarDeclineEmailSubject_msg","shareCalendarDeclineEmailBody_msg",invitation.inviteeMailAddress,replacements)}),_export("loadGroupMembers",function(group){return loadAll(GroupMemberTypeRef,group.members).then(function(members){return Promise.map(members,function(member){return loadGroupInfoForMember(member)})})}),_export("loadGroupInfoForMember",loadGroupInfoForMember),{setters:[function(_mailMailEditor){MailEditor=_mailMailEditor.MailEditor},function(_mailMailModel){mailModel=_mailMailModel.mailModel},function(_mailMailUtils){getDefaultSender=_mailMailUtils.getDefaultSender,getEnabledMailAddresses=_mailMailUtils.getEnabledMailAddresses},function(_CalendarUtils){getCalendarName=_CalendarUtils.getCalendarName},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiEntitiesSysGroupMember){GroupMemberTypeRef=_apiEntitiesSysGroupMember.GroupMemberTypeRef}],execute:function(){}}}),System.register("src/calendar/CalendarView.js",["node_modules/systemjs-plugin-babel/babel-helpers/toConsumableArray.js","node_modules/systemjs-plugin-babel/babel-helpers/slicedToArray.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/main/Entity","mithril/stream/stream.js","../gui/base/ViewColumn","../misc/LanguageViewModel","../gui/base/ViewSlider","../misc/KeyManager","../gui/base/icons/Icons","../gui/theme","../api/common/utils/DateUtils","../api/entities/tutanota/CalendarEvent","../api/entities/tutanota/CalendarGroupRoot","../api/main/LoginController","../api/common/EntityFunctions","../api/main/EventController","../api/common/TutanotaConstants","../api/main/MainLocator","../api/common/utils/Utils","./CalendarUtils","./CalendarEventDialog","../api/main/WorkerClient","../gui/base/ButtonN","./CalendarModel","../api/common/utils/ArrayUtils","../misc/Formatter","../gui/base/NavButtonN","./CalendarMonthView","./CalendarDayView","../api/common/utils/CommonCalendarUtils","../api/entities/sys/User","luxon","../api/common/error/RestError","../gui/base/ProgressDialog","./CalendarAgendaView","../api/entities/sys/GroupInfo","./EditCalendarDialog","../api/entities/tutanota/GroupSettings","../misc/ErrorHandlerImpl","../gui/base/DropdownN","../api/entities/tutanota/Services","../api/entities/tutanota/CalendarDeleteData","../gui/styles","./CalendarWeekView","./CalendarImporter","../gui/base/Dialog","../api/Env","./CalendarSharingDialog","../api/entities/sys/ReceivedGroupInvitation","../api/entities/sys/Group","../api/entities/tutanota/UserSettingsGroupRoot","../mail/MailUtils","../api/entities/sys/UserGroupRoot","./CalendarInvitationDialog","./CalendarSharingUtils","../gui/size","../gui/base/FolderColumnView","../misc/DeviceConfig","../api/entities/sys/Services","../api/entities/sys/MembershipRemoveData","../subscription/PriceUtils","../api/common/utils/LazyLoaded"],function(_export,_context){"use strict";var _toConsumableArray,_slicedToArray,_classCallCheck,_createClass,m,load,loadAll,serviceRequestVoid,update,stream,ColumnType,ViewColumn,lang,ViewSlider,keyManager,Icons,theme,DAY_IN_MILLIS,getHourOfDay,getStartOfDay,isSameDay,CalendarEventTypeRef,CalendarGroupRootTypeRef,logins,_loadReverseRangeBetween,getListId,HttpMethod,isSameId,listIdPart,isUpdateForTypeRef,defaultCalendarColor,GroupType,Keys,OperationType,reverse,ShareCapability,TimeFormat,locator,downcast,freezeMap,memoized,neverNull,noOp,getCalendarName,getCapabilityText,getEventStart,getMonth,getStartOfTheWeekOffset,getStartOfWeek,getTimeZone,hasCapabilityOnGroup,isSameEvent,shouldDefaultToAmPmTimeFormat,showCalendarEventDialog,worker,ButtonColors,ButtonN,ButtonType,addDaysForEvent,addDaysForLongEvent,addDaysForRecurringEvent,findAllAndRemove,findAndRemove,formatDateWithWeekday,formatMonthWithFullYear,NavButtonN,CalendarMonthView,CalendarDayView,geEventElementMaxId,getEventElementMinId,UserTypeRef,DateTime,NotFoundError,showProgressDialog,CalendarAgendaView,GroupInfoTypeRef,showEditCalendarDialog,createGroupSettings,showNotAvailableForFreeDialog,attachDropdown,TutanotaService,createCalendarDeleteData,styles,CalendarWeekView,exportCalendar,showCalendarImportDialog,Dialog,isApp,showCalendarSharingDialog,ReceivedGroupInvitationTypeRef,GroupTypeRef,UserSettingsGroupRootTypeRef,getDisplayText,UserGroupRootTypeRef,showInvitationDialog,loadGroupMembers,size,FolderColumnView,deviceConfig,SysService,createMembershipRemoveData,premiumSubscriptionActive,LazyLoaded,CalendarViewType,CalendarViewTypeByValue,CalendarView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs){_toConsumableArray=_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs){_slicedToArray=_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,serviceRequestVoid=_apiMainEntity.serviceRequestVoid,update=_apiMainEntity.update},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseViewColumn){ColumnType=_guiBaseViewColumn.ColumnType,ViewColumn=_guiBaseViewColumn.ViewColumn},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseViewSlider){ViewSlider=_guiBaseViewSlider.ViewSlider},function(_miscKeyManager){keyManager=_miscKeyManager.keyManager},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiTheme){theme=_guiTheme.theme},function(_apiCommonUtilsDateUtils){DAY_IN_MILLIS=_apiCommonUtilsDateUtils.DAY_IN_MILLIS,getHourOfDay=_apiCommonUtilsDateUtils.getHourOfDay,getStartOfDay=_apiCommonUtilsDateUtils.getStartOfDay,isSameDay=_apiCommonUtilsDateUtils.isSameDay},function(_apiEntitiesTutanotaCalendarEvent){CalendarEventTypeRef=_apiEntitiesTutanotaCalendarEvent.CalendarEventTypeRef},function(_apiEntitiesTutanotaCalendarGroupRoot){CalendarGroupRootTypeRef=_apiEntitiesTutanotaCalendarGroupRoot.CalendarGroupRootTypeRef},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonEntityFunctions){_loadReverseRangeBetween=_apiCommonEntityFunctions._loadReverseRangeBetween,getListId=_apiCommonEntityFunctions.getListId,HttpMethod=_apiCommonEntityFunctions.HttpMethod,isSameId=_apiCommonEntityFunctions.isSameId,listIdPart=_apiCommonEntityFunctions.listIdPart},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_apiCommonTutanotaConstants){defaultCalendarColor=_apiCommonTutanotaConstants.defaultCalendarColor,GroupType=_apiCommonTutanotaConstants.GroupType,Keys=_apiCommonTutanotaConstants.Keys,OperationType=_apiCommonTutanotaConstants.OperationType,reverse=_apiCommonTutanotaConstants.reverse,ShareCapability=_apiCommonTutanotaConstants.ShareCapability,TimeFormat=_apiCommonTutanotaConstants.TimeFormat},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_apiCommonUtilsUtils){downcast=_apiCommonUtilsUtils.downcast,freezeMap=_apiCommonUtilsUtils.freezeMap,memoized=_apiCommonUtilsUtils.memoized,neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_CalendarUtils){getCalendarName=_CalendarUtils.getCalendarName,getCapabilityText=_CalendarUtils.getCapabilityText,getEventStart=_CalendarUtils.getEventStart,getMonth=_CalendarUtils.getMonth,getStartOfTheWeekOffset=_CalendarUtils.getStartOfTheWeekOffset,getStartOfWeek=_CalendarUtils.getStartOfWeek,getTimeZone=_CalendarUtils.getTimeZone,hasCapabilityOnGroup=_CalendarUtils.hasCapabilityOnGroup,isSameEvent=_CalendarUtils.isSameEvent,shouldDefaultToAmPmTimeFormat=_CalendarUtils.shouldDefaultToAmPmTimeFormat},function(_CalendarEventDialog){showCalendarEventDialog=_CalendarEventDialog.showCalendarEventDialog},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseButtonN){ButtonColors=_guiBaseButtonN.ButtonColors,ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_CalendarModel){addDaysForEvent=_CalendarModel.addDaysForEvent,addDaysForLongEvent=_CalendarModel.addDaysForLongEvent,addDaysForRecurringEvent=_CalendarModel.addDaysForRecurringEvent},function(_apiCommonUtilsArrayUtils){findAllAndRemove=_apiCommonUtilsArrayUtils.findAllAndRemove,findAndRemove=_apiCommonUtilsArrayUtils.findAndRemove},function(_miscFormatter){formatDateWithWeekday=_miscFormatter.formatDateWithWeekday,formatMonthWithFullYear=_miscFormatter.formatMonthWithFullYear},function(_guiBaseNavButtonN){NavButtonN=_guiBaseNavButtonN.NavButtonN},function(_CalendarMonthView){CalendarMonthView=_CalendarMonthView.CalendarMonthView},function(_CalendarDayView){CalendarDayView=_CalendarDayView.CalendarDayView},function(_apiCommonUtilsCommonCalendarUtils){geEventElementMaxId=_apiCommonUtilsCommonCalendarUtils.geEventElementMaxId,getEventElementMinId=_apiCommonUtilsCommonCalendarUtils.getEventElementMinId},function(_apiEntitiesSysUser){UserTypeRef=_apiEntitiesSysUser.UserTypeRef},function(_luxon){DateTime=_luxon.DateTime},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_CalendarAgendaView){CalendarAgendaView=_CalendarAgendaView.CalendarAgendaView},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_EditCalendarDialog){showEditCalendarDialog=_EditCalendarDialog.showEditCalendarDialog},function(_apiEntitiesTutanotaGroupSettings){createGroupSettings=_apiEntitiesTutanotaGroupSettings.createGroupSettings},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog},function(_guiBaseDropdownN){attachDropdown=_guiBaseDropdownN.attachDropdown},function(_apiEntitiesTutanotaServices){TutanotaService=_apiEntitiesTutanotaServices.TutanotaService},function(_apiEntitiesTutanotaCalendarDeleteData){createCalendarDeleteData=_apiEntitiesTutanotaCalendarDeleteData.createCalendarDeleteData},function(_guiStyles){styles=_guiStyles.styles},function(_CalendarWeekView){CalendarWeekView=_CalendarWeekView.CalendarWeekView},function(_CalendarImporter){exportCalendar=_CalendarImporter.exportCalendar,showCalendarImportDialog=_CalendarImporter.showCalendarImportDialog},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiEnv){isApp=_apiEnv.isApp},function(_CalendarSharingDialog){showCalendarSharingDialog=_CalendarSharingDialog.showCalendarSharingDialog},function(_apiEntitiesSysReceivedGroupInvitation){ReceivedGroupInvitationTypeRef=_apiEntitiesSysReceivedGroupInvitation.ReceivedGroupInvitationTypeRef},function(_apiEntitiesSysGroup){GroupTypeRef=_apiEntitiesSysGroup.GroupTypeRef},function(_apiEntitiesTutanotaUserSettingsGroupRoot){UserSettingsGroupRootTypeRef=_apiEntitiesTutanotaUserSettingsGroupRoot.UserSettingsGroupRootTypeRef},function(_mailMailUtils){getDisplayText=_mailMailUtils.getDisplayText},function(_apiEntitiesSysUserGroupRoot){UserGroupRootTypeRef=_apiEntitiesSysUserGroupRoot.UserGroupRootTypeRef},function(_CalendarInvitationDialog){showInvitationDialog=_CalendarInvitationDialog.showInvitationDialog},function(_CalendarSharingUtils){loadGroupMembers=_CalendarSharingUtils.loadGroupMembers},function(_guiSize){size=_guiSize.size},function(_guiBaseFolderColumnView){FolderColumnView=_guiBaseFolderColumnView.FolderColumnView},function(_miscDeviceConfig){deviceConfig=_miscDeviceConfig.deviceConfig},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiEntitiesSysMembershipRemoveData){createMembershipRemoveData=_apiEntitiesSysMembershipRemoveData.createMembershipRemoveData},function(_subscriptionPriceUtils){premiumSubscriptionActive=_subscriptionPriceUtils.premiumSubscriptionActive},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded}],execute:function(){_export("LIMIT_PAST_EVENTS_YEARS",100),_export("LIMIT_PAST_EVENTS_YEARS",100),_export("DEFAULT_HOUR_OF_DAY",6),_export("DEFAULT_HOUR_OF_DAY",6),_export("CalendarViewType",CalendarViewType=Object.freeze({DAY:"day",WEEK:"week",MONTH:"month",AGENDA:"agenda"})),_export("CalendarViewType",CalendarViewType),CalendarViewTypeByValue=reverse(CalendarViewType),_export("CalendarView",CalendarView=function(){function CalendarView(){var _this=this;_classCallCheck(this,CalendarView),this._currentViewType=deviceConfig.getDefaultCalendarView(logins.getUserController().user._id)||CalendarViewType.MONTH,this._loadedMonths=new Set,this._eventsForDays=freezeMap(new Map),this._hiddenCalendars=new Set,this.selectedDate=stream(getStartOfDay(new Date)),this.sidebarColumn=new ViewColumn({view:function(){return m(FolderColumnView,{button:styles.isUsingBottomNavigation()?null:{label:"newEvent_action",click:function(){return _this._newEvent()}},content:[_this._renderCalendarViewButtons(),_this._renderSidebarSection("yourCalendars_label",{label:"addCalendar_action",colors:ButtonColors.Nav,click:function(){return _this._onPressedAddCalendar()},icon:function(){return Icons.Add}},_this._renderCalendars(!1)),_this._renderSidebarSection("otherCalendars_label",null,_this._renderCalendars(!0)),_this._calendarInvitations.length>0?_this._renderSidebarSection("calendarInvitations_label",null,_this._renderCalendarInvitations()):null],ariaLabel:"calendar_label"})}},ColumnType.Foreground,size.first_col_min_width,size.first_col_max_width,function(){return _this._currentViewType===CalendarViewType.WEEK?lang.get("month_label"):lang.get("calendar_label")});var getGroupColors=memoized(function(userSettingsGroupRoot){return userSettingsGroupRoot.groupSettings.reduce(function(acc,gc){return acc[gc.group]=gc.color,acc},{})});this.contentColumn=new ViewColumn({view:function(){var groupColors=getGroupColors(logins.getUserController().userSettingsGroupRoot);switch(_this._currentViewType){case CalendarViewType.MONTH:return m(CalendarMonthView,{eventsForDays:_this._eventsForDays,onEventClicked:function(event){return _this._onEventSelected(event)},onNewEvent:function(date){_this._newEvent(date)},selectedDate:_this.selectedDate(),onDateSelected:function(date){var viewType=styles.isDesktopLayout()?CalendarViewType.WEEK:CalendarViewType.DAY;_this._setUrl(viewType,date)},onChangeMonth:function(next){return _this._viewPeriod(next)},amPmFormat:logins.getUserController().userSettingsGroupRoot.timeFormat===TimeFormat.TWELVE_HOURS,startOfTheWeek:downcast(logins.getUserController().userSettingsGroupRoot.startOfTheWeek),groupColors:groupColors,hiddenCalendars:_this._hiddenCalendars});case CalendarViewType.DAY:return m(CalendarDayView,{eventsForDays:_this._eventsForDays,onEventClicked:function(event){return _this._onEventSelected(event)},onNewEvent:function(date){_this._newEvent(date)},selectedDate:_this.selectedDate(),onDateSelected:function(date){_this.selectedDate(date),m.redraw(),_this._setUrl(CalendarViewType.DAY,date)},groupColors:groupColors,hiddenCalendars:_this._hiddenCalendars});case CalendarViewType.WEEK:return m(CalendarWeekView,{eventsForDays:_this._eventsForDays,onEventClicked:function(event){return _this._onEventSelected(event)},onNewEvent:function(date){_this._newEvent(date)},selectedDate:_this.selectedDate(),onDateSelected:function(date){_this._setUrl(CalendarViewType.DAY,date)},startOfTheWeek:downcast(logins.getUserController().userSettingsGroupRoot.startOfTheWeek),groupColors:groupColors,hiddenCalendars:_this._hiddenCalendars,onChangeWeek:function(next){return _this._viewPeriod(next)}});case CalendarViewType.AGENDA:return m(CalendarAgendaView,{eventsForDays:_this._eventsForDays,amPmFormat:shouldDefaultToAmPmTimeFormat(),onEventClicked:function(event){return _this._onEventSelected(event)},groupColors:groupColors,hiddenCalendars:_this._hiddenCalendars,onDateSelected:function(date){_this._setUrl(CalendarViewType.DAY,date)}})}}},ColumnType.Background,size.second_col_min_width+size.third_col_min_width,size.third_col_max_width,function(){return _this._currentViewType===CalendarViewType.MONTH?formatMonthWithFullYear(_this.selectedDate()):_this._currentViewType===CalendarViewType.DAY?formatDateWithWeekday(_this.selectedDate()):_this._currentViewType===CalendarViewType.AGENDA?lang.get("agenda_label"):""}),this.viewSlider=new ViewSlider([this.sidebarColumn,this.contentColumn],"CalendarView"),this._calendarInfos=this._loadCalendarInfos().then(function(calendarInfos){return 0===calendarInfos.size?worker.addCalendar("").then(function(){return _this._loadCalendarInfos()}):calendarInfos}),this._calendarInvitations=[],this._updateCalendarInvitations(),this.selectedDate.map(function(d){var previousMonthDate=new Date(d);previousMonthDate.setMonth(d.getMonth()-1);var nextMonthDate=new Date(d);nextMonthDate.setMonth(d.getMonth()+1),_this._loadMonthIfNeeded(d).then(function(){return _this._loadMonthIfNeeded(nextMonthDate)}).then(function(){return _this._loadMonthIfNeeded(previousMonthDate)})}),this._setupShortcuts(),locator.eventController.addEntityListener(function(updates,eventOwnerGroupId){_this.entityEventReceived(updates,eventOwnerGroupId)})}return _createClass(CalendarView,[{key:"_setupShortcuts",value:function(){var _this2=this,shortcuts=[{key:Keys.ONE,exec:function(){return _this2._setUrl(CalendarViewType.WEEK,_this2.selectedDate())},help:"switchWeekView_action"},{key:Keys.TWO,exec:function(){return _this2._setUrl(CalendarViewType.MONTH,_this2.selectedDate())},help:"switchMonthView_action"},{key:Keys.THREE,exec:function(){return _this2._setUrl(CalendarViewType.AGENDA,_this2.selectedDate())},help:"switchAgendaView_action"},{key:Keys.T,exec:function(){return _this2._setUrl(m.route.param("view"),new Date)},help:"viewToday_action"},{key:Keys.J,enabled:function(){return _this2._currentViewType!==CalendarViewType.AGENDA},exec:function(){return _this2._viewPeriod(!0)},help:"viewNextPeriod_action"},{key:Keys.K,enabled:function(){return _this2._currentViewType!==CalendarViewType.AGENDA},exec:function(){return _this2._viewPeriod(!1)},help:"viewPrevPeriod_action"},{key:Keys.N,exec:function(){return _this2._newEvent(_this2.selectedDate())},help:"newEvent_action"}];this.oncreate=function(){return keyManager.registerShortcuts(shortcuts)},this.onbeforeremove=function(){return keyManager.unregisterShortcuts(shortcuts)}}},{key:"_viewPeriod",value:function(next){var newDate=new Date(this.selectedDate().getTime());switch(this._currentViewType){case CalendarViewType.MONTH:newDate.setMonth(newDate.getMonth()+(next?1:-1)),this.selectedDate(newDate),m.redraw(),this._setUrl(CalendarViewType.MONTH,newDate);break;case CalendarViewType.WEEK:newDate.setDate(newDate.getDate()+(next?7:-7)),this.selectedDate(newDate),m.redraw(),this._setUrl(CalendarViewType.WEEK,newDate)}}},{key:"_renderSidebarSection",value:function(label,button,content){return m(".folders",{style:{color:theme.navigation_button}},[m(".folder-row.flex-space-between.button-height.plr-l",[m("small.b.align-self-center.ml-negative-xs",lang.get(label).toLocaleUpperCase()),button?m(ButtonN,button):null]),content])}},{key:"_renderCalendarViewButtons",value:function(){var _this3=this,calendarViewValues=[{name:lang.get("month_label"),value:CalendarViewType.MONTH,icon:Icons.Table,href:"/calendar/month"},{name:lang.get("agenda_label"),value:CalendarViewType.AGENDA,icon:Icons.ListUnordered,href:"/calendar/agenda"}];return m(".folders.pt-s",[m(".folder-row.flex-space-between.button-height.plr-l",[m("small.b.align-self-center.ml-negative-xs",{style:{color:theme.navigation_button}},lang.get("view_label").toLocaleUpperCase()),this._currentViewType!==CalendarViewType.AGENDA?m(ButtonN,{label:"today_label",click:function(){_this3._setUrl(m.route.param("view"),new Date)},colors:ButtonColors.Nav,type:ButtonType.Primary}):null]),m(".folder-row.plr-l",calendarViewValues.map(function(viewType){return m(NavButtonN,{label:function(){return viewType.name},icon:function(){return viewType.icon},href:m.route.get(),isSelectedPrefix:viewType.href,colors:ButtonColors.Nav,click:function(){_this3._setUrl(viewType.value,_this3.selectedDate()),_this3.viewSlider.focus(_this3.contentColumn)}})}))])}},{key:"headerRightView",value:function(){var _this4=this;return m(ButtonN,{label:"newEvent_action",click:function(){_this4._newEvent()},icon:function(){return Icons.Add},type:ButtonType.Action,colors:ButtonColors.Header})}},{key:"_updateCalendarInvitations",value:function(){var _this5=this;return load(UserGroupRootTypeRef,logins.getUserController().userGroupInfo.group).then(function(userGroupRoot){return loadAll(ReceivedGroupInvitationTypeRef,userGroupRoot.invitations).then(function(calendarInvitations){_this5._calendarInvitations=calendarInvitations,m.redraw()})}).catch(NotFoundError,function(e){_this5._calendarInvitations=[]})}},{key:"handleBackButton",value:function(){var route=m.route.get();return route.startsWith("/calendar/day")?(m.route.set(route.replace("day","month")),!0):!!route.startsWith("/calendar/week")&&(m.route.set(route.replace("week","month")),!0)}},{key:"overrideBackIcon",value:function(){return this._currentViewType===CalendarViewType.WEEK||this._currentViewType===CalendarViewType.DAY}},{key:"_onPressedAddCalendar",value:function(){var _this6=this;0===logins.getUserController().getCalendarMemberships().length?this._showCreateCalendarDialog():premiumSubscriptionActive(!0).then(function(ok){ok&&_this6._showCreateCalendarDialog()})}},{key:"_showCreateCalendarDialog",value:function(){showEditCalendarDialog({name:"",color:Math.random().toString(16).slice(-6)},"add_action",!1,function(dialog,properties){dialog.close(),worker.addCalendar(properties.name).then(function(group){var userSettingsGroupRoot=logins.getUserController().userSettingsGroupRoot,newGroupSettings=Object.assign(createGroupSettings(),{group:group._id,color:properties.color});userSettingsGroupRoot.groupSettings.push(newGroupSettings),update(userSettingsGroupRoot)})},"save_action")}},{key:"_renderCalendarInvitations",value:function(){return this._calendarInvitations.map(function(invitation){return[m(".folder-row.flex-start.plr-l",[m(".flex-v-center.flex-grow.button-height",{style:{"max-width":"calc(100% - "+size.button_height+"px)"}},[m(".b.text-ellipsis",{title:getCapabilityText(downcast(invitation.capability))},invitation.sharedGroupName),m(".small.text-ellipsis",{title:invitation.inviterMailAddress},getDisplayText(invitation.inviterName,invitation.inviterMailAddress,!0))]),m(ButtonN,{label:"show_action",click:function(){return showInvitationDialog(invitation)},icon:function(){return Icons.Eye}})])]})}},{key:"_renderCalendars",value:function(shared){var _this7=this;return this._calendarInfos.isFulfilled()?Array.from(this._calendarInfos.value().values()).filter(function(calendarInfo){return calendarInfo.shared===shared}).map(function(calendarInfo){var userSettingsGroupRoot=logins.getUserController().userSettingsGroupRoot,existingGroupSettings=userSettingsGroupRoot.groupSettings.find(function(gc){return gc.group===calendarInfo.groupInfo.group}),colorValue="#"+(existingGroupSettings?existingGroupSettings.color:defaultCalendarColor),groupRootId=calendarInfo.groupRoot._id;return m(".folder-row.flex-start.plr-l",[m(".flex.flex-grow.center-vertically.button-height",[m(".calendar-checkbox",{onclick:function(){var newHiddenCalendars=new Set(_this7._hiddenCalendars);_this7._hiddenCalendars.has(groupRootId)?newHiddenCalendars.delete(groupRootId):newHiddenCalendars.add(groupRootId),_this7._hiddenCalendars=newHiddenCalendars},style:{"border-color":colorValue,background:_this7._hiddenCalendars.has(groupRootId)?"":colorValue,"margin-left":"-4px",transition:"all 0.3s",cursor:"pointer"}}),m(".pl-m.b.flex-grow.text-ellipsis",{style:{width:0}},getCalendarName(calendarInfo.groupInfo,shared))]),_this7._createCalendarActionDropdown(calendarInfo,colorValue,existingGroupSettings,userSettingsGroupRoot,shared)])}):null}},{key:"_createCalendarActionDropdown",value:function(calendarInfo,colorValue,existingGroupSettings,userSettingsGroupRoot,sharedCalendar){var _this8=this,group=calendarInfo.group,groupInfo=calendarInfo.groupInfo,groupRoot=calendarInfo.groupRoot;return m(ButtonN,attachDropdown({label:"more_label",colors:ButtonColors.Nav,click:noOp,icon:function(){return Icons.More}},function(){return[{label:"edit_action",icon:function(){return Icons.Edit},click:function(){return _this8._onPressedEditCalendar(groupInfo,colorValue,existingGroupSettings,userSettingsGroupRoot,sharedCalendar)},type:ButtonType.Dropdown},{label:"sharing_label",icon:function(){return Icons.ContactImport},click:function(){logins.getUserController().isFreeAccount()?showNotAvailableForFreeDialog(!1):showCalendarSharingDialog(groupInfo,sharedCalendar)},type:ButtonType.Dropdown},isApp()?null:{label:"import_action",icon:function(){return Icons.Import},click:function(){return showCalendarImportDialog(groupRoot)},isVisible:function(){return hasCapabilityOnGroup(logins.getUserController().user,group,ShareCapability.Write)},type:ButtonType.Dropdown},isApp()?null:{label:"export_action",icon:function(){return Icons.Export},click:function(){var alarmInfoList=logins.getUserController().user.alarmInfoList;alarmInfoList&&exportCalendar(getCalendarName(groupInfo,sharedCalendar),groupRoot,alarmInfoList.alarms,new Date,getTimeZone())},isVisible:function(){return hasCapabilityOnGroup(logins.getUserController().user,group,ShareCapability.Read)},type:ButtonType.Dropdown},{label:"delete_action",icon:function(){return Icons.Trash},click:function(){return _this8._confirmDeleteCalendar(calendarInfo)},isVisible:function(){return!sharedCalendar},type:ButtonType.Dropdown}].filter(Boolean)}))}},{key:"_confirmDeleteCalendar",value:function(calendarInfo){var calendarName=getCalendarName(calendarInfo.groupInfo,!1);loadGroupMembers(calendarInfo.group).then(function(members){var ownerMail=logins.getUserController().userGroupInfo.mailAddress,otherMembers=members.filter(function(member){return member.info.mailAddress!==ownerMail});Dialog.confirm(function(){return(otherMembers.length>0?lang.get("deleteSharedCalendarConfirm_msg",{"{calendar}":calendarName})+" ":"")+lang.get("deleteCalendarConfirm_msg",{"{calendar}":calendarName})}).then(function(confirmed){confirmed&&serviceRequestVoid(TutanotaService.CalendarService,HttpMethod.DELETE,createCalendarDeleteData({groupRootId:calendarInfo.groupRoot._id}))})})}},{key:"_onPressedEditCalendar",value:function(groupInfo,colorValue,existingGroupSettings,userSettingsGroupRoot,shared){showEditCalendarDialog({name:getCalendarName(groupInfo,shared),color:colorValue.substring(1)},"edit_action",shared,function(dialog,properties){if(shared||(groupInfo.name=properties.name,update(groupInfo)),existingGroupSettings)existingGroupSettings.color=properties.color,existingGroupSettings.name=shared&&properties.name!==groupInfo.name?properties.name:null;else{var newGroupSettings=Object.assign(createGroupSettings(),{group:groupInfo.group,color:properties.color,name:shared&&properties.name!==groupInfo.name?properties.name:null});userSettingsGroupRoot.groupSettings.push(newGroupSettings)}update(userSettingsGroupRoot),dialog.close()},"save_action")}},{key:"_onEventSelected",value:function(event){this._calendarInfos.then(function(calendarInfos){var p=Promise.resolve(event);event.repeatRule&&(p=load(CalendarEventTypeRef,event._id)),p.then(function(e){return showCalendarEventDialog(getEventStart(e,getTimeZone()),calendarInfos,e)}).catch(NotFoundError,function(){console.log("calendar event not found when clicking on the event")})})}},{key:"_getSelectedView",value:function(){return m.route.get().match("/calendar/month")?CalendarViewType.MONTH:CalendarViewType.DAY}},{key:"_loadMonthIfNeeded",value:function(dayInMonth){var _this9=this,month=getMonth(dayInMonth,getTimeZone());return this._loadedMonths.has(month.start.getTime())?Promise.resolve():(this._loadedMonths.add(month.start.getTime()),this._loadEvents(month).catch(function(e){throw _this9._loadedMonths.delete(month.start.getTime()),e}).tap(function(){return m.redraw()}))}},{key:"_newEvent",value:function(date){var dateToUse=void 0;if(null==date)switch(this._currentViewType){case CalendarViewType.AGENDA:dateToUse=this._getNextHalfHour();break;case CalendarViewType.MONTH:var currentDayStartOfMonth=getMonth(new Date,getTimeZone()).start,visibleStartOfMonth=getMonth(this.selectedDate(),getTimeZone()).start;dateToUse=this._getNewEventStartDate(currentDayStartOfMonth,visibleStartOfMonth);break;case CalendarViewType.WEEK:var startOfTheWeekOffset=getStartOfTheWeekOffset(downcast(logins.getUserController().userSettingsGroupRoot.startOfTheWeek)),currentDayStartOfTheWeek=getStartOfWeek(new Date,startOfTheWeekOffset),visibleStartOfTheWeek=getStartOfWeek(this.selectedDate(),startOfTheWeekOffset);dateToUse=this._getNewEventStartDate(currentDayStartOfTheWeek,visibleStartOfTheWeek);break;default:dateToUse=this._getNewEventStartDate(new Date,this.selectedDate())}else dateToUse=date;(this._calendarInfos.isFulfilled()?this._calendarInfos:showProgressDialog("pleaseWait_msg",this._calendarInfos)).then(function(calendars){return showCalendarEventDialog(dateToUse,calendars)})}},{key:"_getNewEventStartDate",value:function(currentDayStartOfView,visibleStartOfView){if(isSameDay(currentDayStartOfView,visibleStartOfView)){var nextHalfHour=this._getNextHalfHour();if(isSameDay(nextHalfHour,new Date))return nextHalfHour}return getHourOfDay(visibleStartOfView,6)}},{key:"_getNextHalfHour",value:function(){var date=new Date;return date.getMinutes()>30?date.setHours(date.getHours()+1,0):date.setMinutes(30),date}},{key:"view",value:function(){return m(".main-view",m(this.viewSlider))}},{key:"updateUrl",value:function(args){if(args.view){this._currentViewType=CalendarViewTypeByValue[args.view]?args.view:CalendarViewType.MONTH;var urlDateParam=args.date;if(urlDateParam&&this._currentViewType!==CalendarViewType.AGENDA){var luxonDate=DateTime.fromISO(urlDateParam),date=new Date;luxonDate.isValid&&(date=luxonDate.toJSDate()),this.selectedDate().getTime()!==date.getTime()&&(this.selectedDate(date),m.redraw())}deviceConfig.setDefaultCalendarView(logins.getUserController().user._id,this._currentViewType)}else this._setUrl(this._currentViewType,this.selectedDate(),!0)}},{key:"_loadEvents",value:function(month){var _this10=this;return this._calendarInfos.then(function(calendarInfos){var startId=getEventElementMinId(month.start.getTime()-DAY_IN_MILLIS),endId=geEventElementMaxId(month.end.getTime()+DAY_IN_MILLIS),aggregateShortEvents=[],aggregateLongEvents=[];return Promise.map(calendarInfos.values(),function(calendarInfo){var groupRoot=calendarInfo.groupRoot,longEvents=calendarInfo.longEvents;return Promise.all([_loadReverseRangeBetween(CalendarEventTypeRef,groupRoot.shortEvents,endId,startId,worker,200),longEvents.getAsync()]).then(function(_ref){var _ref2=_slicedToArray(_ref,2),shortEventsResult=_ref2[0],longEvents=_ref2[1];aggregateShortEvents.push.apply(aggregateShortEvents,_toConsumableArray(shortEventsResult.elements)),aggregateLongEvents.push.apply(aggregateLongEvents,_toConsumableArray(longEvents))})}).then(function(){var newEvents=_this10._cloneEvents();aggregateShortEvents.filter(function(e){var eventStart=getEventStart(e,getTimeZone()).getTime();return eventStart>=month.start.getTime()&&eventStart<month.end.getTime()}).forEach(function(e){addDaysForEvent(newEvents,e,month)});var zone=getTimeZone();aggregateLongEvents.forEach(function(e){e.repeatRule?addDaysForRecurringEvent(newEvents,e,month,zone):addDaysForLongEvent(newEvents,e,month,zone)}),_this10._replaceEvents(newEvents)})})}},{key:"_loadCalendarInfos",value:function(){var userId=logins.getUserController().user._id;return load(UserTypeRef,userId).then(function(user){var calendarMemberships=user.memberships.filter(function(m){return m.groupType===GroupType.Calendar}),notFoundMemberships=[];return Promise.map(calendarMemberships,function(membership){return Promise.all([load(CalendarGroupRootTypeRef,membership.group),load(GroupInfoTypeRef,membership.groupInfo),load(GroupTypeRef,membership.group)]).catch(NotFoundError,function(){return notFoundMemberships.push(membership),null})}).then(function(groupInstances){var calendarInfos=new Map;return groupInstances.filter(Boolean).forEach(function(_ref3){var _ref4=_slicedToArray(_ref3,3),groupRoot=_ref4[0],groupInfo=_ref4[1],group=_ref4[2];calendarInfos.set(groupRoot._id,{groupRoot:groupRoot,groupInfo:groupInfo,shortEvents:[],longEvents:new LazyLoaded(function(){return loadAll(CalendarEventTypeRef,groupRoot.longEvents)},[]),group:group,shared:!isSameId(group.user,userId)})}),Promise.each(notFoundMemberships,function(notFoundMembership){var data=createMembershipRemoveData({user:userId,group:notFoundMembership.group});return serviceRequestVoid(SysService.MembershipService,HttpMethod.DELETE,data)}),calendarInfos})}).tap(function(){return m.redraw()})}},{key:"entityEventReceived",value:function(updates,eventOwnerGroupId){var _this11=this;this._calendarInfos.then(function(calendarEvents){updates.forEach(function(update){if(isUpdateForTypeRef(UserSettingsGroupRootTypeRef,update)&&m.redraw(),isUpdateForTypeRef(CalendarEventTypeRef,update))update.operation===OperationType.CREATE||update.operation===OperationType.UPDATE?load(CalendarEventTypeRef,[update.instanceListId,update.instanceId]).then(function(event){_this11.addOrUpdateEvent(calendarEvents.get(neverNull(event._ownerGroup)),event),m.redraw()}).catch(NotFoundError,function(e){console.log("Not found event in entityEventsReceived of view",e)}):update.operation===OperationType.DELETE&&(_this11._removeDaysForEvent([update.instanceListId,update.instanceId],eventOwnerGroupId),m.redraw());else if(isUpdateForTypeRef(UserTypeRef,update)&&isSameId(eventOwnerGroupId,logins.getUserController().user.userGroup.group)){if(update.operation===OperationType.UPDATE){var calendarMemberships=logins.getUserController().getCalendarMemberships();_this11._calendarInfos.then(function(calendarInfos){calendarInfos.forEach(function(ci,group){calendarMemberships.every(function(mb){return group!==mb.group})&&_this11._hiddenCalendars.delete(group)}),calendarMemberships.length!==calendarInfos.size&&(_this11._loadedMonths.clear(),_this11._replaceEvents(new Map),_this11._calendarInfos=_this11._loadCalendarInfos(),_this11._calendarInfos.then(function(){var selectedDate=_this11.selectedDate(),previousMonthDate=new Date(selectedDate);previousMonthDate.setMonth(selectedDate.getMonth()-1);var nextMonthDate=new Date(selectedDate);nextMonthDate.setMonth(selectedDate.getMonth()+1),_this11._loadMonthIfNeeded(selectedDate).then(function(){return _this11._loadMonthIfNeeded(nextMonthDate)}).then(function(){return _this11._loadMonthIfNeeded(previousMonthDate)})}))})}}else if(isUpdateForTypeRef(ReceivedGroupInvitationTypeRef,update)){if(update.operation===OperationType.CREATE)load(ReceivedGroupInvitationTypeRef,[update.instanceListId,update.instanceId]).then(function(invitation){_this11._calendarInvitations.push(invitation),m.redraw()});else if(update.operation===OperationType.DELETE){findAndRemove(_this11._calendarInvitations,function(invitation){return isSameId(invitation._id,[update.instanceListId,update.instanceId])})&&m.redraw()}}else isUpdateForTypeRef(GroupInfoTypeRef,update)&&_this11._calendarInfos.then(function(calendarInfos){var calendarInfo=calendarInfos.get(eventOwnerGroupId);calendarInfo&&load(GroupInfoTypeRef,[update.instanceListId,update.instanceId]).then(function(groupInfo){calendarInfo.groupInfo=groupInfo,m.redraw()})})})})}},{key:"addOrUpdateEvent",value:function(calendarInfo,event){var _this12=this,zone=getTimeZone();if(calendarInfo){var eventListId=getListId(event),eventMonth=getMonth(getEventStart(event,zone),zone);if(isSameId(calendarInfo.groupRoot.shortEvents,eventListId)){if(!this._loadedMonths.has(eventMonth.start.getTime()))return;this._addDaysForEvent(event,eventMonth)}else isSameId(calendarInfo.groupRoot.longEvents,eventListId)&&(this._removeExistingEvent(calendarInfo.longEvents.getLoaded(),event),calendarInfo.longEvents.getLoaded().push(event),this._loadedMonths.forEach(function(firstDayTimestamp){var loadedMonth=getMonth(new Date(firstDayTimestamp),zone);event.repeatRule?_this12._addDaysForRecurringEvent(event,loadedMonth):_this12._addDaysForLongEvent(event,loadedMonth)}))}}},{key:"_removeExistingEvent",value:function(events,newEvent){var indexOfOldEvent=events.findIndex(function(el){return isSameEvent(el,newEvent)});if(-1!==indexOfOldEvent){var oldEvent=events[indexOfOldEvent];if(oldEvent.endTime.getTime()!==newEvent.endTime.getTime()){var newMap=this._cloneEvents();newMap.forEach(function(dayEvents){return findAllAndRemove(dayEvents,function(e){return isSameId(e._id,oldEvent._id)})}),this._replaceEvents(newMap)}events.splice(indexOfOldEvent,1)}}},{key:"_addDaysForEvent",value:function(event,month){var newMap=this._cloneEvents();addDaysForEvent(newMap,event,month),this._replaceEvents(newMap)}},{key:"_replaceEvents",value:function(newMap){this._eventsForDays=freezeMap(newMap)}},{key:"_cloneEvents",value:function(){return new Map(this._eventsForDays)}},{key:"_addDaysForRecurringEvent",value:function(event,month){if(-DateTime.fromJSDate(event.startTime).diffNow("year").years>100)console.log("repeating event is too far into the past",event);else{var newMap=this._cloneEvents();addDaysForRecurringEvent(newMap,event,month,getTimeZone()),this._replaceEvents(newMap)}}},{key:"_removeDaysForEvent",value:function(id,ownerGroupId){var newMap=this._cloneEvents();if(newMap.forEach(function(dayEvents){return findAllAndRemove(dayEvents,function(e){return isSameId(e._id,id)})}),this._replaceEvents(newMap),this._calendarInfos.isFulfilled()){var info=this._calendarInfos.value().get(ownerGroupId);info&&isSameId(listIdPart(id),info.groupRoot.longEvents)&&findAndRemove(info.longEvents.getLoaded(),function(e){return isSameId(e._id,id)})}}},{key:"_addDaysForLongEvent",value:function(event,month){var newMap=this._cloneEvents();addDaysForLongEvent(newMap,event,month),this._replaceEvents(newMap)}},{key:"getViewSlider",value:function(){return this.viewSlider}},{key:"_setUrl",value:function(view,date){var replace=arguments.length>2&&void 0!==arguments[2]&&arguments[2],dateString=DateTime.fromJSDate(date).toISODate();m.route.set("/calendar/:view/:date",{view:view,date:dateString},{replace:replace})}}]),CalendarView}()),_export("CalendarView",CalendarView)}}}),System.register("src/calendar/CalendarDayView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../misc/Formatter","../api/common/utils/MapUtils","../api/common/utils/DateUtils","../api/common/TutanotaConstants","./ContinuingCalendarEventBubble","../api/common/utils/CommonCalendarUtils","./CalendarUtils","../api/common/utils/Utils","./CalendarDayEventsView","../gui/theme","../gui/size","../gui/base/PageView","./CalendarView"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,formatTime,incrementDate,isSameDay,EventTextTimeOption,ContinuingCalendarEventBubble,isAllDayEvent,CALENDAR_EVENT_HEIGHT,eventEndsAfterDay,eventStartsBefore,getEventColor,getTimeZone,neverNull,CalendarDayEventsView,calendarDayTimes,theme,px,size,PageView,DEFAULT_HOUR_OF_DAY,CalendarDayView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscFormatter){formatTime=_miscFormatter.formatTime},function(_apiCommonUtilsMapUtils){_apiCommonUtilsMapUtils.getFromMap},function(_apiCommonUtilsDateUtils){incrementDate=_apiCommonUtilsDateUtils.incrementDate,isSameDay=_apiCommonUtilsDateUtils.isSameDay},function(_apiCommonTutanotaConstants){EventTextTimeOption=_apiCommonTutanotaConstants.EventTextTimeOption},function(_ContinuingCalendarEventBubble){ContinuingCalendarEventBubble=_ContinuingCalendarEventBubble.ContinuingCalendarEventBubble},function(_apiCommonUtilsCommonCalendarUtils){isAllDayEvent=_apiCommonUtilsCommonCalendarUtils.isAllDayEvent},function(_CalendarUtils){CALENDAR_EVENT_HEIGHT=_CalendarUtils.CALENDAR_EVENT_HEIGHT,eventEndsAfterDay=_CalendarUtils.eventEndsAfterDay,eventStartsBefore=_CalendarUtils.eventStartsBefore,getEventColor=_CalendarUtils.getEventColor,getTimeZone=_CalendarUtils.getTimeZone},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_CalendarDayEventsView){CalendarDayEventsView=_CalendarDayEventsView.CalendarDayEventsView,calendarDayTimes=_CalendarDayEventsView.calendarDayTimes},function(_guiTheme){theme=_guiTheme.theme},function(_guiSize){px=_guiSize.px,size=_guiSize.size},function(_guiBasePageView){PageView=_guiBasePageView.PageView},function(_CalendarView){DEFAULT_HOUR_OF_DAY=_CalendarView.DEFAULT_HOUR_OF_DAY}],execute:function(){_export("CalendarDayView",CalendarDayView=function(){function CalendarDayView(){_classCallCheck(this,CalendarDayView),this._domElements=[],this._scrollPosition=size.calendar_hour_height*DEFAULT_HOUR_OF_DAY}return _createClass(CalendarDayView,[{key:"view",value:function(vnode){this._selectedDate=vnode.attrs.selectedDate;var previousDate=incrementDate(new Date(vnode.attrs.selectedDate),-1),nextDate=incrementDate(new Date(vnode.attrs.selectedDate),1),previousPageEvents=this._calculateEventsForDate(vnode.attrs,previousDate),currentPageEvents=this._calculateEventsForDate(vnode.attrs,vnode.attrs.selectedDate),nextPageEvents=this._calculateEventsForDate(vnode.attrs,nextDate);return m(PageView,{previousPage:{key:previousDate.getTime(),nodes:this._renderDay(vnode,previousDate,previousPageEvents,currentPageEvents)},currentPage:{key:vnode.attrs.selectedDate.getTime(),nodes:this._renderDay(vnode,vnode.attrs.selectedDate,currentPageEvents,currentPageEvents)},nextPage:{key:nextDate.getTime(),nodes:this._renderDay(vnode,nextDate,nextPageEvents,currentPageEvents)},onChangePage:function(next){return vnode.attrs.onDateSelected(next?nextDate:previousDate)}})}},{key:"_calculateEventsForDate",value:function(attrs,date){var dayEvents=attrs.eventsForDays.get(date.getTime()),events=dayEvents||[],shortEvents=[],longEvents=[],allDayEvents=[],zone=getTimeZone();return events.forEach(function(e){attrs.hiddenCalendars.has(neverNull(e._ownerGroup))||(isAllDayEvent(e)?allDayEvents.push(e):eventStartsBefore(date,zone,e)||eventEndsAfterDay(date,zone,e)?longEvents.push(e):shortEvents.push(e))}),{shortEvents:shortEvents,longEvents:longEvents,allDayEvents:allDayEvents}}},{key:"_renderDay",value:function(vnode,date,thisPageEvents,mainPageEvents){var _this=this,shortEvents=thisPageEvents.shortEvents,longEvents=thisPageEvents.longEvents,allDayEvents=thisPageEvents.allDayEvents,mainPageEventsCount=mainPageEvents.allDayEvents.length+mainPageEvents.longEvents.length,zone=getTimeZone();return m(".fill-absolute.flex.col.calendar-column-border.margin-are-inset-lr",{oncreate:function(){_this._redrawIntervalId=setInterval(m.redraw,6e4)},onremove:function(){null!=_this._redrawIntervalId&&(clearInterval(_this._redrawIntervalId),_this._redrawIntervalId=null)}},[m(".calendar-long-events-header.flex-fixed"+(0===mainPageEventsCount?"":".mt-s"),{style:{height:px(0===mainPageEventsCount?0:mainPageEventsCount*CALENDAR_EVENT_HEIGHT+9)}},[m(".calendar-hour-margin.pr-l",allDayEvents.map(function(e){return m(ContinuingCalendarEventBubble,{event:e,startsBefore:eventStartsBefore(date,zone,e),endsAfter:eventEndsAfterDay(date,zone,e),color:getEventColor(e,vnode.attrs.groupColors),onEventClicked:function(){return vnode.attrs.onEventClicked(e)},showTime:EventTextTimeOption.NO_TIME})})),m(".calendar-hour-margin.pr-l",longEvents.map(function(e){return m(ContinuingCalendarEventBubble,{event:e,startsBefore:eventStartsBefore(date,zone,e),endsAfter:eventEndsAfterDay(date,zone,e),color:getEventColor(e,vnode.attrs.groupColors),onEventClicked:function(){return vnode.attrs.onEventClicked(e)},showTime:EventTextTimeOption.START_TIME})})),mainPageEvents.allDayEvents.length>0||mainPageEvents.longEvents.length>0?m(".mt-s"):null]),m(".flex.scroll",{oncreate:function(vnode){vnode.dom.scrollTop=_this._scrollPosition,_this._domElements.push(vnode.dom)},onscroll:function(event){date===vnode.attrs.selectedDate&&(_this._domElements.forEach(function(dom){dom!==event.target&&(dom.scrollTop=event.target.scrollTop)}),_this._scrollPosition=event.target.scrollTop)}},[m(".flex.col",calendarDayTimes.map(function(n){return m(".calendar-hour.flex",{onclick:function(e){e.stopPropagation(),vnode.attrs.onNewEvent(n)}},m(".pt.pl-s.pr-s.center.small",{style:{width:px(size.calendar_hour_width_mobile),height:px(size.calendar_hour_height),"border-right":"2px solid "+theme.content_border}},formatTime(n)))})),m(".flex-grow",m(CalendarDayEventsView,{onEventClicked:vnode.attrs.onEventClicked,groupColors:vnode.attrs.groupColors,events:shortEvents.filter(function(ev){return!vnode.attrs.hiddenCalendars.has(neverNull(ev._ownerGroup))}),displayTimeIndicator:isSameDay(new Date,vnode.attrs.selectedDate),onTimePressed:function(hours,minutes){var newDate=new Date(vnode.attrs.selectedDate);newDate.setHours(hours,minutes),vnode.attrs.onNewEvent(newDate)},onTimeContextPressed:function(hours,minutes){var newDate=new Date(vnode.attrs.selectedDate);newDate.setHours(hours,minutes),vnode.attrs.onNewEvent(newDate)}}))])])}}]),CalendarDayView}()),_export("CalendarDayView",CalendarDayView)}}}),System.register("src/gui/InfoMessageHandler.js",["mithril","../api/main/WorkerClient","./base/NotificationOverlay","../misc/LanguageViewModel","../api/Env"],function(_export,_context){"use strict";var m,worker,showNotificationOverlay,lang,assertMainOrNode;return{setters:[function(_mithril){m=_mithril.default},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_baseNotificationOverlay){showNotificationOverlay=_baseNotificationOverlay.show},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode}],execute:function(){assertMainOrNode(),worker.infoMessages.map(function(message){showNotificationOverlay({view:function(){return m("",lang.get(message.translationKey,message.args))}},{label:"close_alt"},[])})}}}),System.register("src/gui/base/SearchInPageOverlay.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../../api/main/LoginController.js","./Overlay","../size","./icons/Icons","../../api/Env","../../api/common/WorkerProtocol.js","../../misc/LanguageViewModel","../animation/Animations","../../native/NativeWrapper.js","./ButtonN","../../api/common/TutanotaConstants"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,logins,displayOverlay,px,size,Icons,assertMainOrNode,Request,lang,transform,nativeApp,ButtonN,ButtonType,Keys,SearchInPageOverlay,searchInPageOverlay;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiMainLoginControllerJs){logins=_apiMainLoginControllerJs.logins},function(_Overlay){displayOverlay=_Overlay.displayOverlay},function(_size){px=_size.px,size=_size.size},function(_iconsIcons){Icons=_iconsIcons.Icons},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiCommonWorkerProtocolJs){Request=_apiCommonWorkerProtocolJs.Request},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_animationAnimations){transform=_animationAnimations.transform},function(_nativeNativeWrapperJs){nativeApp=_nativeNativeWrapperJs.nativeApp},function(_ButtonN){ButtonN=_ButtonN.ButtonN,ButtonType=_ButtonN.ButtonType},function(_apiCommonTutanotaConstants){Keys=_apiCommonTutanotaConstants.Keys}],execute:function(){assertMainOrNode(),_export("SearchInPageOverlay",SearchInPageOverlay=function(){function SearchInPageOverlay(){var _this=this;_classCallCheck(this,SearchInPageOverlay),this._matchCase=!1,this._numberOfMatches=0,this._currentMatch=0,this._skipNextBlur=!1,this._inputField=function(){return m("input#search-overlay-input.dropdown-bar.elevated-bg.pl-l.button-height.inputWrapper",{placeholder:lang.get("searchPage_action"),oncreate:function(vnode){_this._domInput=vnode.dom,_this._domInput.focus()},onblur:function(e){_this._skipNextBlur?(_this._skipNextBlur=!1,_this._domInput.focus()):nativeApp.invokeNative(new Request("setSearchOverlayState",[!1,!1]))},onfocus:function(e){return nativeApp.invokeNative(new Request("setSearchOverlayState",[!0,!1]))},oninput:function(e){return _this._find(!0,!1)},style:{width:px(250),top:0,height:px(size.button_height),left:0}},"")},this._find=function(forward,findNext){return console.log("finding next",_this._domInput.value),_this._skipNextBlur=!0,nativeApp.invokeNative(new Request("findInPage",[_this._domInput.value,{forward:forward,matchCase:_this._matchCase,findNext:findNext}])).then(function(r){return _this.applyNextResult(r.activeMatchOrdinal,r.matches)})},this._closeFunction=null}return _createClass(SearchInPageOverlay,[{key:"open",value:function(){logins.isUserLoggedIn()&&(this._closeFunction?(console.log("refocusing"),this._domInput.focus(),this._domInput.select()):this._closeFunction=displayOverlay(this._getRect(),this._getComponent(),function(dom){return transform(transform.type.translateY,dom.offsetHeight,0)},function(dom){return transform(transform.type.translateY,0,dom.offsetHeight)}),m.redraw())}},{key:"close",value:function(){this._closeFunction&&(this._closeFunction(),nativeApp.invokeNative(new Request("stopFindInPage",[])),this._closeFunction=null),m.redraw()}},{key:"_getRect",value:function(){return{height:px(size.navbar_height_mobile),bottom:px(0),right:px(0),left:px(0)}}},{key:"applyNextResult",value:function(activeMatchOrdinal,matches){1===matches&&(this._domInput.blur(),this._domInput.focus()),this._numberOfMatches=matches-1,this._currentMatch=activeMatchOrdinal-1,m.redraw()}},{key:"_getComponent",value:function(){var _this2=this,caseButtonAttrs={label:"matchCase_alt",icon:function(){return Icons.MatchCase},type:ButtonType.Action,noBubble:!0,isSelected:function(){return _this2._matchCase},click:function(){_this2._matchCase=!_this2._matchCase,_this2._find(!0,!1)}},forwardButtonAttrs={label:"next_action",icon:function(){return Icons.ArrowForward},type:ButtonType.Action,noBubble:!0,click:function(){return _this2._find(!0,!0)}},backwardButtonAttrs={label:"previous_action",icon:function(){return Icons.ArrowBackward},type:ButtonType.Action,noBubble:!0,click:function(){return _this2._find(!1,!0)}},closeButtonAttrs={label:"close_alt",icon:function(){return Icons.Cancel},type:ButtonType.Action,click:function(){return _this2.close()}};return{view:function(vnode){return m(".flex.flex-space-between",[m(".flex-start.center-vertically",{onkeydown:function(e){return e.which===Keys.ESC.code&&_this2.close(),e.stopPropagation(),!0}},[_this2._inputField(),m(ButtonN,backwardButtonAttrs),m(ButtonN,forwardButtonAttrs),m(ButtonN,caseButtonAttrs),m("div.pl-m",_this2._numberOfMatches>0?_this2._currentMatch+"/"+_this2._numberOfMatches:lang.get("searchNoResults_msg"))]),m(ButtonN,closeButtonAttrs)])}}}}]),SearchInPageOverlay}()),_export("SearchInPageOverlay",SearchInPageOverlay),_export("searchInPageOverlay",searchInPageOverlay=new SearchInPageOverlay),_export("searchInPageOverlay",searchInPageOverlay)}}}),System.register("src/login/ContactFormRequestDialog.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/Dialog","../gui/base/Button","../gui/base/TextField","../misc/LanguageViewModel","../misc/Formatter","../api/common/TutanotaConstants","../gui/animation/Animations","../api/Env","../file/FileController","../api/common/utils/ArrayUtils","../misc/WindowFacade","../gui/base/DropDownSelector","../api/main/WorkerClient","../gui/base/Icon","../mail/MailUtils","../api/common/error/RestError","../api/common/utils/Utils","../misc/ClientDetector","../api/entities/sys/PushIdentifier","../api/common/EntityFunctions","../api/main/LoginController","../settings/PasswordForm","../gui/base/HtmlEditor","../gui/base/ProgressDialog","../gui/base/icons/Icons","../contacts/ContactFormUtils","mithril/stream/stream.js","../gui/base/CheckboxN","./LoginView","../gui/base/ButtonN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,Dialog,DialogType,Button,createDropDownButton,TextField,Type,lang,formatStorageSize,getCleanedMailAddress,ConversationType,InputFieldType,Keys,MAX_ATTACHMENT_SIZE,PushServiceType,animations,height,assertMainOrNode,fileController,mapAndFilterNull,remove,windowFacade,DropDownSelector,worker,progressIcon,createRecipientInfo,resolveRecipientInfo,AccessDeactivatedError,neverNull,client,createPushIdentifier,PushIdentifierTypeRef,HttpMethodEnum,logins,PasswordForm,HtmlEditor,showProgressDialog,Icons,getDefaultContactFormLanguage,stream,CheckboxN,getPrivacyStatementLink,ButtonType,ContactFormRequestDialog;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_guiBaseButton){Button=_guiBaseButton.Button,createDropDownButton=_guiBaseButton.createDropDownButton},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField,Type=_guiBaseTextField.Type},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_miscFormatter){formatStorageSize=_miscFormatter.formatStorageSize,getCleanedMailAddress=_miscFormatter.getCleanedMailAddress},function(_apiCommonTutanotaConstants){ConversationType=_apiCommonTutanotaConstants.ConversationType,InputFieldType=_apiCommonTutanotaConstants.InputFieldType,Keys=_apiCommonTutanotaConstants.Keys,MAX_ATTACHMENT_SIZE=_apiCommonTutanotaConstants.MAX_ATTACHMENT_SIZE,PushServiceType=_apiCommonTutanotaConstants.PushServiceType},function(_guiAnimationAnimations){animations=_guiAnimationAnimations.animations,height=_guiAnimationAnimations.height},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_fileFileController){fileController=_fileFileController.fileController},function(_apiCommonUtilsArrayUtils){mapAndFilterNull=_apiCommonUtilsArrayUtils.mapAndFilterNull,remove=_apiCommonUtilsArrayUtils.remove},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseIcon){progressIcon=_guiBaseIcon.progressIcon},function(_mailMailUtils){createRecipientInfo=_mailMailUtils.createRecipientInfo,resolveRecipientInfo=_mailMailUtils.resolveRecipientInfo},function(_apiCommonErrorRestError){AccessDeactivatedError=_apiCommonErrorRestError.AccessDeactivatedError},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_miscClientDetector){client=_miscClientDetector.client},function(_apiEntitiesSysPushIdentifier){createPushIdentifier=_apiEntitiesSysPushIdentifier.createPushIdentifier,PushIdentifierTypeRef=_apiEntitiesSysPushIdentifier.PushIdentifierTypeRef},function(_apiCommonEntityFunctions){HttpMethodEnum=_apiCommonEntityFunctions.HttpMethod},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_settingsPasswordForm){PasswordForm=_settingsPasswordForm.PasswordForm},function(_guiBaseHtmlEditor){HtmlEditor=_guiBaseHtmlEditor.HtmlEditor},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_contactsContactFormUtils){getDefaultContactFormLanguage=_contactsContactFormUtils.getDefaultContactFormLanguage},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseCheckboxN){CheckboxN=_guiBaseCheckboxN.CheckboxN},function(_LoginView){getPrivacyStatementLink=_LoginView.getPrivacyStatementLink},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType}],execute:function(){assertMainOrNode(),_export("ContactFormRequestDialog",ContactFormRequestDialog=function(){function ContactFormRequestDialog(contactForm){var _this=this;_classCallCheck(this,ContactFormRequestDialog),this._contactForm=contactForm,this._attachments=[],this._attachmentButtons=[],this._loadingAttachments=!1,this._subject=new TextField("subject_label",function(){return _this.getConfidentialStateMessage()}),this._attachFilesButton=new Button("attachFiles_action",function(){return _this._showFileChooserForAttachments()},function(){return Icons.Attachment}),this._subject._injectionsRight=function(){return[m(_this._attachFilesButton)]},this._statisticFields=this._createStatisticFields(contactForm),this._notificationEmailAddress=new TextField("mailAddress_label",function(){return lang.get("contactFormMailAddressInfo_msg")}).setType(Type.Area),this._passwordForm=new PasswordForm(!1,!1,!0,"contactFormEnterPasswordInfo_msg"),this._privacyPolicyAccepted=stream(!1);var headerBarAttrs={left:[{label:"cancel_action",click:function(){return _this._close()},type:ButtonType.Secondary}],right:[{label:"send_action",click:function(){return _this.send()},type:ButtonType.Primary}],middle:function(){return lang.get("createContactRequest_action")}};this._editor=(new HtmlEditor).showBorders().setPlaceholderId("contactFormPlaceholder_label").setMinHeight(200);var statisticFieldHeader=new TextField(function(){return""},function(){return lang.get("contactFormStatisticFieldsInfo_msg")}).setDisabled().setValue(lang.get("optionalValues_label"));worker.createContactFormUserGroupData();var windowCloseUnsubscribe=void 0;this.view=function(){return m("#mail-editor.text.pb",{oncreate:function(vnode){_this._domElement=vnode.dom,windowCloseUnsubscribe=windowFacade.addWindowCloseListener(function(){})},onremove:function(vnode){return windowCloseUnsubscribe()},ondragover:function(ev){ev.stopPropagation(),ev.preventDefault()},ondrop:function(ev){ev.dataTransfer.files&&ev.dataTransfer.files.length>0&&(fileController.readLocalFiles(ev.dataTransfer.files).then(function(dataFiles){_this._attachFiles(dataFiles),m.redraw()}).catch(function(e){return console.log(e),Dialog.error("couldNotAttachFile_msg")}),ev.stopPropagation(),ev.preventDefault())}},[m(".row",m(_this._subject)),m(".flex-start.flex-wrap.ml-negative-bubble"+(_this._attachmentButtons.length>0?".pt":""),_this._loadingAttachments?[m(".flex-v-center",progressIcon()),m(".small.flex-v-center.plr.button-height",lang.get("loading_msg"))]:_this._attachmentButtons.map(function(b){return m(b)})),_this._attachmentButtons.length>0?m("hr"):null,m(_this._passwordForm),m(".pt-l.text",m(_this._editor)),m(_this._notificationEmailAddress),_this._statisticFields.length>0?m(statisticFieldHeader):null,_this._statisticFields.map(function(field){return m(field.component)}),getPrivacyStatementLink()?m(CheckboxN,{label:function(){return _this._getPrivacyPolicyCheckboxContent()},checked:_this._privacyPolicyAccepted}):null])},this._dialog=Dialog.largeDialog(headerBarAttrs,this).addShortcut({key:Keys.ESC,exec:function(){return _this._close()},help:"close_alt"}).addShortcut({key:Keys.S,ctrl:!0,shift:!0,exec:function(){_this.send()},help:"send_action"}).setCloseHandler(function(){return _this._close()})}return _createClass(ContactFormRequestDialog,[{key:"_getPrivacyPolicyCheckboxContent",value:function(){var parts=lang.get("acceptPrivacyPolicy_msg").split("{privacyPolicy}");return m("",[m("span",parts[0]),m("span",m("a[href="+neverNull(getPrivacyStatementLink())+"][target=_blank]",lang.get("privacyLink_label"))),m("span",parts[1])])}},{key:"_createStatisticFields",value:function(contactForm){return getDefaultContactFormLanguage(contactForm.languages).statisticsFields.map(function(field){if(field.type===InputFieldType.ENUM){var items=field.enumValues.map(function(t){return{name:t.name,value:t.name}});items.splice(0,0,{name:"",value:null});var f=new DropDownSelector(function(){return field.name},null,items,stream(null),250);return{component:f,name:field.name,value:f.selectedValue}}var _f=new TextField(function(){return field.name});return{component:_f,name:field.name,value:_f.value}})}},{key:"_conversationTypeToTitleTextId",value:function(){return"newMail_action"}},{key:"animate",value:function(domElement,fadein){var childHeight=domElement.offsetHeight;return animations.add(domElement,fadein?height(0,childHeight):height(childHeight,0)).then(function(){domElement.style.height=""})}},{key:"show",value:function(){this._dialog.show()}},{key:"_close",value:function(){this._dialog.close()}},{key:"_showFileChooserForAttachments",value:function(){var _this2=this;return fileController.showFileChooser(!0).then(function(files){_this2._attachFiles(files),m.redraw()})}},{key:"_attachFiles",value:function(files){var _this3=this,totalSize=0;this._attachments.forEach(function(file){totalSize+=Number(file.size)});var tooBigFiles=[];files.forEach(function(file){totalSize+Number(file.size)>MAX_ATTACHMENT_SIZE?tooBigFiles.push(file.name):(totalSize+=Number(file.size),_this3._attachments.push(file))}),this._updateAttachmentButtons(),tooBigFiles.length>0&&Dialog.error(function(){return lang.get("tooBigAttachment_msg")+tooBigFiles.join(", ")})}},{key:"_updateAttachmentButtons",value:function(){var _this4=this;this._attachmentButtons=this._attachments.map(function(file){var lazyButtons=[];return lazyButtons.push(new Button("download_action",function(){if("DataFile"===file._type)return fileController.open(file);fileController.downloadAndOpen(file,!0)},null).setType(ButtonType.Secondary)),lazyButtons.push(new Button("remove_action",function(){remove(_this4._attachments,file),_this4._updateAttachmentButtons(),m.redraw()},null).setType(ButtonType.Secondary)),createDropDownButton(function(){return file.name},function(){return Icons.Attachment},function(){return lazyButtons}).setType(ButtonType.Bubble).setStaticRightText("("+formatStorageSize(Number(file.size))+")")})}},{key:"getConfidentialStateMessage",value:function(){return lang.get("confidentialStatus_msg")}},{key:"send",value:function(){var _this5=this,passwordErrorId=this._passwordForm.getErrorMessageId();if(passwordErrorId)Dialog.error(passwordErrorId);else if(!getPrivacyStatementLink()||this._privacyPolicyAccepted()){var passwordCheck=Promise.resolve(!0);this._passwordForm.isPasswordUnsecure()&&(passwordCheck=Dialog.confirm("contactFormPasswordNotSecure_msg")),passwordCheck.then(function(ok){if(ok){var cleanedNotificationMailAddress=getCleanedMailAddress(_this5._notificationEmailAddress.value());if(""!==_this5._notificationEmailAddress.value().trim()&&!cleanedNotificationMailAddress)return Dialog.error("mailAddressInvalid_msg");var password=_this5._passwordForm.getNewPassword(),statisticsFields=mapAndFilterNull(_this5._statisticFields,function(field){return field.value()?{name:field.name,value:field.value()}:null}),sendRequest=worker.createContactFormUser(password,_this5._contactForm._id,statisticsFields).then(function(contactFormResult){var userEmailAddress=contactFormResult.responseMailAddress;return worker.createSession(userEmailAddress,password,client.getIdentifier(),!1,!1).then(function(){var p=Promise.resolve();if(cleanedNotificationMailAddress){var pushIdentifier=createPushIdentifier();pushIdentifier.displayName=client.getIdentifier(),pushIdentifier.identifier=neverNull(cleanedNotificationMailAddress),pushIdentifier.language=lang.code,pushIdentifier.pushServiceType=PushServiceType.EMAIL,pushIdentifier._ownerGroup=logins.getUserController().userGroupInfo.group,pushIdentifier._owner=logins.getUserController().userGroupInfo.group,pushIdentifier._area="0",p=worker.entityRequest(PushIdentifierTypeRef,HttpMethodEnum.POST,neverNull(logins.getUserController().user.pushIdentifierList).list,null,pushIdentifier)}var recipientInfo=createRecipientInfo(contactFormResult.requestMailAddress,"",null,!0);return p.then(function(){return resolveRecipientInfo(recipientInfo).then(function(r){var recipientInfos=[r];return worker.createMailDraft(_this5._subject.value(),_this5._editor.getValue(),userEmailAddress,"",recipientInfos,[],[],ConversationType.NEW,null,_this5._attachments,!0,[]).then(function(draft){return worker.sendMailDraft(draft,recipientInfos,lang.code)})}).finally(function(e){return logins.logout(!1)})})}).then(function(){return{userEmailAddress:userEmailAddress}})});return showProgressDialog("sending_msg",sendRequest).then(function(result){return userEmailAddress=result.userEmailAddress,Promise.fromCallback(function(cb){var confirm=new Button("contactFormSubmitConfirm_action",function(){dialog.close(),cb()}).setType(ButtonType.Login),requestId=new TextField("mailAddress_label").setValue(userEmailAddress).setDisabled(),dialog=new Dialog(DialogType.EditMedium,{view:function(){return m("",[m(".dialog-header.plr-l.flex.justify-center.items-center.b",lang.get("loginCredentials_label")),m(".plr-l.pb.text-break",m(".pt",lang.get("contactFormSubmitConfirm_msg")),m(requestId)),m(confirm)])}}).setCloseHandler(function(){}).show()});var userEmailAddress}).then(function(){return _this5._close()}).catch(AccessDeactivatedError,function(e){return Dialog.error("contactFormSubmitError_msg")})}})}else Dialog.error("acceptPrivacyPolicyReminder_msg")}}]),ContactFormRequestDialog}()),_export("ContactFormRequestDialog",ContactFormRequestDialog)}}}),System.register("src/login/ContactFormView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../api/main/WorkerClient","../gui/animation/Animations","../api/common/error/RestError","../api/common/utils/Utils","./ContactFormRequestDialog","../gui/base/Dialog","../misc/LanguageViewModel","../gui/base/Icon","../gui/base/InfoView","../contacts/ContactFormUtils","../misc/HtmlSanitizer","./LoginView","../gui/base/Header","../gui/base/ButtonN","../api/common/TutanotaConstants"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,worker,animations,opacity,NotFoundError,neverNull,ContactFormRequestDialog,Dialog,getLanguage,lang,progressIcon,InfoView,getDefaultContactFormLanguage,htmlSanitizer,renderPrivacyAndImprintLinks,header,ButtonN,ButtonType,Keys,ContactFormView,contactFormView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiAnimationAnimations){animations=_guiAnimationAnimations.animations,opacity=_guiAnimationAnimations.opacity},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_ContactFormRequestDialog){ContactFormRequestDialog=_ContactFormRequestDialog.ContactFormRequestDialog},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){getLanguage=_miscLanguageViewModel.getLanguage,lang=_miscLanguageViewModel.lang},function(_guiBaseIcon){progressIcon=_guiBaseIcon.progressIcon},function(_guiBaseInfoView){InfoView=_guiBaseInfoView.InfoView},function(_contactsContactFormUtils){getDefaultContactFormLanguage=_contactsContactFormUtils.getDefaultContactFormLanguage},function(_miscHtmlSanitizer){htmlSanitizer=_miscHtmlSanitizer.htmlSanitizer},function(_LoginView){renderPrivacyAndImprintLinks=_LoginView.renderPrivacyAndImprintLinks},function(_guiBaseHeader){header=_guiBaseHeader.header},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_apiCommonTutanotaConstants){Keys=_apiCommonTutanotaConstants.Keys}],execute:function(){assertMainOrNode(),ContactFormView=function(){function ContactFormView(){var _this=this;_classCallCheck(this,ContactFormView),this._contactForm=null,this._helpHtml=null,this._headerHtml=null,this._footerHtml=null;var closeAction=function(){return _this._moreInformationDialog.close()},moreInfoHeaderBarAttrs={right:[{label:"ok_action",click:closeAction,type:ButtonType.Secondary}],middle:function(){return lang.get("moreInformation_action")}};this._moreInformationDialog=Dialog.largeDialog(moreInfoHeaderBarAttrs,{view:function(){return m(".pb",m.trust(neverNull(_this._helpHtml)))}}).addShortcut({key:Keys.ESC,exec:closeAction,help:"close_alt"}).setCloseHandler(closeAction),this.view=function(){return m(".main-view.flex.col",[m(header),m(".flex-center.scroll",m(".flex-grow-shrink-auto.max-width-l.third.pb.plr-l",_this._getContactFormContent()))])}}return _createClass(ContactFormView,[{key:"_getContactFormContent",value:function(){var _this2=this;if(this._loading)return m(".flex-center.items-center.pt-l",{onbeforeremove:function(vnode){return animations.add(vnode.dom,opacity(1,0,!1))}},progressIcon());if(this._contactForm){var language=getDefaultContactFormLanguage(this._contactForm.languages);return m("",{oncreate:function(vnode){return animations.add(vnode.dom,opacity(0,1,!1))}},[language.pageTitle?m("h1.center",language.pageTitle):null,m("",m.trust(neverNull(this._headerHtml))),m(".flex.justify-center",[m(".max-width-m.flex-grow-shrink-auto",[m(".pt-l",m(ButtonN,{label:"createContactRequest_action",click:function(){return new ContactFormRequestDialog(neverNull(_this2._contactForm)).show()},type:ButtonType.Login})),m(".pt-l",m(ButtonN,{label:"readResponse_action",click:function(){return m.route.set("/login")},type:ButtonType.Login})),this._helpHtml?m(".pt-l.flex-center",m(ButtonN,{label:"moreInformation_action",click:function(){return _this2._moreInformationDialog.show()},type:ButtonType.Secondary})):null])]),m(".pt-l",m.trust(neverNull(this._footerHtml))),renderPrivacyAndImprintLinks()])}return m(new InfoView(function(){return"404"},function(){return[m("p",lang.get("notFound404_msg")),m(".pb")]}))}},{key:"updateUrl",value:function(args){var _this3=this;this._formId!==args.formId&&(this._formId=args.formId,this._loading=!0,worker.initialized.then(function(){return worker.loadContactFormByPath(args.formId).then(function(contactForm){_this3._contactForm=contactForm,lang.setLanguage(getLanguage(_this3._contactForm.languages.map(function(l){return l.code}))).finally(function(){var language=getDefaultContactFormLanguage(contactForm.languages);document.title=language.pageTitle,_this3._headerHtml=htmlSanitizer.sanitize(language.headerHtml,!1).text,_this3._footerHtml=htmlSanitizer.sanitize(language.footerHtml,!1).text,_this3._helpHtml=htmlSanitizer.sanitize(language.helpHtml,!1).text,_this3._loading=!1,m.redraw()})}).catch(NotFoundError,function(e){_this3._loading=!1,_this3._contactForm=null,m.redraw()})}))}}]),ContactFormView}(),_export("contactFormView",contactFormView=new ContactFormView),_export("contactFormView",contactFormView)}}}),System.register("src/login/ExternalLoginView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","../api/main/WorkerClient","../misc/DeviceConfig","../api/common/error/RestError","../api/common/EntityFunctions","../api/common/utils/Encoding","../misc/LanguageViewModel","../misc/KeyManager","../misc/ClientDetector","../misc/WindowFacade","../gui/base/ProgressDialog","../api/common/TutanotaConstants","../gui/base/Icon","../gui/base/ButtonN","../gui/base/TextFieldN","../gui/base/CheckboxN","../api/common/error/CancelledError","../api/main/LoginController","../gui/base/MessageBoxN","../gui/base/Dialog","../api/Env","./LoginView","../gui/base/Header"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,worker,deviceConfig,AccessBlockedError,AccessDeactivatedError,AccessExpiredError,BadRequestError,ConnectionError,InternalServerError,NotAuthenticatedError,NotFoundError,TooManyRequestsError,GENERATED_MIN_ID,base64ToUint8Array,base64UrlToBase64,lang,keyManager,client,windowFacade,showProgressDialog,CloseEventBusOption,Keys,progressIcon,ButtonN,ButtonType,TextFieldN,TextFieldType,CheckboxN,CancelledError,logins,MessageBoxN,Dialog,assertMainOrNode,LOGIN_TITLE,renderPrivacyAndImprintLinks,header,ExternalLoginView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_miscDeviceConfig){deviceConfig=_miscDeviceConfig.deviceConfig},function(_apiCommonErrorRestError){AccessBlockedError=_apiCommonErrorRestError.AccessBlockedError,AccessDeactivatedError=_apiCommonErrorRestError.AccessDeactivatedError,AccessExpiredError=_apiCommonErrorRestError.AccessExpiredError,BadRequestError=_apiCommonErrorRestError.BadRequestError,ConnectionError=_apiCommonErrorRestError.ConnectionError,InternalServerError=_apiCommonErrorRestError.InternalServerError,NotAuthenticatedError=_apiCommonErrorRestError.NotAuthenticatedError,NotFoundError=_apiCommonErrorRestError.NotFoundError,TooManyRequestsError=_apiCommonErrorRestError.TooManyRequestsError},function(_apiCommonEntityFunctions){GENERATED_MIN_ID=_apiCommonEntityFunctions.GENERATED_MIN_ID},function(_apiCommonUtilsEncoding){base64ToUint8Array=_apiCommonUtilsEncoding.base64ToUint8Array,base64UrlToBase64=_apiCommonUtilsEncoding.base64UrlToBase64},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_miscKeyManager){keyManager=_miscKeyManager.keyManager},function(_miscClientDetector){client=_miscClientDetector.client},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiCommonTutanotaConstants){CloseEventBusOption=_apiCommonTutanotaConstants.CloseEventBusOption,Keys=_apiCommonTutanotaConstants.Keys},function(_guiBaseIcon){progressIcon=_guiBaseIcon.progressIcon},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN,TextFieldType=_guiBaseTextFieldN.Type},function(_guiBaseCheckboxN){CheckboxN=_guiBaseCheckboxN.CheckboxN},function(_apiCommonErrorCancelledError){CancelledError=_apiCommonErrorCancelledError.CancelledError},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseMessageBoxN){MessageBoxN=_guiBaseMessageBoxN.MessageBoxN},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,LOGIN_TITLE=_apiEnv.LOGIN_TITLE},function(_LoginView){renderPrivacyAndImprintLinks=_LoginView.renderPrivacyAndImprintLinks},function(_guiBaseHeader){header=_guiBaseHeader.header}],execute:function(){assertMainOrNode(),_export("ExternalLoginView",ExternalLoginView=function(){function ExternalLoginView(){var _this=this;_classCallCheck(this,ExternalLoginView),this._loading=null,this._autologinInProgress=!1,this._errorMessageId=null,this._helpText="emptyString_msg",this._password=stream(""),this._savePassword=stream(!1),this._phoneNumbers=[],this._symKeyForPasswordTransmission=null,this._sendSmsAllowed=!1,this._setupShortcuts(),this.view=function(){return m(".main-view",[m(header),m(".flex-center.scroll.pt-responsive",m(".flex-grow-shrink-auto.max-width-s.pt.pb.plr-l",_this._getView()))])}}return _createClass(ExternalLoginView,[{key:"_getView",value:function(){var _this2=this;return!this._loading||this._loading.isPending()||this._autologinInProgress?m("p.center",progressIcon()):this._errorMessageId?m("p.center",m(MessageBoxN,{label:this._errorMessageId})):[this._phoneNumbers.length>0?[m("small",lang.get(1==this._phoneNumbers.length?"clickNumber_msg":"chooseNumber_msg")),m(".mt",this._phoneNumbers.map(function(n){return m(ButtonN,{label:function(){return n.number},type:ButtonType.Login,click:function(){return _this2._sendSms(n._id)}})}))]:null,m(TextFieldN,{type:TextFieldType.Password,label:"password_label",helpLabel:function(){return lang.get("enterPresharedPassword_msg")},value:this._password}),m(CheckboxN,{label:function(){return lang.get("storePassword_action")},helpLabel:function(){return lang.get("onlyPrivateComputer_msg")},checked:this._savePassword}),m(".pt",m(ButtonN,{label:"showMail_action",click:function(){return _this2._formLogin()},type:ButtonType.Login})),m("p.center.statusTextColor",m("small",lang.get(this._helpText))),renderPrivacyAndImprintLinks()]}},{key:"_setupShortcuts",value:function(){var _this3=this,shortcuts=[{key:Keys.RETURN,exec:function(){return _this3._formLogin()},help:"login_label"}];this.oncreate=function(){return keyManager.registerShortcuts(shortcuts)},this.onremove=function(){_this3._password(""),keyManager.unregisterShortcuts(shortcuts)}}},{key:"updateUrl",value:function(args){var _this4=this,userIdLength=GENERATED_MIN_ID.length;try{var id=decodeURIComponent(location.hash).substring(6);this._userId=id.substring(0,userIdLength),this._salt=base64ToUint8Array(base64UrlToBase64(id.substring(userIdLength))),this._loading=this._loadAndSetPhoneNumbers(),this._loading.then(function(){var credentials=deviceConfig.get(_this4._userId);credentials&&!0!==args.noAutoLogin?_this4._autologin(credentials):m.redraw()})}catch(e){this._errorMessageId="invalidLink_msg",this._loading=Promise.reject(),m.redraw()}}},{key:"_autologin",value:function(credentials){var _this5=this;this._autologinInProgress=!0,showProgressDialog("login_msg",worker.initialized.then(function(){return _this5._handleSession(worker.resumeSession(credentials,_this5._salt),function(){_this5._autologinInProgress=!1})}))}},{key:"_formLogin",value:function(){var _this6=this,pw=this._password();if(""===pw)this._helpText="loginFailed_msg";else{this._helpText="login_msg";var clientIdentifier=client.browser+" "+client.device,persistentSession=this._savePassword(),createSessionPromise=worker.createExternalSession(this._userId,pw,this._salt,clientIdentifier,this._savePassword()).then(function(newCredentials){_this6._password("");var storedCredentials=deviceConfig.get(_this6._userId);if(persistentSession&&deviceConfig.set(newCredentials),storedCredentials)return worker.deleteSession(storedCredentials.accessToken).then(function(){persistentSession||deviceConfig.delete(_this6._userId)}).catch(NotFoundError,function(e){return console.log("session already deleted")})});this._handleSession(showProgressDialog("login_msg",createSessionPromise),function(){})}}},{key:"_handleSession",value:function(login,errorAction){var _this7=this;return login.then(function(){return _this7._postLoginActions()}).then(function(){m.route.set("/mail"+location.hash),_this7._helpText="emptyString_msg"}).catch(AccessExpiredError,function(e){return _this7._errorMessageId="expiredLink_msg",errorAction()}).catch(AccessBlockedError,function(e){return _this7._helpText="loginFailedOften_msg",errorAction()}).catch(NotAuthenticatedError,function(e){return _this7._helpText="invalidPassword_msg",errorAction()}).catch(AccessDeactivatedError,function(e){return _this7._helpText="loginFailed_msg",errorAction()}).catch(TooManyRequestsError,function(e){return _this7._helpText="tooManyAttempts_msg",errorAction()}).catch(CancelledError,function(){return _this7._helpText="emptyString_msg",errorAction()}).catch(ConnectionError,function(e){if(client.isIE())return _this7._helpText="loginFailed_msg",m.redraw(),errorAction();throw _this7._helpText="emptyString_msg",e}).finally(function(){return m.redraw()})}},{key:"_postLoginActions",value:function(){document.title===LOGIN_TITLE&&(document.title="Tutanota"),windowFacade.addOnlineListener(function(){console.log("online"),worker.tryReconnectEventBus(!0,!0,2e3)}),windowFacade.addOfflineListener(function(){console.log("offline"),worker.closeEventBus(CloseEventBusOption.Pause)}),logins.loginComplete()}},{key:"_loadAndSetPhoneNumbers",value:function(){var _this8=this;return worker.loadExternalPasswordChannels(this._userId,this._salt).then(function(passwordChannels){_this8._phoneNumbers=passwordChannels.phoneNumberChannels,_this8._sendSmsAllowed=!0}).catch(AccessExpiredError,function(e){_this8._errorMessageId="expiredLink_msg"}).catch(NotAuthenticatedError,function(e){_this8._errorMessageId="invalidLink_msg"}).catch(BadRequestError,function(e){_this8._errorMessageId="invalidLink_msg"}).catch(ConnectionError,function(e){if(!client.isIE())throw _this8._helpText="emptyString_msg",e;_this8._helpText="loginFailed_msg",m.redraw()}).finally(function(){return m.redraw()})}},{key:"_sendSms",value:function(phoneNumberId){var _this9=this;return this._sendSmsAllowed?(this._helpText="sendingSms_msg",this._sendSmsAllowed=!1,m.redraw(),worker.sendExternalPasswordSms(this._userId,this._salt,phoneNumberId,lang.code,this._symKeyForPasswordTransmission).then(function(result){_this9._symKeyForPasswordTransmission=result.symKeyForPasswordTransmission,_this9._helpText="smsSent_msg",setTimeout(function(){_this9._sendSmsAllowed=!0,_this9._helpText="smsResent_msg",m.redraw()},6e4)}).catch(TooManyRequestsError,function(e){_this9._helpText="smsSentOften_msg"}).catch(AccessExpiredError,function(e){_this9._errorMessageId="expiredLink_msg"}).catch(InternalServerError,function(e){_this9._helpText="smsError_msg"}).finally(function(){return m.redraw()})):Dialog.error(this._helpText)}}]),ExternalLoginView}()),_export("ExternalLoginView",ExternalLoginView)}}}),System.register("src/calendar/CalendarModel.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","./CalendarUtils","../api/common/utils/DateUtils","../api/common/utils/MapUtils","../api/common/utils/Utils","../api/common/TutanotaConstants","luxon","../api/common/utils/CommonCalendarUtils","../gui/Notifications","../api/main/EventController","../api/main/WorkerClient","../api/main/MainLocator","../api/common/EntityFunctions","../api/main/Entity","../api/entities/sys/UserAlarmInfo","../api/entities/tutanota/CalendarEvent","../misc/Formatter","../misc/LanguageViewModel","../api/Env","../api/main/LoginController","../api/common/error/RestError","../misc/ClientDetector","../api/common/utils/ArrayUtils","mithril"],function(_export,_context){"use strict";var _classCallCheck,_createClass,getAllDayDateForTimezone,getAllDayDateUTCFromZone,getDiffInDays,getEventEnd,getEventStart,getStartOfDayWithZone,getTimeZone,isLongEvent,isSameEvent,isToday,getFromMap,clone,defer,downcast,AlarmInterval,EndType,FeatureType,OperationType,RepeatPeriod,DateTime,FixedOffsetZone,IANAZone,isAllDayEvent,isAllDayEventByTimes,Notifications,isUpdateForTypeRef,worker,locator,getElementId,load,UserAlarmInfoTypeRef,CalendarEventTypeRef,formatDateWithWeekdayAndTime,formatTime,lang,isApp,logins,NotFoundError,client,insertIntoSortedArray,m,OCCURRENCES_SCHEDULED_AHEAD,CalendarModel,calendarModel;function eventComparator(l,r){return l.startTime.getTime()-r.startTime.getTime()}function addDaysForEvent(events,event,month){var zone=arguments.length>3&&void 0!==arguments[3]?arguments[3]:getTimeZone(),eventStart=getEventStart(event,zone),calculationDate=getStartOfDayWithZone(eventStart,zone),eventEndDate=getEventEnd(event,zone);if(!(eventStart.getTime()<month.start.getTime()||eventStart.getTime()>=month.end.getTime()))for(;calculationDate.getTime()<eventEndDate.getTime();)eventEndDate.getTime()>=month.start.getTime()&&insertIntoSortedArray(event,getFromMap(events,calculationDate.getTime(),function(){return[]}),eventComparator,isSameEvent),calculationDate=incrementByRepeatPeriod(calculationDate,RepeatPeriod.DAILY,1,zone)}function addDaysForLongEvent(events,event,month){var zone=arguments.length>3&&void 0!==arguments[3]?arguments[3]:getTimeZone(),eventStart=getEventStart(event,zone).getTime(),eventEnd=getEventEnd(event,zone).getTime(),calculationDate=void 0,eventEndInMonth=void 0;if(eventStart>=month.start.getTime()&&eventStart<month.end.getTime())calculationDate=getStartOfDayWithZone(new Date(eventStart),zone);else{if(!(eventStart<month.start.getTime()))return;calculationDate=new Date(month.start)}if(eventEnd>month.start.getTime()&&eventEnd<=month.end.getTime())eventEndInMonth=new Date(eventEnd);else{if(!(eventEnd>month.end.getTime()))return;eventEndInMonth=new Date(month.end)}for(var iterations=0;calculationDate.getTime()<eventEndInMonth;)if(insertIntoSortedArray(event,getFromMap(events,calculationDate.getTime(),function(){return[]}),eventComparator,isSameEvent),calculationDate=incrementByRepeatPeriod(calculationDate,RepeatPeriod.DAILY,1,zone),iterations++>1e4)throw new Error("Run into the infinite loop, addDaysForLongEvent")}function incrementByRepeatPeriod(date,repeatPeriod,interval,ianaTimeZone){switch(repeatPeriod){case RepeatPeriod.DAILY:return DateTime.fromJSDate(date,{zone:ianaTimeZone}).plus({days:interval}).toJSDate();case RepeatPeriod.WEEKLY:return DateTime.fromJSDate(date,{zone:ianaTimeZone}).plus({weeks:interval}).toJSDate();case RepeatPeriod.MONTHLY:return DateTime.fromJSDate(date,{zone:ianaTimeZone}).plus({months:interval}).toJSDate();case RepeatPeriod.ANNUALLY:return DateTime.fromJSDate(date,{zone:ianaTimeZone}).plus({years:interval}).toJSDate();default:throw new Error("Unknown repeat period")}}function iterateEventOccurrences(now,timeZone,eventStart,eventEnd,frequency,interval,endType,endValue,alarmTrigger,localTimeZone,callback){for(var occurrences=0,futureOccurrences=0,isAllDayEvent=isAllDayEventByTimes(eventStart,eventEnd),calcEventStart=isAllDayEvent?getAllDayDateForTimezone(eventStart,localTimeZone):eventStart,endDate=endType===EndType.UntilDate?isAllDayEvent?getAllDayDateForTimezone(new Date(endValue),localTimeZone):new Date(endValue):null;futureOccurrences<OCCURRENCES_SCHEDULED_AHEAD&&(endType!==EndType.Count||occurrences<endValue);){var occurrenceDate=incrementByRepeatPeriod(calcEventStart,frequency,interval*occurrences,isAllDayEvent?localTimeZone:timeZone);if(endDate&&occurrenceDate.getTime()>=endDate.getTime())break;var alarmTime=calculateAlarmTime(occurrenceDate,alarmTrigger,localTimeZone);alarmTime>=now&&(callback(alarmTime,occurrences),futureOccurrences++),occurrences++}}function calculateAlarmTime(date,interval,ianaTimeZone){var diff=void 0;switch(interval){case AlarmInterval.FIVE_MINUTES:diff={minutes:5};break;case AlarmInterval.TEN_MINUTES:diff={minutes:10};break;case AlarmInterval.THIRTY_MINUTES:diff={minutes:30};break;case AlarmInterval.ONE_HOUR:diff={hours:1};break;case AlarmInterval.ONE_DAY:diff={days:1};break;case AlarmInterval.TWO_DAYS:diff={days:2};break;case AlarmInterval.THREE_DAYS:diff={days:3};break;case AlarmInterval.ONE_WEEK:diff={weeks:1};break;default:diff={}}return DateTime.fromJSDate(date,{zone:ianaTimeZone}).minus(diff).toJSDate()}function getValidTimeZone(zone,fallback){if(IANAZone.isValidZone(zone))return zone;if(fallback&&IANAZone.isValidZone(fallback))return console.warn("Time zone "+zone+" is not valid, falling back to "+fallback),fallback;var actualFallback=FixedOffsetZone.instance((new Date).getTimezoneOffset()).name;return console.warn("Fallback time zone "+zone+" is not valid, falling back to "+actualFallback),actualFallback}return _export("addDaysForEvent",addDaysForEvent),_export("addDaysForRecurringEvent",function(events,event,month,timeZone){var repeatRule=event.repeatRule;if(null==repeatRule)throw new Error("Invalid argument: event doesn't have a repeatRule"+JSON.stringify(event));var frequency=downcast(repeatRule.frequency),interval=Number(repeatRule.interval),isLong=isLongEvent(event,timeZone),eventStartTime=new Date(getEventStart(event,timeZone)),eventEndTime=new Date(getEventEnd(event,timeZone)),repeatEndTime=null,endOccurrences=null,allDay=isAllDayEvent(event),repeatTimeZone=allDay?timeZone:getValidTimeZone(repeatRule.timeZone);repeatRule.endType===EndType.Count?endOccurrences=Number(repeatRule.endValue):repeatRule.endType===EndType.UntilDate&&(repeatEndTime=allDay?getAllDayDateForTimezone(new Date(Number(repeatRule.endValue)),timeZone):new Date(Number(repeatRule.endValue)));for(var calcStartTime=eventStartTime,calcDuration=allDay?getDiffInDays(eventEndTime,eventStartTime):eventEndTime-eventStartTime,calcEndTime=eventEndTime,iteration=1;(null==endOccurrences||iteration<=endOccurrences)&&(null==repeatEndTime||calcStartTime.getTime()<repeatEndTime)&&calcStartTime.getTime()<month.end.getTime();){if(calcEndTime.getTime()>=month.start.getTime()){var eventClone=clone(event);allDay?(eventClone.startTime=getAllDayDateUTCFromZone(calcStartTime,timeZone),eventClone.endTime=getAllDayDateUTCFromZone(calcEndTime,timeZone)):(eventClone.startTime=new Date(calcStartTime),eventClone.endTime=new Date(calcEndTime)),isLong?addDaysForLongEvent(events,eventClone,month,timeZone):addDaysForEvent(events,eventClone,month,timeZone)}calcStartTime=incrementByRepeatPeriod(eventStartTime,frequency,interval*iteration,repeatTimeZone),calcEndTime=allDay?incrementByRepeatPeriod(calcStartTime,RepeatPeriod.DAILY,calcDuration,repeatTimeZone):DateTime.fromJSDate(calcStartTime).plus(calcDuration).toJSDate(),iteration++}}),_export("addDaysForLongEvent",addDaysForLongEvent),_export("incrementByRepeatPeriod",incrementByRepeatPeriod),_export("iterateEventOccurrences",iterateEventOccurrences),_export("calculateAlarmTime",calculateAlarmTime),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_CalendarUtils){getAllDayDateForTimezone=_CalendarUtils.getAllDayDateForTimezone,getAllDayDateUTCFromZone=_CalendarUtils.getAllDayDateUTCFromZone,getDiffInDays=_CalendarUtils.getDiffInDays,getEventEnd=_CalendarUtils.getEventEnd,getEventStart=_CalendarUtils.getEventStart,getStartOfDayWithZone=_CalendarUtils.getStartOfDayWithZone,getTimeZone=_CalendarUtils.getTimeZone,isLongEvent=_CalendarUtils.isLongEvent,isSameEvent=_CalendarUtils.isSameEvent},function(_apiCommonUtilsDateUtils){isToday=_apiCommonUtilsDateUtils.isToday},function(_apiCommonUtilsMapUtils){getFromMap=_apiCommonUtilsMapUtils.getFromMap},function(_apiCommonUtilsUtils){clone=_apiCommonUtilsUtils.clone,defer=_apiCommonUtilsUtils.defer,downcast=_apiCommonUtilsUtils.downcast},function(_apiCommonTutanotaConstants){AlarmInterval=_apiCommonTutanotaConstants.AlarmInterval,EndType=_apiCommonTutanotaConstants.EndType,FeatureType=_apiCommonTutanotaConstants.FeatureType,OperationType=_apiCommonTutanotaConstants.OperationType,RepeatPeriod=_apiCommonTutanotaConstants.RepeatPeriod},function(_luxon){DateTime=_luxon.DateTime,FixedOffsetZone=_luxon.FixedOffsetZone,IANAZone=_luxon.IANAZone},function(_apiCommonUtilsCommonCalendarUtils){isAllDayEvent=_apiCommonUtilsCommonCalendarUtils.isAllDayEvent,isAllDayEventByTimes=_apiCommonUtilsCommonCalendarUtils.isAllDayEventByTimes},function(_guiNotifications){Notifications=_guiNotifications.Notifications},function(_apiMainEventController){_apiMainEventController.EventController,isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_apiCommonEntityFunctions){getElementId=_apiCommonEntityFunctions.getElementId},function(_apiMainEntity){load=_apiMainEntity.load},function(_apiEntitiesSysUserAlarmInfo){UserAlarmInfoTypeRef=_apiEntitiesSysUserAlarmInfo.UserAlarmInfoTypeRef},function(_apiEntitiesTutanotaCalendarEvent){CalendarEventTypeRef=_apiEntitiesTutanotaCalendarEvent.CalendarEventTypeRef},function(_miscFormatter){formatDateWithWeekdayAndTime=_miscFormatter.formatDateWithWeekdayAndTime,formatTime=_miscFormatter.formatTime},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){isApp=_apiEnv.isApp},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_miscClientDetector){client=_miscClientDetector.client},function(_apiCommonUtilsArrayUtils){insertIntoSortedArray=_apiCommonUtilsArrayUtils.insertIntoSortedArray},function(_mithril){m=_mithril.default}],execute:function(){OCCURRENCES_SCHEDULED_AHEAD=10,CalendarModel=function(){function CalendarModel(notifications,eventController){var _this=this;_classCallCheck(this,CalendarModel),this._notifications=notifications,this._scheduledNotifications=new Map,this._pendingAlarmRequests=new Map,isApp()||eventController.addEntityListener(function(updates){_this._entityEventsReceived(updates)})}return _createClass(CalendarModel,[{key:"scheduleAlarmsLocally",value:function(){var _this2=this;return this._localAlarmsEnabled()?worker.loadAlarmEvents().then(function(eventsWithInfos){eventsWithInfos.forEach(function(_ref){var event=_ref.event,userAlarmInfo=_ref.userAlarmInfo;_this2.scheduleUserAlarmInfo(event,userAlarmInfo)})}):Promise.resolve()}},{key:"scheduleUserAlarmInfo",value:function(event,userAlarmInfo){var _this3=this,repeatRule=event.repeatRule,localZone=getTimeZone();if(repeatRule){var repeatTimeZone=getValidTimeZone(repeatRule.timeZone,localZone),calculationLocalZone=getValidTimeZone(localZone,null);iterateEventOccurrences(new Date,repeatTimeZone,event.startTime,event.endTime,downcast(repeatRule.frequency),Number(repeatRule.interval),downcast(repeatRule.endType)||EndType.Never,Number(repeatRule.endValue),downcast(userAlarmInfo.alarmInfo.trigger),calculationLocalZone,function(time,occurrence){_this3._scheduleNotification(getElementId(userAlarmInfo)+occurrence,event,time)})}else getEventStart(event,localZone).getTime()>Date.now()&&this._scheduleNotification(getElementId(userAlarmInfo),event,calculateAlarmTime(event.startTime,downcast(userAlarmInfo.alarmInfo.trigger)))}},{key:"_scheduleNotification",value:function(identifier,event,time){var _this4=this;this._runAtDate(time,identifier,function(){var title=lang.get("reminder_label"),eventStart=getEventStart(event,getTimeZone()),body=(isToday(eventStart)?formatTime(eventStart):formatDateWithWeekdayAndTime(eventStart))+" "+event.summary;return _this4._notifications.showNotification(title,{body:body},function(){m.route.set("/calendar/agenda")})})}},{key:"_runAtDate",value:function(date,identifier,func){var _this5=this,now=Date.now(),then=date.getTime(),diff=Math.max(then-now,0),timeoutId=diff>2147483647?setTimeout(function(){return _this5._runAtDate(date,identifier,func)},2147483647):setTimeout(func,diff);this._scheduledNotifications.set(identifier,timeoutId)}},{key:"_entityEventsReceived",value:function(updates){var _this6=this,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_loop=function(){var entityEventData=_step.value;if(isUpdateForTypeRef(UserAlarmInfoTypeRef,entityEventData))if(entityEventData.operation===OperationType.CREATE){var userAlarmInfoId=[entityEventData.instanceListId,entityEventData.instanceId];load(UserAlarmInfoTypeRef,userAlarmInfoId).then(function(userAlarmInfo){var _userAlarmInfo$alarmI=userAlarmInfo.alarmInfo.calendarRef,listId=_userAlarmInfo$alarmI.listId,elementId=_userAlarmInfo$alarmI.elementId;return getFromMap(_this6._pendingAlarmRequests,elementId,defer).promise.then(function(){return load(CalendarEventTypeRef,[listId,elementId]).then(function(calendarEvent){_this6.scheduleUserAlarmInfo(calendarEvent,userAlarmInfo)})})}).catch(NotFoundError,function(e){return console.log(e,"Event or alarm were not found: ",entityEventData,e)})}else entityEventData.operation===OperationType.DELETE&&_this6._scheduledNotifications.forEach(function(value,key){key.startsWith(entityEventData.instanceId)&&(_this6._scheduledNotifications.delete(key),clearTimeout(value))});else!isUpdateForTypeRef(CalendarEventTypeRef,entityEventData)||entityEventData.operation!==OperationType.CREATE&&entityEventData.operation!==OperationType.UPDATE||getFromMap(_this6._pendingAlarmRequests,entityEventData.instanceId,defer).resolve()},_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)_loop()}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}},{key:"_localAlarmsEnabled",value:function(){return!isApp()&&logins.isInternalUserLoggedIn()&&!logins.isEnabled(FeatureType.DisableCalendar)&&client.calendarSupported()}}]),CalendarModel}(),_export("calendarModel",calendarModel=new CalendarModel(new Notifications,locator.eventController)),_export("calendarModel",calendarModel)}}}),System.register("src/login/LoginViewController.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/main/WorkerClient","../gui/base/Dialog","../api/common/error/RestError","../api/main/Entity","../api/Env","../api/common/TutanotaConstants","../api/entities/sys/CustomerProperties","../api/common/utils/Utils","../api/entities/sys/CustomerInfo","../misc/LanguageViewModel","../misc/ErrorHandlerImpl","../misc/WindowFacade","../native/PushServiceApp","../api/main/LoginController","./LoginView","../settings/PasswordForm","../misc/DeviceConfig","../misc/ClientDetector","./SecondFactorHandler","../gui/base/ProgressDialog","../mail/MailModel","../gui/theme","../native/SystemApp","../api/common/error/CancelledError","../gui/Notifications","../misc/FormatValidator","../native/FileApp","../subscription/UpgradeSubscriptionWizard","../api/entities/tutanota/ReceiveInfoServiceData","../api/common/EntityFunctions","../api/entities/tutanota/Services","../subscription/SubscriptionUtils","../calendar/CalendarModel"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,worker,Dialog,AccessBlockedError,AccessDeactivatedError,ConnectionError,NotAuthenticatedError,NotFoundError,TooManyRequestsError,load,serviceRequestVoid,update,assertMainOrNode,isAdminClient,isApp,LOGIN_TITLE,Mode,CloseEventBusOption,Const,TimeFormat,CustomerPropertiesTypeRef,neverNull,CustomerInfoTypeRef,lang,checkApprovalStatus,windowFacade,pushServiceApp,logins,PasswordForm,deviceConfig,client,secondFactorHandler,showProgressDialog,mailModel,themeId,changeColorTheme,CancelledError,notifications,isMailAddress,fileApp,_loadSignupWizard,showUpgradeWizard,createReceiveInfoServiceData,HttpMethod,TutanotaService,formatPrice,calendarModel,LoginViewController;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiCommonErrorRestError){AccessBlockedError=_apiCommonErrorRestError.AccessBlockedError,AccessDeactivatedError=_apiCommonErrorRestError.AccessDeactivatedError,ConnectionError=_apiCommonErrorRestError.ConnectionError,NotAuthenticatedError=_apiCommonErrorRestError.NotAuthenticatedError,NotFoundError=_apiCommonErrorRestError.NotFoundError,TooManyRequestsError=_apiCommonErrorRestError.TooManyRequestsError},function(_apiMainEntity){load=_apiMainEntity.load,serviceRequestVoid=_apiMainEntity.serviceRequestVoid,update=_apiMainEntity.update},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isAdminClient=_apiEnv.isAdminClient,isApp=_apiEnv.isApp,LOGIN_TITLE=_apiEnv.LOGIN_TITLE,Mode=_apiEnv.Mode},function(_apiCommonTutanotaConstants){CloseEventBusOption=_apiCommonTutanotaConstants.CloseEventBusOption,Const=_apiCommonTutanotaConstants.Const,TimeFormat=_apiCommonTutanotaConstants.TimeFormat},function(_apiEntitiesSysCustomerProperties){CustomerPropertiesTypeRef=_apiEntitiesSysCustomerProperties.CustomerPropertiesTypeRef},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_miscErrorHandlerImpl){checkApprovalStatus=_miscErrorHandlerImpl.checkApprovalStatus},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_nativePushServiceApp){pushServiceApp=_nativePushServiceApp.pushServiceApp},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_LoginView){_LoginView.LoginView},function(_settingsPasswordForm){PasswordForm=_settingsPasswordForm.PasswordForm},function(_miscDeviceConfig){deviceConfig=_miscDeviceConfig.deviceConfig},function(_miscClientDetector){client=_miscClientDetector.client},function(_SecondFactorHandler){secondFactorHandler=_SecondFactorHandler.secondFactorHandler},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_mailMailModel){mailModel=_mailMailModel.mailModel},function(_guiTheme){themeId=_guiTheme.themeId},function(_nativeSystemApp){changeColorTheme=_nativeSystemApp.changeColorTheme},function(_apiCommonErrorCancelledError){CancelledError=_apiCommonErrorCancelledError.CancelledError},function(_guiNotifications){notifications=_guiNotifications.notifications},function(_miscFormatValidator){isMailAddress=_miscFormatValidator.isMailAddress},function(_nativeFileApp){fileApp=_nativeFileApp.fileApp},function(_subscriptionUpgradeSubscriptionWizard){_loadSignupWizard=_subscriptionUpgradeSubscriptionWizard.loadSignupWizard,showUpgradeWizard=_subscriptionUpgradeSubscriptionWizard.showUpgradeWizard},function(_apiEntitiesTutanotaReceiveInfoServiceData){createReceiveInfoServiceData=_apiEntitiesTutanotaReceiveInfoServiceData.createReceiveInfoServiceData},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_apiEntitiesTutanotaServices){TutanotaService=_apiEntitiesTutanotaServices.TutanotaService},function(_subscriptionSubscriptionUtils){formatPrice=_subscriptionSubscriptionUtils.formatPrice},function(_calendarCalendarModel){calendarModel=_calendarCalendarModel.calendarModel}],execute:function(){assertMainOrNode(),_export("LoginViewController",LoginViewController=function(){function LoginViewController(view){_classCallCheck(this,LoginViewController),this.view=view,this._loginPromise=Promise.resolve(),isApp()&&worker.initialized.then(function(){themeId.map(function(theme){changeColorTheme(theme)})})}return _createClass(LoginViewController,[{key:"autologin",value:function(credentials){var _this=this;this._loginPromise.isPending()||(this._loginPromise=showProgressDialog("login_msg",worker.initialized.then(function(){return _this._handleSession(worker.resumeSession(credentials),function(){_this.view._showLoginForm(credentials.mailAddress)})})))}},{key:"migrateDeviceConfig",value:function(oldCredentials){return worker.initialized.then(function(){return Promise.each(oldCredentials,function(c){return worker.decryptUserPassword(c.userId,c.deviceToken,c.encryptedPassword).then(function(userPw){if(isMailAddress(c.mailAddress,!0))return worker.createSession(c.mailAddress,userPw,client.getIdentifier(),!0,!1).then(function(newCredentials){deviceConfig.set(newCredentials)}).finally(function(){return logins.logout(!1)})}).catch(function(ignored){console.log(ignored)})})}).return()}},{key:"formLogin",value:function(){if(!this._loginPromise.isPending()){var mailAddress=this.view.mailAddress.value(),pw=this.view.password.value();if(""===mailAddress||""===pw)this.view.helpText=lang.get("loginFailed_msg");else{this.view.helpText=lang.get("login_msg"),this.view.invalidCredentials=!1;var persistentSession=this.view.savePassword.checked();this._loginPromise=worker.createSession(mailAddress,pw,client.getIdentifier(),persistentSession,!0).then(function(newCredentials){var storedCredentials=deviceConfig.get(mailAddress);if(persistentSession&&deviceConfig.set(newCredentials),storedCredentials)return worker.deleteSession(storedCredentials.accessToken).then(function(){persistentSession||deviceConfig.delete(mailAddress)}).catch(NotFoundError,function(e){return console.log("session already deleted")})}).finally(function(){return secondFactorHandler.closeWaitingForSecondFactorDialog()}),this._handleSession(showProgressDialog("login_msg",this._loginPromise),function(){})}}}},{key:"recoverLogin",value:function(emailAddress,recoverCode,newPassword){return worker.recoverLogin(emailAddress,recoverCode,newPassword,client.getIdentifier())}},{key:"resetSecondFactors",value:function(mailAddress,password,recoverCode){return worker.resetSecondFactors(mailAddress,password,recoverCode)}},{key:"_handleSession",value:function(login,errorAction){var _this2=this;return login.then(function(){return _this2._enforcePasswordChange()}).then(function(){return logins.loadCustomizations()}).then(function(){return _this2._postLoginActions()}).then(function(){m.route.set(_this2.view._requestedPath),_this2.view.helpText=lang.get("emptyString_msg"),m.redraw()}).catch(AccessBlockedError,function(e){return _this2.view.helpText=lang.get("loginFailedOften_msg"),m.redraw(),errorAction()}).catch(NotAuthenticatedError,function(e){return _this2.view.helpText=lang.get("loginFailed_msg"),_this2.view.invalidCredentials=!0,m.redraw(),errorAction()}).catch(AccessDeactivatedError,function(e){return _this2.view.helpText=lang.get("loginFailed_msg"),m.redraw(),errorAction()}).catch(TooManyRequestsError,function(e){return _this2.view.helpText=lang.get("tooManyAttempts_msg"),m.redraw(),errorAction()}).catch(CancelledError,function(){return _this2.view.helpText=lang.get("emptyString_msg"),m.redraw(),errorAction()}).catch(ConnectionError,function(e){if(client.isIE())return _this2.view.helpText=lang.get("loginFailed_msg"),m.redraw(),errorAction();throw _this2.view.helpText=lang.get("emptyString_msg"),m.redraw(),e})}},{key:"_enforcePasswordChange",value:function(){if(logins.getUserController().user.requirePasswordUpdate)return PasswordForm.showChangeOwnPasswordDialog(!1)}},{key:"_postLoginActions",value:function(){var _this3=this;notifications.requestPermission();var postLoginTitle=document.title===LOGIN_TITLE?"Tutanota":document.title;document.title=neverNull(logins.getUserController().userGroupInfo.mailAddress)+" - "+postLoginTitle,windowFacade.addOnlineListener(function(){console.log((new Date).toISOString(),"online - try reconnect"),worker.tryReconnectEventBus(!0,!0,2e3)}),windowFacade.addOfflineListener(function(){console.log((new Date).toISOString(),"offline - pause event bus"),worker.closeEventBus(CloseEventBusOption.Pause)}),env.mode!==Mode.App&&env.mode!==Mode.Desktop||isAdminClient()||pushServiceApp.register(),checkApprovalStatus(!0).then(function(){return _this3._showUpgradeReminder()}).then(function(){return _this3._checkStorageWarningLimit()}).then(function(){secondFactorHandler.setupAcceptOtherClientLoginListener()}).then(function(){if(!isAdminClient())return mailModel.init()}).then(function(){return logins.loginComplete()}).then(function(){isApp()&&fileApp.clearFileData().catch(function(e){return console.log("Failed to clean file data",e)})}).then(function(){if(logins.isGlobalAdminUserLoggedIn()){var receiveInfoData=createReceiveInfoServiceData();return serviceRequestVoid(TutanotaService.ReceiveInfoService,HttpMethod.POST,receiveInfoData)}}).then(function(){return calendarModel.scheduleAlarmsLocally()}).then(function(){return lang.updateFormats({hour12:logins.getUserController().userSettingsGroupRoot.timeFormat===TimeFormat.TWELVE_HOURS})})}},{key:"_showUpgradeReminder",value:function(){return logins.getUserController().isFreeAccount()&&env.mode!==Mode.App?logins.getUserController().loadCustomer().then(function(customer){return load(CustomerPropertiesTypeRef,neverNull(customer.properties)).then(function(properties){return load(CustomerInfoTypeRef,customer.customerInfo).then(function(customerInfo){if(null==properties.lastUpgradeReminder&&customerInfo.creationTime.getTime()+Const.UPGRADE_REMINDER_INTERVAL<(new Date).getTime()){var message=lang.get("premiumOffer_msg",{"{1}":formatPrice(1,!0)}),title=lang.get("upgradeReminderTitle_msg");return Dialog.reminder(title,message,"https://tutanota.com/blog/posts/premium-pro-business").then(function(confirm){confirm&&showUpgradeWizard()}).then(function(){properties.lastUpgradeReminder=new Date,update(properties)})}})})}):Promise.resolve()}},{key:"_checkStorageWarningLimit",value:function(){return logins.getUserController().isOutlookAccount()?Promise.resolve():logins.getUserController().isGlobalAdmin()?worker.readUsedCustomerStorage().then(function(usedStorage){if(Number(usedStorage)>Const.MEMORY_GB_FACTOR*Const.MEMORY_WARNING_FACTOR)return worker.readAvailableCustomerStorage().then(function(availableStorage){if(Number(usedStorage)>Number(availableStorage)*Const.MEMORY_WARNING_FACTOR)return Dialog.error("insufficientStorageWarning_msg").then(function(){})})}):Promise.resolve()}},{key:"deleteCredentialsNotLoggedIn",value:function(credentials){var _this4=this;return worker.initialized.then(function(){worker.deleteSession(credentials.accessToken).then(function(){deviceConfig.delete(credentials.mailAddress),_this4.view.setKnownCredentials(deviceConfig.getAllInternal())})})}},{key:"loadSignupWizard",value:function(){return worker.initialized.then(function(){return _loadSignupWizard()})}}]),LoginViewController}()),_export("LoginViewController",LoginViewController)}}}),System.register("src/native/DeviceButtonHandler.js",["../mail/MailUtils","mithril","../mail/MailModel","../api/Env","../login/LoginView","../gui/base/Header","../gui/base/Modal","../api/common/utils/ArrayUtils","../misc/RouteChange"],function(_export,_context){"use strict";var getInboxFolder,m,mailModel,assertMainOrNode,LoginView,header,modal,last,CALENDAR_PREFIX,CONTACTS_PREFIX,MAIL_PREFIX,navButtonRoutes,SEARCH_PREFIX,SETTINGS_PREFIX;return _export("handleBackPress",function(){return Promise.resolve().then(function(){var lastModalComponent=last(modal.components);if(lastModalComponent)return lastModalComponent.component.onClose(),!0;if(tutao.currentView instanceof LoginView&&tutao.currentView.onBackPress())return!0;var viewSlider=header._getViewSlider(),currentRoute=m.route.get();if(viewSlider&&viewSlider.isForegroundColumnFocused())return viewSlider.focusNextColumn(),!0;if(window.tutao.currentView&&window.tutao.currentView.handleBackButton&&window.tutao.currentView.handleBackButton())return!0;if(currentRoute.startsWith(CONTACTS_PREFIX)||currentRoute.startsWith(SETTINGS_PREFIX)||currentRoute.startsWith(SEARCH_PREFIX)||currentRoute.startsWith(CALENDAR_PREFIX))return m.route.set(navButtonRoutes.mailUrl),!0;if(viewSlider&&viewSlider.isFirstBackgroundColumnFocused())return!1;if(viewSlider&&viewSlider.isFocusPreviousPossible())return viewSlider.focusPreviousColumn(),!0;if(m.route.get().startsWith(MAIL_PREFIX)){var parts=m.route.get().split("/").filter(function(part){return""!==part});if(parts.length>1){var selectedMailListId=parts[1];return mailModel.getMailboxDetails().then(function(mailboxDetails){var inboxMailListId=getInboxFolder(mailboxDetails[0].folders).mails;return inboxMailListId!==selectedMailListId&&(m.route.set(MAIL_PREFIX+"/"+inboxMailListId),!0)})}return!1}return!1})}),{setters:[function(_mailMailUtils){getInboxFolder=_mailMailUtils.getInboxFolder},function(_mithril){m=_mithril.default},function(_mailMailModel){mailModel=_mailMailModel.mailModel},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_loginLoginView){LoginView=_loginLoginView.LoginView},function(_guiBaseHeader){header=_guiBaseHeader.header},function(_guiBaseModal){modal=_guiBaseModal.modal},function(_apiCommonUtilsArrayUtils){last=_apiCommonUtilsArrayUtils.last},function(_miscRouteChange){CALENDAR_PREFIX=_miscRouteChange.CALENDAR_PREFIX,CONTACTS_PREFIX=_miscRouteChange.CONTACTS_PREFIX,MAIL_PREFIX=_miscRouteChange.MAIL_PREFIX,navButtonRoutes=_miscRouteChange.navButtonRoutes,SEARCH_PREFIX=_miscRouteChange.SEARCH_PREFIX,SETTINGS_PREFIX=_miscRouteChange.SETTINGS_PREFIX}],execute:function(){assertMainOrNode()}}}),System.register("src/native/OpenMailboxHandler.js",["mithril","../mail/MailUtils","../mail/MailModel","../api/main/LoginController"],function(_export,_context){"use strict";var m,getInboxFolder,mailModel,logins;return _export("openMailbox",function(userId,mailAddress,requestedPath){logins.isUserLoggedIn()&&logins.getUserController().user._id===userId?requestedPath?m.route.set("/mail"+requestedPath):mailModel.getMailboxDetails().then(function(mailboxDetails){return m.route.set("/mail/"+getInboxFolder(mailboxDetails[0].folders).mails)}):requestedPath?m.route.set("/login?noAutoLogin=false&userId="+userId+"&loginWith="+mailAddress+"&requestedPath="+encodeURIComponent(requestedPath)):m.route.set("/login?noAutoLogin=false&userId="+userId+"&loginWith="+mailAddress)}),_export("openCalendar",function(userId){logins.isUserLoggedIn()&&logins.getUserController().user._id===userId?m.route.set("/calendar/agenda"):m.route.set("/login?noAutoLogin=false&userId="+userId+"&requestedPath="+encodeURIComponent("/calendar/agenda"))}),{setters:[function(_mithril){m=_mithril.default},function(_mailMailUtils){getInboxFolder=_mailMailUtils.getInboxFolder},function(_mailMailModel){mailModel=_mailMailModel.mailModel},function(_apiMainLoginController){logins=_apiMainLoginController.logins}],execute:function(){}}}),System.register("src/search/SearchBarOverlay.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../gui/size","../misc/LanguageViewModel","../gui/base/ButtonN","../api/main/WorkerClient","../gui/base/icons/Icons","../api/common/utils/ArrayUtils","../api/main/LoginController","../api/common/TutanotaConstants","../misc/Formatter","../api/common/EntityFunctions","../api/entities/tutanota/Mail","../mail/MailUtils","../gui/base/Badge","../gui/base/Icon","../api/entities/tutanota/Contact","../api/entities/sys/GroupInfo","../gui/base/icons/BootIcons","../api/entities/sys/WhitelabelChild","../misc/ClientDetector","mithril","../gui/theme","../contacts/ContactUtils.js"],function(_export,_context){"use strict";var _classCallCheck,_createClass,px,size,lang,ButtonN,ButtonType,worker,Icons,isEmpty,logins,FULL_INDEXED_TIMESTAMP,formatDate,formatDateTimeFromYesterdayOn,formatDateWithMonth,isSameTypeRef,MailTypeRef,getMailFolderIcon,getSenderOrRecipientHeading,isTutanotaTeamMail,Badge,Icon,ContactTypeRef,GroupInfoTypeRef,BootIcons,WhitelabelChildTypeRef,client,m,theme,getContactListName,SearchBarOverlay;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_guiSize){px=_guiSize.px,size=_guiSize.size},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiCommonUtilsArrayUtils){isEmpty=_apiCommonUtilsArrayUtils.isEmpty},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonTutanotaConstants){FULL_INDEXED_TIMESTAMP=_apiCommonTutanotaConstants.FULL_INDEXED_TIMESTAMP},function(_miscFormatter){formatDate=_miscFormatter.formatDate,formatDateTimeFromYesterdayOn=_miscFormatter.formatDateTimeFromYesterdayOn,formatDateWithMonth=_miscFormatter.formatDateWithMonth},function(_apiCommonEntityFunctions){isSameTypeRef=_apiCommonEntityFunctions.isSameTypeRef},function(_apiEntitiesTutanotaMail){MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_mailMailUtils){getMailFolderIcon=_mailMailUtils.getMailFolderIcon,getSenderOrRecipientHeading=_mailMailUtils.getSenderOrRecipientHeading,isTutanotaTeamMail=_mailMailUtils.isTutanotaTeamMail},function(_guiBaseBadge){Badge=_guiBaseBadge.default},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon},function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_apiEntitiesSysWhitelabelChild){WhitelabelChildTypeRef=_apiEntitiesSysWhitelabelChild.WhitelabelChildTypeRef},function(_miscClientDetector){client=_miscClientDetector.client},function(_mithril){m=_mithril.default},function(_guiTheme){theme=_guiTheme.theme},function(_contactsContactUtilsJs){getContactListName=_contactsContactUtilsJs.getContactListName}],execute:function(){_export("SearchBarOverlay",SearchBarOverlay=function(){function SearchBarOverlay(){_classCallCheck(this,SearchBarOverlay)}return _createClass(SearchBarOverlay,[{key:"view",value:function(_ref){var attrs=_ref.attrs,state=attrs.state;return[this._renderIndexingStatus(state,attrs),state.entities&&!isEmpty(state.entities)&&attrs.isQuickSearch&&attrs.isExpanded&&attrs.isFocused?this.renderResults(state,attrs):null]}},{key:"renderResults",value:function(state,attrs){var _this=this;return m("ul.list.click.mail-list",[state.entities.map(function(result){return m("li.plr-l.flex-v-center.",{style:{height:px(52),"border-left":px(size.border_selection)+" solid transparent"},onmousedown:function(e){return attrs.skipNextBlur(!0)},onclick:function(e){return attrs.selectResult(result)},class:state.selected===result?"row-selected":""},_this.renderResult(state,result))})])}},{key:"_renderIndexingStatus",value:function(state,attrs){return attrs.isFocused||!attrs.isQuickSearch&&client.isDesktopDevice()?null!=state.indexState.failedIndexingUpTo?this._renderError(state.indexState.failedIndexingUpTo,attrs):0!==state.indexState.progress?this._renderProgress(state,attrs):null:null}},{key:"_renderProgress",value:function(state,attrs){return m(".flex.col.rel",[m(".plr-l.pt-s.pb-s.flex.items-center.flex-space-between.mr-negative-s",{style:{height:px(52),borderLeft:px(size.border_selection)+" solid transparent"}},[m(".top.flex-space-between.col",m(".bottom.flex-space-between",m("",lang.get("indexedMails_label",{"{count}":state.indexState.indexedMailCount})))),100!==state.indexState.progress?m("div",{onmousedown:function(e){return attrs.skipNextBlur(!0)}},m(ButtonN,{label:"cancel_action",click:function(){return worker.cancelMailIndexing()},type:ButtonType.Secondary})):null]),m(".abs",{style:{backgroundColor:theme.content_accent,height:"2px",width:state.indexState.progress+"%",bottom:0}})])}},{key:"_renderError",value:function(failedIndexingUpTo,attrs){return m(".flex.rel",[m(".plr-l.pt-s.pb-s.flex.items-center.flex-space-between.mr-negative-s",{style:{height:px(52),borderLeft:px(size.border_selection)+" solid transparent"}},[m(".small",lang.get("indexing_error")),m("div",{onmousedown:function(e){return attrs.skipNextBlur(!0)}},m(ButtonN,{label:"retry_action",click:function(){return worker.extendMailIndex(failedIndexingUpTo)},type:ButtonType.Secondary}))])])}},{key:"renderResult",value:function(state,result){var type=result._type?result._type:null;if(!type){var showMoreAction=result,infoText=void 0,indexInfo=void 0;return 0===showMoreAction.resultCount?(infoText=lang.get("searchNoResults_msg"),logins.getUserController().isFreeAccount()&&(indexInfo=lang.get("changeTimeFrame_msg"))):infoText=showMoreAction.allowShowMore?lang.get("showMore_action"):lang.get("moreResultsFound_msg",{"{1}":showMoreAction.resultCount-showMoreAction.shownCount}),showMoreAction.indexTimestamp>FULL_INDEXED_TIMESTAMP&&!indexInfo&&(indexInfo=lang.get("searchedUntil_msg")+" "+formatDate(new Date(showMoreAction.indexTimestamp))),indexInfo?[m(".top.flex-center",infoText),m(".bottom.flex-center.small",indexInfo)]:m("li.plr-l.pt-s.pb-s.items-center.flex-center",m(".flex-center",infoText))}if(isSameTypeRef(MailTypeRef,type)){var mail=result;return[m(".top.flex-space-between.badge-line-height",[isTutanotaTeamMail(mail)?m(Badge,{classes:".small.mr-s"},"Tutanota Team"):null,m("small.text-ellipsis",getSenderOrRecipientHeading(mail,!0)),m("small.text-ellipsis.flex-fixed",formatDateTimeFromYesterdayOn(mail.receivedDate))]),m(".bottom.flex-space-between",[m(".text-ellipsis",mail.subject),m(".icons.flex-fixed",{style:{"margin-right":"-3px"}},[m(Icon,{icon:getMailFolderIcon(mail),class:state.selected===result?"svg-content-accent-fg":"svg-content-fg"}),m(Icon,{icon:Icons.Attachment,class:state.selected===result?"svg-content-accent-fg":"svg-content-fg",style:{display:mail.attachments.length>0?"":"none"}})])])]}if(isSameTypeRef(ContactTypeRef,type)){var contact=result;return[m(".top.flex-space-between",m(".name",getContactListName(contact))),m(".bottom.flex-space-between",m("small.mail-address",contact.mailAddresses&&contact.mailAddresses.length>0?contact.mailAddresses[0].address:""))]}if(isSameTypeRef(GroupInfoTypeRef,type)){var groupInfo=result;return[m(".top.flex-space-between",m(".name",groupInfo.name)),m(".bottom.flex-space-between",[m("small.mail-address",groupInfo.mailAddress),m(".icons.flex",[groupInfo.deleted?m(Icon,{icon:Icons.Trash,class:"svg-list-accent-fg"}):null,!groupInfo.mailAddress&&m.route.get().startsWith("/settings/groups")?m(Icon,{icon:BootIcons.Settings,class:"svg-list-accent-fg"}):null,groupInfo.mailAddress&&m.route.get().startsWith("/settings/groups")?m(Icon,{icon:BootIcons.Mail,class:"svg-list-accent-fg"}):null])])]}if(isSameTypeRef(WhitelabelChildTypeRef,type)){var whitelabelChild=result;return[m(".top.flex-space-between",m(".name",whitelabelChild.mailAddress)),m(".bottom.flex-space-between",[m("small.mail-address",formatDateWithMonth(whitelabelChild.createdDate)),m(".icons.flex",[whitelabelChild.deletedDate?m(Icon,{icon:Icons.Trash,class:"svg-list-accent-fg"}):null])])]}}}]),SearchBarOverlay}()),_export("SearchBarOverlay",SearchBarOverlay)}}}),System.register("src/search/SearchBar.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../gui/base/TextField","mithril","../gui/base/icons/Icons","../api/main/LoginController","../gui/size","mithril/stream/stream.js","../gui/theme","../gui/base/Icon","../gui/animation/Animations","../gui/base/icons/BootIcons","../gui/base/Overlay","../api/entities/tutanota/Mail","../api/entities/tutanota/Contact","../misc/KeyManager","../api/common/EntityFunctions","../misc/MathUtils","../api/common/error/RestError","./SearchUtils","../api/main/MainLocator","../gui/base/Dialog","../api/main/WorkerClient","../api/entities/sys/GroupInfo","../api/common/TutanotaConstants","../api/Env","../contacts/ContactUtils","../api/entities/sys/WhitelabelChild","../gui/styles","../misc/ClientDetector","../api/common/utils/Utils","../api/main/Entity","../gui/base/List","../misc/ClientConstants","./SearchModel","./SearchBarOverlay","../misc/RouteChange","../api/common/error/IndexingNotSupportedError","../misc/LanguageViewModel","../api/common/utils/AriaUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,Type,m,Icons,logins,inputLineHeight,px,size,stream,theme,Icon,DefaultAnimationTime,BootIcons,displayOverlay,MailTypeRef,ContactTypeRef,keyManager,getElementId,isSameTypeRef,mod,NotAuthorizedError,NotFoundError,getRestriction,getSearchUrl,isAdministratedGroup,setSearchUrl,locator,Dialog,worker,GroupInfoTypeRef,FULL_INDEXED_TIMESTAMP,Keys,TabIndex,assertMainOrNode,isApp,compareContacts,WhitelabelChildTypeRef,styles,client,debounce,downcast,noOp,load,PageSize,BrowserType,hasMoreResults,SearchBarOverlay,routeChange,IndexingNotSupportedError,lang,AriaLandmarks,landmarkAttrs,MAX_SEARCH_PREVIEW_RESULTS,SearchBar;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_guiBaseTextField){Type=_guiBaseTextField.Type},function(_mithril){m=_mithril.default},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiSize){inputLineHeight=_guiSize.inputLineHeight,px=_guiSize.px,size=_guiSize.size},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiTheme){theme=_guiTheme.theme},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon},function(_guiAnimationAnimations){DefaultAnimationTime=_guiAnimationAnimations.DefaultAnimationTime},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_guiBaseOverlay){displayOverlay=_guiBaseOverlay.displayOverlay},function(_apiEntitiesTutanotaMail){MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_miscKeyManager){keyManager=_miscKeyManager.keyManager},function(_apiCommonEntityFunctions){getElementId=_apiCommonEntityFunctions.getElementId,isSameTypeRef=_apiCommonEntityFunctions.isSameTypeRef},function(_miscMathUtils){mod=_miscMathUtils.mod},function(_apiCommonErrorRestError){NotAuthorizedError=_apiCommonErrorRestError.NotAuthorizedError,NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_SearchUtils){getRestriction=_SearchUtils.getRestriction,getSearchUrl=_SearchUtils.getSearchUrl,isAdministratedGroup=_SearchUtils.isAdministratedGroup,setSearchUrl=_SearchUtils.setSearchUrl},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiCommonTutanotaConstants){FULL_INDEXED_TIMESTAMP=_apiCommonTutanotaConstants.FULL_INDEXED_TIMESTAMP,Keys=_apiCommonTutanotaConstants.Keys,TabIndex=_apiCommonTutanotaConstants.TabIndex},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isApp=_apiEnv.isApp},function(_contactsContactUtils){compareContacts=_contactsContactUtils.compareContacts},function(_apiEntitiesSysWhitelabelChild){WhitelabelChildTypeRef=_apiEntitiesSysWhitelabelChild.WhitelabelChildTypeRef},function(_guiStyles){styles=_guiStyles.styles},function(_miscClientDetector){client=_miscClientDetector.client},function(_apiCommonUtilsUtils){debounce=_apiCommonUtilsUtils.debounce,downcast=_apiCommonUtilsUtils.downcast,noOp=_apiCommonUtilsUtils.noOp},function(_apiMainEntity){load=_apiMainEntity.load},function(_guiBaseList){PageSize=_guiBaseList.PageSize},function(_miscClientConstants){BrowserType=_miscClientConstants.BrowserType},function(_SearchModel){hasMoreResults=_SearchModel.hasMoreResults},function(_SearchBarOverlay){SearchBarOverlay=_SearchBarOverlay.SearchBarOverlay},function(_miscRouteChange){routeChange=_miscRouteChange.routeChange},function(_apiCommonErrorIndexingNotSupportedError){IndexingNotSupportedError=_apiCommonErrorIndexingNotSupportedError.IndexingNotSupportedError},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonUtilsAriaUtils){AriaLandmarks=_apiCommonUtilsAriaUtils.AriaLandmarks,landmarkAttrs=_apiCommonUtilsAriaUtils.landmarkAttrs}],execute:function(){assertMainOrNode(),200,MAX_SEARCH_PREVIEW_RESULTS=10,_export("SearchBar",SearchBar=function(){function SearchBar(){var _this=this;_classCallCheck(this,SearchBar),this._doSearch=debounce(300,function(query,restriction,cb){var useSuggestions=m.route.get().startsWith("/settings"),limit=isSameTypeRef(MailTypeRef,restriction.type)?_this._isQuickSearch()?MAX_SEARCH_PREVIEW_RESULTS:PageSize:null;locator.search.search(query,restriction,useSuggestions?10:0,limit).then(function(result){return _this._loadAndDisplayResult(query,result,limit)}).finally(function(){return cb()})}),this._groupInfoRestrictionListId=null,this.lastSelectedGroupInfoResult=stream(),this.lastSelectedWhitelabelChildrenInfoResult=stream(),this.focused=!1,this.skipNextBlur=stream(!1),this.busy=!1,this._returnListener=noOp,this._state=stream({query:"",searchResult:null,indexState:locator.search.indexState(),entities:[],selected:null}),this._overlayContentComponent={view:function(){return m(SearchBarOverlay,{state:_this._state(),isQuickSearch:_this._isQuickSearch(),isFocused:_this.focused,isExpanded:_this.expanded,skipNextBlur:_this.skipNextBlur,selectResult:function(selected){return _this._selectResult(selected)}})}};var indexStateStream=void 0,routeChangeStream=void 0,lastQueryStream=void 0,shortcuts=void 0;this.view=function(vnode){return m(".flex.flex-no-grow"+(vnode.attrs.classes||""),{style:vnode.attrs.style},[m(".search-bar.flex-end.items-center"+landmarkAttrs(AriaLandmarks.Search),{oncreate:function(vnode){_this._domWrapper=vnode.dom,shortcuts=_this._setupShortcuts(),keyManager.registerShortcuts(shortcuts),locator.search.indexState.map(function(indexState){var currentResult=_this._state().searchResult;currentResult&&0!==_this._state().indexState.progress&&0===indexState.progress&&_this._doSearch(_this._state().query,currentResult.restriction,m.redraw),_this._updateState({indexState:indexState})}),indexStateStream=_this._state.map(function(state){if(_this._showOverlay(),_this._domInput){var input=_this._domInput;state.query!==input.value&&(input.value=state.query)}m.redraw()}),routeChangeStream=routeChange.map(function(newRoute){try{locator.search.isNewSearch(_this._state().query,getRestriction(newRoute.requestedPath))&&_this._updateState({searchResult:null,entities:[]})}catch(e){}}),lastQueryStream=locator.search.lastQuery.map(function(value){value&&(_this._updateState({query:value}),_this.expanded=!0)})},onremove:function(){shortcuts&&keyManager.unregisterShortcuts(shortcuts),indexStateStream&&indexStateStream.end(!0),routeChangeStream&&routeChangeStream.end(!0),lastQueryStream&&lastQueryStream.end(!0),_this._closeOverlay()},style:{"min-height":px(inputLineHeight+2),"padding-bottom":_this.expanded?_this.focused?px(0):px(1):px(2),"padding-top":px(2),"margin-right":px(styles.isDesktopLayout()?15:8),"border-bottom":vnode.attrs.alwaysExpanded||_this.expanded?_this.focused?"2px solid "+theme.content_accent:"1px solid "+theme.content_border:"0px","align-self":"center","max-width":px(400),flex:"1"}},[styles.isDesktopLayout()?m("button.ml-negative-xs.click",{tabindex:TabIndex.Default,title:lang.get("search_label"),onmousedown:function(e){_this.focused&&_this.skipNextBlur(!0)},onclick:function(e){e.preventDefault(),_this.handleSearchClick(e)}},m(Icon,{icon:BootIcons.Search,class:"flex-center items-center icon-large",style:{fill:_this.focused?theme.header_button_selected:theme.header_button}})):null,m(".searchInputWrapper.flex.items-center",{"aria-hidden":String(!_this.expanded),tabindex:_this.expanded?TabIndex.Default:TabIndex.Programmatic,style:(paddingLeft=void 0,paddingLeft=_this.expanded||vnode.attrs.alwaysExpanded?styles.isDesktopLayout()?px(10):px(6):px(0),{width:_this.inputWrapperWidth(!!vnode.attrs.alwaysExpanded),transition:"width "+DefaultAnimationTime+"ms","padding-left":paddingLeft,"padding-top":"3px","padding-bottom":"3px","overflow-x":"hidden"})},[_this._getInputField(vnode.attrs),m("button.closeIconWrapper",{onclick:function(e){return _this.close()},style:{width:size.icon_size_large},title:lang.get("close_alt"),tabindex:_this.expanded?TabIndex.Default:TabIndex.Programmatic},_this.busy?m(Icon,{icon:BootIcons.Progress,class:"flex-center items-center icon-progress-search icon-progress"}):m(Icon,{icon:Icons.Close,class:"flex-center items-center icon-large",style:{fill:theme.header_button}}))])]),vnode.attrs.spacer?m(".nav-bar-spacer"):null]);var paddingLeft}}return _createClass(SearchBar,[{key:"inputWrapperWidth",value:function(alwaysExpanded){return alwaysExpanded?"100%":this.expanded?px(200):px(0)}},{key:"_showOverlay",value:function(){null==this._closeOverlayFunction?this._closeOverlayFunction=displayOverlay(this._makeOverlayRect(),this._overlayContentComponent):m.redraw()}},{key:"_closeOverlay",value:function(){this._closeOverlayFunction&&(this._closeOverlayFunction(),this._closeOverlayFunction=null)}},{key:"_makeOverlayRect",value:function(){var domRect=this._domWrapper.getBoundingClientRect();return styles.isDesktopLayout()?{top:px(domRect.bottom+5),right:px(window.innerWidth-domRect.right),width:px(350)}:window.innerWidth<500?{top:px(size.navbar_height_mobile+6),left:px(16),right:px(16)}:{top:px(size.navbar_height_mobile+6),left:px(domRect.left),right:px(window.innerWidth-domRect.right)}}},{key:"_setupShortcuts",value:function(){var _this2=this;return[{key:Keys.F,enabled:function(){return!0},exec:function(key){_this2.focus(),m.redraw()},help:"search_label"}]}},{key:"setGroupInfoRestrictionListId",value:function(listId){this._groupInfoRestrictionListId=listId}},{key:"_downloadResults",value:function(_ref){var results=_ref.results,restriction=_ref.restriction;return 0===results.length?Promise.resolve([]):Promise.map(results,function(r){return load(restriction.type,r).catch(NotFoundError,function(){return console.log("mail from search index not found")}).catch(NotAuthorizedError,function(){return console.log("no permission on instance from search index")})})}},{key:"_selectResult",value:function(result){var query=this._state().query;if(null!=result){this._domInput.blur();var type=result._type?result._type:null;type?isSameTypeRef(MailTypeRef,type)?this._updateSearchUrl(query,downcast(result)):isSameTypeRef(ContactTypeRef,type)?this._updateSearchUrl(query,downcast(result)):isSameTypeRef(GroupInfoTypeRef,type)?this.lastSelectedGroupInfoResult(downcast(result)):isSameTypeRef(WhitelabelChildTypeRef,type)&&this.lastSelectedWhitelabelChildrenInfoResult(downcast(result)):result.allowShowMore&&this._updateSearchUrl(query)}}},{key:"handleSearchClick",value:function(e){this.focused?this.search():this.focus()}},{key:"_getRestriction",value:function(){return getRestriction(m.route.get())}},{key:"_updateSearchUrl",value:function(query,selected){setSearchUrl(getSearchUrl(query,this._getRestriction(),selected&&getElementId(selected)))}},{key:"search",value:function(query){var _this3=this,oldQuery=this._state().query;null!=query?this._updateState({query:query}):query=oldQuery;var restriction=this._getRestriction();if(isSameTypeRef(restriction.type,GroupInfoTypeRef)&&(restriction.listId=this._groupInfoRestrictionListId),!locator.search.indexState().mailIndexEnabled&&restriction&&isSameTypeRef(restriction.type,MailTypeRef))this.expanded=!1,Dialog.confirm("enableSearchMailbox_msg","search_label").then(function(confirmed){confirmed&&worker.enableMailIndexing().then(function(){_this3.search(),_this3.focus()}).catch(IndexingNotSupportedError,function(){Dialog.error(isApp()?"searchDisabledApp_msg":"searchDisabled_msg")})});else if(locator.search.isNewSearch(query,restriction)||oldQuery!==query)""!==query.trim()&&(this.busy=!0),this._doSearch(query,restriction,function(){_this3.busy=!1,m.redraw()});else{var result=locator.search.result();this._isQuickSearch()&&result&&this._showResultsInOverlay(result),this.busy=!1}}},{key:"_loadAndDisplayResult",value:function(query,result,limit){var _this4=this,safeResult=result,safeLimit=limit;this._updateState({searchResult:result}),safeResult&&!locator.search.isNewSearch(query,safeResult.restriction)&&(this._isQuickSearch()?safeLimit&&hasMoreResults(safeResult)&&safeResult.results.length<safeLimit?worker.getMoreSearchResults(safeResult,safeLimit-safeResult.results.length).then(function(moreResults){locator.search.isNewSearch(query,moreResults.restriction)||_this4._loadAndDisplayResult(query,moreResults,limit)}):this._showResultsInOverlay(safeResult):setSearchUrl(getSearchUrl(query,safeResult.restriction)))}},{key:"close",value:function(){this.expanded&&(this.expanded=!1,this._updateState({query:""}),this._domInput.blur()),m.route.get().startsWith("/search")&&(locator.search.result(null),this._updateSearchUrl(""))}},{key:"_showResultsInOverlay",value:function(result){var _this5=this;return this._downloadResults(result).then(function(entries){if(!locator.search.isNewSearch(result.query,result.restriction)){var filteredResults=_this5._filterResults(entries,result.restriction),overlayEntries=filteredResults.slice(0,MAX_SEARCH_PREVIEW_RESULTS);if(""!==result.query.trim()&&(0===overlayEntries.length||hasMoreResults(result)||overlayEntries.length<filteredResults.length||result.currentIndexTimestamp!==FULL_INDEXED_TIMESTAMP)){var moreEntry={resultCount:result.results.length,shownCount:overlayEntries.length,indexTimestamp:result.currentIndexTimestamp,allowShowMore:!isSameTypeRef(result.restriction.type,GroupInfoTypeRef)&&!isSameTypeRef(result.restriction.type,WhitelabelChildTypeRef)};overlayEntries.push(moreEntry)}_this5._updateState({entities:overlayEntries,selected:overlayEntries[0]})}})}},{key:"_isQuickSearch",value:function(){return!m.route.get().startsWith("/search")}},{key:"_filterResults",value:function(instances,restriction){var filteredInstances=instances.filter(Boolean);if(isSameTypeRef(restriction.type,GroupInfoTypeRef)&&!logins.getUserController().isGlobalAdmin()){var localAdminGroupIds=logins.getUserController().getLocalAdminGroupMemberships().map(function(gm){return gm.group});filteredInstances=filteredInstances.filter(function(gi){return isAdministratedGroup(localAdminGroupIds,downcast(gi))})}else isSameTypeRef(restriction.type,ContactTypeRef)&&filteredInstances.sort(function(o1,o2){return compareContacts(o1,o2)});return filteredInstances}},{key:"_getInputField",value:function(attrs){var _this6=this;return m("input.input.input-no-clear",{"aria-autocomplete":"list",tabindex:this.expanded?TabIndex.Default:TabIndex.Programmatic,role:"combobox",placeholder:attrs.placeholder,type:Type.Text,value:this._state().query,oncreate:function(vnode){_this6._domInput=vnode.dom},onclick:function(){return _this6.focus()},onfocus:function(){_this6.focused=!0},onblur:function(e){_this6.skipNextBlur()?setTimeout(function(){return _this6._domInput.focus()},0):_this6.blur(e),_this6.skipNextBlur(!1)},onremove:function(){_this6._domInput.onblur=null},oninput:function(e){var domValue=_this6._domInput.value;_this6._state().query!==domValue&&_this6.search(domValue)},onkeydown:function(e){var _state2=_this6._state(),selected=_state2.selected,entities=_state2.entities,keyCode=e.which;if(keyCode===Keys.ESC.code)_this6.close();else if(keyCode===Keys.RETURN.code)selected?_this6._selectResult(selected):isApp()?_this6._domInput.blur():_this6.search(),_this6._returnListener();else if(keyCode===Keys.UP.code){if(entities.length>0){var oldSelected=selected||entities[0];_this6._updateState({selected:entities[mod(entities.indexOf(oldSelected)-1,entities.length)]})}}else if(keyCode===Keys.DOWN.code&&entities.length>0){var newSelected=selected||entities[0];_this6._updateState({selected:entities[mod(entities.indexOf(newSelected)+1,entities.length)]})}return e.stopPropagation(),!0},style:{"line-height":px(inputLineHeight)}})}},{key:"focus",value:function(){var _this7=this;locator.search.indexingSupported?this.focused||(this.focused=!0,this.expanded=!0,setTimeout(function(){_this7._domInput.select(),_this7._domInput.focus(),_this7.search()},client.browser===BrowserType.SAFARI?200:0)):Dialog.error(isApp()?"searchDisabledApp_msg":"searchDisabled_msg")}},{key:"blur",value:function(e){this.focused=!1,""===this._state().query&&(this.expanded=!1,m.route.get().startsWith("/search")&&(locator.search.result(null),setSearchUrl(getSearchUrl("",getRestriction(m.route.get())))))}},{key:"getMaxWidth",value:function(){return 240}},{key:"setReturnListener",value:function(listener){this._returnListener=listener}},{key:"_updateState",value:function(update){var newState=Object.assign({},this._state(),update);return this._state(newState),newState}}]),SearchBar}()),_export("SearchBar",SearchBar)}}}),System.register("src/contacts/ContactViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../misc/LanguageViewModel","../gui/base/Button","./ContactEditor","./ContactUtils","../gui/base/ActionBar","../gui/base/TextField","../api/main/Entity","../api/Env","../misc/KeyManager","../gui/base/Dialog","../gui/base/icons/Icons","../misc/Formatter","../api/common/error/RestError","../mail/MailEditor","../gui/base/icons/BootIcons","../api/common/TutanotaConstants","../mail/MailModel","../mail/MailUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,lang,Button,ContactEditor,formatBirthdayWithMonthName,getContactAddressTypeLabel,getContactPhoneNumberTypeLabel,getContactSocialTypeLabel,ActionBar,TextField,Type,erase,assertMainOrNode,keyManager,Dialog,Icons,formatDateWithMonth,NotFoundError,MailEditor,BootIcons,ContactSocialType,getContactSocialType,Keys,mailModel,getEmailSignature,ContactViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_ContactEditor){ContactEditor=_ContactEditor.ContactEditor},function(_ContactUtils){formatBirthdayWithMonthName=_ContactUtils.formatBirthdayWithMonthName,getContactAddressTypeLabel=_ContactUtils.getContactAddressTypeLabel,getContactPhoneNumberTypeLabel=_ContactUtils.getContactPhoneNumberTypeLabel,getContactSocialTypeLabel=_ContactUtils.getContactSocialTypeLabel},function(_guiBaseActionBar){ActionBar=_guiBaseActionBar.ActionBar},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField,Type=_guiBaseTextField.Type},function(_apiMainEntity){erase=_apiMainEntity.erase},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscKeyManager){keyManager=_miscKeyManager.keyManager},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_miscFormatter){formatDateWithMonth=_miscFormatter.formatDateWithMonth},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_mailMailEditor){MailEditor=_mailMailEditor.MailEditor},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_apiCommonTutanotaConstants){ContactSocialType=_apiCommonTutanotaConstants.ContactSocialType,getContactSocialType=_apiCommonTutanotaConstants.getContactSocialType,Keys=_apiCommonTutanotaConstants.Keys},function(_mailMailModel){mailModel=_mailMailModel.mailModel},function(_mailMailUtils){getEmailSignature=_mailMailUtils.getEmailSignature}],execute:function(){assertMainOrNode(),_export("ContactViewer",ContactViewer=function(){function ContactViewer(contact){var _this=this;_classCallCheck(this,ContactViewer),this.contact=contact;var actions=(new ActionBar).add(new Button("edit_action",function(){return _this.edit()},function(){return Icons.Edit})).add(new Button("delete_action",function(){return _this.delete()},function(){return Icons.Trash})),title=this.contact.title?this.contact.title+" ":"",nickname=this.contact.nickname?' | "'+this.contact.nickname+'"':"",fullName=this.contact.firstName+" "+this.contact.lastName;this.contactAppellation=(title+fullName+nickname).trim(),this.mailAddresses=this.contact.mailAddresses.map(function(element){var textField=new TextField(function(){return getContactAddressTypeLabel(element.type,element.customTypeName)}).setValue(element.address).setDisabled(),newMailButton=new Button("sendMail_alt",function(){return _this._writeMail(element.address)},function(){return BootIcons.Mail});return textField._injectionsRight=function(){return[m(newMailButton)]},textField}),this.phones=this.contact.phoneNumbers.map(function(element){var textField=new TextField(function(){return getContactPhoneNumberTypeLabel(element.type,element.customTypeName)}).setValue(element.number).setDisabled(),callButton=new Button("callNumber_alt",function(){return null},function(){return Icons.Call});return textField._injectionsRight=function(){return m('a[href="tel:'+element.number+'"][target=_blank]',m(callButton))},textField}),this.addresses=this.contact.addresses.map(function(element){var showAddress=new TextField(function(){return getContactAddressTypeLabel(element.type,element.customTypeName)}).setType(Type.Area).setValue(element.address).setDisabled(),prepAddress=void 0;prepAddress=-1!==element.address.indexOf("\n")?encodeURIComponent(element.address.split("\n").join(" ")):encodeURIComponent(element.address);var showButton=new Button("showAddress_alt",function(){return null},function(){return Icons.Pin});return showAddress._injectionsRight=function(){return m('a[href="https://www.openstreetmap.org/search?query='+prepAddress+'"][target=_blank]',m(showButton))},showAddress}),this.socials=this.contact.socialIds.map(function(element){var showURL=new TextField(function(){return getContactSocialTypeLabel(getContactSocialType(element),element.customTypeName)}).setValue(element.socialId).setDisabled(),showButton=new Button("showURL_alt",function(){return null},function(){return Icons.ArrowForward});return showURL._injectionsRight=function(){return m("a[href="+_this.getSocialUrl(element)+"][target=_blank]",m(showButton))},showURL}),this.view=function(){return[m("#contact-viewer.fill-absolute.scroll.plr-l.pb-floating",[m(".header.pt-ml",[m(".contact-actions.flex-space-between.flex-wrap.mt-xs",[m(".left.flex-grow-shrink-150",[m(".h2.selectable.text-break",_this.contactAppellation),m(".flex-wrap.selectable",function(array,spacer){var ret=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=array[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var e=_step.value;null!=e&&(ret.length>0&&ret.push(spacer()),ret.push(e))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return ret}([_this.contact.company?m("span.company",_this.contact.company):null,_this.contact.role?m("span.title",_this.contact.role):null,_this._hasBirthday()?m("span.birthday",_this._formatBirthday()):null],function(){return m("span"," | ")}))]),m(".action-bar.align-self-end",[m(actions)])]),m("hr.hr.mt.mb")]),_this.mailAddresses.length>0||_this.phones.length>0?m(".wrapping-row",[m(".mail.mt-l",_this.mailAddresses.length>0?[m(".h4",lang.get("email_label")),m(".aggregateEditors",[_this.mailAddresses.map(function(ma){return m(ma)})])]:null),m(".phone.mt-l",_this.phones.length>0?[m(".h4",lang.get("phone_label")),m(".aggregateEditors",[_this.phones.map(function(ma){return m(ma)})])]:null)]):null,_this.addresses.length>0||_this.socials.length>0?m(".wrapping-row",[m(".address.mt-l",_this.addresses.length>0?[m(".h4",lang.get("address_label")),m(".aggregateEditors",_this.addresses.map(function(ma){return m(ma)}))]:null),m(".social.mt-l",_this.socials.length>0?[m(".h4",lang.get("social_label")),m(".aggregateEditors",_this.socials.map(function(ma){return m(ma)}))]:null)]):null,_this.contact.comment&&_this.contact.comment.trim().length>0?[m("hr.hr.mt-l"),m("p.mt-l.text-prewrap.text-break",_this.contact.comment)]:null])]},this._setupShortcuts()}return _createClass(ContactViewer,[{key:"getSocialUrl",value:function(element){var socialUrlType="",http="https://",worldwidew="www.";switch(element.type){case ContactSocialType.TWITTER:socialUrlType="twitter.com/",-1===element.socialId.indexOf("http")&&-1===element.socialId.indexOf(worldwidew)||(socialUrlType="");break;case ContactSocialType.FACEBOOK:socialUrlType="facebook.com/",-1===element.socialId.indexOf("http")&&-1===element.socialId.indexOf(worldwidew)||(socialUrlType="");break;case ContactSocialType.XING:socialUrlType="xing.com/profile/",-1===element.socialId.indexOf("http")&&-1===element.socialId.indexOf(worldwidew)||(socialUrlType="");break;case ContactSocialType.LINKED_IN:socialUrlType="linkedin.com/in/",-1===element.socialId.indexOf("http")&&-1===element.socialId.indexOf(worldwidew)||(socialUrlType="")}return-1!==element.socialId.indexOf("http")&&(http=""),-1!==element.socialId.indexOf(worldwidew)&&(worldwidew=""),""+http+worldwidew+socialUrlType+element.socialId.trim()}},{key:"_writeMail",value:function(mailAddress){var _this2=this;return mailModel.getUserMailboxDetails().then(function(mailboxDetails){var editor=new MailEditor(mailboxDetails),name=(_this2.contact.firstName+" "+_this2.contact.lastName).trim();return editor.initWithTemplate({to:[{name:name,address:mailAddress}]},"",getEmailSignature(),null).then(function(){editor.show()})})}},{key:"_setupShortcuts",value:function(){var _this3=this,shortcuts=[{key:Keys.E,exec:function(){return _this3.edit()},help:"editContact_label"}];this.oncreate=function(){return keyManager.registerShortcuts(shortcuts)},this.onbeforeremove=function(){return keyManager.unregisterShortcuts(shortcuts)}}},{key:"delete",value:function(){var _this4=this;Dialog.confirm("deleteContact_msg").then(function(confirmed){confirmed&&erase(_this4.contact).catch(NotFoundError,function(e){})})}},{key:"edit",value:function(){new ContactEditor(this.contact).show()}},{key:"_formatBirthday",value:function(){return this.contact.birthday?formatBirthdayWithMonthName(this.contact.birthday):this.contact.oldBirthday?formatDateWithMonth(this.contact.oldBirthday):""}},{key:"_hasBirthday",value:function(){return!!this.contact.birthday||!!this.contact.oldBirthday}}]),ContactViewer}()),_export("ContactViewer",ContactViewer)}}}),System.register("src/contacts/VCardImporter.js",["../api/entities/tutanota/Contact","../api/entities/tutanota/ContactAddress","../api/common/TutanotaConstants","../api/entities/tutanota/ContactMailAddress","../api/entities/tutanota/ContactPhoneNumber","../api/entities/tutanota/ContactSocialId","../api/Env","../api/entities/tutanota/Birthday"],function(_export,_context){"use strict";var createContact,createContactAddress,ContactAddressType,ContactPhoneNumberType,ContactSocialType,createContactMailAddress,createContactPhoneNumber,createContactSocialId,assertMainOrNode,createBirthday;function vCardEscapingSplit(details){var array=(details=(details=(details=details.replace(/\\\\/g,"--bslashbslash++")).replace(/\\;/g,"--semiColonsemiColon++")).replace(/\\:/g,"--dPunktdPunkt++")).split(";");return array=array.map(function(elem){return elem.trim()})}function vCardReescapingArray(details){return details.map(function(a){return a=(a=(a=(a=(a=a.replace(/\-\-bslashbslash\+\+/g,"\\")).replace(/\-\-semiColonsemiColon\+\+/g,";")).replace(/\-\-dPunktdPunkt\+\+/g,":")).replace(/\\n/g,"\n")).replace(/\\,/g,",")})}function vCardEscapingSplitAdr(addressDetails){return(addressDetails=(addressDetails=addressDetails.replace(/\\\\/g,"--bslashbslash++")).replace(/\\;/g,"--semiColonsemiColon++")).split(";").map(function(elem){return elem.trim().length>0?elem.trim().concat("\n"):""})}return _export("vCardFileToVCards",function(vCardFileData){var B="BEGIN:VCARD\n";return(vCardFileData=(vCardFileData=(vCardFileData=vCardFileData.replace(/begin:vcard/g,"BEGIN:VCARD")).replace(/end:vcard/g,"END:VCARD")).replace(/version:2.1/g,"VERSION:2.1")).indexOf("BEGIN:VCARD")>-1&&vCardFileData.indexOf("END:VCARD")>-1&&(vCardFileData.indexOf("\nVERSION:3.0")>-1||vCardFileData.indexOf("\nVERSION:2.1")>-1)?(vCardFileData=(vCardFileData=(vCardFileData=(vCardFileData=(vCardFileData=(vCardFileData=vCardFileData.replace(/\r/g,"")).replace(/\n /g,"")).replace(/\nEND:VCARD\n\n/g,"")).replace(/\nEND:VCARD\n/g,"")).replace(/\nEND:VCARD/g,"")).substring(vCardFileData.indexOf(B)+B.length)).split(B):null}),_export("vCardEscapingSplit",vCardEscapingSplit),_export("vCardReescapingArray",vCardReescapingArray),_export("vCardEscapingSplitAdr",vCardEscapingSplitAdr),_export("vCardListToContacts",function(vCardList,ownerGroupId){for(var contacts=[],i=0;i<vCardList.length;i++){var contact=createContact();contact._area="0",contact._owner=ownerGroupId,contact.autoTransmitPassword="",contact._ownerGroup=ownerGroupId;for(var vCardLines=vCardList[i].split("\n"),j=0;j<vCardLines.length;j++){var indexAfterTag=vCardLines[j].indexOf(":"),tagAndTypeString=vCardLines[j].substring(0,indexAfterTag).toUpperCase(),tagName=tagAndTypeString.split(";")[0],tagValue=vCardLines[j].substring(indexAfterTag+1);switch(tagName){case"N":for(var nameDetails=vCardReescapingArray(vCardEscapingSplit(tagValue)),_i=nameDetails.length;nameDetails.length<3;_i++)nameDetails.push("");contact.lastName=nameDetails[0],contact.firstName=(nameDetails[1]+" "+nameDetails[2]).trim(),contact.title=nameDetails[3];break;case"FN":if(""===contact.firstName&&""===contact.lastName&&null==contact.title){var fullName=vCardReescapingArray(vCardEscapingSplit(tagValue));contact.firstName=fullName.join(" ").replace(/"/g,"")}break;case"BDAY":var indexOfT=tagValue.indexOf("T"),bDayDetails=null;if(tagValue.match(/--\d{4}/g))(bDayDetails=createBirthday()).month=tagValue.substring(2,4),bDayDetails.day=tagValue.substring(4,6);else if(tagValue.match(/\d{4}-\d{2}-\d{2}/g)){var bDay=tagValue.substring(0,-1!==indexOfT?indexOfT:tagValue.length).split("-");(bDayDetails=createBirthday()).year=bDay[0].trim(),bDayDetails.month=bDay[1].trim(),bDayDetails.day=bDay[2].trim()}else tagValue.match(/\d{8}/g)&&((bDayDetails=createBirthday()).year=tagValue.substring(0,4),bDayDetails.month=tagValue.substring(4,6),bDayDetails.day=tagValue.substring(6,8));bDayDetails&&"1111"===bDayDetails.year&&(bDayDetails.year=null),contact.birthday=bDayDetails;break;case"ORG":var orgDetails=vCardReescapingArray(vCardEscapingSplit(tagValue));contact.company=orgDetails.join(" ");break;case"NOTE":var note=vCardReescapingArray(vCardEscapingSplit(tagValue));contact.comment=note.join(" ");break;case"ADR":case"ITEM1.ADR":case"ITEM2.ADR":tagAndTypeString.indexOf("HOME")>-1?_addAddress(tagValue,contact,ContactAddressType.PRIVATE):tagAndTypeString.indexOf("WORK")>-1?_addAddress(tagValue,contact,ContactAddressType.WORK):_addAddress(tagValue,contact,ContactAddressType.OTHER);break;case"EMAIL":case"ITEM1.EMAIL":case"ITEM2.EMAIL":tagAndTypeString.indexOf("HOME")>-1?_addMailAddress(tagValue,contact,ContactAddressType.PRIVATE):tagAndTypeString.indexOf("WORK")>-1?_addMailAddress(tagValue,contact,ContactAddressType.WORK):_addMailAddress(tagValue,contact,ContactAddressType.OTHER);break;case"TEL":case"ITEM1.TEL":case"ITEM2.TEL":tagValue=tagValue.replace(/[\u2000-\u206F]/g,""),tagAndTypeString.indexOf("HOME")>-1?_addPhoneNumber(tagValue,contact,ContactPhoneNumberType.PRIVATE):tagAndTypeString.indexOf("WORK")>-1?_addPhoneNumber(tagValue,contact,ContactPhoneNumberType.WORK):tagAndTypeString.indexOf("FAX")>-1?_addPhoneNumber(tagValue,contact,ContactPhoneNumberType.FAX):tagAndTypeString.indexOf("CELL")>-1?_addPhoneNumber(tagValue,contact,ContactPhoneNumberType.MOBILE):_addPhoneNumber(tagValue,contact,ContactPhoneNumberType.OTHER);break;case"URL":case"ITEM1.URL":case"ITEM2.URL":var website=createContactSocialId();website.type=ContactSocialType.OTHER,website.socialId=vCardReescapingArray(vCardEscapingSplit(tagValue)).join(""),website.customTypeName="",contact.socialIds.push(website);break;case"NICKNAME":var nick=vCardReescapingArray(vCardEscapingSplit(tagValue));contact.nickname=nick.join(" ");break;case"PHOTO":break;case"ROLE":case"TITLE":var role=vCardReescapingArray(vCardEscapingSplit(tagValue));contact.role+=(" "+role.join(" ")).trim()}}contacts[i]=contact}function _addAddress(vCardAddressValue,contact,type){var address=createContactAddress();address.type=type;var addressDetails=vCardReescapingArray(vCardEscapingSplitAdr(vCardAddressValue));address.address=addressDetails.join("").trim(),address.customTypeName="",contact.addresses.push(address)}function _addPhoneNumber(vCardPhoneNumberValue,contact,type){var phoneNumber=createContactPhoneNumber();phoneNumber.type=type,phoneNumber.number=vCardPhoneNumberValue,phoneNumber.customTypeName="",contact.phoneNumbers.push(phoneNumber)}function _addMailAddress(vCardMailAddressValue,contact,type){var email=createContactMailAddress();email.type=type,email.address=vCardMailAddressValue,email.customTypeName="",contact.mailAddresses.push(email)}return contacts}),{setters:[function(_apiEntitiesTutanotaContact){createContact=_apiEntitiesTutanotaContact.createContact},function(_apiEntitiesTutanotaContactAddress){createContactAddress=_apiEntitiesTutanotaContactAddress.createContactAddress},function(_apiCommonTutanotaConstants){ContactAddressType=_apiCommonTutanotaConstants.ContactAddressType,ContactPhoneNumberType=_apiCommonTutanotaConstants.ContactPhoneNumberType,ContactSocialType=_apiCommonTutanotaConstants.ContactSocialType},function(_apiEntitiesTutanotaContactMailAddress){createContactMailAddress=_apiEntitiesTutanotaContactMailAddress.createContactMailAddress},function(_apiEntitiesTutanotaContactPhoneNumber){createContactPhoneNumber=_apiEntitiesTutanotaContactPhoneNumber.createContactPhoneNumber},function(_apiEntitiesTutanotaContactSocialId){createContactSocialId=_apiEntitiesTutanotaContactSocialId.createContactSocialId},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiEntitiesTutanotaBirthday){createBirthday=_apiEntitiesTutanotaBirthday.createBirthday}],execute:function(){assertMainOrNode()}}}),System.register("src/contacts/MultiContactViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/Button","../api/Env","../gui/base/ActionBar","../gui/base/ColumnEmptyMessageBox","../misc/LanguageViewModel","../gui/base/icons/Icons","./ContactView","./VCardExporter","../gui/base/icons/BootIcons","../gui/theme"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,Button,assertMainOrNode,ActionBar,ColumnEmptyMessageBox,lang,Icons,exportContacts,BootIcons,theme,MultiContactViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseActionBar){ActionBar=_guiBaseActionBar.ActionBar},function(_guiBaseColumnEmptyMessageBox){ColumnEmptyMessageBox=_guiBaseColumnEmptyMessageBox.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_ContactView){_ContactView.ContactView},function(_VCardExporter){exportContacts=_VCardExporter.exportContacts},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_guiTheme){theme=_guiTheme.theme}],execute:function(){assertMainOrNode(),_export("MultiContactViewer",MultiContactViewer=function(){function MultiContactViewer(contactView){var _this=this;_classCallCheck(this,MultiContactViewer),this._contactView=contactView;var actionBar=this.createActionBar();this.view=function(){return[m(".fill-absolute.mt-xs.plr-l",contactView._contactList&&contactView._contactList.list.getSelectedEntities().length>0?[m(".button-height"),m(".flex-space-between",[m(".flex.items-center",_this._getContactSelectionMessage(contactView)),m(actionBar)])]:m(ColumnEmptyMessageBox,{message:function(){return _this._getContactSelectionMessage(contactView)},icon:BootIcons.Contacts,color:theme.content_message_bg}))]}}return _createClass(MultiContactViewer,[{key:"_getContactSelectionMessage",value:function(contactView){var nbrOfSelectedContacts=contactView._contactList?contactView._contactList.list.getSelectedEntities().length:0;return 0===nbrOfSelectedContacts?lang.get("noContact_msg"):lang.get("nbrOfContactsSelected_msg",{"{1}":nbrOfSelectedContacts})}},{key:"createActionBar",value:function(){var _this2=this,actionCallback=arguments.length>0&&void 0!==arguments[0]?arguments[0]:function(){},prependCancel=arguments.length>1&&void 0!==arguments[1]&&arguments[1],actions=new ActionBar;return prependCancel&&actions.add(new Button("cancel_action",function(){return actionCallback},function(){return Icons.Cancel})),actions.add(new Button("delete_action",function(){return _this2._contactView._deleteSelected().then(actionCallback)},function(){return Icons.Trash})),actions.add(new Button("merge_action",function(){return _this2._contactView.mergeSelected().then(actionCallback)},function(){return Icons.People}).setIsVisibleHandler(function(){return 2===_this2._contactView._contactList.list.getSelectedEntities().length})),actions.add(new Button("exportSelectedAsVCard_action",function(){exportContacts(_this2._contactView._contactList.list.getSelectedEntities())},function(){return Icons.Export})),actions}}]),MultiContactViewer}()),_export("MultiContactViewer",MultiContactViewer)}}}),System.register("src/contacts/ContactMergeView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../gui/base/Button","mithril","../gui/base/Dialog","../misc/WindowFacade","../gui/base/icons/Icons","../api/common/TutanotaConstants","../misc/LanguageViewModel","../gui/base/TextField","./ContactUtils","../api/common/utils/Utils","../gui/base/HtmlEditor","../gui/base/ButtonN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,Button,m,Dialog,windowFacade,Icons,ContactMergeAction,getContactSocialType,lang,TextField,formatBirthdayNumeric,getContactAddressTypeLabel,getContactPhoneNumberTypeLabel,getContactSocialTypeLabel,defer,HtmlEditor,Mode,ButtonN,ButtonType,ContactMergeView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_mithril){m=_mithril.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiCommonTutanotaConstants){ContactMergeAction=_apiCommonTutanotaConstants.ContactMergeAction,getContactSocialType=_apiCommonTutanotaConstants.getContactSocialType},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_ContactUtils){formatBirthdayNumeric=_ContactUtils.formatBirthdayNumeric,getContactAddressTypeLabel=_ContactUtils.getContactAddressTypeLabel,getContactPhoneNumberTypeLabel=_ContactUtils.getContactPhoneNumberTypeLabel,getContactSocialTypeLabel=_ContactUtils.getContactSocialTypeLabel},function(_apiCommonUtilsUtils){defer=_apiCommonUtilsUtils.defer},function(_guiBaseHtmlEditor){HtmlEditor=_guiBaseHtmlEditor.HtmlEditor,Mode=_guiBaseHtmlEditor.Mode},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType}],execute:function(){_export("ContactMergeView",ContactMergeView=function(){function ContactMergeView(contact1,contact2){var _this=this;_classCallCheck(this,ContactMergeView),this.contact1=contact1,this.contact2=contact2;var delButton1=new Button("delete_action",function(){Dialog.confirm("deleteContact_msg").then(function(confirmed){confirmed&&_this._close(ContactMergeAction.DeleteFirst)})},function(){return Icons.Trash}),delButton2=new Button("delete_action",function(){Dialog.confirm("deleteContact_msg").then(function(confirmed){confirmed&&_this._close(ContactMergeAction.DeleteSecond)})},function(){return Icons.Trash}),cancelAction=function(){_this._close(ContactMergeAction.Cancel)},headerBarAttrs={left:[{label:"cancel_action",click:cancelAction,type:ButtonType.Secondary}],right:[{label:"skip_action",click:function(){return _this._close(ContactMergeAction.Skip)},type:ButtonType.Primary}],middle:function(){return lang.get("merge_action")}},mailAddresses1=this.contact1.mailAddresses.map(function(element){return new TextField(function(){return getContactAddressTypeLabel(element.type,element.customTypeName)}).setValue(element.address).setDisabled()}),phones1=this.contact1.phoneNumbers.map(function(element){return new TextField(function(){return getContactPhoneNumberTypeLabel(element.type,element.customTypeName)}).setValue(element.number).setDisabled()}),addresses1=this.contact1.addresses.map(function(element){return new HtmlEditor(function(){return getContactAddressTypeLabel(element.type,element.customTypeName)}).showBorders().setValue(element.address).setEnabled(!1).setMode(Mode.HTML).setHtmlMonospace(!1)}),socials1=this.contact1.socialIds.map(function(element){return new TextField(function(){return getContactSocialTypeLabel(getContactSocialType(element),element.customTypeName)}).setValue(element.socialId).setDisabled()}),mailAddresses2=this.contact2.mailAddresses.map(function(element){return new TextField(function(){return getContactAddressTypeLabel(element.type,element.customTypeName)}).setValue(element.address).setDisabled()}),phones2=this.contact2.phoneNumbers.map(function(element){return new TextField(function(){return getContactPhoneNumberTypeLabel(element.type,element.customTypeName)}).setValue(element.number).setDisabled()}),addresses2=this.contact2.addresses.map(function(element){return new HtmlEditor(function(){return getContactAddressTypeLabel(element.type,element.customTypeName)}).showBorders().setValue(element.address).setEnabled(!1).setMode(Mode.HTML).setHtmlMonospace(!1)}),socials2=this.contact2.socialIds.map(function(element){return new TextField(function(){return getContactSocialTypeLabel(getContactSocialType(element),element.customTypeName)}).setValue(element.socialId).setDisabled()}),emptyFieldPlaceholder=new TextField("emptyString_msg").setValue("").setDisabled(),emptyHTMLFieldPlaceholder=new HtmlEditor("emptyString_msg").showBorders().setValue("").setEnabled(!1).setMode(Mode.HTML).setHtmlMonospace(!1),titleFields=this._createTextFields(this.contact1.title,this.contact2.title,"title_placeholder"),firstNameFields=this._createTextFields(this.contact1.firstName,this.contact2.firstName,"firstName_placeholder"),lastNameFields=this._createTextFields(this.contact1.lastName,this.contact2.lastName,"lastName_placeholder"),nicknameFields=this._createTextFields(this.contact1.nickname,this.contact2.nickname,"nickname_placeholder"),companyFields=this._createTextFields(this.contact1.company,this.contact2.company,"company_label"),roleFields=this._createTextFields(this.contact1.role,this.contact2.role,"role_placeholder"),birthdayFields=this._createTextFields(this.contact1.birthday?formatBirthdayNumeric(this.contact1.birthday):"",this.contact2.birthday?formatBirthdayNumeric(this.contact2.birthday):"","birthday_alt"),presharedPasswordFields=this._createTextFields(this.contact1.presharedPassword&&this.contact1.presharedPassword.length>0?"***":"",this.contact2.presharedPassword&&this.contact2.presharedPassword.length>0?"***":"","presharedPassword_label"),comment1Field=null,comment2Field=null;(this.contact1.comment||this.contact2.comment)&&(comment1Field=new HtmlEditor("comment_label").showBorders().setValue(this.contact1.comment).setEnabled(!1).setMode(Mode.HTML).setHtmlMonospace(!1),comment2Field=new HtmlEditor("comment_label").showBorders().setValue(this.contact2.comment).setEnabled(!1).setMode(Mode.HTML).setHtmlMonospace(!1));var windowCloseUnsubscribe=void 0;this.view=function(){return m("#contact-editor",{oncreate:function(vnode){return windowCloseUnsubscribe=windowFacade.addWindowCloseListener(function(){})},onremove:function(vnode){return windowCloseUnsubscribe()}},[m(".flex-center.mt",[m(".full-width.max-width-s",[m(ButtonN,{label:"mergeContacts_action",click:function(){return _this._close(ContactMergeAction.Merge)},type:ButtonType.Login})])]),m(".non-wrapping-row",[m("",[m(".items-center",[m(".items-base.flex-space-between",[m(".h4.mt-l",lang.get("firstMergeContact_label")),m(delButton1)])])]),m("",[m(".items-center",[m(".items-base.flex-space-between",[m(".h4.mt-l",lang.get("secondMergeContact_label")),m(delButton2)])])])]),titleFields?m(".non-wrapping-row",[m(titleFields[0]),m(titleFields[1])]):null,firstNameFields?m(".non-wrapping-row",[m(firstNameFields[0]),m(firstNameFields[1])]):null,lastNameFields?m(".non-wrapping-row",[m(lastNameFields[0]),m(lastNameFields[1])]):null,nicknameFields?m(".non-wrapping-row",[m(nicknameFields[0]),m(nicknameFields[1])]):null,companyFields?m(".non-wrapping-row",[m(companyFields[0]),m(companyFields[1])]):null,birthdayFields?m(".non-wrapping-row",[m(birthdayFields[0]),m(birthdayFields[1])]):null,roleFields?m(".non-wrapping-row",[m(roleFields[0]),m(roleFields[1])]):null,mailAddresses1.length>0||mailAddresses2.length>0?m(".non-wrapping-row",[m(".mail.mt-l",[m("",lang.get("email_label")),m(".aggregateEditors",[mailAddresses1.length>0?mailAddresses1.map(function(ma){return m(ma)}):m(emptyFieldPlaceholder)])]),m(".mail.mt-l",[m("",lang.get("email_label")),m(".aggregateEditors",[mailAddresses2.length>0?mailAddresses2.map(function(ma){return m(ma)}):m(emptyFieldPlaceholder)])])]):null,phones1.length>0||phones2.length>0?m(".non-wrapping-row",[m(".phone.mt-l",[m("",lang.get("phone_label")),m(".aggregateEditors",[phones1.length>0?phones1.map(function(ma){return m(ma)}):m(emptyFieldPlaceholder)])]),m(".phone.mt-l",[m("",lang.get("phone_label")),m(".aggregateEditors",[phones2.length>0?phones2.map(function(ma){return m(ma)}):m(emptyFieldPlaceholder)])])]):null,addresses1.length>0||addresses2.length>0?m(".non-wrapping-row",[m(".address.mt-l",[m("",lang.get("address_label")),m(".aggregateEditors",addresses1.length>0?addresses1.map(function(ma){return m(ma)}):m(emptyHTMLFieldPlaceholder))]),m(".address.mt-l",[m("",lang.get("address_label")),m(".aggregateEditors",addresses2.length>0?addresses2.map(function(ma){return m(ma)}):m(emptyHTMLFieldPlaceholder))])]):null,socials1.length>0||socials2.length>0?m(".non-wrapping-row",[m(".social.mt-l",[m("",lang.get("social_label")),m(".aggregateEditors",socials1.length>0?socials1.map(function(ma){return m(ma)}):m(emptyFieldPlaceholder))]),m(".social.mt-l",[m("",lang.get("social_label")),m(".aggregateEditors",socials2.length>0?socials2.map(function(ma){return m(ma)}):m(emptyFieldPlaceholder))])]):null,comment1Field&&comment2Field?m(".non-wrapping-row",[m(".mt-l",[m(comment1Field)]),m(".mt-l",[m(comment2Field)])]):null,presharedPasswordFields?m(".non-wrapping-row",[m(presharedPasswordFields[0]),m(presharedPasswordFields[1])]):null,m("",{style:{height:"5px"}})])},this.dialog=Dialog.largeDialog(headerBarAttrs,this).setCloseHandler(cancelAction)}return _createClass(ContactMergeView,[{key:"_createTextFields",value:function(value1,value2,labelTextId){return value1||value2?[new TextField(labelTextId).setValue(value1||"").setDisabled(),new TextField(labelTextId).setValue(value2||"").setDisabled()]:null}},{key:"show",value:function(){this.dialog.show();var d=defer();return this.resolveFunction=d.resolve,d.promise}},{key:"_close",value:function(action){var _this2=this;this.dialog.close(),Promise.delay(200).then(function(){_this2.resolveFunction(action)})}}]),ContactMergeView}()),_export("ContactMergeView",ContactMergeView)}}}),System.register("src/contacts/ContactView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/ViewSlider","../gui/base/ViewColumn","./ContactViewer","../gui/base/Button","../gui/base/ButtonN","./ContactEditor","../api/entities/tutanota/Contact","./ContactListView","../api/common/EntityFunctions","../misc/LanguageViewModel","../api/common/utils/Utils","../api/main/Entity","../api/common/TutanotaConstants","../api/Env","../misc/KeyManager","../gui/base/icons/Icons","../api/common/utils/Encoding","../gui/base/Dialog","../file/FileController","../api/main/LoginController","./VCardImporter","../api/common/error/RestError","./MultiContactViewer","../gui/base/Expander","../gui/theme","../gui/base/icons/BootIcons","../gui/base/ProgressDialog","../api/main/MainLocator","../contacts/ContactUtils","./ContactMergeView","./ContactMergeUtils","./VCardExporter","../gui/base/MultiSelectionBar","../api/main/EventController","../misc/RouteChange","../gui/base/NavButtonN","../gui/styles","../gui/size","../gui/base/FolderColumnView"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,ViewSlider,ColumnType,ViewColumn,ContactViewer,Button,createDropDownButton,ButtonColors,ButtonN,ButtonType,ContactEditor,ContactTypeRef,ContactListView,isSameId,lang,getGroupInfoDisplayName,neverNull,noOp,erase,load,loadAll,setup,update,ContactMergeAction,GroupType,Keys,OperationType,assertMainOrNode,isApp,keyManager,Icons,utf8Uint8ArrayToString,Dialog,fileController,logins,vCardFileToVCards,vCardListToContacts,NotFoundError,MultiContactViewer,ExpanderButton,ExpanderPanel,theme,BootIcons,showProgressDialog,locator,LazyContactListId,ContactMergeView,getMergeableContacts,mergeContacts,exportAsVCard,MultiSelectionBar,isUpdateForTypeRef,navButtonRoutes,throttleRoute,NavButtonN,styles,size,FolderColumnView,ContactView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseViewSlider){ViewSlider=_guiBaseViewSlider.ViewSlider},function(_guiBaseViewColumn){ColumnType=_guiBaseViewColumn.ColumnType,ViewColumn=_guiBaseViewColumn.ViewColumn},function(_ContactViewer){ContactViewer=_ContactViewer.ContactViewer},function(_guiBaseButton){Button=_guiBaseButton.Button,createDropDownButton=_guiBaseButton.createDropDownButton},function(_guiBaseButtonN){ButtonColors=_guiBaseButtonN.ButtonColors,ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_ContactEditor){ContactEditor=_ContactEditor.ContactEditor},function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_ContactListView){ContactListView=_ContactListView.ContactListView},function(_apiCommonEntityFunctions){isSameId=_apiCommonEntityFunctions.isSameId},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonUtilsUtils){getGroupInfoDisplayName=_apiCommonUtilsUtils.getGroupInfoDisplayName,neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_apiMainEntity){erase=_apiMainEntity.erase,load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,setup=_apiMainEntity.setup,update=_apiMainEntity.update},function(_apiCommonTutanotaConstants){ContactMergeAction=_apiCommonTutanotaConstants.ContactMergeAction,GroupType=_apiCommonTutanotaConstants.GroupType,Keys=_apiCommonTutanotaConstants.Keys,OperationType=_apiCommonTutanotaConstants.OperationType},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isApp=_apiEnv.isApp},function(_miscKeyManager){keyManager=_miscKeyManager.keyManager},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiCommonUtilsEncoding){utf8Uint8ArrayToString=_apiCommonUtilsEncoding.utf8Uint8ArrayToString},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_fileFileController){fileController=_fileFileController.fileController},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_VCardImporter){vCardFileToVCards=_VCardImporter.vCardFileToVCards,vCardListToContacts=_VCardImporter.vCardListToContacts},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_MultiContactViewer){MultiContactViewer=_MultiContactViewer.MultiContactViewer},function(_guiBaseExpander){ExpanderButton=_guiBaseExpander.ExpanderButton,ExpanderPanel=_guiBaseExpander.ExpanderPanel},function(_guiTheme){theme=_guiTheme.theme},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_contactsContactUtils){LazyContactListId=_contactsContactUtils.LazyContactListId},function(_ContactMergeView){ContactMergeView=_ContactMergeView.ContactMergeView},function(_ContactMergeUtils){getMergeableContacts=_ContactMergeUtils.getMergeableContacts,mergeContacts=_ContactMergeUtils.mergeContacts},function(_VCardExporter){exportAsVCard=_VCardExporter.exportAsVCard},function(_guiBaseMultiSelectionBar){MultiSelectionBar=_guiBaseMultiSelectionBar.MultiSelectionBar},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_miscRouteChange){navButtonRoutes=_miscRouteChange.navButtonRoutes,throttleRoute=_miscRouteChange.throttleRoute},function(_guiBaseNavButtonN){NavButtonN=_guiBaseNavButtonN.NavButtonN},function(_guiStyles){styles=_guiStyles.styles},function(_guiSize){size=_guiSize.size},function(_guiBaseFolderColumnView){FolderColumnView=_guiBaseFolderColumnView.FolderColumnView}],execute:function(){assertMainOrNode(),_export("ContactView",ContactView=function(){function ContactView(){var _this=this;_classCallCheck(this,ContactView);var expander=this.createContactFoldersExpander();this._throttledSetUrl=throttleRoute(),this.folderColumn=new ViewColumn({view:function(){return m(FolderColumnView,{button:styles.isUsingBottomNavigation()||!_this._contactList?null:{label:"newContact_action",click:function(){return _this.createNewContact()}},content:[m(".mr-negative-s.flex-space-between.plr-l.flex-no-grow-no-shrink-auto",m(expander)),m(expander.panel)],ariaLabel:"folderTitle_label"})}},ColumnType.Foreground,size.first_col_min_width,size.first_col_max_width,function(){return lang.get("folderTitle_label")}),this.listColumn=new ViewColumn({view:function(){return m(".list-column",[_this._contactList?m(_this._contactList):null])}},ColumnType.Background,size.second_col_min_width,size.second_col_max_width,function(){return lang.get("contacts_label")}),this.contactViewer=null,this._multiContactViewer=new MultiContactViewer(this);var contactColumnTitle=function(){var selectedEntities=_this._contactList?_this._contactList.list.getSelectedEntities():[];return selectedEntities.length>0?_this._contactList.list._loadedEntities.indexOf(selectedEntities[0])+1+"/"+_this._contactList.list._loadedEntities.length:""};this.contactColumn=new ViewColumn({view:function(){return m(".contact",null!=_this.contactViewer?m(_this.contactViewer):m(_this._multiContactViewer))}},ColumnType.Background,size.third_col_min_width,size.third_col_max_width,contactColumnTitle,function(){return lang.get("contacts_label")+" "+contactColumnTitle()}),this.viewSlider=new ViewSlider([this.folderColumn,this.listColumn,this.contactColumn],"ContactView"),this.view=function(){return m("#contact.main-view",[m(_this.viewSlider)])},this._setupShortcuts(),locator.eventController.addEntityListener(function(updates){updates.forEach(function(update){return _this._processEntityUpdate(update)})})}return _createClass(ContactView,[{key:"createNewContact",value:function(){var _this2=this;return new ContactEditor(null,this._contactList.listId,function(contactId){return _this2._contactList.list.scrollToIdAndSelectWhenReceived(contactId)}).show()}},{key:"headerRightView",value:function(){var _this3=this;return this._contactList&&m(ButtonN,{label:"newContact_action",click:function(){return _this3.createNewContact()},type:ButtonType.Action,icon:function(){return Icons.Add},colors:ButtonColors.Header})}},{key:"_setupShortcuts",value:function(){var _this4=this,shortcuts=[{key:Keys.UP,exec:function(){return _this4._contactList.list.selectPrevious(!1)},help:"selectPrevious_action"},{key:Keys.K,exec:function(){return _this4._contactList.list.selectPrevious(!1)},help:"selectPrevious_action"},{key:Keys.UP,shift:!0,exec:function(){return _this4._contactList.list.selectPrevious(!0)},help:"addPrevious_action"},{key:Keys.K,shift:!0,exec:function(){return _this4._contactList.list.selectPrevious(!0)},help:"addPrevious_action"},{key:Keys.DOWN,exec:function(){return _this4._contactList.list.selectNext(!1)},help:"selectNext_action"},{key:Keys.J,exec:function(){return _this4._contactList.list.selectNext(!1)},help:"selectNext_action"},{key:Keys.DOWN,shift:!0,exec:function(){return _this4._contactList.list.selectNext(!0)},help:"addNext_action"},{key:Keys.J,shift:!0,exec:function(){return _this4._contactList.list.selectNext(!0)},help:"addNext_action"},{key:Keys.DELETE,exec:function(){return _this4._deleteSelected()&&!0},help:"deleteContacts_action"},{key:Keys.N,exec:function(){return _this4.createNewContact()},enabled:function(){return null!=_this4._contactList},help:"newContact_action"}];this.oncreate=function(){return keyManager.registerShortcuts(shortcuts)},this.onbeforeremove=function(){return keyManager.unregisterShortcuts(shortcuts)}}},{key:"createContactFoldersExpander",value:function(){var folderMoreButton=this.createFolderMoreButton(),contactExpander=new ExpanderButton(function(){return getGroupInfoDisplayName(logins.getUserController().userGroupInfo)},new ExpanderPanel({view:function(){return m(".folders",[m(".folder-row.flex-space-between.plr-l.row-selected",[m(NavButtonN,{label:"all_contacts_label",icon:function(){return BootIcons.Contacts},href:function(){return m.route.get()}}),m(folderMoreButton)])])}}),!1,{},function(){return theme.navigation_button});return contactExpander.toggle(),contactExpander}},{key:"createFolderMoreButton",value:function(){var _this5=this;return createDropDownButton("more_label",function(){return Icons.More},function(){return _this5._vcardButtons().concat([new Button("merge_action",function(){return _this5._mergeAction()},function(){return Icons.People}).setType(ButtonType.Dropdown)])},250).setColors(ButtonColors.Nav)}},{key:"_vcardButtons",value:function(){var _this6=this;return isApp()?[]:[new Button("importVCard_action",function(){return _this6._importAsVCard()},function(){return Icons.ContactImport}).setType(ButtonType.Dropdown),new Button("exportVCard_action",function(){return exportAsVCard()},function(){return Icons.Export}).setType(ButtonType.Dropdown)]}},{key:"_importAsVCard",value:function(){fileController.showFileChooser(!0,["vcf"]).then(function(contactFiles){try{if(contactFiles.length>0){var vCardsList=contactFiles.map(function(contactFile){var vCardFileData=utf8Uint8ArrayToString(contactFile.data),vCards=vCardFileToVCards(vCardFileData);if(null==vCards)throw new Error("no vcards found");return vCards});return showProgressDialog("pleaseWait_msg",Promise.resolve().then(function(){var flatvCards=vCardsList.reduce(function(sum,value){return sum.concat(value)},[]),contactList=vCardListToContacts(flatvCards,neverNull(logins.getUserController().user.memberships.find(function(m){return m.groupType===GroupType.Contact})).group);return LazyContactListId.getAsync().then(function(contactListId){var promises=[];return contactList.forEach(function(contact){promises.push(setup(contactListId,contact))}),Promise.all(promises).then(function(){return promises.length})})}))}}catch(e){console.log(e),Dialog.error("importVCardError_msg")}}).then(function(numberOfContacts){numberOfContacts&&Dialog.error(function(){return lang.get("importVCardSuccess_msg",{"{1}":numberOfContacts})})})}},{key:"_mergeAction",value:function(){var _this7=this;return showProgressDialog("pleaseWait_msg",LazyContactListId.getAsync().then(function(contactListId){return loadAll(ContactTypeRef,contactListId)})).then(function(allContacts){if(0===allContacts.length)Dialog.error("noContacts_msg");else{var mergeableAndDuplicates=getMergeableContacts(allContacts),deletePromise=Promise.resolve();mergeableAndDuplicates.deletable.length>0&&(deletePromise=Dialog.confirm(function(){return lang.get("duplicatesNotification_msg",{"{1}":mergeableAndDuplicates.deletable.length})}).then(function(confirmed){confirmed&&mergeableAndDuplicates.deletable.forEach(function(dc){erase(dc)})})),deletePromise.then(function(){0===mergeableAndDuplicates.mergeable.length?Dialog.error(function(){return lang.get("noSimilarContacts_msg")}):_this7._showMergeDialogs(mergeableAndDuplicates.mergeable).then(function(canceled){canceled||Dialog.error(function(){return lang.get("noMoreSimilarContacts_msg")})})})}})}},{key:"_showMergeDialogs",value:function(mergable){var _this8=this,canceled=!1;if(mergable.length>0){var contact1=mergable[0][0],contact2=mergable[0][1];return new ContactMergeView(contact1,contact2).show().then(function(action){return action===ContactMergeAction.Merge?(_this8._removeFromMergableContacts(mergable,contact2),mergeContacts(contact1,contact2),showProgressDialog("pleaseWait_msg",update(contact1).then(function(){return erase(contact2)})).catch(NotFoundError,noOp)):action===ContactMergeAction.DeleteFirst?(_this8._removeFromMergableContacts(mergable,contact1),erase(contact1)):action===ContactMergeAction.DeleteSecond?(_this8._removeFromMergableContacts(mergable,contact2),erase(contact2)):void(action===ContactMergeAction.Skip?_this8._removeFromMergableContacts(mergable,contact2):action===ContactMergeAction.Cancel&&(mergable.length=0,canceled=!0))}).then(function(){return!canceled&&mergable.length>0?_this8._showMergeDialogs(mergable):canceled})}return Promise.resolve(canceled)}},{key:"_removeFromMergableContacts",value:function(mergable,contact){mergable[0][0]===contact?mergable[0].splice(0,1):mergable[0][1]===contact&&mergable[0].splice(1,1),mergable[0].length<=1&&mergable.splice(0,1)}},{key:"updateUrl",value:function(args){var _this9=this;this._contactList||args.listId?!this._contactList&&args.listId?LazyContactListId.getAsync().then(function(contactListId){args.listId!==contactListId?_this9._setUrl("/contact/"+contactListId):(_this9._contactList=new ContactListView(args.listId,_this9),_this9._contactList.list.loadInitial(args.contactId))}).then(m.redraw):this._contactList&&args.listId===this._contactList.listId&&args.contactId&&!this._contactList.list.isEntitySelected(args.contactId)&&this._contactList.list.scrollToIdAndSelect(args.contactId):LazyContactListId.getAsync().then(function(contactListId){_this9._setUrl("/contact/"+contactListId)})}},{key:"_setUrl",value:function(url){navButtonRoutes.contactsUrl=url,m.route.get().startsWith("/contact")&&this._throttledSetUrl(url)}},{key:"_deleteSelected",value:function(){var _this10=this;return Dialog.confirm("deleteContacts_msg").then(function(confirmed){confirmed&&_this10._contactList.list.getSelectedEntities().forEach(function(contact){erase(contact).catch(NotFoundError,function(e){})})})}},{key:"mergeSelected",value:function(){if(2===this._contactList.list.getSelectedEntities().length){var keptContact=this._contactList.list.getSelectedEntities()[0],goodbyeContact=this._contactList.list.getSelectedEntities()[1];return keptContact.presharedPassword&&goodbyeContact.presharedPassword&&keptContact.presharedPassword!==goodbyeContact.presharedPassword?Dialog.error("presharedPasswordsUnequal_msg"):Dialog.confirm("mergeAllSelectedContacts_msg").then(function(confirmed){if(confirmed)return mergeContacts(keptContact,goodbyeContact),showProgressDialog("pleaseWait_msg",update(keptContact).then(function(){return erase(goodbyeContact)})).catch(NotFoundError,noOp)})}return Promise.resolve()}},{key:"elementSelected",value:function(contacts,elementClicked,selectionChanged,multiSelectOperation){1!==contacts.length||multiSelectOperation?(this.contactViewer=null,this._setUrl("/contact/"+this._contactList.listId)):(this.contactViewer=new ContactViewer(contacts[0]),this._setUrl("/contact/"+contacts[0]._id.join("/")),elementClicked&&this.viewSlider.focus(this.contactColumn)),m.redraw()}},{key:"_processEntityUpdate",value:function(update){var _this11=this,instanceListId=update.instanceListId,instanceId=update.instanceId,operation=update.operation;isUpdateForTypeRef(ContactTypeRef,update)&&this._contactList&&instanceListId===this._contactList.listId&&this._contactList.list.entityEventReceived(instanceId,operation).then(function(){operation===OperationType.UPDATE&&_this11.contactViewer&&isSameId(_this11.contactViewer.contact._id,[neverNull(instanceListId),instanceId])&&load(ContactTypeRef,_this11.contactViewer.contact._id).then(function(updatedContact){_this11.contactViewer=new ContactViewer(updatedContact),m.redraw()})})}},{key:"getViewSlider",value:function(){return this.viewSlider}},{key:"headerView",value:function(){var _this12=this;return 1===this.viewSlider.getVisibleBackgroundColumns().length&&this._contactList&&this._contactList.list&&this._contactList.list.isMobileMultiSelectionActionActive()?m(MultiSelectionBar,{selectNoneHandler:function(){return _this12._contactList.list.selectNone()},selectedEntiesLength:this._contactList.list.getSelectedEntities().length,content:this._multiContactViewer.createActionBar(function(){return _this12._contactList.list.selectNone()},!0)}):null}}]),ContactView}()),_export("ContactView",ContactView)}}}),System.register("src/contacts/ContactListView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/List","../api/main/Entity","../api/entities/tutanota/Contact","./ContactView","../api/common/EntityFunctions","./ContactUtils","../api/Env","../misc/LanguageViewModel","../api/common/error/RestError","../gui/size"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,List,load,loadAll,ContactTypeRef,GENERATED_MAX_ID,compareContacts,LazyContactListId,getContactListName,assertMainOrNode,lang,NotFoundError,size,className,ContactListView,ContactRow;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseList){List=_guiBaseList.List},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll},function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_ContactView){_ContactView.ContactView},function(_apiCommonEntityFunctions){GENERATED_MAX_ID=_apiCommonEntityFunctions.GENERATED_MAX_ID},function(_ContactUtils){compareContacts=_ContactUtils.compareContacts,LazyContactListId=_ContactUtils.LazyContactListId,getContactListName=_ContactUtils.getContactListName},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiSize){size=_guiSize.size}],execute:function(){assertMainOrNode(),className="contact-list",_export("ContactListView",ContactListView=function(){function ContactListView(contactListId,contactView){var _this=this;_classCallCheck(this,ContactListView),this.listId=contactListId,this.contactView=contactView,this.list=new List({rowHeight:size.list_row_height,fetch:function(startId,count){if(startId===GENERATED_MAX_ID)return LazyContactListId.getAsync().then(function(contactListId){return loadAll(ContactTypeRef,contactListId).then(function(allContacts){return _this._setLoadedCompletely(),allContacts})});throw new Error("fetch contact called for specific start id")},loadSingle:function(elementId){return load(ContactTypeRef,[_this.listId,elementId]).catch(NotFoundError,function(e){})},sortCompare:compareContacts,elementSelected:function(entities,elementClicked,selectionChanged,multiSelectionActive){return contactView.elementSelected(entities,elementClicked,selectionChanged,multiSelectionActive)},createVirtualRow:function(){return new ContactRow},showStatus:!1,className:className,swipe:{renderLeftSpacer:function(){return[]},renderRightSpacer:function(){return[]},swipeLeft:function(listElement){return Promise.resolve()},swipeRight:function(listElement){return Promise.resolve()},enabled:!1},elementsDraggable:!0,multiSelectionAllowed:!0,emptyMessage:lang.get("noContacts_msg")}),this.view=function(){return m(_this.list)}}return _createClass(ContactListView,[{key:"_setLoadedCompletely",value:function(){this.list.setLoadedCompletely()}}]),ContactListView}()),_export("ContactListView",ContactListView),_export("ContactRow",ContactRow=function(){function ContactRow(){_classCallCheck(this,ContactRow),this.top=0,this.entity=null}return _createClass(ContactRow,[{key:"update",value:function(contact,selected){this.domElement&&(selected?this.domElement.classList.add("row-selected"):this.domElement.classList.remove("row-selected"),this._domName.textContent=getContactListName(contact),this._domAddress.textContent=contact.mailAddresses&&contact.mailAddresses.length>0?contact.mailAddresses[0].address:"")}},{key:"render",value:function(){var _this2=this;return[m(".top",[m(".name.text-ellipsis",{oncreate:function(vnode){return _this2._domName=vnode.dom}})]),m(".bottom.flex-space-between",[m("small.mail-address",{oncreate:function(vnode){return _this2._domAddress=vnode.dom}})])]}}]),ContactRow}()),_export("ContactRow",ContactRow)}}}),System.register("src/search/SearchListView.js",["node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","mithril","../gui/base/List","../api/common/EntityFunctions","../api/Env","../misc/LanguageViewModel","../gui/size","../mail/MailListView","../api/entities/tutanota/Mail","../api/main/Entity","../contacts/ContactListView","../api/entities/tutanota/Contact","../api/common/error/RestError","../api/main/MainLocator","../contacts/ContactUtils","../api/common/utils/Utils","../api/main/WorkerClient","../api/main/LoginController","./SearchModel","../mail/MailUtils","../mail/MailModel","../gui/base/Dialog"],function(_export,_context){"use strict";var _createClass,_classCallCheck,m,List,GENERATED_MAX_ID,isSameId,isSameTypeRef,sortCompareByReverseId,assertMainOrNode,lang,size,MailRow,MailTypeRef,erase,load,ContactRow,ContactTypeRef,NotFoundError,locator,compareContacts,defer,neverNull,worker,logins,hasMoreResults,archiveMails,moveToInbox,showDeleteConfirmationDialog,mailModel,Dialog,SearchResultListEntry,SearchListView,SearchResultListRow;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_mithril){m=_mithril.default},function(_guiBaseList){List=_guiBaseList.List},function(_apiCommonEntityFunctions){GENERATED_MAX_ID=_apiCommonEntityFunctions.GENERATED_MAX_ID,isSameId=_apiCommonEntityFunctions.isSameId,isSameTypeRef=_apiCommonEntityFunctions.isSameTypeRef,sortCompareByReverseId=_apiCommonEntityFunctions.sortCompareByReverseId,_apiCommonEntityFunctions.TypeRef},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiSize){size=_guiSize.size},function(_mailMailListView){MailRow=_mailMailListView.MailRow},function(_apiEntitiesTutanotaMail){MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_apiMainEntity){erase=_apiMainEntity.erase,load=_apiMainEntity.load},function(_contactsContactListView){ContactRow=_contactsContactListView.ContactRow},function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_contactsContactUtils){compareContacts=_contactsContactUtils.compareContacts},function(_apiCommonUtilsUtils){defer=_apiCommonUtilsUtils.defer,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_SearchModel){hasMoreResults=_SearchModel.hasMoreResults},function(_mailMailUtils){archiveMails=_mailMailUtils.archiveMails,moveToInbox=_mailMailUtils.moveToInbox,showDeleteConfirmationDialog=_mailMailUtils.showDeleteConfirmationDialog},function(_mailMailModel){mailModel=_mailMailModel.mailModel},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog}],execute:function(){assertMainOrNode(),_export("SearchResultListEntry",SearchResultListEntry=function SearchResultListEntry(entry){_classCallCheck(this,SearchResultListEntry),this._id=entry._id,this.entry=entry}),_export("SearchResultListEntry",SearchResultListEntry),_export("SearchListView",SearchListView=function(){function SearchListView(searchView){var _this=this;_classCallCheck(this,SearchListView),this._searchView=searchView,this._lastType=MailTypeRef,this.oncreate=function(){_this.list=_this._createList(),locator.search.result()||_this._loadInitial(neverNull(_this.list)),_this._resultStreamDependency=locator.search.result.map(function(result){var oldResult=_this._searchResult;if(_this._searchResult=result,result)if(isSameTypeRef(_this._lastType,result.restriction.type)){if(_this.list){var _l=_this.list;_l.clear(),_this._loadInitial(_l)}}else{var _l2=_this._createList();_this.list=_l2,window.requestAnimationFrame(function(){m.redraw(),_this._loadInitial(_l2)})}else if(_this.list){var l=_this.list;oldResult&&oldResult.results.length>0&&l.clear(),l.displaySpinner(!0,!0)}})},this.view=function(){return _this.list?m(_this.list):null},this.onremove=function(){_this._resultStreamDependency&&_this._resultStreamDependency.end(!0)}}return _createClass(SearchListView,[{key:"_loadInitial",value:function(list){var selectedId=m.route.param("id");list.loadInitial(selectedId)}},{key:"isInSearchResult",value:function(typeRef,id){var result=this._searchResult;return!!(result&&isSameTypeRef(typeRef,result.restriction.type)&&result.results.find(function(r){return isSameId(r,id)}))}},{key:"_createList",value:function(){var _this2=this;return this._lastType="mail"===m.route.param("category")?MailTypeRef:ContactTypeRef,new List({rowHeight:size.list_row_height,fetch:function(startId,count){return locator.search.indexState().initializing?defer().promise:!_this2._searchResult||0===_this2._searchResult.results.length&&!hasMoreResults(_this2._searchResult)?Promise.resolve([]):_this2._loadSearchResults(_this2._searchResult,startId!==GENERATED_MAX_ID,startId,count).then(function(results){return results.map(function(instance){return new SearchResultListEntry(instance)})}).finally(m.redraw)},loadSingle:function(elementId){if(_this2._searchResult){var currentResult=_this2._searchResult,id=currentResult.results.find(function(r){return r[1]===elementId});return id?load(currentResult.restriction.type,id).then(function(entity){return new SearchResultListEntry(entity)}).catch(NotFoundError,function(e){return null}):Promise.resolve(null)}return Promise.resolve(null)},sortCompare:function(o1,o2){return isSameTypeRef(o1.entry._type,ContactTypeRef)?compareContacts(o1.entry,o2.entry):sortCompareByReverseId(o1.entry,o2.entry)},elementSelected:function(entities,elementClicked,selectionChanged,multiSelectionActive){_this2._searchView.elementSelected(entities,elementClicked,selectionChanged,multiSelectionActive)},createVirtualRow:function(){return new SearchResultListRow("mail"===m.route.param("category")?new MailRow(!0):new ContactRow)},showStatus:!1,className:"mail"===m.route.param("category")?"mail-list":"contact-list",swipe:{renderLeftSpacer:function(){return[]},renderRightSpacer:function(){return[]},swipeLeft:function(){return Promise.resolve()},swipeRight:function(){return Promise.resolve()},enabled:!1},elementsDraggable:!1,multiSelectionAllowed:!0,emptyMessage:lang.get("searchNoResults_msg")+"\n"+(logins.getUserController().isFreeAccount()?lang.get("goPremium_msg"):lang.get("switchSearchInMenu_label"))})}},{key:"_loadSearchResults",value:function(currentResult,getMoreFromSearch,startId,count){var _this3=this,mail=isSameTypeRef(currentResult.restriction.type,MailTypeRef),contact=isSameTypeRef(currentResult.restriction.type,ContactTypeRef);if(!isSameTypeRef(this._lastType,currentResult.restriction.type))return Promise.resolve([]);var loadingResultsPromise=Promise.resolve(currentResult);return getMoreFromSearch&&hasMoreResults(currentResult)&&(loadingResultsPromise=worker.getMoreSearchResults(currentResult,count)),loadingResultsPromise.then(function(moreResults){if(_this3._searchResult=moreResults,mail){var startIndex=0;if(startId!==GENERATED_MAX_ID){if(-1===(startIndex=moreResults.results.findIndex(function(id){return id[1]===startId})))throw new Error("start index not found");startIndex++}var toLoad=moreResults.results.slice(startIndex);return _this3._loadAndFilterInstances(currentResult.restriction.type,toLoad,moreResults,startIndex)}return contact?_this3._loadAndFilterInstances(currentResult.restriction.type,moreResults.results,moreResults,0).finally(function(){_this3.list&&_this3.list.setLoadedCompletely(),m.redraw()}):Promise.resolve([])}).then(function(results){return results.length<count&&hasMoreResults(neverNull(_this3._searchResult))?_this3._loadSearchResults(neverNull(_this3._searchResult),!0,startId,count):results})}},{key:"entityEventReceived",value:function(elementId,operation){return this.list?this.list.entityEventReceived(elementId,operation):Promise.resolve()}},{key:"_loadAndFilterInstances",value:function(type,toLoad,currentResult,startIndex){return Promise.map(toLoad,function(id){return load(type,id).catch(NotFoundError,function(){return console.log("mail not found")})},{concurrency:5}).then(function(sr){return sr.filter(function(r,index){return r||currentResult.results.splice(startIndex+index,1),r})})}},{key:"isEntitySelected",value:function(id){return!!this.list&&this.list.isEntitySelected(id)}},{key:"getSelectedEntities",value:function(){return this.list?this.list.getSelectedEntities():[]}},{key:"loading",value:function(){return this.list?this.list._loading:Promise.resolve()}},{key:"selectNext",value:function(shiftPressed){this.list&&this.list.selectNext(shiftPressed)}},{key:"selectPrevious",value:function(shiftPressed){this.list&&this.list.selectPrevious(shiftPressed)}},{key:"scrollToIdAndSelect",value:function(listElementId){return this.list?this.list.scrollToIdAndSelect(listElementId):Promise.resolve(null)}},{key:"selectNone",value:function(){this.list&&this.list.selectNone()}},{key:"isListAvailable",value:function(){return null!=this.list&&this.list.ready}},{key:"archiveSelected",value:function(){var selected=this.getSelectedEntities();if(selected.length>0&&isSameTypeRef(selected[0].entry._type,MailTypeRef)){var selectedMails=selected.map(function(m){return m.entry});selected.length>1&&this.selectNone(),archiveMails(selectedMails)}}},{key:"moveSelectedToInbox",value:function(){var selected=this.getSelectedEntities();if(selected.length>0&&isSameTypeRef(selected[0].entry._type,MailTypeRef)){var selectedMails=selected.map(function(m){return m.entry});selected.length>1&&this.selectNone(),moveToInbox(selectedMails)}}},{key:"deleteSelected",value:function(){var _this4=this,selected=this.getSelectedEntities();if(selected.length>0)if(isSameTypeRef(selected[0].entry._type,MailTypeRef)){var selectedMails=selected.map(function(m){return m.entry});showDeleteConfirmationDialog(selectedMails).then(function(confirmed){confirmed&&(selected.length>1&&_this4.selectNone(),mailModel.deleteMails(selectedMails))})}else if(isSameTypeRef(selected[0].entry._type,ContactTypeRef)){var selectedContacts=selected.map(function(m){return m.entry});Dialog.confirm("deleteContacts_msg").then(function(confirmed){confirmed&&(selected.length>1&&_this4.selectNone(),selectedContacts.forEach(function(c){return erase(c).catch(NotFoundError,function(e){})}))})}}}]),SearchListView}()),_export("SearchListView",SearchListView),_export("SearchResultListRow",SearchResultListRow=function(){function SearchResultListRow(delegate){_classCallCheck(this,SearchResultListRow),this._delegate=delegate,this.top=0,this.entity=null}return _createClass(SearchResultListRow,[{key:"update",value:function(entry,selected){this._delegate.domElement=this.domElement,this._delegate.update(entry.entry,selected)}},{key:"render",value:function(){return this._delegate.render()}}]),SearchResultListRow}()),_export("SearchResultListRow",SearchResultListRow)}}}),System.register("src/contacts/ContactMergeUtils.js",["../api/common/TutanotaConstants","../api/common/utils/Utils","./ContactUtils"],function(_export,_context){"use strict";var ContactComparisonResult,IndifferentContactComparisonResult,neverNull,oldBirthdayToBirthday,migrateToNewBirthday;function _compareContactsForMerge(contact1,contact2){var nameResult=_compareFullName(contact1,contact2),mailResult=_compareMailAddresses(contact1.mailAddresses,contact2.mailAddresses),phoneResult=_comparePhoneNumbers(contact1.phoneNumbers,contact2.phoneNumbers),birthdayResult=_compareBirthdays(contact1,contact2),residualContactFieldsEqual=_areResidualContactFieldsEqual(contact1,contact2);return birthdayResult===ContactComparisonResult.Unique||contact1.presharedPassword&&contact2.presharedPassword&&contact1.presharedPassword!==contact2.presharedPassword?ContactComparisonResult.Unique:nameResult!==ContactComparisonResult.Equal&&nameResult!==IndifferentContactComparisonResult.BothEmpty||mailResult!==ContactComparisonResult.Equal&&mailResult!==IndifferentContactComparisonResult.BothEmpty||phoneResult!==ContactComparisonResult.Equal&&phoneResult!==IndifferentContactComparisonResult.BothEmpty||!residualContactFieldsEqual?nameResult===ContactComparisonResult.Equal||nameResult===ContactComparisonResult.Similar?ContactComparisonResult.Similar:nameResult!==IndifferentContactComparisonResult.BothEmpty&&nameResult!==IndifferentContactComparisonResult.OneEmpty||mailResult!==ContactComparisonResult.Similar&&phoneResult!==ContactComparisonResult.Similar&&mailResult!==ContactComparisonResult.Equal&&phoneResult!==ContactComparisonResult.Equal?ContactComparisonResult.Unique:ContactComparisonResult.Similar:birthdayResult===IndifferentContactComparisonResult.BothEmpty||birthdayResult===ContactComparisonResult.Equal?ContactComparisonResult.Equal:ContactComparisonResult.Similar}function _compareFullName(contact1,contact2){return contact1.firstName===contact2.firstName&&contact1.lastName===contact2.lastName&&(contact1.lastName||contact1.firstName)?ContactComparisonResult.Equal:contact1.firstName||contact1.lastName||contact2.firstName||contact2.lastName?!contact1.firstName&&!contact1.lastName||!contact2.firstName&&!contact2.lastName?IndifferentContactComparisonResult.OneEmpty:contact1.firstName.toLowerCase()===contact2.firstName.toLowerCase()&&contact1.lastName.toLowerCase()===contact2.lastName.toLowerCase()&&contact1.lastName?ContactComparisonResult.Similar:contact1.firstName&&contact2.firstName||contact1.lastName.toLowerCase()!==contact2.lastName.toLowerCase()||!contact1.lastName?ContactComparisonResult.Unique:ContactComparisonResult.Similar:IndifferentContactComparisonResult.BothEmpty}function _getMergedNameField(name1,name2){return name1||name2}function _compareMailAddresses(contact1MailAddresses,contact2MailAddresses){return _compareValues(contact1MailAddresses.map(function(m){return m.address}),contact2MailAddresses.map(function(m){return m.address}))}function _getMergedEmailAddresses(mailAddresses1,mailAddresses2){var filteredMailAddresses2=mailAddresses2.filter(function(ma2){return!mailAddresses1.find(function(ma1){return ma1.address.toLowerCase()===ma2.address.toLowerCase()})});return mailAddresses1.concat(filteredMailAddresses2)}function _comparePhoneNumbers(contact1PhoneNumbers,contact2PhoneNumbers){return _compareValues(contact1PhoneNumbers.map(function(m){return m.number}),contact2PhoneNumbers.map(function(m){return m.number}))}function _getMergedPhoneNumbers(phoneNumbers1,phoneNumbers2){var filteredNumbers2=phoneNumbers2.filter(function(ma2){return!phoneNumbers1.find(function(ma1){return ma1.number===ma2.number})});return phoneNumbers1.concat(filteredNumbers2)}function _areResidualContactFieldsEqual(contact1,contact2){return _isEqualOtherField(contact1.comment,contact2.comment)&&_isEqualOtherField(contact1.company,contact2.company)&&_isEqualOtherField(contact1.nickname,contact2.nickname)&&_isEqualOtherField(contact1.role,contact2.role)&&_isEqualOtherField(contact1.title,contact2.title)&&_isEqualOtherField(contact1.presharedPassword,contact2.presharedPassword)&&(contact1SocialIds=contact1.socialIds,contact2SocialIds=contact2.socialIds,(result=_compareValues(contact1SocialIds.map(function(m){return m.socialId}),contact2SocialIds.map(function(m){return m.socialId})))===IndifferentContactComparisonResult.BothEmpty||result===ContactComparisonResult.Equal)&&function(contact1Addresses,contact2Addresses){var result=_compareValues(contact1Addresses.map(function(m){return m.address}),contact2Addresses.map(function(m){return m.address}));return result===IndifferentContactComparisonResult.BothEmpty||result===ContactComparisonResult.Equal}(contact1.addresses,contact2.addresses);var contact1SocialIds,contact2SocialIds,result}function _getMergedSocialIds(socialIds1,socialIds2){var filteredSocialIds2=socialIds2.filter(function(ma2){return!socialIds1.find(function(ma1){return ma1.socialId===ma2.socialId})});return socialIds1.concat(filteredSocialIds2)}function _getMergedAddresses(addresses1,addresses2){var filteredAddresses2=addresses2.filter(function(ma2){return!addresses1.find(function(ma1){return ma1.address===ma2.address})});return addresses1.concat(filteredAddresses2)}function _compareBirthdays(contact1,contact2){return migrateToNewBirthday(contact1),migrateToNewBirthday(contact2),contact1.birthday&&contact2.birthday?contact1.birthday.day===contact2.birthday.day&&contact1.birthday.month===contact2.birthday.month?contact1.birthday.year===contact2.birthday.year?ContactComparisonResult.Equal:contact1.birthday.year&&contact2.birthday.year&&contact1.birthday.year!==contact2.birthday.year?ContactComparisonResult.Unique:ContactComparisonResult.Similar:ContactComparisonResult.Unique:contact1.birthday&&!contact2.birthday||!contact1.birthday&&contact2.birthday?IndifferentContactComparisonResult.OneEmpty:IndifferentContactComparisonResult.BothEmpty}function _compareValues(values1,values2){if(0===values1.length&&0===values2.length)return IndifferentContactComparisonResult.BothEmpty;if(0===values1.length||0===values2.length)return IndifferentContactComparisonResult.OneEmpty;var equalAddresses=values2.filter(function(c2){return values1.find(function(c1){return c1.trim()===c2.trim()})});return values1.length===values2.length&&values1.length===equalAddresses.length?ContactComparisonResult.Equal:values2.filter(function(c2){return values1.find(function(c1){return c1.trim().toLowerCase()===c2.trim().toLowerCase()})}).length>0?ContactComparisonResult.Similar:ContactComparisonResult.Unique}function _isEqualOtherField(otherAttribute1,otherAttribute2){return null==otherAttribute1&&(otherAttribute1=""),null==otherAttribute2&&(otherAttribute2=""),otherAttribute1===otherAttribute2}function _getMergedOtherField(otherAttribute1,otherAttribute2,separator){return otherAttribute1===otherAttribute2?otherAttribute2:otherAttribute1&&otherAttribute2?otherAttribute1+separator+otherAttribute2:!otherAttribute1&&otherAttribute2?otherAttribute2:otherAttribute1}function _getMergedBirthdays(oldBirthday1,oldBirthday2,newBirthday1,newBirthday2){return newBirthday1&&newBirthday2?newBirthday1.year?{oldBDay:null,newBDay:newBirthday1}:newBirthday2.year?{oldBDay:null,newBDay:newBirthday2}:{oldBDay:null,newBDay:newBirthday1}:newBirthday1?{oldBDay:null,newBDay:newBirthday1}:newBirthday2?{oldBDay:null,newBDay:newBirthday2}:oldBirthday1?{oldBDay:null,newBDay:oldBirthdayToBirthday(oldBirthday1)}:oldBirthday2?{oldBDay:null,newBDay:oldBirthdayToBirthday(oldBirthday2)}:{oldBDay:null,newBDay:null}}return _export("getMergeableContacts",function(inputContacts){for(var mergableContacts=[],duplicateContacts=[],contacts=inputContacts.slice(),firstContactIndex=0;firstContactIndex<contacts.length-1;){var currentMergableContacts=[],firstContact=contacts[firstContactIndex];currentMergableContacts.push(firstContact);for(var secondContactIndex=firstContactIndex+1;secondContactIndex<contacts.length;){var secondContact=contacts[secondContactIndex];if(firstContact._id[1]!==secondContact._id[1]){for(var overallResult=ContactComparisonResult.Unique,i=0;i<currentMergableContacts.length;i++){var result=_compareContactsForMerge(currentMergableContacts[i],secondContact);if(result===ContactComparisonResult.Equal){overallResult=ContactComparisonResult.Equal;break}if(result!==ContactComparisonResult.Similar)break;overallResult=ContactComparisonResult.Similar}overallResult===ContactComparisonResult.Equal?(duplicateContacts.push(secondContact),contacts.splice(secondContactIndex,1)):overallResult===ContactComparisonResult.Similar?(currentMergableContacts.push(secondContact),contacts.splice(secondContactIndex,1)):secondContactIndex++}}currentMergableContacts.length>1&&mergableContacts.push(currentMergableContacts),firstContactIndex++}return{mergeable:mergableContacts,deletable:duplicateContacts}}),_export("mergeContacts",function(keptContact,eliminatedContact){keptContact.firstName=_getMergedNameField(keptContact.firstName,eliminatedContact.firstName),keptContact.lastName=_getMergedNameField(keptContact.lastName,eliminatedContact.lastName),keptContact.title=neverNull(_getMergedOtherField(keptContact.title,eliminatedContact.title,", ")),keptContact.comment=neverNull(_getMergedOtherField(keptContact.comment,eliminatedContact.comment,"\n\n")),keptContact.company=neverNull(_getMergedOtherField(keptContact.company,eliminatedContact.company,", ")),keptContact.nickname=_getMergedOtherField(keptContact.nickname,eliminatedContact.nickname,", "),keptContact.role=neverNull(_getMergedOtherField(keptContact.role,eliminatedContact.role,", "));var birthdays=_getMergedBirthdays(keptContact.oldBirthday,eliminatedContact.oldBirthday,keptContact.birthday,eliminatedContact.birthday);keptContact.oldBirthday=birthdays.oldBDay,keptContact.birthday=birthdays.newBDay,keptContact.mailAddresses=_getMergedEmailAddresses(keptContact.mailAddresses,eliminatedContact.mailAddresses),keptContact.phoneNumbers=_getMergedPhoneNumbers(keptContact.phoneNumbers,eliminatedContact.phoneNumbers),keptContact.socialIds=_getMergedSocialIds(keptContact.socialIds,eliminatedContact.socialIds),keptContact.addresses=_getMergedAddresses(keptContact.addresses,eliminatedContact.addresses),keptContact.presharedPassword=neverNull(_getMergedOtherField(keptContact.presharedPassword,eliminatedContact.presharedPassword,""))}),_export("_compareContactsForMerge",_compareContactsForMerge),_export("_compareFullName",_compareFullName),_export("_getMergedNameField",_getMergedNameField),_export("_compareMailAddresses",_compareMailAddresses),_export("_getMergedEmailAddresses",_getMergedEmailAddresses),_export("_comparePhoneNumbers",_comparePhoneNumbers),_export("_getMergedPhoneNumbers",_getMergedPhoneNumbers),_export("_areResidualContactFieldsEqual",_areResidualContactFieldsEqual),_export("_getMergedSocialIds",_getMergedSocialIds),_export("_getMergedAddresses",_getMergedAddresses),_export("_compareBirthdays",_compareBirthdays),_export("_getMergedOtherField",_getMergedOtherField),_export("birthdayToOldBirthday",function(newBirthday){return new Date(Number(newBirthday.year),Number(newBirthday.month)-1,Number(newBirthday.day))}),_export("_getMergedBirthdays",_getMergedBirthdays),{setters:[function(_apiCommonTutanotaConstants){ContactComparisonResult=_apiCommonTutanotaConstants.ContactComparisonResult,IndifferentContactComparisonResult=_apiCommonTutanotaConstants.IndifferentContactComparisonResult},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_ContactUtils){oldBirthdayToBirthday=_ContactUtils.oldBirthdayToBirthday,migrateToNewBirthday=_ContactUtils.migrateToNewBirthday}],execute:function(){}}}),System.register("src/contacts/VCardExporter.js",["../api/entities/tutanota/Contact","../api/Env","../gui/base/ProgressDialog","../api/common/DataFile","../contacts/ContactUtils","../api/main/Entity","../gui/base/Dialog","../api/entities/tutanota/File","../api/common/utils/Encoding","../file/FileController","../api/common/utils/Utils","../misc/Formatter","../api/common/TutanotaConstants"],function(_export,_context){"use strict";var ContactTypeRef,assertMainOrNode,showProgressDialog,createDataFile,LazyContactListId,loadAll,Dialog,createFile,stringToUtf8Uint8Array,fileController,neverNull,formatSortableDate,ContactAddressType,ContactPhoneNumberType;function exportContacts(contacts){var vCardFile=contactsToVCard(contacts),data=stringToUtf8Uint8Array(vCardFile),tmpFile=createFile();return tmpFile.name="vCard3.0.vcf",tmpFile.mimeType="vCard/rfc2426",tmpFile.size=String(data.byteLength),fileController.open(createDataFile(tmpFile,data))}function contactsToVCard(allContacts){var vCardFile="";return allContacts.forEach(function(contact){vCardFile+=_contactToVCard(contact)}),vCardFile}function _contactToVCard(contact){var contactToVCardString="BEGIN:VCARD\nVERSION:3.0\n",fnString="FN:";fnString+=contact.title?_getVCardEscaped(contact.title)+" ":"",fnString+=contact.firstName?_getVCardEscaped(contact.firstName)+" ":"",contactToVCardString+=_getFoldedString((fnString+=contact.lastName?_getVCardEscaped(contact.lastName):"").trim())+"\n";var nString="N:";if(nString+=contact.lastName?_getVCardEscaped(contact.lastName)+";":";",nString+=contact.firstName?_getVCardEscaped(contact.firstName)+";;":";;",contactToVCardString+=_getFoldedString(nString+=contact.title?_getVCardEscaped(contact.title)+";":";")+"\n",contactToVCardString+=contact.nickname?_getFoldedString("NICKNAME:"+_getVCardEscaped(contact.nickname))+"\n":"",contact.birthday){var day=Number(neverNull(contact.birthday).day),month=Number(neverNull(contact.birthday).month),year=neverNull(contact.birthday).year?Number(neverNull(neverNull(contact.birthday).year)):1111;contactToVCardString+="BDAY:"+formatSortableDate(new Date(year,month-1,day))+"\n"}else contact.oldBirthday&&(contactToVCardString+="BDAY:"+formatSortableDate(contact.oldBirthday)+"\n");return contactToVCardString+=_vCardFormatArrayToString(_addressesToVCardAddresses(contact.addresses),"ADR"),contactToVCardString+=_vCardFormatArrayToString(_addressesToVCardAddresses(contact.mailAddresses),"EMAIL"),contactToVCardString+=_vCardFormatArrayToString(_phoneNumbersToVCardPhoneNumbers(contact.phoneNumbers),"TEL"),contactToVCardString+=_vCardFormatArrayToString(_socialIdsToVCardSocialUrls(contact.socialIds),"URL"),contactToVCardString+=contact.role?_getFoldedString("ROLE:"+_getVCardEscaped(contact.role))+"\n":"",contactToVCardString+=contact.company?_getFoldedString("ORG:"+_getVCardEscaped(contact.company))+"\n":"",contactToVCardString+=contact.comment?_getFoldedString("NOTE:"+_getVCardEscaped(contact.comment))+"\n":"",contactToVCardString+="END:VCARD\n\n"}function _addressesToVCardAddresses(addresses){return addresses.map(function(ad){var kind="";switch(ad.type){case ContactAddressType.PRIVATE:kind="home";break;case ContactAddressType.WORK:kind="work"}return{KIND:kind,CONTENT:ad.address}})}function _phoneNumbersToVCardPhoneNumbers(numbers){return numbers.map(function(num){var kind="";switch(num.type){case ContactPhoneNumberType.PRIVATE:kind="home";break;case ContactPhoneNumberType.WORK:kind="work";break;case ContactPhoneNumberType.MOBILE:kind="cell";break;case ContactPhoneNumberType.FAX:kind="fax"}return{KIND:kind,CONTENT:num.number}})}function _socialIdsToVCardSocialUrls(socialIds){return socialIds.map(function(sId){return{KIND:"",CONTENT:sId.socialId}})}function _vCardFormatArrayToString(typeAndContentArray,tagContent){return typeAndContentArray.reduce(function(result,elem){return elem.KIND?result+_getFoldedString(tagContent+";TYPE="+elem.KIND+":"+_getVCardEscaped(elem.CONTENT))+"\n":result+_getFoldedString(tagContent+":"+_getVCardEscaped(elem.CONTENT))+"\n"},"")}function _getFoldedString(text){for(var separateLinesArray=[];text.length>75;)separateLinesArray.push(text.substring(0,75)),text=text.substring(75,text.length);return separateLinesArray.push(text),text=separateLinesArray.join("\n ")}function _getVCardEscaped(content){return content=(content=(content=(content=content.replace(/\n/g,"\\n")).replace(/;/g,"\\;")).replace(/:/g,"\\:")).replace(/,/g,"\\,")}return _export("exportAsVCard",function(){return showProgressDialog("pleaseWait_msg",LazyContactListId.getAsync().then(function(contactListId){return loadAll(ContactTypeRef,contactListId).then(function(allContacts){return 0===allContacts.length?0:exportContacts(allContacts).return(allContacts.length)})})).then(function(nbrOfContacts){0===nbrOfContacts&&Dialog.error("noContacts_msg")})}),_export("exportContacts",exportContacts),_export("contactsToVCard",contactsToVCard),_export("_contactToVCard",_contactToVCard),_export("_addressesToVCardAddresses",_addressesToVCardAddresses),_export("_phoneNumbersToVCardPhoneNumbers",_phoneNumbersToVCardPhoneNumbers),_export("_socialIdsToVCardSocialUrls",_socialIdsToVCardSocialUrls),_export("_vCardFormatArrayToString",_vCardFormatArrayToString),{setters:[function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiCommonDataFile){createDataFile=_apiCommonDataFile.createDataFile},function(_contactsContactUtils){LazyContactListId=_contactsContactUtils.LazyContactListId},function(_apiMainEntity){loadAll=_apiMainEntity.loadAll},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiEntitiesTutanotaFile){createFile=_apiEntitiesTutanotaFile.createFile},function(_apiCommonUtilsEncoding){stringToUtf8Uint8Array=_apiCommonUtilsEncoding.stringToUtf8Uint8Array},function(_fileFileController){fileController=_fileFileController.fileController},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_miscFormatter){formatSortableDate=_miscFormatter.formatSortableDate},function(_apiCommonTutanotaConstants){ContactAddressType=_apiCommonTutanotaConstants.ContactAddressType,ContactPhoneNumberType=_apiCommonTutanotaConstants.ContactPhoneNumberType}],execute:function(){assertMainOrNode()}}}),System.register("src/search/MultiSearchViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../gui/base/ActionBar","../gui/base/icons/Icons","../gui/base/Button","../misc/LanguageViewModel","../gui/base/ColumnEmptyMessageBox","./SearchListView","../api/main/Entity","../mail/MailModel","../api/common/error/RestError","../api/common/EntityFunctions","../api/entities/tutanota/Contact","../gui/base/Dialog","../api/entities/tutanota/Mail","../mail/MailUtils","../gui/base/ProgressDialog","../contacts/ContactMergeUtils","../api/main/LoginController","../api/common/TutanotaConstants","../mail/Exporter","../api/entities/tutanota/MailBody","../misc/HtmlSanitizer","../api/common/utils/ArrayUtils","../contacts/VCardExporter","../api/common/utils/Utils","../gui/base/ButtonN","../gui/theme","../gui/base/icons/BootIcons"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,Mode,ActionBar,Icons,Button,createAsyncDropDownButton,createDropDownButton,lang,ColumnEmptyMessageBox,erase,load,update,mailModel,NotFoundError,getListId,isSameTypeRef,ContactTypeRef,Dialog,MailTypeRef,getFolderIcon,getFolderName,getSortedCustomFolders,getSortedSystemFolders,showProgressDialog,mergeContacts,logins,FeatureType,exportAsEml,MailBodyTypeRef,htmlSanitizer,groupBy,exportContacts,getMailBodyText,lazyMemoized,noOp,ButtonType,theme,BootIcons,MultiSearchViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,Mode=_apiEnv.Mode},function(_guiBaseActionBar){ActionBar=_guiBaseActionBar.ActionBar},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseButton){Button=_guiBaseButton.Button,createAsyncDropDownButton=_guiBaseButton.createAsyncDropDownButton,createDropDownButton=_guiBaseButton.createDropDownButton},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseColumnEmptyMessageBox){ColumnEmptyMessageBox=_guiBaseColumnEmptyMessageBox.default},function(_SearchListView){_SearchListView.SearchListView},function(_apiMainEntity){erase=_apiMainEntity.erase,load=_apiMainEntity.load,update=_apiMainEntity.update},function(_mailMailModel){mailModel=_mailMailModel.mailModel},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_apiCommonEntityFunctions){getListId=_apiCommonEntityFunctions.getListId,isSameTypeRef=_apiCommonEntityFunctions.isSameTypeRef},function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiEntitiesTutanotaMail){MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_mailMailUtils){getFolderIcon=_mailMailUtils.getFolderIcon,getFolderName=_mailMailUtils.getFolderName,getSortedCustomFolders=_mailMailUtils.getSortedCustomFolders,getSortedSystemFolders=_mailMailUtils.getSortedSystemFolders},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_contactsContactMergeUtils){mergeContacts=_contactsContactMergeUtils.mergeContacts},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonTutanotaConstants){FeatureType=_apiCommonTutanotaConstants.FeatureType},function(_mailExporter){exportAsEml=_mailExporter.exportAsEml},function(_apiEntitiesTutanotaMailBody){MailBodyTypeRef=_apiEntitiesTutanotaMailBody.MailBodyTypeRef},function(_miscHtmlSanitizer){htmlSanitizer=_miscHtmlSanitizer.htmlSanitizer},function(_apiCommonUtilsArrayUtils){groupBy=_apiCommonUtilsArrayUtils.groupBy},function(_contactsVCardExporter){exportContacts=_contactsVCardExporter.exportContacts},function(_apiCommonUtilsUtils){getMailBodyText=_apiCommonUtilsUtils.getMailBodyText,lazyMemoized=_apiCommonUtilsUtils.lazyMemoized,noOp=_apiCommonUtilsUtils.noOp},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType},function(_guiTheme){theme=_guiTheme.theme},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons}],execute:function(){assertMainOrNode(),_export("MultiSearchViewer",MultiSearchViewer=function(){function MultiSearchViewer(searchListView){var _this=this;_classCallCheck(this,MultiSearchViewer),this._mobileMailActionBar=lazyMemoized(function(){return _this.createMailActionBar(!1)}),this._mobileContactActionBar=lazyMemoized(function(){return _this.createContactActionBar(!1)});var mailActionBar=this.createMailActionBar(!0),contactActionBar=this.createContactActionBar(!0);this._searchListView=searchListView,this.view=function(){return _this._searchListView._lastType?_this._searchListView._lastType===MailTypeRef?_this._isMailList=!0:_this._isMailList=!1:console.log("ERROR LIST TYPE NOT FOUND"),[m(".fill-absolute.mt-xs.plr-l",_this._searchListView.list&&_this._searchListView.list._selectedEntities.length>0?[m(".button-height"),m(".flex-space-between",[m(".flex.items-center",_this._getSearchSelectionMessage(_this._searchListView)),m(_this._viewingMails()?mailActionBar:contactActionBar)])]:m(ColumnEmptyMessageBox,{message:function(){return _this._getSearchSelectionMessage(_this._searchListView)},color:theme.content_message_bg,icon:_this._isMailList?BootIcons.Mail:BootIcons.Contacts}))]}}return _createClass(MultiSearchViewer,[{key:"_getSearchSelectionMessage",value:function(searchListView){var nbrOfSelectedSearchEntities=searchListView.list?searchListView.list._selectedEntities.length:0;return this._isMailList?0===nbrOfSelectedSearchEntities?lang.get("noMail_msg"):1===nbrOfSelectedSearchEntities?lang.get("oneMailSelected_msg"):lang.get("nbrOfMailsSelected_msg",{"{1}":nbrOfSelectedSearchEntities}):0===nbrOfSelectedSearchEntities?lang.get("noContact_msg"):1===nbrOfSelectedSearchEntities?lang.get("oneContactSelected_msg"):lang.get("nbrOfContactsSelected_msg",{"{1}":nbrOfSelectedSearchEntities})}},{key:"createContactActionBar",value:function(){var _this2=this,prependCancel=arguments.length>0&&void 0!==arguments[0]&&arguments[0],actionBar=new ActionBar;return prependCancel&&actionBar.add(new Button("cancel_action",function(){return _this2._searchListView.list?_this2._searchListView.list.selectNone():null},function(){return Icons.Cancel})),actionBar.add(new Button("delete_action",function(){_this2._searchListView.deleteSelected()},function(){return Icons.Trash})),actionBar.add(new Button("merge_action",function(){return _this2.mergeSelected()},function(){return Icons.People}).setIsVisibleHandler(function(){return 2===_this2._searchListView.getSelectedEntities().length})),actionBar.add(new Button("exportSelectedAsVCard_action",function(){var selected=_this2._searchListView.getSelectedEntities(),selectedContacts=[];selected.length>0&&isSameTypeRef(selected[0].entry._type,ContactTypeRef)&&selected.forEach(function(c){selectedContacts.push(c.entry)}),exportContacts(selectedContacts)},function(){return Icons.Export})),actionBar}},{key:"createMailActionBar",value:function(){var _this3=this,prependCancel=arguments.length>0&&void 0!==arguments[0]&&arguments[0],actionBar=new ActionBar;return prependCancel&&actionBar.add(new Button("cancel_action",function(){return _this3._searchListView.list?_this3._searchListView.list.selectNone():null},function(){return Icons.Cancel})),actionBar.add(new Button("delete_action",function(){_this3._searchListView.deleteSelected()},function(){return Icons.Trash})),actionBar.add(createAsyncDropDownButton("move_action",function(){return Icons.Folder},function(){var selected=_this3._searchListView.getSelectedEntities(),selectedMails=[];return selected.length>0&&isSameTypeRef(selected[0].entry._type,MailTypeRef)&&selected.forEach(function(m){selectedMails.push(m.entry)}),Promise.reduce(selectedMails,function(set,mail){return mailModel.getMailboxDetailsForMail(mail).then(function(mailBox){return set.indexOf(mailBox)<0&&set.push(mailBox),set})},[]).then(function(sourceMailboxes){return 1!==sourceMailboxes.length?[]:getSortedSystemFolders(sourceMailboxes[0].folders).concat(getSortedCustomFolders(sourceMailboxes[0].folders)).map(function(f){return new Button(function(){return getFolderName(f)},function(){var mailsGroupedByFolder=groupBy(selectedMails,getListId);_this3._searchListView.selectNone(),Promise.each(mailsGroupedByFolder.values(),function(mails){return mailModel.moveMails(mails,f)})},getFolderIcon(f)).setType(ButtonType.Dropdown)})})})),actionBar.add(createDropDownButton("more_label",function(){return Icons.More},function(){var moreButtons=[];return moreButtons.push(new Button("markUnread_action",_this3.getSelectedMails(function(mails){return _this3._markAll(mails,!0).then(_this3._searchListView.selectNone())}),function(){return Icons.NoEye}).setType(ButtonType.Dropdown)),moreButtons.push(new Button("markRead_action",_this3.getSelectedMails(function(mails){return _this3._markAll(mails,!1).then(_this3._searchListView.selectNone())}),function(){return Icons.Eye}).setType(ButtonType.Dropdown)),env.mode===Mode.App||logins.isEnabled(FeatureType.DisableMailExport)||moreButtons.push(new Button("export_action",_this3.getSelectedMails(function(mails){return _this3._exportAll(mails).then(_this3._searchListView.selectNone())}),function(){return Icons.Export}).setType(ButtonType.Dropdown)),moreButtons})),actionBar}},{key:"_exportAll",value:function(mails){return Promise.map(mails,function(mail){return load(MailBodyTypeRef,mail.body).then(function(body){return exportAsEml(mail,htmlSanitizer.sanitize(getMailBodyText(body),!1).text)})},{concurrency:5}).return()}},{key:"_markAll",value:function(mails,unread){return Promise.all(mails.map(function(mail){return mail.unread!==unread?(mail.unread=unread,update(mail).catch(NotFoundError,noOp)):Promise.resolve()})).return()}},{key:"mergeSelected",value:function(){var _this4=this;if(2===this._searchListView.getSelectedEntities().length){if(isSameTypeRef(this._searchListView.getSelectedEntities()[0].entry._type,ContactTypeRef)){var keptContact=this._searchListView.getSelectedEntities()[0].entry,goodbyeContact=this._searchListView.getSelectedEntities()[1].entry;return keptContact.presharedPassword&&goodbyeContact.presharedPassword&&keptContact.presharedPassword!==goodbyeContact.presharedPassword?Dialog.error("presharedPasswordsUnequal_msg"):Dialog.confirm("mergeAllSelectedContacts_msg").then(function(confirmed){if(confirmed)return mergeContacts(keptContact,goodbyeContact),showProgressDialog("pleaseWait_msg",update(keptContact).then(function(){return erase(goodbyeContact).catch(NotFoundError,noOp).then(function(){_this4._searchListView.selectNone()})}))})}return Promise.resolve()}return Promise.resolve()}},{key:"getSelectedMails",value:function(action){var _this5=this;return function(){var selected=_this5._searchListView.getSelectedEntities(),selectedMails=[];selected.length>0&&isSameTypeRef(selected[0].entry._type,MailTypeRef)&&selected.forEach(function(m){selectedMails.push(m.entry)}),action(selectedMails)}}},{key:"actionBar",value:function(){return this._viewingMails()?this._mobileMailActionBar():this._mobileContactActionBar()}},{key:"_viewingMails",value:function(){return"Mail"===this._searchListView._lastType.type}}]),MultiSearchViewer}()),_export("MultiSearchViewer",MultiSearchViewer)}}}),System.register("src/search/SearchResultDetailsViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./SearchListView","../api/common/EntityFunctions","../api/entities/tutanota/Mail","../api/common/error/RestError","../api/main/Entity","../mail/MailViewer","../contacts/ContactViewer","../gui/base/ColumnEmptyMessageBox","../api/entities/tutanota/Contact","../api/Env","./MultiSearchViewer","../gui/base/ActionBar","../gui/theme","../gui/base/icons/BootIcons"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,isSameId,isSameTypeRef,MailTypeRef,NotFoundError,update,MailViewer,ContactViewer,ColumnEmptyMessageBox,ContactTypeRef,assertMainOrNode,MultiSearchViewer,theme,BootIcons,SearchResultDetailsViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_SearchListView){_SearchListView.SearchListView,_SearchListView.SearchResultListEntry},function(_apiCommonEntityFunctions){isSameId=_apiCommonEntityFunctions.isSameId,isSameTypeRef=_apiCommonEntityFunctions.isSameTypeRef},function(_apiEntitiesTutanotaMail){MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_apiMainEntity){update=_apiMainEntity.update},function(_mailMailViewer){MailViewer=_mailMailViewer.MailViewer},function(_contactsContactViewer){ContactViewer=_contactsContactViewer.ContactViewer},function(_guiBaseColumnEmptyMessageBox){ColumnEmptyMessageBox=_guiBaseColumnEmptyMessageBox.default},function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_MultiSearchViewer){MultiSearchViewer=_MultiSearchViewer.MultiSearchViewer},function(_guiBaseActionBar){_guiBaseActionBar.ActionBar},function(_guiTheme){theme=_guiTheme.theme},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons}],execute:function(){assertMainOrNode(),_export("SearchResultDetailsViewer",SearchResultDetailsViewer=function(){function SearchResultDetailsViewer(list){_classCallCheck(this,SearchResultDetailsViewer),this._listView=list,this._viewer=null,this._viewerEntityId=null,this._multiSearchViewer=new MultiSearchViewer(list)}return _createClass(SearchResultDetailsViewer,[{key:"view",value:function(){return 0===(this._listView.list?this._listView.list.getSelectedEntities():[]).length?m(".fill-absolute.mt-xs.plr-l",m(ColumnEmptyMessageBox,{message:"noSelection_msg",color:theme.content_message_bg,icon:isSameTypeRef(this._listView._lastType,MailTypeRef)?BootIcons.Mail:BootIcons.Contacts})):this._viewer?m(this._viewer):null}},{key:"isShownEntity",value:function(id){return null!=this._viewerEntityId&&isSameId(id,this._viewerEntityId)}},{key:"showEntity",value:function(entity,entitySelected){if(isSameTypeRef(MailTypeRef,entity._type)){var mail=entity;this._viewer=new MailViewer(mail,!0),this._viewerEntityId=mail._id,entitySelected&&mail.unread&&!mail._errors&&(mail.unread=!1,update(mail).catch(NotFoundError,function(e){return console.log("could not set read flag as mail has been moved/deleted already",e)})),m.redraw()}if(isSameTypeRef(ContactTypeRef,entity._type)){var contact=entity;this._viewer=new ContactViewer(contact),this._viewerEntityId=contact._id,m.redraw()}}},{key:"elementSelected",value:function(entries,elementClicked,selectionChanged,multiSelectOperation){1!==entries.length||multiSelectOperation||!selectionChanged&&this._viewer&&this._viewer!=this._multiSearchViewer?selectionChanged&&(0===entries.length||multiSelectOperation)?(0==entries.length?(this._viewer=null,this._viewerEntityId=null):this._viewer=this._multiSearchViewer,m.redraw()):selectionChanged&&m.redraw():this.showEntity(entries[0].entry,!0)}},{key:"multiSearchActionBar",value:function(){return this._multiSearchViewer.actionBar()}}]),SearchResultDetailsViewer}()),_export("SearchResultDetailsViewer",SearchResultDetailsViewer)}}}),System.register("src/gui/base/DatePickerDialog.js",["mithril","../../api/Env","./Dialog","../../misc/LanguageViewModel","./DatePicker","../size","../../misc/ClientDetector"],function(_export,_context){"use strict";var m,assertMainOrNode,Dialog,DialogType,lang,DatePicker,px,client;return _export("showDatePickerDialog",function(startOfTheWeekOffset,start,end){var dateStart=new DatePicker(startOfTheWeekOffset,"dateFrom_label","unlimited_label");start&&dateStart.setDate(start);var dateEnd=new DatePicker(startOfTheWeekOffset,"dateTo_label","unlimited_label");end&&dateEnd.setDate(end);var form={view:function(){return m(".flex-space-between",client.isDesktopDevice()?{style:{height:px(305)}}:{},[m(".pr-s.flex-grow.max-width-200.flex-space-between.flex-column",m(dateStart)),m(".pl-s.flex-grow.max-width-200.flex-space-between.flex-column",m(dateEnd))])}};return Promise.fromCallback(function(cb){var dialog=Dialog.showActionDialog({title:lang.get("selectPeriodOfTime_label"),child:form,allowOkWithReturn:!0,okAction:function(){return requestAnimationFrame(function(){var start=dateStart.invalidDate?null:dateStart.date(),end=dateEnd.invalidDate?null:dateEnd.date();start&&end&&start.getTime()>end.getTime()?Dialog.error("startAfterEnd_label"):(dialog.close(),cb(null,{start:start,end:end}))})},type:DialogType.EditMedium})})}),{setters:[function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_Dialog){Dialog=_Dialog.Dialog,DialogType=_Dialog.DialogType},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_DatePicker){DatePicker=_DatePicker.DatePicker},function(_size){px=_size.px},function(_miscClientDetector){client=_miscClientDetector.client}],execute:function(){assertMainOrNode()}}}),System.register("src/search/SearchView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/ViewSlider","../gui/base/ViewColumn","../api/common/EntityFunctions","../misc/LanguageViewModel","../api/common/TutanotaConstants","mithril/stream/stream.js","../api/Env","../misc/KeyManager","../gui/base/NavButtonN","../gui/theme","../gui/base/icons/BootIcons","../api/entities/tutanota/Contact","./SearchListView","../gui/size","./SearchResultDetailsViewer","./SearchUtils","../api/entities/tutanota/Mail","../gui/base/Dialog","../api/main/Entity","../mail/MailModel","../api/main/MainLocator","../gui/base/DropDownSelector","../search/SearchUtils","../mail/MailUtils","../api/common/utils/Utils","../misc/Formatter","../gui/base/TextField","../gui/base/Button","../gui/base/DatePickerDialog","../gui/base/icons/Icons","../api/common/utils/DateUtils","../api/main/LoginController","../misc/ErrorHandlerImpl","../gui/base/List","../gui/base/MultiSelectionBar","../gui/base/Header","../api/main/EventController","../api/main/WorkerClient","../calendar/CalendarUtils","../gui/base/ButtonN","../api/common/error/PermissionError","../mail/MailEditor","../contacts/ContactEditor","../contacts/ContactUtils","../gui/styles","../mail/MailView","../gui/base/FolderColumnView"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,ViewSlider,ColumnType,ViewColumn,isSameTypeRef,TypeRef,lang,FeatureType,FULL_INDEXED_TIMESTAMP,Keys,MailFolderType,NOTHING_INDEXED_TIMESTAMP,OperationType,stream,assertMainOrNode,keyManager,isNavButtonSelected,NavButtonColors,NavButtonN,theme,BootIcons,ContactTypeRef,SearchListView,px,size,SearchResultDetailsViewer,createRestriction,getFreeSearchStartDate,getRestriction,getSearchUrl,setSearchUrl,MailTypeRef,Dialog,load,mailModel,locator,DropDownSelector,SEARCH_CATEGORIES,SEARCH_MAIL_FIELDS,getFolderName,getSortedCustomFolders,getSortedSystemFolders,getGroupInfoDisplayName,neverNull,noOp,formatDateWithMonth,formatDateWithTimeIfNotEven,TextField,Button,showDatePickerDialog,Icons,getEndOfDay,getStartOfDay,isSameDay,isToday,logins,showNotAvailableForFreeDialog,PageSize,MultiSelectionBar,header,isUpdateForTypeRef,worker,getStartOfTheWeekOffsetForUser,ButtonColors,ButtonN,ButtonType,PermissionError,newMail,ContactEditor,LazyContactListId,styles,isNewMailActionAvailable,FolderColumnView,SearchView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseViewSlider){ViewSlider=_guiBaseViewSlider.ViewSlider},function(_guiBaseViewColumn){ColumnType=_guiBaseViewColumn.ColumnType,ViewColumn=_guiBaseViewColumn.ViewColumn},function(_apiCommonEntityFunctions){isSameTypeRef=_apiCommonEntityFunctions.isSameTypeRef,TypeRef=_apiCommonEntityFunctions.TypeRef},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonTutanotaConstants){FeatureType=_apiCommonTutanotaConstants.FeatureType,FULL_INDEXED_TIMESTAMP=_apiCommonTutanotaConstants.FULL_INDEXED_TIMESTAMP,Keys=_apiCommonTutanotaConstants.Keys,MailFolderType=_apiCommonTutanotaConstants.MailFolderType,NOTHING_INDEXED_TIMESTAMP=_apiCommonTutanotaConstants.NOTHING_INDEXED_TIMESTAMP,OperationType=_apiCommonTutanotaConstants.OperationType},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscKeyManager){keyManager=_miscKeyManager.keyManager},function(_guiBaseNavButtonN){isNavButtonSelected=_guiBaseNavButtonN.isNavButtonSelected,NavButtonColors=_guiBaseNavButtonN.NavButtonColors,NavButtonN=_guiBaseNavButtonN.NavButtonN},function(_guiTheme){theme=_guiTheme.theme},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_SearchListView){SearchListView=_SearchListView.SearchListView,_SearchListView.SearchResultListEntry},function(_guiSize){px=_guiSize.px,size=_guiSize.size},function(_SearchResultDetailsViewer){SearchResultDetailsViewer=_SearchResultDetailsViewer.SearchResultDetailsViewer},function(_SearchUtils){createRestriction=_SearchUtils.createRestriction,getFreeSearchStartDate=_SearchUtils.getFreeSearchStartDate,getRestriction=_SearchUtils.getRestriction,getSearchUrl=_SearchUtils.getSearchUrl,setSearchUrl=_SearchUtils.setSearchUrl},function(_apiEntitiesTutanotaMail){MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiMainEntity){load=_apiMainEntity.load},function(_mailMailModel){mailModel=_mailMailModel.mailModel},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_searchSearchUtils){SEARCH_CATEGORIES=_searchSearchUtils.SEARCH_CATEGORIES,SEARCH_MAIL_FIELDS=_searchSearchUtils.SEARCH_MAIL_FIELDS},function(_mailMailUtils){getFolderName=_mailMailUtils.getFolderName,getSortedCustomFolders=_mailMailUtils.getSortedCustomFolders,getSortedSystemFolders=_mailMailUtils.getSortedSystemFolders},function(_apiCommonUtilsUtils){getGroupInfoDisplayName=_apiCommonUtilsUtils.getGroupInfoDisplayName,neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_miscFormatter){formatDateWithMonth=_miscFormatter.formatDateWithMonth,formatDateWithTimeIfNotEven=_miscFormatter.formatDateWithTimeIfNotEven},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_guiBaseDatePickerDialog){showDatePickerDialog=_guiBaseDatePickerDialog.showDatePickerDialog},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiCommonUtilsDateUtils){getEndOfDay=_apiCommonUtilsDateUtils.getEndOfDay,getStartOfDay=_apiCommonUtilsDateUtils.getStartOfDay,isSameDay=_apiCommonUtilsDateUtils.isSameDay,isToday=_apiCommonUtilsDateUtils.isToday},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog},function(_guiBaseList){PageSize=_guiBaseList.PageSize},function(_guiBaseMultiSelectionBar){MultiSelectionBar=_guiBaseMultiSelectionBar.MultiSelectionBar},function(_guiBaseHeader){header=_guiBaseHeader.header},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_calendarCalendarUtils){getStartOfTheWeekOffsetForUser=_calendarCalendarUtils.getStartOfTheWeekOffsetForUser},function(_guiBaseButtonN){ButtonColors=_guiBaseButtonN.ButtonColors,ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_apiCommonErrorPermissionError){PermissionError=_apiCommonErrorPermissionError.PermissionError},function(_mailMailEditor){newMail=_mailMailEditor.newMail},function(_contactsContactEditor){ContactEditor=_contactsContactEditor.ContactEditor},function(_contactsContactUtils){LazyContactListId=_contactsContactUtils.LazyContactListId},function(_guiStyles){styles=_guiStyles.styles},function(_mailMailView){isNewMailActionAvailable=_mailMailView.isNewMailActionAvailable},function(_guiBaseFolderColumnView){FolderColumnView=_guiBaseFolderColumnView.FolderColumnView}],execute:function(){assertMainOrNode(),_export("SearchView",SearchView=function(){function SearchView(){var _this=this;_classCallCheck(this,SearchView),this._mailFolder={label:"emails_label",icon:function(){return BootIcons.Mail},href:function(){return _this._getCurrentSearchUrl("mail",null)},isSelectedPrefix:"/search/mail",colors:NavButtonColors.Nav},this._contactFolder={label:"contacts_label",icon:function(){return BootIcons.Contacts},href:"/search/contact",colors:NavButtonColors.Nav},this._endDate=null,this._startDate=null,this._time=new TextField("periodOfTime_label").setValue().setDisabled();var changeTimeButton=new Button("selectPeriodOfTime_label",function(){logins.getUserController().isFreeAccount()?showNotAvailableForFreeDialog(!0):showDatePickerDialog(getStartOfTheWeekOffsetForUser(),_this._startDate?_this._startDate:_this._getCurrentMailIndexDate(),_this._endDate?_this._endDate:new Date).then(function(dates){dates.end&&isToday(dates.end)?_this._endDate=null:_this._endDate=dates.end;var current=_this._getCurrentMailIndexDate();dates.start&&current&&isSameDay(current,neverNull(dates.start))?_this._startDate=null:_this._startDate=dates.start,_this._searchAgain()})},function(){return Icons.Edit});this._time._injectionsRight=function(){return[m(changeTimeButton)]};var mailAttributes=SEARCH_MAIL_FIELDS.map(function(f){return{name:lang.get(f.textId),value:f.field}});this._mailFieldSelection=new DropDownSelector("field_label",null,mailAttributes,stream(mailAttributes[0].value),250),this._doNotUpdateQuery=!0,this._mailFieldSelection.selectedValue.map(function(newValue){logins.getUserController().isFreeAccount()?null!=newValue&&(neverNull(_this._mailFieldSelection).selectedValue(null),showNotAvailableForFreeDialog(!0)):_this._searchAgain()}),this._doNotUpdateQuery=!1,mailModel.mailboxDetails.map(function(mailboxes){var mailFolders=[{name:lang.get("all_label"),value:null}];mailboxes.forEach(function(mailbox,mailboxIndex){getSortedSystemFolders(mailbox.folders).concat(getSortedCustomFolders(mailbox.folders)).forEach(function(folder){folder.folderType!==MailFolderType.SPAM&&mailFolders.push({name:getFolderName(folder)+(0===mailboxIndex?"":" ("+getGroupInfoDisplayName(mailbox.mailGroupInfo)+")"),value:folder.mails})})});var newSelection=_this._mailFolderSelection?_this._mailFolderSelection.selectedValue():mailFolders[0].value;mailFolders.find(function(f){return f.value===newSelection})||(newSelection=mailFolders[0].value),_this._mailFolderSelection=new DropDownSelector("mailFolder_label",null,mailFolders,stream(newSelection),250),_this._doNotUpdateQuery=!0,_this._mailFolderSelection.selectedValue.map(function(newValue){logins.getUserController().isFreeAccount()?null!=newValue&&(neverNull(_this._mailFolderSelection).selectedValue(null),showNotAvailableForFreeDialog(!0)):_this._searchAgain()}),_this._doNotUpdateQuery=!1}),this.folderColumn=new ViewColumn({view:function(){var restriction=getRestriction(m.route.get());return m(FolderColumnView,{button:_this.getMainButton(restriction.type),content:[m(".folder-row.flex-space-between.pt-s.plr-l",{style:{height:px(size.button_height)}},[m("small.b.align-self-center.ml-negative-xs",{style:{color:theme.navigation_button}},lang.get("search_label").toLocaleUpperCase())]),m(".folders",[m(".folder-row.plr-l",{class:isNavButtonSelected(_this._mailFolder)?"row-selected":""},m(NavButtonN,_this._mailFolder)),m(".folder-row.plr-l",{class:isNavButtonSelected(_this._contactFolder)?"row-selected":""},m(NavButtonN,_this._contactFolder))]),isNavButtonSelected(_this._mailFolder)?m("",[m(".folder-row.flex-space-between.pt-s.plr-l",{style:{height:px(size.button_height)}},[m("small.b.align-self-center.ml-negative-xs",{style:{color:theme.navigation_button}},lang.get("filter_label").toLocaleUpperCase())]),m(".plr-l.mt-negative-s",[m(_this._getUpdatedTimeField()),_this._mailFieldSelection?m(_this._mailFieldSelection):null,_this._mailFolderSelection?m(_this._mailFolderSelection):null])]):null],ariaLabel:"search_label"})}},ColumnType.Foreground,size.first_col_min_width,size.first_col_max_width,function(){return lang.get("search_label")}),this._searchList=new SearchListView(this),this.resultListColumn=new ViewColumn({view:function(){return m(".list-column",[m(_this._searchList)])}},ColumnType.Background,size.second_col_min_width,size.second_col_max_width,function(){return lang.get("searchResult_label")}),this._viewer=new SearchResultDetailsViewer(this._searchList),this.resultDetailsColumn=new ViewColumn({view:function(){return m(".search",m(_this._viewer))}},ColumnType.Background,size.third_col_min_width,size.third_col_max_width),this.viewSlider=new ViewSlider([this.folderColumn,this.resultListColumn,this.resultDetailsColumn],"ContactView"),this.view=function(){return m("#search.main-view",m(_this.viewSlider))},this._setupShortcuts(),locator.eventController.addEntityListener(function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var update=_step.value;_this.entityEventReceived(update)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}})}return _createClass(SearchView,[{key:"getViewSlider",value:function(){return this.viewSlider}},{key:"headerRightView",value:function(){var restriction=getRestriction(m.route.get());return styles.isUsingBottomNavigation()?isSameTypeRef(restriction.type,MailTypeRef)&&isNewMailActionAvailable()?m(ButtonN,{click:function(){mailModel.getUserMailboxDetails().then(newMail).catch(PermissionError,noOp)},label:"newMail_action",type:ButtonType.Action,colors:ButtonColors.Header,icon:function(){return Icons.PencilSquare}}):isSameTypeRef(restriction.type,ContactTypeRef)?m(ButtonN,{click:function(){LazyContactListId.getAsync().then(function(contactListId){new ContactEditor(null,contactListId,null).show()})},label:"newContact_action",type:ButtonType.Action,colors:ButtonColors.Header,icon:function(){return Icons.Add}}):null:null}},{key:"_getCurrentMailIndexDate",value:function(){var timestamp=locator.search.indexState().currentMailIndexTimestamp;return timestamp===FULL_INDEXED_TIMESTAMP?null:timestamp===NOTHING_INDEXED_TIMESTAMP?getEndOfDay(new Date):new Date(timestamp)}},{key:"_getUpdatedTimeField",value:function(){var end=void 0,start=void 0;if(logins.getUserController().isFreeAccount())end=lang.get("today_label"),start=formatDateWithMonth(getFreeSearchStartDate());else if(end=this._endDate?formatDateWithTimeIfNotEven(this._endDate):lang.get("today_label"),this._startDate)start=formatDateWithTimeIfNotEven(this._startDate);else{var currentIndexDate=this._getCurrentMailIndexDate();start=currentIndexDate?isSameDay(currentIndexDate,new Date)?lang.get("today_label"):formatDateWithTimeIfNotEven(currentIndexDate):lang.get("unlimited_label")}var text=start+" - "+end;return this._time.value()!==text&&this._time.setValue(text),this._time}},{key:"_searchAgain",value:function(){var _this2=this;if(!this._doNotUpdateQuery){var startDate=this._startDate;startDate&&startDate.getTime()<locator.search.indexState().currentMailIndexTimestamp?Dialog.confirm("continueSearchMailbox_msg","search_label").then(function(confirmed){confirmed&&worker.extendMailIndex(startDate.getTime()).then(function(){setSearchUrl(_this2._getCurrentSearchUrl(_this2._getCategory(),null))})}):setSearchUrl(this._getCurrentSearchUrl(this._getCategory(),null))}}},{key:"_getCurrentSearchUrl",value:function(searchCategory,selectedId){var restriction=createRestriction(searchCategory,this._endDate?getEndOfDay(this._endDate).getTime():null,this._startDate?getStartOfDay(this._startDate).getTime():null,this._mailFieldSelection&&this._mailFieldSelection.selectedValue(),this._mailFolderSelection&&this._mailFolderSelection.selectedValue());return getSearchUrl(locator.search.lastQuery(),restriction,selectedId)}},{key:"_setupShortcuts",value:function(){var _this3=this,shortcuts=[{key:Keys.UP,exec:function(){return _this3._searchList.selectPrevious(!1)},help:"selectPrevious_action"},{key:Keys.K,exec:function(){return _this3._searchList.selectPrevious(!1)},help:"selectPrevious_action"},{key:Keys.UP,shift:!0,exec:function(){return _this3._searchList.selectPrevious(!0)},help:"addPrevious_action"},{key:Keys.K,shift:!0,exec:function(){return _this3._searchList.selectPrevious(!0)},help:"addPrevious_action"},{key:Keys.DOWN,exec:function(){return _this3._searchList.selectNext(!1)},help:"selectNext_action"},{key:Keys.J,exec:function(){return _this3._searchList.selectNext(!1)},help:"selectNext_action"},{key:Keys.DOWN,shift:!0,exec:function(){return _this3._searchList.selectNext(!0)},help:"addNext_action"},{key:Keys.J,shift:!0,exec:function(){return _this3._searchList.selectNext(!0)},help:"addNext_action"},{key:Keys.N,exec:function(){var restriction=getRestriction(m.route.get()).type;isSameTypeRef(restriction,MailTypeRef)?mailModel.getUserMailboxDetails().then(newMail).catch(PermissionError,noOp):isSameTypeRef(restriction,ContactTypeRef)&&LazyContactListId.getAsync().then(function(contactListId){new ContactEditor(null,contactListId,null).show()})},enabled:function(){return logins.isInternalUserLoggedIn()&&!logins.isEnabled(FeatureType.ReplyOnly)},help:"newMail_action"},{key:Keys.DELETE,exec:function(){return _this3._searchList.deleteSelected()},help:"delete_action"},{key:Keys.A,exec:function(){return _this3._searchList.archiveSelected()},help:"archive_action"},{key:Keys.I,exec:function(){return _this3._searchList.moveSelectedToInbox()},help:"moveToInbox_action"}];this.oncreate=function(){keyManager.registerShortcuts(shortcuts),neverNull(header.searchBar).setReturnListener(function(){return _this3.resultListColumn.focus()})},this.onbeforeremove=function(){keyManager.unregisterShortcuts(shortcuts),neverNull(header.searchBar).setReturnListener(noOp)}}},{key:"elementSelected",value:function(entries,elementClicked,selectionChanged,multiSelectOperation){var _this4=this;this._viewer.elementSelected(entries,elementClicked,selectionChanged,multiSelectOperation),1!==entries.length||multiSelectOperation||!selectionChanged&&this._viewer._viewer||m.route.get().startsWith("/search")&&setSearchUrl(getSearchUrl(locator.search.lastQuery(),getRestriction(m.route.get()),entries[0]._id[1])),!multiSelectOperation&&elementClicked&&this._searchList.loading().then(function(){_this4.viewSlider.focus(_this4.resultDetailsColumn)})}},{key:"updateUrl",value:function(args,requestedPath){var restriction=void 0;try{restriction=getRestriction(requestedPath)}catch(e){return void setSearchUrl(getSearchUrl(args.query,createRestriction("mail")))}var lastQuery=locator.search.lastQuery(),maxResults=isSameTypeRef(MailTypeRef,restriction.type)?PageSize:null;args.hasOwnProperty("query")?locator.search.isNewSearch(args.query,restriction)&&locator.search.search(args.query,restriction,0,maxResults):lastQuery&&locator.search.isNewSearch(lastQuery,restriction)&&locator.search.search(lastQuery,restriction,0,maxResults),isSameTypeRef(restriction.type,MailTypeRef)&&(this._doNotUpdateQuery=!0,this._endDate=restriction.start?new Date(restriction.start):null,this._startDate=restriction.end?new Date(restriction.end):null,this._mailFolderSelection&&this._mailFolderSelection.selectedValue(restriction.listId),this._mailFieldSelection&&this._mailFieldSelection.selectedValue(restriction.field),this._doNotUpdateQuery=!1),args.id&&this._searchList.isListAvailable()&&!this._searchList.isEntitySelected(args.id)?this._searchList.scrollToIdAndSelect(args.id):!args.id&&this._searchList.isListAvailable()&&this._searchList.getSelectedEntities().length>0&&this._searchList.selectNone()}},{key:"_getCategory",value:function(){var restriction=getRestriction(m.route.get());return neverNull(SEARCH_CATEGORIES.find(function(c){return isSameTypeRef(c.typeRef,restriction.type)})).name}},{key:"entityEventReceived",value:function(update){var _this5=this;if(isUpdateForTypeRef(MailTypeRef,update)||isUpdateForTypeRef(ContactTypeRef,update)){var instanceListId=update.instanceListId,instanceId=update.instanceId,operation=update.operation,id=[neverNull(instanceListId),instanceId],typeRef=new TypeRef(update.application,update.type);this._searchList.isInSearchResult(typeRef,id)&&this._searchList.entityEventReceived(instanceId,operation).then(function(){operation===OperationType.UPDATE&&_this5._viewer&&_this5._viewer.isShownEntity(id)&&load(typeRef,id).then(function(updatedEntity){_this5._viewer.showEntity(updatedEntity,!1)}).catch(function(){})})}}},{key:"headerView",value:function(){var _this6=this;return 1===this.viewSlider.getVisibleBackgroundColumns().length&&this._searchList.list&&this._searchList.list.isMobileMultiSelectionActionActive()?m(MultiSelectionBar,{selectNoneHandler:function(){return _this6._searchList.selectNone()},selectedEntiesLength:this._searchList.getSelectedEntities().length,content:this._viewer.multiSearchActionBar()}):null}},{key:"getMainButton",value:function(typeRef){return styles.isUsingBottomNavigation()?null:isSameTypeRef(typeRef,MailTypeRef)&&isNewMailActionAvailable()?{click:function(){mailModel.getUserMailboxDetails().then(newMail).catch(PermissionError,noOp)},label:"newMail_action"}:isSameTypeRef(typeRef,ContactTypeRef)?{click:function(){LazyContactListId.getAsync().then(function(contactListId){new ContactEditor(null,contactListId,null).show()})},label:"newContact_action"}:null}}]),SearchView}()),_export("SearchView",SearchView)}}}),System.register("src/serviceworker/ServiceWorkerClient.js",["../api/Env","../gui/base/NotificationOverlay","../misc/LanguageViewModel","../misc/WindowFacade","../gui/base/ButtonN","mithril","../misc/ErrorHandler","../api/common/WorkerProtocol"],function(_export,_context){"use strict";var assertMainOrNodeBoot,isApp,isDesktop,isTutanotaDomain,notificationOverlay,lang,windowFacade,ButtonType,m,handleUncaughtError,objToError;function showUpdateMessageIfNeeded(registration){var onUpdate,notificationMessage;(registration.waiting||registration.installing)&&registration.active&&(onUpdate=function(){console.log("registration.waiting: ",registration.waiting),registration.waiting&&registration.waiting.postMessage("update")},notificationMessage={view:function(){return m("span",[lang.get("updateFound_label")," ",isTutanotaDomain()?m("a",{href:"https://github.com/tutao/tutanota/releases/",target:"_blank"},lang.get("releaseNotes_action")):null])}},notificationOverlay.show(notificationMessage,{label:"postpone_action"},[{label:"refresh_action",click:onUpdate,type:ButtonType.Primary}]))}return _export("init",function(){var serviceWorker=navigator.serviceWorker;if(serviceWorker){if(env.dist&&!isApp()&&!isDesktop()){console.log("Registering ServiceWorker");var location=window.location.pathname.endsWith("/")||-1!=window.location.pathname.indexOf("contactform/")?"../sw.js":"sw.js";serviceWorker.register(location).then(function(registration){console.log("ServiceWorker has been installed"),showUpdateMessageIfNeeded(registration),registration.addEventListener("updatefound",function(){console.log("updatefound"),showUpdateMessageIfNeeded(registration)});var active=registration.active,refreshing=!1;serviceWorker.addEventListener("controllerchange",function(e){console.log("controllerchange"),active&&!refreshing?(windowFacade.windowCloseConfirmation=!1,refreshing=!0,windowFacade.reload({})):console.log("Skip refreshing: active: "+active+" refreshing: "+String(refreshing))}),serviceWorker.addEventListener("message",function(event){if("error"===event.data.type){var unserializedError=objToError(event.data.value);handleUncaughtError(unserializedError)}})})}}else console.log("ServiceWorker is not supported")}),{setters:[function(_apiEnv){assertMainOrNodeBoot=_apiEnv.assertMainOrNodeBoot,isApp=_apiEnv.isApp,isDesktop=_apiEnv.isDesktop,isTutanotaDomain=_apiEnv.isTutanotaDomain},function(_guiBaseNotificationOverlay){notificationOverlay=_guiBaseNotificationOverlay},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType},function(_mithril){m=_mithril.default},function(_miscErrorHandler){handleUncaughtError=_miscErrorHandler.handleUncaughtError},function(_apiCommonWorkerProtocol){objToError=_apiCommonWorkerProtocol.objToError}],execute:function(){assertMainOrNodeBoot()}}}),System.register("src/settings/SettingsFolder.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../api/Env","../gui/base/NavButtonN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,assertMainOrNode,isSelectedPrefix,SettingsFolder;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseNavButtonN){isSelectedPrefix=_guiBaseNavButtonN.isSelectedPrefix}],execute:function(){assertMainOrNode(),_export("SettingsFolder",SettingsFolder=function(){function SettingsFolder(nameTextId,icon,path,viewerCreator){_classCallCheck(this,SettingsFolder),this.nameTextId=nameTextId,this.icon=icon,this.path=path,this.url="/settings/"+path,this.viewerCreator=viewerCreator,this._isVisibleHandler=function(){return!0}}return _createClass(SettingsFolder,[{key:"isActive",value:function(){return isSelectedPrefix(this.url)}},{key:"isVisible",value:function(){return this._isVisibleHandler()}},{key:"setIsVisibleHandler",value:function(isVisibleHandler){return this._isVisibleHandler=isVisibleHandler,this}}]),SettingsFolder}()),_export("SettingsFolder",SettingsFolder)}}}),System.register("src/settings/LoginSettingsViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","../api/Env","../gui/base/TextFieldN","../misc/LanguageViewModel","./PasswordForm","../api/main/LoginController","../gui/base/icons/Icons","../api/entities/sys/Session","../api/common/utils/Utils","../api/main/Entity","../misc/Formatter","../api/common/TutanotaConstants","./EditSecondFactorsForm","../api/common/utils/LazyLoaded","../api/main/EventController","../gui/base/ButtonN","../api/common/error/RestError","./RecoverCodeDialog","../gui/base/DropdownN","../gui/base/ExpanderN","../gui/base/TableN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,assertMainOrNode,TextFieldN,lang,PasswordForm,logins,Icons,SessionTypeRef,neverNull,noOp,erase,loadAll,formatDateTimeFromYesterdayOn,SessionState,EditSecondFactorsForm,LazyLoaded,isUpdateForTypeRef,ButtonN,ButtonType,NotFoundError,RecoverCodeDialog,attachDropdown,ExpanderButtonN,ExpanderPanelN,ColumnWidth,TableN,LoginSettingsViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_PasswordForm){PasswordForm=_PasswordForm.PasswordForm},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiEntitiesSysSession){SessionTypeRef=_apiEntitiesSysSession.SessionTypeRef},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_apiMainEntity){erase=_apiMainEntity.erase,loadAll=_apiMainEntity.loadAll},function(_miscFormatter){formatDateTimeFromYesterdayOn=_miscFormatter.formatDateTimeFromYesterdayOn},function(_apiCommonTutanotaConstants){SessionState=_apiCommonTutanotaConstants.SessionState},function(_EditSecondFactorsForm){EditSecondFactorsForm=_EditSecondFactorsForm.EditSecondFactorsForm},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_RecoverCodeDialog){RecoverCodeDialog=_RecoverCodeDialog},function(_guiBaseDropdownN){attachDropdown=_guiBaseDropdownN.attachDropdown},function(_guiBaseExpanderN){ExpanderButtonN=_guiBaseExpanderN.ExpanderButtonN,ExpanderPanelN=_guiBaseExpanderN.ExpanderPanelN},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth,TableN=_guiBaseTableN.TableN}],execute:function(){assertMainOrNode(),_export("LoginSettingsViewer",LoginSettingsViewer=function(){function LoginSettingsViewer(){_classCallCheck(this,LoginSettingsViewer),this._mailAddress=stream(neverNull(logins.getUserController().userGroupInfo.mailAddress)),this._stars=stream("***"),this._closedSessionsExpanded=stream(!1),this._activeSessionsTableLines=stream([]),this._closedSessionsTableLines=stream([]),this._secondFactorsForm=new EditSecondFactorsForm(new LazyLoaded(function(){return Promise.resolve(logins.getUserController().user)})),stream.merge([this._closedSessionsTableLines,this._activeSessionsTableLines]).map(m.redraw),this._updateSessions()}return _createClass(LoginSettingsViewer,[{key:"view",value:function(){var mailAddressAttrs={label:"mailAddress_label",value:this._mailAddress,disabled:!0},changePasswordButtonAttrs={label:"changePassword_label",click:function(){return PasswordForm.showChangeOwnPasswordDialog()},icon:function(){return Icons.Edit}},passwordAttrs={label:"password_label",value:this._stars,disabled:!0,injectionsRight:function(){return m(ButtonN,changePasswordButtonAttrs)}},recoveryCodeDropdownButtonAttrs=attachDropdown({label:"edit_action",icon:function(){return Icons.Edit},click:noOp},function(){return[{label:"show_action",click:function(){return RecoverCodeDialog.showRecoverCodeDialogAfterPasswordVerification("get")},type:ButtonType.Dropdown,isVisible:function(){var auth=logins.getUserController().user.auth;return Boolean(auth&&auth.recoverCode)}},{label:function(){return neverNull(logins.getUserController().user.auth).recoverCode?lang.get("update_action"):lang.get("setUp_action")},click:function(){return RecoverCodeDialog.showRecoverCodeDialogAfterPasswordVerification("create")},type:ButtonType.Dropdown}]},function(){return!0}),recoveryCodeFieldAttrs={label:"recoveryCode_label",helpLabel:function(){var lnk=lang.getInfoLink("recoverCode_link");return[m("span",lang.get("moreInfo_msg")+" "),m("span.text-break",[m("a[href="+lnk+"][target=_blank]",lnk)])]},value:this._stars,disabled:!0,injectionsRight:function(){return m(ButtonN,recoveryCodeDropdownButtonAttrs)}},closedSessionExpanderAttrs={label:"show_action",expanded:this._closedSessionsExpanded,showWarning:!1},activeSessionTableAttrs={columnHeading:["client_label","lastAccess_label","IpAddress_label"],columnWidths:[ColumnWidth.Largest,ColumnWidth.Small,ColumnWidth.Small],showActionButtonColumn:!0,lines:this._activeSessionsTableLines()},closedSessionTableAttrs={columnHeading:["client_label","lastAccess_label","IpAddress_label"],columnWidths:[ColumnWidth.Small,ColumnWidth.Largest,ColumnWidth.Small],showActionButtonColumn:!0,lines:this._closedSessionsTableLines()};return m("",[m("#user-settings.fill-absolute.scroll.plr-l.pb-xl",[m(".h4.mt-l",lang.get("loginCredentials_label")),m(TextFieldN,mailAddressAttrs),m(TextFieldN,passwordAttrs),m(TextFieldN,recoveryCodeFieldAttrs),logins.getUserController().isOutlookAccount()?null:m(this._secondFactorsForm),m(".h4.mt-l",lang.get("activeSessions_label")),m(TableN,activeSessionTableAttrs),m(".small",lang.get("sessionsInfo_msg")),m(".flex-space-between.items-center.mt-l.mb-s",[m(".h4",lang.get("closedSessions_label")),m(ExpanderButtonN,closedSessionExpanderAttrs)]),m(ExpanderPanelN,{expanded:this._closedSessionsExpanded},m(TableN,closedSessionTableAttrs)),m(".small",lang.get("sessionsWillBeDeleted_msg")),m(".small",lang.get("sessionsInfo_msg"))])])}},{key:"_updateSessions",value:function(){var _this=this;loadAll(SessionTypeRef,neverNull(logins.getUserController().user.auth).sessions).then(function(sessions){sessions.sort(function(s1,s2){return s2.lastAccessTime.getTime()-s1.lastAccessTime.getTime()}),_this._activeSessionsTableLines(sessions.filter(function(session){return session.state===SessionState.SESSION_STATE_ACTIVE}).map(function(session){var thisSession=logins.getUserController().sessionId[1]===session._id[1];return{cells:[thisSession?lang.get("thisClient_label"):session.clientIdentifier,formatDateTimeFromYesterdayOn(session.lastAccessTime),session.loginIpAddress?session.loginIpAddress:""],actionButtonAttrs:thisSession?null:{label:"closeSession_action",click:function(){erase(session).catch(NotFoundError,function(){console.log("session "+JSON.stringify(session._id)+" already deleted")})},icon:function(){return Icons.Cancel}}}})),_this._closedSessionsTableLines(sessions.filter(function(session){return session.state!==SessionState.SESSION_STATE_ACTIVE}).map(function(session){return{cells:[session.clientIdentifier,formatDateTimeFromYesterdayOn(session.lastAccessTime),session.loginIpAddress?session.loginIpAddress:""]}}))})}},{key:"entityEventsReceived",value:function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var update=_step.value;isUpdateForTypeRef(SessionTypeRef,update)&&this._updateSessions(),this._secondFactorsForm.entityEventReceived(update)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}]),LoginSettingsViewer}()),_export("LoginSettingsViewer",LoginSettingsViewer)}}}),System.register("src/settings/DesktopSettingsViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../misc/LanguageViewModel","mithril/stream/stream.js","../native/NativeWrapper.js","../api/common/WorkerProtocol.js","../gui/base/ProgressDialog.js","../api/common/utils/Utils","../gui/base/icons/Icons","../gui/base/TextFieldN","../gui/base/ButtonN","../native/FileApp","../gui/base/DropdownN","../gui/base/DropDownSelectorN","../gui/base/Dialog"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,lang,stream,nativeApp,Request,showProgressDialog,noOp,Icons,TextFieldN,ButtonN,ButtonType,fileApp,attachDropdown,DropDownSelectorN,Dialog,DownloadLocationStrategy,DesktopSettingsViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_nativeNativeWrapperJs){nativeApp=_nativeNativeWrapperJs.nativeApp},function(_apiCommonWorkerProtocolJs){Request=_apiCommonWorkerProtocolJs.Request},function(_guiBaseProgressDialogJs){showProgressDialog=_guiBaseProgressDialogJs.showProgressDialog},function(_apiCommonUtilsUtils){noOp=_apiCommonUtilsUtils.noOp},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_nativeFileApp){fileApp=_nativeFileApp.fileApp},function(_guiBaseDropdownN){attachDropdown=_guiBaseDropdownN.attachDropdown},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog}],execute:function(){assertMainOrNode(),DownloadLocationStrategy=Object.freeze({ALWAYS_ASK:0,CHOOSE_DIRECTORY:1}),_export("DesktopSettingsViewer",DesktopSettingsViewer=function(){function DesktopSettingsViewer(){_classCallCheck(this,DesktopSettingsViewer),this.entityEventsReceived=noOp,this._isDefaultMailtoHandler=stream(!1),this._runAsTrayApp=stream(!0),this._runOnStartup=stream(!1),this._isIntegrated=stream(!1),this._isAutoUpdateEnabled=stream(!1),this._requestDesktopConfig()}return _createClass(DesktopSettingsViewer,[{key:"view",value:function(){var _this=this,setDefaultMailtoHandlerAttrs={label:"defaultMailHandler_label",helpLabel:function(){return lang.get("defaultMailHandler_msg")},items:[{name:lang.get("unregistered_label"),value:!1},{name:lang.get("registered_label"),value:!0}],selectedValue:this._isDefaultMailtoHandler,selectionChangedHandler:function(v){showProgressDialog("pleaseWait_msg",_this._updateDefaultMailtoHandler(v)).then(function(){_this._isDefaultMailtoHandler(v),m.redraw()})}},setRunAsTrayAppAttrs={label:"linux"===env.platformId?"showTrayIcon_action":"runAsTrayApp_action",helpLabel:"linux"===env.platformId?function(){return lang.get("mayNotWorkForAllDe_msg")}:function(){return""},items:[{name:lang.get("yes_label"),value:!0},{name:lang.get("no_label"),value:!1}],selectedValue:this._runAsTrayApp,selectionChangedHandler:function(v){_this._runAsTrayApp(v),_this.setBooleanSetting("runAsTrayApp",v)}},setRunOnStartupAttrs={label:"runOnStartup_action",items:[{name:lang.get("yes_label"),value:!0},{name:lang.get("no_label"),value:!1}],selectedValue:this._runOnStartup,selectionChangedHandler:function(v){showProgressDialog("pleaseWait_msg",nativeApp.invokeNative(new Request(v?"enableAutoLaunch":"disableAutoLaunch",[]))).then(function(){_this._runOnStartup(v),m.redraw()})}},setDesktopIntegrationAttrs={label:"desktopIntegration_label",items:[{name:lang.get("activated_label"),value:!0},{name:lang.get("deactivated_label"),value:!1}],selectedValue:this._isIntegrated,selectionChangedHandler:function(v){showProgressDialog("pleaseWait_msg",_this._updateDesktopIntegration(v)).then(function(){_this._isIntegrated(v),m.redraw()}).catch(function(e){return Dialog.error("unknownError_msg",e.message)})}},setAutoUpdateAttrs={label:"autoUpdate_label",items:[{name:lang.get("activated_label"),value:!0},{name:lang.get("deactivated_label"),value:!1}],selectedValue:this._isAutoUpdateEnabled,selectionChangedHandler:function(v){_this._isAutoUpdateEnabled(v),_this.setBooleanSetting("enableAutoUpdate",v)}},changeDefaultDownloadPathAttrs=attachDropdown({label:"edit_action",type:ButtonType.Action,click:noOp,icon:function(){return Icons.Edit}},function(){return[{label:"alwaysAsk_action",click:function(){return _this.setDefaultDownloadPath(DownloadLocationStrategy.ALWAYS_ASK)},type:ButtonType.Dropdown},{label:"chooseDirectory_action",click:function(){return _this.setDefaultDownloadPath(DownloadLocationStrategy.CHOOSE_DIRECTORY)},type:ButtonType.Dropdown}]},function(){return!_this._isPathDialogOpen},200),defaultDownloadPathAttrs={label:"defaultDownloadPath_label",value:this._defaultDownloadPath,injectionsRight:function(){return m(ButtonN,changeDefaultDownloadPathAttrs)},disabled:!0};return[m("#user-settings.fill-absolute.scroll.plr-l.pb-xl",[m(".h4.mt-l",lang.get("desktopSettings_label")),"linux"===env.platformId?null:m(DropDownSelectorN,setDefaultMailtoHandlerAttrs),"darwin"===env.platformId?null:m(DropDownSelectorN,setRunAsTrayAppAttrs),m(DropDownSelectorN,setRunOnStartupAttrs),m(TextFieldN,defaultDownloadPathAttrs),"linux"===env.platformId?m(DropDownSelectorN,setDesktopIntegrationAttrs):null,m(DropDownSelectorN,setAutoUpdateAttrs)])]}},{key:"_updateDefaultMailtoHandler",value:function(shouldBeDefaultMailtoHandler){return shouldBeDefaultMailtoHandler?nativeApp.invokeNative(new Request("registerMailto",[])):nativeApp.invokeNative(new Request("unregisterMailto",[]))}},{key:"_updateDesktopIntegration",value:function(shouldIntegrate){return shouldIntegrate?nativeApp.invokeNative(new Request("integrateDesktop",[])):nativeApp.invokeNative(new Request("unIntegrateDesktop",[]))}},{key:"_requestDesktopConfig",value:function(){var _this2=this;this._defaultDownloadPath=stream(lang.get("alwaysAsk_action")),nativeApp.invokeNative(new Request("sendDesktopConfig",[])).then(function(desktopConfig){_this2._isDefaultMailtoHandler(desktopConfig.isMailtoHandler),_this2._defaultDownloadPath(desktopConfig.defaultDownloadPath?desktopConfig.defaultDownloadPath:lang.get("alwaysAsk_action")),_this2._runAsTrayApp(desktopConfig.runAsTrayApp),_this2._runOnStartup(desktopConfig.runOnStartup),_this2._isIntegrated(desktopConfig.isIntegrated),_this2._isAutoUpdateEnabled(desktopConfig.enableAutoUpdate),m.redraw()})}},{key:"setBooleanSetting",value:function(setting,value){nativeApp.invokeNative(new Request("sendDesktopConfig",[])).then(function(config){return config[setting]=value,nativeApp.invokeNative(new Request("updateDesktopConfig",[config]))}).then(function(){return m.redraw()})}},{key:"setDefaultDownloadPath",value:function(v){var _this3=this;this._isPathDialogOpen=!0,Promise.join(nativeApp.invokeNative(new Request("sendDesktopConfig",[])),v===DownloadLocationStrategy.ALWAYS_ASK?Promise.resolve([null]):fileApp.openFolderChooser(),function(config,newPaths){return config.defaultDownloadPath=newPaths[0],_this3._defaultDownloadPath(newPaths[0]?newPaths[0]:lang.get("alwaysAsk_action")),config}).then(function(config){return nativeApp.invokeNative(new Request("updateDesktopConfig",[config]))}).then(function(){_this3._isPathDialogOpen=!1,m.redraw()})}}]),DesktopSettingsViewer}()),_export("DesktopSettingsViewer",DesktopSettingsViewer)}}}),System.register("src/settings/EditSignatureDialog.js",["mithril","../api/Env","../gui/base/Dialog","../misc/LanguageViewModel","../api/main/Entity","../gui/base/DropDownSelector","../api/common/TutanotaConstants","../api/common/utils/Utils","../api/main/LoginController","../mail/MailUtils","../gui/base/HtmlEditor","mithril/stream/stream.js"],function(_export,_context){"use strict";var m,assertMainOrNode,Dialog,DialogType,lang,update,DropDownSelector,EmailSignatureType,FeatureType,neverNull,logins,getDefaultSignature,insertInlineImageB64ClickHandler,HtmlEditor,stream;function getSignatureTypes(props){var signatureTypes=[{name:lang.get("emailSignatureTypeCustom_msg"),value:EmailSignatureType.EMAIL_SIGNATURE_TYPE_CUSTOM},{name:lang.get("comboBoxSelectionNone_msg"),value:EmailSignatureType.EMAIL_SIGNATURE_TYPE_NONE}];return logins.isEnabled(FeatureType.DisableDefaultSignature)&&props.emailSignatureType!==EmailSignatureType.EMAIL_SIGNATURE_TYPE_DEFAULT||signatureTypes.splice(0,0,{name:lang.get("emailSignatureTypeDefault_msg"),value:EmailSignatureType.EMAIL_SIGNATURE_TYPE_DEFAULT}),signatureTypes}function getSignature(type,currentCustomSignature){return type===EmailSignatureType.EMAIL_SIGNATURE_TYPE_DEFAULT?getDefaultSignature():type===EmailSignatureType.EMAIL_SIGNATURE_TYPE_CUSTOM?currentCustomSignature:""}return _export("show",function(props){var currentCustomSignature=logins.getUserController().props.customEmailSignature;""!==currentCustomSignature||logins.isEnabled(FeatureType.DisableDefaultSignature)||(currentCustomSignature=getDefaultSignature());var previousType=logins.getUserController().props.emailSignatureType,editor=new HtmlEditor("preview_label",{enabled:!0,imageButtonClickHandler:insertInlineImageB64ClickHandler}).showBorders().setMinHeight(200).setValue(getSignature(previousType,currentCustomSignature)),typeField=new DropDownSelector("userEmailSignature_label",null,getSignatureTypes(props),stream(previousType));typeField.selectedValue.map(function(type){previousType===EmailSignatureType.EMAIL_SIGNATURE_TYPE_CUSTOM&&(currentCustomSignature=editor.getValue()),previousType=type,editor.setValue(getSignature(type,currentCustomSignature)),editor.setEnabled(type===EmailSignatureType.EMAIL_SIGNATURE_TYPE_CUSTOM)});var form={view:function(){return[m(typeField),m(editor)]}};Dialog.showActionDialog({title:lang.get("userEmailSignature_label"),child:form,type:DialogType.EditLarge,okAction:function(dialog){logins.getUserController().props.emailSignatureType=typeField.selectedValue(),typeField.selectedValue()===EmailSignatureType.EMAIL_SIGNATURE_TYPE_CUSTOM&&(logins.getUserController().props.customEmailSignature=editor.getValue()),update(logins.getUserController().props),dialog.close()}})}),_export("getSignatureTypes",getSignatureTypes),_export("getSignatureType",function(props){return neverNull(getSignatureTypes(props).find(function(t){return t.value===props.emailSignatureType}))}),{setters:[function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiMainEntity){update=_apiMainEntity.update},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_apiCommonTutanotaConstants){EmailSignatureType=_apiCommonTutanotaConstants.EmailSignatureType,FeatureType=_apiCommonTutanotaConstants.FeatureType},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_mailMailUtils){getDefaultSignature=_mailMailUtils.getDefaultSignature,insertInlineImageB64ClickHandler=_mailMailUtils.insertInlineImageB64ClickHandler},function(_guiBaseHtmlEditor){HtmlEditor=_guiBaseHtmlEditor.HtmlEditor},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default}],execute:function(){assertMainOrNode()}}}),System.register("src/settings/IdentifierListViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../api/common/EntityFunctions","../misc/LanguageViewModel","../api/main/Entity","../api/common/utils/Utils","../api/entities/sys/PushIdentifier","../native/PushServiceApp","../api/main/LoginController","../gui/base/icons/Icons","../api/common/TutanotaConstants","../misc/Formatter","../misc/ErrorHandlerImpl","../gui/base/ProgressDialog","../api/main/WorkerClient","../gui/base/Dialog","../api/common/error/RestError","../gui/base/DropdownN","../gui/base/ButtonN","../gui/base/ExpanderN","mithril/stream/stream.js","../gui/base/TextFieldN","../api/main/EventController"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,isApp,isDesktop,HttpMethodEnum,lang,erase,loadAll,update,neverNull,noOp,createPushIdentifier,PushIdentifierTypeRef,pushServiceApp,logins,Icons,PushServiceType,getCleanedMailAddress,showNotAvailableForFreeDialog,showProgressDialog,worker,Dialog,NotFoundError,attachDropdown,ButtonN,ButtonType,ExpanderButtonN,ExpanderPanelN,stream,TextFieldN,isUpdateForTypeRef,IdentifierRow,IdentifierListViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){isApp=_apiEnv.isApp,isDesktop=_apiEnv.isDesktop},function(_apiCommonEntityFunctions){HttpMethodEnum=_apiCommonEntityFunctions.HttpMethod},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiMainEntity){erase=_apiMainEntity.erase,loadAll=_apiMainEntity.loadAll,update=_apiMainEntity.update},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_apiEntitiesSysPushIdentifier){createPushIdentifier=_apiEntitiesSysPushIdentifier.createPushIdentifier,PushIdentifierTypeRef=_apiEntitiesSysPushIdentifier.PushIdentifierTypeRef},function(_nativePushServiceApp){pushServiceApp=_nativePushServiceApp.pushServiceApp},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiCommonTutanotaConstants){PushServiceType=_apiCommonTutanotaConstants.PushServiceType},function(_miscFormatter){getCleanedMailAddress=_miscFormatter.getCleanedMailAddress},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiBaseDropdownN){attachDropdown=_guiBaseDropdownN.attachDropdown},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseExpanderN){ExpanderButtonN=_guiBaseExpanderN.ExpanderButtonN,ExpanderPanelN=_guiBaseExpanderN.ExpanderPanelN},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef}],execute:function(){IdentifierRow=function(){function IdentifierRow(){_classCallCheck(this,IdentifierRow)}return _createClass(IdentifierRow,[{key:"view",value:function(vnode){var dropdownAttrs=attachDropdown({label:"edit_action",icon:function(){return Icons.Edit}},function(){return[{label:function(){return lang.get(vnode.attrs.disabled?"activate_action":"deactivate_action")},type:ButtonType.Dropdown,click:vnode.attrs.disableClicked},{label:"delete_action",type:ButtonType.Dropdown,click:vnode.attrs.removeClicked}]});return m(".flex.flex-column.full-width",[m(".flex.items-center.selectable",[m("span"+(vnode.attrs.current?".b":""),vnode.attrs.name),vnode.attrs.disabled?m(".mlr","("+lang.get("notificationsDisabled_label")+")"):null,m(".flex-grow"),m(ButtonN,dropdownAttrs)]),this._identifier(vnode)])}},{key:"_identifier",value:function(vnode){var identifierText=vnode.attrs.formatIdentifier?neverNull(vnode.attrs.identifier.match(/.{2}/g)).map(function(el,i){return m("span.pr-s"+(i%2==0?".b":""),el)}):vnode.attrs.identifier;return m(".text-break.small.monospace.mt-negative-s.selectable",identifierText)}}]),IdentifierRow}(),_export("IdentifierListViewer",IdentifierListViewer=function(){function IdentifierListViewer(user){_classCallCheck(this,IdentifierListViewer),this._expanded=stream(!1),this._identifiers=stream([]),this._user=user,this._loadPushIdentifiers()}return _createClass(IdentifierListViewer,[{key:"_disableIdentifier",value:function(identifier){identifier.disabled=!identifier.disabled,update(identifier).then(m.redraw)}},{key:"view",value:function(){var _this=this,pushIdentifiersExpanderAttrs={label:"show_action",expanded:this._expanded},expanderContent={view:function(){var buttonAddAttrs={label:"emailPushNotification_action",click:function(){return _this._showAddNotificationEmailAddressDialog(_this._user)},icon:function(){return Icons.Add}},rowAdd=m(".full-width.flex-space-between.items-center.mb-s",[lang.get("emailPushNotification_action"),m(ButtonN,buttonAddAttrs)]),rows=_this._identifiers().map(function(identifier){var isCurrentDevice=(isApp()||isDesktop())&&identifier.identifier===_this._currentIdentifier;return m(IdentifierRow,{name:_this._identifierDisplayName(isCurrentDevice,identifier.pushServiceType,identifier.displayName),disabled:identifier.disabled,identifier:identifier.identifier,current:isCurrentDevice,removeClicked:function(){erase(identifier).catch(NotFoundError,noOp)},formatIdentifier:identifier.pushServiceType!==PushServiceType.EMAIL,disableClicked:function(){return _this._disableIdentifier(identifier)}})}).sort(function(l,r){return+r.attrs.current-+l.attrs.current});return m(".flex.flex-column.items-end.mb",[rowAdd].concat(rows))}};return[m(".flex-space-between.items-center.mt-l.mb-s",[m(".h4",lang.get("notificationSettings_action")),m(ExpanderButtonN,pushIdentifiersExpanderAttrs)]),m(ExpanderPanelN,{expanded:this._expanded},m(expanderContent)),m(".small",lang.get("pushIdentifierInfoMessage_msg"))]}},{key:"_identifierDisplayName",value:function(current,type,displayName){return current?lang.get("pushIdentifierCurrentDevice_label"):displayName||["Android FCM","iOS",lang.get("adminEmailSettings_action"),"Android Tutanota"][Number(type)]}},{key:"_loadPushIdentifiers",value:function(){var _this2=this;if(this._user){this._currentIdentifier=pushServiceApp.getPushIdentifier();var list=neverNull(this._user).pushIdentifierList;list&&loadAll(PushIdentifierTypeRef,list.list).then(function(identifiers){_this2._identifiers(identifiers),m.redraw()})}}},{key:"_showAddNotificationEmailAddressDialog",value:function(user){var _this3=this;if(user){var mailAddress=stream("");if(logins.getUserController().isFreeAccount())showNotAvailableForFreeDialog(!0);else{var emailAddressInputFieldAttrs={label:"mailAddress_label",value:mailAddress},form={view:function(){return[m(TextFieldN,emailAddressInputFieldAttrs),m(".small.mt-s",lang.get("emailPushNotification_msg"))]}};Dialog.showActionDialog({title:lang.get("notificationSettings_action"),child:form,validator:function(){return _this3._validateAddNotificationEmailAddressInput(mailAddress())},allowOkWithReturn:!0,okAction:function(dialog){user=neverNull(user);var pushIdentifier=createPushIdentifier();pushIdentifier.displayName=lang.get("adminEmailSettings_action"),pushIdentifier.identifier=neverNull(getCleanedMailAddress(mailAddress())),pushIdentifier.language=lang.code,pushIdentifier.pushServiceType=PushServiceType.EMAIL,pushIdentifier._ownerGroup=user.userGroup.group,pushIdentifier._owner=user.userGroup.group,pushIdentifier._area="0";var p=worker.entityRequest(PushIdentifierTypeRef,HttpMethodEnum.POST,neverNull(user.pushIdentifierList).list,null,pushIdentifier);showProgressDialog("pleaseWait_msg",p),dialog.close()}})}}}},{key:"_validateAddNotificationEmailAddressInput",value:function(emailAddress){return null==getCleanedMailAddress(emailAddress)?"mailAddressInvalid_msg":null}},{key:"entityEventReceived",value:function(update){isUpdateForTypeRef(PushIdentifierTypeRef,update)&&this._loadPushIdentifiers()}}]),IdentifierListViewer}()),_export("IdentifierListViewer",IdentifierListViewer)}}}),System.register("src/settings/MailSettingsViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../misc/LanguageViewModel","../api/common/EntityFunctions","../api/entities/tutanota/TutanotaProperties","../api/common/TutanotaConstants","../api/main/Entity","../api/common/utils/Utils","../api/entities/tutanota/MailFolder","../mail/InboxRuleHandler","./EditSignatureDialog","./EditAliasesFormN.js","../gui/base/Dialog","../api/entities/sys/GroupInfo","../api/main/LoginController","../mail/MailUtils","../gui/base/icons/Icons","../api/main/WorkerClient","../gui/base/ProgressDialog","../mail/MailModel","../api/main/MainLocator","mithril/stream/stream.js","../api/main/EventController","../gui/base/DropDownSelectorN","../gui/base/TextFieldN","../gui/base/ButtonN","../gui/base/TableN","./AddInboxRuleDialog","../gui/base/ExpanderN","./IdentifierListViewer","../api/common/error/IndexingNotSupportedError"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,isApp,lang,isSameId,TutanotaPropertiesTypeRef,FeatureType,InboxRuleType,OperationType,load,update,getEnabledMailAddressesForGroupInfo,neverNull,MailFolderTypeRef,getInboxRuleTypeName,EditSignatureDialog,EditAliasesFormN,Dialog,GroupInfoTypeRef,logins,getDefaultSenderFromUser,getFolderName,Icons,worker,showProgressDialog,mailModel,locator,stream,isUpdateForTypeRef,DropDownSelectorN,TextFieldN,ButtonN,ButtonType,ColumnWidth,createRowActions,TableN,AddInboxRuleDialog,createInboxRuleTemplate,ExpanderButtonN,ExpanderPanelN,IdentifierListViewer,IndexingNotSupportedError,MailSettingsViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isApp=_apiEnv.isApp},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonEntityFunctions){isSameId=_apiCommonEntityFunctions.isSameId},function(_apiEntitiesTutanotaTutanotaProperties){TutanotaPropertiesTypeRef=_apiEntitiesTutanotaTutanotaProperties.TutanotaPropertiesTypeRef},function(_apiCommonTutanotaConstants){FeatureType=_apiCommonTutanotaConstants.FeatureType,InboxRuleType=_apiCommonTutanotaConstants.InboxRuleType,OperationType=_apiCommonTutanotaConstants.OperationType},function(_apiMainEntity){load=_apiMainEntity.load,update=_apiMainEntity.update},function(_apiCommonUtilsUtils){getEnabledMailAddressesForGroupInfo=_apiCommonUtilsUtils.getEnabledMailAddressesForGroupInfo,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEntitiesTutanotaMailFolder){MailFolderTypeRef=_apiEntitiesTutanotaMailFolder.MailFolderTypeRef},function(_mailInboxRuleHandler){getInboxRuleTypeName=_mailInboxRuleHandler.getInboxRuleTypeName},function(_EditSignatureDialog){EditSignatureDialog=_EditSignatureDialog},function(_EditAliasesFormNJs){EditAliasesFormN=_EditAliasesFormNJs.EditAliasesFormN},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_mailMailUtils){getDefaultSenderFromUser=_mailMailUtils.getDefaultSenderFromUser,getFolderName=_mailMailUtils.getFolderName},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_mailMailModel){mailModel=_mailMailModel.mailModel},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth,createRowActions=_guiBaseTableN.createRowActions,TableN=_guiBaseTableN.TableN},function(_AddInboxRuleDialog){AddInboxRuleDialog=_AddInboxRuleDialog,createInboxRuleTemplate=_AddInboxRuleDialog.createInboxRuleTemplate},function(_guiBaseExpanderN){ExpanderButtonN=_guiBaseExpanderN.ExpanderButtonN,ExpanderPanelN=_guiBaseExpanderN.ExpanderPanelN},function(_IdentifierListViewer){IdentifierListViewer=_IdentifierListViewer.IdentifierListViewer},function(_apiCommonErrorIndexingNotSupportedError){IndexingNotSupportedError=_apiCommonErrorIndexingNotSupportedError.IndexingNotSupportedError}],execute:function(){assertMainOrNode(),_export("MailSettingsViewer",MailSettingsViewer=function(){function MailSettingsViewer(){_classCallCheck(this,MailSettingsViewer),this._defaultSender=stream(getDefaultSenderFromUser()),this._senderName=stream(logins.getUserController().userGroupInfo.name),this._signature=stream(EditSignatureDialog.getSignatureType(logins.getUserController().props).name),this._defaultUnconfidential=stream(logins.getUserController().props.defaultUnconfidential),this._sendPlaintext=stream(logins.getUserController().props.sendPlaintextOnly),this._noAutomaticContacts=stream(logins.getUserController().props.noAutomaticContacts),this._enableMailIndexing=stream(locator.search.indexState().mailIndexEnabled),this._inboxRulesExpanded=stream(!1),this._inboxRulesTableLines=stream([]),this._indexStateWatch=null,this._identifierListViewer=new IdentifierListViewer(logins.getUserController().user),this._updateInboxRules(logins.getUserController().props)}return _createClass(MailSettingsViewer,[{key:"view",value:function(){var _this=this,defaultSenderAttrs={label:"defaultSenderMailAddress_label",items:getEnabledMailAddressesForGroupInfo(logins.getUserController().userGroupInfo).map(function(a){return{name:a,value:a}}),selectedValue:this._defaultSender,selectionChangedHandler:function(v){logins.getUserController().props.defaultSender=v,update(logins.getUserController().props)},helpLabel:function(){return lang.get("defaultSenderMailAddressInfo_msg")},dropdownWidth:250},editSenderNameButtonAttrs={label:"mailName_label",click:function(){Dialog.showTextInputDialog("edit_action","mailName_label",null,_this._senderName()).then(function(newName){logins.getUserController().userGroupInfo.name=newName,update(logins.getUserController().userGroupInfo)})},icon:function(){return Icons.Edit}},senderNameAttrs={label:"mailName_label",value:this._senderName,disabled:!0,injectionsRight:function(){return logins.getUserController().isGlobalAdmin()?[m(ButtonN,editSenderNameButtonAttrs)]:[]}},changeSignatureButtonAttrs={label:"userEmailSignature_label",click:function(){return EditSignatureDialog.show(logins.getUserController().props)},icon:function(){return Icons.Edit}},signatureAttrs={label:"userEmailSignature_label",value:this._signature,disabled:!0,injectionsRight:function(){return[m(ButtonN,changeSignatureButtonAttrs)]}},defaultUnconfidentialAttrs={label:"defaultExternalDelivery_label",items:[{name:lang.get("confidential_action"),value:!1},{name:lang.get("nonConfidential_action"),value:!0}],selectedValue:this._defaultUnconfidential,selectionChangedHandler:function(v){logins.getUserController().props.defaultUnconfidential=v,update(logins.getUserController().props)},helpLabel:function(){return lang.get("defaultExternalDeliveryInfo_msg")},dropdownWidth:250},sendPlaintextAttrs={label:"externalFormatting_label",helpLabel:function(){return lang.get("externalFormattingInfo_msg")},items:[{name:lang.get("html_action"),value:!1},{name:lang.get("plaintext_action"),value:!0}],selectedValue:this._sendPlaintext,selectionChangedHandler:function(v){logins.getUserController().props.sendPlaintextOnly=v,update(logins.getUserController().props)},dropdownWidth:250},noAutomaticContactsAttrs={label:"createContacts_label",helpLabel:function(){return lang.get("createContactsForRecipients_action")},items:[{name:lang.get("activated_label"),value:!1},{name:lang.get("deactivated_label"),value:!0}],selectedValue:this._noAutomaticContacts,selectionChangedHandler:function(v){logins.getUserController().props.noAutomaticContacts=v,update(logins.getUserController().props)},dropdownWidth:250},enableMailIndexingAttrs={label:"searchMailbox_label",helpLabel:function(){return lang.get("enableSearchMailbox_msg")},items:[{name:lang.get("activated_label"),value:!0},{name:lang.get("deactivated_label"),value:!1}],selectedValue:this._enableMailIndexing,selectionChangedHandler:function(mailIndexEnabled){mailIndexEnabled?showProgressDialog("pleaseWait_msg",worker.enableMailIndexing()).catch(IndexingNotSupportedError,function(){Dialog.error(isApp()?"searchDisabledApp_msg":"searchDisabled_msg")}):showProgressDialog("pleaseWait_msg",worker.disableMailIndexing())},dropdownWidth:250},templateRule=createInboxRuleTemplate(InboxRuleType.RECIPIENT_TO_EQUALS,""),addInboxRuleButtonAttrs={label:"addInboxRule_action",click:function(){return mailModel.getUserMailboxDetails().then(function(mailboxDetails){return AddInboxRuleDialog.show(mailboxDetails,templateRule)})},icon:function(){return Icons.Add}},inboxRulesTableAttrs={columnHeading:["inboxRuleField_label","inboxRuleValue_label","inboxRuleTargetFolder_label"],columnWidths:[ColumnWidth.Small,ColumnWidth.Largest,ColumnWidth.Small],showActionButtonColumn:!0,addButtonAttrs:addInboxRuleButtonAttrs,lines:this._inboxRulesTableLines()};return[m("#user-settings.fill-absolute.scroll.plr-l.pb-xl",{role:"group",oncreate:function(){_this._indexStateWatch=locator.search.indexState.map(function(newValue){_this._enableMailIndexing(newValue.mailIndexEnabled),m.redraw()})},onbeforeremove:function(){_this._indexStateWatch&&_this._indexStateWatch.end(!0)}},[m(".h4.mt-l",lang.get("emailSending_label")),m(DropDownSelectorN,defaultSenderAttrs),m(TextFieldN,senderNameAttrs),m(TextFieldN,signatureAttrs),logins.isEnabled(FeatureType.InternalCommunication)?null:m(DropDownSelectorN,defaultUnconfidentialAttrs),logins.isEnabled(FeatureType.InternalCommunication)?null:m(DropDownSelectorN,sendPlaintextAttrs),logins.isEnabled(FeatureType.DisableContacts)?null:m(DropDownSelectorN,noAutomaticContactsAttrs),m(DropDownSelectorN,enableMailIndexingAttrs),logins.getUserController().isGlobalAdmin()?m(EditAliasesFormN,{userGroupInfo:logins.getUserController().userGroupInfo}):null,logins.isEnabled(FeatureType.InternalCommunication)?null:[m(".flex-space-between.items-center.mt-l.mb-s",[m(".h4",lang.get("inboxRulesSettings_action")),m(ExpanderButtonN,{label:"showInboxRules_action",expanded:this._inboxRulesExpanded})]),m(ExpanderPanelN,{expanded:this._inboxRulesExpanded},m(TableN,inboxRulesTableAttrs)),m(".small",lang.get("nbrOfInboxRules_msg",{"{1}":logins.getUserController().props.inboxRules.length}))],m(this._identifierListViewer)])]}},{key:"_updatePropertiesSettings",value:function(props){props.defaultSender&&this._defaultSender(props.defaultSender),this._defaultUnconfidential(props.defaultUnconfidential),this._noAutomaticContacts(props.noAutomaticContacts),this._sendPlaintext(props.sendPlaintextOnly),this._signature(EditSignatureDialog.getSignatureType(props).name)}},{key:"_updateInboxRules",value:function(props){var _this2=this;mailModel.getUserMailboxDetails().then(function(mailboxDetails){_this2._inboxRulesTableLines(props.inboxRules.map(function(rule,index){return{cells:[getInboxRuleTypeName(rule.type),rule.value,_this2._getTextForTarget(mailboxDetails,rule.targetFolder)],actionButtonAttrs:createRowActions({getArray:function(){return props.inboxRules},updateInstance:function(){return update(props)}},rule,index,[{label:"edit_action",click:function(){return AddInboxRuleDialog.show(mailboxDetails,rule)},type:ButtonType.Dropdown}])}})),m.redraw()})}},{key:"_getTextForTarget",value:function(mailboxDetails,targetFolderId){var folder=mailboxDetails.folders.find(function(folder){return isSameId(folder._id,targetFolderId)});return folder?getFolderName(folder):"?"}},{key:"entityEventsReceived",value:function(updates){var _this3=this,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _update=_step.value,instanceListId=_update.instanceListId,instanceId=_update.instanceId,operation=_update.operation;isUpdateForTypeRef(TutanotaPropertiesTypeRef,_update)&&operation===OperationType.UPDATE?load(TutanotaPropertiesTypeRef,logins.getUserController().props._id).then(function(props){_this3._updatePropertiesSettings(props),_this3._updateInboxRules(props)}):isUpdateForTypeRef(MailFolderTypeRef,_update)?this._updateInboxRules(logins.getUserController().props):isUpdateForTypeRef(GroupInfoTypeRef,_update)&&operation===OperationType.UPDATE&&isSameId(logins.getUserController().userGroupInfo._id,[neverNull(instanceListId),instanceId])&&load(GroupInfoTypeRef,[neverNull(instanceListId),instanceId]).then(function(groupInfo){_this3._senderName(groupInfo.name),m.redraw()}),this._identifierListViewer.entityEventReceived(_update)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}m.redraw()}}]),MailSettingsViewer}()),_export("MailSettingsViewer",MailSettingsViewer)}}}),System.register("src/settings/UserListView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/List","../api/main/Entity","../api/common/EntityFunctions","../api/Env","../misc/LanguageViewModel","../api/common/error/RestError","../gui/size","../api/entities/sys/GroupInfo","../api/entities/sys/Customer","../api/common/utils/Utils","./UserViewer","./SettingsView","../api/common/utils/LazyLoaded","../api/common/TutanotaConstants","../api/main/LoginController","./AddUserDialog","../gui/base/Icon","../gui/base/icons/Icons","../gui/base/icons/BootIcons","../gui/base/Header","../api/entities/sys/GroupMember","../api/entities/sys/User","../api/common/utils/ArrayUtils","../api/main/EventController","../gui/base/ButtonN","../misc/ErrorHandlerImpl"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,List,load,loadAll,GENERATED_MAX_ID,assertMainOrNode,lang,NotFoundError,size,GroupInfoTypeRef,CustomerTypeRef,compareGroupInfos,neverNull,UserViewer,LazyLoaded,FeatureType,GroupType,OperationType,logins,AddUserDialog,Icon,Icons,BootIcons,header,GroupMemberTypeRef,UserTypeRef,contains,isUpdateForTypeRef,ButtonN,ButtonType,showNotAvailableForFreeDialog,className,UserListView,UserRow;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseList){List=_guiBaseList.List},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll},function(_apiCommonEntityFunctions){GENERATED_MAX_ID=_apiCommonEntityFunctions.GENERATED_MAX_ID},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiSize){size=_guiSize.size},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiCommonUtilsUtils){compareGroupInfos=_apiCommonUtilsUtils.compareGroupInfos,neverNull=_apiCommonUtilsUtils.neverNull},function(_UserViewer){UserViewer=_UserViewer.UserViewer},function(_SettingsView){_SettingsView.SettingsView},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_apiCommonTutanotaConstants){FeatureType=_apiCommonTutanotaConstants.FeatureType,GroupType=_apiCommonTutanotaConstants.GroupType,OperationType=_apiCommonTutanotaConstants.OperationType},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_AddUserDialog){AddUserDialog=_AddUserDialog},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_guiBaseHeader){header=_guiBaseHeader.header},function(_apiEntitiesSysGroupMember){GroupMemberTypeRef=_apiEntitiesSysGroupMember.GroupMemberTypeRef},function(_apiEntitiesSysUser){UserTypeRef=_apiEntitiesSysUser.UserTypeRef},function(_apiCommonUtilsArrayUtils){contains=_apiCommonUtilsArrayUtils.contains},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog}],execute:function(){assertMainOrNode(),className="user-list",_export("UserListView",UserListView=function(){function UserListView(settingsView){var _this=this;_classCallCheck(this,UserListView),this._adminUserGroupInfoIds=[],this._settingsView=settingsView,this._listId=new LazyLoaded(function(){return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return customer.userGroups})}),this.list=new List({rowHeight:size.list_row_height,fetch:function(startId,count){if(startId===GENERATED_MAX_ID)return _this._loadAdmins().then(function(){return _this._listId.getAsync().then(function(listId){return loadAll(GroupInfoTypeRef,listId).then(function(allUserGroupInfos){if(_this._setLoadedCompletely(),logins.getUserController().isGlobalAdmin())return allUserGroupInfos;var localAdminGroupIds=logins.getUserController().getLocalAdminGroupMemberships().map(function(gm){return gm.group});return allUserGroupInfos.filter(function(gi){return gi.localAdmin&&-1!==localAdminGroupIds.indexOf(gi.localAdmin)})})})});throw new Error("fetch user group infos called for specific start id")},loadSingle:function(elementId){return _this._listId.getAsync().then(function(listId){return load(GroupInfoTypeRef,[listId,elementId]).catch(NotFoundError,function(e){})})},sortCompare:compareGroupInfos,elementSelected:function(entities,elementClicked,selectionChanged,multiSelectionActive){return _this.elementSelected(entities,elementClicked,selectionChanged,multiSelectionActive)},createVirtualRow:function(){return new UserRow(_this)},showStatus:!1,className:className,swipe:{renderLeftSpacer:function(){return[]},renderRightSpacer:function(){return[]},swipeLeft:function(listElement){return Promise.resolve()},swipeRight:function(listElement){return Promise.resolve()},enabled:!1},elementsDraggable:!1,multiSelectionAllowed:!1,emptyMessage:lang.get("noEntries_msg")}),this.view=function(){return logins.isEnabled(FeatureType.WhitelabelChild)?null:m(".flex.flex-column.fill-absolute",[m(".flex.flex-column.justify-center.plr-l.list-border-right.list-bg.list-header",m(".mr-negative-s.align-self-end",m(ButtonN,{label:"addUsers_action",type:ButtonType.Primary,click:function(){return _this.addButtonClicked()}}))),m(".rel.flex-grow",m(_this.list))])},this.list.loadInitial();var searchBar=neverNull(header.searchBar);this._listId.getAsync().then(function(listId){searchBar.setGroupInfoRestrictionListId(listId)}),this._searchResultStreamDependency=searchBar.lastSelectedGroupInfoResult.map(function(groupInfo){_this._listId.isLoaded()&&_this._listId.getSync()===groupInfo._id[0]&&_this.list.scrollToIdAndSelect(groupInfo._id[1])}),this.onremove=function(){_this._searchResultStreamDependency&&_this._searchResultStreamDependency.end(!0)}}return _createClass(UserListView,[{key:"_loadAdmins",value:function(){var _this2=this,adminGroupMembership=logins.getUserController().user.memberships.find(function(gm){return gm.groupType===GroupType.Admin});return null==adminGroupMembership?Promise.resolve():loadAll(GroupMemberTypeRef,adminGroupMembership.groupMember[0]).map(function(adminGroupMember){return adminGroupMember.userGroupInfo[1]}).then(function(userGroupInfoIds){_this2._adminUserGroupInfoIds=userGroupInfoIds})}},{key:"_setLoadedCompletely",value:function(){this.list.setLoadedCompletely()}},{key:"elementSelected",value:function(groupInfos,elementClicked,selectionChanged,multiSelectOperation){0===groupInfos.length&&this._settingsView.detailsViewer?(this._settingsView.detailsViewer=null,m.redraw()):1===groupInfos.length&&selectionChanged?(this._settingsView.detailsViewer=new UserViewer(groupInfos[0],this.isAdmin(groupInfos[0])),elementClicked&&this._settingsView.focusSettingsDetailsColumn(),m.redraw()):this._settingsView.focusSettingsDetailsColumn()}},{key:"isAdmin",value:function(userGroupInfo){return contains(this._adminUserGroupInfoIds,userGroupInfo._id[1])}},{key:"addButtonClicked",value:function(){logins.getUserController().isFreeAccount()?showNotAvailableForFreeDialog(!1):AddUserDialog.show()}},{key:"entityEventsReceived",value:function(updates){var _this3=this,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_loop=function(){var update=_step.value,instanceListId=update.instanceListId,instanceId=update.instanceId,operation=update.operation;if(isUpdateForTypeRef(GroupInfoTypeRef,update)&&_this3._listId.getSync()===instanceListId)if(logins.getUserController().isGlobalAdmin())_this3.list.entityEventReceived(instanceId,operation);else{var listEntity=_this3.list.getEntity(instanceId);load(GroupInfoTypeRef,[neverNull(instanceListId),instanceId]).then(function(gi){var localAdminGroupIds=logins.getUserController().getLocalAdminGroupMemberships().map(function(gm){return gm.group});listEntity?-1===localAdminGroupIds.indexOf(gi.localAdmin)?_this3.list.entityEventReceived(instanceId,OperationType.DELETE):_this3.list.entityEventReceived(instanceId,operation):-1!==localAdminGroupIds.indexOf(gi.localAdmin)&&_this3.list.entityEventReceived(instanceId,OperationType.CREATE)})}else isUpdateForTypeRef(UserTypeRef,update)&&operation===OperationType.UPDATE&&_this3._loadAdmins().then(function(){_this3.list.redraw()})},_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)_loop()}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}]),UserListView}()),_export("UserListView",UserListView),_export("UserRow",UserRow=function(){function UserRow(userListView){_classCallCheck(this,UserRow),this._userListView=userListView,this.top=0,this.entity=null}return _createClass(UserRow,[{key:"update",value:function(groupInfo,selected){this.domElement&&(selected?this.domElement.classList.add("row-selected"):this.domElement.classList.remove("row-selected"),this._domName.textContent=groupInfo.name,this._domAddress.textContent=groupInfo.mailAddress?groupInfo.mailAddress:"",this._userListView.isAdmin(groupInfo)?this._domAdminIcon.style.display="":this._domAdminIcon.style.display="none",groupInfo.deleted?this._domDeletedIcon.style.display="":this._domDeletedIcon.style.display="none")}},{key:"render",value:function(){var _this4=this;return[m(".top",[m(".name",{oncreate:function(vnode){return _this4._domName=vnode.dom}})]),m(".bottom.flex-space-between",[m("small.mail-address",{oncreate:function(vnode){return _this4._domAddress=vnode.dom}}),m(".icons.flex",[m(Icon,{icon:BootIcons.Settings,oncreate:function(vnode){return _this4._domAdminIcon=vnode.dom},class:"svg-list-accent-fg",title:lang.get("administrator_label"),style:{display:"none"}}),m(Icon,{icon:Icons.Trash,oncreate:function(vnode){return _this4._domDeletedIcon=vnode.dom},class:"svg-list-accent-fg",style:{display:"none"}})])])]}}]),UserRow}()),_export("UserRow",UserRow)}}}),System.register("src/settings/GroupListView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/List","../api/main/Entity","../api/common/EntityFunctions","../api/Env","../misc/LanguageViewModel","../api/common/error/RestError","../gui/size","../api/entities/sys/GroupInfo","../api/entities/sys/Customer","../api/common/utils/Utils","./SettingsView","../api/common/utils/LazyLoaded","../api/main/LoginController","./GroupViewer","./AddGroupDialog","../gui/base/Icon","../gui/base/icons/Icons","../api/common/TutanotaConstants","../gui/base/icons/BootIcons","../gui/base/Header","../search/SearchUtils","../api/entities/sys/GroupMember","../api/main/EventController","../gui/base/ButtonN","../misc/ErrorHandlerImpl"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,List,load,loadAll,GENERATED_MAX_ID,assertMainOrNode,lang,NotFoundError,size,GroupInfoTypeRef,CustomerTypeRef,compareGroupInfos,neverNull,LazyLoaded,logins,GroupViewer,AddGroupDialog,Icon,Icons,OperationType,BootIcons,header,isAdministratedGroup,GroupMemberTypeRef,isUpdateForTypeRef,ButtonN,ButtonType,showNotAvailableForFreeDialog,className,GroupListView,GroupRow;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseList){List=_guiBaseList.List},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll},function(_apiCommonEntityFunctions){GENERATED_MAX_ID=_apiCommonEntityFunctions.GENERATED_MAX_ID},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiSize){size=_guiSize.size},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiCommonUtilsUtils){compareGroupInfos=_apiCommonUtilsUtils.compareGroupInfos,neverNull=_apiCommonUtilsUtils.neverNull},function(_SettingsView){_SettingsView.SettingsView},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_GroupViewer){GroupViewer=_GroupViewer.GroupViewer},function(_AddGroupDialog){AddGroupDialog=_AddGroupDialog},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiCommonTutanotaConstants){OperationType=_apiCommonTutanotaConstants.OperationType},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_guiBaseHeader){header=_guiBaseHeader.header},function(_searchSearchUtils){isAdministratedGroup=_searchSearchUtils.isAdministratedGroup},function(_apiEntitiesSysGroupMember){GroupMemberTypeRef=_apiEntitiesSysGroupMember.GroupMemberTypeRef},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog}],execute:function(){assertMainOrNode(),className="group-list",_export("GroupListView",GroupListView=function(){function GroupListView(settingsView){var _this=this;_classCallCheck(this,GroupListView),this._settingsView=settingsView,this._listId=new LazyLoaded(function(){return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return customer.teamGroups})}),this._localAdminGroupMemberships=logins.getUserController().getLocalAdminGroupMemberships(),this.list=new List({rowHeight:size.list_row_height,fetch:function(startId,count){if(startId===GENERATED_MAX_ID)return _this._listId.getAsync().then(function(listId){return loadAll(GroupInfoTypeRef,listId).then(function(allGroupInfos){if(_this._setLoadedCompletely(),logins.getUserController().isGlobalAdmin())return allGroupInfos;var localAdminGroupIds=logins.getUserController().getLocalAdminGroupMemberships().map(function(gm){return gm.group});return allGroupInfos.filter(function(gi){return isAdministratedGroup(localAdminGroupIds,gi)})})});throw new Error("fetch user group infos called for specific start id")},loadSingle:function(elementId){return _this._listId.getAsync().then(function(listId){return load(GroupInfoTypeRef,[listId,elementId]).catch(NotFoundError,function(e){})})},sortCompare:compareGroupInfos,elementSelected:function(entities,elementClicked,selectionChanged,multiSelectionActive){return _this.elementSelected(entities,elementClicked,selectionChanged,multiSelectionActive)},createVirtualRow:function(){return new GroupRow},showStatus:!1,className:className,swipe:{renderLeftSpacer:function(){return[]},renderRightSpacer:function(){return[]},swipeLeft:function(listElement){return Promise.resolve()},swipeRight:function(listElement){return Promise.resolve()},enabled:!1},elementsDraggable:!1,multiSelectionAllowed:!1,emptyMessage:lang.get("noEntries_msg")}),this.view=function(){return m(".flex.flex-column.fill-absolute",[m(".flex.flex-column.justify-center.plr-l.list-border-right.list-bg.list-header",m(".mr-negative-s.align-self-end",m(ButtonN,{label:"addGroup_label",type:ButtonType.Primary,click:function(){return _this.addButtonClicked()}}))),m(".rel.flex-grow",m(_this.list))])},this.list.loadInitial();var searchBar=neverNull(header.searchBar);this._listId.getAsync().then(function(listId){searchBar.setGroupInfoRestrictionListId(listId)}),this._searchResultStreamDependency=searchBar.lastSelectedGroupInfoResult.map(function(groupInfo){_this._listId.isLoaded()&&_this._listId.getSync()===groupInfo._id[0]&&_this.list.scrollToIdAndSelect(groupInfo._id[1])}),this.onremove=function(){_this._searchResultStreamDependency&&_this._searchResultStreamDependency.end(!0)}}return _createClass(GroupListView,[{key:"_setLoadedCompletely",value:function(){this.list.setLoadedCompletely()}},{key:"elementSelected",value:function(groupInfos,elementClicked,selectionChanged,multiSelectOperation){0===groupInfos.length&&this._settingsView.detailsViewer?(this._settingsView.detailsViewer=null,m.redraw()):1===groupInfos.length&&selectionChanged&&(this._settingsView.detailsViewer=new GroupViewer(groupInfos[0]),elementClicked&&this._settingsView.focusSettingsDetailsColumn(),m.redraw())}},{key:"addButtonClicked",value:function(){logins.getUserController().isFreeAccount()?showNotAvailableForFreeDialog(!1):AddGroupDialog.show()}},{key:"entityEventsReceived",value:function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var update=_step.value;this.processUpdate(update)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}},{key:"processUpdate",value:function(update){var _this2=this,instanceListId=update.instanceListId,instanceId=update.instanceId,operation=update.operation;if(isUpdateForTypeRef(GroupInfoTypeRef,update)&&this._listId.getSync()===instanceListId)if(logins.getUserController().isGlobalAdmin())this.list.entityEventReceived(instanceId,operation);else{var listEntity=this.list.getEntity(instanceId);load(GroupInfoTypeRef,[neverNull(instanceListId),instanceId]).then(function(gi){var localAdminGroupIds=logins.getUserController().getLocalAdminGroupMemberships().map(function(gm){return gm.group});listEntity?isAdministratedGroup(localAdminGroupIds,gi)?_this2.list.entityEventReceived(instanceId,operation):_this2.list.entityEventReceived(instanceId,OperationType.DELETE):isAdministratedGroup(localAdminGroupIds,gi)&&_this2.list.entityEventReceived(instanceId,OperationType.CREATE)})}else if(!logins.getUserController().isGlobalAdmin()&&isUpdateForTypeRef(GroupMemberTypeRef,update)){var oldLocalAdminGroupMembership=this._localAdminGroupMemberships.find(function(gm){return gm.groupMember[1]===instanceId}),newLocalAdminGroupMembership=logins.getUserController().getLocalAdminGroupMemberships().find(function(gm){return gm.groupMember[1]===instanceId});operation===OperationType.CREATE&&!oldLocalAdminGroupMembership&&newLocalAdminGroupMembership?this.list.entityEventReceived(newLocalAdminGroupMembership.groupInfo[1],operation):operation===OperationType.DELETE&&oldLocalAdminGroupMembership&&!newLocalAdminGroupMembership&&this.list.entityEventReceived(oldLocalAdminGroupMembership.groupInfo[1],operation),this._localAdminGroupMemberships=logins.getUserController().getLocalAdminGroupMemberships()}}}]),GroupListView}()),_export("GroupListView",GroupListView),_export("GroupRow",GroupRow=function(){function GroupRow(){_classCallCheck(this,GroupRow),this.top=0,this.entity=null}return _createClass(GroupRow,[{key:"update",value:function(groupInfo,selected){this.domElement&&(selected?this.domElement.classList.add("row-selected"):this.domElement.classList.remove("row-selected"),this._domName.textContent=groupInfo.name,this._domAddress.textContent=groupInfo.mailAddress?groupInfo.mailAddress:"",groupInfo.deleted?this._domDeletedIcon.style.display="":this._domDeletedIcon.style.display="none",groupInfo.mailAddress?(this._domLocalAdminIcon.style.display="none",this._domMailIcon.style.display=""):(this._domLocalAdminIcon.style.display="",this._domMailIcon.style.display="none"))}},{key:"render",value:function(){var _this3=this;return[m(".top",[m(".name",{oncreate:function(vnode){return _this3._domName=vnode.dom}})]),m(".bottom.flex-space-between",[m("small.mail-address",{oncreate:function(vnode){return _this3._domAddress=vnode.dom}}),m(".icons.flex",[m(Icon,{icon:Icons.Trash,oncreate:function(vnode){return _this3._domDeletedIcon=vnode.dom},class:"svg-list-accent-fg",style:{display:"none"}}),m(Icon,{icon:BootIcons.Settings,oncreate:function(vnode){return _this3._domLocalAdminIcon=vnode.dom},class:"svg-list-accent-fg",style:{display:"none"}}),m(Icon,{icon:BootIcons.Mail,oncreate:function(vnode){return _this3._domMailIcon=vnode.dom},class:"svg-list-accent-fg",style:{display:"none"}})])])]}}]),GroupRow}()),_export("GroupRow",GroupRow)}}}),System.register("src/settings/SetDomainCertificateDialog.js",["mithril","../misc/LanguageViewModel","../api/Env","../gui/base/TextField","../gui/base/Dialog","../gui/base/Button","../api/main/WorkerClient","../file/FileController","../api/common/utils/Encoding","../api/common/error/RestError","../gui/base/icons/Icons","../gui/base/ProgressDialog","../misc/FormatValidator","../gui/base/DropDownSelectorN","mithril/stream/stream.js","../api/common/TutanotaConstants","../api/common/utils/Utils"],function(_export,_context){"use strict";var m,lang,assertMainOrNode,TextField,Dialog,Button,worker,fileController,utf8Uint8ArrayToString,InvalidDataError,PreconditionFailedError,Icons,showProgressDialog,isDomainName,DropDownSelectorN,stream,CertificateType,getCertificateType,getWhitelabelDomain;function registerDomain(domain,certChainFile,privKeyFile,dialog){showProgressDialog("pleaseWait_msg",worker.uploadCertificate(domain,certChainFile&&utf8Uint8ArrayToString(certChainFile.data),privKeyFile&&utf8Uint8ArrayToString(privKeyFile.data)).then(function(){dialog.close()}).catch(InvalidDataError,function(e){Dialog.error("certificateError_msg")}).catch(PreconditionFailedError,function(e){switch(e.data){case"lock.locked":Dialog.error("operationStillActive_msg");break;case"domain.invalid_cname":Dialog.error("invalidCnameRecord_msg");break;case"domain.not_a_subdomain":Dialog.error("notASubdomain_msg");break;case"domain.invalid":case"domain.exists":Dialog.error("customDomainErrorDomainNotAvailable_msg");break;default:throw e}}))}return _export("show",function(customerInfo,certificateInfo){var whitelabelDomainInfo=getWhitelabelDomain(customerInfo),domainField=void 0;domainField=whitelabelDomainInfo?new TextField("whitelabelDomain_label").setValue(whitelabelDomainInfo.domain).setDisabled():new TextField("whitelabelDomain_label");var certChainFile=null,certificateChainField=new TextField("certificateChain_label",function(){return lang.get("certificateChainInfo_msg")}).setValue("").setDisabled(),chooseCertificateChainButton=new Button("edit_action",function(){fileController.showFileChooser(!1).then(function(files){certChainFile=files[0],certificateChainField.setValue(certChainFile.name),m.redraw()})},function(){return Icons.Edit});certificateChainField._injectionsRight=function(){return[m(chooseCertificateChainButton)]};var privKeyFile=null,privateKeyField=new TextField("privateKey_label",function(){return lang.get("privateKeyInfo_msg")}).setValue("").setDisabled(),choosePrivateKeyButton=new Button("edit_action",function(){fileController.showFileChooser(!1).then(function(files){privKeyFile=files[0],privateKeyField.setValue(privKeyFile.name),m.redraw()})},function(){return Icons.Edit});privateKeyField._injectionsRight=function(){return[m(choosePrivateKeyButton)]};var selectedType=stream(certificateInfo?getCertificateType(certificateInfo):CertificateType.LETS_ENCRYPT),certOptionDropDownAttrs={label:"certificateType_label",items:[{name:lang.get("certificateTypeAutomatic_label"),value:CertificateType.LETS_ENCRYPT},{name:lang.get("certificateTypeManual_label"),value:CertificateType.MANUAL}],selectedValue:selectedType,dropdownWidth:250},form={view:function(){return[m(domainField),m(DropDownSelectorN,certOptionDropDownAttrs)].concat(selectedType()===CertificateType.MANUAL?[m(certificateChainField),m(privateKeyField)]:null)}},dialog=Dialog.showActionDialog({title:lang.get("whitelabelDomain_label"),child:form,okAction:function(){var domain=domainField.value().trim().toLowerCase();if(!isDomainName(domain)||domain.split(".").length<3)Dialog.error("notASubdomain_msg");else if(customerInfo.domainInfos.find(function(di){return!di.whitelabelConfig&&di.domain===domain}))Dialog.error("customDomainErrorDomainNotAvailable_msg");else if(selectedType()===CertificateType.LETS_ENCRYPT)registerDomain(domain,null,null,dialog);else if(certChainFile)if(privKeyFile)try{registerDomain(domain,certChainFile,privKeyFile,dialog)}catch(e){Dialog.error("certificateError_msg")}else Dialog.error("privateKeyInfo_msg");else Dialog.error("certificateChainInfo_msg")}})}),{setters:[function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_fileFileController){fileController=_fileFileController.fileController},function(_apiCommonUtilsEncoding){utf8Uint8ArrayToString=_apiCommonUtilsEncoding.utf8Uint8ArrayToString},function(_apiCommonErrorRestError){InvalidDataError=_apiCommonErrorRestError.InvalidDataError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_miscFormatValidator){isDomainName=_miscFormatValidator.isDomainName},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiCommonTutanotaConstants){CertificateType=_apiCommonTutanotaConstants.CertificateType,getCertificateType=_apiCommonTutanotaConstants.getCertificateType},function(_apiCommonUtilsUtils){getWhitelabelDomain=_apiCommonUtilsUtils.getWhitelabelDomain}],execute:function(){assertMainOrNode()}}}),System.register("src/settings/EditCustomColorsDialog.js",["mithril","../misc/LanguageViewModel","../api/Env","../gui/base/TextField","../gui/base/Dialog","../gui/base/ButtonN","../gui/theme","../api/main/Entity","../api/common/TutanotaConstants"],function(_export,_context){"use strict";var m,lang,assertMainOrNode,TextField,Dialog,ButtonType,defaultTheme,theme,updateCustomTheme,update,Keys,COLOR_FORMAT;function getValidColorValue(field){var colorValue=field.value().trim();return colorValue&&COLOR_FORMAT.test(colorValue)?colorValue:null}function _getDefaultColorLine(field){var colorValue=getValidColorValue(field);if(!field.value().trim()||colorValue){var colorName=field.label();return m(".small.flex-space-between",[m("",lang.get("defaultColor_label",{"{1}":defaultTheme[colorName]})),m("",{style:{width:"100px",height:"10px","margin-top":"2px","background-color":defaultTheme[colorName]}})])}return m(".small",lang.get("invalidInputFormat_msg"))}return _export("show",function(whitelabelConfig,themeToEdit){var colorFields=Object.keys(defaultTheme).filter(function(name){return"logo"!==name}).sort(function(a,b){return a.localeCompare(b)}).map(function(colorName){var value=themeToEdit[colorName],field=new TextField(function(){return colorName}).setValue(value||"");return field._injectionsRight=function(){return[m("",{style:{width:"106px",height:"20px","margin-bottom":"2px","background-color":getValidColorValue(field)||theme.content_bg}})]},field}),nbrOfLeftColors=Math.ceil(colorFields.length/2),leftColumns=colorFields.slice(0,nbrOfLeftColors),rightColumns=colorFields.slice(nbrOfLeftColors),form={view:function(){return m(".pb",[m(".small.mt",lang.get("customColorsInfo_msg")),m(".wrapping-row",[m("",leftColumns.map(function(c){return m("",[m(c),_getDefaultColorLine(c)])})),m("",rightColumns.map(function(c){return m("",[m(c),_getDefaultColorLine(c)])}))])])}},cancelAction=function(){return dialog.close()},actionBarAttrs={left:[{label:"cancel_action",click:cancelAction,type:ButtonType.Secondary}],right:[{label:"ok_action",click:function(){for(var newTheme=themeToEdit.logo?{logo:themeToEdit.logo}:{},i=0;i<colorFields.length;i++){var colorValue=colorFields[i].value().trim();if(colorValue){if(!COLOR_FORMAT.test(colorValue))return void Dialog.error("correctValues_msg");newTheme[colorFields[i].label()]=colorValue}}whitelabelConfig.jsonTheme=JSON.stringify(newTheme),update(whitelabelConfig),updateCustomTheme(newTheme),dialog.close()},type:ButtonType.Primary}],middle:function(){return lang.get("customColors_label")}},dialog=Dialog.largeDialog(actionBarAttrs,form).addShortcut({key:Keys.ESC,exec:cancelAction,help:"close_alt"}).setCloseHandler(cancelAction).show()}),{setters:[function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType},function(_guiTheme){defaultTheme=_guiTheme.defaultTheme,theme=_guiTheme.theme,updateCustomTheme=_guiTheme.updateCustomTheme},function(_apiMainEntity){update=_apiMainEntity.update},function(_apiCommonTutanotaConstants){Keys=_apiCommonTutanotaConstants.Keys}],execute:function(){assertMainOrNode(),COLOR_FORMAT=new RegExp("^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$")}}}),System.register("src/settings/EditNotificationEmailDialog.js",["../api/entities/sys/NotificationMailTemplate","../gui/base/HtmlEditor","../misc/LanguageViewModel","mithril/stream/stream.js","../gui/base/Dialog","mithril","../gui/base/DropDownSelectorN","../gui/base/TextFieldN","../gui/base/ProgressDialog","../api/main/Entity","../api/common/utils/LazyLoaded","../misc/HtmlSanitizer","../api/common/utils/Utils","../api/main/LoginController","../api/entities/sys/CustomerInfo","../mail/MailUtils","../api/common/error/RestError","../gui/base/SegmentControl"],function(_export,_context){"use strict";var createNotificationMailTemplate,HtmlEditor,lang,languages,stream,Dialog,DialogType,m,DropDownSelectorN,TextFieldN,showProgressDialog,load,update,htmlSanitizer,getWhitelabelDomain,neverNull,logins,CustomerInfoTypeRef,insertInlineImageB64ClickHandler,PreconditionFailedError,SegmentControl,HTML_PTAG_START,HTML_PTAG_END;return _export("show",function(existingTemplate,customerProperties){var template=void 0;existingTemplate?template=existingTemplate:((template=createNotificationMailTemplate()).language="en",template.body=HTML_PTAG_START+lang.get("externalNotificationMailBody1_msg")+HTML_PTAG_END+HTML_PTAG_START+lang.get("externalNotificationMailBody2_msg",{"{1}":"https://tutanota.com"})+HTML_PTAG_END+HTML_PTAG_START+"<a href='{link}'>"+lang.get("externalNotificationMailBody3_msg")+"</a>"+HTML_PTAG_END+HTML_PTAG_START+lang.get("externalNotificationMailBody4_msg")+"<br>{link}<br>"+HTML_PTAG_END+HTML_PTAG_START+lang.get("externalNotificationMailBody5_msg")+HTML_PTAG_END+HTML_PTAG_START+lang.get("externalNotificationMailBody6_msg")+"<br>{sender}"+HTML_PTAG_END,template.subject=lang.get("externalNotificationMailSubject_msg",{"{1}":"{sender}"}));var editor=new HtmlEditor(null,{enabled:!0,imageButtonClickHandler:insertInlineImageB64ClickHandler}).setMinHeight(400).showBorders().setModeSwitcher("mailBody_label").setValue(template.body),editSegment={name:lang.get("edit_action"),value:"edit"},previewSegment={name:lang.get("preview_label"),value:"preview"},selectedTab=stream(editSegment.value),sortedLanguages=languages.slice().sort(function(a,b){return lang.get(a.textId).localeCompare(lang.get(b.textId))}).map(function(language){return{name:lang.get(language.textId),value:language.code}}),selectedLanguage=sortedLanguages.find(function(_ref){return _ref.value===template.language}),selectedLanguageStream=stream(selectedLanguage&&selectedLanguage.value),subject=stream(template.subject),savedHtml=editor.getValue();selectedTab.map(function(tab){tab===editSegment?editor.setValue(savedHtml):savedHtml=editor.getValue()});var senderName=logins.getUserController().userGroupInfo.name,senderDomain="https://mail.tutanota.com";logins.getUserController().loadCustomer().then(function(customer){return load(CustomerInfoTypeRef,customer.customerInfo)}).then(function(customerInfo){var whitelabelDomainInfo=customerInfo&&getWhitelabelDomain(customerInfo);senderDomain="https://"+(whitelabelDomainInfo&&whitelabelDomainInfo.domain||"mail.tutanota.com"),m.redraw()}),Dialog.showActionDialog({type:DialogType.EditLarge,title:lang.get("edit_action"),child:function(){return[m(SegmentControl,{items:[editSegment,previewSegment],selectedValue:selectedTab}),selectedTab()===editSegment.value?[m(".small.mt-s",lang.get("templateHelp_msg")),existingTemplate?m(TextFieldN,{label:"notificationMailLanguage_label",disabled:!0,value:stream(neverNull(selectedLanguage).name)}):m(DropDownSelectorN,{label:"notificationMailLanguage_label",items:sortedLanguages,selectedValue:selectedLanguageStream,dropdownWidth:250}),m(TextFieldN,{label:"subject_label",value:subject}),m(editor)]:[m(TextFieldN,{label:"subject_label",value:stream(subject().replace(/{sender}/g,senderName)),disabled:!0}),m(".small.mt.mb",lang.get("mailBody_label")),m.trust(savedHtml.replace(/{sender}/g,senderName).replace(/{link}/g,senderDomain))]]},okAction:function(dialog){editor.getValue().includes("{link}")?showProgressDialog("pleaseWait_msg",customerProperties.getAsync().then(function(customerProperties){if(customerProperties.notificationMailTemplates.filter(function(t){return t!==existingTemplate&&t.language===selectedLanguageStream()}).length>0)Dialog.error("templateLanguageExists_msg");else{template.subject=htmlSanitizer.sanitize(subject(),!1).text,template.body=htmlSanitizer.sanitize(editor.getValue(),!1).text,template.language=selectedLanguageStream();var index=customerProperties.notificationMailTemplates.findIndex(function(t){return t===template});-1!==index?customerProperties.notificationMailTemplates[index]=template:customerProperties.notificationMailTemplates.push(template),update(customerProperties).then(function(){return dialog.close()}).catch(PreconditionFailedError,function(){Dialog.error("notificationMailTemplateTooLarge_msg")})}})):Dialog.error(function(){return lang.get("templateMustContain_msg",{"{value}":"{link}"})})}})}),{setters:[function(_apiEntitiesSysNotificationMailTemplate){createNotificationMailTemplate=_apiEntitiesSysNotificationMailTemplate.createNotificationMailTemplate},function(_guiBaseHtmlEditor){HtmlEditor=_guiBaseHtmlEditor.HtmlEditor},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang,languages=_miscLanguageViewModel.languages},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_mithril){m=_mithril.default},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiMainEntity){load=_apiMainEntity.load,update=_apiMainEntity.update},function(_apiCommonUtilsLazyLoaded){_apiCommonUtilsLazyLoaded.LazyLoaded},function(_miscHtmlSanitizer){htmlSanitizer=_miscHtmlSanitizer.htmlSanitizer},function(_apiCommonUtilsUtils){getWhitelabelDomain=_apiCommonUtilsUtils.getWhitelabelDomain,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_mailMailUtils){insertInlineImageB64ClickHandler=_mailMailUtils.insertInlineImageB64ClickHandler},function(_apiCommonErrorRestError){PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_guiBaseSegmentControl){SegmentControl=_guiBaseSegmentControl.SegmentControl}],execute:function(){HTML_PTAG_START="<p>",HTML_PTAG_END="</p>"}}}),System.register("src/settings/WhitelabelSettingsViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/slicedToArray.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../api/common/utils/LazyLoaded","../api/entities/sys/Customer","../api/main/Entity","../api/common/utils/Utils","../api/entities/sys/CustomerInfo","../api/main/LoginController","../misc/LanguageViewModel","../gui/base/Dialog","./SetDomainCertificateDialog","../api/common/TutanotaConstants","../api/common/EntityFunctions","../gui/base/TextField","../gui/base/Button","./EditCustomColorsDialog","../api/main/WorkerClient","mithril/stream/stream.js","../file/FileController","../api/entities/sys/WhitelabelConfig","../gui/theme","../api/common/utils/Encoding","../api/common/utils/ArrayUtils","../misc/Formatter","../gui/base/Icon","../gui/base/icons/Icons","../gui/base/ProgressDialog","../gui/base/DropDownSelector","../api/entities/sys/StringWrapper","../misc/ErrorHandlerImpl","../gui/base/DatePicker","../api/entities/tutanota/CustomerContactFormGroupRoot","../api/entities/tutanota/ContactForm","../api/common/DataFile","../api/entities/tutanota/File","../api/common/utils/DateUtils","../api/entities/tutanota/UnencryptedStatisticLogEntry","../api/entities/sys/Booking","../subscription/PriceUtils","../subscription/WhitelabelAndSharingBuyDialog","../api/main/EventController","../gui/base/TableN","../gui/base/ButtonN","../api/entities/sys/CustomerProperties","../gui/base/DropdownN","./EditNotificationEmailDialog","../gui/base/TextFieldN","../subscription/SubscriptionUtils","../gui/base/ExpanderN","../calendar/CalendarUtils","../api/entities/sys/Services","../api/entities/sys/BrandingDomainGetReturn","../api/common/error/RestError"],function(_export,_context){"use strict";var _slicedToArray,_classCallCheck,_createClass,m,assertMainOrNode,LazyLoaded,CustomerTypeRef,load,loadAll,loadRange,serviceRequest,update,getCustomMailDomains,getWhitelabelDomain,neverNull,CustomerInfoTypeRef,logins,lang,languageByCode,Dialog,SetCustomDomainCertificateDialog,ALLOWED_IMAGE_FORMATS,CertificateState,CertificateType,FeatureType,MAX_LOGO_SIZE,OperationType,CUSTOM_MIN_ID,GENERATED_MAX_ID,HttpMethod,TextField,Type,Button,EditCustomColorsDialog,worker,stream,fileController,WhitelabelConfigTypeRef,updateCustomTheme,stringToUtf8Uint8Array,timestampToGeneratedId,uint8ArrayToBase64,utf8Uint8ArrayToString,contains,formatDateTime,formatSortableDate,progressIcon,Icons,showProgressDialog,DropDownSelector,createStringWrapper,showNotAvailableForFreeDialog,DatePicker,CustomerContactFormGroupRootTypeRef,ContactFormTypeRef,createDataFile,createFile,DAY_IN_MILLIS,UnencryptedStatisticLogEntryTypeRef,BookingTypeRef,createNotAvailableForFreeClickHandler,WhitelabelBuyDialog,isUpdateForTypeRef,ColumnWidth,TableN,ButtonN,ButtonType,CustomerPropertiesTypeRef,attachDropdown,EditNotificationEmailDialog,TextFieldN,isWhitelabelActive,ExpanderButtonN,ExpanderPanelN,getStartOfTheWeekOffsetForUser,SysService,BrandingDomainGetReturnTypeRef,PreconditionFailedError,WhitelabelSettingsViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs){_slicedToArray=_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,loadRange=_apiMainEntity.loadRange,serviceRequest=_apiMainEntity.serviceRequest,update=_apiMainEntity.update},function(_apiCommonUtilsUtils){getCustomMailDomains=_apiCommonUtilsUtils.getCustomMailDomains,getWhitelabelDomain=_apiCommonUtilsUtils.getWhitelabelDomain,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang,languageByCode=_miscLanguageViewModel.languageByCode},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_SetDomainCertificateDialog){SetCustomDomainCertificateDialog=_SetDomainCertificateDialog},function(_apiCommonTutanotaConstants){ALLOWED_IMAGE_FORMATS=_apiCommonTutanotaConstants.ALLOWED_IMAGE_FORMATS,CertificateState=_apiCommonTutanotaConstants.CertificateState,CertificateType=_apiCommonTutanotaConstants.CertificateType,FeatureType=_apiCommonTutanotaConstants.FeatureType,MAX_LOGO_SIZE=_apiCommonTutanotaConstants.MAX_LOGO_SIZE,OperationType=_apiCommonTutanotaConstants.OperationType},function(_apiCommonEntityFunctions){CUSTOM_MIN_ID=_apiCommonEntityFunctions.CUSTOM_MIN_ID,GENERATED_MAX_ID=_apiCommonEntityFunctions.GENERATED_MAX_ID,HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField,Type=_guiBaseTextField.Type},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_EditCustomColorsDialog){EditCustomColorsDialog=_EditCustomColorsDialog},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_fileFileController){fileController=_fileFileController.fileController},function(_apiEntitiesSysWhitelabelConfig){WhitelabelConfigTypeRef=_apiEntitiesSysWhitelabelConfig.WhitelabelConfigTypeRef},function(_guiTheme){updateCustomTheme=_guiTheme.updateCustomTheme},function(_apiCommonUtilsEncoding){stringToUtf8Uint8Array=_apiCommonUtilsEncoding.stringToUtf8Uint8Array,timestampToGeneratedId=_apiCommonUtilsEncoding.timestampToGeneratedId,uint8ArrayToBase64=_apiCommonUtilsEncoding.uint8ArrayToBase64,utf8Uint8ArrayToString=_apiCommonUtilsEncoding.utf8Uint8ArrayToString},function(_apiCommonUtilsArrayUtils){contains=_apiCommonUtilsArrayUtils.contains},function(_miscFormatter){formatDateTime=_miscFormatter.formatDateTime,formatSortableDate=_miscFormatter.formatSortableDate},function(_guiBaseIcon){progressIcon=_guiBaseIcon.progressIcon},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_apiEntitiesSysStringWrapper){createStringWrapper=_apiEntitiesSysStringWrapper.createStringWrapper},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog},function(_guiBaseDatePicker){DatePicker=_guiBaseDatePicker.DatePicker},function(_apiEntitiesTutanotaCustomerContactFormGroupRoot){CustomerContactFormGroupRootTypeRef=_apiEntitiesTutanotaCustomerContactFormGroupRoot.CustomerContactFormGroupRootTypeRef},function(_apiEntitiesTutanotaContactForm){ContactFormTypeRef=_apiEntitiesTutanotaContactForm.ContactFormTypeRef},function(_apiCommonDataFile){createDataFile=_apiCommonDataFile.createDataFile},function(_apiEntitiesTutanotaFile){createFile=_apiEntitiesTutanotaFile.createFile},function(_apiCommonUtilsDateUtils){DAY_IN_MILLIS=_apiCommonUtilsDateUtils.DAY_IN_MILLIS},function(_apiEntitiesTutanotaUnencryptedStatisticLogEntry){UnencryptedStatisticLogEntryTypeRef=_apiEntitiesTutanotaUnencryptedStatisticLogEntry.UnencryptedStatisticLogEntryTypeRef},function(_apiEntitiesSysBooking){BookingTypeRef=_apiEntitiesSysBooking.BookingTypeRef},function(_subscriptionPriceUtils){createNotAvailableForFreeClickHandler=_subscriptionPriceUtils.createNotAvailableForFreeClickHandler},function(_subscriptionWhitelabelAndSharingBuyDialog){WhitelabelBuyDialog=_subscriptionWhitelabelAndSharingBuyDialog},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth,TableN=_guiBaseTableN.TableN},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_apiEntitiesSysCustomerProperties){CustomerPropertiesTypeRef=_apiEntitiesSysCustomerProperties.CustomerPropertiesTypeRef},function(_guiBaseDropdownN){attachDropdown=_guiBaseDropdownN.attachDropdown},function(_EditNotificationEmailDialog){EditNotificationEmailDialog=_EditNotificationEmailDialog},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_subscriptionSubscriptionUtils){isWhitelabelActive=_subscriptionSubscriptionUtils.isWhitelabelActive},function(_guiBaseExpanderN){ExpanderButtonN=_guiBaseExpanderN.ExpanderButtonN,ExpanderPanelN=_guiBaseExpanderN.ExpanderPanelN},function(_calendarCalendarUtils){getStartOfTheWeekOffsetForUser=_calendarCalendarUtils.getStartOfTheWeekOffsetForUser},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiEntitiesSysBrandingDomainGetReturn){BrandingDomainGetReturnTypeRef=_apiEntitiesSysBrandingDomainGetReturn.BrandingDomainGetReturnTypeRef},function(_apiCommonErrorRestError){PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError}],execute:function(){assertMainOrNode(),_export("WhitelabelSettingsViewer",WhitelabelSettingsViewer=function(){function WhitelabelSettingsViewer(){var _this=this;_classCallCheck(this,WhitelabelSettingsViewer),this._customer=new LazyLoaded(function(){return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer))}),this._customerInfo=new LazyLoaded(function(){return _this._customer.getAsync().then(function(customer){return load(CustomerInfoTypeRef,customer.customerInfo)})}),this._customerProperties=new LazyLoaded(function(){return _this._customer.getAsync().then(function(customer){return load(CustomerPropertiesTypeRef,neverNull(customer.properties))})}),this._whitelabelStatusField={label:"state_label",value:stream(lang.get("loading_msg")),disabled:!0},this._notificationEmailsExpanded=stream(!1),this._lastBooking=null,this._updateFields(),this._contactFormsExist=null,this._customer.getAsync().then(function(customer){load(CustomerContactFormGroupRootTypeRef,customer.customerGroup).then(function(root){loadRange(ContactFormTypeRef,root.contactForms,CUSTOM_MIN_ID,1,!1).then(function(contactForms){_this._contactFormsExist=contactForms.length>0,m.redraw()})})});var startOfTheWeekOffset=getStartOfTheWeekOffsetForUser(),contactFormReportFrom=new DatePicker(startOfTheWeekOffset,"dateFrom_label"),contactFormReportTo=new DatePicker(startOfTheWeekOffset,"dateTo_label");contactFormReportFrom.setDate(new Date),contactFormReportTo.setDate(new Date);var contactFormReportButton=new Button("export_action",function(){return _this._contactFormReport(contactFormReportFrom.date(),contactFormReportTo.date())},function(){return Icons.Export});this.view=function(){return[m("#global-settings.fill-absolute.scroll.plr-l",_this._brandingDomainField?[m(".h4.mt-l",lang.get("whitelabel_label")),m(".small",lang.get("whitelabelDomainLinkInfo_msg")+" "),m("small.text-break",[m("a[href="+lang.getInfoLink("whitelabel_link")+"][target=_blank]",lang.getInfoLink("whitelabel_link"))]),m(TextFieldN,_this._whitelabelStatusField),_this.notificationEmailSettings(),m(".h4.mt-l",lang.get("whitelabelDomain_label")),m(_this._brandingDomainField),m(_this._customLogoField),m(_this._customColorsField),m(_this._customMetaTagsField),m(_this._whitelabelImprintUrl),m(_this._whitelabelPrivacyUrl),_this._defaultGermanLanguageFile?m(_this._defaultGermanLanguageFile):null,_this._isWhitelabelRegistrationVisible()?m("",[m(_this._whitelabelRegistrationDomains),m(_this._whitelabelCodeField)]):null,_this._contactFormsExist?m(".mt-l",[m(".h4",lang.get("contactFormReport_label")),m(".small",lang.get("contactFormReportInfo_msg")),m(".flex-space-between.items-center.mb-s",[m(contactFormReportFrom),m(contactFormReportTo),m(contactFormReportButton)])]):null,m(".mb-l")]:[m(".flex-center.items-center.button-height.mt-l",progressIcon())])]}}return _createClass(WhitelabelSettingsViewer,[{key:"_isWhitelabelRegistrationVisible",value:function(){return this._customer.isLoaded()&&this._customer.getLoaded().customizations.find(function(c){return c.feature===FeatureType.WhitelabelParent})&&this._customerInfo.isLoaded()&&getWhitelabelDomain(this._customerInfo.getLoaded())&&this._whitelabelCodeField&&this._whitelabelRegistrationDomains}},{key:"_tryLoadWhitelabelConfig",value:function(domainInfo){return domainInfo&&domainInfo.whitelabelConfig?Promise.all([load(WhitelabelConfigTypeRef,domainInfo.whitelabelConfig),serviceRequest(SysService.BrandingDomainService,HttpMethod.GET,null,BrandingDomainGetReturnTypeRef).then(function(response){return response.certificateInfo})]).then(function(_ref){var _ref2=_slicedToArray(_ref,2);return{whitelabelConfig:_ref2[0],certificateInfo:_ref2[1]}}):Promise.resolve(null)}},{key:"_updateFields",value:function(){var _this2=this;this._customerInfo.getAsync().then(function(customerInfo){var whitelabelDomainInfo=getWhitelabelDomain(customerInfo);return _this2._tryLoadWhitelabelConfig(whitelabelDomainInfo).then(function(data){var whitelabelConfig=data&&data.whitelabelConfig,certificateInfo=data&&data.certificateInfo;loadRange(BookingTypeRef,neverNull(customerInfo.bookings).items,GENERATED_MAX_ID,1,!0).then(function(bookings){_this2._lastBooking=1===bookings.length?bookings[0]:null;var whitelabelActive=isWhitelabelActive(_this2._lastBooking),enableWhiteLabelAction={label:"whitelabelDomain_label",click:createNotAvailableForFreeClickHandler(!1,function(){return WhitelabelBuyDialog.showWhitelabelBuyDialog(!0)},function(){return logins.getUserController().isPremiumAccount()}),icon:function(){return Icons.Edit}},disableWhiteLabelAction={label:"whitelabelDomain_label",click:createNotAvailableForFreeClickHandler(!1,function(){return WhitelabelBuyDialog.showWhitelabelBuyDialog(!1)},function(){return logins.getUserController().isPremiumAccount()}),icon:function(){return Icons.Cancel}};_this2._whitelabelStatusField.value(whitelabelActive?lang.get("active_label"):lang.get("deactivated_label")),_this2._whitelabelStatusField.injectionsRight=function(){return m(ButtonN,whitelabelActive?disableWhiteLabelAction:enableWhiteLabelAction)};var customJsonTheme=whitelabelConfig?JSON.parse(whitelabelConfig.jsonTheme):null;_this2._brandingDomainField=new TextField("whitelabelDomain_label",_this2._whitelabelInfo(certificateInfo)).setValue(whitelabelDomainInfo?whitelabelDomainInfo.domain:lang.get("deactivated_label")).setDisabled();var deactivateAction=null;whitelabelDomainInfo&&(deactivateAction=new Button("deactivate_action",function(){Dialog.confirm("confirmDeactivateWhitelabelDomain_msg").then(function(ok){ok&&showProgressDialog("pleaseWait_msg",worker.deleteCertificate(neverNull(whitelabelDomainInfo).domain)).catch(PreconditionFailedError,function(e){if("lock.locked"!==e.data)throw e;Dialog.error("operationStillActive_msg")})})},function(){return Icons.Cancel}));var editAction=new Button("edit_action",function(){logins.getUserController().isFreeAccount()?showNotAvailableForFreeDialog(!1):(whitelabelActive?Promise.resolve(!1):WhitelabelBuyDialog.showWhitelabelBuyDialog(!0)).then(function(failed){failed||SetCustomDomainCertificateDialog.show(customerInfo,certificateInfo)})},function(){return Icons.Edit});_this2._brandingDomainField._injectionsRight=function(){return[deactivateAction?m(deactivateAction):null,m(editAction)]};var customLogoDefined=customJsonTheme&&customJsonTheme.logo;if(_this2._customLogoField=new TextField("customLogo_label",function(){return lang.get("customLogoInfo_msg")}).setValue(lang.get(customLogoDefined?"activated_label":"deactivated_label")).setDisabled(),customJsonTheme){var deleteCustomLogo=void 0;customLogoDefined&&(deleteCustomLogo=new Button("deactivate_action",function(){Dialog.confirm("confirmDeactivateCustomLogo_msg").then(function(ok){ok&&(delete neverNull(customJsonTheme).logo,neverNull(whitelabelConfig).jsonTheme=JSON.stringify(customJsonTheme),update(whitelabelConfig),updateCustomTheme(customJsonTheme))})},function(){return Icons.Cancel}));var chooseLogoButton=new Button("edit_action",function(){fileController.showFileChooser(!1).then(function(files){var extension=files[0].name.toLowerCase().substring(files[0].name.lastIndexOf(".")+1);if(files[0].size>MAX_LOGO_SIZE||!contains(ALLOWED_IMAGE_FORMATS,extension))Dialog.error("customLogoInfo_msg");else{var imageData=null;imageData="svg"===extension?utf8Uint8ArrayToString(files[0].data):'<img src="data:image/'+("jpeg"===extension?"jpg":extension)+";base64,"+uint8ArrayToBase64(files[0].data)+'">',neverNull(customJsonTheme).logo=imageData,neverNull(whitelabelConfig).jsonTheme=JSON.stringify(customJsonTheme),update(whitelabelConfig),updateCustomTheme(customJsonTheme),_this2._customLogoField.setValue(lang.get("activated_label")),m.redraw()}})},function(){return Icons.Edit});_this2._customLogoField._injectionsRight=function(){return[deleteCustomLogo?m(deleteCustomLogo):null,m(chooseLogoButton)]}}var customColorsDefined=_this2._areCustomColorsDefined(customJsonTheme);if(_this2._customColorsField=new TextField("customColors_label",null).setValue(customColorsDefined?lang.get("activated_label"):lang.get("deactivated_label")).setDisabled(),customJsonTheme){var deactivateColorTheme=void 0;customColorsDefined&&(deactivateColorTheme=new Button("deactivate_action",function(){Dialog.confirm("confirmDeactivateCustomColors_msg").then(function(ok){ok&&(Object.keys(neverNull(customJsonTheme)).forEach(function(key){"logo"!==key&&delete neverNull(customJsonTheme)[key]}),neverNull(whitelabelConfig).jsonTheme=JSON.stringify(customJsonTheme),update(whitelabelConfig),updateCustomTheme(customJsonTheme))})},function(){return Icons.Cancel}));var editCustomColorButton=new Button("edit_action",function(){return EditCustomColorsDialog.show(neverNull(whitelabelConfig),neverNull(customJsonTheme))},function(){return Icons.Edit});_this2._customColorsField._injectionsRight=function(){return[deactivateColorTheme?m(deactivateColorTheme):null,m(editCustomColorButton)]}}var customMetaTagsDefined=!!whitelabelConfig&&whitelabelConfig.metaTags.length>0;if(_this2._whitelabelImprintUrl=new TextField("imprintUrl_label",null).setValue(whitelabelConfig&&whitelabelConfig.imprintUrl?whitelabelConfig.imprintUrl:"").setDisabled(),_this2._whitelabelPrivacyUrl=new TextField("privacyPolicyUrl_label",null).setValue(whitelabelConfig&&whitelabelConfig.privacyStatementUrl?whitelabelConfig.privacyStatementUrl:"").setDisabled(),_this2._customMetaTagsField=new TextField("customMetaTags_label",null).setValue(customMetaTagsDefined?lang.get("activated_label"):lang.get("deactivated_label")).setDisabled(),whitelabelConfig){var editCustomMetaTagsButton=new Button("edit_action",function(){var metaTags=new TextField("customMetaTags_label").setValue(neverNull(whitelabelConfig).metaTags).setType(Type.Area),dialog=Dialog.showActionDialog({title:lang.get("customMetaTags_label"),child:{view:function(){return m(metaTags)}},okAction:function(ok){ok&&(neverNull(whitelabelConfig).metaTags=metaTags.value(),update(whitelabelConfig),dialog.close())}})},function(){return Icons.Edit});_this2._customMetaTagsField._injectionsRight=function(){return m(editCustomMetaTagsButton)};var editImprintUrlButton=new Button("edit_action",function(){var imprintUrl=new TextField("imprintUrl_label").setValue(neverNull(whitelabelConfig).imprintUrl),dialog=Dialog.showActionDialog({title:lang.get("imprintUrl_label"),child:{view:function(){return m(imprintUrl)}},allowOkWithReturn:!0,okAction:function(ok){ok&&(neverNull(whitelabelConfig).imprintUrl=imprintUrl.value()?imprintUrl.value():null,update(whitelabelConfig),dialog.close())}})},function(){return Icons.Edit}),editPrivacyUrlButton=new Button("edit_action",function(){var privacyUrl=new TextField("privacyPolicyUrl_label").setValue(neverNull(whitelabelConfig).privacyStatementUrl),dialog=Dialog.showActionDialog({title:lang.get("privacyLink_label"),child:{view:function(){return m(privacyUrl)}},allowOkWithReturn:!0,okAction:function(ok){ok&&(neverNull(whitelabelConfig).privacyStatementUrl=privacyUrl.value()?privacyUrl.value():null,update(whitelabelConfig),dialog.close())}})},function(){return Icons.Edit});_this2._whitelabelImprintUrl._injectionsRight=function(){return m(editImprintUrlButton)},_this2._whitelabelPrivacyUrl._injectionsRight=function(){return m(editPrivacyUrlButton)},_this2._whitelabelCodeField=new TextField("whitelabelRegistrationCode_label",null).setValue(whitelabelConfig.whitelabelCode).setDisabled();var editButton=new Button("edit_action",function(){Dialog.showTextInputDialog("edit_action","whitelabelRegistrationCode_label",null,_this2._whitelabelCodeField.value()).then(function(newCode){whitelabelConfig.whitelabelCode=newCode,update(whitelabelConfig)})},function(){return Icons.Edit});_this2._whitelabelCodeField._injectionsRight=function(){return[m(editButton)]};var _items=[{name:lang.get("deactivated_label"),value:null}].concat(getCustomMailDomains(customerInfo).map(function(d){return{name:d.domain,value:d.domain}})),initialValue=0===whitelabelConfig.whitelabelRegistrationDomains.length?null:whitelabelConfig.whitelabelRegistrationDomains[0].value;_this2._whitelabelRegistrationDomains=new DropDownSelector("whitelabelRegistrationEmailDomain_label",null,_items,stream(initialValue),250).setSelectionChangedHandler(function(v){if(whitelabelConfig.whitelabelRegistrationDomains.length=0,v){var domain=createStringWrapper();domain.value=v,whitelabelConfig.whitelabelRegistrationDomains.push(domain)}update(whitelabelConfig)})}var customGermanLanguageFileDefined=!(!whitelabelConfig||!whitelabelConfig.germanLanguageCode)&&whitelabelConfig.germanLanguageCode,items=[{name:"Deutsch (Du)",value:"de"},{name:"Deutsch (Sie)",value:"de_sie"}];if(whitelabelConfig&&("de"===lang.code||"de_sie"===lang.code)){var streamValue=stream(customGermanLanguageFileDefined?neverNull(whitelabelConfig.germanLanguageCode):items[0].value);_this2._defaultGermanLanguageFile=new DropDownSelector("germanLanguageFile_label",null,items,streamValue,250).setSelectionChangedHandler(function(v){v&&(neverNull(whitelabelConfig).germanLanguageCode=v,update(whitelabelConfig),lang.setLanguage({code:v,languageTag:lang.languageTag}))})}m.redraw(),_this2._customerProperties.getAsync().then(m.redraw)})})})}},{key:"_whitelabelInfo",value:function(certificateInfo){var components=void 0;if(certificateInfo)switch(certificateInfo.state){case CertificateState.VALID:components=[lang.get("certificateExpiryDate_label",{"{date}":formatDateTime(neverNull(certificateInfo.expiryDate))}),this._certificateTypeString(certificateInfo)];break;case CertificateState.VALIDATING:components=[lang.get("certificateStateProcessing_label")];break;case CertificateState.INVALID:components=[lang.get("certificateStateInvalid_label")];break;default:components=[lang.get("emptyString_msg")]}else components=[lang.get("emptyString_msg")];return function(){return m(".flex",components.map(function(c){return m(".pr-s",c)}))}}},{key:"_certificateTypeString",value:function(certificateInfo){switch(certificateInfo.type){case CertificateType.LETS_ENCRYPT:return lang.get("certificateTypeAutomatic_label");case CertificateType.MANUAL:return lang.get("certificateTypeManual_label");default:return lang.get("emptyString_msg")}}},{key:"_areCustomColorsDefined",value:function(theme){return!!theme&&null!=Object.keys(theme).find(function(key){return"logo"!==key&&neverNull(theme)[key]})}},{key:"_contactFormReport",value:function(from,to){null==from||null==to||from.getTime()>to.getTime()?Dialog.error("dateInvalidRange_msg"):showProgressDialog("loading_msg",load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerContactFormGroupRootTypeRef,customer.customerGroup)}).then(function(root){return loadAll(UnencryptedStatisticLogEntryTypeRef,neverNull(root.statisticsLog).items,timestampToGeneratedId(neverNull(from).getTime()),timestampToGeneratedId(neverNull(to).getTime()+DAY_IN_MILLIS))}).then(function(logEntries){var rows=logEntries.map(function(entry){return'"'+entry.contactFormPath+'",'+formatSortableDate(entry.date)}),csv=["path,date"].concat(rows).join("\n"),data=stringToUtf8Uint8Array(csv),tmpFile=createFile();return tmpFile.name="report.csv",tmpFile.mimeType="text/csv",tmpFile.size=String(data.byteLength),fileController.open(createDataFile(tmpFile,data))}))}},{key:"notificationEmailSettings",value:function(){var _this3=this,customerProperties=this._customerProperties.getSync();return customerProperties?[m(".flex-space-between.items-center.mt-l.mb-s",[m(".h4",lang.get("customNotificationEmails_label")),m(ExpanderButtonN,{label:"show_action",expanded:this._notificationEmailsExpanded})]),m(ExpanderPanelN,{expanded:this._notificationEmailsExpanded},m(TableN,{columnHeading:["language_label","subject_label"],columnWidths:[ColumnWidth.Largest,ColumnWidth.Largest],showActionButtonColumn:!0,addButtonAttrs:{label:"add_action",click:function(){_this3._showBuyOrSetNotificationEmailDialog()},type:ButtonType.Action,icon:function(){return Icons.Add}},lines:customerProperties.notificationMailTemplates.map(function(template){return{cells:[lang.get(languageByCode[template.language].textId),template.subject],actionButtonAttrs:attachDropdown({label:"edit_action",type:ButtonType.Action,icon:function(){return Icons.Edit}},function(){return[{label:"edit_action",click:function(){return EditNotificationEmailDialog.show(template,_this3._customerProperties)},type:ButtonType.Dropdown},{label:"remove_action",click:function(){return _this3._removeNotificationMailTemplate(template)},type:ButtonType.Dropdown}]})}})})),m(".small",lang.get("customNotificationEmailsHelp_msg"))]:null}},{key:"_showBuyOrSetNotificationEmailDialog",value:function(existingTemplate){var _this4=this;logins.getUserController().isFreeAccount()?showNotAvailableForFreeDialog(!1):(isWhitelabelActive(this._lastBooking)?Promise.resolve(!1):WhitelabelBuyDialog.showWhitelabelBuyDialog(!0)).then(function(failed){failed||EditNotificationEmailDialog.show(existingTemplate,_this4._customerProperties)})}},{key:"_removeNotificationMailTemplate",value:function(template){showProgressDialog("pleaseWait_msg",this._customerProperties.getAsync().then(function(customerProps){var index=customerProps.notificationMailTemplates.findIndex(function(t){return t.language===template.language});-1!==index&&(customerProps.notificationMailTemplates.splice(index,1),update(customerProps))}))}},{key:"entityEventsReceived",value:function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _update=_step.value;isUpdateForTypeRef(CustomerTypeRef,_update)&&_update.operation===OperationType.UPDATE?(this._customer.reset(),this._customer.getAsync().then(function(){return m.redraw()})):isUpdateForTypeRef(CustomerInfoTypeRef,_update)&&_update.operation===OperationType.UPDATE?(this._customerInfo.reset(),this._updateFields()):isUpdateForTypeRef(WhitelabelConfigTypeRef,_update)&&_update.operation===OperationType.UPDATE?this._updateFields():isUpdateForTypeRef(CustomerPropertiesTypeRef,_update)&&_update.operation===OperationType.UPDATE?(this._customerProperties.reset(),this._updateFields()):isUpdateForTypeRef(BookingTypeRef,_update)&&this._updateFields()}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}]),WhitelabelSettingsViewer}()),_export("WhitelabelSettingsViewer",WhitelabelSettingsViewer)}}}),System.register("src/settings/WhitelabelChildViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../gui/base/TextField","../api/main/Entity","../misc/Formatter","../misc/LanguageViewModel","../api/common/EntityFunctions","../gui/base/DropDownSelector","../api/common/utils/Utils","../api/common/TutanotaConstants","../gui/base/ProgressDialog","../api/entities/sys/WhitelabelChild","../gui/base/icons/Icons","../gui/base/Dialog","../gui/base/Button","mithril/stream/stream.js","../api/main/EventController"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,TextField,Type,load,update,formatDateWithMonth,lang,isSameId,DropDownSelector,neverNull,OperationType,showProgressDialog,WhitelabelChildTypeRef,Icons,Dialog,Button,stream,isUpdateForTypeRef,WhitelabelChildViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField,Type=_guiBaseTextField.Type},function(_apiMainEntity){load=_apiMainEntity.load,update=_apiMainEntity.update},function(_miscFormatter){formatDateWithMonth=_miscFormatter.formatDateWithMonth},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonEntityFunctions){isSameId=_apiCommonEntityFunctions.isSameId},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiCommonTutanotaConstants){OperationType=_apiCommonTutanotaConstants.OperationType},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiEntitiesSysWhitelabelChild){WhitelabelChildTypeRef=_apiEntitiesSysWhitelabelChild.WhitelabelChildTypeRef},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef}],execute:function(){assertMainOrNode(),_export("WhitelabelChildViewer",WhitelabelChildViewer=function(){function WhitelabelChildViewer(whitelabelChild){var _this=this;_classCallCheck(this,WhitelabelChildViewer),this.whitelabelChild=whitelabelChild,this._mailAddress=new TextField("mailAddress_label").setValue(whitelabelChild.mailAddress).setDisabled();var created=new TextField("created_label").setValue(formatDateWithMonth(whitelabelChild.createdDate)).setDisabled();this._comment=new TextField("comment_label").setType(Type.Area).setValue(whitelabelChild.comment).setDisabled();var editCommentButton=new Button("edit_action",function(){Dialog.showTextAreaInputDialog("edit_action","comment_label",null,_this._comment.value()).then(function(newComment){_this.whitelabelChild.comment=newComment,update(_this.whitelabelChild)})},function(){return Icons.Edit});this._comment._injectionsRight=function(){return[m(editCommentButton)]},this._deactivated=new DropDownSelector("state_label",null,[{name:lang.get("activated_label"),value:!1},{name:lang.get("deactivated_label"),value:!0}],stream(null!=this.whitelabelChild.deletedDate)).setSelectionChangedHandler(function(deactivate){return _this.whitelabelChild.deletedDate=deactivate?new Date:null,showProgressDialog("pleaseWait_msg",update(_this.whitelabelChild))}),this.view=function(){return[m("#whitelabel-child-viewer.fill-absolute.scroll.plr-l",[m(".h4.mt-l",lang.get("whitelabelAccount_label")),m(_this._mailAddress),m(created),m(_this._deactivated),m(_this._comment)])]}}return _createClass(WhitelabelChildViewer,[{key:"entityEventsReceived",value:function(updates){var _this2=this,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _update=_step.value;isUpdateForTypeRef(WhitelabelChildTypeRef,_update)&&_update.operation===OperationType.UPDATE&&isSameId(this.whitelabelChild._id,[neverNull(_update.instanceListId),_update.instanceId])&&load(WhitelabelChildTypeRef,this.whitelabelChild._id).then(function(updatedWhitelabelChild){_this2.whitelabelChild=updatedWhitelabelChild,_this2._mailAddress.setValue(updatedWhitelabelChild.mailAddress),_this2._deactivated.selectedValue(null!=updatedWhitelabelChild.deletedDate),_this2._comment.setValue(updatedWhitelabelChild.comment),m.redraw()})}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}]),WhitelabelChildViewer}()),_export("WhitelabelChildViewer",WhitelabelChildViewer)}}}),System.register("src/settings/WhitelabelChildrenListView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/List","../api/main/Entity","../api/common/EntityFunctions","../api/Env","../misc/LanguageViewModel","../api/common/error/RestError","../gui/size","../api/entities/sys/Customer","../api/common/utils/Utils","./SettingsView","../api/common/utils/LazyLoaded","../api/main/LoginController","../gui/base/Icon","../gui/base/icons/Icons","../gui/base/Header","../api/entities/sys/WhitelabelChild","../misc/Formatter","./WhitelabelChildViewer","../api/main/EventController"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,List,load,loadAll,GENERATED_MAX_ID,assertMainOrNode,lang,NotFoundError,size,CustomerTypeRef,neverNull,LazyLoaded,logins,Icon,Icons,header,WhitelabelChildTypeRef,formatDateWithMonth,WhitelabelChildViewer,isUpdateForTypeRef,className,WhitelabelChildrenListView,WhitelabelChildRow;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseList){List=_guiBaseList.List},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll},function(_apiCommonEntityFunctions){GENERATED_MAX_ID=_apiCommonEntityFunctions.GENERATED_MAX_ID},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiSize){size=_guiSize.size},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_SettingsView){_SettingsView.SettingsView},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseHeader){header=_guiBaseHeader.header},function(_apiEntitiesSysWhitelabelChild){WhitelabelChildTypeRef=_apiEntitiesSysWhitelabelChild.WhitelabelChildTypeRef},function(_miscFormatter){formatDateWithMonth=_miscFormatter.formatDateWithMonth},function(_WhitelabelChildViewer){WhitelabelChildViewer=_WhitelabelChildViewer.WhitelabelChildViewer},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef}],execute:function(){assertMainOrNode(),className="whitelabelchildren-list",_export("WhitelabelChildrenListView",WhitelabelChildrenListView=function(){function WhitelabelChildrenListView(settingsView){var _this=this;_classCallCheck(this,WhitelabelChildrenListView),this._settingsView=settingsView,this._listId=new LazyLoaded(function(){return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return customer.whitelabelChildren?customer.whitelabelChildren.items:null})}),this.list=new List({rowHeight:size.list_row_height,fetch:function(startId,count){if(startId===GENERATED_MAX_ID)return _this._listId.getAsync().then(function(listId){return listId?loadAll(WhitelabelChildTypeRef,listId).then(function(allChildren){return _this._setLoadedCompletely(),allChildren}):(_this._setLoadedCompletely(),[])});throw new Error("fetch whitelabel children called for specific start id")},loadSingle:function(elementId){return _this._listId.getAsync().then(function(listId){return listId?load(WhitelabelChildTypeRef,[listId,elementId]).catch(NotFoundError,function(e){}):null})},sortCompare:function(a,b){return a.mailAddress.localeCompare(b.mailAddress)},elementSelected:function(entities,elementClicked,selectionChanged,multiSelectionActive){return _this.elementSelected(entities,elementClicked,selectionChanged,multiSelectionActive)},createVirtualRow:function(){return new WhitelabelChildRow(_this)},showStatus:!1,className:className,swipe:{renderLeftSpacer:function(){return[]},renderRightSpacer:function(){return[]},swipeLeft:function(listElement){return Promise.resolve()},swipeRight:function(listElement){return Promise.resolve()}},elementsDraggable:!1,multiSelectionAllowed:!1,emptyMessage:lang.get("noEntries_msg")}),this.view=function(){return m(_this.list)},this.list.loadInitial(),this._searchResultStreamDependency=neverNull(header.searchBar).lastSelectedWhitelabelChildrenInfoResult.map(function(whitelabelChild){_this._listId.isLoaded()&&_this._listId.getSync()===whitelabelChild._id[0]&&_this.list.scrollToIdAndSelect(whitelabelChild._id[1])}),this.onremove=function(){_this._searchResultStreamDependency&&_this._searchResultStreamDependency.end(!0)}}return _createClass(WhitelabelChildrenListView,[{key:"_setLoadedCompletely",value:function(){this.list.setLoadedCompletely()}},{key:"elementSelected",value:function(whitelabelChildren,elementClicked,selectionChanged,multiSelectOperation){0===whitelabelChildren.length&&this._settingsView.detailsViewer?(this._settingsView.detailsViewer=null,m.redraw()):1===whitelabelChildren.length&&selectionChanged&&(this._settingsView.detailsViewer=new WhitelabelChildViewer(whitelabelChildren[0]),elementClicked&&this._settingsView.focusSettingsDetailsColumn(),m.redraw())}},{key:"entityEventsReceived",value:function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var update=_step.value;isUpdateForTypeRef(WhitelabelChildTypeRef,update)&&this._listId.getSync()===update.instanceListId&&this.list.entityEventReceived(update.instanceId,update.operation)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}]),WhitelabelChildrenListView}()),_export("WhitelabelChildrenListView",WhitelabelChildrenListView),_export("WhitelabelChildRow",WhitelabelChildRow=function(){function WhitelabelChildRow(whitelabelChildrenListView){_classCallCheck(this,WhitelabelChildRow),this._whitelabelChildrenListView=whitelabelChildrenListView,this.top=0,this.entity=null}return _createClass(WhitelabelChildRow,[{key:"update",value:function(whitelabelChild,selected){this.domElement&&(selected?this.domElement.classList.add("row-selected"):this.domElement.classList.remove("row-selected"),this._domMailAddress.textContent=whitelabelChild.mailAddress,this._domCreatedDate.textContent=formatDateWithMonth(whitelabelChild.createdDate),whitelabelChild.deletedDate?this._domDeletedIcon.style.display="":this._domDeletedIcon.style.display="none")}},{key:"render",value:function(){var _this2=this;return[m(".top",[m(".name",{oncreate:function(vnode){return _this2._domMailAddress=vnode.dom}})]),m(".bottom.flex-space-between",[m("small",{oncreate:function(vnode){return _this2._domCreatedDate=vnode.dom}}),m(".icons.flex",[m(Icon,{icon:Icons.Trash,oncreate:function(vnode){return _this2._domDeletedIcon=vnode.dom},class:"svg-list-accent-fg",style:{display:"none"}})])])]}}]),WhitelabelChildRow}()),_export("WhitelabelChildRow",WhitelabelChildRow)}}}),System.register("src/settings/AddGroupDialog.js",["mithril","../api/Env","../gui/base/TextField","../api/common/TutanotaConstants","../gui/base/Dialog","./SelectMailAddressForm","../api/main/WorkerClient","../gui/base/DropDownSelector","./GroupViewer","./AddUserDialog","../gui/base/ProgressDialog","../subscription/BuyDialog","../api/main/LoginController","../misc/LanguageViewModel","mithril/stream/stream.js"],function(_export,_context){"use strict";var m,assertMainOrNode,TextField,BookingItemFeatureType,FeatureType,GroupType,Dialog,SelectMailAddressForm,worker,DropDownSelector,getGroupTypeName,AddUserDialog,showProgressDialog,BuyDialog,logins,lang,stream;function getAvailableGroupTypes(){return logins.isEnabled(FeatureType.WhitelabelChild)?[]:logins.isProdDisabled()?logins.getUserController().isGlobalAdmin()?[GroupType.LocalAdmin]:[]:logins.getUserController().isGlobalAdmin()?[GroupType.Mail,GroupType.LocalAdmin]:[GroupType.Mail]}return _export("show",function(){0===getAvailableGroupTypes().length?Dialog.error("selectionNotAvailable_msg"):AddUserDialog.getAvailableDomains().then(function(availableDomains){var groupTypes=getAvailableGroupTypes(),typeField=new DropDownSelector("groupType_label",null,groupTypes.map(function(t){return{name:getGroupTypeName(t),value:t}}),stream(groupTypes[0])),nameField=new TextField("name_label"),mailAddressForm=new SelectMailAddressForm(availableDomains),form={view:function(){return[m(typeField),m(nameField),typeField.selectedValue()===GroupType.Mail?m(mailAddressForm):m("")]}};Dialog.showActionDialog({title:lang.get("addGroup_label"),child:form,validator:function(){return function(type,name,mailAddressForm){return type===GroupType.Mail?mailAddressForm.getErrorMessageId():type===GroupType.MailingList&&""===name.trim()?"enterName_msg":null}(typeField.selectedValue(),nameField.value(),mailAddressForm)},okAction:function(dialog){typeField.selectedValue()===GroupType.Mail?showProgressDialog("pleaseWait_msg",BuyDialog.show(BookingItemFeatureType.SharedMailGroup,1,0,!1).then(function(accepted){if(accepted)return dialog.close(),worker.createMailGroup(nameField.value(),mailAddressForm.getCleanMailAddress())})):typeField.selectedValue()===GroupType.LocalAdmin&&showProgressDialog("pleaseWait_msg",BuyDialog.show(BookingItemFeatureType.LocalAdminGroup,1,0,!1).then(function(accepted){if(accepted)return dialog.close(),worker.createLocalAdminGroup(nameField.value())}))}})})}),{setters:[function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_apiCommonTutanotaConstants){BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,FeatureType=_apiCommonTutanotaConstants.FeatureType,GroupType=_apiCommonTutanotaConstants.GroupType},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_SelectMailAddressForm){SelectMailAddressForm=_SelectMailAddressForm.SelectMailAddressForm},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_GroupViewer){getGroupTypeName=_GroupViewer.getGroupTypeName},function(_AddUserDialog){AddUserDialog=_AddUserDialog},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_subscriptionBuyDialog){BuyDialog=_subscriptionBuyDialog},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default}],execute:function(){assertMainOrNode()}}}),System.register("src/subscription/EmailAliasOptionsDialog.js",["mithril","../misc/LanguageViewModel","../api/common/TutanotaConstants","./BuyOptionBox","../api/main/Entity","../api/main/WorkerClient","./PriceUtils","../api/common/utils/Utils","../subscription/SubscriptionUtils","../api/entities/sys/Customer","../api/entities/sys/CustomerInfo","../api/main/LoginController","../gui/base/Dialog","./BuyDialog","../api/entities/sys/BookingServiceData","../api/common/error/RestError","../api/entities/sys/Services","../api/common/EntityFunctions","../gui/base/ButtonN"],function(_export,_context){"use strict";var m,lang,BookingItemFeatureType,Const,BuyOptionBox,getActiveSubscriptionActionButtonReplacement,load,serviceRequestVoid,worker,getCountFromPriceData,getPriceFromPriceData,neverNull,formatPrice,CustomerTypeRef,CustomerInfoTypeRef,logins,Dialog,DialogType,BuyDialog,createBookingServiceData,PreconditionFailedError,SysService,HttpMethod,ButtonN,ButtonType;function buyAliases(amount){var bookingData=createBookingServiceData();return bookingData.amount=amount.toString(),bookingData.featureType=BookingItemFeatureType.Alias,bookingData.date=Const.CURRENT_DATE,serviceRequestVoid(SysService.BookingService,HttpMethod.POST,bookingData).return(!1).catch(PreconditionFailedError,function(error){return Dialog.error("emailAliasesTooManyActivatedForBooking_msg").return(!0)})}function createEmailAliasPackageBox(amount,freeAmount,buyAction){var attrs={heading:lang.get("pricing.mailAddressAliasesShort_label",{"{amount}":Math.max(amount,freeAmount)}),actionButton:{view:function(){return m(ButtonN,{label:"pricing.select_action",type:ButtonType.Login,click:function(){return buyAction(amount)}})}},price:lang.get("emptyString_msg"),originalPrice:lang.get("emptyString_msg"),helpLabel:"emptyString_msg",features:function(){return[]},width:230,height:210,paymentInterval:null,showReferenceDiscount:!1};return worker.getPrice(BookingItemFeatureType.Alias,amount,!1).then(function(newPrice){amount===getCountFromPriceData(newPrice.currentPriceNextPeriod,BookingItemFeatureType.Alias)&&(attrs.actionButton=getActiveSubscriptionActionButtonReplacement());var price=formatPrice(getPriceFromPriceData(newPrice.futurePriceNextPeriod,BookingItemFeatureType.Alias),!0);attrs.price=price,attrs.originalPrice=price,attrs.helpLabel="12"===neverNull(newPrice.futurePriceNextPeriod).paymentInterval?"pricing.perYear_label":"pricing.perMonth_label",m.redraw()}),{amount:amount,buyOptionBoxAttr:attrs}}return _export("buyAliases",buyAliases),_export("show",function show(){return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerInfoTypeRef,customer.customerInfo)}).then(function(customerInfo){var dialog=void 0,freeEmailAliases=Math.max(Number(customerInfo.includedEmailAliases),Number(customerInfo.promotionEmailAliases));return new Promise(function(resolve){var changeEmailAliasPackageAction=function(amount){dialog.close(),BuyDialog.show(BookingItemFeatureType.Alias,amount,freeEmailAliases,!1).then(function(confirm){if(confirm)return buyAliases(amount);show()}).then(function(){return resolve()})},emailAliasesBuyOptionsAttrs=[createEmailAliasPackageBox(0,freeEmailAliases,changeEmailAliasPackageAction),createEmailAliasPackageBox(20,freeEmailAliases,changeEmailAliasPackageAction),createEmailAliasPackageBox(40,freeEmailAliases,changeEmailAliasPackageAction),createEmailAliasPackageBox(100,freeEmailAliases,changeEmailAliasPackageAction)].filter(function(aliasPackage){return 0===aliasPackage.amount||aliasPackage.amount>freeEmailAliases}).map(function(scb){return scb.buyOptionBoxAttr});dialog=Dialog.showActionDialog({title:lang.get("emailAlias_label"),okAction:null,type:DialogType.EditLarge,child:function(){return[m(".pt.center",lang.get("buyEmailAliasInfo_msg")),m(".flex-center.flex-wrap",emailAliasesBuyOptionsAttrs.map(function(attr){return m(BuyOptionBox,attr)}))]}})})})}),{setters:[function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonTutanotaConstants){BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,Const=_apiCommonTutanotaConstants.Const},function(_BuyOptionBox){BuyOptionBox=_BuyOptionBox.BuyOptionBox,getActiveSubscriptionActionButtonReplacement=_BuyOptionBox.getActiveSubscriptionActionButtonReplacement},function(_apiMainEntity){load=_apiMainEntity.load,serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_PriceUtils){getCountFromPriceData=_PriceUtils.getCountFromPriceData,getPriceFromPriceData=_PriceUtils.getPriceFromPriceData},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_subscriptionSubscriptionUtils){formatPrice=_subscriptionSubscriptionUtils.formatPrice},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_BuyDialog){BuyDialog=_BuyDialog},function(_apiEntitiesSysBookingServiceData){createBookingServiceData=_apiEntitiesSysBookingServiceData.createBookingServiceData},function(_apiCommonErrorRestError){PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType}],execute:function(){}}}),System.register("src/subscription/StorageCapacityOptionsDialog.js",["mithril","../misc/LanguageViewModel","../api/common/TutanotaConstants","./BuyOptionBox","../api/main/Entity","../api/main/WorkerClient","./PriceUtils","../api/common/utils/Utils","../subscription/SubscriptionUtils","../api/entities/sys/Customer","../api/entities/sys/CustomerInfo","../api/main/LoginController","../gui/base/Dialog","../api/entities/sys/BookingServiceData","../api/common/error/RestError","../api/entities/sys/Services","../api/common/EntityFunctions","../gui/base/ButtonN","./BuyDialog"],function(_export,_context){"use strict";var m,lang,BookingItemFeatureType,Const,Keys,BuyOptionBox,getActiveSubscriptionActionButtonReplacement,load,serviceRequestVoid,worker,getCountFromPriceData,getPriceFromPriceData,neverNull,formatPrice,CustomerTypeRef,CustomerInfoTypeRef,logins,Dialog,createBookingServiceData,PreconditionFailedError,SysService,HttpMethod,ButtonN,ButtonType,BuyDialog;function buyStorage(amount){var bookingData=createBookingServiceData();return bookingData.amount=amount.toString(),bookingData.featureType=BookingItemFeatureType.Storage,bookingData.date=Const.CURRENT_DATE,serviceRequestVoid(SysService.BookingService,HttpMethod.POST,bookingData).return(!1).catch(PreconditionFailedError,function(error){return Dialog.error("storageCapacityTooManyUsedForBooking_msg").return(!0)})}function createStorageCapacityBoxAttr(amount,freeAmount,buyAction){var attrs={heading:function(amount){return amount<1e3?amount+" GB":amount/1e3+" TB"}(Math.max(amount,freeAmount)),actionButton:{view:function(){return m(ButtonN,{label:"pricing.select_action",type:ButtonType.Login,click:function(){return buyAction(amount)}})}},price:lang.get("emptyString_msg"),originalPrice:lang.get("emptyString_msg"),helpLabel:"emptyString_msg",features:function(){return[]},width:230,height:210,paymentInterval:null,showReferenceDiscount:!1};return worker.getPrice(BookingItemFeatureType.Storage,amount,!1).then(function(newPrice){amount===getCountFromPriceData(newPrice.currentPriceNextPeriod,BookingItemFeatureType.Storage)&&(attrs.actionButton=getActiveSubscriptionActionButtonReplacement());var price=formatPrice(getPriceFromPriceData(newPrice.futurePriceNextPeriod,BookingItemFeatureType.Storage),!0);attrs.price=price,attrs.originalPrice=price,attrs.helpLabel="12"===neverNull(newPrice.futurePriceNextPeriod).paymentInterval?"pricing.perYear_label":"pricing.perMonth_label",m.redraw()}),{amount:amount,buyOptionBoxAttr:attrs}}return _export("buyStorage",buyStorage),_export("show",function(){return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerInfoTypeRef,customer.customerInfo)}).then(function(customerInfo){var freeStorageCapacity=Math.max(Number(customerInfo.includedStorageCapacity),Number(customerInfo.promotionStorageCapacity));return Promise.fromCallback(function(callback){var changeStorageCapacityAction=function(amount){dialog.close(),BuyDialog.show(BookingItemFeatureType.Storage,amount,freeStorageCapacity,!1).then(function(confirm){if(confirm)return buyStorage(amount)}).then(function(){callback(null)})},cancelAction=function(){dialog.close(),callback(null)},storageBuyOptionsAttrs=[createStorageCapacityBoxAttr(0,freeStorageCapacity,changeStorageCapacityAction),createStorageCapacityBoxAttr(10,freeStorageCapacity,changeStorageCapacityAction),createStorageCapacityBoxAttr(100,freeStorageCapacity,changeStorageCapacityAction),createStorageCapacityBoxAttr(1e3,freeStorageCapacity,changeStorageCapacityAction)].filter(function(scb){return 0===scb.amount||scb.amount>freeStorageCapacity}).map(function(scb){return scb.buyOptionBoxAttr}),headerBarAttrs={left:[{label:"cancel_action",click:cancelAction,type:ButtonType.Secondary}],middle:function(){return lang.get("storageCapacity_label")}},dialog=Dialog.largeDialog(headerBarAttrs,{view:function(){return[m(".pt.center",lang.get("buyStorageCapacityInfo_msg")),m(".flex-center.flex-wrap",storageBuyOptionsAttrs.map(function(attr){return m(BuyOptionBox,attr)}))]}}).addShortcut({key:Keys.ESC,exec:cancelAction,help:"close_alt"}).setCloseHandler(cancelAction).show()})})}),{setters:[function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonTutanotaConstants){BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,Const=_apiCommonTutanotaConstants.Const,Keys=_apiCommonTutanotaConstants.Keys},function(_BuyOptionBox){BuyOptionBox=_BuyOptionBox.BuyOptionBox,getActiveSubscriptionActionButtonReplacement=_BuyOptionBox.getActiveSubscriptionActionButtonReplacement},function(_apiMainEntity){load=_apiMainEntity.load,serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_PriceUtils){getCountFromPriceData=_PriceUtils.getCountFromPriceData,getPriceFromPriceData=_PriceUtils.getPriceFromPriceData},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_subscriptionSubscriptionUtils){formatPrice=_subscriptionSubscriptionUtils.formatPrice},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiEntitiesSysBookingServiceData){createBookingServiceData=_apiEntitiesSysBookingServiceData.createBookingServiceData},function(_apiCommonErrorRestError){PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_BuyDialog){BuyDialog=_BuyDialog}],execute:function(){}}}),System.register("src/subscription/WhitelabelAndSharingBuyDialog.js",["../api/common/TutanotaConstants","../api/main/Entity","../api/common/EntityFunctions","../gui/base/Dialog","../api/entities/sys/Services","../api/common/error/RestError","./BuyDialog","../api/entities/sys/BookingServiceData","../gui/base/ProgressDialog"],function(_export,_context){"use strict";var BookingItemFeatureType,Const,serviceRequestVoid,HttpMethod,Dialog,SysService,PreconditionFailedError,BuyDialog,createBookingServiceData,showProgressDialog;function buy(bookingItemFeatureType,errorMessageId,enable){var amount=enable?1:0,bookingData=createBookingServiceData();return bookingData.amount=amount.toString(),bookingData.featureType=bookingItemFeatureType,bookingData.date=Const.CURRENT_DATE,serviceRequestVoid(SysService.BookingService,HttpMethod.POST,bookingData).then(function(){return!1}).catch(PreconditionFailedError,function(error){return console.log(error),Dialog.error(errorMessageId).return(!0)})}function showBuyDialog(bookingItemFeatureType,errorMessageId,enable){var amount=enable?1:0;return showProgressDialog("pleaseWait_msg",BuyDialog.show(bookingItemFeatureType,amount,0,!1)).then(function(accepted){return!accepted||buy(bookingItemFeatureType,errorMessageId,enable)})}return _export("buyWhitelabel",function(enable){return buy(BookingItemFeatureType.Branding,"whitelabelDomainExisting_msg",enable)}),_export("buySharing",function(enable){return buy(BookingItemFeatureType.Sharing,"unknownError_msg",enable)}),_export("showWhitelabelBuyDialog",function(enable){return showBuyDialog(BookingItemFeatureType.Branding,"whitelabelDomainExisting_msg",enable)}),_export("showSharingBuyDialog",function(enable){return(enable?Promise.resolve(!0):Dialog.confirm("sharingDeletionWarning_msg")).then(function(ok){return!ok||showBuyDialog(BookingItemFeatureType.Sharing,"unknownError_msg",enable)})}),{setters:[function(_apiCommonTutanotaConstants){BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,Const=_apiCommonTutanotaConstants.Const},function(_apiMainEntity){serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiCommonErrorRestError){PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_BuyDialog){BuyDialog=_BuyDialog},function(_apiEntitiesSysBookingServiceData){createBookingServiceData=_apiEntitiesSysBookingServiceData.createBookingServiceData},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog}],execute:function(){}}}),System.register("src/subscription/SwitchSubscriptionDialog.js",["mithril","../gui/base/Dialog","../misc/LanguageViewModel","../gui/base/ButtonN","../api/main/Entity","../api/entities/sys/Services","../api/common/EntityFunctions","../api/entities/sys/SwitchAccountTypeData","../api/common/TutanotaConstants","../api/common/error/RestError","../api/main/WorkerClient","./SubscriptionSelector","mithril/stream/stream.js","./EmailAliasOptionsDialog","./StorageCapacityOptionsDialog","./WhitelabelAndSharingBuyDialog","./SubscriptionViewer","../gui/base/ProgressDialog","./SubscriptionUtils","../api/entities/sys/PlanPrices","../api/common/utils/Utils","./PriceUtils"],function(_export,_context){"use strict";var m,Dialog,lang,ButtonN,ButtonType,serviceRequestVoid,SysService,HttpMethod,createSwitchAccountTypeData,AccountType,BookingItemFeatureByCode,BookingItemFeatureType,Const,Keys,UnsubscribeFailureReason,BadRequestError,InvalidDataError,PreconditionFailedError,worker,SubscriptionSelector,stream,buyAliases,buyStorage,buySharing,buyWhitelabel,changeSubscriptionInterval,showProgressDialog,SubscriptionType,createPlanPrices,neverNull,getPriceFromPriceData,getPriceItem,subscriptions;function getPrice(currentSubscription,targetSubscription,addUserReturn,upgrade20AliasesPrice,downgrade5AliasesPrice,upgrade10GbStoragePrice,downgrade1GbStoragePrice,upgradeSharingPrice,downgradeSharingPrice,upgradeWhitelabelPrice,downgradeWhitelabelPrice,contactFormReturn,paymentIntervalFactor,currentTotalStorage,currentTotalAliases,includedStorage,includedAliases,currentlyWhitelabelOrdered,currentlySharingOrdered){var prices=createPlanPrices(),monthlyPrice=Number(neverNull(addUserReturn.currentPriceNextPeriod).price),contactFormPrice=getMonthlySinglePrice(contactFormReturn,BookingItemFeatureType.ContactForm,paymentIntervalFactor),singleUserPriceMonthly=getMonthlySinglePrice(addUserReturn,BookingItemFeatureType.Users,paymentIntervalFactor),currentSharingPerUserMonthly=getMonthlySinglePrice(addUserReturn,BookingItemFeatureType.Sharing,paymentIntervalFactor),currentWhitelabelPerUserMonthly=getMonthlySinglePrice(addUserReturn,BookingItemFeatureType.Branding,paymentIntervalFactor);return prices.contactFormPriceMonthly=subscriptions[targetSubscription].whitelabel?String(contactFormPrice):"0",prices.firstYearDiscount="0",currentSubscription===targetSubscription?(monthlyPrice*=paymentIntervalFactor,prices.includedAliases=String(currentTotalAliases),prices.includedStorage=String(currentTotalStorage),prices.monthlyPrice=String(monthlyPrice),prices.monthlyReferencePrice=String(monthlyPrice),prices.additionalUserPriceMonthly=String(singleUserPriceMonthly+currentSharingPerUserMonthly+currentWhitelabelPerUserMonthly)):isUpgrade(targetSubscription,currentSubscription)?(isUpgradeWhitelabelNeeded(targetSubscription,currentlyWhitelabelOrdered)&&(monthlyPrice+=Number(neverNull(upgradeWhitelabelPrice.futurePriceNextPeriod).price)-Number(neverNull(upgradeWhitelabelPrice.currentPriceNextPeriod).price)),isUpgradeSharingNeeded(targetSubscription,currentlySharingOrdered)&&(monthlyPrice+=Number(neverNull(upgradeSharingPrice.futurePriceNextPeriod).price)-Number(neverNull(upgradeSharingPrice.currentPriceNextPeriod).price)),isUpgradeStorageNeeded(targetSubscription,currentTotalStorage)&&(monthlyPrice+=Number(neverNull(upgrade10GbStoragePrice.futurePriceNextPeriod).price)-Number(neverNull(upgrade10GbStoragePrice.currentPriceNextPeriod).price)),isUpgradeAliasesNeeded(targetSubscription,currentTotalAliases)&&(monthlyPrice+=Number(neverNull(upgrade20AliasesPrice.futurePriceNextPeriod).price)-Number(neverNull(upgrade20AliasesPrice.currentPriceNextPeriod).price)),monthlyPrice*=paymentIntervalFactor,prices.includedAliases=String(Math.max(currentTotalAliases,subscriptions[targetSubscription].nbrOfAliases)),prices.includedStorage=String(Math.max(currentTotalStorage,subscriptions[targetSubscription].storageGb)),prices.monthlyPrice=String(monthlyPrice),prices.monthlyReferencePrice=String(monthlyPrice),prices.additionalUserPriceMonthly=String(singleUserPriceMonthly+(isUpgradeWhitelabelNeeded(targetSubscription,currentlyWhitelabelOrdered)?getMonthlySinglePrice(upgradeWhitelabelPrice,BookingItemFeatureType.Branding,paymentIntervalFactor):currentWhitelabelPerUserMonthly)+(isUpgradeSharingNeeded(targetSubscription,currentlySharingOrdered)?getMonthlySinglePrice(upgradeSharingPrice,BookingItemFeatureType.Sharing,paymentIntervalFactor):currentSharingPerUserMonthly))):(isDowngradeWhitelabelNeeded(targetSubscription,currentlyWhitelabelOrdered)&&(monthlyPrice+=Number(neverNull(downgradeWhitelabelPrice.futurePriceNextPeriod).price)-Number(neverNull(downgradeWhitelabelPrice.currentPriceNextPeriod).price)),isDowngradeSharingNeeded(targetSubscription,currentlySharingOrdered)&&(monthlyPrice+=Number(neverNull(downgradeSharingPrice.futurePriceNextPeriod).price)-Number(neverNull(downgradeSharingPrice.currentPriceNextPeriod).price)),isDowngradeStorageNeeded(targetSubscription,currentTotalStorage,includedStorage)&&(monthlyPrice+=Number(neverNull(downgrade1GbStoragePrice.futurePriceNextPeriod).price)-Number(neverNull(downgrade1GbStoragePrice.currentPriceNextPeriod).price)),isDowngradeAliasesNeeded(targetSubscription,currentTotalAliases,includedAliases)&&(monthlyPrice+=Number(neverNull(downgrade5AliasesPrice.futurePriceNextPeriod).price)-Number(neverNull(downgrade5AliasesPrice.currentPriceNextPeriod).price)),monthlyPrice*=paymentIntervalFactor,prices.includedAliases=String(Math.max(includedAliases,subscriptions[targetSubscription].nbrOfAliases)),prices.includedStorage=String(Math.max(includedStorage,subscriptions[targetSubscription].storageGb)),prices.monthlyPrice=String(monthlyPrice),prices.monthlyReferencePrice=String(monthlyPrice),prices.additionalUserPriceMonthly=String(singleUserPriceMonthly+(isDowngradeWhitelabelNeeded(targetSubscription,currentlyWhitelabelOrdered)?0:currentWhitelabelPerUserMonthly)+(isDowngradeSharingNeeded(targetSubscription,currentlySharingOrdered)?0:currentSharingPerUserMonthly))),prices}function getMonthlySinglePrice(priceData,featureType,additionalFactor){var futurePrice=getPriceFromPriceData(priceData.futurePriceNextPeriod,featureType),item=getPriceItem(priceData.futurePriceNextPeriod,featureType);return item&&item.singleType?(futurePrice/=Number(item.count))*additionalFactor:0}function isUpgrade(targetSubscription,currentSubscription){return currentSubscription===SubscriptionType.Premium||currentSubscription===SubscriptionType.Teams&&targetSubscription===SubscriptionType.Pro}function isUpgradeAliasesNeeded(targetSubscription,currentNbrOfAliases){return currentNbrOfAliases<subscriptions[targetSubscription].nbrOfAliases}function isDowngradeAliasesNeeded(targetSubscription,currentNbrOfAliases,includedAliases){return currentNbrOfAliases>subscriptions[targetSubscription].nbrOfAliases&&currentNbrOfAliases>includedAliases}function isUpgradeStorageNeeded(targetSubscription,currentAmountOfStorage){return currentAmountOfStorage<subscriptions[targetSubscription].storageGb}function isDowngradeStorageNeeded(targetSubscription,currentAmountOfStorage,includedStorage){return currentAmountOfStorage>subscriptions[targetSubscription].storageGb&&currentAmountOfStorage>includedStorage}function isUpgradeSharingNeeded(targetSubscription,currentlySharingOrdered){return!currentlySharingOrdered&&subscriptions[targetSubscription].sharing}function isDowngradeSharingNeeded(targetSubscription,currentlySharingOrdered){return currentlySharingOrdered&&!subscriptions[targetSubscription].sharing}function isUpgradeWhitelabelNeeded(targetSubscription,currentlyWhitelabelOrdered){return!currentlyWhitelabelOrdered&&subscriptions[targetSubscription].whitelabel}function isDowngradeWhitelabelNeeded(targetSubscription,currentlyWhitelabelOrdered){return currentlyWhitelabelOrdered&&!subscriptions[targetSubscription].whitelabel}function switchSubscription(targetSubscription,currentSubscription,accountingInfo,paymentInterval,dialog,currentNbrOfAliases,currentAmountOfStorage,includedAliases,includedStorage,currentlySharingOrdered,currentlyWhitelabelOrdered){if(isUpgrade(targetSubscription,currentSubscription)){var msg=lang.get(targetSubscription===SubscriptionType.Pro?"upgradePro_msg":"upgradeTeams_msg");(isDowngradeAliasesNeeded(targetSubscription,currentNbrOfAliases,includedAliases)||isDowngradeStorageNeeded(targetSubscription,currentAmountOfStorage,includedStorage))&&(msg=msg+"\n\n"+lang.get("upgradeProNoReduction_msg")),Dialog.confirm(function(){return msg}).then(function(ok){if(ok)return showProgressDialog("pleaseWait_msg",Promise.resolve().then(function(){if(isUpgradeAliasesNeeded(targetSubscription,currentNbrOfAliases))return buyAliases(subscriptions[targetSubscription].orderNbrOfAliases)}).then(function(){if(isUpgradeStorageNeeded(targetSubscription,currentAmountOfStorage))return buyStorage(subscriptions[targetSubscription].orderStorageGb)}).then(function(){if(isUpgradeSharingNeeded(targetSubscription,currentlySharingOrdered))return buySharing(!0)}).then(function(){if(isUpgradeWhitelabelNeeded(targetSubscription,currentlyWhitelabelOrdered))return buyWhitelabel(!0)}).then(function(){return updatePaymentInterval(paymentInterval,accountingInfo)})).then(function(){return dialog.close()})})}else Dialog.confirm(targetSubscription===SubscriptionType.Premium?"downgradeToPremium_msg":"downgradeToTeams_msg").then(function(ok){if(ok)return showProgressDialog("pleaseWait_msg",cancelAllAdditionalFeatures(targetSubscription,currentNbrOfAliases,currentAmountOfStorage,includedAliases,includedStorage,currentlySharingOrdered,currentlyWhitelabelOrdered).then(function(){return updatePaymentInterval(paymentInterval,accountingInfo)})).then(function(){return dialog.close()})})}function cancelAllAdditionalFeatures(targetSubscription,currentNbrOfAliases,currentAmountOfStorage,includedAliases,includedStorage,currentlySharingOrdered,currentlyWhitelabelOrdered){return Promise.resolve().then(function(){return!!isDowngradeAliasesNeeded(targetSubscription,currentNbrOfAliases,includedAliases)&&buyAliases(subscriptions[targetSubscription].orderNbrOfAliases)}).then(function(previousFailed){return isDowngradeStorageNeeded(targetSubscription,currentAmountOfStorage,includedStorage)?buyStorage(subscriptions[targetSubscription].orderStorageGb).then(function(thisFailed){return thisFailed||previousFailed}):previousFailed}).then(function(previousFailed){return isDowngradeSharingNeeded(targetSubscription,currentlySharingOrdered)?buySharing(!1).then(function(thisFailed){return thisFailed||previousFailed}):previousFailed}).then(function(previousFailed){return isDowngradeWhitelabelNeeded(targetSubscription,currentlyWhitelabelOrdered)?buyWhitelabel(!1).then(function(thisFailed){return thisFailed||previousFailed}):previousFailed})}function updatePaymentInterval(paymentInterval,accountingInfo){paymentInterval!==Number(accountingInfo.paymentInterval)&&changeSubscriptionInterval(accountingInfo,paymentInterval)}return _export("showSwitchDialog",function(accountingInfo,currentSubscription,currentNbrOfUsers,currentTotalStorage,currentTotalAliases,includedStorage,includedAliases,currentlySharingOrdered,currentlyWhitelabelOrdered){var businessStream=stream(accountingInfo.business),paymentIntervalStream=stream(Number(accountingInfo.paymentInterval));return showProgressDialog("pleaseWait_msg",function(currentSubscription,currentNbrOfUsers,currentTotalStorage,currentTotalAliases,includedStorage,includedAliases,currentlyWhitelabelOrdered,currentlySharingOrdered){return Promise.join(worker.getPrice(BookingItemFeatureType.Users,1,!1),worker.getPrice(BookingItemFeatureType.Alias,20,!1),worker.getPrice(BookingItemFeatureType.Alias,0,!1),worker.getPrice(BookingItemFeatureType.Storage,10,!1),worker.getPrice(BookingItemFeatureType.Storage,0,!1),worker.getPrice(BookingItemFeatureType.Sharing,1,!1),worker.getPrice(BookingItemFeatureType.Sharing,0,!1),worker.getPrice(BookingItemFeatureType.Branding,1,!1),worker.getPrice(BookingItemFeatureType.Branding,0,!1),worker.getPrice(BookingItemFeatureType.ContactForm,1,!1),function(addUserPrice,upgrade20AliasesPrice,downgrade5AliasesPrice,upgrade10GbStoragePrice,downgrade1GbStoragePrice,upgradeSharingPrice,downgradeSharingPrice,upgradeWhitelabelPrice,downgradeWhitelabelPrice,contactFormPrice){var additionalFactor="12"===neverNull(addUserPrice.futurePriceNextPeriod).paymentInterval?.1:1,premiumPrices=getPrice(currentSubscription,SubscriptionType.Premium,addUserPrice,upgrade20AliasesPrice,downgrade5AliasesPrice,upgrade10GbStoragePrice,downgrade1GbStoragePrice,upgradeSharingPrice,downgradeSharingPrice,upgradeWhitelabelPrice,downgradeWhitelabelPrice,contactFormPrice,additionalFactor,currentTotalStorage,currentTotalAliases,includedStorage,includedAliases,currentlyWhitelabelOrdered,currentlySharingOrdered),teamsPrices=getPrice(currentSubscription,SubscriptionType.Teams,addUserPrice,upgrade20AliasesPrice,downgrade5AliasesPrice,upgrade10GbStoragePrice,downgrade1GbStoragePrice,upgradeSharingPrice,downgradeSharingPrice,upgradeWhitelabelPrice,downgradeWhitelabelPrice,contactFormPrice,additionalFactor,currentTotalStorage,currentTotalAliases,includedStorage,includedAliases,currentlyWhitelabelOrdered,currentlySharingOrdered),proPrices=getPrice(currentSubscription,SubscriptionType.Pro,addUserPrice,upgrade20AliasesPrice,downgrade5AliasesPrice,upgrade10GbStoragePrice,downgrade1GbStoragePrice,upgradeSharingPrice,downgradeSharingPrice,upgradeWhitelabelPrice,downgradeWhitelabelPrice,contactFormPrice,additionalFactor,currentTotalStorage,currentTotalAliases,includedStorage,includedAliases,currentlyWhitelabelOrdered,currentlySharingOrdered);return{premiumPrices:premiumPrices,teamsPrices:teamsPrices,proPrices:proPrices}})}(currentSubscription,0,currentTotalStorage,currentTotalAliases,includedStorage,includedAliases,currentlyWhitelabelOrdered,currentlySharingOrdered)).then(function(prices){var cancelAction=function(){dialog.close()},headerBarAttrs={left:[{label:"cancel_action",click:cancelAction,type:ButtonType.Secondary}],right:[],middle:function(){return lang.get("subscription_label")}},dialog=Dialog.largeDialog(headerBarAttrs,{view:function(){return m("#upgrade-account-dialog.pt",m(SubscriptionSelector,{options:{businessUse:businessStream,paymentInterval:paymentIntervalStream},campaignInfoTextId:null,boxWidth:230,boxHeight:230,currentlyActive:currentSubscription,currentlySharingOrdered:currentlySharingOrdered,currentlyWhitelabelOrdered:currentlyWhitelabelOrdered,isInitialUpgrade:!1,premiumPrices:prices.premiumPrices,teamsPrices:prices.teamsPrices,proPrices:prices.proPrices,freeActionButton:{view:function(){return m(ButtonN,{label:"pricing.select_action",click:function(){return function(dialog,currentNbrOfAliases,currentAmountOfStorage,includedAliases,includedStorage,currentlySharingOrdered,currentlyWhitelabelOrdered){Dialog.confirm("unsubscribeConfirm_msg").then(function(ok){if(ok){var d=createSwitchAccountTypeData();d.accountType=AccountType.FREE,d.date=Const.CURRENT_DATE,showProgressDialog("pleaseWait_msg",cancelAllAdditionalFeatures(SubscriptionType.Free,currentNbrOfAliases,currentAmountOfStorage,includedAliases,includedStorage,currentlySharingOrdered,currentlyWhitelabelOrdered).then(function(failed){if(!failed)return serviceRequestVoid(SysService.SwitchAccountTypeService,HttpMethod.POST,d).then(function(){return worker.switchPremiumToFreeGroup()}).catch(PreconditionFailedError,function(e){var reason=e.data;if(null==reason)return Dialog.error("unknownError_msg");var detailMsg=void 0;switch(reason){case UnsubscribeFailureReason.TOO_MANY_ENABLED_USERS:detailMsg=lang.get("accountSwitchTooManyActiveUsers_msg");break;case UnsubscribeFailureReason.CUSTOM_MAIL_ADDRESS:detailMsg=lang.get("accountSwitchCustomMailAddress_msg");break;case UnsubscribeFailureReason.TOO_MANY_CALENDARS:detailMsg=lang.get("accountSwitchMultipleCalendars_msg");break;case UnsubscribeFailureReason.CALENDAR_TYPE:detailMsg=lang.get("accountSwitchSharedCalendar_msg");break;case UnsubscribeFailureReason.TOO_MANY_ALIASES:detailMsg=lang.get("accountSwitchAliases_msg");break;default:if(reason.startsWith(UnsubscribeFailureReason.FEATURE)){var feature=reason.slice(UnsubscribeFailureReason.FEATURE.length+1),featureName=BookingItemFeatureByCode[feature];detailMsg=lang.get("accountSwitchFeature_msg",{"{featureName}":featureName})}else detailMsg=lang.get("unknownError_msg")}return Dialog.error(function(){return lang.get("accountSwitchNotPossible_msg",{"{detailMsg}":detailMsg})})}).catch(InvalidDataError,function(e){return Dialog.error("accountSwitchTooManyActiveUsers_msg")}).catch(BadRequestError,function(e){return Dialog.error("deactivatePremiumWithCustomDomainError_msg")})})).finally(function(){return dialog.close()})}})}(dialog,currentTotalAliases,currentTotalStorage,includedAliases,includedStorage,currentlySharingOrdered,currentlyWhitelabelOrdered)},type:ButtonType.Login})}},premiumActionButton:{view:function(){return m(ButtonN,{label:"pricing.select_action",click:function(){switchSubscription(SubscriptionType.Premium,currentSubscription,accountingInfo,paymentIntervalStream(),dialog,currentTotalAliases,currentTotalStorage,includedAliases,includedStorage,currentlySharingOrdered,currentlyWhitelabelOrdered)},type:ButtonType.Login})}},teamsActionButton:{view:function(){return m(ButtonN,{label:"pricing.select_action",click:function(){switchSubscription(SubscriptionType.Teams,currentSubscription,accountingInfo,paymentIntervalStream(),dialog,currentTotalAliases,currentTotalStorage,includedAliases,includedStorage,currentlySharingOrdered,currentlyWhitelabelOrdered)},type:ButtonType.Login})}},proActionButton:{view:function(){return m(ButtonN,{label:"pricing.select_action",click:function(){switchSubscription(SubscriptionType.Pro,currentSubscription,accountingInfo,paymentIntervalStream(),dialog,currentTotalAliases,currentTotalStorage,includedAliases,includedStorage,currentlySharingOrdered,currentlyWhitelabelOrdered)},type:ButtonType.Login})}}}))}}).addShortcut({key:Keys.ESC,exec:cancelAction,help:"close_alt"}).setCloseHandler(cancelAction).show()})}),{setters:[function(_mithril){m=_mithril.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_apiMainEntity){serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_apiEntitiesSysSwitchAccountTypeData){createSwitchAccountTypeData=_apiEntitiesSysSwitchAccountTypeData.createSwitchAccountTypeData},function(_apiCommonTutanotaConstants){AccountType=_apiCommonTutanotaConstants.AccountType,BookingItemFeatureByCode=_apiCommonTutanotaConstants.BookingItemFeatureByCode,BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,Const=_apiCommonTutanotaConstants.Const,Keys=_apiCommonTutanotaConstants.Keys,UnsubscribeFailureReason=_apiCommonTutanotaConstants.UnsubscribeFailureReason},function(_apiCommonErrorRestError){BadRequestError=_apiCommonErrorRestError.BadRequestError,InvalidDataError=_apiCommonErrorRestError.InvalidDataError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_SubscriptionSelector){SubscriptionSelector=_SubscriptionSelector.SubscriptionSelector},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_EmailAliasOptionsDialog){buyAliases=_EmailAliasOptionsDialog.buyAliases},function(_StorageCapacityOptionsDialog){buyStorage=_StorageCapacityOptionsDialog.buyStorage},function(_WhitelabelAndSharingBuyDialog){buySharing=_WhitelabelAndSharingBuyDialog.buySharing,buyWhitelabel=_WhitelabelAndSharingBuyDialog.buyWhitelabel},function(_SubscriptionViewer){changeSubscriptionInterval=_SubscriptionViewer.changeSubscriptionInterval},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_SubscriptionUtils){SubscriptionType=_SubscriptionUtils.SubscriptionType},function(_apiEntitiesSysPlanPrices){createPlanPrices=_apiEntitiesSysPlanPrices.createPlanPrices},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_PriceUtils){getPriceFromPriceData=_PriceUtils.getPriceFromPriceData,getPriceItem=_PriceUtils.getPriceItem}],execute:function(){(subscriptions={})[SubscriptionType.Free]={nbrOfAliases:0,orderNbrOfAliases:0,storageGb:1,orderStorageGb:0,sharing:!1,whitelabel:!1},subscriptions[SubscriptionType.Premium]={nbrOfAliases:5,orderNbrOfAliases:0,storageGb:1,orderStorageGb:0,sharing:!1,whitelabel:!1},subscriptions[SubscriptionType.Teams]={nbrOfAliases:5,orderNbrOfAliases:0,storageGb:10,orderStorageGb:10,sharing:!0,whitelabel:!1},subscriptions[SubscriptionType.Pro]={nbrOfAliases:20,orderNbrOfAliases:20,storageGb:10,orderStorageGb:10,sharing:!0,whitelabel:!0}}}}),System.register("src/subscription/DeleteAccountDialog.js",["mithril","../gui/base/Dialog","../misc/LanguageViewModel","../api/common/error/RestError","../api/main/WorkerClient","../gui/base/TextField","../misc/Formatter","../api/common/utils/Utils"],function(_export,_context){"use strict";var m,Dialog,lang,InvalidDataError,PreconditionFailedError,worker,TextField,Type,getCleanedMailAddress,neverNull;return _export("showDeleteAccountDialog",function(){var why=new TextField("deleteAccountReason_label",function(){return lang.get("deleteAccountReasonInfo_msg")}),takeover=new TextField("takeoverMailAddress_label",function(){return lang.get("takeoverMailAddressInfo_msg")}),password=new TextField("password_label",function(){return lang.get("passwordEnterNeutral_msg")}).setType(Type.Password);Dialog.showActionDialog({title:lang.get("adminDeleteAccount_action"),child:{view:function(){return m("#delete-account-dialog",[m(why),m(takeover),m(password)])}},okAction:function(){return function(reason,takeover,password){var cleanedTakeover=""===takeover?"":getCleanedMailAddress(takeover);null===cleanedTakeover?Dialog.error("mailAddressInvalid_msg"):Dialog.confirm(function(){return""===cleanedTakeover?lang.get("deleteAccountConfirm_msg"):lang.get("deleteAccountWithTakeoverConfirm_msg",{"{1}":cleanedTakeover})}).then(function(ok){ok&&worker.deleteAccount(password,reason,neverNull(cleanedTakeover)).catch(PreconditionFailedError,function(e){return Dialog.error("passwordWrongInvalid_msg")}).catch(InvalidDataError,function(e){return Dialog.error("takeoverAccountInvalid_msg")})})}(why.value(),takeover.value(),password.value())},allowCancel:!0,okActionTextId:"delete_action"})}),{setters:[function(_mithril){m=_mithril.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonErrorRestError){InvalidDataError=_apiCommonErrorRestError.InvalidDataError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField,Type=_guiBaseTextField.Type},function(_miscFormatter){getCleanedMailAddress=_miscFormatter.getCleanedMailAddress},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull}],execute:function(){}}}),System.register("src/subscription/SignOrderProcessingAgreementDialog.js",["mithril","../gui/base/Dialog","../misc/LanguageViewModel","../api/Env","../misc/Formatter","../gui/base/HtmlEditor","../api/main/Entity","../api/common/EntityFunctions","../api/entities/sys/SignOrderProcessingAgreementData","../api/entities/sys/Services","../mail/MailUtils","../api/common/utils/Utils"],function(_export,_context){"use strict";var m,Dialog,DialogType,lang,assertMainOrNode,isApp,formatDate,formatNameAndAddress,HtmlEditor,Mode,serviceRequestVoid,HttpMethod,createSignOrderProcessingAgreementData,SysService,getDisplayText,neverNull,PRINT_DIV_ID,agreementTexts;function cleanupPrintElement(){var root=document.getElementById("root"),body=document.body,printDiv=document.getElementById(PRINT_DIV_ID);printDiv&&root&&body&&(body.removeChild(printDiv),root.className=root.className.split(" ").filter(function(c){return"noprint"!==c}).join(" "))}return _export("showForSigning",function(customer,accountingInfo){var version="1_"+("de"===lang.code?"de":"en"),addressEditor=(new HtmlEditor).setMinHeight(120).showBorders().setPlaceholderId("contractor_label").setMode(Mode.HTML).setHtmlMonospace(!1).setValue(formatNameAndAddress(accountingInfo.invoiceName,accountingInfo.invoiceAddress));Dialog.showActionDialog({title:lang.get("orderProcessingAgreement_label"),okAction:function(dialog){var data=createSignOrderProcessingAgreementData();data.version=version,data.customerAddress=addressEditor.getValue(),addressEditor.getValue().trim().split("\n").length<3?Dialog.error("contractorInfo_msg"):serviceRequestVoid(SysService.SignOrderProcessingAgreementService,HttpMethod.POST,data).then(function(){return dialog.close()})},okActionTextId:"sign_action",type:DialogType.EditLarge,child:function(){return m(".pt",[m.trust(agreementTexts[version].heading),m(".flex-center",m(".dialog-width-s",[m(addressEditor),m(".small",lang.get("contractorInfo_msg"))])),m.trust(agreementTexts[version].content),m.trust(agreementTexts[version].appendix)])}})}),_export("showForViewing",function(agreement,signerUserGroupInfo){Dialog.showActionDialog({title:lang.get("orderProcessingAgreement_label"),okAction:isApp()||"function"!=typeof window.print?null:function(){return function(elem){var root=document.getElementById("root"),body=document.body;if(elem&&root&&body){var printDiv=document.getElementById(PRINT_DIV_ID);if(!printDiv){(printDiv=document.createElement("DIV")).id=PRINT_DIV_ID,body.appendChild(printDiv);var classes=root.className.split(" ");classes.push("noprint"),root.className=classes.join(" ")}printDiv.innerHTML=elem.innerHTML,window.print()}}(document.getElementById("agreement-content"))},okActionTextId:"print_action",cancelActionTextId:"close_alt",type:DialogType.EditLarge,child:function(){return m("#agreement-content.pt",{onremove:cleanupPrintElement},[m.trust(agreementTexts[agreement.version].heading),m("p.text-center.text-prewrap",agreement.customerAddress),m.trust(agreementTexts[agreement.version].content),m("i",lang.get("signedOn_msg",{"{date}":formatDate(agreement.signatureDate)})+" "+lang.get("by_label")+" "+getDisplayText(signerUserGroupInfo.name,neverNull(signerUserGroupInfo.mailAddress),!1)),m("hr"),m.trust(agreementTexts[agreement.version].appendix)])}})}),{setters:[function(_mithril){m=_mithril.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isApp=_apiEnv.isApp},function(_miscFormatter){formatDate=_miscFormatter.formatDate,formatNameAndAddress=_miscFormatter.formatNameAndAddress},function(_guiBaseHtmlEditor){HtmlEditor=_guiBaseHtmlEditor.HtmlEditor,Mode=_guiBaseHtmlEditor.Mode},function(_apiMainEntity){serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_apiEntitiesSysSignOrderProcessingAgreementData){createSignOrderProcessingAgreementData=_apiEntitiesSysSignOrderProcessingAgreementData.createSignOrderProcessingAgreementData},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_mailMailUtils){getDisplayText=_mailMailUtils.getDisplayText},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull}],execute:function(){assertMainOrNode(),PRINT_DIV_ID="print-div",agreementTexts={"1_en":{heading:'<div class="papertext"><h3 style="text-align: center;" id="Orderprocessingagreement-Orderprocessingagreement">Order processing agreement</h3><p style="text-align: center;">between</p>',content:'<p style="text-align: center;">-&nbsp;controller -<br>hereinafter referred to as the Client</p><p style="text-align: center;">and</p><p style="text-align: center;">Tutao GmbH, Deisterstr. 17a, 30449 Hannover, Germany</p><p style="text-align: center;">-&nbsp;processor -<br>hereinafter referred to as the Supplier</p><p style="text-align: center;">&nbsp;</p><h4 id="Orderprocessingagreement-1.Subjectmatteranddurationoftheagreement">1.&nbsp;Subject matter and duration of the agreement</h4><p>The Subject matter of the agreement results from the Terms and Conditions of Tutao GmbH in its current version, see <span class="nolink">https://tutanota.com/terms</span>, which is referred to here (hereinafter referred to as Service Agreement). The Supplier processes personal data for the Client according to Art. 4 no. 2 and Art. 28 GDPR based on this agreement.</p><p>The duration of this Agreement corresponds to the selected term of policy in the selected tariff.</p><h4 id="Orderprocessingagreement-2.Purpose,TypeofDataandCategoriesofDataSubjects">2. Purpose, Type of Data and Categories of Data Subjects</h4><p>For the initiation of a contractual relationship and for service provision</p><ul><li>the newly registered email address</li></ul><p>is collected as inventory data.</p><p>For invoicing and determining the VAT</p><ul><li>the domicile of the customer (country)</li><li>the invoicing address</li><li>the VAT identification number (only for business customers of some countries)</li></ul><p>is collected as inventory data.</p><p>For the transaction of payments the following payment data (inventory data) is collected depending on the chosen payment method:</p><ul><li>Banking details (account number and sort code and IBAN/BIC, if necessary bank name, account holder),</li><li>credit card data,</li><li>PayPal user name.</li></ul><p>For the execution of direct debiting, the banking details are shared with the authorized credit institution. For the execution of PayPal payments, the PayPal data is shared with PayPal (Europe). For the execution of credit card payments, the credit card data is shared with the payment service provider&nbsp;Braintree&nbsp;for subprocessing. This includes the transfer of personal data into a third country (USA). An agreement entered into with Braintree defines appropriate safeguards and demands that the data is only processed in compliance with the GDPR and only for the purpose of execution of payments. This agreement can be examined here:&nbsp;<span class="nolink">https://www.braintreepayments.com/assets/Braintree-PSA-Model-Clauses-March2018.pdf</span></p><p>Tutanota provides services for saving, editing, presentation and electronic transmission of data, such as email service, contact management and data storage. Within the context of this content data, personal data of the Client may be processed. All textual content is encrypted for the user and its communication partners in a way that even Tutao GmbH has no access to the data.&nbsp;</p><p>In order to maintain email server operations, for error diagnosis and for prevention of abuse, mail server logs are stored max. 30 days. These logs contain sender and recipient email addresses and time of connection, but no customer IP addresses.&nbsp;</p><p>In order to maintain operations, for prevention of abuse and and for visitors analysis, IP addresses of users are processed. Storage only takes place for IP addresses made anonymous which are therefore not personal data any more.</p><p>With the exception of payment data, the personal data including the email address is not disclosed to third parties. However, Tutao GmbH can be legally bound to provide content data (in case of a valid German court order) and inventory data to prosecution services. There will be no sale of data.</p><p>The undertaking of the contractually agreed Processing of Data shall be carried out exclusively within a Member State of the European Union (EU) or within a Member State of the European Economic Area (EEA). Each and every Transfer of Data to a State which is not a Member State of either the EU or the EEA requires the prior agreement of the Client and shall only occur if the specific Conditions of Article 44 et seq. GDPR have been fulfilled.</p><p>The Categories of Data Subjects comprise the users set up in Tutanota by the Client and these users\' communication partners.</p><h4 id="Orderprocessingagreement-3.TechnicalandOrganizationalMeasures">3. Technical and Organizational Measures</h4><p>(1) Before the commencement of processing, the Supplier shall document the execution of the necessary Technical and Organizational Measures, set out in advance of the awarding of the Agreement, specifically with regard to the detailed execution of the Agreement, and shall present these documented measures to the Client for inspection. Upon acceptance by the Client, the documented measures become the foundation of the Agreement. Insofar as the inspection/audit by the Client shows the need for amendments, such amendments shall be implemented by mutual agreement.</p><p>(2) The Supplier shall establish the security in accordance with Article 28 Paragraph 3 Point c, and Article 32 GDPR in particular in conjunction with Article 5 Paragraph 1, and Paragraph 2 GDPR. The measures to be taken are measures of data security and measures that guarantee a protection level appropriate to the risk concerning confidentiality, integrity, availability and resilience of the systems. The state of the art, implementation costs, the nature, scope and purposes of processing as well as the probability of occurrence and the severity of the risk to the rights and freedoms of natural persons within the meaning of Article 32 Paragraph 1 GDPR must be taken into account. [Details in Appendix 1]</p><p>(3) The Technical and Organizational Measures are subject to technical progress and further development. In this respect, it is permissible for the Supplier to implement alternative adequate measures. In so doing, the security level of the defined measures must not be reduced. Substantial changes must be documented.</p><h4 id="Orderprocessingagreement-4.Rectification,restrictionanderasureofdata"><span>4. Rectification, restriction and erasure of data</span></h4><p>(1) The Supplier may not on its own authority rectify, erase or restrict the processing of data that is being processed on behalf of the Client, but only on documented instructions from the Client. <br>Insofar as a Data Subject contacts the Supplier directly concerning a rectification, erasure, or restriction of processing, the Supplier will immediately forward the Data Subject’s request to the Client.</p><p>(2) Insofar as it is included in the scope of services, the erasure policy, ‘right to be forgotten’, rectification, data portability and access shall be ensured by the Supplier in accordance with documented instructions from the Client without undue delay.</p><h4 id="Orderprocessingagreement-5.QualityassuranceandotherdutiesoftheSupplier">5. Quality assurance and other duties of the Supplier&nbsp;</h4><p align="justify">In addition to complying with the rules set out in this Agreement, the Supplier shall comply with the statutory requirements referred to in Articles 28 to 33 GDPR; accordingly, the Supplier ensures, in particular, compliance with the following requirements:</p><ol><li><p align="justify">The Supplier is not obliged to appoint a Data Protection Officer. Mr. Arne Moehle, phone: +49 511 202801-11, arne.moehle@tutao.de, is designated as the Contact Person on behalf of the Supplier.</p></li><li><p align="justify">Confidentiality in accordance with Article 28 Paragraph 3 Sentence 2 Point b, Articles 29 and 32 Paragraph 4 GDPR. The Supplier entrusts only such employees with the data processing outlined in this Agreement who have been bound to confidentiality and have previously been familiarized with the data protection provisions relevant to their work. The Supplier and any person acting under its authority who has access to personal data, shall not process that data unless on instructions from the Client, which includes the powers granted in this Agreement, unless required to do so by law.</p></li><li><p align="justify">Implementation of and compliance with all Technical and Organizational Measures necessary for this Agreement in accordance with Article 28 Paragraph 3 Sentence 2 Point c, Article 32 GDPR [details in Appendix 1].</p></li><li><p align="justify">The Client and the Supplier shall cooperate, on request, with the supervisory authority in performance of its tasks.</p></li><li><p align="justify">The Client shall be informed immediately of any inspections and measures conducted by the supervisory authority, insofar as they relate to this Agreement. This also applies insofar as the Supplier is under investigation or is party to an investigation by a competent authority in connection with infringements to any Civil or Criminal Law, or Administrative Rule or Regulation regarding the processing of personal data in connection with the processing of this Agreement.</p></li><li><p align="justify">Insofar as the Client is subject to an inspection by the supervisory authority, an administrative or summary offense or criminal procedure, a liability claim by a Data Subject or by a third party or any other claim in connection with the Agreement data processing by the Supplier, the Supplier shall make every effort to support the Client.</p></li><li><p align="justify">The Supplier shall periodically monitor the internal processes and the Technical and Organizational Measures to ensure that processing within his area of responsibility is in accordance with the requirements of applicable data protection law and the protection of the rights of the data subject.</p></li><li><p align="justify">Verifiability of the Technical and Organizational Measures conducted by the Client as part of the Client’s supervisory powers referred to in item 7 of this Agreement.</p></li></ol><h4 id="Orderprocessingagreement-6.Subcontracting">6. Subcontracting</h4><p align="justify">(1) Subcontracting for the purpose of this Agreement is to be understood as meaning services which relate directly to the provision of the principal service. This does not include ancillary services, such as telecommunication services, postal / transport services, maintenance and user support services or the disposal of data carriers, as well as other measures to ensure the confidentiality, availability, integrity and resilience of the hardware and software of data processing equipment. The Supplier shall, however, be obliged to make appropriate and legally binding contractual arrangements and take appropriate inspection measures to ensure the data protection and the data security of the Client\'s data, even in the case of outsourced ancillary services.</p><p align="justify">(2) The Supplier may commission subcontractors (additional contract processors) only after prior explicit written or documented consent from the Client.&nbsp;</p><p align="justify">(3) Outsourcing to subcontractors or changing the existing subcontractor are permissible when:</p><ul><li>The Supplier submits such an outsourcing to a subcontractor to the Client in writing or in text form with appropriate advance notice; and</li><li>The Client has not objected to the planned outsourcing in writing or in text form by the date of handing over the data to the Supplier; and</li><li>The subcontracting is based on a contractual agreement in accordance with Article 28 paragraphs 2-4 GDPR.</li></ul><p align="justify">(4) The transfer of personal data from the Client to the subcontractor and the subcontractors commencement of the data processing shall only be undertaken after compliance with all requirements has been achieved.</p><p align="justify">(5) If the subcontractor provides the agreed service outside the EU/EEA, the Supplier shall ensure compliance with EU Data Protection Regulations by appropriate measures. The same applies if service providers are to be used within the meaning of Paragraph 1 Sentence 2.</p><p align="justify">(6) Further outsourcing by the subcontractor requires the express consent of the main Client (at the minimum in text form);</p><p align="justify">(7) All contractual provisions in the contract chain shall be communicated to and agreed with each and every additional subcontractor.</p><h4 class="western" id="Orderprocessingagreement-7.SupervisorypowersoftheClient">7. Supervisory powers of the Client</h4><p align="justify">(1) The Client has the right, after consultation with the Supplier, to carry out inspections or to have them carried out by an auditor to be designated in each individual case. It has the right to convince itself of the compliance with this agreement by the Supplier in his business operations by means of random checks, which are ordinarily to be announced in good time.</p><p align="justify">(2) The Supplier shall ensure that the Client is able to verify compliance with the obligations of the Supplier in accordance with Article 28 GDPR. The Supplier undertakes to give the Client the necessary information on request and, in particular, to demonstrate the execution of the Technical and Organizational Measures.</p><p align="justify">(3) Evidence of such measures, which concern not only the specific Agreement, may be provided by</p><ul><li>Compliance with approved Codes of Conduct pursuant to Article 40 GDPR;</li><li>Certification according to an approved certification procedure in accordance with Article 42 GDPR;</li><li>Current auditor’s certificates, reports or excerpts from reports provided by independent bodies (e.g. auditor, Data Protection Officer, IT security department, data privacy auditor, quality auditor)</li><li>A suitable certification by IT security or data protection auditing (e.g. according to BSI-Grundschutz (IT Baseline Protection certification developed by the German&nbsp; Federal Office for Security in Information Technology (BSI)) or ISO/IEC 27001).</li></ul><p align="justify">(4) The Supplier may claim remuneration for enabling Client inspections.&nbsp;</p><h4 class="western" id="Orderprocessingagreement-8.CommunicationinthecaseofinfringementsbytheSupplier">8. Communication in the case of infringements by the Supplier</h4><p align="justify">(1) The Supplier shall assist the Client in complying with the obligations concerning the security of personal data, reporting requirements for data breaches, data protection impact assessments and prior consultations, referred to in Articles 32 to 36 of the GDPR. These include:</p><ol><li>Ensuring an appropriate level of protection through Technical and Organizational Measures that take into account the circumstances and purposes of the processing as well as the projected probability and severity of a possible infringement of the law as a result of security vulnerabilities and that enable an immediate detection of relevant infringement events.</li><li>The obligation to report a personal data breach immediately to the Client</li><li>The duty to assist the Client with regard to the Client’s obligation to provide information to the Data Subject concerned and to immediately provide the Client with all relevant information in this regard.</li><li>Supporting the Client with its data protection impact assessment</li><li>Supporting the Client with regard to prior consultation of the supervisory authority</li></ol><p align="justify">(2) The Supplier may claim compensation for support services which are not included in the description of the services and which are not attributable to failures on the part of the Supplier.</p><h4 class="western" id="Orderprocessingagreement-9.AuthorityoftheClienttoissueinstructions">9. Authority of the Client to issue instructions</h4><p>(1) The Client shall immediately confirm oral instructions (at the minimum in text form).</p><p>(2) The Supplier shall inform the Client immediately if he considers that an instruction violates Data Protection Regulations. The Supplier shall then be entitled to suspend the execution of the relevant instructions until the Client confirms or changes them.</p><h4 class="western" id="Orderprocessingagreement-10.Deletionandreturnofpersonaldata">10. Deletion and return of personal data</h4><p>(1) Copies or duplicates of the data shall never be created without the knowledge of the Client, with the exception of back-up copies as far as they are necessary to ensure orderly data processing, as well as data required to meet regulatory requirements to retain data.</p><p>(2) After conclusion of the contracted work, or earlier upon request by the Client, at the latest upon termination of the Service Agreement, the Supplier shall hand over to the Client or – subject to prior consent – destroy all documents, processing and utilization results, and data sets related to the Agreement that have come into its possession, in a data-protection compliant manner. The same applies to any and all connected test, waste, redundant and discarded material. The log of the destruction or deletion shall be provided on request.</p><p>(3) Documentation which is used to demonstrate orderly data processing in accordance with the Agreement shall be stored beyond the contract duration by the Supplier in accordance with the respective retention periods. It may hand such documentation over to the Client at the end of the contract duration to relieve the Supplier of this contractual obligation.</p><h4 id="Orderprocessingagreement-11.Finalprovisions">11. Final provisions</h4><p align="justify">(1) This agreement shall be governed by and construed in accordance with German law. Place of jurisdiction shall be Hanover, Germany.</p><p align="justify">(2) Any changes of or amendments to this Agreement must be in writing to become effective. This includes any alteration of this written form clause.</p><p align="justify" class="western">(3) Should any provision of this Agreement be or become legally invalid or if there is any void that needs to be filled, the validity of the remainder of the agreement shall not be affected thereby. Invalid provisions shall be replaced by common consent with such provisions which come as close as possible to the intended result of the invalid provision. In the event of gaps such provision shall come into force by common consent which comes as close as possible to the intended result of the agreement, should the matter have been considered in advance.</p><p align="justify">&nbsp;</p>',appendix:'<div class="pagebreak" style="break-before:always;"><p></p><h4 id="Orderprocessingagreement-Appendix1-TechnicalandOrganizationalMeasures">Appendix 1 - Technical and Organizational Measures&nbsp;</h4><p>System administrators are hereinafter referred to as "DevOps". The following Technical and Organizational Measures have been implemented:</p><ol><li>Entrance control: All systems are located in ISO 27001 certified&nbsp;data centers in Germany. Only DevOps are granted access to the physical systems.</li><li>Authentication access control: User access is secured with strong password protection according to the internal Password Policy or public key access control as well as second factor authentication (e.g. YubiKey).&nbsp;User access is managed by DevOps.</li><li>Authorization access control: Data records are secured with role based permissions. Permissions are managed by DevOps.</li><li>Data medium control: All hard discs containing personal data are encrypted. File permissions are allocated to DevOps users/roles as well as application users/roles to make sure no unauthorized access to files is allowed from logged in users and processes.</li><li>Transfer control: Transfer of personal data to other parties is being logged.&nbsp;Logs include the user/process that initiated the input, the type of personal data and the timestamp. The logs are kept for 6 months.</li><li>Input control: Input of new and updated as well as deletion of personal data is logged. Logs include the user/process that initiated the input, the type of personal data and the timestamp. The logs are kept for 6 months.</li><li>Transport control: Transport of personal data from and to the system are secured with strong SSL and/or end-to-end encryption.</li><li>Confidentiality: Personal data is stored end-to-end encrypted wherever possible.</li><li>Restoration control: All systems have a second network interface with access for DevOps only. This interface allows access even if the main interface is blocked. Components of the system can be restarted in case of error conditions. A DDOS mitigation service is automatically activated if a DDOS attack occurs that makes the system inaccessible.</li><li>Reliability:&nbsp;&nbsp;DevOps monitor all systems and are notified if any component of the system fails to be able to bring it up again immediately.</li><li>Data integrity: Automatic error correction on data mediums and also on database level make sure that data integrity is guaranteed. Additionally the integrity of end-to-end encrypted personal data is guaranteed through MACs during encryption and decryption.</li><li>Instruction control: All employees are aware of the purposes of processing and regularly complete&nbsp;an internal security awareness program. (Sub)processors are instructed by written contracts.</li><li>Availability control: All systems are located in ISO 27001 certified&nbsp;data centers in Germany which guarantee the physical availability and connection of the systems. All long-term data is stored as three replicas on different servers or in a RAID system. Backups are created prior to updating critical parts of the system.</li><li>Separability: Separate processing for personal data is set up as required.</li><li>Resilience: All systems use highly scalable components that are designed for much higher load than actually needed. All systems are expandable very quickly to continuously allow processing higher loads.</li></ol></div>\n</div>'},"1_de":{heading:'<div class="papertext"><h2 style="text-align: center;" id="VertragzurAuftragsverarbeitung-VertragzurAuftragsverarbeitung">Vertrag zur Auftragsverarbeitung</h2><p style="text-align: center;">zwischen</p>',content:'<p style="text-align: center;">-&nbsp;Verantwortlicher -<br>nachstehend Auftraggeber genannt&nbsp;</p><p style="text-align: center;">und</p><p style="text-align: center;">Tutao GmbH, Deisterstr. 17a, 30449 Hannover</p><p style="text-align: center;">-&nbsp;Auftragsverarbeiter -<br>nachstehend&nbsp;Auftragnehmer genannt</p><p style="text-align: center;">&nbsp;</p><h2 id="VertragzurAuftragsverarbeitung-1.GegenstandundDauer">1.&nbsp;Gegenstand und Dauer</h2><p>Der Gegenstand des Auftrags ergibt sich aus den AGB der Tutao GmbH in der jeweils gültigen Version, siehe <span class="nolink">https://tutanota.com/de/terms</span>, auf die hier verwiesen wird (im Folgenden Leistungsvereinbarung). Der&nbsp;Auftragnehmer verarbeitet dabei personenbezogene Daten für den Auftraggeber&nbsp;im Sinne von Art. 4 Nr. 2 und Art. 28 DS-GVO auf Grundlage dieses Vertrages.</p><p>Die Dauer dieses Auftrags entspricht der im jeweiligen Tarif gewählten Vertragslaufzeit.</p><h2 id="VertragzurAuftragsverarbeitung-2.Zweck,DatenkategorienundbetroffenePersonen">2. Zweck, Datenkategorien und betroffene Personen</h2><p>Zur Begründung eines Vertragsverhältnisses, und zur Leistungserbringung wird</p><ul><li>die neu registrierte E-Mail-Adresse</li></ul><p>als Bestandsdatum erfasst.</p><p>Für die Rechnungsstellung und Bestimmung der Umsatzsteuer&nbsp;werden</p><ul><li>der Sitz des Kunden (Land)</li><li>die Rechnungsadresse</li><li>die&nbsp;USt-IdNr. (nur für Geschäftskunden bestimmter Länder)</li></ul><p>als Bestandsdaten erfasst.</p><p>Zur Abwicklung von Zahlungen werden, je nach gewählter Zahlungsart, die folgenden Zahlungsdaten (Bestandsdaten) erfasst:</p><ul><li>Bankverbindung (Kontonummer und BLZ bzw. IBAN/BIC, ggf. Bankname, Kontoinhaber),</li><li>Kreditkartendaten,</li><li>der PayPal-Nutzername.</li></ul><p>Zur Abwicklung von Lastschriften wird die Bankverbindung an das beauftragte Kreditinstitut weitergegeben. <span>Zur Abwicklung von PayPal-Zahlungen werden die PayPal-Zahlungsdaten an PayPal (Europe) weitergegeben. </span>Zur Abwicklung von&nbsp;Kreditkartenzahlungen werden die Kreditkartendaten zur Auftragsverarbeitung an den Zahlungsdienstleister&nbsp;Braintree&nbsp;weitergegeben. Hierbei handelt es sich um eine Übermittlung von personenbezogenen Daten an ein Drittland. Ein mit Braintree geschlossener Vertrag sieht geeignete Garantien vor und stellt sicher, dass die weitergegebenen Daten nur im Einklang mit der DSGVO und lediglich zur Abwicklung von Zahlungen verwendet werden. Dieser Vertrag kann&nbsp;hier eingesehen werden:&nbsp;<span class="nolink">https://www.braintreepayments.com/assets/Braintree-PSA-Model-Clauses-March2018.pdf</span></p><p>Tutanota stellt Dienste zur Speicherung, Bearbeitung, Darstellung und elektronischem Versand von Daten bereit, wie z.B. E-Mail-Service, Kontaktverwaltung und Datenablage. Im Rahmen dieser Inhaltsdaten können personenbezogene Daten des Auftraggebers verarbeitet werden. Alle textuellen Inhalte werden verschlüsselt für den Nutzer und dessen Kommunikationspartner gespeichert, so dass die Tutao GmbH selbst keinen Zugriff auf diese Daten hat.</p><p>Zur Aufrechterhaltung des&nbsp;Mailserver-Betriebs, zur Fehlerdiagnose und zur Verhinderung von Missbrauch werden Mail-Server-Logs maximal 30 Tage gespeichert. Diese enthalten Sender- und Empfänger-E-Mail-Adressen sowie den Zeitpunkt der Verbindung, jedoch keine IP-Adressen der Benutzer.</p><p>Zur Sicherstellung des Betriebs, zur&nbsp;Verhinderung von Missbrauch und zur&nbsp;Besucherauswertung werden IP-Adressen der Benutzer verarbeitet. <span>Eine Speicherung erfolgt nur für anonymisierte und damit nicht mehr </span><span>personenbezogene </span><span>IP-Adressen.</span></p><p>Mit Ausnahme der Zahlungsdaten werden die personenbezogenen Daten inklusive der E-Mail-Adresse nicht an Dritte weitergegeben. Jedoch kann Tutao GmbH rechtlich verpflichtet werden Inhaltsdaten (bei Vorlage eines gültigen deutschen Gerichtsbeschlusses) sowie&nbsp;Bestandsdaten an Strafverfolgungsbehörden auszuliefern. Es erfolgt kein Verkauf von Daten.</p><p>Die Erbringung der vertraglich vereinbarten Datenverarbeitung findet ausschließlich in einem Mitgliedsstaat der Europäischen Union oder in einem anderen Vertragsstaat des Abkommens über den Europäischen Wirtschaftsraum statt.&nbsp;Jede Verlagerung in ein Drittland bedarf der vorherigen Zustimmung des Auftraggebers und darf nur erfolgen, wenn die besonderen Voraussetzungen der Art. 44 ff. DS-GVO erfüllt sind.&nbsp;</p><p>Die Kategorien der durch die Verarbeitung betroffenen Personen umfassen die durch den Auftraggeber in Tutanota eingerichtete Nutzer und deren Kommunikationspartner.</p><h2 id="VertragzurAuftragsverarbeitung-3.Technisch-organisatorischeMaßnahmen">3. Technisch-organisatorische Maßnahmen</h2><p>(1) Der&nbsp;Auftragnehmer hat die Umsetzung der im Vorfeld der Auftragsvergabe dargelegten und erforderlichen technischen und organisatorischen Maßnahmen vor Beginn der Verarbeitung, insbesondere hinsichtlich der konkreten Auftragsdurchführung zu dokumentieren und dem&nbsp;Auftraggeber zur Prüfung zu übergeben. Bei Akzeptanz durch den&nbsp;Auftraggeber&nbsp;werden die dokumentierten Maßnahmen Grundlage des Auftrags. Soweit die Prüfung des&nbsp;Auftraggebers einen Anpassungsbedarf ergibt, ist dieser einvernehmlich umzusetzen</p><p align="justify">(2) Der Auftragnehmer hat die Sicherheit gem. Art. 28 Abs. 3 lit. c, 32 DS-GVO insbesondere in Verbindung mit Art. 5 Abs. 1, Abs. 2 DS-GVO herzustellen. Insgesamt handelt es sich bei den zu treffenden Maßnahmen um Maßnahmen der Datensicherheit und zur Gewährleistung eines dem Risiko angemessenen Schutzniveaus hinsichtlich der Vertraulichkeit, der Integrität, der Verfügbarkeit sowie der Belastbarkeit der Systeme. Dabei sind der Stand der Technik, die Implementierungskosten und die Art, der Umfang und die Zwecke der Verarbeitung sowie die unterschiedliche Eintrittswahrscheinlichkeit und Schwere des Risikos für die Rechte und Freiheiten natürlicher Personen im Sinne von Art. 32 Abs. 1 DS-GVO zu berücksichtigen [Einzelheiten in Anlage 1].</p><p align="justify">(3) Die technischen und organisatorischen Maßnahmen unterliegen dem technischen Fortschritt und der Weiterentwicklung. Insoweit ist es dem Auftragnehmer gestattet, alternative adäquate Maßnahmen umzusetzen. Dabei darf das Sicherheitsniveau der festgelegten Maßnahmen nicht unterschritten werden. Wesentliche Änderungen sind zu dokumentieren.</p><h2 id="VertragzurAuftragsverarbeitung-4.Berichtigung,EinschränkungundLöschungvonDaten">4. Berichtigung, Einschränkung und Löschung von Daten</h2><p align="justify">(1) Der Auftragnehmer darf die Daten, die im Auftrag verarbeitet werden, nicht eigenmächtig sondern nur nach dokumentierter Weisung des Auftraggebers berichtigen, löschen oder deren Verarbeitung einschränken. Soweit eine betroffene Person sich diesbezüglich unmittelbar an den Auftragnehmer wendet, wird der Auftragnehmer dieses Ersuchen unverzüglich an den Auftraggeber weiterleiten.</p><p align="justify">(2) Soweit vom Leistungsumfang umfasst, sind Löschkonzept, Recht auf Vergessenwerden, Berichtigung, Datenportabilität und Auskunft nach dokumentierter Weisung des Auftraggebers unmittelbar durch den Auftragnehmer sicherzustellen.</p><h2 id="VertragzurAuftragsverarbeitung-5.QualitätssicherungundsonstigePflichtendesAuftragnehmers">5. Qualitätssicherung und sonstige Pflichten des Auftragnehmers</h2><p align="justify">Der Auftragnehmer hat zusätzlich zu der Einhaltung der Regelungen dieses Auftrags gesetzliche Pflichten gemäß Art. 28 bis 33 DS-GVO; insofern gewährleistet er insbesondere die Einhaltung folgender Vorgaben:</p><ol><li><p align="justify">Der Auftragnehmer ist nicht zur Bestellung eines Datenschutzbeauftragten verpflichtet. Als Ansprechpartner beim Auftragnehmer wird Herr Arne Möhle, Telefon: 0511 202801-11, arne.moehle@tutao.de, benannt.</p></li><li><p align="justify">Die Wahrung der Vertraulichkeit gemäß Art. 28 Abs. 3 S. 2 lit. b, 29, 32 Abs. 4 DS-GVO. Der Auftragnehmer setzt bei der Durchführung der Arbeiten nur Beschäftigte ein, die auf die Vertraulichkeit verpflichtet und zuvor mit den für sie relevanten Bestimmungen zum Datenschutz vertraut gemacht wurden. Der Auftragnehmer und jede dem Auftragnehmer unterstellte Person, die Zugang zu personenbezogenen Daten hat, dürfen diese Daten ausschließlich entsprechend der Weisung des Auftraggebers verarbeiten einschließlich der in diesem Vertrag eingeräumten Befugnisse, es sei denn, dass sie gesetzlich zur Verarbeitung verpflichtet sind.</p></li><li><p align="justify">Die Umsetzung und Einhaltung aller für diesen Auftrag erforderlichen technischen und organisatorischen Maßnahmen gemäß Art. 28 Abs. 3 S. 2 lit. c, 32 DS-GVO [Einzelheiten in Anlage 1].</p></li><li><p align="justify">Der Auftraggeber und der Auftragnehmer arbeiten auf Anfrage mit der Aufsichtsbehörde bei der Erfüllung ihrer Aufgaben zusammen.</p></li><li><p align="justify">Die unverzügliche Information des Auftragnehmers über Kontrollhandlungen und Maßnahmen der Aufsichtsbehörde, soweit sie sich auf diesen Auftrag beziehen. Dies gilt auch, soweit eine zuständige Behörde im Rahmen eines Ordnungswidrigkeits- oder Strafverfahrens in Bezug auf die Verarbeitung personenbezogener Daten bei der Auftragsverarbeitung beim Auftragnehmer ermittelt.</p></li><li><p align="justify">Soweit der Auftraggeber seinerseits einer Kontrolle der Aufsichtsbehörde, einem Ordnungswidrigkeits- oder Strafverfahren, dem Haftungsanspruch einer betroffenen Person oder eines Dritten oder einem anderen Anspruch im Zusammenhang mit der Auftragsverarbeitung beim Auftragnehmer ausgesetzt ist, hat ihn der Auftragnehmer nach besten Kräften zu unterstützen.</p></li><li><p align="justify">Der Auftragnehmer kontrolliert regelmäßig die internen Prozesse sowie die technischen und organisatorischen Maßnahmen, um zu gewährleisten, dass die Verarbeitung in seinem Verantwortungsbereich im Einklang mit den Anforderungen des geltenden Datenschutzrechts erfolgt und der Schutz der Rechte der betroffenen Person gewährleistet wird.</p></li><li><p align="justify">Nachweisbarkeit der getroffenen technischen und organisatorischen Maßnahmen gegenüber dem Auftraggeber im Rahmen seiner Kontrollbefugnisse nach Ziffer 7 dieses Vertrages.</p></li></ol><h2 id="VertragzurAuftragsverarbeitung-6.Unterauftragsverhältnisse">6. Unterauftragsverhältnisse</h2><p align="justify">(1) Als Unterauftragsverhältnisse im Sinne dieser Regelung sind solche Dienstleistungen zu verstehen, die sich unmittelbar auf die Erbringung der Hauptleistung beziehen. Nicht hierzu gehören Nebenleistungen, die der Auftragnehmer wie z.B. Telekommunikationsleistungen, Post-/Transportdienstleistungen, Wartung und Benutzerservice oder die Entsorgung von Datenträgern sowie sonstige Maßnahmen zur Sicherstellung der Vertraulichkeit, Verfügbarkeit, Integrität und Belastbarkeit der Hard- und Software von Datenverarbeitungsanlagen in Anspruch nimmt. Der Auftragnehmer ist jedoch verpflichtet, zur Gewährleistung des Datenschutzes und der Datensicherheit der Daten des Auftraggebers auch bei ausgelagerten Nebenleistungen angemessene und gesetzeskonforme vertragliche Vereinbarungen sowie Kontrollmaßnahmen zu ergreifen.</p><p align="justify">(2) Der Auftragnehmer darf Unterauftragnehmer (weitere Auftragsverarbeiter) nur nach vorheriger ausdrücklicher schriftlicher bzw. dokumentierter Zustimmung des Auftraggebers beauftragen.</p><p align="justify">(3) Die Auslagerung auf Unterauftragnehmer sowie der&nbsp;Wechsel der bestehenden Unterauftragnehmer sind zulässig, soweit:</p><ul><li>der Auftragnehmer eine solche Auslagerung auf Unterauftragnehmer dem Auftraggeber eine angemessene Zeit vorab schriftlich oder in Textform anzeigt und</li><li>der Auftraggeber nicht bis zum Zeitpunkt der Übergabe der Daten gegenüber dem Auftragnehmer schriftlich oder in Textform Einspruch gegen die geplante Auslagerung erhebt und</li><li>eine vertragliche Vereinbarung nach Maßgabe des Art. 28 Abs. 2-4 DS-GVO zugrunde gelegt wird.</li></ul><p align="justify">(4) Die Weitergabe von personenbezogenen Daten des Auftraggebers an den Unterauftragnehmer und dessen erstmaliges Tätigwerden sind erst mit Vorliegen aller Voraussetzungen für eine Unterbeauftragung gestattet.</p><p align="justify">(5) Erbringt der Unterauftragnehmer die vereinbarte Leistung außerhalb der EU/des EWR stellt der Auftragnehmer die datenschutzrechtliche Zulässigkeit durch entsprechende Maßnahmen sicher. Gleiches gilt, wenn Dienstleister im Sinne von Abs. 1 Satz 2 eingesetzt werden sollen.</p><p align="justify">(6) Eine weitere Auslagerung durch den Unterauftragnehmer bedarf der ausdrücklichen Zustimmung des Hauptauftraggebers (mind. Textform).</p><p align="justify">(7) Sämtliche vertraglichen Regelungen in der Vertragskette sind auch dem weiteren Unterauftragnehmer aufzuerlegen.</p><h2 class="western" id="VertragzurAuftragsverarbeitung-7.KontrollrechtedesAuftraggebers">7. Kontrollrechte des Auftraggebers</h2><p align="justify">(1) Der Auftraggeber hat das Recht, im Benehmen mit dem Auftragnehmer Überprüfungen durchzuführen oder durch im Einzelfall zu benennende Prüfer durchführen zu lassen. Er hat das Recht, sich durch Stichprobenkontrollen, die in der Regel rechtzeitig anzumelden sind, von der Einhaltung dieser Vereinbarung durch den Auftragnehmer in dessen Geschäftsbetrieb zu überzeugen.</p><p align="justify">(2) Der Auftragnehmer stellt sicher, dass sich der Auftraggeber von der Einhaltung der Pflichten des Auftragnehmers nach Art. 28 DS-GVO überzeugen kann. Der Auftragnehmer verpflichtet sich, dem Auftraggeber auf Anforderung die erforderlichen Auskünfte zu erteilen und insbesondere die Umsetzung der technischen und organisatorischen Maßnahmen nachzuweisen.</p><p align="justify">(3) Der Nachweis solcher Maßnahmen, die nicht nur den konkreten Auftrag betreffen, kann erfolgen durch</p><ul><li>die Einhaltung genehmigter Verhaltensregeln gemäß Art. 40 DS-GVO;</li><li>die Zertifizierung nach einem genehmigten Zertifizierungsverfahren gemäß Art. 42 DS-GVO;</li><li>aktuelle Testate, Berichte oder Berichtsauszüge unabhängiger Instanzen (z.B. Wirtschaftsprüfer, Revision, Datenschutzbeauftragter, IT-Sicherheitsabteilung, Datenschutzauditoren, Qualitätsauditoren);</li><li>eine geeignete Zertifizierung durch IT-Sicherheits- oder Datenschutzaudit (z.B. nach BSI-Grundschutz).</li></ul><p align="justify">(4) Für die Ermöglichung von Kontrollen durch den Auftraggeber kann der Auftragnehmer einen Vergütungsanspruch geltend machen.</p><h2 class="western" id="VertragzurAuftragsverarbeitung-8.MitteilungbeiVerstößendesAuftragnehmers">8. Mitteilung bei Verstößen des Auftragnehmers</h2><p align="justify">(1) Der Auftragnehmer unterstützt den Auftraggeber bei der Einhaltung der in den Artikeln 32 bis 36 der DS-GVO genannten Pflichten zur Sicherheit personenbezogener Daten, Meldepflichten bei Datenpannen, Datenschutz-Folgeabschätzungen und vorherige Konsultationen. Hierzu gehören u.a.</p><ol><li><p align="justify">die Sicherstellung eines angemessenen Schutzniveaus durch technische und organisatorische Maßnahmen, die die Umstände und Zwecke der Verarbeitung sowie die prognostizierte Wahrscheinlichkeit und Schwere einer möglichen Rechtsverletzung durch Sicherheitslücken berücksichtigen und eine sofortige Feststellung von relevanten Verletzungsereignissen ermöglichen</p></li><li><p align="justify">die Verpflichtung, Verletzungen personenbezogener Daten unverzüglich an den Auftraggeber zu melden</p></li><li><p align="justify">die Verpflichtung, dem Auftraggeber im Rahmen seiner Informationspflicht gegenüber dem Betroffenen zu unterstützen und ihm in diesem Zusammenhang sämtliche relevante Informationen unverzüglich zur Verfügung zu stellen</p></li><li><p align="justify">die Unterstützung des Auftraggebers für dessen Datenschutz-Folgenabschätzung</p></li><li><p align="justify">die Unterstützung des Auftraggebers im Rahmen vorheriger Konsultationen mit der Aufsichtsbehörde</p></li></ol><p align="justify">(2) Für Unterstützungsleistungen, die nicht in der Leistungsbeschreibung enthalten oder nicht auf ein Fehlverhalten des Auftragnehmers zurückzuführen sind, kann der Auftragnehmer eine Vergütung beanspruchen.</p><h2 class="western" id="VertragzurAuftragsverarbeitung-9.WeisungsbefugnisdesAuftraggebers">9. Weisungsbefugnis des Auftraggebers</h2><p align="justify">(1) Mündliche Weisungen bestätigt der Auftraggeber unverzüglich (mind. Textform).</p><p align="justify">(2) Der Auftragnehmer hat den Auftraggeber unverzüglich zu informieren, wenn er der Meinung ist, eine Weisung verstoße gegen Datenschutzvorschriften. Der Auftragnehmer ist berechtigt, die Durchführung der entsprechenden Weisung solange auszusetzen, bis sie durch den Auftraggeber bestätigt oder geändert wird.</p><h2 class="western" id="VertragzurAuftragsverarbeitung-10.LöschungundRückgabevonpersonenbezogenenDaten">10. Löschung und Rückgabe von personenbezogenen Daten</h2><p align="justify">(1) Kopien oder Duplikate der Daten werden ohne Wissen des Auftraggebers nicht erstellt. Hiervon ausgenommen sind Sicherheitskopien, soweit sie zur Gewährleistung einer ordnungsgemäßen Datenverarbeitung erforderlich sind, sowie Daten, die im Hinblick auf die Einhaltung gesetzlicher Aufbewahrungspflichten erforderlich sind.</p><p align="justify">(2) Nach Abschluss der vertraglich vereinbarten Arbeiten oder früher nach Aufforderung durch den Auftraggeber – spätestens mit Beendigung der Leistungsvereinbarung – hat der Auftragnehmer sämtliche in seinen Besitz gelangten Unterlagen, erstellte Verarbeitungs- und Nutzungsergebnisse sowie Datenbestände, die im Zusammenhang mit dem Auftragsverhältnis stehen, dem Auftraggeber auszuhändigen oder nach vorheriger Zustimmung datenschutzgerecht zu vernichten. Gleiches gilt für Test- und Ausschussmaterial. Das Protokoll der Löschung ist auf Anforderung vorzulegen.</p><p align="justify">(3) Dokumentationen, die dem Nachweis der auftrags- und ordnungsgemäßen Datenverarbeitung dienen, sind durch den Auftragnehmer entsprechend der jeweiligen Aufbewahrungsfristen über das Vertragsende hinaus aufzubewahren. Er kann sie zu seiner Entlastung bei Vertragsende dem Auftraggeber übergeben.</p><h2 id="VertragzurAuftragsverarbeitung-11.Schlussbestimmungen">11. Schlussbestimmungen</h2><p align="justify">(1) <span>Dieser Vertrag unterliegt dem Recht der Bundesrepublik Deutschland. Gerichtsstand ist Hannover.</span></p><p align="justify"><span>(2) Änderungen und Ergänzungen dieses Vertrags bedürfen der Schriftform. Dies gilt auch für den Verzicht auf das Schriftformerfordernis.</span></p><p align="justify" class="western">(3) <span>Sollten einzelne Bestimmungen dieses Vertrags unwirksam sein oder werden, so wird dadurch die Gültigkeit der übrigen Bestimmungen nicht berührt. Die Vertragsparteien verpflichten sich in diesen Fällen, anstelle der etwa unwirksamen Bestimmung(en) – mit Wirkung von Beginn der Unwirksamkeit an – eine Ersatzregelung oder ggf. einen neuen wirksamen Vertrag zu vereinbaren, die bzw. der dem wirtschaftlichen gewollten Zweck der unwirksamen Bestimmung(en) weitgehend entspricht oder am nächsten kommt. Dies gilt auch für den Fall, dass der Vertrag eine Regelungslücke enthalten sollte.</span></p><p align="justify">&nbsp;</p>',appendix:'<div class="pagebreak" style="break-before:always;"><p></p><h2 id="VertragzurAuftragsverarbeitung-Anlage1(TechnischeundorganisatorischeMaßnahmen)">Anlage 1 (Technische und organisatorische Maßnahmen)</h2><p>Die Systemadministratoren werden im Folgenden "DevOps" genannt. Folgende Maßnahmen wurden getroffen:</p><ol><li>Zutrittskontrolle: Alle Systeme sind in ISO 27001 zertifizierten Rechenzentren in Deutschland gehostet. Nur DevOps haben Zutritt zu den physischen Systemen.</li><li>Zugangskontrolle/Benutzerkontrolle: Der Zugriff durch Benutzer ist mit starken Passwörtern entsprechend den internen Passwortregeln oder Public-Key-Zugriff und Zwei-Faktor-Authentifizierung (e.g. YubiKey) gesichert.&nbsp;Benutzerzugriff wird von DevOps verwaltet.</li><li>Zugriffskontrolle/Speicherkontrolle: Datensätze sind mit rollenbasierten Berechtigungen geschützt. Berechtigungen werden von DevOps verwaltet.</li><li>Datenträgerkontrolle: <span>Alle Festplatten mit personenbezogenen Daten sind verschüsselt. Dateiberechtigungen sind für DevOps sowie Anwendungen so vergeben, dass unberechtigter Zugriff auf Dateien von eingeloggten Benutzern und Prozessen verhindert wird.</span></li><li>Übertragungskontrolle/Weitergabekontrolle: Weitergabe von personenbezogenen Daten an andere Empfänger wird protokolliert.&nbsp;Die Protokolle enthalten den Benutzer/Prozess, der die Eingabe initiiert hat, die Kategorie personenbezogener Daten und den Zeitstempel. Die Protokolle werden für sechs Monate aufgehoben.</li><li>Eingabekontrolle: Eingabe von neuen und aktualisierten sowie die Löschung von personenbezogenen Daten wird protokolliert. <span>Die Protokolle enthalten den Benutzer/Prozess, der die Eingabe initiiert hat, die Kategorie personenbezogener Daten und den Zeitstempel. Die Protokolle werden für sechs Monate aufgehoben.</span></li><li>Transportkontrolle: Übertragung von personenbezogenen Daten von und zu den Systemen ist durch starke SSL-Verschlüsselung und/oder Ende-zu-Ende-Verschlüsselung gesichert.</li><li>Vertraulichkeit: Personenbezogene Daten werden soweit möglich Ende-zu-Ende verschlüsselte gespeichert.</li><li>Wiederherstellbarkeit: Alle Systeme haben eine zweite Netzwerkschnittstelle, die nur den Zugriff von DevOps erlaubt. Diese Schnittstelle erlaubt den Zugriff selbst wenn die Hauptschnittstelle blockiert ist. Komponenten des Systems können im Fehlerfall neu gestartet werden. Ein Dienst zum Schutz vor DDOS-Angriffen wird automatisch gestartet, wenn solch ein Angriff erkannt wird.</li><li>Zuverlässigkeit:&nbsp;&nbsp;DevOps überwachen alle Systeme und werden automatisch benachrichtigt, wenn eine Komponente des Systems ausfällt, um diese sofort wieder aktivieren zu können.</li><li>Datenintegrität: Automatische Fehlerkorrektur auf Datenträgern und auf Datenbankebene stellt sicher, dass die Datenintegrität gewahrt bleibt. Zusätzlich wird die Integrität der Ende-zu-Ende verschlüsselten personenbezogenen Daten durch MACs bei der Ver- und Entschlüsselung sichergestellt.</li><li>Auftragskontrolle: Alle Mitarbeiter kennen die Zwecke der Verarbeitung und absolvieren regelmäßig ein internes Sicherheitstraining. Unterauftragnehmer werden nur schriftlich beauftragt.</li><li>Verfügbarkeitskontrolle: <span>Alle Systeme sind in ISO 27001 zertifizierten Rechenzentren in Deutschland gehostet, die die physische Verfügbarkeit und Verbindung der Systeme sicherstellen</span>. Alle langfristig gespeicherten Daten werden dreifach repliziert auf unterschiedlichen Servern oder in einem RAID-System abgelegt. Vor der Aktualisierung kritischer Teile des Systems werden Backups angelegt.</li><li>Trennbarkeit: Getrennte Verarbeitung von personenbezogenen Daten ist bedarfsabhängig eingerichtet.</li><li>Belastbarkeit: Alle Systeme bestehen aus hochskalierbaren Komponenten, die für viel höhere Lasten als tatsächlich benötigt ausgelegt sind. Alle Systeme sind kurzfristig erweiterbar, um kontinuierlich steigende Lasten verarbeiten zu können.</li></ol></div>\n</div>'}}}}}),System.register("src/subscription/SubscriptionViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../api/common/TutanotaConstants","../api/entities/sys/Customer","../api/common/utils/Utils","../api/entities/sys/CustomerInfo","../api/main/Entity","../api/main/LoginController","../misc/LanguageViewModel.js","../gui/base/Button","../gui/base/icons/Icons","../api/entities/sys/AccountingInfo","../api/main/WorkerClient","../api/common/EntityFunctions","../api/entities/sys/User","./PriceUtils","../misc/Formatter","../api/common/CountryList","../api/entities/sys/Booking","../api/entities/sys/Services","../api/entities/sys/MailAddressAliasServiceReturn","../settings/AddUserDialog","./EmailAliasOptionsDialog","../settings/AddGroupDialog","../settings/ContactFormEditor","./WhitelabelAndSharingBuyDialog","./StorageCapacityOptionsDialog","./UpgradeSubscriptionWizard","./SwitchSubscriptionDialog","mithril/stream/stream.js","./DeleteAccountDialog","../gui/base/Expander","../api/entities/sys/OrderProcessingAgreement","./SignOrderProcessingAgreementDialog","../api/entities/sys/GroupInfo","./InvoiceDataDialog","../api/common/error/RestError","../api/main/EventController","./SubscriptionUtils","../gui/base/ButtonN","../gui/base/TextFieldN","../gui/base/DropDownSelectorN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,AccountType,AccountTypeNames,BookingItemFeatureType,Const,CustomerTypeRef,downcast,neverNull,noOp,CustomerInfoTypeRef,load,loadRange,serviceRequest,logins,lang,Button,Icons,AccountingInfoTypeRef,worker,GENERATED_MAX_ID,HttpMethod,UserTypeRef,createNotAvailableForFreeClickHandler,formatPriceDataWithInfo,getCurrentCount,formatDate,formatNameAndAddress,formatStorageSize,getByAbbreviation,BookingTypeRef,SysService,MailAddressAliasServiceReturnTypeRef,AddUserDialog,EmailAliasOptionsDialog,AddGroupDialog,ContactFormEditor,WhitelabelAndSharingBuyDialog,StorageCapacityOptionsDialog,showUpgradeWizard,showSwitchDialog,stream,showDeleteAccountDialog,ExpanderButton,ExpanderPanel,OrderProcessingAgreementTypeRef,SignOrderAgreementDialog,GroupInfoTypeRef,InvoiceDataDialog,NotFoundError,isUpdateForTypeRef,getIncludedAliases,getIncludedStorageCapacity,getNbrOfUsers,getSubscriptionType,getTotalAliases,getTotalStorageCapacity,isSharingActive,isWhitelabelActive,ButtonN,ButtonType,TextFieldN,DropDownSelectorN,DAY,SubscriptionViewer;function changeSubscriptionInterval(accountingInfo,paymentInterval){if(accountingInfo&&accountingInfo.invoiceCountry&&Number(accountingInfo.paymentInterval)!==paymentInterval){var invoiceCountry=neverNull(getByAbbreviation(neverNull(accountingInfo.invoiceCountry)));worker.updatePaymentData(accountingInfo.business,paymentInterval,{invoiceAddress:formatNameAndAddress(accountingInfo.invoiceName,accountingInfo.invoiceAddress),country:invoiceCountry,vatNumber:accountingInfo.invoiceVatIdNo},null,invoiceCountry)}}return _export("changeSubscriptionInterval",changeSubscriptionInterval),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiCommonTutanotaConstants){AccountType=_apiCommonTutanotaConstants.AccountType,AccountTypeNames=_apiCommonTutanotaConstants.AccountTypeNames,BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,Const=_apiCommonTutanotaConstants.Const},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiCommonUtilsUtils){downcast=_apiCommonUtilsUtils.downcast,neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_apiMainEntity){load=_apiMainEntity.load,loadRange=_apiMainEntity.loadRange,serviceRequest=_apiMainEntity.serviceRequest},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_miscLanguageViewModelJs){lang=_miscLanguageViewModelJs.lang},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiEntitiesSysAccountingInfo){AccountingInfoTypeRef=_apiEntitiesSysAccountingInfo.AccountingInfoTypeRef},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonEntityFunctions){GENERATED_MAX_ID=_apiCommonEntityFunctions.GENERATED_MAX_ID,HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_apiEntitiesSysUser){UserTypeRef=_apiEntitiesSysUser.UserTypeRef},function(_PriceUtils){createNotAvailableForFreeClickHandler=_PriceUtils.createNotAvailableForFreeClickHandler,formatPriceDataWithInfo=_PriceUtils.formatPriceDataWithInfo,getCurrentCount=_PriceUtils.getCurrentCount},function(_miscFormatter){formatDate=_miscFormatter.formatDate,formatNameAndAddress=_miscFormatter.formatNameAndAddress,formatStorageSize=_miscFormatter.formatStorageSize},function(_apiCommonCountryList){getByAbbreviation=_apiCommonCountryList.getByAbbreviation},function(_apiEntitiesSysBooking){BookingTypeRef=_apiEntitiesSysBooking.BookingTypeRef},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiEntitiesSysMailAddressAliasServiceReturn){MailAddressAliasServiceReturnTypeRef=_apiEntitiesSysMailAddressAliasServiceReturn.MailAddressAliasServiceReturnTypeRef},function(_settingsAddUserDialog){AddUserDialog=_settingsAddUserDialog},function(_EmailAliasOptionsDialog){EmailAliasOptionsDialog=_EmailAliasOptionsDialog},function(_settingsAddGroupDialog){AddGroupDialog=_settingsAddGroupDialog},function(_settingsContactFormEditor){ContactFormEditor=_settingsContactFormEditor},function(_WhitelabelAndSharingBuyDialog){WhitelabelAndSharingBuyDialog=_WhitelabelAndSharingBuyDialog},function(_StorageCapacityOptionsDialog){StorageCapacityOptionsDialog=_StorageCapacityOptionsDialog},function(_UpgradeSubscriptionWizard){showUpgradeWizard=_UpgradeSubscriptionWizard.showUpgradeWizard},function(_SwitchSubscriptionDialog){showSwitchDialog=_SwitchSubscriptionDialog.showSwitchDialog},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_DeleteAccountDialog){showDeleteAccountDialog=_DeleteAccountDialog.showDeleteAccountDialog},function(_guiBaseExpander){ExpanderButton=_guiBaseExpander.ExpanderButton,ExpanderPanel=_guiBaseExpander.ExpanderPanel},function(_apiEntitiesSysOrderProcessingAgreement){OrderProcessingAgreementTypeRef=_apiEntitiesSysOrderProcessingAgreement.OrderProcessingAgreementTypeRef},function(_SignOrderProcessingAgreementDialog){SignOrderAgreementDialog=_SignOrderProcessingAgreementDialog},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_InvoiceDataDialog){InvoiceDataDialog=_InvoiceDataDialog},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_SubscriptionUtils){getIncludedAliases=_SubscriptionUtils.getIncludedAliases,getIncludedStorageCapacity=_SubscriptionUtils.getIncludedStorageCapacity,getNbrOfUsers=_SubscriptionUtils.getNbrOfUsers,getSubscriptionType=_SubscriptionUtils.getSubscriptionType,getTotalAliases=_SubscriptionUtils.getTotalAliases,getTotalStorageCapacity=_SubscriptionUtils.getTotalStorageCapacity,isSharingActive=_SubscriptionUtils.isSharingActive,isWhitelabelActive=_SubscriptionUtils.isWhitelabelActive},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN}],execute:function(){assertMainOrNode(),DAY=864e5,_export("SubscriptionViewer",SubscriptionViewer=function(){function SubscriptionViewer(){var _this=this;_classCallCheck(this,SubscriptionViewer);var subscriptionAction=new Button("subscription_label",function(){_this._accountingInfo&&_this._customer&&_this._customerInfo&&showSwitchDialog(_this._accountingInfo,_this._currentSubscription,getNbrOfUsers(_this._lastBooking),getTotalStorageCapacity(neverNull(_this._customer),neverNull(_this._customerInfo),_this._lastBooking),getTotalAliases(neverNull(_this._customer),neverNull(_this._customerInfo),_this._lastBooking),getIncludedStorageCapacity(neverNull(_this._customerInfo)),getIncludedAliases(neverNull(_this._customerInfo)),isSharingActive(_this._lastBooking),isWhitelabelActive(_this._lastBooking))},function(){return Icons.Edit}),upgradeActionAttrs={label:"upgrade_action",click:showUpgradeWizard,icon:function(){return Icons.Edit}},usageTypeActionAttrs={label:"pricing.businessUse_label",click:function(){return _this._switchToBusinessUse()},icon:function(){return Icons.Edit}},signOrderAgreementActionAttrs={label:"sign_action",click:function(){return SignOrderAgreementDialog.showForSigning(neverNull(_this._customer),neverNull(_this._accountingInfo))},icon:function(){return Icons.Edit}},showOrderAgreementActionAttrs={label:"show_action",click:function(){return load(GroupInfoTypeRef,neverNull(_this._orderAgreement).signerUserGroupInfo).then(function(signerUserGroupInfo){return SignOrderAgreementDialog.showForViewing(neverNull(_this._orderAgreement),signerUserGroupInfo)})},icon:function(){return Icons.Download}},subscriptionPeriods=[{name:lang.get("pricing.yearly_label")+", "+lang.get("automaticRenewal_label"),value:12},{name:lang.get("pricing.monthly_label")+", "+lang.get("automaticRenewal_label"),value:1}],isPremiumPredicate=function(){return logins.getUserController().isPremiumAccount()},addUserButtonAttrs={label:"addUsers_action",click:createNotAvailableForFreeClickHandler(!1,AddUserDialog.show,isPremiumPredicate),icon:function(){return Icons.Add},type:ButtonType.Action},editUsersButtonAttrs={label:"bookingItemUsers_label",click:createNotAvailableForFreeClickHandler(!1,function(){return m.route.set("/settings/users")},isPremiumPredicate),icon:function(){return Icons.Edit},type:ButtonType.Action},changeStorageCapacityButtonAttrs={label:"storageCapacity_label",click:createNotAvailableForFreeClickHandler(!1,function(){return StorageCapacityOptionsDialog.show()},isPremiumPredicate),icon:function(){return Icons.Edit},type:ButtonType.Action},changeEmailAliasPackageButtonAttrs={label:"emailAlias_label",click:createNotAvailableForFreeClickHandler(!0,EmailAliasOptionsDialog.show,isPremiumPredicate),icon:function(){return Icons.Edit}},addGroupsActionAttrs={label:"addGroup_label",click:createNotAvailableForFreeClickHandler(!1,AddGroupDialog.show,isPremiumPredicate),icon:function(){return Icons.Add}},editGroupsActionAttrs={label:"groups_label",click:createNotAvailableForFreeClickHandler(!1,function(){return m.route.set("/settings/groups")},isPremiumPredicate),icon:function(){return Icons.Edit}},addContactFormActionAttrs={label:"createContactForm_label",click:createNotAvailableForFreeClickHandler(!1,function(){return ContactFormEditor.show(null,!0,noOp)},isPremiumPredicate),icon:function(){return Icons.Add}},editContactFormsActionAttrs={label:"contactForms_label",click:createNotAvailableForFreeClickHandler(!1,function(){return m.route.set("/settings/contactforms")},isPremiumPredicate),icon:function(){return Icons.Edit}},enableWhiteLabelActionAttrs={label:"whitelabelDomain_label",click:createNotAvailableForFreeClickHandler(!1,function(){return WhitelabelAndSharingBuyDialog.showWhitelabelBuyDialog(!0)},isPremiumPredicate),icon:function(){return Icons.Edit}},disableWhiteLabelActionAttrs={label:"whitelabelDomain_label",click:createNotAvailableForFreeClickHandler(!1,function(){return WhitelabelAndSharingBuyDialog.showWhitelabelBuyDialog(!1)},isPremiumPredicate),icon:function(){return Icons.Cancel}},enableSharingActionAttrs={label:"sharingFeature_label",click:createNotAvailableForFreeClickHandler(!1,function(){return WhitelabelAndSharingBuyDialog.showSharingBuyDialog(!0)},isPremiumPredicate),icon:function(){return Icons.Edit}},disableSharingActionAttrs={label:"sharingFeature_label",click:createNotAvailableForFreeClickHandler(!1,function(){return WhitelabelAndSharingBuyDialog.showSharingBuyDialog(!1)},isPremiumPredicate),icon:function(){return Icons.Cancel}},deleteButtonAttrs={label:"adminDeleteAccount_action",click:showDeleteAccountDialog,type:ButtonType.Login},deleteAccountExpander=new ExpanderButton("adminDeleteAccount_action",new ExpanderPanel({view:function(){return m(".flex-center.mb-l",m("",{style:{width:"200px"}},m(ButtonN,deleteButtonAttrs)))}}),!1);this.view=function(){return m("#subscription-settings.fill-absolute.scroll.plr-l",[m(".h4.mt-l",lang.get("currentlyBooked_label")),m(TextFieldN,{label:"subscription_label",value:_this._subscriptionFieldValue,disabled:!0,injectionsRight:function(){return logins.getUserController().isFreeAccount()?m(ButtonN,upgradeActionAttrs):_this._isCancelled?null:[m(subscriptionAction)]}}),_this._showPriceData()?m(TextFieldN,{label:"businessOrPrivateUsage_label",value:_this._usageTypeFieldValue,disabled:!0,injectionsRight:function(){return _this._accountingInfo&&!_this._accountingInfo.business&&_this._customer&&!_this._customer.canceledPremiumAccount?m(ButtonN,usageTypeActionAttrs):null}}):null,_this._showOrderAgreement()?m(TextFieldN,{label:"orderProcessingAgreement_label",helpLabel:function(){return lang.get("orderProcessingAgreementInfo_msg")},value:_this._orderAgreementFieldValue,disabled:!0,injectionsRight:function(){return _this._orderAgreement&&_this._customer&&_this._customer.orderProcessingAgreementNeeded?[m(ButtonN,signOrderAgreementActionAttrs),m(ButtonN,showOrderAgreementActionAttrs)]:_this._orderAgreement?[m(ButtonN,showOrderAgreementActionAttrs)]:_this._customer&&_this._customer.orderProcessingAgreementNeeded?[m(ButtonN,signOrderAgreementActionAttrs)]:[]}}):null,_this._showPriceData()?m(DropDownSelectorN,{label:"subscriptionPeriod_label",helpLabel:function(){return _this._periodEndDate?lang.get("endOfSubscriptionPeriod_label",{"{1}":formatDate(_this._periodEndDate)}):""},items:subscriptionPeriods,selectedValue:_this._selectedSubscriptionInterval,dropdownWidth:300,selectionChangedHandler:function(value){_this._accountingInfo&&changeSubscriptionInterval(_this._accountingInfo,value)}}):null,_this._showPriceData()?m(TextFieldN,{label:function(){return _this._nextPeriodPriceVisible&&_this._periodEndDate?lang.get("priceTill_label",{"{date}":formatDate(_this._periodEndDate)}):lang.get("price_label")},value:_this._currentPriceFieldValue,disabled:!0}):null,_this._showPriceData()&&_this._nextPeriodPriceVisible&&_this._periodEndDate?m(TextFieldN,{label:function(){return lang.get("priceFrom_label",{"{date}":formatDate(new Date(neverNull(_this._periodEndDate).getTime()+DAY))})},helpLabel:function(){return lang.get("nextSubscriptionPrice_msg")},value:_this._nextPriceFieldValue,disabled:!0}):null,m(".h4.mt-l",lang.get("adminPremiumFeatures_action")),m(TextFieldN,{label:"bookingItemUsers_label",value:_this._usersFieldValue,disabled:!0,injectionsRight:function(){return[m(ButtonN,addUserButtonAttrs),m(ButtonN,editUsersButtonAttrs)]}}),m(TextFieldN,{label:"storageCapacity_label",value:_this._storageFieldValue,disabled:!0,injectionsRight:function(){return m(ButtonN,changeStorageCapacityButtonAttrs)}}),m(TextFieldN,{label:"mailAddressAliases_label",value:_this._emailAliasFieldValue,disabled:!0,injectionsRight:function(){return m(ButtonN,changeEmailAliasPackageButtonAttrs)}}),m(TextFieldN,{label:"groups_label",value:_this._groupsFieldValue,disabled:!0,injectionsRight:function(){return[m(ButtonN,addGroupsActionAttrs),m(ButtonN,editGroupsActionAttrs)]}}),m(TextFieldN,{label:"whitelabel_label",value:_this._whitelabelFieldValue,disabled:!0,injectionsRight:function(){return 0===getCurrentCount(BookingItemFeatureType.Branding,_this._lastBooking)?m(ButtonN,enableWhiteLabelActionAttrs):m(ButtonN,disableWhiteLabelActionAttrs)}}),m(TextFieldN,{label:"sharingFeature_label",value:_this._sharingFieldValue,disabled:!0,injectionsRight:function(){return 0===getCurrentCount(BookingItemFeatureType.Sharing,_this._lastBooking)?m(ButtonN,enableSharingActionAttrs):m(ButtonN,disableSharingActionAttrs)}}),m(TextFieldN,{label:"contactForms_label",value:_this._contactFormsFieldValue,disabled:!0,injectionsRight:function(){return[m(ButtonN,addContactFormActionAttrs),m(ButtonN,editContactFormsActionAttrs)]}}),m(".flex-space-between.items-center.mt-l.mb",[m(".h4",lang.get("adminDeleteAccount_action")),m(deleteAccountExpander)]),m(deleteAccountExpander.panel)])},load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return _this._updateOrderProcessingAgreement(customer),load(CustomerInfoTypeRef,customer.customerInfo)}).then(function(customerInfo){return _this._customerInfo=customerInfo,load(AccountingInfoTypeRef,customerInfo.accountingInfo)}).then(function(accountingInfo){_this._updateAccountInfoData(accountingInfo)});var loadingString=lang.get("loading_msg");this._currentPriceFieldValue=stream(loadingString),this._subscriptionFieldValue=stream(loadingString),this._usageTypeFieldValue=stream(loadingString),this._orderAgreementFieldValue=stream(loadingString),this._nextPriceFieldValue=stream(loadingString),this._usersFieldValue=stream(loadingString),this._storageFieldValue=stream(loadingString),this._emailAliasFieldValue=stream(loadingString),this._groupsFieldValue=stream(loadingString),this._whitelabelFieldValue=stream(loadingString),this._sharingFieldValue=stream(loadingString),this._contactFormsFieldValue=stream(loadingString),this._selectedSubscriptionInterval=stream(null),this._updatePriceInfo(),this._updateBookings()}return _createClass(SubscriptionViewer,[{key:"_showOrderAgreement",value:function(){return(logins.getUserController().isPremiumAccount()||logins.getUserController().isOutlookAccount())&&(null!=this._accountingInfo&&this._accountingInfo.business||null!=this._customer&&(null!=this._customer.orderProcessingAgreement||this._customer.orderProcessingAgreementNeeded))}},{key:"_updateOrderProcessingAgreement",value:function(customer){var _this2=this,p=Promise.resolve();this._customer=customer,this._customer.orderProcessingAgreement?p=load(OrderProcessingAgreementTypeRef,this._customer.orderProcessingAgreement).then(function(a){_this2._orderAgreement=a}):this._orderAgreement=null,p.then(function(){customer.orderProcessingAgreementNeeded?_this2._orderAgreementFieldValue(lang.get("signingNeeded_msg")):_this2._orderAgreement?_this2._orderAgreementFieldValue(lang.get("signedOn_msg",{"{date}":formatDate(_this2._orderAgreement.signatureDate)})):_this2._orderAgreementFieldValue(lang.get("notSigned_msg")),m.redraw()})}},{key:"_switchToBusinessUse",value:function(){if(this._accountingInfo&&!this._accountingInfo.business){var accountingInfo=neverNull(this._accountingInfo),invoiceCountry=neverNull(getByAbbreviation(neverNull(accountingInfo.invoiceCountry)));InvoiceDataDialog.show({businessUse:stream(!0),paymentInterval:stream(Number(accountingInfo.paymentInterval))},{invoiceAddress:formatNameAndAddress(accountingInfo.invoiceName,accountingInfo.invoiceAddress),country:invoiceCountry,vatNumber:""},"pricing.businessUse_label","businessChangeInfo_msg")}}},{key:"_showPriceData",value:function(){return logins.getUserController().isPremiumAccount()||logins.getUserController().isOutlookAccount()}},{key:"_updatePriceInfo",value:function(){var _this3=this;this._showPriceData()&&worker.getCurrentPrice().then(function(priceServiceReturn){null!=priceServiceReturn.currentPriceThisPeriod&&null!=priceServiceReturn.currentPriceNextPeriod&&(priceServiceReturn.currentPriceThisPeriod.price!==priceServiceReturn.currentPriceNextPeriod.price?(_this3._currentPriceFieldValue(formatPriceDataWithInfo(priceServiceReturn.currentPriceThisPeriod)),_this3._nextPriceFieldValue(formatPriceDataWithInfo(neverNull(priceServiceReturn.currentPriceNextPeriod))),_this3._nextPeriodPriceVisible=!0):(_this3._currentPriceFieldValue(formatPriceDataWithInfo(priceServiceReturn.currentPriceThisPeriod)),_this3._nextPeriodPriceVisible=!1),_this3._periodEndDate=priceServiceReturn.periodEndDate,m.redraw())})}},{key:"_updateAccountInfoData",value:function(accountingInfo){this._accountingInfo=accountingInfo,this._usageTypeFieldValue(accountingInfo.business?lang.get("pricing.businessUse_label"):lang.get("pricing.privateUse_label")),this._selectedSubscriptionInterval(Number(accountingInfo.paymentInterval)),m.redraw()}},{key:"_updateSubscriptionField",value:function(cancelled){var type,subscription,cancelledText=cancelled&&this._periodEndDate?" "+lang.get("cancelledBy_label",{"{endOfSubscriptionPeriod}":formatDate(this._periodEndDate)}):"",accountType=downcast(logins.getUserController().user.accountType);this._subscriptionFieldValue((type=accountType,subscription=this._currentSubscription,(type===AccountType.PREMIUM?subscription:AccountTypeNames[Number(type)])+cancelledText))}},{key:"_updateBookings",value:function(){var _this4=this;load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){load(CustomerInfoTypeRef,customer.customerInfo).catch(NotFoundError,function(e){return console.log("could not update bookings as customer info does not exist (moved between free/premium lists)")}).then(function(customerInfo){customerInfo&&(_this4._customerInfo=customerInfo,loadRange(BookingTypeRef,neverNull(customerInfo.bookings).items,GENERATED_MAX_ID,1,!0).then(function(bookings){_this4._lastBooking=bookings.length>0?bookings[bookings.length-1]:null,_this4._isCancelled=customer.canceledPremiumAccount,_this4._currentSubscription=getSubscriptionType(_this4._lastBooking,customer,customerInfo),_this4._updateSubscriptionField(_this4._isCancelled),Promise.all([_this4._updateUserField(),_this4._updateStorageField(customer,customerInfo),_this4._updateAliasField(customer,customerInfo),_this4._updateGroupsField(),_this4._updateWhitelabelField(),_this4._updateSharingField(),_this4._updateContactFormsField()]).then(function(){return m.redraw()})}))})})}},{key:"_updateUserField",value:function(){return this._usersFieldValue(""+Math.max(1,getCurrentCount(BookingItemFeatureType.Users,this._lastBooking))),Promise.resolve()}},{key:"_updateStorageField",value:function(customer,customerInfo){var _this5=this;return worker.readUsedCustomerStorage().then(function(usedStorage){var usedStorageFormatted=formatStorageSize(Number(usedStorage)),totalStorageFormatted=formatStorageSize(getTotalStorageCapacity(customer,customerInfo,_this5._lastBooking)*Const.MEMORY_GB_FACTOR);_this5._storageFieldValue(lang.get("amountUsedOf_label",{"{amount}":usedStorageFormatted,"{totalAmount}":totalStorageFormatted}))})}},{key:"_updateAliasField",value:function(customer,customerInfo){var _this6=this,totalAmount=getTotalAliases(customer,customerInfo,this._lastBooking);return 0===totalAmount?(this._emailAliasFieldValue("0"),Promise.resolve()):serviceRequest(SysService.MailAddressAliasService,HttpMethod.GET,null,MailAddressAliasServiceReturnTypeRef).then(function(aliasServiceReturn){_this6._emailAliasFieldValue(lang.get("amountUsedAndActivatedOf_label",{"{used}":aliasServiceReturn.usedAliases,"{active}":aliasServiceReturn.enabledAliases,"{totalAmount}":totalAmount}))}).return()}},{key:"_updateGroupsField",value:function(){var localAdminCount=getCurrentCount(BookingItemFeatureType.LocalAdminGroup,this._lastBooking),localAdminText=localAdminCount+" "+lang.get(1===localAdminCount?"localAdminGroup_label":"localAdminGroups_label"),sharedMailCount=getCurrentCount(BookingItemFeatureType.SharedMailGroup,this._lastBooking),sharedMailText=sharedMailCount+" "+lang.get(1===sharedMailCount?"sharedMailbox_label":"sharedMailboxes_label");return 0===localAdminCount?this._groupsFieldValue(sharedMailText):localAdminCount>0&&sharedMailCount>0?this._groupsFieldValue(sharedMailText+", "+localAdminText):this._groupsFieldValue(localAdminText),Promise.resolve()}},{key:"_updateContactFormsField",value:function(){var totalAmount=getCurrentCount(BookingItemFeatureType.ContactForm,this._lastBooking);return this._contactFormsFieldValue(totalAmount.toString()),Promise.resolve()}},{key:"_updateWhitelabelField",value:function(){return isWhitelabelActive(this._lastBooking)?this._whitelabelFieldValue(lang.get("active_label")):this._whitelabelFieldValue(lang.get("deactivated_label")),Promise.resolve()}},{key:"_updateSharingField",value:function(){return isSharingActive(this._lastBooking)?this._sharingFieldValue(lang.get("active_label")):this._sharingFieldValue(lang.get("deactivated_label")),Promise.resolve()}},{key:"entityEventsReceived",value:function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var update=_step.value;this.processUpdate(update)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}},{key:"processUpdate",value:function(update){var _this7=this,instanceId=update.instanceId;isUpdateForTypeRef(AccountingInfoTypeRef,update)?(load(AccountingInfoTypeRef,instanceId).then(function(accountingInfo){return _this7._updateAccountInfoData(accountingInfo)}),this._updatePriceInfo()):isUpdateForTypeRef(UserTypeRef,update)?(this._updateBookings(),this._updatePriceInfo()):isUpdateForTypeRef(BookingTypeRef,update)?(this._updateBookings(),this._updatePriceInfo()):isUpdateForTypeRef(CustomerTypeRef,update)&&load(CustomerTypeRef,instanceId).then(function(customer){return _this7._updateOrderProcessingAgreement(customer)})}}]),SubscriptionViewer}()),_export("SubscriptionViewer",SubscriptionViewer)}}}),System.register("src/subscription/InvoiceDataDialog.js",["mithril","../gui/base/Dialog","../misc/LanguageViewModel","./InvoiceDataInput","./InvoiceAndPaymentDataPage","../api/common/error/RestError"],function(_export,_context){"use strict";var m,Dialog,lang,InvoiceDataInput,updatePaymentData,BadRequestError;return _export("show",function(subscriptionOptions,invoiceData,headingId,infoMessageId){var invoiceDataInput=new InvoiceDataInput(subscriptionOptions,invoiceData),dialog=Dialog.showActionDialog({title:headingId?lang.get(headingId):lang.get("invoiceData_msg"),child:{view:function(){return m("#changeInvoiceDataDialog",[infoMessageId?m(".pt",lang.get(infoMessageId)):null,m(invoiceDataInput)])}},okAction:function(){var error=invoiceDataInput.validateInvoiceData();error?Dialog.error(error):updatePaymentData(subscriptionOptions,invoiceDataInput.getInvoiceData(),null,null,!1).then(function(success){success&&dialog.close()}).catch(BadRequestError,function(e){Dialog.error("paymentMethodNotAvailable_msg")})},allowCancel:!0,okActionTextId:"save_action"});return dialog}),{setters:[function(_mithril){m=_mithril.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_InvoiceDataInput){InvoiceDataInput=_InvoiceDataInput.InvoiceDataInput},function(_InvoiceAndPaymentDataPage){updatePaymentData=_InvoiceAndPaymentDataPage.updatePaymentData},function(_apiCommonErrorRestError){BadRequestError=_apiCommonErrorRestError.BadRequestError}],execute:function(){}}}),System.register("src/subscription/PaymentViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../api/common/utils/Utils","../api/main/Entity","../misc/LanguageViewModel.js","../gui/base/TextField","../api/entities/sys/AccountingInfo","../gui/base/HtmlEditor","./PriceUtils","./InvoiceDataDialog","../gui/base/icons/Icons","../api/common/EntityFunctions","../gui/base/TableN","../gui/base/ButtonN","../misc/Formatter","../api/common/TutanotaConstants","../api/main/WorkerClient","../file/FileController","../api/common/error/RestError","../gui/base/Dialog","../api/entities/sys/DebitServicePutData","../api/entities/sys/Services","../api/common/CountryList","./PaymentDataDialog","../gui/base/ProgressDialog","../api/main/EventController","mithril/stream/stream.js","./SubscriptionUtils","../gui/base/DialogHeaderBar","../gui/base/TextFieldN","../api/entities/accounting/Services","../api/entities/accounting/CustomerAccountReturn","../api/entities/sys/Customer","../api/main/LoginController","../api/entities/sys/CustomerInfo","../api/entities/sys/InvoiceInfo","../api/entities/accounting/CustomerAccountPosting","../gui/base/ExpanderN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,isIOSApp,neverNull,load,serviceRequest,serviceRequestVoid,lang,TextField,AccountingInfoTypeRef,HtmlEditor,Mode,createNotAvailableForFreeClickHandler,getPaymentMethodInfoText,getPaymentMethodName,InvoiceDataDialog,Icons,HttpMethod,ColumnWidth,TableN,ButtonN,ButtonType,formatDate,formatNameAndAddress,getPaymentMethodType,PaymentMethodType,PostingType,worker,fileController,BadGatewayError,PreconditionFailedError,TooManyRequestsError,Dialog,DialogType,createDebitServicePutData,SysService,getByAbbreviation,PaymentDataDialog,showProgressDialog,isUpdateForTypeRef,stream,formatPrice,getPreconditionFailedPaymentMsg,DialogHeaderBar,TextFieldN,AccountingService,CustomerAccountReturnTypeRef,CustomerTypeRef,logins,CustomerInfoTypeRef,InvoiceInfoTypeRef,createCustomerAccountPosting,ExpanderButtonN,ExpanderPanelN,PaymentViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isIOSApp=_apiEnv.isIOSApp},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiMainEntity){load=_apiMainEntity.load,serviceRequest=_apiMainEntity.serviceRequest,serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_miscLanguageViewModelJs){lang=_miscLanguageViewModelJs.lang},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_apiEntitiesSysAccountingInfo){AccountingInfoTypeRef=_apiEntitiesSysAccountingInfo.AccountingInfoTypeRef},function(_guiBaseHtmlEditor){HtmlEditor=_guiBaseHtmlEditor.HtmlEditor,Mode=_guiBaseHtmlEditor.Mode},function(_PriceUtils){createNotAvailableForFreeClickHandler=_PriceUtils.createNotAvailableForFreeClickHandler,getPaymentMethodInfoText=_PriceUtils.getPaymentMethodInfoText,getPaymentMethodName=_PriceUtils.getPaymentMethodName},function(_InvoiceDataDialog){InvoiceDataDialog=_InvoiceDataDialog},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth,TableN=_guiBaseTableN.TableN},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_miscFormatter){formatDate=_miscFormatter.formatDate,formatNameAndAddress=_miscFormatter.formatNameAndAddress},function(_apiCommonTutanotaConstants){getPaymentMethodType=_apiCommonTutanotaConstants.getPaymentMethodType,PaymentMethodType=_apiCommonTutanotaConstants.PaymentMethodType,PostingType=_apiCommonTutanotaConstants.PostingType},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_fileFileController){fileController=_fileFileController.fileController},function(_apiCommonErrorRestError){BadGatewayError=_apiCommonErrorRestError.BadGatewayError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError,TooManyRequestsError=_apiCommonErrorRestError.TooManyRequestsError},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_apiEntitiesSysDebitServicePutData){createDebitServicePutData=_apiEntitiesSysDebitServicePutData.createDebitServicePutData},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiCommonCountryList){getByAbbreviation=_apiCommonCountryList.getByAbbreviation},function(_PaymentDataDialog){PaymentDataDialog=_PaymentDataDialog},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_SubscriptionUtils){formatPrice=_SubscriptionUtils.formatPrice,getPreconditionFailedPaymentMsg=_SubscriptionUtils.getPreconditionFailedPaymentMsg},function(_guiBaseDialogHeaderBar){DialogHeaderBar=_guiBaseDialogHeaderBar.DialogHeaderBar},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_apiEntitiesAccountingServices){AccountingService=_apiEntitiesAccountingServices.AccountingService},function(_apiEntitiesAccountingCustomerAccountReturn){CustomerAccountReturnTypeRef=_apiEntitiesAccountingCustomerAccountReturn.CustomerAccountReturnTypeRef},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_apiEntitiesSysInvoiceInfo){InvoiceInfoTypeRef=_apiEntitiesSysInvoiceInfo.InvoiceInfoTypeRef},function(_apiEntitiesAccountingCustomerAccountPosting){createCustomerAccountPosting=_apiEntitiesAccountingCustomerAccountPosting.createCustomerAccountPosting},function(_guiBaseExpanderN){ExpanderButtonN=_guiBaseExpanderN.ExpanderButtonN,ExpanderPanelN=_guiBaseExpanderN.ExpanderPanelN}],execute:function(){assertMainOrNode(),_export("PaymentViewer",PaymentViewer=function(){function PaymentViewer(){var _this=this;_classCallCheck(this,PaymentViewer),this._invoiceAddressField=(new HtmlEditor).setMinHeight(140).showBorders().setMode(Mode.HTML).setHtmlMonospace(!1).setEnabled(!1).setPlaceholderId("invoiceAddress_label");var changeInvoiceDataButtonAttrs={label:"invoiceData_msg",click:createNotAvailableForFreeClickHandler(!0,function(){if(_this._accountingInfo){var accountingInfo=neverNull(_this._accountingInfo),invoiceCountry=accountingInfo.invoiceCountry?getByAbbreviation(accountingInfo.invoiceCountry):null;InvoiceDataDialog.show({businessUse:stream(accountingInfo.business),paymentInterval:stream(Number(accountingInfo.paymentInterval))},{invoiceAddress:formatNameAndAddress(accountingInfo.invoiceName,accountingInfo.invoiceAddress),country:invoiceCountry,vatNumber:accountingInfo.invoiceVatIdNo})}},function(){return logins.getUserController().isPremiumAccount()}),icon:function(){return Icons.Edit}},changePaymentDataButtonAttrs={label:"paymentMethod_label",click:createNotAvailableForFreeClickHandler(!0,function(){_this._accountingInfo&&PaymentDataDialog.show(_this._accountingInfo).then(function(success){if(success&&_this._isPayButtonVisible())return _this._showPayDialog(_this._openBalance())})},function(){return!isIOSApp()&&logins.getUserController().isPremiumAccount()}),icon:function(){return Icons.Edit}};this._invoiceVatNumber=new TextField("invoiceVatIdNo_label").setValue(lang.get("loading_msg")).setDisabled(),this._paymentMethodField=new TextField("paymentMethod_label").setValue(lang.get("loading_msg")).setDisabled(),this._paymentMethodField._injectionsRight=function(){return[m(ButtonN,changePaymentDataButtonAttrs)]},this._postings=[],this._paymentBusy=!1;var postingExpanded=stream(!1);this.view=function(){return m("#invoicing-settings.fill-absolute.scroll.plr-l",{role:"group"},[m(".flex-space-between.items-center.mt-l.mb-s",[m(".h4",lang.get("invoiceData_msg")),m(".mr-negative-s",m(ButtonN,changeInvoiceDataButtonAttrs))]),m(_this._invoiceAddressField),_this._accountingInfo&&_this._accountingInfo.invoiceVatIdNo.trim().length>0?m(_this._invoiceVatNumber):null,m(_this._paymentMethodField),_this._renderPostings(postingExpanded)])},load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerInfoTypeRef,customer.customerInfo)}).then(function(customerInfo){return load(AccountingInfoTypeRef,customerInfo.accountingInfo)}).then(function(accountingInfo){_this._updateAccountingInfoData(accountingInfo),load(InvoiceInfoTypeRef,neverNull(accountingInfo.invoiceInfo)).then(function(invoiceInfo){_this._invoiceInfo=invoiceInfo,m.redraw()})}),this._updatePostingsTable()}return _createClass(PaymentViewer,[{key:"_renderPostings",value:function(postingExpanded){var _this2=this;return this._postings&&0!==this._postings.length?[m(".h4.mt-l",lang.get("currentBalance_label")),m(".flex.center-horizontally.center-vertically.col",[m("div.h4.pt.pb"+(this._openBalance()?".content-accent-fg":""),formatPrice(Number(this._postings[0].balance),!0)),this._isPayButtonVisible()?m(".pb",{style:{width:"200px"}},m(ButtonN,{label:"invoicePay_action",type:ButtonType.Login,click:function(){return _this2._showPayDialog(_this2._openBalance())}})):null]),this._openBalance()&&this._accountingInfo&&this._accountingInfo.paymentMethod!==PaymentMethodType.Invoice?this._invoiceInfo&&this._invoiceInfo.paymentErrorInfo?m(".small.underline.b",lang.get(getPreconditionFailedPaymentMsg(new PreconditionFailedError("dummy-msg",this._invoiceInfo.paymentErrorInfo.errorCode)))):m(".small.underline.b",lang.get("failedDebitAttempt_msg")):null,m(".flex-space-between.items-center.mt-l.mb-s",[m(".h4",lang.get("postings_label")),m(ExpanderButtonN,{label:"show_action",expanded:postingExpanded})]),m(ExpanderPanelN,{expanded:postingExpanded},m(TableN,{columnHeading:["type_label","amount_label"],columnWidths:[ColumnWidth.Largest,ColumnWidth.Small,ColumnWidth.Small],columnAlignments:[!1,!0,!1],showActionButtonColumn:!0,lines:this._postings.map(function(posting){return{cells:function(){return[{main:function(posting){switch(posting.type){case PostingType.UsageFee:return lang.get("invoice_label");case PostingType.Credit:return lang.get("credit_label");case PostingType.Payment:return lang.get("adminPayment_action");case PostingType.Refund:return lang.get("refund_label");default:return""}}(posting),info:formatDate(posting.valueDate)},{main:formatPrice(Number(posting.amount),!0)}]},actionButtonAttrs:posting.type===PostingType.UsageFee?{label:"download_action",icon:function(){return Icons.Download},click:function(){showProgressDialog("pleaseWait_msg",worker.downloadInvoice(neverNull(posting.invoiceNumber))).then(function(pdfInvoice){return fileController.open(pdfInvoice)})}}:null}})})),m(".small",lang.get("invoiceSettingDescription_msg")+" "+lang.get("laterInvoicingInfo_msg"))]:null}},{key:"_updateAccountingInfoData",value:function(accountingInfo){this._accountingInfo=accountingInfo,this._invoiceAddressField.setValue(formatNameAndAddress(accountingInfo.invoiceName,accountingInfo.invoiceAddress,accountingInfo.invoiceCountry)),this._invoiceVatNumber.setValue(accountingInfo.invoiceVatIdNo),this._paymentMethodField.setValue(getPaymentMethodName(getPaymentMethodType(accountingInfo))+" "+getPaymentMethodInfoText(accountingInfo)),m.redraw()}},{key:"_openBalance",value:function(){if(null!=this._postings&&this._postings.length>0){var balance=Number(this._postings[0].balance);if(balance<0)return balance}return 0}},{key:"_updatePostingsTable",value:function(){var _this3=this;serviceRequest(AccountingService.CustomerAccountService,HttpMethod.GET,null,CustomerAccountReturnTypeRef).then(function(result){_this3._postings=result.postings,m.redraw()})}},{key:"entityEventsReceived",value:function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var update=_step.value;this.processUpdate(update)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}},{key:"processUpdate",value:function(update){var _this4=this,instanceId=update.instanceId;isUpdateForTypeRef(AccountingInfoTypeRef,update)?load(AccountingInfoTypeRef,instanceId).then(function(accountingInfo){return _this4._updateAccountingInfoData(accountingInfo)}):isUpdateForTypeRef(InvoiceInfoTypeRef,update)&&load(InvoiceInfoTypeRef,instanceId).then(function(invoiceInfo){_this4._invoiceInfo=invoiceInfo})}},{key:"_isPayButtonVisible",value:function(){return null!=this._accountingInfo&&(this._accountingInfo.paymentMethod===PaymentMethodType.CreditCard||this._accountingInfo.paymentMethod===PaymentMethodType.Paypal)&&this._openBalance()<0}},{key:"_showPayDialog",value:function(openBalance){var price,_this5=this;return this._paymentBusy=!0,(price=openBalance,new Promise(function(resolve){var dialog=void 0,doAction=function(res){dialog.close(),resolve(res)},actionBarAttrs={left:[{label:"cancel_action",click:function(){return doAction(!1)},type:ButtonType.Secondary}],right:[{label:"invoicePay_action",click:function(){return doAction(!0)},type:ButtonType.Primary}],middle:function(){return lang.get("adminPayment_action")}};dialog=new Dialog(DialogType.EditSmall,{view:function(){return[m(".dialog-header.plr-l",m(DialogHeaderBar,actionBarAttrs)),m(".plr-l.pb",m("",[m(".pt",lang.get("invoicePayConfirm_msg")),m(TextFieldN,{label:"price_label",value:stream(formatPrice(-price,!0)),disabled:!0})]))]}}).setCloseHandler(function(){return doAction(!1)}).show()})).then(function(confirmed){if(confirmed){var service=createDebitServicePutData();return showProgressDialog("pleaseWait_msg",serviceRequestVoid(SysService.DebitService,HttpMethod.PUT,service).then(function(){var mostCurrentPosting=_this5._postings[0],newPosting=createCustomerAccountPosting({valueDate:new Date,amount:String(-Number.parseFloat(mostCurrentPosting.balance)),balance:"0",type:PostingType.Payment});_this5._postings.unshift(newPosting),m.redraw()}).catch(PreconditionFailedError,function(error){return getPreconditionFailedPaymentMsg(error)}).catch(BadGatewayError,function(error){return"paymentProviderNotAvailableError_msg"}).catch(TooManyRequestsError,function(error){return"tooManyAttempts_msg"}))}}).then(function(errorId){if(errorId)return Dialog.error(errorId)}).finally(function(){return _this5._paymentBusy=!1})}}]),PaymentViewer}()),_export("PaymentViewer",PaymentViewer)}}}),System.register("src/settings/LocalAdminGroupInfoModel.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/main/Entity","../api/main/LoginController","../api/entities/sys/GroupInfo","../api/common/TutanotaConstants","../api/main/MainLocator","@hot","../api/main/EventController"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,loadAll,logins,GroupInfoTypeRef,GroupType,locator,replaced,isUpdateForTypeRef,LocalAdminGroupInfoModel,localAdminGroupInfoModel;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiMainEntity){loadAll=_apiMainEntity.loadAll},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiCommonTutanotaConstants){GroupType=_apiCommonTutanotaConstants.GroupType},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_hot){replaced=_hot.module},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef}],execute:function(){LocalAdminGroupInfoModel=function(){function LocalAdminGroupInfoModel(){_classCallCheck(this,LocalAdminGroupInfoModel),this._initialization=null,this.groupInfos=[]}return _createClass(LocalAdminGroupInfoModel,[{key:"init",value:function(){var _this=this;return this._initialization?this._initialization:(locator.eventController.addEntityListener(function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var update=_step.value;_this.entityEventReceived(update)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}),this._init())}},{key:"_init",value:function(){var _this2=this;return this._initialization=logins.getUserController().loadCustomer().then(function(customer){return loadAll(GroupInfoTypeRef,customer.teamGroups).filter(function(gi){return gi.groupType===GroupType.LocalAdmin}).then(function(groupInfos){return _this2.groupInfos=groupInfos,groupInfos})}),this._initialization}},{key:"entityEventReceived",value:function(update){isUpdateForTypeRef(GroupInfoTypeRef,update)&&this._init().then(function(){return m.redraw()})}}]),LocalAdminGroupInfoModel}(),_export("localAdminGroupInfoModel",localAdminGroupInfoModel=new LocalAdminGroupInfoModel),_export("localAdminGroupInfoModel",localAdminGroupInfoModel),replaced&&Object.assign(localAdminGroupInfoModel,replaced.localAdminGroupInfoModel)}}}),System.register("src/settings/GroupViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../gui/base/TextField","../gui/base/Button","../gui/base/Dialog","../api/main/Entity","../misc/Formatter","../misc/LanguageViewModel","../api/common/EntityFunctions","../gui/base/DropDownSelector","../api/common/utils/Utils","../api/entities/sys/Group","../api/common/TutanotaConstants","../api/entities/sys/GroupInfo","../api/common/utils/LazyLoaded","../api/common/error/RestError","../api/main/WorkerClient","../gui/base/Table","../gui/base/TableN","../api/entities/sys/GroupMember","../gui/base/TableLine","../api/main/LoginController","../api/entities/sys/User","../gui/base/icons/Icons","../gui/base/ProgressDialog","../subscription/BuyDialog","../api/entities/sys/AdministratedGroup","./LocalAdminGroupInfoModel","mithril/stream/stream.js","../api/main/EventController","../api/entities/sys/Customer"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,TextField,Button,Dialog,load,loadAll,loadRange,update,formatDateWithMonth,formatStorageSize,lang,GENERATED_MAX_ID,GENERATED_MIN_ID,isSameId,DropDownSelector,compareGroupInfos,getGroupInfoDisplayName,neverNull,GroupTypeRef,BookingItemFeatureType,GroupType,OperationType,GroupInfoTypeRef,LazyLoaded,BadRequestError,NotAuthorizedError,PreconditionFailedError,worker,Table,ColumnWidth,GroupMemberTypeRef,TableLine,logins,UserTypeRef,Icons,showProgressDialog,BuyDialog,AdministratedGroupTypeRef,localAdminGroupInfoModel,stream,isUpdateForTypeRef,CustomerTypeRef,GroupViewer;function getGroupTypeName(groupType){return groupType===GroupType.Mail?lang.get("sharedMailbox_label"):groupType===GroupType.LocalAdmin?lang.get("localAdmin_label"):groupType===GroupType.User?lang.get("userColumn_label"):groupType}return _export("getGroupTypeName",getGroupTypeName),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,loadRange=_apiMainEntity.loadRange,update=_apiMainEntity.update},function(_miscFormatter){formatDateWithMonth=_miscFormatter.formatDateWithMonth,formatStorageSize=_miscFormatter.formatStorageSize},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonEntityFunctions){GENERATED_MAX_ID=_apiCommonEntityFunctions.GENERATED_MAX_ID,GENERATED_MIN_ID=_apiCommonEntityFunctions.GENERATED_MIN_ID,isSameId=_apiCommonEntityFunctions.isSameId},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_apiCommonUtilsUtils){compareGroupInfos=_apiCommonUtilsUtils.compareGroupInfos,getGroupInfoDisplayName=_apiCommonUtilsUtils.getGroupInfoDisplayName,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEntitiesSysGroup){GroupTypeRef=_apiEntitiesSysGroup.GroupTypeRef},function(_apiCommonTutanotaConstants){BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,GroupType=_apiCommonTutanotaConstants.GroupType,OperationType=_apiCommonTutanotaConstants.OperationType},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_apiCommonErrorRestError){BadRequestError=_apiCommonErrorRestError.BadRequestError,NotAuthorizedError=_apiCommonErrorRestError.NotAuthorizedError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseTable){Table=_guiBaseTable.Table},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth},function(_apiEntitiesSysGroupMember){GroupMemberTypeRef=_apiEntitiesSysGroupMember.GroupMemberTypeRef},function(_guiBaseTableLine){TableLine=_guiBaseTableLine.default},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiEntitiesSysUser){UserTypeRef=_apiEntitiesSysUser.UserTypeRef},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_subscriptionBuyDialog){BuyDialog=_subscriptionBuyDialog},function(_apiEntitiesSysAdministratedGroup){AdministratedGroupTypeRef=_apiEntitiesSysAdministratedGroup.AdministratedGroupTypeRef},function(_LocalAdminGroupInfoModel){localAdminGroupInfoModel=_LocalAdminGroupInfoModel.localAdminGroupInfoModel},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef}],execute:function(){assertMainOrNode(),_export("GroupViewer",GroupViewer=function(){function GroupViewer(groupInfo){var _this=this;_classCallCheck(this,GroupViewer),this.groupInfo=groupInfo,this._group=new LazyLoaded(function(){return load(GroupTypeRef,_this.groupInfo.group)}),this._group.getAsync().then(function(){return m.redraw()}),this._members=new LazyLoaded(function(){return _this._group.getAsync().then(function(group){return loadRange(GroupMemberTypeRef,group.members,GENERATED_MIN_ID,200,!1).map(function(member){return load(GroupInfoTypeRef,member.userGroupInfo)})})}),this._name=new TextField("name_label").setValue(this.groupInfo.name).setDisabled();var editNameButton=new Button("edit_action",function(){Dialog.showTextInputDialog("edit_action","name_label",null,_this._name.value(),function(newName){return _this._group.isLoaded()&&_this._group.getLoaded().type===GroupType.MailingList&&""===newName.trim()?"enterName_msg":null}).then(function(newName){var newGroupInfo=Object.assign({},_this.groupInfo);newGroupInfo.name=newName,update(newGroupInfo)})},function(){return Icons.Edit});this._name._injectionsRight=function(){return[m(editNameButton)]};var mailAddress=new TextField("mailAddress_label").setValue(this.groupInfo.mailAddress).setDisabled(),created=new TextField("created_label").setValue(formatDateWithMonth(this.groupInfo.created)).setDisabled();this._usedStorage=new TextField("storageCapacityUsed_label").setValue(lang.get("loading_msg")).setDisabled(),localAdminGroupInfoModel.init().filter(function(groupInfo){return!groupInfo.deleted}).then(function(localAdminGroupInfos){var adminGroupIdToName=[{name:lang.get("globalAdmin_label"),value:null}].concat(localAdminGroupInfos.map(function(gi){return{name:getGroupInfoDisplayName(gi),value:gi.group}}));_this._administratedBy=new DropDownSelector("administratedBy_label",null,adminGroupIdToName,stream(_this.groupInfo.localAdmin)).setSelectionChangedHandler(function(localAdminId){_this.groupInfo.groupType===GroupType.LocalAdmin?Dialog.error("updateAdminshipLocalAdminGroupError_msg"):showProgressDialog("pleaseWait_msg",Promise.resolve().then(function(){var newAdminGroupId=localAdminId||neverNull(logins.getUserController().user.memberships.find(function(gm){return gm.groupType===GroupType.Admin})).group;return worker.updateAdminship(_this.groupInfo.group,newAdminGroupId)}))}),m.redraw()}),this._deactivated=new DropDownSelector("state_label",null,[{name:lang.get("activated_label"),value:!1},{name:lang.get("deactivated_label"),value:!0}],stream(null!=this.groupInfo.deleted)).setSelectionChangedHandler(function(deactivate){_this._members.getAsync().then(function(members){if(!(deactivate&&_this._members.getLoaded().length>0)){var bookingItemType=_this.groupInfo.groupType===GroupType.LocalAdmin?BookingItemFeatureType.LocalAdminGroup:BookingItemFeatureType.SharedMailGroup;return showProgressDialog("pleaseWait_msg",BuyDialog.show(bookingItemType,deactivate?-1:1,0,!deactivate).then(function(confirmed){if(confirmed)return _this._group.getAsync().then(function(group){return worker.deactivateGroup(group,!deactivate).catch(PreconditionFailedError,function(e){_this.groupInfo.groupType===GroupType.LocalAdmin?Dialog.error("localAdminGroupAssignedError_msg"):deactivate?Dialog.error("stillReferencedFromContactForm_msg"):Dialog.error("emailAddressInUse_msg")})})}))}Dialog.error("groupNotEmpty_msg")})});var addUserButton=new Button("addUserToGroup_label",function(){return _this._showAddMember()},function(){return Icons.Add});this._membersTable=new Table(["name_label","mailAddress_label"],[ColumnWidth.Largest,ColumnWidth.Largest],!0,addUserButton),this._updateMembers(),this.groupInfo.groupType===GroupType.LocalAdmin&&(this._administratedGroups=new LazyLoaded(function(){return _this._group.getAsync().then(function(group){return loadRange(AdministratedGroupTypeRef,neverNull(group.administratedGroups).items,GENERATED_MAX_ID,200,!0).map(function(administratedGroup){return load(GroupInfoTypeRef,administratedGroup.groupInfo)})})}),this._administratedGroupsTable=new Table(["type_label","name_label","mailAddress_label"],[ColumnWidth.Largest,ColumnWidth.Largest],!0),this._updateAdministratedGroups()),this.view=function(){return[m("#user-viewer.fill-absolute.scroll.plr-l",[m(".h4.mt-l",_this._group.isLoaded()?getGroupTypeName(_this._group.getLoaded().type):lang.get("emptyString_msg")),m("",[m(created),_this._isMailGroup()?m(_this._usedStorage):null]),m("",[m(_this._name),logins.getUserController().isGlobalAdmin()&&_this._administratedBy?m(_this._administratedBy):null,m(_this._deactivated)]),_this.groupInfo.deleted?null:m(".h4.mt-l.mb-s",lang.get("groupMembers_label")),_this.groupInfo.deleted?null:m(_this._membersTable),_this._isMailGroup()?m(".h4.mt-l",lang.get("mailSettings_label")):null,_this._isMailGroup()?m(".wrapping-row",[m("",[m(mailAddress)])]):null,_this.groupInfo.groupType!==GroupType.LocalAdmin?null:[m(".h4.mt-l.mb-s",lang.get("administratedGroups_label")),m(_this._administratedGroupsTable)]])]},this._updateUsedStorage()}return _createClass(GroupViewer,[{key:"_showAddMember",value:function(){var _this2=this;load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return loadAll(GroupInfoTypeRef,customer.userGroups).then(function(userGroupInfos){var globalAdmin=logins.isGlobalAdminUserLoggedIn(),localAdminGroupIds=logins.getUserController().getLocalAdminGroupMemberships().map(function(gm){return gm.group}),availableUserGroupInfos=userGroupInfos.filter(function(g){return!(!globalAdmin&&-1===localAdminGroupIds.indexOf(g.localAdmin))&&(!g.deleted&&null==_this2._members.getLoaded().find(function(m){return isSameId(m._id,g._id)}))});if(availableUserGroupInfos.length>0){availableUserGroupInfos.sort(compareGroupInfos);var dropdown=new DropDownSelector("userSettings_label",null,availableUserGroupInfos.map(function(g){return{name:getGroupInfoDisplayName(g),value:g}}),stream(availableUserGroupInfos[0]),250);Dialog.showActionDialog({title:lang.get("addUserToGroup_label"),child:{view:function(){return m(dropdown)}},allowOkWithReturn:!0,okAction:function(dialog){showProgressDialog("pleaseWait_msg",load(GroupTypeRef,dropdown.selectedValue().group).then(function(userGroup){return load(UserTypeRef,neverNull(userGroup.user)).then(function(user){worker.addUserToGroup(user,_this2.groupInfo.group)})})),dialog.close()}})}})})}},{key:"_updateMembers",value:function(){var _this3=this;this._members.reset(),this._members.getAsync().map(function(userGroupInfo){var removeButton=new Button("remove_action",function(){showProgressDialog("pleaseWait_msg",load(GroupTypeRef,userGroupInfo.group).then(function(userGroup){return worker.removeUserFromGroup(neverNull(userGroup.user),_this3.groupInfo.group)})).catch(NotAuthorizedError,function(e){Dialog.error("removeUserFromGroupNotAdministratedError_msg")})},function(){return Icons.Cancel});return new TableLine([userGroupInfo.name,neverNull(userGroupInfo.mailAddress)],removeButton)}).then(function(tableLines){_this3._membersTable.updateEntries(tableLines)})}},{key:"_updateAdministratedGroups",value:function(){var _this4=this;this._administratedGroups.reset(),this._administratedGroups.getAsync().map(function(groupInfo){var removeButton=null;return logins.getUserController().isGlobalAdmin()&&(removeButton=new Button("remove_action",function(){showProgressDialog("pleaseWait_msg",load(GroupTypeRef,groupInfo.group).then(function(userGroup){var adminGroupId=neverNull(logins.getUserController().user.memberships.find(function(m){return m.groupType===GroupType.Admin})).group;return worker.updateAdminship(groupInfo.group,adminGroupId)}))},function(){return Icons.Cancel})),new TableLine([getGroupTypeName(groupInfo.groupType),groupInfo.name,neverNull(groupInfo.mailAddress)],removeButton)}).then(function(tableLines){_this4._administratedGroupsTable.updateEntries(tableLines)})}},{key:"_isMailGroup",value:function(){return this.groupInfo.groupType===GroupType.Mail}},{key:"_updateUsedStorage",value:function(){var _this5=this;this._isMailGroup()?worker.readUsedGroupStorage(this.groupInfo.group).then(function(usedStorage){_this5._usedStorage.setValue(formatStorageSize(usedStorage)),m.redraw()}).catch(BadRequestError,function(e){}):this._usedStorage.setValue(formatStorageSize(0))}},{key:"entityEventsReceived",value:function(updates){var _this6=this,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_loop=function(){var update=_step.value,instanceListId=update.instanceListId,instanceId=update.instanceId,operation=update.operation;isUpdateForTypeRef(GroupInfoTypeRef,update)&&operation===OperationType.UPDATE?load(GroupInfoTypeRef,_this6.groupInfo._id).then(function(updatedUserGroupInfo){isSameId(_this6.groupInfo._id,[neverNull(instanceListId),instanceId])?(_this6.groupInfo=updatedUserGroupInfo,_this6._name.setValue(updatedUserGroupInfo.name),_this6._deactivated.selectedValue(null!=updatedUserGroupInfo.deleted),_this6._administratedBy&&_this6._administratedBy.selectedValue(_this6.groupInfo.localAdmin),_this6._updateUsedStorage(),m.redraw()):_this6._updateMembers()}):isUpdateForTypeRef(GroupMemberTypeRef,update)&&_this6._group.isLoaded()&&_this6._group.getLoaded().members===neverNull(instanceListId)?_this6._updateMembers():isUpdateForTypeRef(AdministratedGroupTypeRef,update)&&_this6._group.isLoaded()&&_this6._group.getLoaded().administratedGroups&&neverNull(_this6._group.getLoaded().administratedGroups).items===neverNull(instanceListId)&&_this6._updateAdministratedGroups()},_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)_loop()}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}]),GroupViewer}()),_export("GroupViewer",GroupViewer)}}}),System.registerDynamic("libs/qrcode.js",[],!0,function($__require,exports,module){this||self;function QR8bitByte(data){this.mode=QRMode.MODE_8BIT_BYTE,this.data=data,this.parsedData=[];for(var i=0,l=this.data.length;i<l;i++){var byteArray=[],code=this.data.charCodeAt(i);code>65536?(byteArray[0]=240|(1835008&code)>>>18,byteArray[1]=128|(258048&code)>>>12,byteArray[2]=128|(4032&code)>>>6,byteArray[3]=128|63&code):code>2048?(byteArray[0]=224|(61440&code)>>>12,byteArray[1]=128|(4032&code)>>>6,byteArray[2]=128|63&code):code>128?(byteArray[0]=192|(1984&code)>>>6,byteArray[1]=128|63&code):byteArray[0]=code,this.parsedData.push(byteArray)}this.parsedData=Array.prototype.concat.apply([],this.parsedData),this.parsedData.length!=this.data.length&&(this.parsedData.unshift(191),this.parsedData.unshift(187),this.parsedData.unshift(239))}function QRCodeModel(typeNumber,errorCorrectLevel){this.typeNumber=typeNumber,this.errorCorrectLevel=errorCorrectLevel,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}QR8bitByte.prototype={getLength:function(buffer){return this.parsedData.length},write:function(buffer){for(var i=0,l=this.parsedData.length;i<l;i++)buffer.put(this.parsedData[i],8)}},QRCodeModel.prototype={addData:function(data){var newData=new QR8bitByte(data);this.dataList.push(newData),this.dataCache=null},isDark:function(row,col){if(row<0||this.moduleCount<=row||col<0||this.moduleCount<=col)throw new Error(row+","+col);return this.modules[row][col]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(test,maskPattern){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(var col=0;col<this.moduleCount;col++)this.modules[row][col]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(test,maskPattern),this.typeNumber>=7&&this.setupTypeNumber(test),null==this.dataCache&&(this.dataCache=QRCodeModel.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,maskPattern)},setupPositionProbePattern:function(row,col){for(var r=-1;r<=7;r++)if(!(row+r<=-1||this.moduleCount<=row+r))for(var c=-1;c<=7;c++)col+c<=-1||this.moduleCount<=col+c||(this.modules[row+r][col+c]=0<=r&&r<=6&&(0==c||6==c)||0<=c&&c<=6&&(0==r||6==r)||2<=r&&r<=4&&2<=c&&c<=4)},getBestMaskPattern:function(){for(var minLostPoint=0,pattern=0,i=0;i<8;i++){this.makeImpl(!0,i);var lostPoint=QRUtil.getLostPoint(this);(0==i||minLostPoint>lostPoint)&&(minLostPoint=lostPoint,pattern=i)}return pattern},createMovieClip:function(target_mc,instance_name,depth){var qr_mc=target_mc.createEmptyMovieClip(instance_name,depth);this.make();for(var row=0;row<this.modules.length;row++)for(var y=1*row,col=0;col<this.modules[row].length;col++){var x=1*col;this.modules[row][col]&&(qr_mc.beginFill(0,100),qr_mc.moveTo(x,y),qr_mc.lineTo(x+1,y),qr_mc.lineTo(x+1,y+1),qr_mc.lineTo(x,y+1),qr_mc.endFill())}return qr_mc},setupTimingPattern:function(){for(var r=8;r<this.moduleCount-8;r++)null==this.modules[r][6]&&(this.modules[r][6]=r%2==0);for(var c=8;c<this.moduleCount-8;c++)null==this.modules[6][c]&&(this.modules[6][c]=c%2==0)},setupPositionAdjustPattern:function(){for(var pos=QRUtil.getPatternPosition(this.typeNumber),i=0;i<pos.length;i++)for(var j=0;j<pos.length;j++){var row=pos[i],col=pos[j];if(null==this.modules[row][col])for(var r=-2;r<=2;r++)for(var c=-2;c<=2;c++)this.modules[row+r][col+c]=-2==r||2==r||-2==c||2==c||0==r&&0==c}},setupTypeNumber:function(test){for(var bits=QRUtil.getBCHTypeNumber(this.typeNumber),i=0;i<18;i++){var mod=!test&&1==(bits>>i&1);this.modules[Math.floor(i/3)][i%3+this.moduleCount-8-3]=mod}for(i=0;i<18;i++){mod=!test&&1==(bits>>i&1);this.modules[i%3+this.moduleCount-8-3][Math.floor(i/3)]=mod}},setupTypeInfo:function(test,maskPattern){for(var data=this.errorCorrectLevel<<3|maskPattern,bits=QRUtil.getBCHTypeInfo(data),i=0;i<15;i++){var mod=!test&&1==(bits>>i&1);i<6?this.modules[i][8]=mod:i<8?this.modules[i+1][8]=mod:this.modules[this.moduleCount-15+i][8]=mod}for(i=0;i<15;i++){mod=!test&&1==(bits>>i&1);i<8?this.modules[8][this.moduleCount-i-1]=mod:i<9?this.modules[8][15-i-1+1]=mod:this.modules[8][15-i-1]=mod}this.modules[this.moduleCount-8][8]=!test},mapData:function(data,maskPattern){for(var inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0,col=this.moduleCount-1;col>0;col-=2)for(6==col&&col--;;){for(var c=0;c<2;c++)if(null==this.modules[row][col-c]){var dark=!1;byteIndex<data.length&&(dark=1==(data[byteIndex]>>>bitIndex&1)),QRUtil.getMask(maskPattern,row,col-c)&&(dark=!dark),this.modules[row][col-c]=dark,-1==--bitIndex&&(byteIndex++,bitIndex=7)}if((row+=inc)<0||this.moduleCount<=row){row-=inc,inc=-inc;break}}}},QRCodeModel.PAD0=236,QRCodeModel.PAD1=17,QRCodeModel.createData=function(typeNumber,errorCorrectLevel,dataList){for(var rsBlocks=QRRSBlock.getRSBlocks(typeNumber,errorCorrectLevel),buffer=new QRBitBuffer,i=0;i<dataList.length;i++){var data=dataList[i];buffer.put(data.mode,4),buffer.put(data.getLength(),QRUtil.getLengthInBits(data.mode,typeNumber)),data.write(buffer)}var totalDataCount=0;for(i=0;i<rsBlocks.length;i++)totalDataCount+=rsBlocks[i].dataCount;if(buffer.getLengthInBits()>8*totalDataCount)throw new Error("code length overflow. ("+buffer.getLengthInBits()+">"+8*totalDataCount+")");for(buffer.getLengthInBits()+4<=8*totalDataCount&&buffer.put(0,4);buffer.getLengthInBits()%8!=0;)buffer.putBit(!1);for(;!(buffer.getLengthInBits()>=8*totalDataCount||(buffer.put(QRCodeModel.PAD0,8),buffer.getLengthInBits()>=8*totalDataCount));)buffer.put(QRCodeModel.PAD1,8);return QRCodeModel.createBytes(buffer,rsBlocks)},QRCodeModel.createBytes=function(buffer,rsBlocks){for(var offset=0,maxDcCount=0,maxEcCount=0,dcdata=new Array(rsBlocks.length),ecdata=new Array(rsBlocks.length),r=0;r<rsBlocks.length;r++){var dcCount=rsBlocks[r].dataCount,ecCount=rsBlocks[r].totalCount-dcCount;maxDcCount=Math.max(maxDcCount,dcCount),maxEcCount=Math.max(maxEcCount,ecCount),dcdata[r]=new Array(dcCount);for(var i=0;i<dcdata[r].length;i++)dcdata[r][i]=255&buffer.buffer[i+offset];offset+=dcCount;var rsPoly=QRUtil.getErrorCorrectPolynomial(ecCount),modPoly=new QRPolynomial(dcdata[r],rsPoly.getLength()-1).mod(rsPoly);ecdata[r]=new Array(rsPoly.getLength()-1);for(i=0;i<ecdata[r].length;i++){var modIndex=i+modPoly.getLength()-ecdata[r].length;ecdata[r][i]=modIndex>=0?modPoly.get(modIndex):0}}var totalCodeCount=0;for(i=0;i<rsBlocks.length;i++)totalCodeCount+=rsBlocks[i].totalCount;var data=new Array(totalCodeCount),index=0;for(i=0;i<maxDcCount;i++)for(r=0;r<rsBlocks.length;r++)i<dcdata[r].length&&(data[index++]=dcdata[r][i]);for(i=0;i<maxEcCount;i++)for(r=0;r<rsBlocks.length;r++)i<ecdata[r].length&&(data[index++]=ecdata[r][i]);return data};for(var QRMode={MODE_NUMBER:1,MODE_ALPHA_NUM:2,MODE_8BIT_BYTE:4,MODE_KANJI:8},QRErrorCorrectLevel={L:1,M:0,Q:3,H:2},QRMaskPattern_PATTERN000=0,QRMaskPattern_PATTERN001=1,QRMaskPattern_PATTERN010=2,QRMaskPattern_PATTERN011=3,QRMaskPattern_PATTERN100=4,QRMaskPattern_PATTERN101=5,QRMaskPattern_PATTERN110=6,QRMaskPattern_PATTERN111=7,QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,34,62,90],[6,28,50,72,94],[6,26,50,74,98],[6,30,54,78,102],[6,28,54,80,106],[6,32,58,84,110],[6,30,58,86,114],[6,34,62,90,118],[6,26,50,74,98,122],[6,30,54,78,102,126],[6,26,52,78,104,130],[6,30,56,82,108,134],[6,34,60,86,112,138],[6,30,58,86,114,142],[6,34,62,90,118,146],[6,30,54,78,102,126,150],[6,24,50,76,102,128,154],[6,28,54,80,106,132,158],[6,32,58,84,110,136,162],[6,26,54,82,110,138,166],[6,30,58,86,114,142,170]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(data){for(var d=data<<10;QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0;)d^=QRUtil.G15<<QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15);return(data<<10|d)^QRUtil.G15_MASK},getBCHTypeNumber:function(data){for(var d=data<<12;QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18)>=0;)d^=QRUtil.G18<<QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G18);return data<<12|d},getBCHDigit:function(data){for(var digit=0;0!=data;)digit++,data>>>=1;return digit},getPatternPosition:function(typeNumber){return QRUtil.PATTERN_POSITION_TABLE[typeNumber-1]},getMask:function(maskPattern,i,j){switch(maskPattern){case QRMaskPattern_PATTERN000:return(i+j)%2==0;case QRMaskPattern_PATTERN001:return i%2==0;case QRMaskPattern_PATTERN010:return j%3==0;case QRMaskPattern_PATTERN011:return(i+j)%3==0;case QRMaskPattern_PATTERN100:return(Math.floor(i/2)+Math.floor(j/3))%2==0;case QRMaskPattern_PATTERN101:return i*j%2+i*j%3==0;case QRMaskPattern_PATTERN110:return(i*j%2+i*j%3)%2==0;case QRMaskPattern_PATTERN111:return(i*j%3+(i+j)%2)%2==0;default:throw new Error("bad maskPattern:"+maskPattern)}},getErrorCorrectPolynomial:function(errorCorrectLength){for(var a=new QRPolynomial([1],0),i=0;i<errorCorrectLength;i++)a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));return a},getLengthInBits:function(mode,type){if(1<=type&&type<10)switch(mode){case QRMode.MODE_NUMBER:return 10;case QRMode.MODE_ALPHA_NUM:return 9;case QRMode.MODE_8BIT_BYTE:case QRMode.MODE_KANJI:return 8;default:throw new Error("mode:"+mode)}else if(type<27)switch(mode){case QRMode.MODE_NUMBER:return 12;case QRMode.MODE_ALPHA_NUM:return 11;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 10;default:throw new Error("mode:"+mode)}else{if(!(type<41))throw new Error("type:"+type);switch(mode){case QRMode.MODE_NUMBER:return 14;case QRMode.MODE_ALPHA_NUM:return 13;case QRMode.MODE_8BIT_BYTE:return 16;case QRMode.MODE_KANJI:return 12;default:throw new Error("mode:"+mode)}}},getLostPoint:function(qrCode){for(var moduleCount=qrCode.getModuleCount(),lostPoint=0,row=0;row<moduleCount;row++)for(var col=0;col<moduleCount;col++){for(var sameCount=0,dark=qrCode.isDark(row,col),r=-1;r<=1;r++)if(!(row+r<0||moduleCount<=row+r))for(var c=-1;c<=1;c++)col+c<0||moduleCount<=col+c||0==r&&0==c||dark==qrCode.isDark(row+r,col+c)&&sameCount++;sameCount>5&&(lostPoint+=3+sameCount-5)}for(row=0;row<moduleCount-1;row++)for(col=0;col<moduleCount-1;col++){var count=0;qrCode.isDark(row,col)&&count++,qrCode.isDark(row+1,col)&&count++,qrCode.isDark(row,col+1)&&count++,qrCode.isDark(row+1,col+1)&&count++,0!=count&&4!=count||(lostPoint+=3)}for(row=0;row<moduleCount;row++)for(col=0;col<moduleCount-6;col++)qrCode.isDark(row,col)&&!qrCode.isDark(row,col+1)&&qrCode.isDark(row,col+2)&&qrCode.isDark(row,col+3)&&qrCode.isDark(row,col+4)&&!qrCode.isDark(row,col+5)&&qrCode.isDark(row,col+6)&&(lostPoint+=40);for(col=0;col<moduleCount;col++)for(row=0;row<moduleCount-6;row++)qrCode.isDark(row,col)&&!qrCode.isDark(row+1,col)&&qrCode.isDark(row+2,col)&&qrCode.isDark(row+3,col)&&qrCode.isDark(row+4,col)&&!qrCode.isDark(row+5,col)&&qrCode.isDark(row+6,col)&&(lostPoint+=40);var darkCount=0;for(col=0;col<moduleCount;col++)for(row=0;row<moduleCount;row++)qrCode.isDark(row,col)&&darkCount++;return lostPoint+=10*(Math.abs(100*darkCount/moduleCount/moduleCount-50)/5)}},QRMath={glog:function(n){if(n<1)throw new Error("glog("+n+")");return QRMath.LOG_TABLE[n]},gexp:function(n){for(;n<0;)n+=255;for(;n>=256;)n-=255;return QRMath.EXP_TABLE[n]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)},i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;for(i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];for(i=0;i<255;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;function QRPolynomial(num,shift){if(null==num.length)throw new Error(num.length+"/"+shift);for(var offset=0;offset<num.length&&0==num[offset];)offset++;this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset]}function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount,this.dataCount=dataCount}function QRBitBuffer(){this.buffer=[],this.length=0}QRPolynomial.prototype={get:function(index){return this.num[index]},getLength:function(){return this.num.length},multiply:function(e){for(var num=new Array(this.getLength()+e.getLength()-1),i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));return new QRPolynomial(num,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;for(var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0)),num=new Array(this.getLength()),i=0;i<this.getLength();i++)num[i]=this.get(i);for(i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);return new QRPolynomial(num,0).mod(e)}},QRRSBlock.RS_BLOCK_TABLE=[[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[1,134,108],[2,67,43],[2,33,15,2,34,16],[2,33,11,2,34,12],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[2,98,78],[4,49,31],[2,32,14,4,33,15],[4,39,13,1,40,14],[2,121,97],[2,60,38,2,61,39],[4,40,18,2,41,19],[4,40,14,2,41,15],[2,146,116],[3,58,36,2,59,37],[4,36,16,4,37,17],[4,36,12,4,37,13],[2,86,68,2,87,69],[4,69,43,1,70,44],[6,43,19,2,44,20],[6,43,15,2,44,16],[4,101,81],[1,80,50,4,81,51],[4,50,22,4,51,23],[3,36,12,8,37,13],[2,116,92,2,117,93],[6,58,36,2,59,37],[4,46,20,6,47,21],[7,42,14,4,43,15],[4,133,107],[8,59,37,1,60,38],[8,44,20,4,45,21],[12,33,11,4,34,12],[3,145,115,1,146,116],[4,64,40,5,65,41],[11,36,16,5,37,17],[11,36,12,5,37,13],[5,109,87,1,110,88],[5,65,41,5,66,42],[5,54,24,7,55,25],[11,36,12],[5,122,98,1,123,99],[7,73,45,3,74,46],[15,43,19,2,44,20],[3,45,15,13,46,16],[1,135,107,5,136,108],[10,74,46,1,75,47],[1,50,22,15,51,23],[2,42,14,17,43,15],[5,150,120,1,151,121],[9,69,43,4,70,44],[17,50,22,1,51,23],[2,42,14,19,43,15],[3,141,113,4,142,114],[3,70,44,11,71,45],[17,47,21,4,48,22],[9,39,13,16,40,14],[3,135,107,5,136,108],[3,67,41,13,68,42],[15,54,24,5,55,25],[15,43,15,10,44,16],[4,144,116,4,145,117],[17,68,42],[17,50,22,6,51,23],[19,46,16,6,47,17],[2,139,111,7,140,112],[17,74,46],[7,54,24,16,55,25],[34,37,13],[4,151,121,5,152,122],[4,75,47,14,76,48],[11,54,24,14,55,25],[16,45,15,14,46,16],[6,147,117,4,148,118],[6,73,45,14,74,46],[11,54,24,16,55,25],[30,46,16,2,47,17],[8,132,106,4,133,107],[8,75,47,13,76,48],[7,54,24,22,55,25],[22,45,15,13,46,16],[10,142,114,2,143,115],[19,74,46,4,75,47],[28,50,22,6,51,23],[33,46,16,4,47,17],[8,152,122,4,153,123],[22,73,45,3,74,46],[8,53,23,26,54,24],[12,45,15,28,46,16],[3,147,117,10,148,118],[3,73,45,23,74,46],[4,54,24,31,55,25],[11,45,15,31,46,16],[7,146,116,7,147,117],[21,73,45,7,74,46],[1,53,23,37,54,24],[19,45,15,26,46,16],[5,145,115,10,146,116],[19,75,47,10,76,48],[15,54,24,25,55,25],[23,45,15,25,46,16],[13,145,115,3,146,116],[2,74,46,29,75,47],[42,54,24,1,55,25],[23,45,15,28,46,16],[17,145,115],[10,74,46,23,75,47],[10,54,24,35,55,25],[19,45,15,35,46,16],[17,145,115,1,146,116],[14,74,46,21,75,47],[29,54,24,19,55,25],[11,45,15,46,46,16],[13,145,115,6,146,116],[14,74,46,23,75,47],[44,54,24,7,55,25],[59,46,16,1,47,17],[12,151,121,7,152,122],[12,75,47,26,76,48],[39,54,24,14,55,25],[22,45,15,41,46,16],[6,151,121,14,152,122],[6,75,47,34,76,48],[46,54,24,10,55,25],[2,45,15,64,46,16],[17,152,122,4,153,123],[29,74,46,14,75,47],[49,54,24,10,55,25],[24,45,15,46,46,16],[4,152,122,18,153,123],[13,74,46,32,75,47],[48,54,24,14,55,25],[42,45,15,32,46,16],[20,147,117,4,148,118],[40,75,47,7,76,48],[43,54,24,22,55,25],[10,45,15,67,46,16],[19,148,118,6,149,119],[18,75,47,31,76,48],[34,54,24,34,55,25],[20,45,15,61,46,16]],QRRSBlock.getRSBlocks=function(typeNumber,errorCorrectLevel){var rsBlock=QRRSBlock.getRsBlockTable(typeNumber,errorCorrectLevel);if(null==rsBlock)throw new Error("bad rs block @ typeNumber:"+typeNumber+"/errorCorrectLevel:"+errorCorrectLevel);for(var length=rsBlock.length/3,list=[],i=0;i<length;i++)for(var count=rsBlock[3*i+0],totalCount=rsBlock[3*i+1],dataCount=rsBlock[3*i+2],j=0;j<count;j++)list.push(new QRRSBlock(totalCount,dataCount));return list},QRRSBlock.getRsBlockTable=function(typeNumber,errorCorrectLevel){switch(errorCorrectLevel){case QRErrorCorrectLevel.L:return QRRSBlock.RS_BLOCK_TABLE[4*(typeNumber-1)+0];case QRErrorCorrectLevel.M:return QRRSBlock.RS_BLOCK_TABLE[4*(typeNumber-1)+1];case QRErrorCorrectLevel.Q:return QRRSBlock.RS_BLOCK_TABLE[4*(typeNumber-1)+2];case QRErrorCorrectLevel.H:return QRRSBlock.RS_BLOCK_TABLE[4*(typeNumber-1)+3];default:return}},QRBitBuffer.prototype={get:function(index){var bufIndex=Math.floor(index/8);return 1==(this.buffer[bufIndex]>>>7-index%8&1)},put:function(num,length){for(var i=0;i<length;i++)this.putBit(1==(num>>>length-i-1&1))},getLengthInBits:function(){return this.length},putBit:function(bit){var bufIndex=Math.floor(this.length/8);this.buffer.length<=bufIndex&&this.buffer.push(0),bit&&(this.buffer[bufIndex]|=128>>>this.length%8),this.length++}};var QRCodeLimitLength=[[17,14,11,7],[32,26,20,14],[53,42,32,24],[78,62,46,34],[106,84,60,44],[134,106,74,58],[154,122,86,64],[192,152,108,84],[230,180,130,98],[271,213,151,119],[321,251,177,137],[367,287,203,155],[425,331,241,177],[458,362,258,194],[520,412,292,220],[586,450,322,250],[644,504,364,280],[718,560,394,310],[792,624,442,338],[858,666,482,382],[929,711,509,403],[1003,779,565,439],[1091,857,611,461],[1171,911,661,511],[1273,997,715,535],[1367,1059,751,593],[1465,1125,805,625],[1528,1190,868,658],[1628,1264,908,698],[1732,1370,982,742],[1840,1452,1030,790],[1952,1538,1112,842],[2068,1628,1168,898],[2188,1722,1228,958],[2303,1809,1283,983],[2431,1911,1351,1051],[2563,1989,1423,1093],[2699,2099,1499,1139],[2809,2213,1579,1219],[2953,2331,1663,1273]];function QRCode(options){if(this.options={padding:4,width:256,height:256,typeNumber:4,color:"#000000",background:"#ffffff",ecl:"M"},"string"==typeof options&&(options={content:options}),options)for(var i in options)this.options[i]=options[i];if("string"!=typeof this.options.content)throw new Error("Expected 'content' as string!");if(0===this.options.content.length)throw new Error("Expected 'content' to be non-empty!");if(!(this.options.padding>=0))throw new Error("Expected 'padding' value to be non-negative!");if(!(this.options.width>0&&this.options.height>0))throw new Error("Expected 'width' or 'height' value to be higher than zero!");var content=this.options.content,type=function(content,ecl){for(var length=function(content){var result=encodeURI(content).toString().replace(/\%[0-9a-fA-F]{2}/g,"a");return result.length+(result.length!=content?3:0)}(content),type=1,limit=0,i=0,len=QRCodeLimitLength.length;i<=len;i++){var table=QRCodeLimitLength[i];if(!table)throw new Error("Content too long: expected "+limit+" but got "+length);switch(ecl){case"L":limit=table[0];break;case"M":limit=table[1];break;case"Q":limit=table[2];break;case"H":limit=table[3];break;default:throw new Error("Unknwon error correction level: "+ecl)}if(length<=limit)break;type++}if(type>QRCodeLimitLength.length)throw new Error("Content too long");return type}(content,this.options.ecl),ecl=function(ecl){switch(ecl){case"L":return QRErrorCorrectLevel.L;case"M":return QRErrorCorrectLevel.M;case"Q":return QRErrorCorrectLevel.Q;case"H":return QRErrorCorrectLevel.H;default:throw new Error("Unknwon error correction level: "+ecl)}}(this.options.ecl);this.qrcode=new QRCodeModel(type,ecl),this.qrcode.addData(content),this.qrcode.make()}QRCode.prototype.svg=function(opt){void 0===opt&&(opt={container:"svg"});for(var options=this.options,modules=this.qrcode.modules,EOL="\r\n",width=options.width,height=options.height,length=modules.length,xsize=width/(length+2*options.padding),ysize=height/(length+2*options.padding),rect='<rect x="0" y="0" width="'+width+'" height="'+height+'" style="fill:'+options.background+';shape-rendering:crispEdges;"/>'+EOL,y=0;y<length;y++)for(var x=0;x<length;x++){if(modules[x][y])rect+='<rect x="'+(x*xsize+options.padding*xsize).toString()+'" y="'+(y*ysize+options.padding*ysize).toString()+'" width="'+xsize+'" height="'+ysize+'" style="fill:'+options.color+';shape-rendering:crispEdges;"/>'+EOL}var svg="";switch(opt.container){case"svg":svg+='<?xml version="1.0" standalone="yes"?>\r\n<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="'+width+'" height="'+height+'">'+EOL,svg+=rect,svg+="</svg>";break;case"g":svg+='<g width="'+width+'" height="'+height+'">'+EOL,svg+=rect,svg+="</g>";break;default:svg+=rect}return svg},void 0!==module&&(module.exports=QRCode)}),System.register("src/settings/EditSecondFactorsForm.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","node_modules/systemjs-plugin-babel/babel-helpers/defineProperty.js","mithril","../api/Env","../api/entities/sys/SecondFactor","../api/common/utils/LazyLoaded","../gui/base/icons/Icons","../api/main/Entity","../gui/base/Dialog","../misc/LanguageViewModel","../misc/U2fClient","../api/common/TutanotaConstants","mithril/stream/stream.js","../api/main/LoginController","../api/common/utils/Utils","../gui/base/Icon","../gui/theme","../login/SecondFactorHandler","../api/common/utils/ArrayUtils","../api/main/WorkerClient","qrcode","../api/entities/sys/GroupInfo","../gui/base/ProgressDialog","../native/SystemApp","../misc/ClipboardUtils","../misc/HtmlSanitizer","../gui/base/ButtonN","./RecoverCodeDialog","../gui/base/TableN","../api/common/error/RestError","../gui/base/TextFieldN","../gui/base/DropDownSelectorN","../api/main/EventController"],function(_export,_context){"use strict";var _classCallCheck,_createClass,_defineProperty,m,assertMainOrNode,isApp,isTutanotaDomain,createSecondFactor,SecondFactorTypeRef,Icons,erase,load,loadAll,setup,Dialog,DialogType,lang,U2fClient,SecondFactorType,stream,logins,neverNull,Icon,progressIcon,theme,appIdToLoginDomain,contains,worker,QRCode,GroupInfoTypeRef,showProgressDialog,openLinkNative,copyToClipboard,htmlSanitizer,ButtonN,ButtonType,RecoverCodeDialog,ColumnWidth,TableN,NotFoundError,TextFieldN,DropDownSelectorN,isUpdateForTypeRef,_SecondFactorTypeToNa,VerificationStatus,SecondFactorTypeToNameTextId,EditSecondFactorsForm;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersDefinePropertyJs){_defineProperty=_node_modulesSystemjsPluginBabelBabelHelpersDefinePropertyJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isApp=_apiEnv.isApp,isTutanotaDomain=_apiEnv.isTutanotaDomain},function(_apiEntitiesSysSecondFactor){createSecondFactor=_apiEntitiesSysSecondFactor.createSecondFactor,SecondFactorTypeRef=_apiEntitiesSysSecondFactor.SecondFactorTypeRef},function(_apiCommonUtilsLazyLoaded){_apiCommonUtilsLazyLoaded.LazyLoaded},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiMainEntity){erase=_apiMainEntity.erase,load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,setup=_apiMainEntity.setup},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_miscU2fClient){U2fClient=_miscU2fClient.U2fClient},function(_apiCommonTutanotaConstants){SecondFactorType=_apiCommonTutanotaConstants.SecondFactorType},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon,progressIcon=_guiBaseIcon.progressIcon},function(_guiTheme){theme=_guiTheme.theme},function(_loginSecondFactorHandler){appIdToLoginDomain=_loginSecondFactorHandler.appIdToLoginDomain},function(_apiCommonUtilsArrayUtils){contains=_apiCommonUtilsArrayUtils.contains},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_qrcode){QRCode=_qrcode.default},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_nativeSystemApp){openLinkNative=_nativeSystemApp.openLinkNative},function(_miscClipboardUtils){copyToClipboard=_miscClipboardUtils.copyToClipboard},function(_miscHtmlSanitizer){htmlSanitizer=_miscHtmlSanitizer.htmlSanitizer},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_RecoverCodeDialog){RecoverCodeDialog=_RecoverCodeDialog},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth,TableN=_guiBaseTableN.TableN},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef}],execute:function(){assertMainOrNode(),VerificationStatus={Initial:"Initial",Progress:"Progress",Failed:"Failed",Success:"Success"},_defineProperty(_SecondFactorTypeToNa={},SecondFactorType.totp,"totpAuthenticator_label"),_defineProperty(_SecondFactorTypeToNa,SecondFactorType.u2f,"u2fSecurityKey_label"),SecondFactorTypeToNameTextId=_SecondFactorTypeToNa,_export("EditSecondFactorsForm",EditSecondFactorsForm=function(){function EditSecondFactorsForm(user){_classCallCheck(this,EditSecondFactorsForm),this._2FALineAttrs=stream([]),this._2FALineAttrs.map(m.redraw),this._user=user,this._updateSecondFactors()}return _createClass(EditSecondFactorsForm,[{key:"view",value:function(){var _this=this,lnk=lang.getInfoLink("2FA_link"),secondFactorTableAttrs={columnHeading:["name_label","type_label"],columnWidths:[ColumnWidth.Largest,ColumnWidth.Largest],lines:this._2FALineAttrs(),showActionButtonColumn:!0,addButtonAttrs:{label:"addSecondFactor_action",click:function(){return _this._showAddSecondFactorDialog()},icon:function(){return Icons.Add}}};return[m(".h4.mt-l",lang.get("secondFactorAuthentication_label")),m(TableN,secondFactorTableAttrs),m("span.small",lang.get("moreInfo_msg")+" "),m("span.small.text-break",[m("a[href="+lnk+"][target=_blank]",lnk)])]}},{key:"_updateSecondFactors",value:function(){var _this2=this;this._user.getAsync().then(function(user){return loadAll(SecondFactorTypeRef,neverNull(user.auth).secondFactors)}).then(function(factors){var differentDomainAppIds=factors.reduce(function(result,f){return f.type===SecondFactorType.u2f&&!contains(result,neverNull(f.u2f).appId)&&result.push(neverNull(f.u2f).appId),result},[]);_this2._2FALineAttrs(factors.map(function(f){var removeButtonAttrs={label:"remove_action",click:function(){return Dialog.confirm("confirmDeleteSecondFactor_msg").then(function(res){return res?showProgressDialog("pleaseWait_msg",erase(f)):Promise.resolve()}).catch(NotFoundError,function(e){return console.log("could not delete second factor (already deleted)",e)})},icon:function(){return Icons.Cancel}},domainInfo=f.type===SecondFactorType.u2f&&differentDomainAppIds.length>1?(f.name.length>0?" - ":"")+appIdToLoginDomain(neverNull(f.u2f).appId):"";return{cells:[f.name+domainInfo,lang.get(SecondFactorTypeToNameTextId[f.type])],actionButtonAttrs:logins.getUserController().isGlobalOrLocalAdmin()?removeButtonAttrs:null}}))})}},{key:"_getOtpAuthUrl",value:function(secret){return this._user.getAsync().then(function(user){return load(GroupInfoTypeRef,user.userGroup.groupInfo)}).then(function(userGroupInfo){var issuer=isTutanotaDomain()?"Tutanota":location.hostname;return"otpauth://totp/"+encodeURI(issuer+":"+neverNull(userGroupInfo.mailAddress))+"?secret="+secret.replace(/ /g,"")+"&issuer="+issuer+"&algorithm=SHA1&digits=6&period=30"})}},{key:"_showAddSecondFactorDialog",value:function(){var _this3=this,u2f=new U2fClient,totpPromise=worker.generateTotpSecret(),u2fSupportPromise=u2f.isSupported(),userPromise=this._user.getAsync();showProgressDialog("pleaseWait_msg",Promise.all([totpPromise,u2fSupportPromise,userPromise])).spread(function(totpKeys,u2fSupport,user){console.log("u2fSupport",u2fSupport);var nameValue=stream(""),selectedType=stream(SecondFactorType.totp),totpCode=stream(""),typeDropdownAttrs={label:"type_label",selectedValue:selectedType,items:Object.keys(SecondFactorTypeToNameTextId).filter(function(k){return k!==SecondFactorType.u2f||u2fSupport}).sort(function(a,b){return Number(b)-Number(a)}).map(function(key){return{name:lang.get(SecondFactorTypeToNameTextId[key]),value:key}}),dropdownWidth:300},nameFieldAttrs={label:"name_label",helpLabel:function(){return lang.get("secondFactorNameInfo_msg")},value:nameValue},u2fRegistrationData=stream(null),totpSecretFieldAttrs={label:"totpSecret_label",helpLabel:function(){return lang.get(isApp()?"totpTransferSecretApp_msg":"totpTransferSecret_msg")},value:stream(totpKeys.readableKey),injectionsRight:function(){return m(ButtonN,copyButtonAttrs)},disabled:!0},copyButtonAttrs={label:"copy_action",click:function(){return copyToClipboard(totpKeys.readableKey)},icon:function(){return Icons.Copy}},totpQRCodeSvg=void 0,authUrl=void 0;_this3._getOtpAuthUrl(totpKeys.readableKey).then(function(optAuthUrl){if(!isApp()){var qrcodeGenerator=new QRCode({height:150,width:150,content:optAuthUrl});totpQRCodeSvg=htmlSanitizer.sanitize(qrcodeGenerator.svg(),!1).text}authUrl=optAuthUrl});var totpCodeAttrs={label:"totpCode_label",value:totpCode},openTOTPAppAttrs={label:"addOpenOTPApp_action",click:function(){openLinkNative(authUrl).then(function(successful){successful||Dialog.error("noAppAvailable_msg")})},type:ButtonType.Login},verificationStatus=stream();selectedType.map(function(type){verificationStatus(type===SecondFactorType.u2f?VerificationStatus.Initial:VerificationStatus.Progress)}),verificationStatus.map(function(){return m.redraw()}),totpCode.map(function(v){var cleanedValue=v.replace(/ /g,"");if(6===cleanedValue.length){var time=Math.floor((new Date).getTime()/1e3/30),expectedCode=Number(cleanedValue);return worker.generateTotpCode(time,totpKeys.key).then(function(number){return number===expectedCode?VerificationStatus.Success:worker.generateTotpCode(time-1,totpKeys.key).then(function(number){return number===expectedCode?VerificationStatus.Success:worker.generateTotpCode(time+1,totpKeys.key).then(function(number){return number===expectedCode?VerificationStatus.Success:VerificationStatus.Failed})})}).then(verificationStatus)}return verificationStatus(VerificationStatus.Progress)});var dialog=Dialog.showActionDialog({title:lang.get("add_action"),allowOkWithReturn:!0,child:{view:function(){return[m(DropDownSelectorN,typeDropdownAttrs),m(TextFieldN,nameFieldAttrs),selectedType()===SecondFactorType.totp?m(".mb",[m(TextFieldN,totpSecretFieldAttrs),isApp()?m(".pt",m(ButtonN,openTOTPAppAttrs)):m(".flex-center",m.trust(totpQRCodeSvg)),m(TextFieldN,totpCodeAttrs)]):null,selectedType()===SecondFactorType.u2f&&verificationStatus()!==VerificationStatus.Progress?null:m("p.flex.items-center",[m(".mr-s",function(){switch(verificationStatus()){case VerificationStatus.Progress:return progressIcon();case VerificationStatus.Success:return m(Icon,{icon:Icons.Checkmark,large:!0,style:{fill:theme.content_accent}});case VerificationStatus.Failed:return m(Icon,{icon:Icons.Cancel,large:!0,style:{fill:theme.content_accent}});default:return null}}()),m("",selectedType()===SecondFactorType.u2f?verificationStatus()===VerificationStatus.Success?lang.get("registeredU2fDevice_msg"):lang.get("registerU2fDevice_msg"):verificationStatus()===VerificationStatus.Success?lang.get("totpCodeConfirmed_msg"):verificationStatus()===VerificationStatus.Failed?lang.get("totpCodeWrong_msg"):lang.get("totpCodeEnter_msg"))])]}},okAction:function(){var p=void 0;if(selectedType()===SecondFactorType.u2f){if(verificationStatus()===VerificationStatus.Progress)return;verificationStatus(VerificationStatus.Progress),p=u2f.register().then(function(result){u2fRegistrationData(result),verificationStatus(VerificationStatus.Success)}).catch(function(){u2fRegistrationData(null),verificationStatus(VerificationStatus.Failed)})}else p=Promise.resolve();return p.then(function(){var sf=createSecondFactor();if(sf._ownerGroup=user._ownerGroup,sf.name=nameValue(),sf.type=selectedType(),sf.type===SecondFactorType.u2f){if(verificationStatus()!==VerificationStatus.Success)return void Dialog.error("unrecognizedU2fDevice_msg");sf.u2f=u2fRegistrationData()}else if(sf.type===SecondFactorType.totp){if(verificationStatus()!==VerificationStatus.Success)return void Dialog.error("totpCodeEnter_msg");sf.otpSecret=totpKeys.key}showProgressDialog("pleaseWait_msg",setup(neverNull(user.auth).secondFactors,sf)).then(function(){return dialog.close()}).then(function(){return _this3._showRecoveryInfoDialog(user)})})},allowCancel:!0,okActionTextId:"save_action"})})}},{key:"entityEventReceived",value:function(update){isUpdateForTypeRef(SecondFactorTypeRef,update)&&this._updateSecondFactors()}},{key:"_showRecoveryInfoDialog",value:function(user){var isRecoverCodeAvailable=user.auth&&null!=user.auth.recoverCode;Dialog.showActionDialog({title:lang.get("recoveryCode_label"),type:DialogType.EditMedium,child:function(){return m(".pt",lang.get("recoveryCode_msg"))},allowOkWithReturn:!0,okAction:function(dialog){dialog.close(),RecoverCodeDialog.showRecoverCodeDialogAfterPasswordVerification(isRecoverCodeAvailable?"get":"create",!1)},okActionTextId:isRecoverCodeAvailable?"show_action":"setUp_action"})}}]),EditSecondFactorsForm}()),_export("EditSecondFactorsForm",EditSecondFactorsForm)}}}),System.register("src/settings/ImportUsersViewer.js",["mithril","../gui/base/Dialog","../misc/LanguageViewModel","../misc/FormatValidator","../api/main/WorkerClient","../gui/base/ProgressDialog","../api/common/TutanotaConstants","./UserViewer","../api/common/utils/ArrayUtils","../subscription/BuyDialog"],function(_export,_context){"use strict";var m,Dialog,lang,isMailAddress,worker,showWorkerProgressDialog,BookingItemFeatureType,CSV_USER_FORMAT,contains,showBuyDialog,delayTime;return _export("checkAndImportUserData",function(userDetailsInputCsv,availableDomains){var userDetailsArray,nbrOfCreatedUsers,notAvailableUsers,userData=function(csvString){var lines=csvString.replace("\r","").split("\n").filter(function(l){return""!==l.trim()}),error=!1,userData=lines.map(function(a){var parts=a.trim().split(";");return 3!==parts.length?(error=!0,null):{username:parts[0],mailAddress:parts[1],password:parts[2]}});return error?null:userData}(userDetailsInputCsv);if(userData){var errorMessage=function(userData,availableDomains){if(0===userData.length)return lang.get("noInputWasMade_msg");var errorMessageArray=[],errorMessage=null;return userData.find(function(u,index){var mailAddress=u.mailAddress,domain=u.mailAddress.split("@")[1].toLowerCase().trim();if(isMailAddress(u.mailAddress,!0)||errorMessageArray.push("mailAddressInvalid_msg"),contains(availableDomains,domain)||errorMessageArray.push("customDomainErrorDomainNotAvailable_msg"),""===u.password.trim()&&errorMessageArray.push("enterMissingPassword_msg"),userData.find(function(otherUser){return otherUser.mailAddress===mailAddress&&otherUser!==u})&&errorMessageArray.push("duplicatedMailAddressInUserList_msg"),errorMessageArray.length>0)return errorMessage=errorMessageArray.map(function(e){return lang.get(e)}).join("\n")+"\n"+lang.get("errorAtLine_msg",{"{index}":index+1,"{error}":'"'+(u.username||"")+";"+(u.mailAddress||"")+";"+(u.password||"")+'"'}),!0}),errorMessage}(userData,availableDomains);return errorMessage?(Dialog.error(function(){return errorMessage}),!1):(userData.length>0&&(userDetailsArray=userData,nbrOfCreatedUsers=0,notAvailableUsers=[],showBuyDialog(BookingItemFeatureType.Users,userDetailsArray.length,0,!1).then(function(accepted){if(accepted)return showWorkerProgressDialog(function(){return lang.get("createActionStatus_msg",{"{index}":nbrOfCreatedUsers,"{count}":userDetailsArray.length})},Promise.each(userDetailsArray,function(user,index){return function(user,index,overallNumberOfUsers){var cleanMailAddress=user.mailAddress.trim().toLowerCase();return worker.isMailAddressAvailable(cleanMailAddress).then(function(available){return available?worker.createUser(user.username?user.username:"",cleanMailAddress,user.password,index,overallNumberOfUsers).then(function(){return Promise.delay(delayTime).return(!0)}):Promise.delay(delayTime).return(!1)})}(user,index,userDetailsArray.length).then(function(created){created?(nbrOfCreatedUsers++,m.redraw()):notAvailableUsers.push(user)})})).then(function(){var p=Promise.resolve();notAvailableUsers.length>0&&(p=Dialog.error(function(){return lang.get("addressesAlreadyInUse_msg")+" "+notAvailableUsers.map(function(u){return u.mailAddress}).join(", ")})),p.then(function(){Dialog.error(function(){return lang.get("createdUsersCount_msg",{"{1}":nbrOfCreatedUsers})})})})})),!0)}return Dialog.error(function(){return lang.get("wrongUserCsvFormat_msg",{"{format}":CSV_USER_FORMAT})}),!1}),{setters:[function(_mithril){m=_mithril.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_miscFormatValidator){isMailAddress=_miscFormatValidator.isMailAddress},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseProgressDialog){showWorkerProgressDialog=_guiBaseProgressDialog.showWorkerProgressDialog},function(_apiCommonTutanotaConstants){BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType},function(_UserViewer){CSV_USER_FORMAT=_UserViewer.CSV_USER_FORMAT},function(_apiCommonUtilsArrayUtils){contains=_apiCommonUtilsArrayUtils.contains},function(_subscriptionBuyDialog){showBuyDialog=_subscriptionBuyDialog.show}],execute:function(){delayTime=900}}}),System.register("src/settings/EditAliasesFormN.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../gui/base/Dialog","../gui/base/TableN","../misc/LanguageViewModel","../api/common/RecipientInfo","../api/common/error/RestError","../api/main/WorkerClient","../api/common/utils/Utils","./SelectMailAddressForm","../misc/ErrorHandlerImpl","../api/main/LoginController","../gui/base/icons/Icons","../gui/base/ProgressDialog","./AddUserDialog","../gui/base/ButtonN","mithril/stream/stream.js","../gui/base/ExpanderN","../gui/base/DropdownN","../api/common/TutanotaConstants"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,Dialog,ColumnWidth,TableN,lang,isTutanotaMailAddress,InvalidDataError,LimitReachedError,worker,noOp,SelectMailAddressForm,showNotAvailableForFreeDialog,logins,Icons,showProgressDialog,getAvailableDomains,ButtonType,stream,ExpanderButtonN,ExpanderPanelN,attachDropdown,TUTANOTA_MAIL_ADDRESS_DOMAINS,_EditAliasesForm,EditAliasesFormN;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth,TableN=_guiBaseTableN.TableN},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonRecipientInfo){isTutanotaMailAddress=_apiCommonRecipientInfo.isTutanotaMailAddress},function(_apiCommonErrorRestError){InvalidDataError=_apiCommonErrorRestError.InvalidDataError,LimitReachedError=_apiCommonErrorRestError.LimitReachedError},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonUtilsUtils){noOp=_apiCommonUtilsUtils.noOp},function(_SelectMailAddressForm){SelectMailAddressForm=_SelectMailAddressForm.SelectMailAddressForm},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_AddUserDialog){getAvailableDomains=_AddUserDialog.getAvailableDomains},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseExpanderN){ExpanderButtonN=_guiBaseExpanderN.ExpanderButtonN,ExpanderPanelN=_guiBaseExpanderN.ExpanderPanelN},function(_guiBaseDropdownN){attachDropdown=_guiBaseDropdownN.attachDropdown},function(_apiCommonTutanotaConstants){TUTANOTA_MAIL_ADDRESS_DOMAINS=_apiCommonTutanotaConstants.TUTANOTA_MAIL_ADDRESS_DOMAINS}],execute:function(){assertMainOrNode(),_EditAliasesForm=function(){function _EditAliasesForm(){_classCallCheck(this,_EditAliasesForm),this._nbrOfAliasesToCreate=0,this._nbrOfAliasesToEnable=0,this._expanded=stream(!1)}return _createClass(_EditAliasesForm,[{key:"oninit",value:function(){this._getNbrOfAliases()}},{key:"view",value:function(vnode){var _this=this,a=vnode.attrs,addAliasButtonAttrs={label:"addEmailAlias_label",click:function(){return _this._showAddAliasDialog(a.userGroupInfo)},icon:function(){return Icons.Add}},aliasesTableAttrs={columnHeading:["emailAlias_label","state_label"],columnWidths:[ColumnWidth.Largest,ColumnWidth.Small],showActionButtonColumn:!0,addButtonAttrs:addAliasButtonAttrs,lines:this._getAliasLineAttrs(a.userGroupInfo)};return[m(".flex-space-between.items-center.mt-l.mb-s",[m(".h4",lang.get("mailAddressAliases_label")),m(ExpanderButtonN,{label:"showEmailAliases_action",expanded:this._expanded})]),m(ExpanderPanelN,{expanded:this._expanded},m(TableN,aliasesTableAttrs)),m(".small",0===this._nbrOfAliasesToCreate?lang.get("adminMaxNbrOfAliasesReached_msg"):lang.get("mailAddressAliasesMaxNbr_label",{"{1}":this._nbrOfAliasesToCreate}))]}},{key:"_getAliasLineAttrs",value:function(groupInfo){var _this2=this;return groupInfo.mailAddressAliases.sort(function(a,b){return a.mailAddress>b.mailAddress?1:-1}).map(function(alias){var actionButtonAttrs=attachDropdown({label:"edit_action",icon:function(){return Icons.Edit},click:noOp},function(){return[{label:"activate_action",click:function(){alias.enabled||_this2._switchStatus(alias,groupInfo)},type:ButtonType.Dropdown,isSelected:function(){return alias.enabled}},{label:isTutanotaMailAddress(alias.mailAddress)?"deactivate_action":"delete_action",click:function(){alias.enabled&&_this2._switchStatus(alias,groupInfo)},type:ButtonType.Dropdown,isSelected:function(){return!alias.enabled}}]},function(){return!0},250);return{cells:[alias.mailAddress,alias.enabled?lang.get("activated_label"):lang.get("deactivated_label")],actionButtonAttrs:actionButtonAttrs}})}},{key:"_showAddAliasDialog",value:function(groupInfo){var _this3=this;0===this._nbrOfAliasesToEnable?logins.getUserController().isFreeAccount()?showNotAvailableForFreeDialog(!0):Dialog.confirm(function(){return lang.get("adminMaxNbrOfAliasesReached_msg")+" "+lang.get("orderAliasesConfirm_msg")}).then(function(confirmed){}):getAvailableDomains().then(function(domains){var form=new SelectMailAddressForm(domains);Dialog.showActionDialog({title:lang.get("addEmailAlias_label"),child:{view:function(){return[m(form),m(ExpanderPanelN,{expanded:form.domain.map(function(d){return TUTANOTA_MAIL_ADDRESS_DOMAINS.includes(d)})},m(".pt-m",lang.get("permanentAliasWarning_msg")))]}},validator:function(){return form.getErrorMessageId()},allowOkWithReturn:!0,okAction:function(dialog){var alias=form.cleanMailAddress();showProgressDialog("pleaseWait_msg",worker.addMailAlias(groupInfo.group,alias)).catch(InvalidDataError,function(){return Dialog.error("mailAddressNA_msg")}).catch(LimitReachedError,function(){return Dialog.error("adminMaxNbrOfAliasesReached_msg")}).finally(function(){return _this3._getNbrOfAliases()}),dialog.close()}})})}},{key:"_getNbrOfAliases",value:function(){var _this4=this;worker.getAliasCounters().then(function(mailAddressAliasServiceReturn){var newNbr=Math.max(0,Number(mailAddressAliasServiceReturn.totalAliases)-Number(mailAddressAliasServiceReturn.usedAliases)),newNbrToEnable=Math.max(0,Number(mailAddressAliasServiceReturn.totalAliases)-Number(mailAddressAliasServiceReturn.enabledAliases));_this4._nbrOfAliasesToCreate===newNbr&&_this4._nbrOfAliasesToEnable===newNbrToEnable||(_this4._nbrOfAliasesToCreate=newNbr,_this4._nbrOfAliasesToEnable=newNbrToEnable,m.redraw())})}},{key:"_switchStatus",value:function(alias,groupInfo){var _this5=this,restore=!alias.enabled,promise=Promise.resolve(!0);if(!restore){var message=isTutanotaMailAddress(alias.mailAddress)?"deactivateAlias_msg":"deleteAlias_msg";promise=Dialog.confirm(function(){return lang.get(message,{"{1}":alias.mailAddress})})}promise.then(function(confirmed){if(confirmed){var p=worker.setMailAliasStatus(groupInfo.group,alias.mailAddress,restore).catch(LimitReachedError,function(e){Dialog.error("adminMaxNbrOfAliasesReached_msg")}).finally(function(){return _this5._getNbrOfAliases()});showProgressDialog("pleaseWait_msg",p)}})}}]),_EditAliasesForm}(),_export("EditAliasesFormN",EditAliasesFormN=_EditAliasesForm),_export("EditAliasesFormN",EditAliasesFormN)}}}),System.register("src/settings/UserViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../gui/base/TextField","../gui/base/Button","../gui/base/Dialog","../api/main/Entity","../misc/Formatter","../misc/LanguageViewModel","./PasswordForm","../api/common/EntityFunctions","../api/main/WorkerClient","../gui/base/DropDownSelector","../api/entities/sys/User","../api/common/utils/Utils","../api/entities/sys/Group","../api/common/TutanotaConstants","../api/entities/sys/GroupInfo","../api/common/utils/LazyLoaded","../api/common/error/RestError","../subscription/BuyDialog","../api/main/LoginController","../api/entities/tutanota/MailboxServerProperties","../api/entities/tutanota/MailboxGroupRoot","../gui/base/Table","../gui/base/TableN","../gui/base/TableLine","./GroupViewer","../api/entities/sys/Customer","../gui/base/icons/Icons","./EditSecondFactorsForm","../api/entities/tutanota/ContactForm","../api/common/utils/ArrayUtils","../api/entities/tutanota/CustomerContactFormGroupRoot","../gui/base/ProgressDialog","mithril/stream/stream.js","../api/main/EventController","../misc/ErrorHandlerImpl","../gui/base/HtmlEditor","./ContactFormListView","./ImportUsersViewer","./EditAliasesFormN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,TextField,Button,Dialog,load,loadAll,loadMultiple,loadRange,update,formatDateWithMonth,formatStorageSize,lang,PasswordForm,CUSTOM_MIN_ID,isSameId,worker,DropDownSelector,UserTypeRef,compareGroupInfos,getGroupInfoDisplayName,neverNull,GroupTypeRef,BookingItemFeatureType,GroupType,OperationType,GroupInfoTypeRef,LazyLoaded,BadRequestError,NotAuthorizedError,PreconditionFailedError,BuyDialog,logins,MailboxServerPropertiesTypeRef,MailboxGroupRootTypeRef,Table,ColumnWidth,TableLine,getGroupTypeName,CustomerTypeRef,Icons,EditSecondFactorsForm,ContactFormTypeRef,remove,CustomerContactFormGroupRootTypeRef,showProgressDialog,stream,isUpdateForTypeRef,showNotAvailableForFreeDialog,Editor,Mode,filterContactFormsForLocalAdmin,checkAndImportUserData,EditAliasesFormN,CSV_USER_FORMAT,UserViewer;return _export("showUserImportDialog",function(customDomains){var editor=new Editor("enterAsCSV_msg").showBorders().setMode(Mode.HTML).setValue(CSV_USER_FORMAT).setMinHeight(200),form={view:function(){return[m(editor)]}};Dialog.showActionDialog({title:lang.get("importUsers_action"),child:form,okAction:function(csvDialog){logins.getUserController().isFreeAccount()?showNotAvailableForFreeDialog(!1):checkAndImportUserData(editor.getValue(),customDomains)&&csvDialog.close()}})}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,loadMultiple=_apiMainEntity.loadMultiple,loadRange=_apiMainEntity.loadRange,update=_apiMainEntity.update},function(_miscFormatter){formatDateWithMonth=_miscFormatter.formatDateWithMonth,formatStorageSize=_miscFormatter.formatStorageSize},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_PasswordForm){PasswordForm=_PasswordForm.PasswordForm},function(_apiCommonEntityFunctions){CUSTOM_MIN_ID=_apiCommonEntityFunctions.CUSTOM_MIN_ID,isSameId=_apiCommonEntityFunctions.isSameId},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_apiEntitiesSysUser){UserTypeRef=_apiEntitiesSysUser.UserTypeRef},function(_apiCommonUtilsUtils){compareGroupInfos=_apiCommonUtilsUtils.compareGroupInfos,getGroupInfoDisplayName=_apiCommonUtilsUtils.getGroupInfoDisplayName,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEntitiesSysGroup){GroupTypeRef=_apiEntitiesSysGroup.GroupTypeRef},function(_apiCommonTutanotaConstants){BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,GroupType=_apiCommonTutanotaConstants.GroupType,OperationType=_apiCommonTutanotaConstants.OperationType},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_apiCommonErrorRestError){BadRequestError=_apiCommonErrorRestError.BadRequestError,NotAuthorizedError=_apiCommonErrorRestError.NotAuthorizedError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_subscriptionBuyDialog){BuyDialog=_subscriptionBuyDialog},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiEntitiesTutanotaMailboxServerProperties){MailboxServerPropertiesTypeRef=_apiEntitiesTutanotaMailboxServerProperties.MailboxServerPropertiesTypeRef},function(_apiEntitiesTutanotaMailboxGroupRoot){MailboxGroupRootTypeRef=_apiEntitiesTutanotaMailboxGroupRoot.MailboxGroupRootTypeRef},function(_guiBaseTable){Table=_guiBaseTable.Table},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth},function(_guiBaseTableLine){TableLine=_guiBaseTableLine.default},function(_GroupViewer){getGroupTypeName=_GroupViewer.getGroupTypeName},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_EditSecondFactorsForm){EditSecondFactorsForm=_EditSecondFactorsForm.EditSecondFactorsForm},function(_apiEntitiesTutanotaContactForm){ContactFormTypeRef=_apiEntitiesTutanotaContactForm.ContactFormTypeRef},function(_apiCommonUtilsArrayUtils){remove=_apiCommonUtilsArrayUtils.remove},function(_apiEntitiesTutanotaCustomerContactFormGroupRoot){CustomerContactFormGroupRootTypeRef=_apiEntitiesTutanotaCustomerContactFormGroupRoot.CustomerContactFormGroupRootTypeRef},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog},function(_guiBaseHtmlEditor){Editor=_guiBaseHtmlEditor.HtmlEditor,Mode=_guiBaseHtmlEditor.Mode},function(_ContactFormListView){filterContactFormsForLocalAdmin=_ContactFormListView.filterContactFormsForLocalAdmin},function(_ImportUsersViewer){checkAndImportUserData=_ImportUsersViewer.checkAndImportUserData},function(_EditAliasesFormN){EditAliasesFormN=_EditAliasesFormN.EditAliasesFormN}],execute:function(){assertMainOrNode(),_export("CSV_USER_FORMAT",CSV_USER_FORMAT="username;user@domain.com;password"),_export("CSV_USER_FORMAT",CSV_USER_FORMAT),_export("UserViewer",UserViewer=function(){function UserViewer(userGroupInfo,isAdmin){var _this=this;_classCallCheck(this,UserViewer),this.userGroupInfo=userGroupInfo,this._user=new LazyLoaded(function(){return load(GroupTypeRef,_this.userGroupInfo.group).then(function(userGroup){return load(UserTypeRef,neverNull(userGroup.user))})}),this._customer=new LazyLoaded(function(){return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer))}),this._teamGroupInfos=new LazyLoaded(function(){return _this._customer.getAsync().then(function(customer){return loadAll(GroupInfoTypeRef,customer.teamGroups)})}),this._senderName=new TextField("mailName_label").setValue(this.userGroupInfo.name).setDisabled();var editSenderNameButton=new Button("edit_action",function(){Dialog.showTextInputDialog("edit_action","mailName_label",null,_this._senderName.value()).then(function(newName){_this.userGroupInfo.name=newName,update(_this.userGroupInfo)})},function(){return Icons.Edit});this._senderName._injectionsRight=function(){return[m(editSenderNameButton)]};var mailAddress=new TextField("mailAddress_label").setValue(this.userGroupInfo.mailAddress).setDisabled(),created=new TextField("created_label").setValue(formatDateWithMonth(this.userGroupInfo.created)).setDisabled();this._usedStorage=new TextField("storageCapacityUsed_label").setValue(lang.get("loading_msg")).setDisabled(),this._admin=new DropDownSelector("globalAdmin_label",null,[{name:lang.get("no_label"),value:!1},{name:lang.get("yes_label"),value:!0}],stream(isAdmin)).setSelectionChangedHandler(function(makeAdmin){_this.userGroupInfo.deleted?Dialog.error("userAccountDeactivated_msg"):_this._isItMe()?Dialog.error("removeOwnAdminFlagInfo_msg"):null!=_this.userGroupInfo.localAdmin?Dialog.error("assignAdminRightsToLocallyAdministratedUserError_msg"):showProgressDialog("pleaseWait_msg",_this._user.getAsync().then(function(user){return worker.changeAdminFlag(user,makeAdmin)}))}),this._deactivated=new DropDownSelector("state_label",null,[{name:lang.get("activated_label"),value:!1},{name:lang.get("deactivated_label"),value:!0}],stream(null!=this.userGroupInfo.deleted)).setSelectionChangedHandler(function(deactivate){_this._admin.selectedValue()?Dialog.error("deactivateOwnAccountInfo_msg"):_this._deleteUser(!deactivate)});var password=new TextField("password_label").setValue("***").setDisabled(),changePasswordButton=new Button("changePassword_label",function(){return _this._changePassword()},function(){return Icons.Edit});password._injectionsRight=function(){return[m(changePasswordButton)]},this._secondFactorsForm=new EditSecondFactorsForm(this._user),this._teamGroupInfos.getAsync().then(function(availableTeamGroupInfos){if(availableTeamGroupInfos.length>0){var addGroupButton=new Button("addGroup_label",function(){return _this._showAddUserToGroupDialog()},function(){return Icons.Add});_this._groupsTable=new Table(["name_label","groupType_label"],[ColumnWidth.Largest,ColumnWidth.Small],!0,addGroupButton),_this._updateGroups();var adminGroupIdToName=[{name:lang.get("globalAdmin_label"),value:null}].concat(availableTeamGroupInfos.filter(function(gi){return gi.groupType===GroupType.LocalAdmin}).map(function(gi){return{name:getGroupInfoDisplayName(gi),value:gi.group}}));_this._administratedBy=new DropDownSelector("administratedBy_label",null,adminGroupIdToName,stream(_this.userGroupInfo.localAdmin)).setSelectionChangedHandler(function(localAdminId){return _this._user.getAsync().then(function(user){_this.userGroupInfo.deleted?Dialog.error("userAccountDeactivated_msg"):_this._isItMe()?Dialog.error("updateOwnAdminship_msg"):_this._isAdmin(user)?Dialog.error("updateAdminshipGlobalAdmin_msg"):showProgressDialog("pleaseWait_msg",Promise.resolve().then(function(){var newAdminGroupId=localAdminId||neverNull(logins.getUserController().user.memberships.find(function(gm){return gm.groupType===GroupType.Admin})).group;return worker.updateAdminship(_this.userGroupInfo.group,newAdminGroupId)}))})})}}),this._customer.getAsync().then(function(customer){return load(CustomerContactFormGroupRootTypeRef,customer.customerGroup).then(function(contactFormGroupRoot){loadRange(ContactFormTypeRef,contactFormGroupRoot.contactForms,CUSTOM_MIN_ID,1,!1).then(function(cf){if(cf.length>0){var contactFormsAddButton=new Button("addResponsiblePerson_label",function(){return _this._showAddUserToContactFormDialog()},function(){return Icons.Add});_this._contactFormsTable=new Table(["contactForms_label"],[ColumnWidth.Largest,ColumnWidth.Small],!0,contactFormsAddButton),_this._updateContactForms()}})})}),this.view=function(){var whitelistProtestciton=_this._whitelistProtection;return[m("#user-viewer.fill-absolute.scroll.plr-l.pb-floating",[m(".h4.mt-l",lang.get("userSettings_label")),m("",[m(mailAddress),m(created),m(_this._usedStorage)]),m("",[m(_this._senderName),m(password),logins.getUserController().isGlobalAdmin()?[m(_this._admin),_this._administratedBy?m(_this._administratedBy):null]:null,m(_this._deactivated)]),logins.getUserController().isPremiumAccount()||logins.getUserController().isFreeAccount()?m(_this._secondFactorsForm):null,_this._groupsTable?m(".h4.mt-l.mb-s",lang.get("groups_label")):null,_this._groupsTable?m(_this._groupsTable):null,_this._contactFormsTable?m(".h4.mt-l.mb-s",lang.get("contactForms_label")):null,_this._contactFormsTable?m(_this._contactFormsTable):null,m(EditAliasesFormN,{userGroupInfo:_this.userGroupInfo}),logins.getUserController().isPremiumAccount()&&whitelistProtestciton?[m(".h4.mt-l",lang.get("mailSettings_label")),m(whitelistProtestciton)]:null])]},this._createOrUpdateWhitelistProtectionField(),this._updateUsedStorageAndAdminFlag()}return _createClass(UserViewer,[{key:"_createOrUpdateWhitelistProtectionField",value:function(){}},{key:"_isItMe",value:function(){return isSameId(logins.getUserController().userGroupInfo._id,this.userGroupInfo._id)}},{key:"_changePassword",value:function(){this._isItMe()?PasswordForm.showChangeOwnPasswordDialog():this._admin.selectedValue()?Dialog.error("changeAdminPassword_msg"):this._user.getAsync().then(function(user){PasswordForm.showChangeUserPasswordAsAdminDialog(user)})}},{key:"_updateGroups",value:function(){var _this2=this;this._groupsTable&&this._user.getAsync().then(function(user){_this2._customer.getAsync().then(function(customer){Promise.map(_this2._getTeamMemberships(user,customer),function(m){return load(GroupInfoTypeRef,m.groupInfo).then(function(groupInfo){var removeButton;return removeButton=new Button("remove_action",function(){showProgressDialog("pleaseWait_msg",worker.removeUserFromGroup(user._id,groupInfo.group)).catch(NotAuthorizedError,function(e){Dialog.error("removeUserFromGroupNotAdministratedUserError_msg")})},function(){return Icons.Cancel}),new TableLine([getGroupInfoDisplayName(groupInfo),getGroupTypeName(neverNull(m.groupType))],removeButton)})}).then(function(tableLines){_this2._groupsTable&&_this2._groupsTable.updateEntries(tableLines)})})})}},{key:"_updateContactForms",value:function(){var _this3=this;this._contactFormsTable&&this._user.getAsync().then(function(user){var userMailGroupMembership=neverNull(user.memberships.find(function(m){return m.groupType===GroupType.Mail}));return load(MailboxGroupRootTypeRef,userMailGroupMembership.group).then(function(mailboxGroupRoot){return mailboxGroupRoot.participatingContactForms.length>0?loadMultiple(ContactFormTypeRef,mailboxGroupRoot.participatingContactForms[0][0],mailboxGroupRoot.participatingContactForms.map(function(idTuple){return idTuple[1]})):[]}).map(function(cf){var removeButton=new Button("remove_action",function(){var match=cf.participantGroupInfos.find(function(id){return isSameId(id,user.userGroup.groupInfo)});match&&remove(cf.participantGroupInfos,match),showProgressDialog("pleaseWait_msg",update(cf))},function(){return Icons.Cancel});return new TableLine([cf.path],removeButton)}).then(function(tableLines){_this3._contactFormsTable&&_this3._contactFormsTable.updateEntries(tableLines)})})}},{key:"_showAddUserToGroupDialog",value:function(){var _this4=this;this._user.getAsync().then(function(user){if(_this4.userGroupInfo.deleted)Dialog.error("userAccountDeactivated_msg");else{var globalAdmin=logins.isGlobalAdminUserLoggedIn(),localAdminGroupIds=logins.getUserController().getLocalAdminGroupMemberships().map(function(gm){return gm.group}),availableGroupInfos=_this4._teamGroupInfos.getLoaded().filter(function(g){return!(!globalAdmin&&-1===localAdminGroupIds.indexOf(g.localAdmin)&&-1===localAdminGroupIds.indexOf(g.group))&&(!g.deleted&&null==user.memberships.find(function(m){return isSameId(m.groupInfo,g._id)}))});if(availableGroupInfos.length>0){availableGroupInfos.sort(compareGroupInfos);var dropdown=new DropDownSelector("group_label",null,availableGroupInfos.map(function(g){return{name:getGroupInfoDisplayName(g),value:g}}),stream(availableGroupInfos[0]),250);Dialog.showActionDialog({title:lang.get("addUserToGroup_label"),child:{view:function(){return m(dropdown)}},allowOkWithReturn:!0,okAction:function(dialog){showProgressDialog("pleaseWait_msg",worker.addUserToGroup(user,dropdown.selectedValue().group)),dialog.close()}})}}})}},{key:"_showAddUserToContactFormDialog",value:function(){var _this5=this;this._user.getAsync().then(function(user){_this5._customer.getAsync().then(function(customer){return load(CustomerContactFormGroupRootTypeRef,customer.customerGroup).then(function(contactFormGroupRoot){loadAll(ContactFormTypeRef,contactFormGroupRoot.contactForms).then(function(allContactForms){filterContactFormsForLocalAdmin(allContactForms).then(function(contactForms){var dropdown=new DropDownSelector("contactForms_label",null,contactForms.map(function(cf){return{name:cf.path,value:cf}}),stream(contactForms[0]),250);Dialog.showActionDialog({title:lang.get("responsiblePersons_label"),child:{view:function(){return m(dropdown)}},allowOkWithReturn:!0,okAction:function(dialog){var cf=dropdown.selectedValue();cf.participantGroupInfos.indexOf(user.userGroup.groupInfo)&&cf.participantGroupInfos.push(user.userGroup.groupInfo),showProgressDialog("pleaseWait_msg",update(cf)),dialog.close()}})})})})})})}},{key:"_updateUsedStorageAndAdminFlag",value:function(){var _this6=this;this._user.getAsync().then(function(user){var isAdmin=_this6._isAdmin(user);_this6._admin.selectedValue(isAdmin),worker.readUsedUserStorage(user).then(function(usedStorage){_this6._usedStorage.setValue(formatStorageSize(usedStorage)),m.redraw()}).catch(BadRequestError,function(e){})})}},{key:"_getTeamMemberships",value:function(user,customer){return user.memberships.filter(function(m){return m.groupInfo[0]===customer.teamGroups})}},{key:"_isAdmin",value:function(user){return null!=user.memberships.find(function(m){return m.groupType===GroupType.Admin})}},{key:"_deleteUser",value:function(restore){var _this7=this;return showProgressDialog("pleaseWait_msg",BuyDialog.show(BookingItemFeatureType.Users,restore?1:-1,0,restore).then(function(confirmed){if(confirmed)return _this7._user.getAsync().then(function(user){return worker.deleteUser(user,restore)})})).catch(PreconditionFailedError,function(e){restore?Dialog.error("emailAddressInUse_msg"):Dialog.error("stillReferencedFromContactForm_msg")})}},{key:"entityEventsReceived",value:function(updates){var _this8=this,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _update=_step.value,instanceListId=_update.instanceListId,instanceId=_update.instanceId,operation=_update.operation;isUpdateForTypeRef(GroupInfoTypeRef,_update)&&operation===OperationType.UPDATE&&isSameId(this.userGroupInfo._id,[neverNull(instanceListId),instanceId])?load(GroupInfoTypeRef,this.userGroupInfo._id).then(function(updatedUserGroupInfo){_this8.userGroupInfo=updatedUserGroupInfo,_this8._senderName.setValue(updatedUserGroupInfo.name),_this8._deactivated.selectedValue(null!=updatedUserGroupInfo.deleted),_this8._updateUsedStorageAndAdminFlag(),_this8._administratedBy&&_this8._administratedBy.selectedValue(_this8.userGroupInfo.localAdmin),m.redraw()}):isUpdateForTypeRef(UserTypeRef,_update)&&operation===OperationType.UPDATE&&this._user.isLoaded()&&isSameId(this._user.getLoaded()._id,instanceId)?(this._user.reset(),this._updateUsedStorageAndAdminFlag(),this._updateGroups()):isUpdateForTypeRef(MailboxServerPropertiesTypeRef,_update)?this._createOrUpdateWhitelistProtectionField():isUpdateForTypeRef(MailboxGroupRootTypeRef,_update)&&this._updateContactForms(),this._secondFactorsForm.entityEventReceived(_update)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}m.redraw()}}]),UserViewer}()),_export("UserViewer",UserViewer)}}}),System.register("src/settings/AppearanceSettingsViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../misc/LanguageViewModel","../gui/base/DropDownSelectorN","mithril/stream/stream.js","../misc/DeviceConfig","../gui/theme","../api/common/TutanotaConstants","../api/main/LoginController","../api/common/utils/Utils","../api/main/Entity","../api/main/EventController","../api/entities/tutanota/UserSettingsGroupRoot","../api/common/utils/DateUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,getLanguage,lang,languageCodeToTag,languages,DropDownSelectorN,stream,deviceConfig,themeId,TimeFormat,WeekStart,logins,downcast,load,update,isUpdateForTypeRef,UserSettingsGroupRootTypeRef,incrementDate,AppearanceSettingsViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){getLanguage=_miscLanguageViewModel.getLanguage,lang=_miscLanguageViewModel.lang,languageCodeToTag=_miscLanguageViewModel.languageCodeToTag,languages=_miscLanguageViewModel.languages},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_miscDeviceConfig){deviceConfig=_miscDeviceConfig.deviceConfig},function(_guiTheme){themeId=_guiTheme.themeId},function(_apiCommonTutanotaConstants){TimeFormat=_apiCommonTutanotaConstants.TimeFormat,WeekStart=_apiCommonTutanotaConstants.WeekStart},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonUtilsUtils){downcast=_apiCommonUtilsUtils.downcast},function(_apiMainEntity){load=_apiMainEntity.load,update=_apiMainEntity.update},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_apiEntitiesTutanotaUserSettingsGroupRoot){UserSettingsGroupRootTypeRef=_apiEntitiesTutanotaUserSettingsGroupRoot.UserSettingsGroupRootTypeRef},function(_apiCommonUtilsDateUtils){incrementDate=_apiCommonUtilsDateUtils.incrementDate}],execute:function(){_export("AppearanceSettingsViewer",AppearanceSettingsViewer=function(){function AppearanceSettingsViewer(){_classCallCheck(this,AppearanceSettingsViewer)}return _createClass(AppearanceSettingsViewer,[{key:"view",value:function(){var languageDropDownAttrs={label:"language_label",items:languages.map(function(language){return{name:lang.get(language.textId),value:language.code}}).concat({name:lang.get("automatic_label"),value:null}),selectedValue:stream(deviceConfig.getLanguage()||null),selectionChangedHandler:function(value){deviceConfig.setLanguage(value),value?lang.setLanguage({code:value,languageTag:languageCodeToTag(value)}).then(m.redraw):lang.setLanguage(getLanguage()).then(m.redraw)}},themeDropDownAttrs={label:"switchColorTheme_action",items:[{name:lang.get("light_label"),value:"light"},{name:lang.get("dark_label"),value:"dark"}],selectedValue:themeId,selectionChangedHandler:function(value){return deviceConfig.setTheme(value)}},userSettingsGroupRoot=logins.getUserController().userSettingsGroupRoot,hourFormatDropDownAttrs={label:"timeFormat_label",items:[{name:lang.get("timeFormatTwentyFourHour_label"),value:TimeFormat.TWENTY_FOUR_HOURS},{name:lang.get("timeFormatTwelveHour_label"),value:TimeFormat.TWELVE_HOURS}],selectedValue:stream(downcast(userSettingsGroupRoot.timeFormat)),selectionChangedHandler:function(value){userSettingsGroupRoot.timeFormat=value,update(userSettingsGroupRoot)}},weekdayFormat=new Intl.DateTimeFormat(lang.languageTag,{weekday:"long"}),calcDate=new Date;incrementDate(calcDate,-calcDate.getDay());var sundayName=weekdayFormat.format(calcDate);incrementDate(calcDate,1);var weekStartDropDownAttrs={label:"weekStart_label",items:[{name:weekdayFormat.format(calcDate),value:WeekStart.MONDAY},{name:sundayName,value:WeekStart.SUNDAY}],selectedValue:stream(downcast(userSettingsGroupRoot.startOfTheWeek)),selectionChangedHandler:function(value){userSettingsGroupRoot.startOfTheWeek=value,update(userSettingsGroupRoot)}};return m(".fill-absolute.scroll.plr-l.pb-xl",[m(".h4.mt-l",lang.get("settingsForDevice_label")),m(DropDownSelectorN,languageDropDownAttrs),"custom"===themeId()?null:m(DropDownSelectorN,themeDropDownAttrs),m(".h4.mt-l",lang.get("userSettings_label")),m(DropDownSelectorN,hourFormatDropDownAttrs),m(DropDownSelectorN,weekStartDropDownAttrs)])}},{key:"entityEventsReceived",value:function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _update=_step.value;isUpdateForTypeRef(UserSettingsGroupRootTypeRef,_update)&&load(UserSettingsGroupRootTypeRef,_update.instanceId).then(function(settings){lang.updateFormats({hour12:settings.timeFormat===TimeFormat.TWELVE_HOURS}),m.redraw()})}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}]),AppearanceSettingsViewer}()),_export("AppearanceSettingsViewer",AppearanceSettingsViewer)}}}),System.register("src/settings/AboutDialog.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/ButtonN","../native/SystemApp","../mail/MailEditor","../mail/MailModel","../gui/base/icons/Logo","../calendar/CalendarUtils","../gui/theme","../api/Env","../api/main/WorkerClient","../api/common/Logger","../api/common/utils/Utils","../misc/ErrorHandlerImpl"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,ButtonN,ButtonType,getDesktopLogs,getDeviceLogs,MailEditor,mailModel,LogoSvg,isColorLight,theme,isApp,isDesktop,worker,createLogFile,downcast,clientInfoString,AboutDialog;function sendLogsLink(){return m(".mt.right",m(ButtonN,{label:function(){return"Send Logs"},click:function(){mailModel.getUserMailboxDetails().then(function(mailboxDetails){var editor=new MailEditor(mailboxDetails),timestamp=new Date,_clientInfoString=clientInfoString(timestamp),message=_clientInfoString.message,type=_clientInfoString.type,client=_clientInfoString.client;message=message.split("\n").filter(Boolean).map(function(l){return"<div>"+l+"<br></div>"}).join(""),editor.initWithTemplate({},"Device logs v"+env.versionNumber+" - "+type+" - "+client,message,!0);var global=downcast(window),p=Promise.resolve();global.logger&&(p=worker.getLog().then(function(workerLogEntries){var mainEntries=global.logger.getEntries();editor.attachFiles([createLogFile(timestamp.getTime(),mainEntries,"main"),createLogFile(timestamp.getTime(),workerLogEntries,"worker")])})),isDesktop()&&(p=p.then(function(){return getDesktopLogs().then(function(desktopEntries){var desktopLogFile=createLogFile(timestamp.getTime(),desktopEntries,"desktop");editor.attachFiles([desktopLogFile])})})),isApp()&&(p=p.then(function(){getDeviceLogs().then(function(fileReference){fileReference.name=timestamp.getTime()+"_device_tutanota.log",editor.attachFiles([fileReference])})})),p.then(function(){editor.show()})})},type:ButtonType.Primary}))}function aboutLink(href,text){return m("a.no-text-decoration.mlr.mt",{href:href,target:"_blank"},[m(".underline",text)])}return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_nativeSystemApp){getDesktopLogs=_nativeSystemApp.getDesktopLogs,getDeviceLogs=_nativeSystemApp.getDeviceLogs},function(_mailMailEditor){MailEditor=_mailMailEditor.MailEditor},function(_mailMailModel){mailModel=_mailMailModel.mailModel},function(_guiBaseIconsLogo){LogoSvg=_guiBaseIconsLogo.LogoSvg},function(_calendarCalendarUtils){isColorLight=_calendarCalendarUtils.isColorLight},function(_guiTheme){theme=_guiTheme.theme},function(_apiEnv){isApp=_apiEnv.isApp,isDesktop=_apiEnv.isDesktop},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonLogger){createLogFile=_apiCommonLogger.createLogFile},function(_apiCommonUtilsUtils){downcast=_apiCommonUtilsUtils.downcast},function(_miscErrorHandlerImpl){clientInfoString=_miscErrorHandlerImpl.clientInfoString}],execute:function(){_export("AboutDialog",AboutDialog=function(){function AboutDialog(){_classCallCheck(this,AboutDialog)}return _createClass(AboutDialog,[{key:"view",value:function(vnode){return m(".flex.col",[m(".center.mt","Powered by"),m(".center.mt",m.trust(isColorLight(theme.content_bg.slice(1))?LogoSvg.Red:LogoSvg.Cyan)),m(".flex.justify-center.mt-l.flex-wrap",[aboutLink("https://tutanota.com","Website"),aboutLink("https://github.com/tutao/tutanota/releases","Releases")]),m(".flex.justify-center.flex-wrap",[m("p.center.mt.mlr","v"+env.versionNumber),m("p.text-center.mlr","GPL-v3"),m("p","© 2020 Tutao GmbH")]),sendLogsLink()])}}]),AboutDialog}()),_export("AboutDialog",AboutDialog)}}}),System.register("src/gui/nav/NavFunctions.js",["../../api/common/utils/Utils"],function(_export,_context){"use strict";var asyncImport;return _export("showUpgradeDialog",function(){asyncImport("undefined"!=typeof module?module.id:_context.id,env.rootPathPrefix+"src/subscription/UpgradeSubscriptionWizard.js").then(function(upgradeWizard){return upgradeWizard.showUpgradeWizard("Free")})}),_export("writeSupportMail",function(){asyncImport("undefined"!=typeof module?module.id:_context.id,env.rootPathPrefix+"src/mail/MailEditor.js").then(function(mailEditorModule){return mailEditorModule.MailEditor.writeSupportMail()})}),_export("writeInviteMail",function(){asyncImport("undefined"!=typeof module?module.id:_context.id,env.rootPathPrefix+"src/mail/MailEditor.js").then(function(mailEditorModule){return mailEditorModule.MailEditor.writeInviteMail()})}),{setters:[function(_apiCommonUtilsUtils){asyncImport=_apiCommonUtilsUtils.asyncImport}],execute:function(){}}}),System.register("src/gui/nav/BottomNav.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../base/NavButtonN","../base/icons/BootIcons","../size","../../misc/RouteChange","../../api/main/LoginController","../../api/common/TutanotaConstants"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,NavButtonN,BootIcons,size,CALENDAR_PREFIX,CONTACTS_PREFIX,navButtonRoutes,SEARCH_PREFIX,logins,FeatureType,fontSize,BottomNav;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_baseNavButtonN){NavButtonN=_baseNavButtonN.NavButtonN},function(_baseIconsBootIcons){BootIcons=_baseIconsBootIcons.BootIcons},function(_size){size=_size.size},function(_miscRouteChange){CALENDAR_PREFIX=_miscRouteChange.CALENDAR_PREFIX,CONTACTS_PREFIX=_miscRouteChange.CONTACTS_PREFIX,navButtonRoutes=_miscRouteChange.navButtonRoutes,SEARCH_PREFIX=_miscRouteChange.SEARCH_PREFIX},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonTutanotaConstants){FeatureType=_apiCommonTutanotaConstants.FeatureType}],execute:function(){fontSize=size.font_size_small,_export("BottomNav",BottomNav=function(){function BottomNav(){_classCallCheck(this,BottomNav)}return _createClass(BottomNav,[{key:"view",value:function(vnode){return m("bottom-nav.bottom-nav.flex.items-center.z1",[m(NavButtonN,{label:"emails_label",icon:function(){return BootIcons.Mail},href:navButtonRoutes.mailUrl,vertical:!0,fontSize:fontSize}),logins.isInternalUserLoggedIn()?m(NavButtonN,{label:"search_label",icon:function(){return BootIcons.Search},href:m.route.get().startsWith(SEARCH_PREFIX)?m.route.get():m.route.get().startsWith(CONTACTS_PREFIX)?"/search/contact":"/search/mail",isSelectedPrefix:SEARCH_PREFIX,vertical:!0,fontSize:fontSize}):null,logins.isInternalUserLoggedIn()&&!logins.isEnabled(FeatureType.DisableContacts)?m(NavButtonN,{label:"contacts_label",icon:function(){return BootIcons.Contacts},href:function(){return navButtonRoutes.contactsUrl},isSelectedPrefix:CONTACTS_PREFIX,vertical:!0,fontSize:fontSize}):null,logins.isInternalUserLoggedIn()&&!logins.isEnabled(FeatureType.DisableCalendar)?m(NavButtonN,{label:"calendar_label",icon:function(){return BootIcons.Calendar},href:CALENDAR_PREFIX,vertical:!0,fontSize:fontSize}):null])}}]),BottomNav}()),_export("BottomNav",BottomNav)}}}),System.register("src/gui/base/ViewSlider.js",["node_modules/systemjs-plugin-babel/babel-helpers/slicedToArray.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./ViewColumn","../../misc/WindowFacade","../size","../animation/Animations","../animation/Easing","../theme","../../api/common/utils/Utils","../../api/Env","../nav/BottomNav","./Header","../styles","../../api/common/utils/AriaUtils"],function(_export,_context){"use strict";var _slicedToArray,_classCallCheck,_createClass,m,ColumnType,windowFacade,size,alpha,animations,transform,ease,theme,neverNull,assertMainOrNode,BottomNav,header,styles,AriaLandmarks,gestureInfoFromTouch,ViewSlider;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs){_slicedToArray=_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_ViewColumn){ColumnType=_ViewColumn.ColumnType,_ViewColumn.ViewColumn},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_size){size=_size.size},function(_animationAnimations){alpha=_animationAnimations.alpha,animations=_animationAnimations.animations,transform=_animationAnimations.transform},function(_animationEasing){ease=_animationEasing.ease},function(_theme){theme=_theme.theme},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_navBottomNav){BottomNav=_navBottomNav.BottomNav},function(_Header){header=_Header.header},function(_styles){styles=_styles.styles},function(_apiCommonUtilsAriaUtils){AriaLandmarks=_apiCommonUtilsAriaUtils.AriaLandmarks}],execute:function(){assertMainOrNode(),_export("gestureInfoFromTouch",gestureInfoFromTouch=function(touch){return{x:touch.pageX,y:touch.pageY,time:performance.now(),identifier:touch.identifier}}),_export("gestureInfoFromTouch",gestureInfoFromTouch),_export("ViewSlider",ViewSlider=function(){function ViewSlider(viewColumns,parentName){var _this=this;_classCallCheck(this,ViewSlider),this.oncreate=function(){_this._updateVisibleBackgroundColumns(),windowFacade.addResizeListener(_this.resizeListener)},this.onremove=function(){return windowFacade.removeResizeListener(_this.resizeListener)},this.resizeListener=function(){return _this._updateVisibleBackgroundColumns()},this._getSideColDom=function(){return _this.columns[0]._domColumn},this.columns=viewColumns,this._mainColumn=neverNull(viewColumns.find(function(column){return column.columnType===ColumnType.Background})),this.focusedColumn=this._mainColumn,this._visibleBackgroundColumns=[],this._updateVisibleBackgroundColumns(),this._busy=Promise.resolve(),this._parentName=parentName,this._isModalBackgroundVisible=!1,this.columns.forEach(function(column){return column.setRole(_this._getColumnRole(column))}),this.view=function(){var mainSliderColumns=_this._getColumnsForMainSlider(),allBackgroundColumnsAreVisible=_this._visibleBackgroundColumns.length===mainSliderColumns.length;return m(".fill-absolute.flex.col",{oncreate:function(vnode){_this._attachTouchHandler(vnode.dom)},onremove:function(){_this.columns[0].columnType===ColumnType.Foreground&&_this.columns[0].isInForeground&&(_this.columns[0].isInForeground=!1,_this._isModalBackgroundVisible=!1)}},[m(header),m(".view-columns.backface_fix.flex-grow.rel",{oncreate:function(vnode){_this._domSlidingPart=vnode.dom},style:{width:_this.getWidth()+"px",transform:"translateX("+_this.getOffset(_this._visibleBackgroundColumns[0])+"px)"}},mainSliderColumns.map(function(column,index){return m(column,{rightBorder:allBackgroundColumnsAreVisible&&index!==mainSliderColumns.length-1})})),styles.isUsingBottomNavigation()?m(BottomNav):null,_this._getColumnsForOverlay().map(m),_this._createModalBackground()])}}return _createClass(ViewSlider,[{key:"_getColumnRole",value:function(column){return column.columnType===ColumnType.Foreground?null:this._mainColumn===column?AriaLandmarks.Main:AriaLandmarks.Region}},{key:"getMainColumn",value:function(){return this._mainColumn}},{key:"_getColumnsForMainSlider",value:function(){return this.columns.filter(function(c){return c.columnType===ColumnType.Background||c.visible})}},{key:"_getColumnsForOverlay",value:function(){return this.columns.filter(function(c){return c.columnType===ColumnType.Foreground&&!c.visible})}},{key:"_createModalBackground",value:function(){var _this2=this;return this._isModalBackgroundVisible?[m(".fill-absolute.z3.will-change-alpha",{oncreate:function(vnode){_this2._busy.then(function(){return animations.add(vnode.dom,alpha(alpha.type.backgroundColor,theme.modal_bg,0,.5))})},onbeforeremove:function(vnode){return _this2._busy.then(function(){return animations.add(vnode.dom,alpha(alpha.type.backgroundColor,theme.modal_bg,.5,0))})},onclick:function(event){_this2.focus(_this2._visibleBackgroundColumns[0])}})]:[]}},{key:"_updateVisibleBackgroundColumns",value:function(){var _this3=this;this.focusedColumn=this.focusedColumn||this._mainColumn;for(var visibleColumns=[this.focusedColumn.columnType===ColumnType.Background?this.focusedColumn:this._mainColumn],remainingSpace=window.innerWidth-visibleColumns[0].minWidth,nextVisibleColumn=this.getNextVisibleColumn(visibleColumns,this.columns);nextVisibleColumn&&remainingSpace>=nextVisibleColumn.minWidth;)visibleColumns.push(nextVisibleColumn),remainingSpace-=nextVisibleColumn.minWidth,nextVisibleColumn=this.getNextVisibleColumn(visibleColumns,this.columns);visibleColumns.sort(function(a,b){return _this3.columns.indexOf(a)-_this3.columns.indexOf(b)}),this._distributeRemainingSpace(visibleColumns,remainingSpace),this._setWidthForHiddenColumns(visibleColumns),this.columns.forEach(function(column){return column.visible=visibleColumns.includes(column)}),this.updateOffsets(),this._visibleBackgroundColumns=visibleColumns,this.allColumnsVisible()&&(this.focusedColumn.isInForeground=!1,this._isModalBackgroundVisible=!1,this.columns[0]._domColumn&&(this.columns[0]._domColumn.style.transform="")),window.requestAnimationFrame(function(){return m.redraw()})}},{key:"getVisibleBackgroundColumns",value:function(){return this._visibleBackgroundColumns.slice()}},{key:"isUsingOverlayColumns",value:function(){return this.columns.every(function(c){return c.columnType!==ColumnType.Foreground||c.visible})}},{key:"getNextVisibleColumn",value:function(visibleColumns,allColumns){var nextColumn=allColumns.find(function(column){return column.columnType===ColumnType.Background&&visibleColumns.indexOf(column)<0});return nextColumn||(nextColumn=allColumns.find(function(column){return column.columnType===ColumnType.Foreground&&visibleColumns.indexOf(column)<0})),nextColumn}},{key:"getBackgroundColumns",value:function(){return this.columns.filter(function(c){return c.columnType===ColumnType.Background})}},{key:"_distributeRemainingSpace",value:function(visibleColumns,remainingSpace){var spacePerColumn=remainingSpace/visibleColumns.length;visibleColumns.forEach(function(visibleColumn,index){if(visibleColumns.length-1===index)visibleColumn.setWidth(visibleColumn.minWidth+remainingSpace);else{var spaceForThisColumn=Math.min(spacePerColumn,visibleColumn.maxWidth-visibleColumn.minWidth);remainingSpace-=spaceForThisColumn,visibleColumn.setWidth(visibleColumn.minWidth+spaceForThisColumn)}})}},{key:"_setWidthForHiddenColumns",value:function(visibleColumns){if(this.columns.length!==visibleColumns.length){1===visibleColumns.length&&this.columns.forEach(function(column){return column.setWidth(visibleColumns[0].width)});var foreGroundColumn=this.columns.find(function(column){return column.columnType===ColumnType.Foreground});if(foreGroundColumn){var remainingSpace=window.innerWidth-foreGroundColumn.minWidth-size.hpad_large,additionalSpaceForColumn=Math.min(remainingSpace,foreGroundColumn.maxWidth-foreGroundColumn.minWidth);foreGroundColumn.setWidth(foreGroundColumn.minWidth+additionalSpaceForColumn)}}}},{key:"focus",value:function(viewColumn){var _this4=this;this._busy.then(function(){if(_this4.focusedColumn.isInForeground)return _this4._busy=_this4._slideForegroundColumn(_this4.focusedColumn,!1),_this4._busy}).then(function(){return _this4.focusedColumn=viewColumn,viewColumn.columnType===ColumnType.Background&&1===_this4._visibleBackgroundColumns.length&&_this4._visibleBackgroundColumns.indexOf(viewColumn)<0?_this4._busy=_this4._slideBackgroundColumns(viewColumn,_this4.getOffset(_this4._visibleBackgroundColumns[0]),_this4.getOffset(viewColumn)):viewColumn.columnType===ColumnType.Foreground&&_this4._visibleBackgroundColumns.indexOf(viewColumn)<0&&(_this4._busy=_this4._slideForegroundColumn(viewColumn,!0)),_this4._busy}).finally(function(){m.redraw(),viewColumn.focus()})}},{key:"_slideBackgroundColumns",value:function(nextVisibleViewColumn,oldOffset,newOffset){var _this5=this;return animations.add(this._domSlidingPart,transform(transform.type.translateX,oldOffset,newOffset),{easingFunction:ease.inOut}).finally(function(){var _visibleBackgroundCol=_this5._visibleBackgroundColumns.splice(0,1,nextVisibleViewColumn);_slicedToArray(_visibleBackgroundCol,1)[0].visible=!1,nextVisibleViewColumn.visible=!0})}},{key:"_slideForegroundColumn",value:function(foregroundColumn,toForeground){if(!foregroundColumn._domColumn)return Promise.resolve();var oldOffset=foregroundColumn._domColumn.getBoundingClientRect().left,newOffset=foregroundColumn.getOffsetForeground(toForeground);return this._isModalBackgroundVisible=toForeground,animations.add(neverNull(foregroundColumn._domColumn),transform(transform.type.translateX,oldOffset,newOffset),{easingFunction:ease.in}).finally(function(){foregroundColumn.isInForeground=toForeground})}},{key:"updateOffsets",value:function(){var offset=0,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=this.columns[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var column=_step.value;(column.columnType===ColumnType.Background||column.visible)&&(column.offset=offset,offset+=column.width)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}},{key:"getWidth",value:function(){var lastColumn=this.columns[this.columns.length-1];return lastColumn.offset+lastColumn.width}},{key:"getOffset",value:function(column){return 0-column.offset}},{key:"isFocusPreviousPossible",value:function(){return null!=this.getPreviousColumn()}},{key:"focusPreviousColumn",value:function(){this.isFocusPreviousPossible()&&this.focus(neverNull(this.getPreviousColumn()))}},{key:"focusNextColumn",value:function(){var indexOfCurrent=this.columns.indexOf(this.focusedColumn);indexOfCurrent+1<this.columns.length&&this.focus(this.columns[indexOfCurrent+1])}},{key:"getPreviousColumn",value:function(){if(this.columns.indexOf(this._visibleBackgroundColumns[0])>0&&!this.focusedColumn.isInForeground){var visibleColumnIndex=this.columns.indexOf(this._visibleBackgroundColumns[0]);return this.columns[visibleColumnIndex-1]}return null}},{key:"isFirstBackgroundColumnFocused",value:function(){return 0===this.columns.filter(function(column){return column.columnType===ColumnType.Background}).indexOf(this.focusedColumn)}},{key:"isForegroundColumnFocused",value:function(){return this.focusedColumn&&this.focusedColumn.columnType===ColumnType.Foreground}},{key:"allColumnsVisible",value:function(){return this._visibleBackgroundColumns.length===this.columns.length}},{key:"_attachTouchHandler",value:function(element){var _this6=this,lastGestureInfo=void 0,oldGestureInfo=void 0,initialGestureInfo=void 0,directionLock=0,gestureEnd=function(event){if(lastGestureInfo&&oldGestureInfo&&!_this6.allColumnsVisible()){var touch=event.changedTouches[0],mainCol=_this6._mainColumn._domColumn,sideCol=_this6._getSideColDom();if(!mainCol||!sideCol)return;var mainColRect=mainCol.getBoundingClientRect(),velocity=(lastGestureInfo.x-oldGestureInfo.x)/(lastGestureInfo.time-oldGestureInfo.time),show=function(){_this6.focusedColumn=_this6.columns[0],_this6._busy=_this6._slideForegroundColumn(_this6.columns[0],!0),_this6._isModalBackgroundVisible=!0},hide=function(){_this6.focusedColumn=_this6.columns[1],_this6._busy=_this6._slideForegroundColumn(_this6.columns[0],!1),_this6._isModalBackgroundVisible=!1};velocity>.8?show():velocity<-.8&&1!==directionLock?hide():touch.pageX>mainColRect.left+100?show():1!==directionLock&&hide(),_this6._busy.then(function(){return m.redraw()})}lastGestureInfo&&lastGestureInfo.identifier===event.changedTouches[0].identifier&&(lastGestureInfo=null,oldGestureInfo=null,initialGestureInfo=null,directionLock=0)},listeners={touchstart:function(event){if(!lastGestureInfo){var mainCol=_this6._mainColumn._domColumn,sideCol=_this6._getSideColDom();if(mainCol&&sideCol&&!_this6.allColumnsVisible()){var colRect=mainCol.getBoundingClientRect();1===event.touches.length&&(_this6.columns[0].isInForeground||event.touches[0].pageX<colRect.left+40)&&(_this6.columns[0].isInForeground||event.stopPropagation(),lastGestureInfo=initialGestureInfo=gestureInfoFromTouch(event.touches[0]))}else lastGestureInfo=null}},touchmove:function(event){var sideCol=_this6._getSideColDom();if(sideCol&&_this6._mainColumn&&!_this6.allColumnsVisible()){var gestureInfo=lastGestureInfo;if(gestureInfo&&1===event.touches.length&&initialGestureInfo){var touch=event.touches[0],newTouchPos=touch.pageX,sideColRect=sideCol.getBoundingClientRect();if(oldGestureInfo=lastGestureInfo,lastGestureInfo=gestureInfoFromTouch(touch),2===directionLock||1!==directionLock&&Math.abs(lastGestureInfo.x-initialGestureInfo.x)>30){directionLock=2;var newTranslate=Math.min(sideColRect.left-(gestureInfo.x-newTouchPos),0);sideCol.style.transform="translateX("+newTranslate+"px)",event.preventDefault()}else 1!==directionLock&&Math.abs(lastGestureInfo.y-initialGestureInfo.y)>30&&(directionLock=1);event.stopPropagation()}}},touchend:gestureEnd,touchcancel:gestureEnd};for(var listener in listeners)element.addEventListener(listener,listeners[listener],!0)}}]),ViewSlider}()),_export("ViewSlider",ViewSlider)}}}),System.register("src/gui/base/ViewColumn.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../../api/Env","../../api/common/utils/AriaUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,AriaLandmarks,landmarkAttrs,ColumnType,ViewColumn;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiCommonUtilsAriaUtils){AriaLandmarks=_apiCommonUtilsAriaUtils.AriaLandmarks,landmarkAttrs=_apiCommonUtilsAriaUtils.landmarkAttrs}],execute:function(){assertMainOrNode(),_export("ColumnType",ColumnType={Background:1,Foreground:0}),_export("ColumnType",ColumnType),_export("ViewColumn",ViewColumn=function(){function ViewColumn(component,columnType,minWidth,maxWidth,title,ariaLabel){var _this=this;_classCallCheck(this,ViewColumn),this.component=component,this.columnType=columnType,this.minWidth=minWidth,this.maxWidth=maxWidth,this.title=title,this.ariaLabel=ariaLabel,this.width=minWidth,this.offset=0,this.isInForeground=!1,this.visible=!1,this.view=function(vnode){var zIndex=_this.visible||_this.columnType!==ColumnType.Foreground?"":".z4",border=vnode.attrs.rightBorder?".list-border-right":"",landmark=_this._ariaRole?landmarkAttrs(_this._ariaRole,_this.ariaLabel?_this.ariaLabel():_this.getTitle()):"";return m(".view-column.overflow-x-hidden.fill-absolute.backface_fix"+zIndex+border+landmark,{"aria-hidden":_this.visible||_this.isInForeground?"false":"true",oncreate:function(vnode){_this._domColumn=vnode.dom,_this._domColumn.style.transform=_this.columnType===ColumnType.Foreground?"translateX("+_this.getOffsetForeground(_this.isInForeground)+"px)":null,_this._ariaRole===AriaLandmarks.Main&&_this.focus()},style:{width:_this.width+"px",left:_this.offset+"px"}},m(_this.component))}}return _createClass(ViewColumn,[{key:"setWidth",value:function(width){this.width=width}},{key:"setRole",value:function(landmark){this._ariaRole=landmark}},{key:"getWidth",value:function(){return this.width}},{key:"getTitle",value:function(){return this.title?this.title():""}},{key:"getOffsetForeground",value:function(foregroundState){return this.visible||foregroundState?0:-this.width}},{key:"focus",value:function(){this._domColumn&&this._domColumn.focus()}}]),ViewColumn}()),_export("ViewColumn",ViewColumn)}}}),System.register("src/settings/AddInboxRuleDialog.js",["mithril","../api/Env","../gui/base/Dialog","../misc/LanguageViewModel","../api/common/TutanotaConstants","../misc/FormatValidator","../mail/InboxRuleHandler","../api/entities/tutanota/InboxRule","../api/main/Entity","../misc/ErrorHandlerImpl","../api/main/LoginController","../mail/MailUtils","mithril/stream/stream.js","../gui/base/DropDownSelectorN","../gui/base/TextFieldN","../api/common/utils/Utils","../api/common/EntityFunctions"],function(_export,_context){"use strict";var m,assertMainOrNode,Dialog,lang,InboxRuleType,isDomainName,isMailAddress,isRegularExpression,getInboxRuleTypeNameMapping,createInboxRule,update,showNotAvailableForFreeDialog,logins,getArchiveFolder,getFolderName,getInboxFolder,stream,DropDownSelectorN,TextFieldN,neverNull,isSameId;function getExistingRuleForType(cleanValue,type){return logins.getUserController().props.inboxRules.find(function(rule){return type===rule.type&&cleanValue===rule.value})}function _getCleanedValue(type,value){return type===InboxRuleType.SUBJECT_CONTAINS||type===InboxRuleType.MAIL_HEADER_CONTAINS?value:value.trim().toLowerCase()}return _export("show",function(mailBoxDetails,ruleOrTemplate){if(logins.getUserController().isFreeAccount())showNotAvailableForFreeDialog(!0);else if(mailBoxDetails){var targetFolders=mailBoxDetails.folders.filter(function(folder){return folder!==getInboxFolder(mailBoxDetails.folders)}).map(function(folder){return{name:getFolderName(folder),value:folder}}).sort(function(folder1,folder2){return folder1.name.localeCompare(folder2.name)}),inboxRuleType=stream(ruleOrTemplate.type),inboxRuleValue=stream(ruleOrTemplate.value),selectedFolder=mailBoxDetails.folders.find(function(folder){return isSameId(folder._id,ruleOrTemplate.targetFolder)}),inboxRuleTarget=stream(selectedFolder||getArchiveFolder(mailBoxDetails.folders)),isNewRule=null===ruleOrTemplate._id;Dialog.showActionDialog({title:lang.get("addInboxRule_action"),child:function(){return[m(DropDownSelectorN,{items:getInboxRuleTypeNameMapping(),label:"inboxRuleField_label",selectedValue:inboxRuleType}),m(TextFieldN,{label:"inboxRuleValue_label",value:inboxRuleValue,helpLabel:function(){return inboxRuleType()!==InboxRuleType.SUBJECT_CONTAINS&&inboxRuleType()!==InboxRuleType.MAIL_HEADER_CONTAINS?lang.get("emailSenderPlaceholder_label"):lang.get("emptyString_msg")}}),m(DropDownSelectorN,{label:"inboxRuleTargetFolder_label",items:targetFolders,selectedValue:inboxRuleTarget})]},validator:function(){return function(type,value,ruleId){var currentCleanedValue=_getCleanedValue(type,value);if(""===currentCleanedValue)return"inboxRuleEnterValue_msg";if(!(type===InboxRuleType.SUBJECT_CONTAINS||type===InboxRuleType.MAIL_HEADER_CONTAINS||isRegularExpression(currentCleanedValue)||isDomainName(currentCleanedValue)||isMailAddress(currentCleanedValue,!1)))return"inboxRuleInvalidEmailAddress_msg";var existingRule=getExistingRuleForType(currentCleanedValue,type);return existingRule&&(!ruleId||ruleId&&!isSameId(existingRule._id,ruleId))?"inboxRuleAlreadyExists_msg":null}(inboxRuleType(),inboxRuleValue(),ruleOrTemplate._id)},allowOkWithReturn:!0,okAction:function(dialog){var rule=createInboxRule();rule.type=inboxRuleType(),rule.value=_getCleanedValue(inboxRuleType(),inboxRuleValue()),rule.targetFolder=inboxRuleTarget()._id;var props=logins.getUserController().props;isNewRule?props.inboxRules.push(rule):props.inboxRules=props.inboxRules.map(function(inboxRule){return isSameId(inboxRule._id,ruleOrTemplate._id)?rule:inboxRule}),update(props),dialog.close()}})}}),_export("createInboxRuleTemplate",function(ruleType,value){var template=createInboxRule();return template.type=ruleType||InboxRuleType.FROM_EQUALS,template.value=_getCleanedValue(neverNull(ruleType),value||""),template}),_export("getExistingRuleForType",getExistingRuleForType),{setters:[function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonTutanotaConstants){InboxRuleType=_apiCommonTutanotaConstants.InboxRuleType},function(_miscFormatValidator){isDomainName=_miscFormatValidator.isDomainName,isMailAddress=_miscFormatValidator.isMailAddress,isRegularExpression=_miscFormatValidator.isRegularExpression},function(_mailInboxRuleHandler){getInboxRuleTypeNameMapping=_mailInboxRuleHandler.getInboxRuleTypeNameMapping},function(_apiEntitiesTutanotaInboxRule){createInboxRule=_apiEntitiesTutanotaInboxRule.createInboxRule},function(_apiMainEntity){update=_apiMainEntity.update},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_mailMailUtils){getArchiveFolder=_mailMailUtils.getArchiveFolder,getFolderName=_mailMailUtils.getFolderName,getInboxFolder=_mailMailUtils.getInboxFolder},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiCommonEntityFunctions){isSameId=_apiCommonEntityFunctions.isSameId}],execute:function(){assertMainOrNode()}}}),System.register("src/settings/DomainDnsStatus.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../api/entities/sys/CustomDomainCheckData","../api/main/Entity","../api/entities/sys/Services","../api/common/EntityFunctions","../api/entities/sys/CustomDomainCheckReturn","../api/common/TutanotaConstants","../api/common/utils/LazyLoaded","../misc/LanguageViewModel","../api/Env"],function(_export,_context){"use strict";var _classCallCheck,_createClass,createCustomDomainCheckData,serviceRequest,SysService,HttpMethod,CustomDomainCheckReturnTypeRef,CustomDomainCheckResult,DnsRecordType,LazyLoaded,lang,assertMainOrNode,DomainDnsStatus;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_apiEntitiesSysCustomDomainCheckData){createCustomDomainCheckData=_apiEntitiesSysCustomDomainCheckData.createCustomDomainCheckData},function(_apiMainEntity){serviceRequest=_apiMainEntity.serviceRequest},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_apiEntitiesSysCustomDomainCheckReturn){CustomDomainCheckReturnTypeRef=_apiEntitiesSysCustomDomainCheckReturn.CustomDomainCheckReturnTypeRef},function(_apiCommonTutanotaConstants){CustomDomainCheckResult=_apiCommonTutanotaConstants.CustomDomainCheckResult,DnsRecordType=_apiCommonTutanotaConstants.DnsRecordType},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode}],execute:function(){assertMainOrNode(),_export("DomainDnsStatus",DomainDnsStatus=function(){function DomainDnsStatus(cleanDomainName){_classCallCheck(this,DomainDnsStatus),this.domain=cleanDomainName,this.status=new LazyLoaded(function(){var data=createCustomDomainCheckData();return data.domain=cleanDomainName,serviceRequest(SysService.CustomDomainCheckService,HttpMethod.GET,data,CustomDomainCheckReturnTypeRef)},null)}return _createClass(DomainDnsStatus,[{key:"getLoadedCustomDomainCheckReturn",value:function(){return this.status.getLoaded()}},{key:"areAllRecordsFine",value:function(){return this.status.isLoaded()&&this.status.getLoaded().checkResult===CustomDomainCheckResult.CUSTOM_DOMAIN_CHECK_RESULT_OK&&0===this.status.getLoaded().missingRecords.length&&0===this.status.getLoaded().invalidRecords.length}},{key:"getDnsStatusInfo",value:function(){if(this.status.isLoaded()){var result=this.status.getLoaded();if(result.checkResult===CustomDomainCheckResult.CUSTOM_DOMAIN_CHECK_RESULT_OK){var mxOk=!result.missingRecords.find(function(r){return r.type===DnsRecordType.DNS_RECORD_TYPE_MX})&&!result.invalidRecords.find(function(r){return r.type===DnsRecordType.DNS_RECORD_TYPE_MX}),spfOk=!result.missingRecords.find(function(r){return r.type===DnsRecordType.DNS_RECORD_TYPE_TXT_SPF})&&!result.invalidRecords.find(function(r){return r.type===DnsRecordType.DNS_RECORD_TYPE_TXT_SPF}),dkimOk=!result.missingRecords.find(function(r){return r.type===DnsRecordType.DNS_RECORD_TYPE_CNAME_DKIM})&&!result.invalidRecords.find(function(r){return r.type===DnsRecordType.DNS_RECORD_TYPE_CNAME_DKIM}),dmarcWarn=result.missingRecords.find(function(r){return r.type===DnsRecordType.DNS_RECORD_TYPE_TXT_DMARC});return"MX "+(mxOk?"✓":"✗")+", SPF "+(spfOk?"✓":"✗")+", DKIM "+(dkimOk?"✓":"✗")+", DMARC "+(result.invalidRecords.find(function(r){return r.type===DnsRecordType.DNS_RECORD_TYPE_TXT_DMARC})?"✗":dmarcWarn?"⚠":"✓")}return result.checkResult===CustomDomainCheckResult.CUSTOM_DOMAIN_CHECK_RESULT_DNS_LOOKUP_FAILED?"DNS ⚠":"DNS ✗"}return lang.get("loading_msg")}},{key:"loadCurrentStatus",value:function(){return this.status.isLoaded()?this.status.reload().return():this.status.getAsync().return()}}]),DomainDnsStatus}()),_export("DomainDnsStatus",DomainDnsStatus)}}}),System.register("src/settings/AddDomainDialog.js",["mithril","mithril/stream/stream.js","../misc/LanguageViewModel","../api/Env","../gui/base/Dialog","../api/common/TutanotaConstants","../api/main/WorkerClient","../misc/FormatValidator","../gui/base/TextFieldN","../gui/base/ProgressDialog","./CheckDomainDnsStatusDialog","./DomainDnsStatus","../gui/base/TableN","../api/entities/sys/DnsRecord"],function(_export,_context){"use strict";var m,stream,lang,assertMainOrNode,Dialog,DialogType,CustomDomainValidationResult,DnsRecordType,DnsRecordTypeToName,worker,isDomainName,TextFieldN,showProgressDialog,showDnsCheckDialog,DomainDnsStatus,ColumnWidth,TableN,createDnsRecord;function createDnsRecordTable(records){return m(TableN,{columnHeading:["type_label","dnsRecordHostOrName_label","dnsRecordValueOrPointsTo_label"],columnWidths:[ColumnWidth.Small,ColumnWidth.Small,ColumnWidth.Largest],showActionButtonColumn:!1,lines:records.map(function(r){return{cells:[DnsRecordTypeToName[r.type],r.subdomain?r.subdomain:"@",r.value]}})})}return _export("showAddDomainDialog",function(customerInfo,domainDnsStatus){var domainName=stream(""),expectedValidationRecord=createDnsRecord();expectedValidationRecord.type=DnsRecordType.DNS_RECORD_TYPE_TXT_SPF,expectedValidationRecord.subdomain=null,expectedValidationRecord.value="",worker.getDomainValidationRecord().then(function(recordValue){expectedValidationRecord.value=recordValue,m.redraw()});var dialog=Dialog.showActionDialog({type:DialogType.EditLarger,title:function(){return lang.get("addCustomDomain_action")},child:function(){return[m(TextFieldN,{label:"adminCustomDomain_label",value:domainName}),m(".mt-l",lang.get("addCustomDomainValidationRecord_msg")),createDnsRecordTable([expectedValidationRecord])]},allowOkWithReturn:!0,okAction:function(){var cleanDomainName=domainName().trim().toLowerCase();isDomainName(cleanDomainName)?customerInfo.domainInfos.find(function(info){return info.domain===cleanDomainName})?Dialog.error("customDomainDomainAssigned_msg"):showProgressDialog("pleaseWait_msg",worker.addDomain(cleanDomainName).then(function(result){if(result.validationResult===CustomDomainValidationResult.CUSTOM_DOMAIN_VALIDATION_RESULT_OK)return dialog.close(),domainDnsStatus[cleanDomainName]?null:(domainDnsStatus[cleanDomainName]=new DomainDnsStatus(cleanDomainName),domainDnsStatus[cleanDomainName].loadCurrentStatus().then(function(){return domainDnsStatus[cleanDomainName].areAllRecordsFine()||showDnsCheckDialog(domainDnsStatus[cleanDomainName]),null}));var errorMessageMap={};return errorMessageMap[CustomDomainValidationResult.CUSTOM_DOMAIN_VALIDATION_RESULT_DNS_LOOKUP_FAILED]="customDomainErrorDnsLookupFailure_msg",errorMessageMap[CustomDomainValidationResult.CUSTOM_DOMAIN_VALIDATION_RESULT_DOMAIN_NOT_FOUND]="customDomainErrorDomainNotFound_msg",errorMessageMap[CustomDomainValidationResult.CUSTOM_DOMAIN_VALIDATION_RESULT_NAMESERVER_NOT_FOUND]="customDomainErrorNameserverNotFound_msg",errorMessageMap[CustomDomainValidationResult.CUSTOM_DOMAIN_VALIDATION_RESULT_DOMAIN_NOT_AVAILABLE]="customDomainErrorDomainNotAvailable_msg",errorMessageMap[CustomDomainValidationResult.CUSTOM_DOMAIN_VALIDATION_RESULT_VALIDATION_FAILED]="customDomainErrorValidationFailed_msg",function(){return lang.get(errorMessageMap[result.validationResult])+(result.invalidDnsRecords.length>0?" "+lang.get("customDomainErrorOtherTxtRecords_msg")+"\n"+result.invalidDnsRecords.map(function(r){return r.value}).join("\n"):"")}})).then(function(message){message&&Dialog.error(message)}):Dialog.error("customDomainNeutral_msg")}}).setCloseHandler(function(){dialog.close()})}),_export("createDnsRecordTable",createDnsRecordTable),{setters:[function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_apiCommonTutanotaConstants){CustomDomainValidationResult=_apiCommonTutanotaConstants.CustomDomainValidationResult,DnsRecordType=_apiCommonTutanotaConstants.DnsRecordType,DnsRecordTypeToName=_apiCommonTutanotaConstants.DnsRecordTypeToName},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_miscFormatValidator){isDomainName=_miscFormatValidator.isDomainName},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_CheckDomainDnsStatusDialog){showDnsCheckDialog=_CheckDomainDnsStatusDialog.showDnsCheckDialog},function(_DomainDnsStatus){DomainDnsStatus=_DomainDnsStatus.DomainDnsStatus},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth,TableN=_guiBaseTableN.TableN},function(_apiEntitiesSysDnsRecord){createDnsRecord=_apiEntitiesSysDnsRecord.createDnsRecord}],execute:function(){assertMainOrNode()}}}),System.register("src/settings/CheckDomainDnsStatusDialog.js",["mithril","../misc/LanguageViewModel","../api/Env","../gui/base/Dialog","../api/common/TutanotaConstants","../gui/base/ProgressDialog","./DomainDnsStatus","./AddDomainDialog"],function(_export,_context){"use strict";var m,lang,assertMainOrNode,Dialog,DialogType,CustomDomainCheckResult,DnsRecordType,showProgressDialog,createDnsRecordTable;return _export("showDnsCheckDialog",function(currentStatus){var dialog=Dialog.showActionDialog({type:DialogType.EditLarger,title:function(){return lang.get("checkDnsRecords_action")},okActionTextId:"checkAgain_action",cancelActionTextId:"close_alt",child:function(){return function(){var result=currentStatus.getLoadedCustomDomainCheckReturn();if(result.checkResult===CustomDomainCheckResult.CUSTOM_DOMAIN_CHECK_RESULT_OK){var array=[];if(result.missingRecords.length>0||result.invalidRecords.length>0){array.push(m(".i.mt-m.mb-s",lang.get("skipDnsRecordsInfo_msg"))),result.missingRecords.filter(function(r){return r.type!==DnsRecordType.DNS_RECORD_TYPE_TXT_DMARC}).length>0&&(array.push(m(".mt-m.mb-s",lang.get("setDnsRecords_msg"))),array.push(createDnsRecordTable(result.missingRecords.filter(function(r){return r.type!==DnsRecordType.DNS_RECORD_TYPE_TXT_DMARC})))),result.invalidRecords.length>0&&(array.push(m(".mt-m.mb-s",lang.get("deleteDnsRecords_msg"))),array.push(createDnsRecordTable(result.invalidRecords)));var recommendedDmarc=result.missingRecords.find(function(r){return r.type===DnsRecordType.DNS_RECORD_TYPE_TXT_DMARC});recommendedDmarc&&(array.push(m(".mt-m.mb-s",lang.get("recommendedDmarcRecord_msg"))),array.push(createDnsRecordTable([recommendedDmarc]))),array.push(m("span.small.mt-m",lang.get("moreInfo_msg")+" ")),array.push(m("span.small",m("a[href="+lang.getInfoLink("domainInfo_link")+"][target=_blank]",lang.getInfoLink("domainInfo_link"))))}return array}var errorMessageMap={};return errorMessageMap[CustomDomainCheckResult.CUSTOM_DOMAIN_CHECK_RESULT_DNS_LOOKUP_FAILED]="customDomainErrorDnsLookupFailure_msg",errorMessageMap[CustomDomainCheckResult.CUSTOM_DOMAIN_CHECK_RESULT_DOMAIN_NOT_FOUND]="customDomainErrorDomainNotFound_msg",errorMessageMap[CustomDomainCheckResult.CUSTOM_DOMAIN_CHECK_RESULT_NAMESERVER_NOT_FOUND]="customDomainErrorNameserverNotFound_msg",[lang.get(errorMessageMap[result.checkResult])]}()},okAction:function(){showProgressDialog("pleaseWait_msg",currentStatus.loadCurrentStatus()).then(function(){currentStatus.areAllRecordsFine()?(dialog.close(),Dialog.error("dnsRecordsOk_msg")):m.redraw()})}}).setCloseHandler(function(){dialog.close()})}),{setters:[function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_apiCommonTutanotaConstants){CustomDomainCheckResult=_apiCommonTutanotaConstants.CustomDomainCheckResult,DnsRecordType=_apiCommonTutanotaConstants.DnsRecordType},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_DomainDnsStatus){_DomainDnsStatus.DomainDnsStatus},function(_AddDomainDialog){createDnsRecordTable=_AddDomainDialog.createDnsRecordTable}],execute:function(){assertMainOrNode()}}}),System.register("src/settings/GlobalSettingsViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/slicedToArray.js","node_modules/systemjs-plugin-babel/babel-helpers/defineProperty.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../misc/LanguageViewModel","../api/main/Entity","./AddSpamRuleDialog","../api/common/TutanotaConstants","../api/common/utils/Utils","../api/entities/sys/CustomerServerProperties","../api/main/WorkerClient","../api/common/EntityFunctions","../gui/base/DropDownSelector","mithril/stream/stream.js","../api/main/LoginController","../api/entities/sys/AuditLogEntry","../misc/Formatter","../api/entities/sys/Customer","../gui/base/Dialog","../api/entities/sys/GroupInfo","../api/common/error/RestError","../api/common/utils/LazyLoaded","../api/entities/sys/CustomerInfo","./LoadingUtils","../api/entities/sys/Group","../api/entities/sys/User","../misc/ErrorHandlerImpl","../gui/base/icons/Icons","../gui/base/ProgressDialog","../api/main/EventController","../gui/base/TableN","../gui/base/ExpanderN","../gui/base/DropdownN","../gui/base/ButtonN","./AddDomainDialog","./DomainDnsStatus","./CheckDomainDnsStatusDialog"],function(_export,_context){"use strict";var _slicedToArray,_defineProperty,_classCallCheck,_createClass,m,assertMainOrNode,lang,load,loadRange,update,AddSpamRuleDialog,getSparmRuleField,GroupType,OperationType,SpamRuleFieldType,SpamRuleType,getCustomMailDomains,getUserGroupMemberships,neverNull,objectEntries,CustomerServerPropertiesTypeRef,worker,GENERATED_MAX_ID,DropDownSelector,stream,logins,AuditLogEntryTypeRef,formatDateTime,formatDateTimeFromYesterdayOn,CustomerTypeRef,Dialog,GroupInfoTypeRef,NotAuthorizedError,PreconditionFailedError,LazyLoaded,CustomerInfoTypeRef,loadEnabledTeamMailGroups,loadEnabledUserMailGroups,loadGroupDisplayName,GroupTypeRef,UserTypeRef,showNotAvailableForFreeDialog,Icons,showProgressDialog,isUpdateForTypeRef,ColumnWidth,createRowActions,TableN,ExpanderButtonN,ExpanderPanelN,createDropdown,ButtonType,showAddDomainDialog,DomainDnsStatus,showDnsCheckDialog,GlobalSettingsViewer;function getSpamRuleTypeNameMapping(){return[{value:SpamRuleType.WHITELIST,name:lang.get("emailSenderWhitelist_action")},{value:SpamRuleType.BLACKLIST,name:lang.get("emailSenderBlacklist_action")},{value:SpamRuleType.DISCARD,name:lang.get("emailSenderDiscardlist_action")}]}function getSpamRuleFieldToName(){var _ref;return _defineProperty(_ref={},SpamRuleFieldType.FROM,lang.get("from_label")),_defineProperty(_ref,SpamRuleFieldType.TO,lang.get("to_label")),_defineProperty(_ref,SpamRuleFieldType.CC,"CC"),_defineProperty(_ref,SpamRuleFieldType.BCC,"BCC"),_ref}return _export("getSpamRuleTypeNameMapping",getSpamRuleTypeNameMapping),_export("getSpamRuleFieldMapping",function(){return objectEntries(getSpamRuleFieldToName()).map(function(_ref2){var _ref3=_slicedToArray(_ref2,2);return{value:_ref3[0],name:_ref3[1]}})}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs){_slicedToArray=_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersDefinePropertyJs){_defineProperty=_node_modulesSystemjsPluginBabelBabelHelpersDefinePropertyJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiMainEntity){load=_apiMainEntity.load,loadRange=_apiMainEntity.loadRange,update=_apiMainEntity.update},function(_AddSpamRuleDialog){AddSpamRuleDialog=_AddSpamRuleDialog},function(_apiCommonTutanotaConstants){getSparmRuleField=_apiCommonTutanotaConstants.getSparmRuleField,GroupType=_apiCommonTutanotaConstants.GroupType,OperationType=_apiCommonTutanotaConstants.OperationType,SpamRuleFieldType=_apiCommonTutanotaConstants.SpamRuleFieldType,SpamRuleType=_apiCommonTutanotaConstants.SpamRuleType},function(_apiCommonUtilsUtils){getCustomMailDomains=_apiCommonUtilsUtils.getCustomMailDomains,getUserGroupMemberships=_apiCommonUtilsUtils.getUserGroupMemberships,neverNull=_apiCommonUtilsUtils.neverNull,objectEntries=_apiCommonUtilsUtils.objectEntries},function(_apiEntitiesSysCustomerServerProperties){CustomerServerPropertiesTypeRef=_apiEntitiesSysCustomerServerProperties.CustomerServerPropertiesTypeRef},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonEntityFunctions){GENERATED_MAX_ID=_apiCommonEntityFunctions.GENERATED_MAX_ID},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiEntitiesSysAuditLogEntry){AuditLogEntryTypeRef=_apiEntitiesSysAuditLogEntry.AuditLogEntryTypeRef},function(_miscFormatter){formatDateTime=_miscFormatter.formatDateTime,formatDateTimeFromYesterdayOn=_miscFormatter.formatDateTimeFromYesterdayOn},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiCommonErrorRestError){NotAuthorizedError=_apiCommonErrorRestError.NotAuthorizedError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_LoadingUtils){loadEnabledTeamMailGroups=_LoadingUtils.loadEnabledTeamMailGroups,loadEnabledUserMailGroups=_LoadingUtils.loadEnabledUserMailGroups,loadGroupDisplayName=_LoadingUtils.loadGroupDisplayName},function(_apiEntitiesSysGroup){GroupTypeRef=_apiEntitiesSysGroup.GroupTypeRef},function(_apiEntitiesSysUser){UserTypeRef=_apiEntitiesSysUser.UserTypeRef},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth,createRowActions=_guiBaseTableN.createRowActions,TableN=_guiBaseTableN.TableN},function(_guiBaseExpanderN){ExpanderButtonN=_guiBaseExpanderN.ExpanderButtonN,ExpanderPanelN=_guiBaseExpanderN.ExpanderPanelN},function(_guiBaseDropdownN){createDropdown=_guiBaseDropdownN.createDropdown},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType},function(_AddDomainDialog){showAddDomainDialog=_AddDomainDialog.showAddDomainDialog},function(_DomainDnsStatus){DomainDnsStatus=_DomainDnsStatus.DomainDnsStatus},function(_CheckDomainDnsStatusDialog){showDnsCheckDialog=_CheckDomainDnsStatusDialog.showDnsCheckDialog}],execute:function(){assertMainOrNode(),_export("GlobalSettingsViewer",GlobalSettingsViewer=function(){function GlobalSettingsViewer(){var _this=this;_classCallCheck(this,GlobalSettingsViewer),this._customerInfo=new LazyLoaded(function(){return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerInfoTypeRef,customer.customerInfo)})}),this._domainDnsStatus={},this._spamRuleLines=stream([]),this._spamRulesExpandedState=stream(!1),this._customDomainLines=stream([]),this._customDomainsExpandedState=stream(!1),this._auditLogLines=stream([]),this._auditLogExpandedState=stream(!1),this._props=stream(),this._customer=stream();var saveIpAddress=stream(!1);this._props.map(function(props){return saveIpAddress(props.saveEncryptedIpAddressInSession)});var saveIpAddressDropdown=new DropDownSelector("saveEncryptedIpAddress_label",null,[{name:lang.get("yes_label"),value:!0},{name:lang.get("no_label"),value:!1}],saveIpAddress,250).setSelectionChangedHandler(function(v){update(Object.assign({},_this._props(),{saveEncryptedIpAddressInSession:v}))}),requirePasswordUpdateAfterReset=stream(!1);this._props.map(function(props){return requirePasswordUpdateAfterReset(props.requirePasswordUpdateAfterReset)});var requirePasswordUpdateAfterResetDropdown=new DropDownSelector("enforcePasswordUpdate_title",function(){return lang.get("enforcePasswordUpdate_msg")},[{name:lang.get("yes_label"),value:!0},{name:lang.get("no_label"),value:!1}],requirePasswordUpdateAfterReset,250).setSelectionChangedHandler(function(v){update(Object.assign({},_this._props(),{requirePasswordUpdateAfterReset:v}))});this.view=function(){var spamRuleTableAttrs={columnHeading:["emailSender_label","emailSenderRule_label"],columnWidths:[ColumnWidth.Largest,ColumnWidth.Small],showActionButtonColumn:!0,addButtonAttrs:{label:"addSpamRule_action",click:function(){return AddSpamRuleDialog.show()},icon:function(){return Icons.Add}},lines:_this._spamRuleLines()},customDomainTableAttrs={columnHeading:["adminCustomDomain_label","catchAllMailbox_label"],columnWidths:[ColumnWidth.Largest,ColumnWidth.Largest],showActionButtonColumn:!0,addButtonAttrs:{label:"addCustomDomain_action",click:function(){logins.getUserController().isFreeAccount()?showNotAvailableForFreeDialog(!0):_this._customerInfo.getAsync().then(function(customerInfo){return showAddDomainDialog(customerInfo,_this._domainDnsStatus)})},icon:function(){return Icons.Add}},lines:_this._customDomainLines()},auditLogTableAttrs={columnHeading:["action_label","modified_label","time_label"],columnWidths:[ColumnWidth.Largest,ColumnWidth.Largest,ColumnWidth.Small],showActionButtonColumn:!0,lines:_this._auditLogLines()};return[m("#global-settings.fill-absolute.scroll.plr-l",[m(".flex-space-between.items-center.mb-s.mt-l",[m(".h4",lang.get("adminSpam_action")),m(ExpanderButtonN,{label:"show_action",expanded:_this._spamRulesExpandedState})]),m(ExpanderPanelN,{expanded:_this._spamRulesExpandedState},m(TableN,spamRuleTableAttrs)),m("small",lang.get("adminSpamRuleInfo_msg")),m("small.text-break",[m("a[href="+lang.getInfoLink("spamRules_link")+"][target=_blank]",lang.getInfoLink("spamRules_link"))]),m(".flex-space-between.items-center.mb-s.mt-l",[m(".h4",lang.get("customEmailDomains_label")),m(ExpanderButtonN,{label:"show_action",expanded:_this._customDomainsExpandedState})]),m(ExpanderPanelN,{expanded:_this._customDomainsExpandedState},m(TableN,customDomainTableAttrs)),m("small",lang.get("moreInfo_msg")+" "),m("small.text-break",[m("a[href="+lang.getInfoLink("domainInfo_link")+"][target=_blank]",lang.getInfoLink("domainInfo_link"))]),m(".mt-l",[m(".h4",lang.get("security_title")),m(saveIpAddressDropdown),logins.getUserController().isGlobalAdmin()&&logins.getUserController().isPremiumAccount()?m("",[m(requirePasswordUpdateAfterResetDropdown),_this._customer()?m(".mt-l",[m(".flex-space-between.items-center.mb-s",[m(".h4",lang.get("auditLog_title")),m(ExpanderButtonN,{label:"show_action",expanded:_this._auditLogExpandedState})]),m(ExpanderPanelN,{expanded:_this._auditLogExpandedState},m(TableN,auditLogTableAttrs)),m("small",lang.get("auditLogInfo_msg"))]):null]):null])])]},this._updateDomains(),this._updateCustomerServerProperties(),this._updateAuditLog()}return _createClass(GlobalSettingsViewer,[{key:"_updateCustomerServerProperties",value:function(){var _this2=this;worker.loadCustomerServerProperties().then(function(props){_this2._props(props);var fieldToName=getSpamRuleFieldToName();_this2._spamRuleLines(props.emailSenderList.map(function(rule,index){return{cells:function(){return[{main:fieldToName[getSparmRuleField(rule)],info:rule.value},{main:neverNull(getSpamRuleTypeNameMapping().find(function(t){return t.value===rule.type})).name}]},actionButtonAttrs:createRowActions({getArray:function(){return props.emailSenderList},updateInstance:function(){return update(props)}},rule,index,[{label:"edit_action",click:function(){return AddSpamRuleDialog.show(rule)},type:ButtonType.Dropdown}])}})),m.redraw()})}},{key:"_updateAuditLog",value:function(){var _this3=this;load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){_this3._customer(customer),loadRange(AuditLogEntryTypeRef,neverNull(customer.auditLog).items,GENERATED_MAX_ID,200,!0).then(function(auditLog){_this3._auditLogLines(auditLog.map(function(auditLogEntry){return{cells:[auditLogEntry.action,auditLogEntry.modifiedEntity,formatDateTimeFromYesterdayOn(auditLogEntry.date)],actionButtonAttrs:{label:"showMore_action",icon:function(){return Icons.More},click:function(){return _this3._showAuditLogDetails(auditLogEntry,customer)}}}}))})})}},{key:"_showAuditLogDetails",value:function(entry,customer){var _this4=this,modifiedGroupInfo=stream(),groupInfo=stream(),groupInfoLoadingPromises=[];entry.modifiedGroupInfo&&groupInfoLoadingPromises.push(load(GroupInfoTypeRef,entry.modifiedGroupInfo).then(function(gi){modifiedGroupInfo(gi)}).catch(NotAuthorizedError,function(e){})),entry.groupInfo&&groupInfoLoadingPromises.push(load(GroupInfoTypeRef,entry.groupInfo).then(function(gi){groupInfo(gi)}).catch(NotAuthorizedError,function(e){})),Promise.all(groupInfoLoadingPromises).then(function(){var dialog=Dialog.showActionDialog({title:lang.get("auditLog_title"),child:{view:function(){return m("table.pt",[m("tr",[m("td",lang.get("action_label")),m("td.pl",entry.action)]),m("tr",[m("td",lang.get("actor_label")),m("td.pl",entry.actorMailAddress)]),m("tr",[m("td",lang.get("IpAddress_label")),m("td.pl",entry.actorIpAddress?entry.actorIpAddress:"")]),m("tr",[m("td",lang.get("modified_label")),m("td.pl",modifiedGroupInfo()&&_this4._getGroupInfoDisplayText(modifiedGroupInfo())?_this4._getGroupInfoDisplayText(modifiedGroupInfo()):entry.modifiedEntity)]),groupInfo()?m("tr",[m("td",lang.get("group_label")),m("td.pl",customer.adminGroup===groupInfo().group?lang.get("globalAdmin_label"):_this4._getGroupInfoDisplayText(groupInfo()))]):null,m("tr",[m("td",lang.get("time_label")),m("td.pl",formatDateTime(entry.date))])])}},allowOkWithReturn:!0,okAction:function(){return dialog.close()},allowCancel:!1})})}},{key:"_getGroupInfoDisplayText",value:function(groupInfo){return groupInfo.name&&groupInfo.mailAddress?groupInfo.name+" <"+groupInfo.mailAddress+">":groupInfo.mailAddress?groupInfo.mailAddress:groupInfo.name}},{key:"_updateDomains",value:function(){var _this5=this;this._customerInfo.getAsync().then(function(customerInfo){var customDomainInfos=getCustomMailDomains(customerInfo);Object.keys(_this5._domainDnsStatus).forEach(function(domain){customDomainInfos.find(function(di){return di.domain===domain})||delete _this5._domainDnsStatus[domain]}),Promise.map(customDomainInfos,function(domainInfo){_this5._domainDnsStatus[domainInfo.domain]||(_this5._domainDnsStatus[domainInfo.domain]=new DomainDnsStatus(domainInfo.domain),_this5._domainDnsStatus[domainInfo.domain].loadCurrentStatus().then(function(){m.redraw()}));var domainDnsStatus=_this5._domainDnsStatus[domainInfo.domain],p=Promise.resolve(lang.get("comboBoxSelectionNone_msg"));return domainInfo.catchAllMailGroup&&(p=loadGroupDisplayName(domainInfo.catchAllMailGroup)),p.then(function(catchAllGroupName){return{cells:function(){return[{main:domainInfo.domain,info:domainDnsStatus.getDnsStatusInfo(),click:domainDnsStatus.status.isLoaded()&&!domainDnsStatus.areAllRecordsFine()?function(){showDnsCheckDialog(domainDnsStatus)}:null},{main:catchAllGroupName,info:null}]},actionButtonAttrs:{label:"action_label",icon:function(){return Icons.More},click:createDropdown(function(){return(domainDnsStatus.status.isLoaded()&&!domainDnsStatus.areAllRecordsFine()?[{type:ButtonType.Dropdown,label:"checkDnsRecords_action",click:function(){showDnsCheckDialog(domainDnsStatus)}}]:[]).concat([{type:ButtonType.Dropdown,label:"setCatchAllMailbox_action",click:function(){return _this5._editCatchAllMailbox(domainInfo)}},{type:ButtonType.Dropdown,label:"delete_action",click:function(){return _this5._deleteCustomDomain(domainInfo)}}])},250)}}})}).then(function(tableLines){return _this5._customDomainLines(tableLines)})})}},{key:"_editCatchAllMailbox",value:function(domainInfo){showProgressDialog("pleaseWait_msg",load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return loadEnabledTeamMailGroups(customer).then(function(teamMailGroups){return loadEnabledUserMailGroups(customer).then(function(userMailGroups){var allMailGroups=teamMailGroups.concat(userMailGroups),options=[{name:lang.get("comboBoxSelectionNone_msg"),value:null}].concat(allMailGroups.map(function(groupData){return{name:groupData.displayName,value:groupData.groupId}})),selectedPromise=Promise.resolve(null);return domainInfo.catchAllMailGroup&&(selectedPromise=load(GroupTypeRef,domainInfo.catchAllMailGroup).then(function(catchAllGroup){return catchAllGroup.type===GroupType.User?load(UserTypeRef,neverNull(catchAllGroup.user)).then(function(user){return getUserGroupMemberships(user,GroupType.Mail)[0].group}):domainInfo.catchAllMailGroup})),selectedPromise.then(function(catchAllMailGroupId){var selected=allMailGroups.find(function(g){return g.groupId===catchAllMailGroupId});return{available:options,selected:selected}})})})})).then(function(availableAndSelectedGroupDatas){var valueStream=stream(availableAndSelectedGroupDatas.selected?availableAndSelectedGroupDatas.selected.groupId:null);return Dialog.showDropDownSelectionDialog("setCatchAllMailbox_action","catchAllMailbox_label",null,availableAndSelectedGroupDatas.available,valueStream,250).then(function(selectedMailGroupId){return worker.setCatchAllGroup(domainInfo.domain,selectedMailGroupId)})})}},{key:"_deleteCustomDomain",value:function(domainInfo){var _this6=this;worker.removeDomain(domainInfo.domain).catch(PreconditionFailedError,function(e){-1!==(null!=_this6._props()?_this6._props().whitelabelRegistrationDomains.map(function(domainWrapper){return domainWrapper.value}):[]).indexOf(domainInfo.domain)?Dialog.error(function(){return lang.get("customDomainDeletePreconditionWhitelabelFailed_msg",{"{domainName}":domainInfo.domain})}):Dialog.error(function(){return lang.get("customDomainDeletePreconditionFailed_msg",{"{domainName}":domainInfo.domain})})})}},{key:"entityEventsReceived",value:function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _update=_step.value;isUpdateForTypeRef(CustomerServerPropertiesTypeRef,_update)&&_update.operation===OperationType.UPDATE?this._updateCustomerServerProperties():isUpdateForTypeRef(AuditLogEntryTypeRef,_update)?this._updateAuditLog():isUpdateForTypeRef(CustomerInfoTypeRef,_update)&&_update.operation===OperationType.UPDATE&&(this._customerInfo.reset(),this._updateDomains())}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}]),GlobalSettingsViewer}()),_export("GlobalSettingsViewer",GlobalSettingsViewer)}}}),System.register("src/settings/AddSpamRuleDialog.js",["mithril","../misc/LanguageViewModel","../api/Env","./GlobalSettingsViewer","../misc/FormatValidator","../api/common/TutanotaConstants","../api/common/utils/ArrayUtils","../gui/base/Dialog","../api/main/WorkerClient","../api/main/Entity","../api/common/utils/Utils","../api/entities/sys/CustomerInfo","../api/entities/sys/Customer","../api/main/LoginController","mithril/stream/stream.js","../gui/base/DropDownSelectorN","../gui/base/TextFieldN"],function(_export,_context){"use strict";var m,lang,assertMainOrNode,getSpamRuleFieldMapping,getSpamRuleTypeNameMapping,isDomainOrTopLevelDomain,isMailAddress,getSpamRuleType,getSparmRuleField,SpamRuleType,TUTANOTA_MAIL_ADDRESS_DOMAINS,contains,Dialog,worker,load,neverNull,CustomerInfoTypeRef,CustomerTypeRef,logins,stream,DropDownSelectorN,TextFieldN;function _getInputInvalidMessage(type,value,field,existingRules,customDomains,existingSpamRuleOrTemplate){var currentValue=value.toLowerCase().trim();return existingRules&&customDomains?""===currentValue?"spamRuleEnterValue_msg":isDomainOrTopLevelDomain(currentValue)||isMailAddress(currentValue,!1)||"*"===currentValue?function(type,value,customDomains){if(type!==SpamRuleType.WHITELIST){if(isDomainOrTopLevelDomain(value))return"tutao.de"===value||contains(TUTANOTA_MAIL_ADDRESS_DOMAINS,value)||contains(customDomains,value);if(isMailAddress(value,!1)){var domain=value.split("@")[1];return"tutao.de"===domain||contains(customDomains,domain)}}return!1}(type,currentValue,customDomains)?"emailSenderInvalidRule_msg":existingRules.some(function(r){return r.value===currentValue&&(null==existingSpamRuleOrTemplate||r._id!==existingSpamRuleOrTemplate._id)&&r.field===field})?"emailSenderExistingRule_msg":null:"invalidInputFormat_msg":"emptyString_msg"}return _export("show",function(existingSpamRuleOrTemplate){var existingSpamRules=null,customDomains=void 0;worker.loadCustomerServerProperties().then(function(props){existingSpamRules=props.emailSenderList,load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerInfoTypeRef,customer.customerInfo)}).then(function(customerInfo){customDomains=customerInfo.domainInfos.map(function(d){return d.domain}),m.redraw()})});var typeItems=getSpamRuleTypeNameMapping(),selectedType=stream(existingSpamRuleOrTemplate&&getSpamRuleType(existingSpamRuleOrTemplate)||typeItems[0].value),valueFieldValue=stream(existingSpamRuleOrTemplate?existingSpamRuleOrTemplate.value:""),fieldValues=getSpamRuleFieldMapping(),selectedField=stream(existingSpamRuleOrTemplate?getSparmRuleField(existingSpamRuleOrTemplate):fieldValues[0].value);Dialog.showActionDialog({title:lang.get("addSpamRule_action"),child:function(){return[m(DropDownSelectorN,{items:fieldValues,label:"field_label",selectedValue:selectedField}),m(TextFieldN,{label:"emailSenderPlaceholder_label",value:valueFieldValue,helpLabel:function(){return lang.get(_getInputInvalidMessage(selectedType(),valueFieldValue(),selectedField(),existingSpamRules,customDomains,existingSpamRuleOrTemplate)||"emptyString_msg")}}),m(DropDownSelectorN,{items:typeItems,label:"emailSenderRule_label",selectedValue:selectedType})]},validator:function(){return _getInputInvalidMessage(selectedType(),valueFieldValue(),selectedField(),existingSpamRules,customDomains,existingSpamRuleOrTemplate)},allowOkWithReturn:!0,okAction:function(dialog){existingSpamRuleOrTemplate&&existingSpamRuleOrTemplate._id?worker.editSpamRule(Object.assign({},existingSpamRuleOrTemplate,{value:valueFieldValue(),field:selectedField(),type:selectedType()})):worker.addSpamRule(selectedField(),selectedType(),valueFieldValue()),dialog.close()}})}),{setters:[function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_GlobalSettingsViewer){getSpamRuleFieldMapping=_GlobalSettingsViewer.getSpamRuleFieldMapping,getSpamRuleTypeNameMapping=_GlobalSettingsViewer.getSpamRuleTypeNameMapping},function(_miscFormatValidator){isDomainOrTopLevelDomain=_miscFormatValidator.isDomainOrTopLevelDomain,isMailAddress=_miscFormatValidator.isMailAddress},function(_apiCommonTutanotaConstants){getSpamRuleType=_apiCommonTutanotaConstants.getSpamRuleType,getSparmRuleField=_apiCommonTutanotaConstants.getSparmRuleField,SpamRuleType=_apiCommonTutanotaConstants.SpamRuleType,TUTANOTA_MAIL_ADDRESS_DOMAINS=_apiCommonTutanotaConstants.TUTANOTA_MAIL_ADDRESS_DOMAINS},function(_apiCommonUtilsArrayUtils){contains=_apiCommonUtilsArrayUtils.contains},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiMainEntity){load=_apiMainEntity.load},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN}],execute:function(){assertMainOrNode()}}}),function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():System.registerDynamic("libs/Autolinker.js",[],!1,function($__require,$__exports,$__module){return factory.call(this)})}(0,function(){"use strict";function indexOf(arr,element){if(Array.prototype.indexOf)return arr.indexOf(element);for(var i=0,len=arr.length;i<len;i++)if(arr[i]===element)return i;return-1}function remove(arr,fn){for(var i=arr.length-1;i>=0;i--)!0===fn(arr[i])&&arr.splice(i,1)}function throwUnhandledCaseError(theValue){throw new Error("Unhandled case for value: '"+theValue+"'")}var HtmlTag=function(){function HtmlTag(cfg){void 0===cfg&&(cfg={}),this.tagName="",this.attrs={},this.innerHTML="",this.whitespaceRegex=/\s+/,this.tagName=cfg.tagName||"",this.attrs=cfg.attrs||{},this.innerHTML=cfg.innerHtml||cfg.innerHTML||""}return HtmlTag.prototype.setTagName=function(tagName){return this.tagName=tagName,this},HtmlTag.prototype.getTagName=function(){return this.tagName||""},HtmlTag.prototype.setAttr=function(attrName,attrValue){return this.getAttrs()[attrName]=attrValue,this},HtmlTag.prototype.getAttr=function(attrName){return this.getAttrs()[attrName]},HtmlTag.prototype.setAttrs=function(attrs){return Object.assign(this.getAttrs(),attrs),this},HtmlTag.prototype.getAttrs=function(){return this.attrs||(this.attrs={})},HtmlTag.prototype.setClass=function(cssClass){return this.setAttr("class",cssClass)},HtmlTag.prototype.addClass=function(cssClass){for(var newClass,classAttr=this.getClass(),whitespaceRegex=this.whitespaceRegex,classes=classAttr?classAttr.split(whitespaceRegex):[],newClasses=cssClass.split(whitespaceRegex);newClass=newClasses.shift();)-1===indexOf(classes,newClass)&&classes.push(newClass);return this.getAttrs().class=classes.join(" "),this},HtmlTag.prototype.removeClass=function(cssClass){for(var removeClass,classAttr=this.getClass(),whitespaceRegex=this.whitespaceRegex,classes=classAttr?classAttr.split(whitespaceRegex):[],removeClasses=cssClass.split(whitespaceRegex);classes.length&&(removeClass=removeClasses.shift());){var idx=indexOf(classes,removeClass);-1!==idx&&classes.splice(idx,1)}return this.getAttrs().class=classes.join(" "),this},HtmlTag.prototype.getClass=function(){return this.getAttrs().class||""},HtmlTag.prototype.hasClass=function(cssClass){return-1!==(" "+this.getClass()+" ").indexOf(" "+cssClass+" ")},HtmlTag.prototype.setInnerHTML=function(html){return this.innerHTML=html,this},HtmlTag.prototype.setInnerHtml=function(html){return this.setInnerHTML(html)},HtmlTag.prototype.getInnerHTML=function(){return this.innerHTML||""},HtmlTag.prototype.getInnerHtml=function(){return this.getInnerHTML()},HtmlTag.prototype.toAnchorString=function(){var tagName=this.getTagName(),attrsStr=this.buildAttrsStr();return["<",tagName,attrsStr=attrsStr?" "+attrsStr:"",">",this.getInnerHtml(),"</",tagName,">"].join("")},HtmlTag.prototype.buildAttrsStr=function(){if(!this.attrs)return"";var attrs=this.getAttrs(),attrsArr=[];for(var prop in attrs)attrs.hasOwnProperty(prop)&&attrsArr.push(prop+'="'+attrs[prop]+'"');return attrsArr.join(" ")},HtmlTag}();var AnchorTagBuilder=function(){function AnchorTagBuilder(cfg){void 0===cfg&&(cfg={}),this.newWindow=!1,this.truncate={},this.className="",this.newWindow=cfg.newWindow||!1,this.truncate=cfg.truncate||{},this.className=cfg.className||""}return AnchorTagBuilder.prototype.build=function(match){return new HtmlTag({tagName:"a",attrs:this.createAttrs(match),innerHtml:this.processAnchorText(match.getAnchorText())})},AnchorTagBuilder.prototype.createAttrs=function(match){var attrs={href:match.getAnchorHref()},cssClass=this.createCssClass(match);return cssClass&&(attrs.class=cssClass),this.newWindow&&(attrs.target="_blank",attrs.rel="noopener noreferrer"),this.truncate&&this.truncate.length&&this.truncate.length<match.getAnchorText().length&&(attrs.title=match.getAnchorHref()),attrs},AnchorTagBuilder.prototype.createCssClass=function(match){var className=this.className;if(className){for(var returnClasses=[className],cssClassSuffixes=match.getCssClassSuffixes(),i=0,len=cssClassSuffixes.length;i<len;i++)returnClasses.push(className+"-"+cssClassSuffixes[i]);return returnClasses.join(" ")}return""},AnchorTagBuilder.prototype.processAnchorText=function(anchorText){return anchorText=this.doTruncate(anchorText)},AnchorTagBuilder.prototype.doTruncate=function(anchorText){var truncate=this.truncate;if(!truncate||!truncate.length)return anchorText;var truncateLength=truncate.length,truncateLocation=truncate.location;return"smart"===truncateLocation?function(url,truncateLen,ellipsisChars){var ellipsisLengthBeforeParsing,ellipsisLength;null==ellipsisChars?(ellipsisChars="&hellip;",ellipsisLength=3,ellipsisLengthBeforeParsing=8):(ellipsisLength=ellipsisChars.length,ellipsisLengthBeforeParsing=ellipsisChars.length);var buildUrl=function(urlObj){var url="";return urlObj.scheme&&urlObj.host&&(url+=urlObj.scheme+"://"),urlObj.host&&(url+=urlObj.host),urlObj.path&&(url+="/"+urlObj.path),urlObj.query&&(url+="?"+urlObj.query),urlObj.fragment&&(url+="#"+urlObj.fragment),url},buildSegment=function(segment,remainingAvailableLength){var remainingAvailableLengthHalf=remainingAvailableLength/2,startOffset=Math.ceil(remainingAvailableLengthHalf),endOffset=-1*Math.floor(remainingAvailableLengthHalf),end="";return endOffset<0&&(end=segment.substr(endOffset)),segment.substr(0,startOffset)+ellipsisChars+end};if(url.length<=truncateLen)return url;var availableLength=truncateLen-ellipsisLength,urlObj=function(url){var urlObj={},urlSub=url,match=urlSub.match(/^([a-z]+):\/\//i);return match&&(urlObj.scheme=match[1],urlSub=urlSub.substr(match[0].length)),(match=urlSub.match(/^(.*?)(?=(\?|#|\/|$))/i))&&(urlObj.host=match[1],urlSub=urlSub.substr(match[0].length)),(match=urlSub.match(/^\/(.*?)(?=(\?|#|$))/i))&&(urlObj.path=match[1],urlSub=urlSub.substr(match[0].length)),(match=urlSub.match(/^\?(.*?)(?=(#|$))/i))&&(urlObj.query=match[1],urlSub=urlSub.substr(match[0].length)),(match=urlSub.match(/^#(.*?)$/i))&&(urlObj.fragment=match[1]),urlObj}(url);if(urlObj.query){var matchQuery=urlObj.query.match(/^(.*?)(?=(\?|\#))(.*?)$/i);matchQuery&&(urlObj.query=urlObj.query.substr(0,matchQuery[1].length),url=buildUrl(urlObj))}if(url.length<=truncateLen)return url;if(urlObj.host&&(urlObj.host=urlObj.host.replace(/^www\./,""),url=buildUrl(urlObj)),url.length<=truncateLen)return url;var str="";if(urlObj.host&&(str+=urlObj.host),str.length>=availableLength)return urlObj.host.length==truncateLen?(urlObj.host.substr(0,truncateLen-ellipsisLength)+ellipsisChars).substr(0,availableLength+ellipsisLengthBeforeParsing):buildSegment(str,availableLength).substr(0,availableLength+ellipsisLengthBeforeParsing);var pathAndQuery="";if(urlObj.path&&(pathAndQuery+="/"+urlObj.path),urlObj.query&&(pathAndQuery+="?"+urlObj.query),pathAndQuery){if((str+pathAndQuery).length>=availableLength)return(str+pathAndQuery).length==truncateLen?(str+pathAndQuery).substr(0,truncateLen):(str+buildSegment(pathAndQuery,availableLength-str.length)).substr(0,availableLength+ellipsisLengthBeforeParsing);str+=pathAndQuery}if(urlObj.fragment){var fragment="#"+urlObj.fragment;if((str+fragment).length>=availableLength)return(str+fragment).length==truncateLen?(str+fragment).substr(0,truncateLen):(str+buildSegment(fragment,availableLength-str.length)).substr(0,availableLength+ellipsisLengthBeforeParsing);str+=fragment}if(urlObj.scheme&&urlObj.host){var scheme=urlObj.scheme+"://";if((str+scheme).length<availableLength)return(scheme+str).substr(0,truncateLen)}if(str.length<=truncateLen)return str;var end="";return availableLength>0&&(end=str.substr(-1*Math.floor(availableLength/2))),(str.substr(0,Math.ceil(availableLength/2))+ellipsisChars+end).substr(0,availableLength+ellipsisLengthBeforeParsing)}(anchorText,truncateLength):"middle"===truncateLocation?function(url,truncateLen,ellipsisChars){if(url.length<=truncateLen)return url;var ellipsisLengthBeforeParsing,ellipsisLength;null==ellipsisChars?(ellipsisChars="&hellip;",ellipsisLengthBeforeParsing=8,ellipsisLength=3):(ellipsisLengthBeforeParsing=ellipsisChars.length,ellipsisLength=ellipsisChars.length);var availableLength=truncateLen-ellipsisLength,end="";return availableLength>0&&(end=url.substr(-1*Math.floor(availableLength/2))),(url.substr(0,Math.ceil(availableLength/2))+ellipsisChars+end).substr(0,availableLength+ellipsisLengthBeforeParsing)}(anchorText,truncateLength):function(anchorText,truncateLen,ellipsisChars){return function(str,truncateLen,ellipsisChars){var ellipsisLength;return str.length>truncateLen&&(null==ellipsisChars?(ellipsisChars="&hellip;",ellipsisLength=3):ellipsisLength=ellipsisChars.length,str=str.substring(0,truncateLen-ellipsisLength)+ellipsisChars),str}(anchorText,truncateLen,ellipsisChars)}(anchorText,truncateLength)},AnchorTagBuilder}(),Match=function(){function Match(cfg){this.__jsduckDummyDocProp=null,this.matchedText="",this.offset=0,this.tagBuilder=cfg.tagBuilder,this.matchedText=cfg.matchedText,this.offset=cfg.offset}return Match.prototype.getMatchedText=function(){return this.matchedText},Match.prototype.setOffset=function(offset){this.offset=offset},Match.prototype.getOffset=function(){return this.offset},Match.prototype.getCssClassSuffixes=function(){return[this.getType()]},Match.prototype.buildTag=function(){return this.tagBuilder.build(this)},Match}(),extendStatics=function(d,b){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)b.hasOwnProperty(p)&&(d[p]=b[p])})(d,b)};function __extends(d,b){function __(){this.constructor=d}extendStatics(d,b),d.prototype=null===b?Object.create(b):(__.prototype=b.prototype,new __)}var __assign=function(){return(__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(t[p]=s[p]);return t}).apply(this,arguments)},EmailMatch=function(_super){function EmailMatch(cfg){var _this=_super.call(this,cfg)||this;return _this.email="",_this.email=cfg.email,_this}return __extends(EmailMatch,_super),EmailMatch.prototype.getType=function(){return"email"},EmailMatch.prototype.getEmail=function(){return this.email},EmailMatch.prototype.getAnchorHref=function(){return"mailto:"+this.email},EmailMatch.prototype.getAnchorText=function(){return this.email},EmailMatch}(Match),HashtagMatch=function(_super){function HashtagMatch(cfg){var _this=_super.call(this,cfg)||this;return _this.serviceName="",_this.hashtag="",_this.serviceName=cfg.serviceName,_this.hashtag=cfg.hashtag,_this}return __extends(HashtagMatch,_super),HashtagMatch.prototype.getType=function(){return"hashtag"},HashtagMatch.prototype.getServiceName=function(){return this.serviceName},HashtagMatch.prototype.getHashtag=function(){return this.hashtag},HashtagMatch.prototype.getAnchorHref=function(){var serviceName=this.serviceName,hashtag=this.hashtag;switch(serviceName){case"twitter":return"https://twitter.com/hashtag/"+hashtag;case"facebook":return"https://www.facebook.com/hashtag/"+hashtag;case"instagram":return"https://instagram.com/explore/tags/"+hashtag;default:throw new Error("Unknown service name to point hashtag to: "+serviceName)}},HashtagMatch.prototype.getAnchorText=function(){return"#"+this.hashtag},HashtagMatch}(Match),MentionMatch=function(_super){function MentionMatch(cfg){var _this=_super.call(this,cfg)||this;return _this.serviceName="twitter",_this.mention="",_this.mention=cfg.mention,_this.serviceName=cfg.serviceName,_this}return __extends(MentionMatch,_super),MentionMatch.prototype.getType=function(){return"mention"},MentionMatch.prototype.getMention=function(){return this.mention},MentionMatch.prototype.getServiceName=function(){return this.serviceName},MentionMatch.prototype.getAnchorHref=function(){switch(this.serviceName){case"twitter":return"https://twitter.com/"+this.mention;case"instagram":return"https://instagram.com/"+this.mention;case"soundcloud":return"https://soundcloud.com/"+this.mention;default:throw new Error("Unknown service name to point mention to: "+this.serviceName)}},MentionMatch.prototype.getAnchorText=function(){return"@"+this.mention},MentionMatch.prototype.getCssClassSuffixes=function(){var cssClassSuffixes=_super.prototype.getCssClassSuffixes.call(this),serviceName=this.getServiceName();return serviceName&&cssClassSuffixes.push(serviceName),cssClassSuffixes},MentionMatch}(Match),PhoneMatch=function(_super){function PhoneMatch(cfg){var _this=_super.call(this,cfg)||this;return _this.number="",_this.plusSign=!1,_this.number=cfg.number,_this.plusSign=cfg.plusSign,_this}return __extends(PhoneMatch,_super),PhoneMatch.prototype.getType=function(){return"phone"},PhoneMatch.prototype.getPhoneNumber=function(){return this.number},PhoneMatch.prototype.getNumber=function(){return this.getPhoneNumber()},PhoneMatch.prototype.getAnchorHref=function(){return"tel:"+(this.plusSign?"+":"")+this.number},PhoneMatch.prototype.getAnchorText=function(){return this.matchedText},PhoneMatch}(Match),UrlMatch=function(_super){function UrlMatch(cfg){var _this=_super.call(this,cfg)||this;return _this.url="",_this.urlMatchType="scheme",_this.protocolUrlMatch=!1,_this.protocolRelativeMatch=!1,_this.stripPrefix={scheme:!0,www:!0},_this.stripTrailingSlash=!0,_this.decodePercentEncoding=!0,_this.schemePrefixRegex=/^(https?:\/\/)?/i,_this.wwwPrefixRegex=/^(https?:\/\/)?(www\.)?/i,_this.protocolRelativeRegex=/^\/\//,_this.protocolPrepended=!1,_this.urlMatchType=cfg.urlMatchType,_this.url=cfg.url,_this.protocolUrlMatch=cfg.protocolUrlMatch,_this.protocolRelativeMatch=cfg.protocolRelativeMatch,_this.stripPrefix=cfg.stripPrefix,_this.stripTrailingSlash=cfg.stripTrailingSlash,_this.decodePercentEncoding=cfg.decodePercentEncoding,_this}return __extends(UrlMatch,_super),UrlMatch.prototype.getType=function(){return"url"},UrlMatch.prototype.getUrlMatchType=function(){return this.urlMatchType},UrlMatch.prototype.getUrl=function(){var url=this.url;return this.protocolRelativeMatch||this.protocolUrlMatch||this.protocolPrepended||(url=this.url="http://"+url,this.protocolPrepended=!0),url},UrlMatch.prototype.getAnchorHref=function(){return this.getUrl().replace(/&amp;/g,"&")},UrlMatch.prototype.getAnchorText=function(){var anchorText=this.getMatchedText();return this.protocolRelativeMatch&&(anchorText=this.stripProtocolRelativePrefix(anchorText)),this.stripPrefix.scheme&&(anchorText=this.stripSchemePrefix(anchorText)),this.stripPrefix.www&&(anchorText=this.stripWwwPrefix(anchorText)),this.stripTrailingSlash&&(anchorText=this.removeTrailingSlash(anchorText)),this.decodePercentEncoding&&(anchorText=this.removePercentEncoding(anchorText)),anchorText},UrlMatch.prototype.stripSchemePrefix=function(url){return url.replace(this.schemePrefixRegex,"")},UrlMatch.prototype.stripWwwPrefix=function(url){return url.replace(this.wwwPrefixRegex,"$1")},UrlMatch.prototype.stripProtocolRelativePrefix=function(text){return text.replace(this.protocolRelativeRegex,"")},UrlMatch.prototype.removeTrailingSlash=function(anchorText){return"/"===anchorText.charAt(anchorText.length-1)&&(anchorText=anchorText.slice(0,-1)),anchorText},UrlMatch.prototype.removePercentEncoding=function(anchorText){var preProcessedEntityAnchorText=anchorText.replace(/%22/gi,"&quot;").replace(/%26/gi,"&amp;").replace(/%27/gi,"&#39;").replace(/%3C/gi,"&lt;").replace(/%3E/gi,"&gt;");try{return decodeURIComponent(preProcessedEntityAnchorText)}catch(e){return preProcessedEntityAnchorText}},UrlMatch}(Match),Matcher=function(){return function(cfg){this.__jsduckDummyDocProp=null,this.tagBuilder=cfg.tagBuilder}}(),letterRe=/[A-Za-z]/,digitRe=/[0-9]/,whitespaceRe=/\s/,quoteRe=/['"]/,controlCharsRe=/[\x00-\x1F\x7F]/,alphaCharsStr=/A-Za-z\xAA\xB5\xBA\xC0-\xD6\xD8-\xF6\xF8-\u02C1\u02C6-\u02D1\u02E0-\u02E4\u02EC\u02EE\u0370-\u0374\u0376\u0377\u037A-\u037D\u037F\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u048A-\u052F\u0531-\u0556\u0559\u0561-\u0587\u05D0-\u05EA\u05F0-\u05F2\u0620-\u064A\u066E\u066F\u0671-\u06D3\u06D5\u06E5\u06E6\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u07A5\u07B1\u07CA-\u07EA\u07F4\u07F5\u07FA\u0800-\u0815\u081A\u0824\u0828\u0840-\u0858\u08A0-\u08B4\u08B6-\u08BD\u0904-\u0939\u093D\u0950\u0958-\u0961\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09F0\u09F1\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A59-\u0A5C\u0A5E\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABD\u0AD0\u0AE0\u0AE1\u0AF9\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3D\u0B5C\u0B5D\u0B5F-\u0B61\u0B71\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BD0\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C58-\u0C5A\u0C60\u0C61\u0C80\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBD\u0CDE\u0CE0\u0CE1\u0CF1\u0CF2\u0D05-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3A\u0D3D\u0D4E\u0D54-\u0D56\u0D5F-\u0D61\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E46\u0E81\u0E82\u0E84\u0E87\u0E88\u0E8A\u0E8D\u0E94-\u0E97\u0E99-\u0E9F\u0EA1-\u0EA3\u0EA5\u0EA7\u0EAA\u0EAB\u0EAD-\u0EB0\u0EB2\u0EB3\u0EBD\u0EC0-\u0EC4\u0EC6\u0EDC-\u0EDF\u0F00\u0F40-\u0F47\u0F49-\u0F6C\u0F88-\u0F8C\u1000-\u102A\u103F\u1050-\u1055\u105A-\u105D\u1061\u1065\u1066\u106E-\u1070\u1075-\u1081\u108E\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16F1-\u16F8\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17D7\u17DC\u1820-\u1877\u1880-\u1884\u1887-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1950-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u1A00-\u1A16\u1A20-\u1A54\u1AA7\u1B05-\u1B33\u1B45-\u1B4B\u1B83-\u1BA0\u1BAE\u1BAF\u1BBA-\u1BE5\u1C00-\u1C23\u1C4D-\u1C4F\u1C5A-\u1C7D\u1C80-\u1C88\u1CE9-\u1CEC\u1CEE-\u1CF1\u1CF5\u1CF6\u1D00-\u1DBF\u1E00-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6-\u1FCC\u1FD0-\u1FD3\u1FD6-\u1FDB\u1FE0-\u1FEC\u1FF2-\u1FF4\u1FF6-\u1FFC\u2071\u207F\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2183\u2184\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CEE\u2CF2\u2CF3\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005\u3006\u3031-\u3035\u303B\u303C\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312D\u3131-\u318E\u31A0-\u31BA\u31F0-\u31FF\u3400-\u4DB5\u4E00-\u9FD5\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA61F\uA62A\uA62B\uA640-\uA66E\uA67F-\uA69D\uA6A0-\uA6E5\uA717-\uA71F\uA722-\uA788\uA78B-\uA7AE\uA7B0-\uA7B7\uA7F7-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA840-\uA873\uA882-\uA8B3\uA8F2-\uA8F7\uA8FB\uA8FD\uA90A-\uA925\uA930-\uA946\uA960-\uA97C\uA984-\uA9B2\uA9CF\uA9E0-\uA9E4\uA9E6-\uA9EF\uA9FA-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA60-\uAA76\uAA7A\uAA7E-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAAC0\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB5A\uAB5C-\uAB65\uAB70-\uABE2\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D\uFB1F-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE70-\uFE74\uFE76-\uFEFC\uFF21-\uFF3A\uFF41-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC/.source,alphaCharsAndMarksStr=alphaCharsStr+/\u2700-\u27bf\udde6-\uddff\ud800-\udbff\udc00-\udfff\ufe0e\ufe0f\u0300-\u036f\ufe20-\ufe23\u20d0-\u20f0\ud83c\udffb-\udfff\u200d\u3299\u3297\u303d\u3030\u24c2\ud83c\udd70-\udd71\udd7e-\udd7f\udd8e\udd91-\udd9a\udde6-\uddff\ude01-\ude02\ude1a\ude2f\ude32-\ude3a\ude50-\ude51\u203c\u2049\u25aa-\u25ab\u25b6\u25c0\u25fb-\u25fe\u00a9\u00ae\u2122\u2139\udc04\u2600-\u26FF\u2b05\u2b06\u2b07\u2b1b\u2b1c\u2b50\u2b55\u231a\u231b\u2328\u23cf\u23e9-\u23f3\u23f8-\u23fa\udccf\u2935\u2934\u2190-\u21ff/.source+/\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08D4-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C03\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D01-\u0D03\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF8\u1CF9\u1DC0-\u1DF5\u1DFB-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F/.source,decimalNumbersStr=/0-9\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0BE6-\u0BEF\u0C66-\u0C6F\u0CE6-\u0CEF\u0D66-\u0D6F\u0DE6-\u0DEF\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F29\u1040-\u1049\u1090-\u1099\u17E0-\u17E9\u1810-\u1819\u1946-\u194F\u19D0-\u19D9\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\uA620-\uA629\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uA9F0-\uA9F9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19/.source,alphaNumericCharsStr=alphaCharsAndMarksStr+decimalNumbersStr,alphaNumericAndMarksCharsStr=alphaCharsAndMarksStr+decimalNumbersStr,ipStr="(?:["+decimalNumbersStr+"]{1,3}\\.){3}["+decimalNumbersStr+"]{1,3}",domainLabelStr="["+alphaNumericAndMarksCharsStr+"](?:["+alphaNumericAndMarksCharsStr+"\\-]{0,61}["+alphaNumericAndMarksCharsStr+"])?",getDomainLabelStr=function(group){return"(?=("+domainLabelStr+"))\\"+group},getDomainNameStr=function(group){return"(?:"+getDomainLabelStr(group)+"(?:\\."+getDomainLabelStr(group+1)+"){0,126}|"+ipStr+")"},domainNameCharRegex=new RegExp("["+alphaNumericAndMarksCharsStr+"]"),tldRegex=/(?:xn--vermgensberatung-pwb|xn--vermgensberater-ctb|xn--clchc0ea0b2g2a9gcd|xn--w4r85el8fhu5dnra|northwesternmutual|travelersinsurance|vermögensberatung|xn--3oq18vl8pn36a|xn--5su34j936bgsg|xn--bck1b9a5dre4c|xn--mgbai9azgqp6j|xn--mgberp4a5d4ar|xn--xkc2dl3a5ee0h|vermögensberater|xn--fzys8d69uvgm|xn--mgba7c0bbn0a|xn--xkc2al3hye2a|americanexpress|kerryproperties|sandvikcoromant|xn--i1b6b1a6a2e|xn--kcrx77d1x4a|xn--lgbbat1ad8j|xn--mgba3a4f16a|xn--mgbaakc7dvf|xn--mgbc0a9azcg|xn--nqv7fs00ema|afamilycompany|americanfamily|bananarepublic|cancerresearch|cookingchannel|kerrylogistics|weatherchannel|xn--54b7fta0cc|xn--6qq986b3xl|xn--80aqecdr1a|xn--b4w605ferd|xn--fiq228c5hs|xn--h2breg3eve|xn--jlq61u9w7b|xn--mgba3a3ejt|xn--mgbaam7a8h|xn--mgbayh7gpa|xn--mgbb9fbpob|xn--mgbbh1a71e|xn--mgbca7dzdo|xn--mgbi4ecexp|xn--mgbx4cd0ab|xn--rvc1e0am3e|international|lifeinsurance|spreadbetting|travelchannel|wolterskluwer|xn--eckvdtc9d|xn--fpcrj9c3d|xn--fzc2c9e2c|xn--h2brj9c8c|xn--tiq49xqyj|xn--yfro4i67o|xn--ygbi2ammx|construction|lplfinancial|scholarships|versicherung|xn--3e0b707e|xn--45br5cyl|xn--80adxhks|xn--80asehdb|xn--8y0a063a|xn--gckr3f0f|xn--mgb9awbf|xn--mgbab2bd|xn--mgbgu82a|xn--mgbpl2fh|xn--mgbt3dhd|xn--mk1bu44c|xn--ngbc5azd|xn--ngbe9e0a|xn--ogbpf8fl|xn--qcka1pmc|accountants|barclaycard|blackfriday|blockbuster|bridgestone|calvinklein|contractors|creditunion|engineering|enterprises|foodnetwork|investments|kerryhotels|lamborghini|motorcycles|olayangroup|photography|playstation|productions|progressive|redumbrella|rightathome|williamhill|xn--11b4c3d|xn--1ck2e1b|xn--1qqw23a|xn--2scrj9c|xn--3bst00m|xn--3ds443g|xn--3hcrj9c|xn--42c2d9a|xn--45brj9c|xn--55qw42g|xn--6frz82g|xn--80ao21a|xn--9krt00a|xn--cck2b3b|xn--czr694b|xn--d1acj3b|xn--efvy88h|xn--estv75g|xn--fct429k|xn--fjq720a|xn--flw351e|xn--g2xx48c|xn--gecrj9c|xn--gk3at1e|xn--h2brj9c|xn--hxt814e|xn--imr513n|xn--j6w193g|xn--jvr189m|xn--kprw13d|xn--kpry57d|xn--kpu716f|xn--mgbbh1a|xn--mgbtx2b|xn--mix891f|xn--nyqy26a|xn--otu796d|xn--pbt977c|xn--pgbs0dh|xn--q9jyb4c|xn--rhqv96g|xn--rovu88b|xn--s9brj9c|xn--ses554g|xn--t60b56a|xn--vuq861b|xn--w4rs40l|xn--xhq521b|xn--zfr164b|சிங்கப்பூர்|accountant|apartments|associates|basketball|bnpparibas|boehringer|capitalone|consulting|creditcard|cuisinella|eurovision|extraspace|foundation|healthcare|immobilien|industries|management|mitsubishi|nationwide|newholland|nextdirect|onyourside|properties|protection|prudential|realestate|republican|restaurant|schaeffler|swiftcover|tatamotors|technology|telefonica|university|vistaprint|vlaanderen|volkswagen|xn--30rr7y|xn--3pxu8k|xn--45q11c|xn--4gbrim|xn--55qx5d|xn--5tzm5g|xn--80aswg|xn--90a3ac|xn--9dbq2a|xn--9et52u|xn--c2br7g|xn--cg4bki|xn--czrs0t|xn--czru2d|xn--fiq64b|xn--fiqs8s|xn--fiqz9s|xn--io0a7i|xn--kput3i|xn--mxtq1m|xn--o3cw4h|xn--pssy2u|xn--unup4y|xn--wgbh1c|xn--wgbl6a|xn--y9a3aq|accenture|alfaromeo|allfinanz|amsterdam|analytics|aquarelle|barcelona|bloomberg|christmas|community|directory|education|equipment|fairwinds|financial|firestone|fresenius|frontdoor|fujixerox|furniture|goldpoint|hisamitsu|homedepot|homegoods|homesense|honeywell|institute|insurance|kuokgroup|ladbrokes|lancaster|landrover|lifestyle|marketing|marshalls|melbourne|microsoft|panasonic|passagens|pramerica|richardli|scjohnson|shangrila|solutions|statebank|statefarm|stockholm|travelers|vacations|xn--90ais|xn--c1avg|xn--d1alf|xn--e1a4c|xn--fhbei|xn--j1aef|xn--j1amh|xn--l1acc|xn--ngbrx|xn--nqv7f|xn--p1acf|xn--tckwe|xn--vhquv|yodobashi|abudhabi|airforce|allstate|attorney|barclays|barefoot|bargains|baseball|boutique|bradesco|broadway|brussels|budapest|builders|business|capetown|catering|catholic|chrysler|cipriani|cityeats|cleaning|clinique|clothing|commbank|computer|delivery|deloitte|democrat|diamonds|discount|discover|download|engineer|ericsson|esurance|etisalat|everbank|exchange|feedback|fidelity|firmdale|football|frontier|goodyear|grainger|graphics|guardian|hdfcbank|helsinki|holdings|hospital|infiniti|ipiranga|istanbul|jpmorgan|lighting|lundbeck|marriott|maserati|mckinsey|memorial|merckmsd|mortgage|movistar|observer|partners|pharmacy|pictures|plumbing|property|redstone|reliance|saarland|samsclub|security|services|shopping|showtime|softbank|software|stcgroup|supplies|symantec|training|uconnect|vanguard|ventures|verisign|woodside|xn--90ae|xn--node|xn--p1ai|xn--qxam|yokohama|السعودية|abogado|academy|agakhan|alibaba|android|athleta|auction|audible|auspost|avianca|banamex|bauhaus|bentley|bestbuy|booking|brother|bugatti|capital|caravan|careers|cartier|channel|charity|chintai|citadel|clubmed|college|cologne|comcast|company|compare|contact|cooking|corsica|country|coupons|courses|cricket|cruises|dentist|digital|domains|exposed|express|farmers|fashion|ferrari|ferrero|finance|fishing|fitness|flights|florist|flowers|forsale|frogans|fujitsu|gallery|genting|godaddy|grocery|guitars|hamburg|hangout|hitachi|holiday|hosting|hoteles|hotmail|hyundai|iselect|ismaili|jewelry|juniper|kitchen|komatsu|lacaixa|lancome|lanxess|lasalle|latrobe|leclerc|liaison|limited|lincoln|markets|metlife|monster|netbank|netflix|network|neustar|okinawa|oldnavy|organic|origins|philips|pioneer|politie|realtor|recipes|rentals|reviews|rexroth|samsung|sandvik|schmidt|schwarz|science|shiksha|shriram|singles|staples|starhub|storage|support|surgery|systems|temasek|theater|theatre|tickets|tiffany|toshiba|trading|walmart|wanggou|watches|weather|website|wedding|whoswho|windows|winners|xfinity|yamaxun|youtube|zuerich|католик|اتصالات|الجزائر|العليان|پاکستان|كاثوليك|موبايلي|இந்தியா|abarth|abbott|abbvie|active|africa|agency|airbus|airtel|alipay|alsace|alstom|anquan|aramco|author|bayern|beauty|berlin|bharti|blanco|bostik|boston|broker|camera|career|caseih|casino|center|chanel|chrome|church|circle|claims|clinic|coffee|comsec|condos|coupon|credit|cruise|dating|datsun|dealer|degree|dental|design|direct|doctor|dunlop|dupont|durban|emerck|energy|estate|events|expert|family|flickr|futbol|gallup|garden|george|giving|global|google|gratis|health|hermes|hiphop|hockey|hotels|hughes|imamat|insure|intuit|jaguar|joburg|juegos|kaufen|kinder|kindle|kosher|lancia|latino|lawyer|lefrak|living|locker|london|luxury|madrid|maison|makeup|market|mattel|mobile|mobily|monash|mormon|moscow|museum|mutual|nagoya|natura|nissan|nissay|norton|nowruz|office|olayan|online|oracle|orange|otsuka|pfizer|photos|physio|piaget|pictet|quebec|racing|realty|reisen|repair|report|review|rocher|rogers|ryukyu|safety|sakura|sanofi|school|schule|search|secure|select|shouji|soccer|social|stream|studio|supply|suzuki|swatch|sydney|taipei|taobao|target|tattoo|tennis|tienda|tjmaxx|tkmaxx|toyota|travel|unicom|viajes|viking|villas|virgin|vision|voting|voyage|vuelos|walter|warman|webcam|xihuan|yachts|yandex|zappos|москва|онлайн|ابوظبي|ارامكو|الاردن|المغرب|امارات|فلسطين|مليسيا|भारतम्|இலங்கை|ファッション|actor|adult|aetna|amfam|amica|apple|archi|audio|autos|azure|baidu|beats|bible|bingo|black|boats|bosch|build|canon|cards|chase|cheap|cisco|citic|click|cloud|coach|codes|crown|cymru|dabur|dance|deals|delta|dodge|drive|dubai|earth|edeka|email|epost|epson|faith|fedex|final|forex|forum|gallo|games|gifts|gives|glade|glass|globo|gmail|green|gripe|group|gucci|guide|homes|honda|horse|house|hyatt|ikano|intel|irish|iveco|jetzt|koeln|kyoto|lamer|lease|legal|lexus|lilly|linde|lipsy|lixil|loans|locus|lotte|lotto|lupin|macys|mango|media|miami|money|mopar|movie|nadex|nexus|nikon|ninja|nokia|nowtv|omega|osaka|paris|parts|party|phone|photo|pizza|place|poker|praxi|press|prime|promo|quest|radio|rehab|reise|ricoh|rocks|rodeo|rugby|salon|sener|seven|sharp|shell|shoes|skype|sling|smart|smile|solar|space|sport|stada|store|study|style|sucks|swiss|tatar|tires|tirol|tmall|today|tokyo|tools|toray|total|tours|trade|trust|tunes|tushu|ubank|vegas|video|vodka|volvo|wales|watch|weber|weibo|works|world|xerox|yahoo|zippo|ایران|بازار|بھارت|سودان|سورية|همراه|भारोत|संगठन|বাংলা|భారత్|ഭാരതം|嘉里大酒店|aarp|able|adac|aero|aigo|akdn|ally|amex|arab|army|arpa|arte|asda|asia|audi|auto|baby|band|bank|bbva|beer|best|bike|bing|blog|blue|bofa|bond|book|buzz|cafe|call|camp|care|cars|casa|case|cash|cbre|cern|chat|citi|city|club|cool|coop|cyou|data|date|dclk|deal|dell|desi|diet|dish|docs|doha|duck|duns|dvag|erni|fage|fail|fans|farm|fast|fiat|fido|film|fire|fish|flir|food|ford|free|fund|game|gbiz|gent|ggee|gift|gmbh|gold|golf|goog|guge|guru|hair|haus|hdfc|help|here|hgtv|host|hsbc|icbc|ieee|imdb|immo|info|itau|java|jeep|jobs|jprs|kddi|kiwi|kpmg|kred|land|lego|lgbt|lidl|life|like|limo|link|live|loan|loft|love|ltda|luxe|maif|meet|meme|menu|mini|mint|mobi|moda|moto|name|navy|news|next|nico|nike|ollo|open|page|pars|pccw|pics|ping|pink|play|plus|pohl|porn|post|prod|prof|qpon|raid|read|reit|rent|rest|rich|rmit|room|rsvp|ruhr|safe|sale|sarl|save|saxo|scor|scot|seat|seek|sexy|shaw|shia|shop|show|silk|sina|site|skin|sncf|sohu|song|sony|spot|star|surf|talk|taxi|team|tech|teva|tiaa|tips|town|toys|tube|vana|visa|viva|vivo|vote|voto|wang|weir|wien|wiki|wine|work|xbox|yoga|zara|zero|zone|дети|сайт|بارت|بيتك|ڀارت|تونس|شبكة|عراق|عمان|موقع|भारत|ভারত|ভাৰত|ਭਾਰਤ|ભારત|ଭାରତ|ಭಾರತ|ලංකා|グーグル|クラウド|ポイント|大众汽车|组织机构|電訊盈科|香格里拉|aaa|abb|abc|aco|ads|aeg|afl|aig|anz|aol|app|art|aws|axa|bar|bbc|bbt|bcg|bcn|bet|bid|bio|biz|bms|bmw|bnl|bom|boo|bot|box|buy|bzh|cab|cal|cam|car|cat|cba|cbn|cbs|ceb|ceo|cfa|cfd|com|crs|csc|dad|day|dds|dev|dhl|diy|dnp|dog|dot|dtv|dvr|eat|eco|edu|esq|eus|fan|fit|fly|foo|fox|frl|ftr|fun|fyi|gal|gap|gdn|gea|gle|gmo|gmx|goo|gop|got|gov|hbo|hiv|hkt|hot|how|ibm|ice|icu|ifm|inc|ing|ink|int|ist|itv|jcb|jcp|jio|jll|jmp|jnj|jot|joy|kfh|kia|kim|kpn|krd|lat|law|lds|llc|lol|lpl|ltd|man|map|mba|med|men|mil|mit|mlb|mls|mma|moe|moi|mom|mov|msd|mtn|mtr|nab|nba|nec|net|new|nfl|ngo|nhk|now|nra|nrw|ntt|nyc|obi|off|one|ong|onl|ooo|org|ott|ovh|pay|pet|phd|pid|pin|pnc|pro|pru|pub|pwc|qvc|red|ren|ril|rio|rip|run|rwe|sap|sas|sbi|sbs|sca|scb|ses|sew|sex|sfr|ski|sky|soy|srl|srt|stc|tab|tax|tci|tdk|tel|thd|tjx|top|trv|tui|tvs|ubs|uno|uol|ups|vet|vig|vin|vip|wed|win|wme|wow|wtc|wtf|xin|xxx|xyz|you|yun|zip|бел|ком|қаз|мкд|мон|орг|рус|срб|укр|հայ|קום|عرب|قطر|كوم|مصر|कॉम|नेट|คอม|ไทย|ストア|セール|みんな|中文网|天主教|我爱你|新加坡|淡马锡|诺基亚|飞利浦|ac|ad|ae|af|ag|ai|al|am|ao|aq|ar|as|at|au|aw|ax|az|ba|bb|bd|be|bf|bg|bh|bi|bj|bm|bn|bo|br|bs|bt|bv|bw|by|bz|ca|cc|cd|cf|cg|ch|ci|ck|cl|cm|cn|co|cr|cu|cv|cw|cx|cy|cz|de|dj|dk|dm|do|dz|ec|ee|eg|er|es|et|eu|fi|fj|fk|fm|fo|fr|ga|gb|gd|ge|gf|gg|gh|gi|gl|gm|gn|gp|gq|gr|gs|gt|gu|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|io|iq|ir|is|it|je|jm|jo|jp|ke|kg|kh|ki|km|kn|kp|kr|kw|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|me|mg|mh|mk|ml|mm|mn|mo|mp|mq|mr|ms|mt|mu|mv|mw|mx|my|mz|na|nc|ne|nf|ng|ni|nl|no|np|nr|nu|nz|om|pa|pe|pf|pg|ph|pk|pl|pm|pn|pr|ps|pt|pw|py|qa|re|ro|rs|ru|rw|sa|sb|sc|sd|se|sg|sh|si|sj|sk|sl|sm|sn|so|sr|st|su|sv|sx|sy|sz|tc|td|tf|tg|th|tj|tk|tl|tm|tn|to|tr|tt|tv|tw|tz|ua|ug|uk|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|ye|yt|za|zm|zw|ελ|бг|ею|рф|გე|닷넷|닷컴|삼성|한국|コム|世界|中信|中国|中國|企业|佛山|信息|健康|八卦|公司|公益|台湾|台灣|商城|商店|商标|嘉里|在线|大拿|娱乐|家電|工行|广东|微博|慈善|手机|手表|招聘|政务|政府|新闻|时尚|書籍|机构|游戏|澳門|点看|珠宝|移动|网址|网店|网站|网络|联通|谷歌|购物|通販|集团|食品|餐厅|香港)/,EmailMatcher=function(_super){function EmailMatcher(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.localPartCharRegex=new RegExp("["+alphaNumericAndMarksCharsStr+"!#$%&'*+/=?^_`{|}~-]"),_this.strictTldRegex=new RegExp("^"+tldRegex.source+"$"),_this}return __extends(EmailMatcher,_super),EmailMatcher.prototype.parseMatches=function(text){for(var tagBuilder=this.tagBuilder,localPartCharRegex=this.localPartCharRegex,strictTldRegex=this.strictTldRegex,matches=[],len=text.length,noCurrentEmailMatch=new CurrentEmailMatch,mailtoTransitions={m:"a",a:"i",i:"l",l:"t",t:"o",o:":"},charIdx=0,state=0,currentEmailMatch=noCurrentEmailMatch;charIdx<len;){var char=text.charAt(charIdx);switch(state){case 0:stateNonEmailAddress(char);break;case 1:stateMailTo(text.charAt(charIdx-1),char);break;case 2:stateLocalPart(char);break;case 3:stateLocalPartDot(char);break;case 4:stateAtSign(char);break;case 5:stateDomainChar(char);break;case 6:stateDomainHyphen(char);break;case 7:stateDomainDot(char);break;default:throwUnhandledCaseError(state)}charIdx++}return captureMatchIfValidAndReset(),matches;function stateNonEmailAddress(char){"m"===char?beginEmailMatch(1):localPartCharRegex.test(char)&&beginEmailMatch()}function stateMailTo(prevChar,char){":"===prevChar?localPartCharRegex.test(char)?(state=2,currentEmailMatch=new CurrentEmailMatch(__assign({},currentEmailMatch,{hasMailtoPrefix:!0}))):resetToNonEmailMatchState():mailtoTransitions[prevChar]===char||(localPartCharRegex.test(char)?state=2:"."===char?state=3:"@"===char?state=4:resetToNonEmailMatchState())}function stateLocalPart(char){"."===char?state=3:"@"===char?state=4:localPartCharRegex.test(char)||resetToNonEmailMatchState()}function stateLocalPartDot(char){"."===char?resetToNonEmailMatchState():"@"===char?resetToNonEmailMatchState():localPartCharRegex.test(char)?state=2:resetToNonEmailMatchState()}function stateAtSign(char){domainNameCharRegex.test(char)?state=5:resetToNonEmailMatchState()}function stateDomainChar(char){"."===char?state=7:"-"===char?state=6:domainNameCharRegex.test(char)||captureMatchIfValidAndReset()}function stateDomainHyphen(char){"-"===char||"."===char?captureMatchIfValidAndReset():domainNameCharRegex.test(char)?state=5:captureMatchIfValidAndReset()}function stateDomainDot(char){"."===char||"-"===char?captureMatchIfValidAndReset():domainNameCharRegex.test(char)?(state=5,currentEmailMatch=new CurrentEmailMatch(__assign({},currentEmailMatch,{hasDomainDot:!0}))):captureMatchIfValidAndReset()}function beginEmailMatch(newState){void 0===newState&&(newState=2),state=newState,currentEmailMatch=new CurrentEmailMatch({idx:charIdx})}function resetToNonEmailMatchState(){state=0,currentEmailMatch=noCurrentEmailMatch}function captureMatchIfValidAndReset(){if(currentEmailMatch.hasDomainDot){var matchedText=text.slice(currentEmailMatch.idx,charIdx);/[-.]$/.test(matchedText)&&(matchedText=matchedText.slice(0,-1));var emailAddress=currentEmailMatch.hasMailtoPrefix?matchedText.slice("mailto:".length):matchedText;(function(emailAddress){var emailAddressNormalized=(emailAddress.split(".").pop()||"").toLowerCase();return strictTldRegex.test(emailAddressNormalized)})(emailAddress)&&matches.push(new EmailMatch({tagBuilder:tagBuilder,matchedText:matchedText,offset:currentEmailMatch.idx,email:emailAddress}))}resetToNonEmailMatchState()}},EmailMatcher}(Matcher),CurrentEmailMatch=function(){return function(cfg){void 0===cfg&&(cfg={}),this.idx=void 0!==cfg.idx?cfg.idx:-1,this.hasMailtoPrefix=!!cfg.hasMailtoPrefix,this.hasDomainDot=!!cfg.hasDomainDot}}(),UrlMatchValidator=function(){function UrlMatchValidator(){}return UrlMatchValidator.isValid=function(urlMatch,protocolUrlMatch){return!(protocolUrlMatch&&!this.isValidUriScheme(protocolUrlMatch)||this.urlMatchDoesNotHaveProtocolOrDot(urlMatch,protocolUrlMatch)||this.urlMatchDoesNotHaveAtLeastOneWordChar(urlMatch,protocolUrlMatch)&&!this.isValidIpAddress(urlMatch)||this.containsMultipleDots(urlMatch))},UrlMatchValidator.isValidIpAddress=function(uriSchemeMatch){var newRegex=new RegExp(this.hasFullProtocolRegex.source+this.ipRegex.source);return null!==uriSchemeMatch.match(newRegex)},UrlMatchValidator.containsMultipleDots=function(urlMatch){var stringBeforeSlash=urlMatch;return this.hasFullProtocolRegex.test(urlMatch)&&(stringBeforeSlash=urlMatch.split("://")[1]),stringBeforeSlash.split("/")[0].indexOf("..")>-1},UrlMatchValidator.isValidUriScheme=function(uriSchemeMatch){var uriSchemeMatchArr=uriSchemeMatch.match(this.uriSchemeRegex),uriScheme=uriSchemeMatchArr&&uriSchemeMatchArr[0].toLowerCase();return"javascript:"!==uriScheme&&"vbscript:"!==uriScheme},UrlMatchValidator.urlMatchDoesNotHaveProtocolOrDot=function(urlMatch,protocolUrlMatch){return!(!urlMatch||protocolUrlMatch&&this.hasFullProtocolRegex.test(protocolUrlMatch)||-1!==urlMatch.indexOf("."))},UrlMatchValidator.urlMatchDoesNotHaveAtLeastOneWordChar=function(urlMatch,protocolUrlMatch){return!(!urlMatch||!protocolUrlMatch)&&!this.hasWordCharAfterProtocolRegex.test(urlMatch)},UrlMatchValidator.hasFullProtocolRegex=/^[A-Za-z][-.+A-Za-z0-9]*:\/\//,UrlMatchValidator.uriSchemeRegex=/^[A-Za-z][-.+A-Za-z0-9]*:/,UrlMatchValidator.hasWordCharAfterProtocolRegex=new RegExp(":[^\\s]*?["+alphaCharsStr+"]"),UrlMatchValidator.ipRegex=/[0-9][0-9]?[0-9]?\.[0-9][0-9]?[0-9]?\.[0-9][0-9]?[0-9]?\.[0-9][0-9]?[0-9]?(:[0-9]*)?\/?$/,UrlMatchValidator}(),UrlMatcher=function(_super){function UrlMatcher(cfg){var urlSuffixRegex,_this=_super.call(this,cfg)||this;return _this.stripPrefix={scheme:!0,www:!0},_this.stripTrailingSlash=!0,_this.decodePercentEncoding=!0,_this.matcherRegex=(urlSuffixRegex=new RegExp("[/?#](?:["+alphaNumericAndMarksCharsStr+"\\-+&@#/%=~_()|'$*\\[\\]?!:,.;✓]*["+alphaNumericAndMarksCharsStr+"\\-+&@#/%=~_()|'$*\\[\\]✓])?"),new RegExp(["(?:","(",/(?:[A-Za-z][-.+A-Za-z0-9]{0,63}:(?![A-Za-z][-.+A-Za-z0-9]{0,63}:\/\/)(?!\d+\/?)(?:\/\/)?)/.source,getDomainNameStr(2),")","|","(","(//)?",/(?:www\.)/.source,getDomainNameStr(6),")","|","(","(//)?",getDomainNameStr(10)+"\\.",tldRegex.source,"(?![-"+alphaNumericCharsStr+"])",")",")","(?::[0-9]+)?","(?:"+urlSuffixRegex.source+")?"].join(""),"gi")),_this.wordCharRegExp=new RegExp("["+alphaNumericAndMarksCharsStr+"]"),_this.stripPrefix=cfg.stripPrefix,_this.stripTrailingSlash=cfg.stripTrailingSlash,_this.decodePercentEncoding=cfg.decodePercentEncoding,_this}return __extends(UrlMatcher,_super),UrlMatcher.prototype.parseMatches=function(text){for(var match,matcherRegex=this.matcherRegex,stripPrefix=this.stripPrefix,stripTrailingSlash=this.stripTrailingSlash,decodePercentEncoding=this.decodePercentEncoding,tagBuilder=this.tagBuilder,matches=[],_loop_1=function(){var matchStr=match[0],schemeUrlMatch=match[1],wwwUrlMatch=match[4],wwwProtocolRelativeMatch=match[5],tldProtocolRelativeMatch=match[9],offset=match.index,protocolRelativeMatch=wwwProtocolRelativeMatch||tldProtocolRelativeMatch,prevChar=text.charAt(offset-1);if(!UrlMatchValidator.isValid(matchStr,schemeUrlMatch))return"continue";if(offset>0&&"@"===prevChar)return"continue";if(offset>0&&protocolRelativeMatch&&this_1.wordCharRegExp.test(prevChar))return"continue";if(/\?$/.test(matchStr)&&(matchStr=matchStr.substr(0,matchStr.length-1)),this_1.matchHasUnbalancedClosingParen(matchStr))matchStr=matchStr.substr(0,matchStr.length-1);else{var pos=this_1.matchHasInvalidCharAfterTld(matchStr,schemeUrlMatch);pos>-1&&(matchStr=matchStr.substr(0,pos))}var foundCommonScheme=["http://","https://"].find(function(commonScheme){return!!schemeUrlMatch&&-1!==schemeUrlMatch.indexOf(commonScheme)});if(foundCommonScheme){var indexOfSchemeStart=matchStr.indexOf(foundCommonScheme);matchStr=matchStr.substr(indexOfSchemeStart),schemeUrlMatch=schemeUrlMatch.substr(indexOfSchemeStart),offset+=indexOfSchemeStart}var urlMatchType=schemeUrlMatch?"scheme":wwwUrlMatch?"www":"tld",protocolUrlMatch=!!schemeUrlMatch;matches.push(new UrlMatch({tagBuilder:tagBuilder,matchedText:matchStr,offset:offset,urlMatchType:urlMatchType,url:matchStr,protocolUrlMatch:protocolUrlMatch,protocolRelativeMatch:!!protocolRelativeMatch,stripPrefix:stripPrefix,stripTrailingSlash:stripTrailingSlash,decodePercentEncoding:decodePercentEncoding}))},this_1=this;null!==(match=matcherRegex.exec(text));)_loop_1();return matches},UrlMatcher.prototype.matchHasUnbalancedClosingParen=function(matchStr){var startChar,endChar=matchStr.charAt(matchStr.length-1);if(")"===endChar)startChar="(";else{if("]"!==endChar)return!1;startChar="["}for(var numOpenBraces=0,i=0,len=matchStr.length-1;i<len;i++){var char=matchStr.charAt(i);char===startChar?numOpenBraces++:char===endChar&&(numOpenBraces=Math.max(numOpenBraces-1,0))}return 0===numOpenBraces},UrlMatcher.prototype.matchHasInvalidCharAfterTld=function(urlMatch,schemeUrlMatch){if(!urlMatch)return-1;var offset=0;schemeUrlMatch&&(offset=urlMatch.indexOf(":"),urlMatch=urlMatch.slice(offset));var res=new RegExp("^((.?//)?[-."+alphaNumericAndMarksCharsStr+"]*[-"+alphaNumericAndMarksCharsStr+"]\\.[-"+alphaNumericAndMarksCharsStr+"]+)").exec(urlMatch);return null===res?-1:(offset+=res[1].length,urlMatch=urlMatch.slice(res[1].length),/^[^-.A-Za-z0-9:\/?#]/.test(urlMatch)?offset:-1)},UrlMatcher}(Matcher),HashtagMatcher=function(_super){function HashtagMatcher(cfg){var _this=_super.call(this,cfg)||this;return _this.serviceName="twitter",_this.matcherRegex=new RegExp("#[_"+alphaNumericAndMarksCharsStr+"]{1,139}(?![_"+alphaNumericAndMarksCharsStr+"])","g"),_this.nonWordCharRegex=new RegExp("[^"+alphaNumericAndMarksCharsStr+"]"),_this.serviceName=cfg.serviceName,_this}return __extends(HashtagMatcher,_super),HashtagMatcher.prototype.parseMatches=function(text){for(var match,matcherRegex=this.matcherRegex,nonWordCharRegex=this.nonWordCharRegex,serviceName=this.serviceName,tagBuilder=this.tagBuilder,matches=[];null!==(match=matcherRegex.exec(text));){var offset=match.index,prevChar=text.charAt(offset-1);if(0===offset||nonWordCharRegex.test(prevChar)){var matchedText=match[0],hashtag=match[0].slice(1);matches.push(new HashtagMatch({tagBuilder:tagBuilder,matchedText:matchedText,offset:offset,serviceName:serviceName,hashtag:hashtag}))}}return matches},HashtagMatcher}(Matcher),PhoneMatcher=function(_super){function PhoneMatcher(){var _this=null!==_super&&_super.apply(this,arguments)||this;return _this.matcherRegex=/(?:(?:(?:(\+)?\d{1,3}[-\040.]?)?\(?\d{3}\)?[-\040.]?\d{3}[-\040.]?\d{4})|(?:(\+)(?:9[976]\d|8[987530]\d|6[987]\d|5[90]\d|42\d|3[875]\d|2[98654321]\d|9[8543210]|8[6421]|6[6543210]|5[87654321]|4[987654310]|3[9643210]|2[70]|7|1)[-\040.]?(?:\d[-\040.]?){6,12}\d+))([,;]+[0-9]+#?)*/g,_this}return __extends(PhoneMatcher,_super),PhoneMatcher.prototype.parseMatches=function(text){for(var match,matcherRegex=this.matcherRegex,tagBuilder=this.tagBuilder,matches=[];null!==(match=matcherRegex.exec(text));){var matchedText=match[0],cleanNumber=matchedText.replace(/[^0-9,;#]/g,""),plusSign=!(!match[1]&&!match[2]),before=0==match.index?"":text.substr(match.index-1,1),after=text.substr(match.index+matchedText.length,1),contextClear=!before.match(/\d/)&&!after.match(/\d/);this.testMatch(match[3])&&this.testMatch(matchedText)&&contextClear&&matches.push(new PhoneMatch({tagBuilder:tagBuilder,matchedText:matchedText,offset:match.index,number:cleanNumber,plusSign:plusSign}))}return matches},PhoneMatcher.prototype.testMatch=function(text){return/\D/.test(text)},PhoneMatcher}(Matcher),MentionMatcher=function(_super){function MentionMatcher(cfg){var _this=_super.call(this,cfg)||this;return _this.serviceName="twitter",_this.matcherRegexes={twitter:new RegExp("@[_"+alphaNumericAndMarksCharsStr+"]{1,50}(?![_"+alphaNumericAndMarksCharsStr+"])","g"),instagram:new RegExp("@[_."+alphaNumericAndMarksCharsStr+"]{1,30}(?![_"+alphaNumericAndMarksCharsStr+"])","g"),soundcloud:new RegExp("@[-_."+alphaNumericAndMarksCharsStr+"]{1,50}(?![-_"+alphaNumericAndMarksCharsStr+"])","g")},_this.nonWordCharRegex=new RegExp("[^"+alphaNumericAndMarksCharsStr+"]"),_this.serviceName=cfg.serviceName,_this}return __extends(MentionMatcher,_super),MentionMatcher.prototype.parseMatches=function(text){var match,serviceName=this.serviceName,matcherRegex=this.matcherRegexes[this.serviceName],nonWordCharRegex=this.nonWordCharRegex,tagBuilder=this.tagBuilder,matches=[];if(!matcherRegex)return matches;for(;null!==(match=matcherRegex.exec(text));){var offset=match.index,prevChar=text.charAt(offset-1);if(0===offset||nonWordCharRegex.test(prevChar)){var matchedText=match[0].replace(/\.+$/g,""),mention=matchedText.slice(1);matches.push(new MentionMatch({tagBuilder:tagBuilder,matchedText:matchedText,offset:offset,serviceName:serviceName,mention:mention}))}}return matches},MentionMatcher}(Matcher);function parseHtml(html,_a){for(var text,onOpenTag=_a.onOpenTag,onCloseTag=_a.onCloseTag,onText=_a.onText,onComment=_a.onComment,onDoctype=_a.onDoctype,noCurrentTag=new CurrentTag,charIdx=0,len=html.length,state=0,currentDataIdx=0,currentTag=noCurrentTag;charIdx<len;){var char=html.charAt(charIdx);switch(state){case 0:stateData(char);break;case 1:stateTagOpen(char);break;case 2:stateEndTagOpen(char);break;case 3:stateTagName(char);break;case 4:stateBeforeAttributeName(char);break;case 5:stateAttributeName(char);break;case 6:stateAfterAttributeName(char);break;case 7:stateBeforeAttributeValue(char);break;case 8:stateAttributeValueDoubleQuoted(char);break;case 9:stateAttributeValueSingleQuoted(char);break;case 10:stateAttributeValueUnquoted(char);break;case 11:stateAfterAttributeValueQuoted(char);break;case 12:stateSelfClosingStartTag(char);break;case 13:stateMarkupDeclarationOpen(char);break;case 14:stateCommentStart(char);break;case 15:stateCommentStartDash(char);break;case 16:stateComment(char);break;case 17:stateCommentEndDash(char);break;case 18:stateCommentEnd(char);break;case 19:stateCommentEndBang(char);break;case 20:stateDoctype(char);break;default:throwUnhandledCaseError(state)}charIdx++}function stateData(char){"<"===char&&startNewTag()}function stateTagOpen(char){"!"===char?state=13:"/"===char?(state=2,currentTag=new CurrentTag(__assign({},currentTag,{isClosing:!0}))):"<"===char?startNewTag():letterRe.test(char)?(state=3,currentTag=new CurrentTag(__assign({},currentTag,{isOpening:!0}))):(state=0,currentTag=noCurrentTag)}function stateTagName(char){whitespaceRe.test(char)?(currentTag=new CurrentTag(__assign({},currentTag,{name:captureTagName()})),state=4):"<"===char?startNewTag():"/"===char?(currentTag=new CurrentTag(__assign({},currentTag,{name:captureTagName()})),state=12):">"===char?(currentTag=new CurrentTag(__assign({},currentTag,{name:captureTagName()})),emitTagAndPreviousTextNode()):letterRe.test(char)||digitRe.test(char)||":"===char||resetToDataState()}function stateEndTagOpen(char){">"===char?resetToDataState():letterRe.test(char)?state=3:resetToDataState()}function stateBeforeAttributeName(char){whitespaceRe.test(char)||("/"===char?state=12:">"===char?emitTagAndPreviousTextNode():"<"===char?startNewTag():"="===char||quoteRe.test(char)||controlCharsRe.test(char)?resetToDataState():state=5)}function stateAttributeName(char){whitespaceRe.test(char)?state=6:"/"===char?state=12:"="===char?state=7:">"===char?emitTagAndPreviousTextNode():"<"===char?startNewTag():quoteRe.test(char)&&resetToDataState()}function stateAfterAttributeName(char){whitespaceRe.test(char)||("/"===char?state=12:"="===char?state=7:">"===char?emitTagAndPreviousTextNode():"<"===char?startNewTag():quoteRe.test(char)?resetToDataState():state=5)}function stateBeforeAttributeValue(char){whitespaceRe.test(char)||('"'===char?state=8:"'"===char?state=9:/[>=`]/.test(char)?resetToDataState():"<"===char?startNewTag():state=10)}function stateAttributeValueDoubleQuoted(char){'"'===char&&(state=11)}function stateAttributeValueSingleQuoted(char){"'"===char&&(state=11)}function stateAttributeValueUnquoted(char){whitespaceRe.test(char)?state=4:">"===char?emitTagAndPreviousTextNode():"<"===char&&startNewTag()}function stateAfterAttributeValueQuoted(char){whitespaceRe.test(char)?state=4:"/"===char?state=12:">"===char?emitTagAndPreviousTextNode():"<"===char?startNewTag():(state=4,charIdx--)}function stateSelfClosingStartTag(char){">"===char?(currentTag=new CurrentTag(__assign({},currentTag,{isClosing:!0})),emitTagAndPreviousTextNode()):state=4}function stateMarkupDeclarationOpen(char){"--"===html.substr(charIdx,2)?(charIdx+=2,currentTag=new CurrentTag(__assign({},currentTag,{type:"comment"})),state=14):"DOCTYPE"===html.substr(charIdx,7).toUpperCase()?(charIdx+=7,currentTag=new CurrentTag(__assign({},currentTag,{type:"doctype"})),state=20):resetToDataState()}function stateCommentStart(char){"-"===char?state=15:">"===char?resetToDataState():state=16}function stateCommentStartDash(char){"-"===char?state=18:">"===char?resetToDataState():state=16}function stateComment(char){"-"===char&&(state=17)}function stateCommentEndDash(char){state="-"===char?18:16}function stateCommentEnd(char){">"===char?emitTagAndPreviousTextNode():"!"===char?state=19:"-"===char||(state=16)}function stateCommentEndBang(char){"-"===char?state=17:">"===char?emitTagAndPreviousTextNode():state=16}function stateDoctype(char){">"===char?emitTagAndPreviousTextNode():"<"===char&&startNewTag()}function resetToDataState(){state=0,currentTag=noCurrentTag}function startNewTag(){state=1,currentTag=new CurrentTag({idx:charIdx})}function emitTagAndPreviousTextNode(){var textBeforeTag=html.slice(currentDataIdx,currentTag.idx);textBeforeTag&&onText(textBeforeTag,currentDataIdx),"comment"===currentTag.type?onComment(currentTag.idx):"doctype"===currentTag.type?onDoctype(currentTag.idx):(currentTag.isOpening&&onOpenTag(currentTag.name,currentTag.idx),currentTag.isClosing&&onCloseTag(currentTag.name,currentTag.idx)),resetToDataState(),currentDataIdx=charIdx+1}function captureTagName(){var startIdx=currentTag.idx+(currentTag.isClosing?2:1);return html.slice(startIdx,charIdx).toLowerCase()}currentDataIdx<charIdx&&(text=html.slice(currentDataIdx,charIdx),onText(text,currentDataIdx),currentDataIdx=charIdx+1)}var CurrentTag=function(){return function(cfg){void 0===cfg&&(cfg={}),this.idx=void 0!==cfg.idx?cfg.idx:-1,this.type=cfg.type||"tag",this.name=cfg.name||"",this.isOpening=!!cfg.isOpening,this.isClosing=!!cfg.isClosing}}();return function(){function Autolinker(cfg){void 0===cfg&&(cfg={}),this.version=Autolinker.version,this.urls={},this.email=!0,this.phone=!0,this.hashtag=!1,this.mention=!1,this.newWindow=!0,this.stripPrefix={scheme:!0,www:!0},this.stripTrailingSlash=!0,this.decodePercentEncoding=!0,this.truncate={length:0,location:"end"},this.className="",this.replaceFn=null,this.context=void 0,this.matchers=null,this.tagBuilder=null,this.urls=this.normalizeUrlsCfg(cfg.urls),this.email="boolean"==typeof cfg.email?cfg.email:this.email,this.phone="boolean"==typeof cfg.phone?cfg.phone:this.phone,this.hashtag=cfg.hashtag||this.hashtag,this.mention=cfg.mention||this.mention,this.newWindow="boolean"==typeof cfg.newWindow?cfg.newWindow:this.newWindow,this.stripPrefix=this.normalizeStripPrefixCfg(cfg.stripPrefix),this.stripTrailingSlash="boolean"==typeof cfg.stripTrailingSlash?cfg.stripTrailingSlash:this.stripTrailingSlash,this.decodePercentEncoding="boolean"==typeof cfg.decodePercentEncoding?cfg.decodePercentEncoding:this.decodePercentEncoding;var mention=this.mention;if(!1!==mention&&"twitter"!==mention&&"instagram"!==mention&&"soundcloud"!==mention)throw new Error("invalid `mention` cfg - see docs");var hashtag=this.hashtag;if(!1!==hashtag&&"twitter"!==hashtag&&"facebook"!==hashtag&&"instagram"!==hashtag)throw new Error("invalid `hashtag` cfg - see docs");this.truncate=this.normalizeTruncateCfg(cfg.truncate),this.className=cfg.className||this.className,this.replaceFn=cfg.replaceFn||this.replaceFn,this.context=cfg.context||this}return Autolinker.link=function(textOrHtml,options){return new Autolinker(options).link(textOrHtml)},Autolinker.parse=function(textOrHtml,options){return new Autolinker(options).parse(textOrHtml)},Autolinker.prototype.normalizeUrlsCfg=function(urls){return null==urls&&(urls=!0),"boolean"==typeof urls?{schemeMatches:urls,wwwMatches:urls,tldMatches:urls}:{schemeMatches:"boolean"!=typeof urls.schemeMatches||urls.schemeMatches,wwwMatches:"boolean"!=typeof urls.wwwMatches||urls.wwwMatches,tldMatches:"boolean"!=typeof urls.tldMatches||urls.tldMatches}},Autolinker.prototype.normalizeStripPrefixCfg=function(stripPrefix){return null==stripPrefix&&(stripPrefix=!0),"boolean"==typeof stripPrefix?{scheme:stripPrefix,www:stripPrefix}:{scheme:"boolean"!=typeof stripPrefix.scheme||stripPrefix.scheme,www:"boolean"!=typeof stripPrefix.www||stripPrefix.www}},Autolinker.prototype.normalizeTruncateCfg=function(truncate){return"number"==typeof truncate?{length:truncate,location:"end"}:function(dest,src){for(var prop in src)src.hasOwnProperty(prop)&&void 0===dest[prop]&&(dest[prop]=src[prop]);return dest}(truncate||{},{length:Number.POSITIVE_INFINITY,location:"end"})},Autolinker.prototype.parse=function(textOrHtml){var _this=this,skipTagNames=["a","style","script"],skipTagsStackCount=0,matches=[];return parseHtml(textOrHtml,{onOpenTag:function(tagName){skipTagNames.indexOf(tagName)>=0&&skipTagsStackCount++},onText:function(text,offset){if(0===skipTagsStackCount){var textSplit=function(str,splitRegex){if(!splitRegex.global)throw new Error("`splitRegex` must have the 'g' flag set");for(var match,result=[],lastIdx=0;match=splitRegex.exec(str);)result.push(str.substring(lastIdx,match.index)),result.push(match[0]),lastIdx=match.index+match[0].length;return result.push(str.substring(lastIdx)),result}(text,/(&nbsp;|&#160;|&lt;|&#60;|&gt;|&#62;|&quot;|&#34;|&#39;)/gi),currentOffset_1=offset;textSplit.forEach(function(splitText,i){if(i%2==0){var textNodeMatches=_this.parseText(splitText,currentOffset_1);matches.push.apply(matches,textNodeMatches)}currentOffset_1+=splitText.length})}},onCloseTag:function(tagName){skipTagNames.indexOf(tagName)>=0&&(skipTagsStackCount=Math.max(skipTagsStackCount-1,0))},onComment:function(offset){},onDoctype:function(offset){}}),matches=this.compactMatches(matches),matches=this.removeUnwantedMatches(matches)},Autolinker.prototype.compactMatches=function(matches){matches.sort(function(a,b){return a.getOffset()-b.getOffset()});for(var i=0;i<matches.length-1;i++){var match=matches[i],offset=match.getOffset(),matchedTextLength=match.getMatchedText().length,endIdx=offset+matchedTextLength;if(i+1<matches.length){if(matches[i+1].getOffset()===offset){var removeIdx=matches[i+1].getMatchedText().length>matchedTextLength?i:i+1;matches.splice(removeIdx,1);continue}matches[i+1].getOffset()<endIdx&&matches.splice(i+1,1)}}return matches},Autolinker.prototype.removeUnwantedMatches=function(matches){return this.hashtag||remove(matches,function(match){return"hashtag"===match.getType()}),this.email||remove(matches,function(match){return"email"===match.getType()}),this.phone||remove(matches,function(match){return"phone"===match.getType()}),this.mention||remove(matches,function(match){return"mention"===match.getType()}),this.urls.schemeMatches||remove(matches,function(m){return"url"===m.getType()&&"scheme"===m.getUrlMatchType()}),this.urls.wwwMatches||remove(matches,function(m){return"url"===m.getType()&&"www"===m.getUrlMatchType()}),this.urls.tldMatches||remove(matches,function(m){return"url"===m.getType()&&"tld"===m.getUrlMatchType()}),matches},Autolinker.prototype.parseText=function(text,offset){void 0===offset&&(offset=0),offset=offset||0;for(var matchers=this.getMatchers(),matches=[],i=0,numMatchers=matchers.length;i<numMatchers;i++){for(var textMatches=matchers[i].parseMatches(text),j=0,numTextMatches=textMatches.length;j<numTextMatches;j++)textMatches[j].setOffset(offset+textMatches[j].getOffset());matches.push.apply(matches,textMatches)}return matches},Autolinker.prototype.link=function(textOrHtml){if(!textOrHtml)return"";for(var matches=this.parse(textOrHtml),newHtml=[],lastIndex=0,i=0,len=matches.length;i<len;i++){var match=matches[i];newHtml.push(textOrHtml.substring(lastIndex,match.getOffset())),newHtml.push(this.createMatchReturnVal(match)),lastIndex=match.getOffset()+match.getMatchedText().length}return newHtml.push(textOrHtml.substring(lastIndex)),newHtml.join("")},Autolinker.prototype.createMatchReturnVal=function(match){var replaceFnResult;return this.replaceFn&&(replaceFnResult=this.replaceFn.call(this.context,match)),"string"==typeof replaceFnResult?replaceFnResult:!1===replaceFnResult?match.getMatchedText():replaceFnResult instanceof HtmlTag?replaceFnResult.toAnchorString():match.buildTag().toAnchorString()},Autolinker.prototype.getMatchers=function(){if(this.matchers)return this.matchers;var tagBuilder=this.getTagBuilder(),matchers=[new HashtagMatcher({tagBuilder:tagBuilder,serviceName:this.hashtag}),new EmailMatcher({tagBuilder:tagBuilder}),new PhoneMatcher({tagBuilder:tagBuilder}),new MentionMatcher({tagBuilder:tagBuilder,serviceName:this.mention}),new UrlMatcher({tagBuilder:tagBuilder,stripPrefix:this.stripPrefix,stripTrailingSlash:this.stripTrailingSlash,decodePercentEncoding:this.decodePercentEncoding})];return this.matchers=matchers},Autolinker.prototype.getTagBuilder=function(){var tagBuilder=this.tagBuilder;return tagBuilder||(tagBuilder=this.tagBuilder=new AnchorTagBuilder({newWindow:this.newWindow,truncate:this.truncate,className:this.className})),tagBuilder},Autolinker.version="3.11.1",Autolinker.AnchorTagBuilder=AnchorTagBuilder,Autolinker.HtmlTag=HtmlTag,Autolinker.matcher={Email:EmailMatcher,Hashtag:HashtagMatcher,Matcher:Matcher,Mention:MentionMatcher,Phone:PhoneMatcher,Url:UrlMatcher},Autolinker.match={Email:EmailMatch,Hashtag:HashtagMatch,Match:Match,Mention:MentionMatch,Phone:PhoneMatch,Url:UrlMatch},Autolinker}()}),System.register("src/misc/Urlifier.js",["../api/common/utils/StringUtils","autolinker"],function(_export,_context){"use strict";var startsWith,Autolinker;return _export("urlify",function(text){return Autolinker.link(text,{stripPrefix:!1,urls:!0,emails:!0,phone:!1,mention:!1,hashtag:!1,replaceFn:function(match){switch(match.getType()){case"url":if(startsWith(match.getMatchedText(),"http")||startsWith(match.getMatchedText(),"www.")){var tag=match.buildTag();return tag.setAttr("target","_blank"),tag.setAttr("rel","noopener noreferrer"),tag}return!1}}})}),{setters:[function(_apiCommonUtilsStringUtils){startsWith=_apiCommonUtilsStringUtils.startsWith},function(_autolinker){Autolinker=_autolinker.default}],execute:function(){}}}),System.register("src/mail/MailViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../gui/size","mithril","mithril/stream/stream.js","../gui/base/Expander","../gui/base/ExpanderN","../api/main/Entity","../gui/base/Button","../misc/Formatter","../misc/WindowFacade","../gui/base/ActionBar","../gui/animation/Easing","../gui/animation/Animations","../native/NativeWrapper","../api/entities/tutanota/MailBody","../api/common/TutanotaConstants","./MailEditor","../api/entities/tutanota/File","../file/FileController","../misc/LanguageViewModel","../api/Env","../misc/HtmlSanitizer","../gui/base/Dialog","../api/common/utils/Utils","../misc/ErrorHandlerImpl","../api/common/utils/ArrayUtils","../api/common/utils/StringUtils","../api/common/WorkerProtocol.js","../api/entities/tutanota/ConversationEntry","./MailUtils","../contacts/ContactEditor","../gui/base/ColumnEmptyMessageBox","../misc/KeyManager","../settings/AddInboxRuleDialog","../settings/AddSpamRuleDialog","../misc/Urlifier","../api/main/LoginController","../gui/base/Icon","../gui/base/icons/Icons","../api/entities/tutanota/MailAddress","../api/entities/tutanota/EncryptedMailAddress","../settings/LoadingUtils","../api/entities/sys/Customer","../api/common/error/RestError","../gui/base/icons/BootIcons","./MailModel","../gui/theme","../contacts/ContactUtils","../api/entities/tutanota/Services","../api/common/EntityFunctions","../api/entities/tutanota/ListUnsubscribeData","../api/entities/tutanota/MailHeaders","./Exporter","../misc/ClientDetector","../gui/base/Dropdown","../gui/base/ProgressDialog","../gui/base/Badge","../api/common/error/FileOpenError","../gui/base/ButtonN","../gui/styles","../api/main/WorkerClient","../gui/base/DropdownN","../misc/RouteChange","../api/entities/sys/EmailSenderListElement","./MailView"],function(_export,_context){"use strict";var _classCallCheck,_createClass,px,size,m,stream,ExpanderButton,ExpanderPanel,ExpanderButtonN,ExpanderPanelN,load,serviceRequestVoid,update,Button,createAsyncDropDownButton,createDropDownButton,formatDateTime,formatDateWithWeekday,formatStorageSize,formatTime,urlEncodeHtmlTags,windowFacade,ActionBar,ease,animations,scroll,nativeApp,MailBodyTypeRef,ConversationType,FeatureType,InboxRuleType,Keys,MailFolderType,MailState,SparmRuleType,SpamRuleType,TabIndex,MailEditor,FileTypeRef,fileController,lang,assertMainOrNode,isAndroidApp,isDesktop,isIOSApp,htmlSanitizer,stringifyFragment,Dialog,defer,getMailBodyText,getMailHeaders,neverNull,noOp,checkApprovalStatus,addAll,contains,startsWith,Request,ConversationEntryTypeRef,createNewContact,getArchiveFolder,getDefaultSender,getDisplayText,getEnabledMailAddresses,getFolderIcon,getFolderName,getMailboxName,getSenderOrRecipientHeading,getSenderOrRecipientHeadingTooltip,getSortedCustomFolders,getSortedSystemFolders,isExcludedMailAddress,isTutanotaTeamMail,replaceCidsWithInlineImages,showDeleteConfirmationDialog,ContactEditor,ColumnEmptyMessageBox,keyManager,AddInboxRuleDialog,createInboxRuleTemplate,AddSpamRuleDialog,urlify,logins,Icon,progressIcon,Icons,createMailAddress,createEncryptedMailAddress,loadGroupInfos,CustomerTypeRef,NotAuthorizedError,NotFoundError,BootIcons,mailModel,theme,LazyContactListId,searchForContactByMailAddress,TutanotaService,getListId,HttpMethod,createListUnsubscribeData,MailHeadersTypeRef,exportAsEml,client,DomRectReadOnlyPolyfilled,showProgressDialog,Badge,FileOpenError,ButtonN,ButtonType,styles,worker,createDropdown,navButtonRoutes,createEmailSenderListElement,isNewMailActionAvailable,MailViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_guiSize){px=_guiSize.px,size=_guiSize.size},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseExpander){ExpanderButton=_guiBaseExpander.ExpanderButton,ExpanderPanel=_guiBaseExpander.ExpanderPanel},function(_guiBaseExpanderN){ExpanderButtonN=_guiBaseExpanderN.ExpanderButtonN,ExpanderPanelN=_guiBaseExpanderN.ExpanderPanelN},function(_apiMainEntity){load=_apiMainEntity.load,serviceRequestVoid=_apiMainEntity.serviceRequestVoid,update=_apiMainEntity.update},function(_guiBaseButton){Button=_guiBaseButton.Button,createAsyncDropDownButton=_guiBaseButton.createAsyncDropDownButton,createDropDownButton=_guiBaseButton.createDropDownButton},function(_miscFormatter){formatDateTime=_miscFormatter.formatDateTime,formatDateWithWeekday=_miscFormatter.formatDateWithWeekday,formatStorageSize=_miscFormatter.formatStorageSize,formatTime=_miscFormatter.formatTime,urlEncodeHtmlTags=_miscFormatter.urlEncodeHtmlTags},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_guiBaseActionBar){ActionBar=_guiBaseActionBar.ActionBar},function(_guiAnimationEasing){ease=_guiAnimationEasing.ease},function(_guiAnimationAnimations){animations=_guiAnimationAnimations.animations,scroll=_guiAnimationAnimations.scroll},function(_nativeNativeWrapper){nativeApp=_nativeNativeWrapper.nativeApp},function(_apiEntitiesTutanotaMailBody){MailBodyTypeRef=_apiEntitiesTutanotaMailBody.MailBodyTypeRef},function(_apiCommonTutanotaConstants){ConversationType=_apiCommonTutanotaConstants.ConversationType,FeatureType=_apiCommonTutanotaConstants.FeatureType,InboxRuleType=_apiCommonTutanotaConstants.InboxRuleType,Keys=_apiCommonTutanotaConstants.Keys,MailFolderType=_apiCommonTutanotaConstants.MailFolderType,MailState=_apiCommonTutanotaConstants.MailState,SparmRuleType=_apiCommonTutanotaConstants.SpamRuleFieldType,SpamRuleType=_apiCommonTutanotaConstants.SpamRuleType,TabIndex=_apiCommonTutanotaConstants.TabIndex},function(_MailEditor){MailEditor=_MailEditor.MailEditor},function(_apiEntitiesTutanotaFile){FileTypeRef=_apiEntitiesTutanotaFile.FileTypeRef},function(_fileFileController){fileController=_fileFileController.fileController},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isAndroidApp=_apiEnv.isAndroidApp,isDesktop=_apiEnv.isDesktop,isIOSApp=_apiEnv.isIOSApp},function(_miscHtmlSanitizer){htmlSanitizer=_miscHtmlSanitizer.htmlSanitizer,stringifyFragment=_miscHtmlSanitizer.stringifyFragment},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiCommonUtilsUtils){defer=_apiCommonUtilsUtils.defer,getMailBodyText=_apiCommonUtilsUtils.getMailBodyText,getMailHeaders=_apiCommonUtilsUtils.getMailHeaders,neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_miscErrorHandlerImpl){checkApprovalStatus=_miscErrorHandlerImpl.checkApprovalStatus},function(_apiCommonUtilsArrayUtils){addAll=_apiCommonUtilsArrayUtils.addAll,contains=_apiCommonUtilsArrayUtils.contains},function(_apiCommonUtilsStringUtils){startsWith=_apiCommonUtilsStringUtils.startsWith},function(_apiCommonWorkerProtocolJs){Request=_apiCommonWorkerProtocolJs.Request},function(_apiEntitiesTutanotaConversationEntry){ConversationEntryTypeRef=_apiEntitiesTutanotaConversationEntry.ConversationEntryTypeRef},function(_MailUtils){createNewContact=_MailUtils.createNewContact,getArchiveFolder=_MailUtils.getArchiveFolder,getDefaultSender=_MailUtils.getDefaultSender,getDisplayText=_MailUtils.getDisplayText,getEnabledMailAddresses=_MailUtils.getEnabledMailAddresses,getFolderIcon=_MailUtils.getFolderIcon,getFolderName=_MailUtils.getFolderName,getMailboxName=_MailUtils.getMailboxName,getSenderOrRecipientHeading=_MailUtils.getSenderOrRecipientHeading,getSenderOrRecipientHeadingTooltip=_MailUtils.getSenderOrRecipientHeadingTooltip,getSortedCustomFolders=_MailUtils.getSortedCustomFolders,getSortedSystemFolders=_MailUtils.getSortedSystemFolders,isExcludedMailAddress=_MailUtils.isExcludedMailAddress,isTutanotaTeamMail=_MailUtils.isTutanotaTeamMail,replaceCidsWithInlineImages=_MailUtils.replaceCidsWithInlineImages,showDeleteConfirmationDialog=_MailUtils.showDeleteConfirmationDialog},function(_contactsContactEditor){ContactEditor=_contactsContactEditor.ContactEditor},function(_guiBaseColumnEmptyMessageBox){ColumnEmptyMessageBox=_guiBaseColumnEmptyMessageBox.default},function(_miscKeyManager){keyManager=_miscKeyManager.keyManager},function(_settingsAddInboxRuleDialog){AddInboxRuleDialog=_settingsAddInboxRuleDialog,createInboxRuleTemplate=_settingsAddInboxRuleDialog.createInboxRuleTemplate},function(_settingsAddSpamRuleDialog){AddSpamRuleDialog=_settingsAddSpamRuleDialog},function(_miscUrlifier){urlify=_miscUrlifier.urlify},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon,progressIcon=_guiBaseIcon.progressIcon},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiEntitiesTutanotaMailAddress){createMailAddress=_apiEntitiesTutanotaMailAddress.createMailAddress},function(_apiEntitiesTutanotaEncryptedMailAddress){createEncryptedMailAddress=_apiEntitiesTutanotaEncryptedMailAddress.createEncryptedMailAddress},function(_settingsLoadingUtils){loadGroupInfos=_settingsLoadingUtils.loadGroupInfos},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiCommonErrorRestError){NotAuthorizedError=_apiCommonErrorRestError.NotAuthorizedError,NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_MailModel){mailModel=_MailModel.mailModel},function(_guiTheme){theme=_guiTheme.theme},function(_contactsContactUtils){LazyContactListId=_contactsContactUtils.LazyContactListId,searchForContactByMailAddress=_contactsContactUtils.searchForContactByMailAddress},function(_apiEntitiesTutanotaServices){TutanotaService=_apiEntitiesTutanotaServices.TutanotaService},function(_apiCommonEntityFunctions){getListId=_apiCommonEntityFunctions.getListId,HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_apiEntitiesTutanotaListUnsubscribeData){createListUnsubscribeData=_apiEntitiesTutanotaListUnsubscribeData.createListUnsubscribeData},function(_apiEntitiesTutanotaMailHeaders){MailHeadersTypeRef=_apiEntitiesTutanotaMailHeaders.MailHeadersTypeRef},function(_Exporter){exportAsEml=_Exporter.exportAsEml},function(_miscClientDetector){client=_miscClientDetector.client},function(_guiBaseDropdown){DomRectReadOnlyPolyfilled=_guiBaseDropdown.DomRectReadOnlyPolyfilled},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_guiBaseBadge){Badge=_guiBaseBadge.default},function(_apiCommonErrorFileOpenError){FileOpenError=_apiCommonErrorFileOpenError.FileOpenError},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_guiStyles){styles=_guiStyles.styles},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseDropdownN){createDropdown=_guiBaseDropdownN.createDropdown},function(_miscRouteChange){navButtonRoutes=_miscRouteChange.navButtonRoutes},function(_apiEntitiesSysEmailSenderListElement){createEmailSenderListElement=_apiEntitiesSysEmailSenderListElement.createEmailSenderListElement},function(_MailView){isNewMailActionAvailable=_MailView.isNewMailActionAvailable}],execute:function(){assertMainOrNode(),350,.8,_export("MailViewer",MailViewer=function(){function MailViewer(mail,showFolder){var _this=this;if(_classCallCheck(this,MailViewer),this._lastBodyTouchEndTime=0,isDesktop()&&nativeApp.invokeNative(new Request("sendSocketMessage",[{mailAddress:mail.sender.address}])),this.mail=mail,this._folderText=null,this._filesExpanded=stream(!1),this._domBodyDeferred=defer(),showFolder){var folder=mailModel.getMailFolder(mail._id[0]);folder&&mailModel.getMailboxDetailsForMail(mail).then(function(mailboxDetails){_this._folderText=(lang.get("location_label")+": "+getMailboxName(mailboxDetails)+" / "+getFolderName(folder)).toUpperCase(),m.redraw()})}this._attachments=[],this._attachmentButtons=[],this._htmlBody="",this._contrastFixNeeded=!1,this._contentBlocked=!1,this._bodyLineHeight=size.line_height,this._errorOccurred=!1,this._domMailViewer=null,this._scrollAnimation=Promise.resolve(),this._isScaling=!0,this._lastTouchStart={x:0,y:0,time:Date.now()};var closeAction=function(){return _this.mailHeaderDialog.close()},headerBarAttrs={right:[{label:"ok_action",click:closeAction,type:ButtonType.Secondary}],middle:function(){return lang.get("mailHeaders_title")}};this.mailHeaderInfo="",this.mailHeaderDialog=Dialog.largeDialog(headerBarAttrs,{view:function(){return m(".white-space-pre.pt.pb.selectable",_this.mailHeaderInfo)}}).addShortcut({key:Keys.ESC,exec:closeAction,help:"close_alt"}).setCloseHandler(closeAction);var resizeListener=function(){return _this._updateLineHeight()};windowFacade.addResizeListener(resizeListener);var senderBubble=createAsyncDropDownButton(function(){return getDisplayText(_this.mail.sender.name,_this.mail.sender.address,!1)},null,function(){return _this._createBubbleContextButtons(_this.mail.sender,InboxRuleType.FROM_EQUALS)},300).setType(ButtonType.Bubble),differentSenderBubble=this._isEnvelopeSenderVisible()?new Button(function(){return getDisplayText("",neverNull(_this.mail.differentEnvelopeSender),!1)},function(){return Dialog.error("envelopeSenderInfo_msg",neverNull(_this.mail.differentEnvelopeSender))},function(){return Icons.Warning}).setType(ButtonType.Bubble):null,toRecipientBubbles=this.mail.toRecipients.map(function(recipient){return createAsyncDropDownButton(function(){return getDisplayText(recipient.name,recipient.address,!1)},null,function(){return _this._createBubbleContextButtons(recipient,InboxRuleType.RECIPIENT_TO_EQUALS)},300).setType(ButtonType.Bubble)}),ccRecipientBubbles=this.mail.ccRecipients.map(function(recipient){return createAsyncDropDownButton(function(){return getDisplayText(recipient.name,recipient.address,!1)},null,function(){return _this._createBubbleContextButtons(recipient,InboxRuleType.RECIPIENT_CC_EQUALS)},300).setType(ButtonType.Bubble)}),bccRecipientBubbles=this.mail.bccRecipients.map(function(recipient){return createAsyncDropDownButton(function(){return getDisplayText(recipient.name,recipient.address,!1)},null,function(){return _this._createBubbleContextButtons(recipient,InboxRuleType.RECIPIENT_BCC_EQUALS)},300).setType(ButtonType.Bubble)}),replyToBubbles=this.mail.replyTos.map(function(recipient){return createAsyncDropDownButton(function(){return getDisplayText(recipient.name,recipient.address,!1)},null,function(){return _this._createBubbleContextButtons(recipient,null)},300).setType(ButtonType.Bubble)}),detailsExpander=new ExpanderButton("showMore_action",new ExpanderPanel({view:function(){return m("",[m(".ml-negative-bubble",m(senderBubble)),differentSenderBubble?m(".small",lang.get("sender_label")):null,differentSenderBubble?m(".ml-negative-bubble",m(differentSenderBubble)):null,toRecipientBubbles.length>0?m(".small",lang.get("to_label")):null,toRecipientBubbles.length>0?m(".flex-start.flex-wrap.ml-negative-bubble",toRecipientBubbles.map(function(b){return m(b)})):null,ccRecipientBubbles.length>0?m(".small",lang.get("cc_label")):null,ccRecipientBubbles.length>0?m(".flex-start.flex-wrap.ml-negative-bubble",ccRecipientBubbles.map(function(b){return m(b)})):null,bccRecipientBubbles.length>0?m(".small",lang.get("bcc_label")):null,bccRecipientBubbles.length>0?m(".flex-start.flex-wrap.ml-negative-bubble",bccRecipientBubbles.map(function(b){return m(b)})):null,replyToBubbles.length>0?m(".small",lang.get("replyTo_label")):null,replyToBubbles.length>0?m(".flex-start.flex-wrap.ml-negative-bubble",replyToBubbles.map(function(b){return m(b)})):null])}}),!1,{"padding-top":px(26)}),actions=new ActionBar;if(actions.add(this._createLoadExternalContentButton(mail)),mail.state===MailState.DRAFT)actions.add(new Button("edit_action",function(){return _this._editDraft()},function(){return Icons.Edit}));else{if(!this._isAnnouncement()){actions.add(new Button("reply_action",function(){return _this._reply(!1)},function(){return Icons.Reply}));var userController=logins.getUserController(),restrictedParticipants=mail.restrictions&&mail.restrictions.participantGroupInfos.length>0;userController.isInternalUser()&&mail.toRecipients.length+mail.ccRecipients.length+mail.bccRecipients.length>1&&!restrictedParticipants&&actions.add(new Button("replyAll_action",function(){return _this._reply(!0)},function(){return Icons.ReplyAll})),userController.isInternalUser()&&!restrictedParticipants?actions.add(new Button("forward_action",function(){return _this._forward()},function(){return Icons.Forward})):userController.isInternalUser()&&restrictedParticipants&&userController.getUserMailGroupMembership().group!==this.mail._ownerGroup&&actions.add(this._createAssignActionButton(mail))}actions.add(createAsyncDropDownButton("move_action",function(){return Icons.Folder},function(){return mailModel.getMailboxFolders(_this.mail).then(function(folders){var filteredFolders=folders.filter(function(f){return f.mails!==_this.mail._id[0]});return getSortedSystemFolders(filteredFolders).concat(getSortedCustomFolders(filteredFolders)).map(function(f){return new Button(function(){return getFolderName(f)},function(){return mailModel.moveMails([mail],f)},getFolderIcon(f)).setType(ButtonType.Dropdown)})})}))}actions.add(new Button("delete_action",function(){showDeleteConfirmationDialog([_this.mail]).then(function(confirmed){confirmed&&mailModel.deleteMails([_this.mail])})},function(){return Icons.Trash})),mail.state!==MailState.DRAFT&&actions.add(createDropDownButton("more_label",function(){return Icons.More},function(){var moreButtons=[];return _this.mail.unread?moreButtons.push(new Button("markRead_action",function(){return _this._markUnread(!1)},function(){return Icons.Eye}).setType(ButtonType.Dropdown)):moreButtons.push(new Button("markUnread_action",function(){return _this._markUnread(!0)},function(){return Icons.NoEye}).setType(ButtonType.Dropdown)),_this._isAnnouncement()||client.isMobileDevice()||logins.isEnabled(FeatureType.DisableMailExport)||moreButtons.push(new Button("export_action",function(){return exportAsEml(_this.mail,_this._mailBody?htmlSanitizer.sanitize(_this._getMailBody(),!1).text:"")},function(){return Icons.Export}).setType(ButtonType.Dropdown)),client.isMobileDevice()||logins.isEnabled(FeatureType.DisableMailExport)||"function"!=typeof window.print||moreButtons.push(new Button("print_action",function(){return window.print()},function(){return Icons.Print}).setType(ButtonType.Dropdown)),_this.mail.listUnsubscribe&&moreButtons.push(new Button("unsubscribe_action",function(){if(_this.mail.headers)return showProgressDialog("pleaseWait_msg",load(MailHeadersTypeRef,_this.mail.headers).then(function(mailHeaders){var headers=getMailHeaders(mailHeaders).split("\n").filter(function(headerLine){return headerLine.toLowerCase().startsWith("list-unsubscribe")});return headers.length>0&&_this._getSenderOfResponseMail().then(function(recipient){var postData=createListUnsubscribeData({mail:_this.mail._id,recipient:recipient,headers:headers.join("\n")});return serviceRequestVoid(TutanotaService.ListUnsubscribeService,HttpMethod.POST,postData).return(!0)})})).then(function(success){if(success)return Dialog.error("unsubscribeSuccessful_msg")}).catch(function(e){return Dialog.error("unsubscribeFailed_msg")})},function(){return Icons.Cancel}).setType(ButtonType.Dropdown)),moreButtons.push(new Button("showHeaders_action",function(){return _this._showHeaders()},function(){return Icons.ListUnordered}).setType(ButtonType.Dropdown)),moreButtons},350)),this._inlineFileIds=this._loadMailBody(mail),load(ConversationEntryTypeRef,mail.conversationEntry).catch(NotFoundError,function(e){return console.log("could load conversation entry as it has been moved/deleted already",e)}),this._inlineImages=this._loadAttachments(mail),this.view=function(){var dateTime=formatDateWithWeekday(_this.mail.receivedDate)+" • "+formatTime(_this.mail.receivedDate);return[m("#mail-viewer.fill-absolute"+(client.isMobileDevice()?".scroll-no-overlay.overflow-x-hidden":".flex.flex-column"),{oncreate:function(vnode){return _this._domMailViewer=vnode.dom}},[m(".header.plr-l.margin-are-inset-lr",[m(".flex-space-between.button-min-height",[m(".flex.flex-column-reverse",[detailsExpander.panel.expanded?m("small.flex.text-break",lang.get("from_label")):m(".small.flex.text-break.selectable.badge-line-height.flex-wrap.pt-s",{title:getSenderOrRecipientHeadingTooltip(_this.mail)},[_this._tutaoBadge(),_this._isEnvelopeSenderVisible()?m(Icon,{icon:Icons.Warning,style:{fill:theme.navigation_button}}):null,getSenderOrRecipientHeading(_this.mail,!1)]),_this._folderText?m("small.b.flex.pt",{style:{color:theme.navigation_button}},_this._folderText):null]),m(".flex.flex-column-reverse",_this._isAnnouncement()?null:m(detailsExpander))]),m(detailsExpander.panel),m(".subject-actions.flex-space-between.mr-negative-s.flex-wrap.mt-xs",[m(".left.flex-grow-shrink-150",[m(".subject.text-break.selectable",{"aria-label":lang.get("subject_label")+", "+_this.mail.subject},_this.mail.subject),m(".flex.items-center.content-accent-fg.svg-content-accent-fg"+(_this.mail.confidential?".ml-negative-xs":""),{tabindex:TabIndex.Default,"aria-label":lang.get(_this.mail.confidential?"confidential_action":"nonConfidential_action")+", "+dateTime},[_this.mail.confidential?m(Icon,{icon:Icons.Lock}):null,m("small.date.mt-xs",dateTime)])]),m(actions)]),_this._renderAttachments(),m("hr.hr.mt")]),m(".rel.margin-are-inset-lr.scroll-x.plr-l.pb-floating"+(client.isMobileDevice()?"":".scroll-no-overlay")+(_this._contrastFixNeeded?".bg-white.content-black":" "),{ontouchstart:function(event){event.redraw=!1;var touch=event.touches[0];_this._lastTouchStart.x=touch.clientX,_this._lastTouchStart.y=touch.clientY,_this._lastTouchStart.time=Date.now()},oncreate:function(vnode){_this._domForScrolling=vnode.dom},ontouchend:function(event){client.isMobileDevice()&&_this._handleDoubleTap(event,function(e){return _this._handleAnchorClick(e,!0)},function(){return _this._rescale(!0)})},onclick:function(event){client.isMobileDevice()||_this._handleAnchorClick(event,!1)}},m("#mail-body.selectable.touch-callout.break-word-links",{oncreate:function(vnode){_this._domBodyDeferred.resolve(vnode.dom),_this._updateLineHeight(),_this._rescale(!1)},onupdate:function(vnode){_this._domBodyDeferred.promise.isPending()&&_this._domBodyDeferred.resolve(vnode.dom),_this._rescale(!1)},onsubmit:function(event){return _this._confirmSubmit(event)},style:{"line-height":_this._bodyLineHeight,"transform-origin":"top left"}},null!=_this._mailBody||_this._errorOccurred?_this._errorOccurred||_this.mail._errors||neverNull(_this._mailBody)._errors?m(ColumnEmptyMessageBox,{message:"corrupted_msg",icon:Icons.Warning,color:theme.content_message_bg}):m.trust(_this._htmlBody):m(".progress-panel.flex-v-center.items-center",{style:{height:"200px"}},[progressIcon(),m("small",lang.get("loading_msg"))])))])]},this.onbeforeremove=function(){return windowFacade.removeResizeListener(resizeListener)},this._setupShortcuts()}return _createClass(MailViewer,[{key:"getBounds",value:function(){return this._domMailViewer&&this._domMailViewer.getBoundingClientRect()}},{key:"_createAssignActionButton",value:function(mail){var _this2=this,mailRecipients=this._getAssignableMailRecipients().filter(function(userOrMailGroupInfo){return logins.getUserController().getUserMailGroupMembership().group===_this2.mail._ownerGroup?userOrMailGroupInfo.group!==logins.getUserController().userGroupInfo.group&&userOrMailGroupInfo.group!==mail._ownerGroup:userOrMailGroupInfo.group!==mail._ownerGroup}).map(function(userOrMailGroupInfo){return new Button(function(){return getDisplayText(userOrMailGroupInfo.name,neverNull(userOrMailGroupInfo.mailAddress),!0)},function(){return _this2._assignMail(userOrMailGroupInfo)},function(){return BootIcons.Contacts}).setType(ButtonType.Dropdown)});return createAsyncDropDownButton("forward_action",function(){return Icons.Forward},function(){return mailRecipients},250)}},{key:"_createLoadExternalContentButton",value:function(mail){var _this3=this,loadExternalContentButton=new Button("contentBlocked_msg",function(){_this3._mailBody&&Dialog.confirm("contentBlocked_msg","showBlockedContent_action").then(function(confirmed){confirmed&&(_this3._htmlBody=urlify(stringifyFragment(htmlSanitizer.sanitizeFragment(_this3._getMailBody(),!1,isTutanotaTeamMail(mail)).html)),_this3._contentBlocked=!1,_this3._domBodyDeferred=defer(),_this3._replaceInlineImages(),m.redraw())})},function(){return Icons.Picture});return loadExternalContentButton.setIsVisibleHandler(function(){return _this3._contentBlocked}),loadExternalContentButton}},{key:"_replaceInlineImages",value:function(){var _this4=this;this._inlineImages.then(function(loadedInlineImages){_this4._domBodyDeferred.promise.then(function(domBody){replaceCidsWithInlineImages(domBody,loadedInlineImages,function(file,event,dom){createDropdown(function(){return[{label:"download_action",click:function(){fileController.downloadAndOpen(file,!0).catch(FileOpenError,function(){return Dialog.error("canNotOpenFileOnDevice_msg")})},type:ButtonType.Dropdown}]})(event,dom)})})})}},{key:"_loadMailBody",value:function(mail){var _this5=this;return load(MailBodyTypeRef,mail.body).then(function(body){_this5._mailBody=body;var sanitizeResult=htmlSanitizer.sanitizeFragment(_this5._getMailBody(),!0,isTutanotaTeamMail(mail));return _this5._contrastFixNeeded=void 0!==Array.from(sanitizeResult.html.querySelectorAll("*[style]"),function(e){return e.style}).find(function(s){return""!==s.color&&void 0!==s.color})||0<Array.from(sanitizeResult.html.querySelectorAll("font[color]"),function(e){return e.style}).length,_this5._htmlBody=urlify(stringifyFragment(sanitizeResult.html)),_this5._contentBlocked=sanitizeResult.externalContent.length>0,m.redraw(),sanitizeResult.inlineImageCids}).catch(NotFoundError,function(e){return _this5._errorOccurred=!0,console.log("could load mail body as it has been moved/deleted already",e),[]}).catch(NotAuthorizedError,function(e){return _this5._errorOccurred=!0,console.log("could load mail body as the permission is missing",e),[]})}},{key:"_loadAttachments",value:function(mail){var _this6=this;return 0===mail.attachments.length?(this._loadingAttachments=!1,Promise.resolve({})):(this._loadingAttachments=!0,Promise.map(mail.attachments,function(fileId){return load(FileTypeRef,fileId)}).then(function(files){return _this6._attachments=files,_this6._inlineFileIds.then(function(inlineCids){_this6._attachmentButtons=_this6._createAttachmentsButtons(files,inlineCids),_this6._loadingAttachments=!1,m.redraw();var filesToLoad=files.filter(function(file){return inlineCids.find(function(inline){return file.cid===inline})}),inlineImages={};return Promise.map(filesToLoad,function(file){return worker.downloadFileContent(file).then(function(dataFile){var blob=new Blob([dataFile.data],{type:dataFile.mimeType});inlineImages[neverNull(file.cid)]={file:file,url:URL.createObjectURL(blob)}})}).return(inlineImages)})}).catch(NotFoundError,function(e){return console.log("could load attachments as they have been moved/deleted already",e),{}}))}},{key:"_renderAttachments",value:function(){if(this._loadingAttachments)return m(".flex",[m(".flex-v-center.pl-button",progressIcon()),m(".small.flex-v-center.plr.button-height",lang.get("loading_msg"))]);var spoilerLimit=this._attachmentsSpoilerLimit();return m(".flex.ml-negative-bubble.flex-wrap",[this._attachmentButtons.length>spoilerLimit?[this._attachmentButtons.slice(0,spoilerLimit).map(m),m(ExpanderButtonN,{label:"showAll_action",expanded:this._filesExpanded,style:{margin:"0 6px",paddingTop:"0"}}),m(ExpanderPanelN,{expanded:this._filesExpanded},this._attachmentButtons.slice(spoilerLimit).map(m))]:this._attachmentButtons.map(m),this._renderDownloadAllButton()])}},{key:"_renderDownloadAllButton",value:function(){var _this7=this;return!isIOSApp()&&this._attachmentButtons.length>2?m(".limit-width",m(ButtonN,{label:"saveAll_action",type:ButtonType.Secondary,click:function(){return _this7._downloadAll()}})):null}},{key:"_attachmentsSpoilerLimit",value:function(){return styles.isDesktopLayout()?4:2}},{key:"_tutaoBadge",value:function(){return isTutanotaTeamMail(this.mail)?m(Badge,{classes:".mr-s"},"Tutanota Team"):null}},{key:"_isAnnouncement",value:function(){return isExcludedMailAddress(this.mail.sender.address)}},{key:"_rescale",value:function(animate){if(client.isMobileDevice()&&this._domBodyDeferred.promise.isFulfilled()){var child=this._domBodyDeferred.promise.value(),containerWidth=child.offsetWidth;if(!this._isScaling||containerWidth>child.scrollWidth)child.style.transform="",child.style.marginBottom="";else{var scale=containerWidth/child.scrollWidth,heightDiff=child.scrollHeight-child.scrollHeight*scale;child.style.transform="scale("+scale+")",child.style.marginBottom=-heightDiff+"px"}child.style.transition=animate?"transform 200ms ease-in-out":""}}},{key:"_setupShortcuts",value:function(){var _this8=this,shortcuts=[{key:Keys.E,enabled:function(){return _this8.mail.state===MailState.DRAFT},exec:function(){_this8._editDraft()},help:"editMail_action"},{key:Keys.H,exec:function(){return _this8._showHeaders()},help:"showHeaders_action"},{key:Keys.R,exec:function(key){_this8._reply(!1)},help:"reply_action"},{key:Keys.R,shift:!0,exec:function(key){_this8._reply(!0)},help:"replyAll_action"},{key:Keys.F,shift:!0,exec:function(key){_this8._forward()},help:"forward_action"}];this.oncreate=function(){keyManager.registerShortcuts(shortcuts),_this8._replaceInlineImages()},this.onremove=function(){keyManager.unregisterShortcuts(shortcuts),_this8._domBodyDeferred=defer()},this.onbeforeremove=function(){_this8._inlineImages.then(function(inlineImages){Object.keys(inlineImages).forEach(function(key){URL.revokeObjectURL(inlineImages[key].url)})})}}},{key:"_updateLineHeight",value:function(){var _this9=this;this._domBodyDeferred.promise.then(function(domBody){var width=domBody.offsetWidth;_this9._bodyLineHeight=width>900?size.line_height_l:width>600?size.line_height_m:size.line_height,m.redraw()})}},{key:"_confirmSubmit",value:function(event){confirm(lang.get("reallySubmitContent_msg"))||event.preventDefault()}},{key:"_createBubbleContextButtons",value:function(address,defaultInboxRuleField){var _this10=this;if(logins.getUserController().isInternalUser()){var buttons=[address.address],contactsPromise=Promise.resolve();return logins.isEnabled(FeatureType.DisableContacts)||(contactsPromise=searchForContactByMailAddress(address.address).then(function(contact){contact?buttons.push(new Button("showContact_action",function(){navButtonRoutes.contactsUrl="/contact/"+neverNull(contact)._id[0]+"/"+neverNull(contact)._id[1],m.route.set(navButtonRoutes.contactsUrl+location.hash)},null).setType(ButtonType.Secondary)):buttons.push(new Button("createContact_action",function(){LazyContactListId.getAsync().then(function(contactListId){new ContactEditor(createNewContact(address.address,address.name),contactListId).show()})},null).setType(ButtonType.Secondary))})),contactsPromise.then(function(){return mailModel.getMailboxDetailsForMail(_this10.mail).then(function(mailboxDetails){if(defaultInboxRuleField&&!logins.getUserController().isOutlookAccount()&&!logins.isEnabled(FeatureType.InternalCommunication)){var rule=AddInboxRuleDialog.getExistingRuleForType(address.address.trim().toLowerCase(),defaultInboxRuleField),actionLabel="editInboxRule_action";rule||(rule=createInboxRuleTemplate(defaultInboxRuleField,address.address.trim().toLowerCase()),actionLabel="addInboxRule_action"),buttons.push(new Button(actionLabel,function(){AddInboxRuleDialog.show(mailboxDetails,neverNull(rule))},null).setType(ButtonType.Secondary))}return logins.isGlobalAdminUserLoggedIn()&&!logins.isEnabled(FeatureType.InternalCommunication)&&buttons.push(new Button("addSpamRule_action",function(){var folder=mailModel.getMailFolder(getListId(_this10.mail)),spamRuleType=folder&&folder.folderType===MailFolderType.SPAM?SpamRuleType.WHITELIST:SpamRuleType.BLACKLIST,spamRuleField=void 0;switch(defaultInboxRuleField){case InboxRuleType.RECIPIENT_TO_EQUALS:spamRuleField=SparmRuleType.TO;break;case InboxRuleType.RECIPIENT_CC_EQUALS:spamRuleField=SparmRuleType.CC;break;case InboxRuleType.RECIPIENT_BCC_EQUALS:spamRuleField=SparmRuleType.BCC;break;default:spamRuleField=SparmRuleType.FROM}AddSpamRuleDialog.show(createEmailSenderListElement({value:address.address.trim().toLowerCase(),type:spamRuleType,field:spamRuleField}))},null).setType(ButtonType.Secondary)),buttons})})}return Promise.resolve([address.address])}},{key:"_isEnvelopeSenderVisible",value:function(){return null!=this.mail.differentEnvelopeSender}},{key:"_markUnread",value:function(unread){this.mail.unread=unread,update(this.mail).catch(NotFoundError,noOp)}},{key:"_editDraft",value:function(){var _this11=this;return checkApprovalStatus(!1).then(function(sendAllowed){if(sendAllowed)return mailModel.getMailboxDetailsForMail(_this11.mail).then(function(mailboxDetails){var editor=new MailEditor(mailboxDetails);return editor.initFromDraft({draftMail:_this11.mail,attachments:_this11._attachments,bodyText:_this11._getMailBody(),blockExternalContent:_this11._contentBlocked,inlineImages:_this11._inlineImages}).then(function(){editor.show()})})})}},{key:"_reply",value:function(replyAll){var _this12=this;if(!this._isAnnouncement())return checkApprovalStatus(!1).then(function(sendAllowed){if(sendAllowed)return mailModel.getMailboxDetailsForMail(_this12.mail).then(function(mailboxDetails){var subject=startsWith(_this12.mail.subject.toUpperCase(),"Re: ".toUpperCase())?_this12.mail.subject:"Re: "+_this12.mail.subject,body=formatDateTime(_this12.mail.sentDate)+" "+lang.get("by_label")+" "+_this12.mail.sender.address+":"+'<br><blockquote class="tutanota_quote">'+_this12._getMailBody()+"</blockquote>",toRecipients=[],ccRecipients=[],bccRecipients=[];if(logins.getUserController().isInternalUser()||_this12.mail.state!==MailState.RECEIVED)if(_this12.mail.state===MailState.RECEIVED){if(_this12.mail.replyTos.length>0?addAll(toRecipients,_this12.mail.replyTos):toRecipients.push(_this12.mail.sender),replyAll){var myMailAddresses=getEnabledMailAddresses(mailboxDetails);addAll(ccRecipients,_this12.mail.toRecipients.filter(function(recipient){return!contains(myMailAddresses,recipient.address.toLowerCase())})),addAll(ccRecipients,_this12.mail.ccRecipients.filter(function(recipient){return!contains(myMailAddresses,recipient.address.toLowerCase())}))}}else addAll(toRecipients,_this12.mail.toRecipients),replyAll&&(addAll(ccRecipients,_this12.mail.ccRecipients),addAll(bccRecipients,_this12.mail.bccRecipients));else toRecipients.push(_this12.mail.sender);var editor=new MailEditor(mailboxDetails);return _this12._getSenderOfResponseMail().then(function(senderMailAddress){return editor.initAsResponse({previousMail:_this12.mail,conversationType:ConversationType.REPLY,senderMailAddress:senderMailAddress,toRecipients:toRecipients,ccRecipients:ccRecipients,bccRecipients:bccRecipients,attachments:[],subject:subject,bodyText:body,replyTos:[],addSignature:!0,inlineImages:_this12._inlineImages,blockExternalContent:_this12._contentBlocked})}).then(function(){editor.show()})})})}},{key:"_getMailBody",value:function(){return this._mailBody?getMailBodyText(this._mailBody):""}},{key:"_forward",value:function(){var _this13=this;return checkApprovalStatus(!1).then(function(sendAllowed){if(sendAllowed)return _this13._createForwardingMailEditor([],[],!0,!0).then(function(editor){editor.show()})})}},{key:"_createForwardingMailEditor",value:function(recipients,replyTos,addSignature,replaceInlineImages){var _this14=this,infoLine=lang.get("date_label")+": "+formatDateTime(this.mail.sentDate)+"<br>";infoLine+=lang.get("from_label")+": "+this.mail.sender.address+"<br>",this.mail.toRecipients.length>0&&(infoLine+=lang.get("to_label")+": "+this.mail.toRecipients.map(function(recipient){return recipient.address}).join(", "),infoLine+="<br>"),this.mail.ccRecipients.length>0&&(infoLine+=lang.get("cc_label")+": "+this.mail.ccRecipients.map(function(recipient){return recipient.address}).join(", "),infoLine+="<br>");var body=(infoLine+=lang.get("subject_label")+": "+urlEncodeHtmlTags(this.mail.subject))+'<br><br><blockquote class="tutanota_quote">'+this._getMailBody()+"</blockquote>";return mailModel.getMailboxDetailsForMail(this.mail).then(function(mailboxDetails){return _this14._getSenderOfResponseMail().then(function(senderMailAddress){var editor=new MailEditor(mailboxDetails);return editor.initAsResponse({previousMail:_this14.mail,conversationType:ConversationType.FORWARD,senderMailAddress:senderMailAddress,toRecipients:recipients,ccRecipients:[],bccRecipients:[],attachments:_this14._attachments.slice(),subject:"FWD: "+_this14.mail.subject,bodyText:body,replyTos:replyTos,addSignature:addSignature,inlineImages:replaceInlineImages?_this14._inlineImages:null,blockExternalContent:_this14._contentBlocked}).then(function(){return editor})})})}},{key:"_getAssignableMailRecipients",value:function(){if(null!=this.mail.restrictions&&this.mail.restrictions.participantGroupInfos.length>0){var participantGroupInfos=this.mail.restrictions.participantGroupInfos;return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return loadGroupInfos(participantGroupInfos.filter(function(groupInfoId){return neverNull(customer.contactFormUserGroups).list!==groupInfoId[0]})).filter(function(groupInfo){return null==groupInfo.deleted})})}return Promise.resolve([])}},{key:"_assignMail",value:function(userGroupInfo){var _this15=this,recipient=createMailAddress();recipient.address=neverNull(userGroupInfo.mailAddress),recipient.name=userGroupInfo.name;var newReplyTos=void 0;this.mail.replyTos.length>0?newReplyTos=this.mail.replyTos:((newReplyTos=[createEncryptedMailAddress()])[0].address=this.mail.sender.address,newReplyTos[0].name=this.mail.sender.name),this._createForwardingMailEditor([recipient],newReplyTos,!1,!1).then(function(editor){return editor.send()}).then(function(){return mailModel.getMailboxFolders(_this15.mail)}).then(function(folders){mailModel.moveMails([_this15.mail],getArchiveFolder(folders))})}},{key:"_getSenderOfResponseMail",value:function(){var _this16=this;return mailModel.getMailboxDetailsForMail(this.mail).then(function(mailboxDetails){var myMailAddresses=getEnabledMailAddresses(mailboxDetails),addressesInMail=[];addAll(addressesInMail,_this16.mail.toRecipients),addAll(addressesInMail,_this16.mail.ccRecipients),addAll(addressesInMail,_this16.mail.bccRecipients),addressesInMail.push(_this16.mail.sender);var foundAddress=addressesInMail.find(function(address){return contains(myMailAddresses,address.address.toLowerCase())});return foundAddress?foundAddress.address.toLowerCase():getDefaultSender(mailboxDetails)})}},{key:"_handleAnchorClick",value:function(event,shouldDispatchSyntheticClick){var target=event.target;if(target&&target.closest){var anchorElement=target.closest("a");if(anchorElement&&startsWith(anchorElement.href,"mailto:"))event.preventDefault(),isNewMailActionAvailable()&&mailModel.getMailboxDetailsForMail(this.mail).then(function(mailboxDetails){var mailEditor=new MailEditor(mailboxDetails);mailEditor.initWithMailtoUrl(anchorElement.href,!logins.getUserController().props.defaultUnconfidential).then(function(){mailEditor.show()})});else if(anchorElement&&isTutanotaTeamMail(this.mail)&&startsWith(anchorElement.href,anchorElement.origin+"/settings/")){var newRoute=anchorElement.href.substr(anchorElement.href.indexOf("/settings/"));m.route.set(newRoute),event.preventDefault()}else if(anchorElement&&shouldDispatchSyntheticClick){var newClickEvent=new MouseEvent("click");newClickEvent.synthetic=!0,anchorElement.dispatchEvent(newClickEvent)}}}},{key:"scrollUp",value:function(){this._scrollIfDomBody(function(dom){var current=dom.scrollTop,toScroll=.8*dom.clientHeight;return scroll(current,Math.max(0,current-toScroll))})}},{key:"scrollDown",value:function(){this._scrollIfDomBody(function(dom){var current=dom.scrollTop,toScroll=.8*dom.clientHeight;return scroll(current,Math.min(dom.scrollHeight-dom.offsetHeight,dom.scrollTop+toScroll))})}},{key:"scrollToTop",value:function(){this._scrollIfDomBody(function(dom){return scroll(dom.scrollTop,0)})}},{key:"scrollToBottom",value:function(){this._scrollIfDomBody(function(dom){var end=dom.scrollHeight-dom.offsetHeight;return scroll(dom.scrollTop,end)})}},{key:"_showHeaders",value:function(){var _this17=this;this.mailHeaderDialog.visible||(this.mail.headers?load(MailHeadersTypeRef,this.mail.headers).then(function(mailHeaders){_this17.mailHeaderInfo=getMailHeaders(mailHeaders),_this17.mailHeaderDialog.show()}).catch(NotFoundError,noOp):(this.mailHeaderInfo=lang.get("noMailHeadersInfo_msg"),this.mailHeaderDialog.show()))}},{key:"_scrollIfDomBody",value:function(cb){if(this._domForScrolling){var _dom=this._domForScrolling;this._scrollAnimation.isFulfilled()&&(this._scrollAnimation=animations.add(_dom,cb(_dom),{easing:ease.inOut}))}}},{key:"_createAttachmentsButtons",value:function(files,inlineCids){files=files.filter(function(item){return!1===inlineCids.includes(item.cid)});return isAndroidApp()||isDesktop()?files.map(function(file){var dropdownButton=createDropDownButton(function(){return file.name},function(){return Icons.Attachment},function(){return[new Button("open_action",function(){return fileController.downloadAndOpen(file,!0).catch(FileOpenError,function(){return Dialog.error("canNotOpenFileOnDevice_msg")})},null).setType(ButtonType.Dropdown),new Button("download_action",function(){return fileController.downloadAndOpen(file,!1).catch(FileOpenError,function(){return Dialog.error("canNotOpenFileOnDevice_msg")})},null).setType(ButtonType.Dropdown)]},200,function(){var rect=dropdownButton._domButton.getBoundingClientRect();return new DomRectReadOnlyPolyfilled(rect.left+size.bubble_border_width,rect.top,rect.width,rect.height)}).setType(ButtonType.Bubble).setStaticRightText("("+formatStorageSize(Number(file.size))+")");return dropdownButton}):files.map(function(file){return new Button(function(){return file.name},function(){return fileController.downloadAndOpen(file,!0).catch(FileOpenError,function(){return Dialog.error("canNotOpenFileOnDevice_msg")})},function(){return Icons.Attachment}).setType(ButtonType.Bubble).setStaticRightText("("+formatStorageSize(Number(file.size))+")")})}},{key:"_downloadAll",value:function(){var _this18=this;this._inlineFileIds.then(function(inilneFileIds){var nonInlineFiles=_this18._attachments.filter(function(a){return!inilneFileIds.includes(a.cid)});client.needsDownloadBatches()&&nonInlineFiles.length>10?fileController.downloadBatched(nonInlineFiles,10,1e3):client.canDownloadMultipleFiles()?fileController.downloadAll(nonInlineFiles):fileController.downloadBatched(nonInlineFiles,1,10)})}},{key:"_handleDoubleTap",value:function(e,singleClickAction,doubleClickAction){var _this19=this,lastClick=this._lastBodyTouchEndTime,now=Date.now(),touch=e.changedTouches[0];!touch||e.synthetic||!e.cancelable||Date.now()-this._lastTouchStart.time>350||touch.clientX-this._lastTouchStart.x>40||touch.clientY-this._lastTouchStart.y>40||(e.preventDefault(),now-lastClick<350?(this._isScaling=!this._isScaling,this._lastBodyTouchEndTime=0,e.redraw=!1,doubleClickAction(e)):setTimeout(function(){_this19._lastBodyTouchEndTime===now&&singleClickAction(e)},350),this._lastBodyTouchEndTime=now)}}]),MailViewer}()),_export("MailViewer",MailViewer)}}}),System.register("node_modules/systemjs-plugin-babel/babel-helpers/get.js",[],function(_export,_context){"use strict";return{setters:[],execute:function(){_export("default",function get(object,property,receiver){null===object&&(object=Function.prototype);var desc=Object.getOwnPropertyDescriptor(object,property);if(void 0===desc){var parent=Object.getPrototypeOf(object);return null===parent?void 0:get(parent,property,receiver)}if("value"in desc)return desc.value;var getter=desc.get;return void 0!==getter?getter.call(receiver):void 0})}}}),System.register("src/gui/base/SwipeHandler.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../../misc/ClientDetector","../size"],function(_export,_context){"use strict";var _classCallCheck,_createClass,client,size,DirectionLock,SwipeHandler;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_miscClientDetector){client=_miscClientDetector.client},function(_size){size=_size.size}],execute:function(){_export("DirectionLock",DirectionLock=Object.freeze({Horizontal:1,Vertical:2})),_export("DirectionLock",DirectionLock),_export("SwipeHandler",SwipeHandler=function(){function SwipeHandler(touchArea){var _this=this;_classCallCheck(this,SwipeHandler),this.startPos={x:0,y:0},this.touchArea=touchArea,this.animating=Promise.resolve(),this.directionLock=null;var eventListenerArgs=!!client.passive()&&{passive:!0};this.touchArea.addEventListener("touchstart",function(e){return _this.start(e)},eventListenerArgs),this.touchArea.addEventListener("touchmove",function(e){return _this.move(e)},!!client.passive()&&{passive:!1}),this.touchArea.addEventListener("touchend",function(e){return _this.end(e)},eventListenerArgs)}return _createClass(SwipeHandler,[{key:"start",value:function(e){this.startPos.x=e.touches[0].clientX,this.startPos.y=e.touches[0].clientY}},{key:"move",value:function(e){var _this2=this,_getDelta=this.getDelta(e),x=_getDelta.x,y=_getDelta.y;this.directionLock===DirectionLock.Horizontal||this.directionLock!==DirectionLock.Vertical&&Math.abs(x)>Math.abs(y)&&Math.abs(x)>14?(this.directionLock=DirectionLock.Horizontal,e.preventDefault(),this.animating.isFulfilled()&&this.onHorizontalDrag(x,y)):this.directionLock!==DirectionLock.Vertical&&Math.abs(y)>Math.abs(x)&&Math.abs(y)>size.list_row_height&&(this.directionLock=DirectionLock.Vertical,this.animating.isFulfilled()&&window.requestAnimationFrame(function(){_this2.animating.isFulfilled()&&_this2.reset({x:x,y:y})}))}},{key:"end",value:function(e){this.gestureEnd(e)}},{key:"gestureEnd",value:function(e){var delta=this.getDelta(e);this.animating.isFulfilled()&&this.directionLock===DirectionLock.Horizontal?this.animating=this.onHorizontalGestureCompleted(delta):this.animating.isFulfilled()&&(this.animating=this.reset(delta)),this.directionLock=null}},{key:"onHorizontalDrag",value:function(xDelta,yDelta){}},{key:"onHorizontalGestureCompleted",value:function(delta){return Promise.resolve()}},{key:"reset",value:function(delta){return Promise.resolve()}},{key:"getDelta",value:function(e){return{x:e.changedTouches[0].clientX-this.startPos.x,y:e.changedTouches[0].clientY-this.startPos.y}}}]),SwipeHandler}()),_export("SwipeHandler",SwipeHandler)}}}),System.register("src/gui/HtmlUtils.js",[],function(_export,_context){"use strict";return _export("applySafeAreaInsetMarginLR",function(element){element.style.marginRight="env(safe-area-inset-right)",element.style.marginLeft="env(safe-area-inset-left)"}),_export("getSafeAreaInsetLeft",function(){return 90===window.orientation?"env(safe-area-inset-left)":""}),_export("getSafeAreaInsetRight",function(){return-90===window.orientation?"env(safe-area-inset-right)":""}),{setters:[],execute:function(){}}}),System.register("src/gui/base/List.js",["node_modules/systemjs-plugin-babel/babel-helpers/possibleConstructorReturn.js","node_modules/systemjs-plugin-babel/babel-helpers/get.js","node_modules/systemjs-plugin-babel/babel-helpers/inherits.js","node_modules/systemjs-plugin-babel/babel-helpers/toConsumableArray.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../../misc/Log","../size","../../misc/ClientDetector","../../api/common/EntityFunctions","../../api/common/TutanotaConstants","../../api/common/utils/ArrayUtils","../../api/common/utils/Utils","../../api/Env","./ColumnEmptyMessageBox","./Icon","./../animation/Animations","../animation/Easing","../animation/Animations","../../misc/WindowFacade","../../api/common/error/RestError","./SwipeHandler","../HtmlUtils","../theme","../styles","../../misc/KeyManager"],function(_export,_context){"use strict";var _possibleConstructorReturn,_get,_inherits,_toConsumableArray,_classCallCheck,_createClass,m,Cat,log,px,client,firstBiggerThanSecond,GENERATED_MAX_ID,getElementId,getLetId,Keys,OperationType,TabIndex,addAll,arrayEquals,last,remove,debounceStart,neverNull,assertMainOrNode,ColumnEmptyMessageBox,progressIcon,animations,transform,ease,DefaultAnimationTime,opacity,windowFacade,BadRequestError,SwipeHandler,applySafeAreaInsetMarginLR,theme,styles,isKeyPressed,ScrollBuffer,List,ListSwipeHandler;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersPossibleConstructorReturnJs){_possibleConstructorReturn=_node_modulesSystemjsPluginBabelBabelHelpersPossibleConstructorReturnJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersGetJs){_get=_node_modulesSystemjsPluginBabelBabelHelpersGetJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersInheritsJs){_inherits=_node_modulesSystemjsPluginBabelBabelHelpersInheritsJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs){_toConsumableArray=_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLog){Cat=_miscLog.Cat,log=_miscLog.log},function(_size){px=_size.px},function(_miscClientDetector){client=_miscClientDetector.client},function(_apiCommonEntityFunctions){firstBiggerThanSecond=_apiCommonEntityFunctions.firstBiggerThanSecond,GENERATED_MAX_ID=_apiCommonEntityFunctions.GENERATED_MAX_ID,getElementId=_apiCommonEntityFunctions.getElementId,getLetId=_apiCommonEntityFunctions.getLetId},function(_apiCommonTutanotaConstants){Keys=_apiCommonTutanotaConstants.Keys,OperationType=_apiCommonTutanotaConstants.OperationType,TabIndex=_apiCommonTutanotaConstants.TabIndex},function(_apiCommonUtilsArrayUtils){addAll=_apiCommonUtilsArrayUtils.addAll,arrayEquals=_apiCommonUtilsArrayUtils.arrayEquals,last=_apiCommonUtilsArrayUtils.last,remove=_apiCommonUtilsArrayUtils.remove},function(_apiCommonUtilsUtils){debounceStart=_apiCommonUtilsUtils.debounceStart,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_ColumnEmptyMessageBox){ColumnEmptyMessageBox=_ColumnEmptyMessageBox.default},function(_Icon){progressIcon=_Icon.progressIcon},function(_animationAnimations){animations=_animationAnimations.animations,transform=_animationAnimations.transform},function(_animationEasing){ease=_animationEasing.ease},function(_animationAnimations2){DefaultAnimationTime=_animationAnimations2.DefaultAnimationTime,opacity=_animationAnimations2.opacity},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_apiCommonErrorRestError){BadRequestError=_apiCommonErrorRestError.BadRequestError},function(_SwipeHandler2){SwipeHandler=_SwipeHandler2.SwipeHandler},function(_HtmlUtils){applySafeAreaInsetMarginLR=_HtmlUtils.applySafeAreaInsetMarginLR},function(_theme){theme=_theme.theme},function(_styles){styles=_styles.styles},function(_miscKeyManager){isKeyPressed=_miscKeyManager.isKeyPressed}],execute:function(){assertMainOrNode(),_export("ScrollBuffer",ScrollBuffer=15),_export("ScrollBuffer",ScrollBuffer),_export("PageSize",100),_export("PageSize",100),_export("List",List=function(){function List(config){var _this=this;_classCallCheck(this,List),this._lastSelectedEntitiesForCallback=[],this._mobileMultiSelectionActive=!1,this._elementSelected=debounceStart(200,function(entities,elementClicked,multiSelectOperation){var selectionChanged=_this._lastSelectedEntitiesForCallback.length!==entities.length||_this._lastSelectedEntitiesForCallback.some(function(el,i){return entities[i]!==el});_this._config.elementSelected(entities,elementClicked,selectionChanged,multiSelectOperation),_this._lastSelectedEntitiesForCallback=entities}),this._config=config,this._loadedEntities=[],this._scrollListener=function(){_this.currentPosition=_this._domListContainer.scrollTop,_this.lastPosition!==_this.currentPosition&&window.requestAnimationFrame(function(){return _this._scroll()})},this._virtualList=[],this._width=0,this._loadedCompletely=!1,this._loading=Promise.resolve(),this.currentPosition=0,this.lastPosition=0,this.updateLater=!1,this._visibleElementsHeight=0,this.bufferHeight=this._config.rowHeight*ScrollBuffer,this._domStatus={bufferUp:null,bufferDown:null,speed:null,scrollDiff:null,timeDiff:null},this._selectedEntities=[],this._lastMultiSelectWasKeyUp=!1,this._idOfEntityToSelectWhenReceived=null,this.onbeforeupdate=function(){return!_this.ready},this._displayingProgress=!1;var updateWidth=function(){_this._domListContainer&&_this._domSwipeSpacerLeft&&_this._domSwipeSpacerRight&&(_this._domSwipeSpacerLeft.style.opacity="0",_this._domSwipeSpacerRight.style.opacity="0",setTimeout(function(){_this._width=_this._domListContainer.clientWidth,_this._swipeHandler&&(_this._swipeHandler.updateWidth(),_this._domSwipeSpacerLeft.style.opacity="1",_this._domSwipeSpacerRight.style.opacity="1")},60))},reset=function(){var wrapper;_this._domListContainer&&_this._domListContainer.removeEventListener("scroll",_this._scrollListener),_this._domInitialized=((wrapper={}).promise=Promise.fromCallback(function(cb){wrapper.resolve=cb}),wrapper),_this.ready=!1,_this._virtualList=[],windowFacade.removeResizeListener(updateWidth)};reset(),this.onremove=reset,this.oncreate=function(){windowFacade.addResizeListener(updateWidth)},this.view=function(){var list=m(".list-container.fill-absolute.scroll.list-bg.nofocus.overflow-x-hidden",{tabindex:TabIndex.Programmatic,oncreate:function(vnode){_this._domListContainer=vnode.dom,_this._width=_this._domListContainer.clientWidth,_this._createVirtualElements();var render=function(){m.render(vnode.dom,[m(".swipe-spacer.flex.items-center.justify-end.pr-l.blue",{oncreate:function(vnode){return _this._domSwipeSpacerLeft=vnode.dom},tabindex:TabIndex.Programmatic,"aria-hidden":"true",style:{height:px(_this._config.rowHeight),transform:"translateY(-"+_this._config.rowHeight+"px)",position:"absolute","z-index":1,width:px(_this._width)}},_this._config.swipe.renderLeftSpacer()),m(".swipe-spacer.flex.items-center.pl-l.red",{oncreate:function(vnode){return _this._domSwipeSpacerRight=vnode.dom},tabindex:TabIndex.Programmatic,"aria-hidden":"true",style:{height:px(_this._config.rowHeight),transform:"translateY(-"+_this._config.rowHeight+"px)",position:"absolute","z-index":1,width:px(_this._width)}},_this._config.swipe.renderRightSpacer()),m("ul.list.list-alternate-background.fill-absolute.click",{oncreate:function(vnode){return _this._setDomList(vnode.dom)},style:{height:_this._calculateListHeight()},className:_this._config.className},[_this._virtualList.map(function(virtualRow){return m("li.list-row.pl.pr-l"+(styles.isDesktopLayout()&&_this._config.elementsDraggable?'[draggable="true"]':""),{tabindex:TabIndex.Default,oncreate:function(vnode){return _this._initRow(virtualRow,vnode.dom)},style:{transform:"translateY(-"+_this._config.rowHeight+"px)",paddingTop:px(15),paddingBottom:px(15)},ondragstart:function(event){return _this._dragstart(event,virtualRow)}},virtualRow.render())}),m("li#spinnerinlist.list-loading.list-row.flex-center.items-center.odd-row",{oncreate:function(vnode){_this._domLoadingRow=vnode.dom,_this._domLoadingRow.style.display=_this._displayingProgress?"":"none"}},progressIcon())]),m(ColumnEmptyMessageBox,{message:function(){return _this._config.emptyMessage},color:theme.list_message_bg,oncreate:function(vnode){_this._messageBoxDom=vnode.dom,_this._updateMessageBoxVisibility()}})]),_this._domInitialized.resolve(),_this._init()};if(client.isMobileDevice()){var _id=window.setTimeout(function(){return render()},DefaultAnimationTime);_this._renderCallback={type:"timeout",id:_id}}else{var _id2=window.requestAnimationFrame(function(){return render()});_this._renderCallback={type:"frame",id:_id2}}}});return _this._config.showStatus?m(".status-wrapper",[m(".status.flex.justify-between.fill-absolute",{style:{height:px(60)}},[m("div",[m(".bufferUp",{oncreate:function(vnode){return _this._domStatus.bufferUp=vnode.dom}}),m(".bufferDown",{oncreate:function(vnode){return _this._domStatus.bufferDown=vnode.dom}})]),m("div",[m(".scrollDiff",{oncreate:function(vnode){return _this._domStatus.scrollDiff=vnode.dom}})]),m("div",[m(".speed",{oncreate:function(vnode){return _this._domStatus.speed=vnode.dom}}),m(".time",{oncreate:function(vnode){return _this._domStatus.timeDiff=vnode.dom}})])]),m(".list-wrapper.fill-absolute",{style:{top:px(60)}},list)]):list}}return _createClass(List,[{key:"clear",value:function(){if(this._loadedEntities.length=0,this._loadedCompletely=!1,this._domList){this._domList.style.height=this._calculateListHeight();var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=this._virtualList[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var row=_step.value;row.domElement&&(row.domElement.style.display="none")}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}}},{key:"_initRow",value:function(virtualRow,domElement){var _this2=this,touchStartTime=void 0;virtualRow.domElement=domElement,domElement.onclick=function(e){(!touchStartTime||Date.now()-touchStartTime<400)&&virtualRow.entity&&_this2._elementClicked(virtualRow.entity,e)},domElement.onkeyup=function(e){isKeyPressed(e.keyCode,Keys.SPACE,Keys.RETURN)&&virtualRow.entity&&_this2._elementClicked(virtualRow.entity,e)};var timeoutId=void 0,touchStartCoords=void 0;domElement.addEventListener("touchstart",function(e){touchStartTime=Date.now(),_this2._config.multiSelectionAllowed&&(timeoutId=setTimeout(function(){_this2._mobileMultiSelectionActive=!0,virtualRow.entity&&!_this2.isEntitySelected(virtualRow.entity._id[1])?(_this2._selectedEntities.length=0,_this2._elementClicked(virtualRow.entity,e)):m.redraw()},400),touchStartCoords={x:e.touches[0].pageX,y:e.touches[0].pageY})});var touchEnd=function(){timeoutId&&clearTimeout(timeoutId)};domElement.addEventListener("touchend",touchEnd),domElement.addEventListener("touchcancel",touchEnd),domElement.addEventListener("touchmove",function(e){var touch=e.touches[0];touchStartCoords&&timeoutId&&(Math.abs(touch.pageX-touchStartCoords.x)>30||Math.abs(touch.pageY-touchStartCoords.y)>30)&&clearTimeout(timeoutId)}),applySafeAreaInsetMarginLR(domElement)}},{key:"_dragstart",value:function(ev,virtualRow){neverNull(ev.dataTransfer).setData("text",getLetId(neverNull(virtualRow.entity))[1])}},{key:"getEntity",value:function(id){return this._loadedEntities.find(function(entity){return getLetId(entity)[1]===id})}},{key:"_elementClicked",value:function(clickedEntity,event){var selectionChanged=!1,multiSelect=!1;if(this._config.multiSelectionAllowed&&(this._mobileMultiSelectionActive||(client.isMacOS?event.metaKey:event.ctrlKey)))selectionChanged=!0,multiSelect=!0,-1!==this._selectedEntities.indexOf(clickedEntity)?remove(this._selectedEntities,clickedEntity):this._selectedEntities.push(clickedEntity);else if(this._config.multiSelectionAllowed&&event.shiftKey)if(multiSelect=!0,0===this._selectedEntities.length)this._selectedEntities.push(clickedEntity),selectionChanged=!0;else if(1===this._selectedEntities.length&&this._selectedEntities[0]===clickedEntity);else{for(var clickedItemIndex=this._loadedEntities.indexOf(clickedEntity),nearestSelectedIndex=null,i=0;i<this._selectedEntities.length;i++){var currentSelectedItemIndex=this._loadedEntities.indexOf(this._selectedEntities[i]);(null==nearestSelectedIndex||Math.abs(clickedItemIndex-currentSelectedItemIndex)<Math.abs(clickedItemIndex-nearestSelectedIndex))&&(nearestSelectedIndex=currentSelectedItemIndex)}var itemsToAddToSelection=[];if(neverNull(nearestSelectedIndex)<clickedItemIndex)for(var _i=neverNull(nearestSelectedIndex)+1;_i<=clickedItemIndex;_i++)itemsToAddToSelection.push(this._loadedEntities[_i]);else for(var _i2=clickedItemIndex;_i2<neverNull(nearestSelectedIndex);_i2++)itemsToAddToSelection.push(this._loadedEntities[_i2]);addAll(this._selectedEntities,itemsToAddToSelection),selectionChanged=itemsToAddToSelection.length>0}else arrayEquals(this._selectedEntities,[clickedEntity])||(this._selectedEntities.splice(0,this._selectedEntities.length,clickedEntity),selectionChanged=!0);selectionChanged&&(this._selectedEntities.sort(this._config.sortCompare),this._reposition()),0===this._selectedEntities.length&&(this._mobileMultiSelectionActive=!1),this._elementSelected(this.getSelectedEntities(),!0,multiSelect)}},{key:"_entitySelected",value:function(entity,addToSelection){addToSelection?-1===this._selectedEntities.indexOf(entity)&&(this._selectedEntities.push(entity),this._selectedEntities.sort(this._config.sortCompare),this._reposition(),this._elementSelected(this.getSelectedEntities(),!1,!0)):((1!==this._selectedEntities.length||this._selectedEntities[0]!==entity)&&(this._selectedEntities=[entity],this._reposition()),0===this._selectedEntities.length&&(this._mobileMultiSelectionActive=!1),this._elementSelected(this.getSelectedEntities(),!1,!1))}},{key:"selectNext",value:function(shiftPressed){if(this._config.multiSelectionAllowed||(shiftPressed=!1),shiftPressed&&!0===this._lastMultiSelectWasKeyUp&&this._selectedEntities.length>1)this._selectedEntities.splice(0,1),this._reposition(),this._elementSelected(this.getSelectedEntities(),!1,!0),this._scrollToLoadedEntityAndSelect(this._selectedEntities[0],!0);else if(this._lastMultiSelectWasKeyUp=!1,0===this._selectedEntities.length&&this._loadedEntities.length>0)this._entitySelected(this._loadedEntities[0],shiftPressed);else if(0!==this._selectedEntities.length&&this._loadedEntities.length>0){var selectedIndex=this._loadedEntities.indexOf(last(this._selectedEntities));shiftPressed||selectedIndex!==this._loadedEntities.length-1||selectedIndex--,selectedIndex!==this._loadedEntities.length-1&&this._scrollToLoadedEntityAndSelect(this._loadedEntities[selectedIndex+1],shiftPressed)}}},{key:"selectPrevious",value:function(shiftPressed){if(this._config.multiSelectionAllowed||(shiftPressed=!1),shiftPressed&&!1===this._lastMultiSelectWasKeyUp&&this._selectedEntities.length>1){this._selectedEntities.splice(-1,1),this._reposition(),this._elementSelected(this.getSelectedEntities(),!1,!0);var lastEl=last(this._selectedEntities);lastEl&&this._scrollToLoadedEntityAndSelect(lastEl,!0)}else if(this._lastMultiSelectWasKeyUp=!0,0===this._selectedEntities.length&&this._loadedEntities.length>0)this._entitySelected(this._loadedEntities[0],shiftPressed);else if(0!==this._selectedEntities.length&&this._loadedEntities.length>0){var selectedIndex=this._loadedEntities.indexOf(this._selectedEntities[0]);shiftPressed||0!==selectedIndex||selectedIndex++,0!==selectedIndex&&this._scrollToLoadedEntityAndSelect(this._loadedEntities[selectedIndex-1],shiftPressed)}}},{key:"selectNone",value:function(){this._mobileMultiSelectionActive=!1,this._selectedEntities.length>0&&(this._selectedEntities=[],this._reposition(),this._elementSelected([],!1,!1))}},{key:"isEntitySelected",value:function(id){return null!=this._selectedEntities.find(function(entity){return getLetId(entity)[1]===id})}},{key:"getSelectedEntities",value:function(){return this._selectedEntities.slice()}},{key:"loadInitial",value:function(listElementId){var _this3=this;return listElementId?this.scrollToIdAndSelect(listElementId).then(function(entity){if(!entity)return _this3._loadMore().then(function(){return _this3._domInitialized.promise.then(function(){_this3._domList.style.height=_this3._calculateListHeight()})})}):this._loadMore().then(function(){return _this3._domInitialized.promise.then(function(){_this3._domList.style.height=_this3._calculateListHeight()})})}},{key:"_loadMore",value:function(){var _this4=this,startId=void 0;startId=0===this._loadedEntities.length?GENERATED_MAX_ID:getLetId(this._loadedEntities[this._loadedEntities.length-1])[1];return this.displaySpinner(0===this._loadedEntities.length&&styles.isUsingBottomNavigation()),this._loading=this._config.fetch(startId,100).then(function(newItems){var _loadedEntities;(_loadedEntities=_this4._loadedEntities).push.apply(_loadedEntities,_toConsumableArray(newItems)),_this4._loadedEntities.sort(_this4._config.sortCompare),newItems.length<100&&_this4.setLoadedCompletely()}).finally(function(){_this4.ready&&(_this4._displayingProgress=!1,_this4._domLoadingRow.style.display="none",_this4._reposition())}),neverNull(this._loading)}},{key:"_calculateListHeight",value:function(){return this._config.rowHeight*(this._loadedEntities.length+(this._loadedCompletely?0:1))+"px"}},{key:"setLoadedCompletely",value:function(){var _this5=this;this._loadedCompletely=!0,this._displayingProgress=!1,this._domInitialized.promise.then(function(){_this5._domLoadingRow.style.display="none"}),this._config.listLoadedCompletly&&this._config.listLoadedCompletly()}},{key:"displaySpinner",value:function(){var _this6=this,delayed=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],force=arguments[1];this._displayingProgress=!0,setTimeout(function(){!force&&_this6._loading.isFulfilled()||!_this6._domLoadingRow||(_this6._domLoadingRow.style.display="")},delayed?DefaultAnimationTime+16:5)}},{key:"_init",value:function(){var _this7=this;this._domListContainer.addEventListener("scroll",this._scrollListener,!!client.passive()&&{passive:!0}),window.requestAnimationFrame(function(){_this7._domList.style.height=_this7._calculateListHeight(),_this7._reposition(),_this7.ready=!0,client.isTouchSupported()&&_this7._config.swipe.enabled&&(_this7._swipeHandler=new ListSwipeHandler(_this7._domListContainer,_this7))})}},{key:"_setDomList",value:function(domElement){this._domList=domElement}},{key:"_createVirtualElements",value:function(){var visibleElements=2*Math.ceil(this._domListContainer.clientHeight/this._config.rowHeight/2);this._virtualList.length=visibleElements+2*ScrollBuffer,this._visibleElementsHeight=visibleElements*this._config.rowHeight;for(var i=0;i<this._virtualList.length;i++)this._virtualList[i]=this._config.createVirtualRow(),this._virtualList[i].top=i*this._config.rowHeight}},{key:"_scroll",value:function(){var _this8=this;if(0!==this._virtualList.length){var up=this.currentPosition<this.lastPosition,scrollDiff=up?this.lastPosition-this.currentPosition:this.currentPosition-this.lastPosition,now=window.performance.now(),timeDiff=Math.round(now-this.lastUpdateTime);this.lastUpdateTime=now;var rowHeight=this._config.rowHeight,topElement=this._virtualList[0],bottomElement=this._virtualList[this._virtualList.length-1];this._loadMoreIfNecessary();var status={bufferUp:Math.floor((this.currentPosition-topElement.top)/rowHeight),bufferDown:Math.floor((bottomElement.top+rowHeight-(this.currentPosition+this._visibleElementsHeight))/rowHeight),speed:Math.ceil(scrollDiff/timeDiff),scrollDiff:scrollDiff,timeDiff:timeDiff};if(this.updateStatus(status),this.lastPosition=this.currentPosition,this.updateLater)(scrollDiff<50||0===this.currentPosition||this.currentPosition+this._visibleElementsHeight===this._loadedEntities.length*rowHeight)&&(this.repositionTimeout&&clearTimeout(this.repositionTimeout),this._reposition());else if(status.bufferDown<=5&&this.currentPosition+this._visibleElementsHeight<this._loadedEntities.length*rowHeight-6*rowHeight||status.bufferUp<=5&&this.currentPosition>6*rowHeight)client.isDesktopDevice()?this._reposition():(log(Cat.debug,"list > update later (scrolling too fast)"),this.updateLater=!0,this.repositionTimeout=setTimeout(function(){return _this8._repositionAfterScrollStop()},110));else if(up)for(;bottomElement.top>this.currentPosition+this._visibleElementsHeight+this.bufferHeight&&topElement.top>0;){var _nextPosition=this._virtualList[0].top-rowHeight;if(_nextPosition>this.currentPosition)this._reposition();else{bottomElement.top=_nextPosition,bottomElement.domElement&&(bottomElement.domElement.style.transform="translateY("+bottomElement.top+"px)");var _pos=bottomElement.top/rowHeight,_entity=this._loadedEntities[_pos];this._updateVirtualRow(bottomElement,_entity,_pos%2),this._virtualList.unshift(this._virtualList.pop()),topElement=bottomElement,bottomElement=this._virtualList[this._virtualList.length-1]}}else for(;topElement.top+rowHeight<this.currentPosition-this.bufferHeight&&this._virtualList[this._virtualList.length-1].top<rowHeight*this._loadedEntities.length-rowHeight;){var nextPosition=this._virtualList[this._virtualList.length-1].top+rowHeight;if(nextPosition<this.currentPosition)this._reposition();else{topElement.top=nextPosition,topElement.domElement&&(topElement.domElement.style.transform="translateY("+topElement.top+"px)");var pos=topElement.top/rowHeight,entity=this._loadedEntities[pos];this._updateVirtualRow(topElement,entity,pos%2),this._virtualList.push(this._virtualList.shift()),bottomElement=topElement=this._virtualList[0]}}}}},{key:"_loadMoreIfNecessary",value:function(){var _this9=this;this.currentPosition>this._loadedEntities.length*this._config.rowHeight-2*this._visibleElementsHeight&&this._loading.isFulfilled()&&!this._loadedCompletely&&this._loadMore().then(function(){_this9._domList.style.height=_this9._calculateListHeight()})}},{key:"_repositionAfterScrollStop",value:function(){var _this10=this;window.performance.now()-this.lastUpdateTime>100?window.requestAnimationFrame(function(){return _this10._reposition()}):this.repositionTimeout=setTimeout(function(){return _this10._repositionAfterScrollStop()},110)}},{key:"_updateMessageBoxVisibility",value:function(){this._messageBoxDom&&(this._messageBoxDom.style.display=0===this._loadedEntities.length&&this._loadedCompletely&&""!==this._config.emptyMessage?"":"none")}},{key:"_reposition",value:function(){this._updateMessageBoxVisibility(),this.currentPosition=this._domListContainer.scrollTop;var rowHeight=this._config.rowHeight,maxStartPosition=rowHeight*this._loadedEntities.length-2*this.bufferHeight-this._visibleElementsHeight,nextPosition=this.currentPosition-this.currentPosition%rowHeight-this.bufferHeight;nextPosition<0?nextPosition=0:nextPosition>maxStartPosition&&(nextPosition=maxStartPosition);var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=this._virtualList[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var row=_step2.value;if(row.top=nextPosition,nextPosition+=rowHeight,!row.domElement)throw new Error("undefined dom element for virtual dom element "+this._virtualList.length+", "+row.top);row.domElement.style.transform="translateY("+row.top+"px)";var pos=row.top/rowHeight,entity=this._loadedEntities[pos];this._updateVirtualRow(row,entity,pos%2)}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}this._loadedEntities.length%2==0?this._domLoadingRow.classList.add("odd-row"):this._domLoadingRow.classList.remove("odd-row"),log(Cat.debug,"repositioned list"),this.updateLater=!1}},{key:"redraw",value:function(){this._reposition()}},{key:"_updateVirtualRow",value:function(row,entity,odd){row.entity=entity,row.domElement&&(odd?row.domElement.classList.remove("odd-row"):row.domElement.classList.add("odd-row"),entity?(row.domElement.style.display="list-item",row.update(entity,this.isEntitySelected(getLetId(entity)[1]))):row.domElement.style.display="none")}},{key:"updateStatus",value:function(status){this._domStatus.bufferUp&&(this._domStatus.bufferUp.textContent=status.bufferUp+""),this._domStatus.bufferDown&&(this._domStatus.bufferDown.textContent=status.bufferDown+""),this._domStatus.speed&&(this._domStatus.speed.textContent=status.speed+""),this._domStatus.scrollDiff&&(this._domStatus.scrollDiff.textContent=status.scrollDiff+""),this._domStatus.timeDiff&&(this._domStatus.timeDiff.textContent=status.timeDiff+"")}},{key:"scrollToIdAndSelectWhenReceived",value:function(listElementId){var entity=this.getEntity(listElementId);entity?this._scrollToLoadedEntityAndSelect(entity,!1):this._idOfEntityToSelectWhenReceived=listElementId}},{key:"scrollToIdAndSelect",value:function(listElementId){var _this11=this,entity=this.getEntity(listElementId);return entity?(this._scrollToLoadedEntityAndSelect(entity,!1),Promise.resolve(entity)):this._config.loadSingle(listElementId).then(function(entity){return entity?_this11._loadTill(listElementId).then(function(scrollTarget){return _this11._domInitialized.promise.then(function(){return _this11._domList.style.height=_this11._calculateListHeight(),null!=scrollTarget&&_this11._scrollToLoadedEntityAndSelect(scrollTarget,!1),scrollTarget})}):null}).catch(BadRequestError,function(e){console.log("invalid element id",listElementId,e)})}},{key:"_scrollToLoadedEntityAndSelect",value:function(scrollTarget,addToSelection){for(var _this12=this,i=0;i<this._virtualList.length;i++)if(this._virtualList[i].entity===scrollTarget){if(this._virtualList[i].top-this.currentPosition>0&&this._virtualList[i].top-this.currentPosition<this._visibleElementsHeight-this._config.rowHeight)return void this._entitySelected(scrollTarget,addToSelection);break}this._domInitialized.promise.then(function(){_this12._domListContainer.scrollTop=_this12._loadedEntities.indexOf(scrollTarget)*_this12._config.rowHeight,_this12._entitySelected(scrollTarget,addToSelection)})}},{key:"_loadTill",value:function(listElementId){var _this13=this,scrollTarget=this._loadedEntities.find(function(e){return getLetId(e)[1]===listElementId});return null!=scrollTarget||this._loadedCompletely||this._loadedEntities.length>0&&firstBiggerThanSecond(listElementId,getLetId(this._loadedEntities[this._loadedEntities.length-1])[1])?Promise.resolve(scrollTarget):this._loadMore().then(function(){return _this13._loadTill(listElementId)})}},{key:"entityEventReceived",value:function(elementId,operation){var _this14=this;return operation===OperationType.CREATE||operation===OperationType.UPDATE?this._config.loadSingle(elementId).then(function(entity){if(entity){var newEntity=neverNull(entity);return _this14._loading.then(function(){operation===OperationType.CREATE?_this14._loadedCompletely?_this14._addToLoadedEntities(newEntity):_this14._loadedEntities.length>0&&_this14._config.sortCompare(newEntity,neverNull(last(_this14._loadedEntities)))<0&&_this14._addToLoadedEntities(newEntity):operation===OperationType.UPDATE&&_this14._updateLoadedEntity(newEntity)})}}):operation===OperationType.DELETE?(this._swipeHandler?this._swipeHandler.animating:Promise.resolve()).then(function(){return _this14._deleteLoadedEntity(elementId)}):Promise.resolve()}},{key:"_addToLoadedEntities",value:function(entity){for(var i=0;i<this._loadedEntities.length;i++)if(getLetId(entity)[1]===getLetId(this._loadedEntities[i])[1])return;this._loadedEntities.push(entity),this._loadedEntities.sort(this._config.sortCompare),this.ready&&(this._domList.style.height=this._calculateListHeight(),this._reposition()),this._idOfEntityToSelectWhenReceived&&this._idOfEntityToSelectWhenReceived===getLetId(entity)[1]&&(this._idOfEntityToSelectWhenReceived=null,this._scrollToLoadedEntityAndSelect(entity,!1))}},{key:"_updateLoadedEntity",value:function(entity){for(var positionToUpdate=0;positionToUpdate<this._loadedEntities.length;positionToUpdate++)if(getLetId(entity)[1]===getLetId(this._loadedEntities[positionToUpdate])[1]){this._loadedEntities.splice(positionToUpdate,1,entity),this._loadedEntities.sort(this._config.sortCompare),this.ready&&this._reposition();break}for(var i=0;i<this._selectedEntities.length;i++)if(getLetId(entity)[1]===getLetId(this._selectedEntities[i])[1]){this._selectedEntities[i]=entity;break}}},{key:"_deleteLoadedEntity",value:function(elementId){var _this15=this;return this._loading.then(function(){var entity=_this15._loadedEntities.find(function(e){return getLetId(e)[1]===elementId});if(entity){var nextElementSelected=!1;if(1===_this15._selectedEntities.length&&_this15._selectedEntities[0]===entity&&_this15._loadedEntities.length>1){var nextSelection=entity===last(_this15._loadedEntities)?_this15._loadedEntities[_this15._loadedEntities.length-2]:_this15._loadedEntities[_this15._loadedEntities.indexOf(entity)+1];_this15._selectedEntities.push(nextSelection),nextElementSelected=!0}remove(_this15._loadedEntities,entity);var selectionChanged=remove(_this15._selectedEntities,entity);_this15.ready&&(_this15._domList.style.height=_this15._calculateListHeight(),_this15._reposition()),selectionChanged&&_this15._elementSelected(_this15.getSelectedEntities(),!1,!nextElementSelected),_this15._loadMoreIfNecessary()}})}},{key:"isMobileMultiSelectionActionActive",value:function(){return this._mobileMultiSelectionActive}},{key:"getLoadedEntities",value:function(){return this._loadedEntities}}]),List}()),_export("List",List),_export("ActionDistance",150),_export("ActionDistance",150),ListSwipeHandler=function(_SwipeHandler){function ListSwipeHandler(touchArea,list){_classCallCheck(this,ListSwipeHandler);var _this16=_possibleConstructorReturn(this,(ListSwipeHandler.__proto__||Object.getPrototypeOf(ListSwipeHandler)).call(this,touchArea));return _this16.list=list,_this16}return _inherits(ListSwipeHandler,SwipeHandler),_createClass(ListSwipeHandler,[{key:"onHorizontalDrag",value:function(xDelta,yDelta){var _this17=this;_get(ListSwipeHandler.prototype.__proto__||Object.getPrototypeOf(ListSwipeHandler.prototype),"onHorizontalDrag",this).call(this,xDelta,yDelta);var ve=this.getVirtualElement();window.requestAnimationFrame(function(){_this17.xoffset=xDelta<0?Math.max(xDelta,-150):Math.min(xDelta,150),_this17.animating.isFulfilled()&&ve&&ve.domElement&&ve.entity&&(ve.domElement.style.transform="translateX("+_this17.xoffset+"px) translateY("+ve.top+"px)",_this17.list._domSwipeSpacerLeft.style.transform="translateX("+(_this17.xoffset-_this17.list._width)+"px) translateY("+ve.top+"px)",_this17.list._domSwipeSpacerRight.style.transform="\n\t\t\t\ttranslateX("+(_this17.xoffset+_this17.list._width)+"px) translateY("+ve.top+"px)")})}},{key:"onHorizontalGestureCompleted",value:function(delta){if(this.virtualElement&&this.virtualElement.entity&&Math.abs(delta.x)>150){var entity=this.virtualElement.entity,swipePromise=void 0;return swipePromise=delta.x<0?this.list._config.swipe.swipeLeft(entity):this.list._config.swipe.swipeRight(entity),this.finish(getElementId(entity),swipePromise,delta)}return this.reset(delta)}},{key:"finish",value:function(id,swipeActionPromise,delta){var _this18=this;if(0!==this.xoffset){var ve=neverNull(this.virtualElement),listTargetPosition=this.xoffset<0?-this.list._width:this.list._width;return swipeActionPromise=swipeActionPromise.then(function(){return!0}).catch(function(){return!1}),Promise.all([ve.domElement&&animations.add(ve.domElement,transform(transform.type.translateX,this.xoffset,listTargetPosition).chain(transform.type.translateY,ve.top,ve.top),{easing:ease.inOut,duration:2*DefaultAnimationTime}),animations.add(this.list._domSwipeSpacerLeft,transform(transform.type.translateX,this.xoffset-this.list._width,listTargetPosition-this.list._width).chain(transform.type.translateY,ve.top,ve.top),{easing:ease.inOut,duration:2*DefaultAnimationTime}),animations.add(this.list._domSwipeSpacerRight,transform(transform.type.translateX,this.xoffset+this.list._width,listTargetPosition+this.list._width).chain(transform.type.translateY,ve.top,ve.top),{easing:ease.inOut,duration:2*DefaultAnimationTime})]).then(function(){return _this18.xoffset=listTargetPosition}).then(function(){return swipeActionPromise}).then(function(success){return success?_this18.list._deleteLoadedEntity(id).then(function(){return _this18.xoffset=0,ve.domElement&&(ve.domElement.style.transform="translateX("+_this18.xoffset+"px) translateY("+ve.top+"px)"),Promise.all([animations.add(_this18.list._domSwipeSpacerLeft,opacity(1,0,!0)),animations.add(_this18.list._domSwipeSpacerRight,opacity(1,0,!0))])}).then(function(){_this18.list._domSwipeSpacerLeft.style.transform="translateX("+(_this18.xoffset-_this18.list._width)+"px) translateY("+ve.top+"px)",_this18.list._domSwipeSpacerRight.style.transform="translateX("+(_this18.xoffset+_this18.list._width)+"px) translateY("+ve.top+"px)",_this18.list._domSwipeSpacerRight.style.opacity="",_this18.list._domSwipeSpacerLeft.style.opacity=""}):_this18.reset(delta)}).finally(function(){_this18.virtualElement=null})}return Promise.resolve()}},{key:"getVirtualElement",value:function(){if(!this.virtualElement){var touchAreaOffset=this.touchArea.getBoundingClientRect().top,relativeYposition=this.list.currentPosition+this.startPos.y-touchAreaOffset,targetElementPosition=Math.floor(relativeYposition/this.list._config.rowHeight)*this.list._config.rowHeight;this.virtualElement=this.list._virtualList.find(function(ve){return ve.top===targetElementPosition})}return this.virtualElement}},{key:"updateWidth",value:function(){this.list._domSwipeSpacerLeft.style.width=px(this.list._width),this.list._domSwipeSpacerRight.style.width=px(this.list._width),this.list._domSwipeSpacerLeft.style.transform="translateX("+-this.list._width+"px) translateY(0px)",this.list._domSwipeSpacerRight.style.transform="translateX("+this.list._width+"px) translateY(0px)",this.list._virtualList.forEach(function(element){element.domElement&&applySafeAreaInsetMarginLR(element.domElement)})}},{key:"reset",value:function(delta){try{if(0!==this.xoffset){var ve=this.virtualElement;if(ve&&ve.domElement&&ve.entity)return Promise.all([animations.add(ve.domElement,transform(transform.type.translateX,this.xoffset,0).chain(transform.type.translateY,ve.top,ve.top),{easing:ease.inOut}),animations.add(this.list._domSwipeSpacerLeft,transform(transform.type.translateX,this.xoffset-this.list._width,-this.list._width).chain(transform.type.translateY,ve.top,ve.top),{easing:ease.inOut}),animations.add(this.list._domSwipeSpacerRight,transform(transform.type.translateX,this.xoffset+this.list._width,this.list._width).chain(transform.type.translateY,ve.top,ve.top),{easing:ease.inOut})]);this.xoffset=0}}finally{this.virtualElement=null}return Promise.resolve()}}]),ListSwipeHandler}()}}}),System.register("src/gui/AlternateColors.js",["../api/Env"],function(_export,_context){"use strict";var assertMainOrNode,colors;return{setters:[function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode}],execute:function(){assertMainOrNode(),_export("colors",colors={alt_0:"#263238",alt_1:"#E91E63",alt_2:"#9C27B0",alt_3:"#673AB7",alt_4:"#3F51B5",alt_5:"#2196F3",alt_6:"#03A9F4",alt_7:"#00BCD4",alt_8:"#009688",alt_9:"#4CAF50",alt_10:"#8BC34A",alt_11:"#CDDC39",alt_12:"#FFEB3B",alt_13:"#FFC107",alt_14:"#FF9800",alt_15:"#FF5722",alt_16:"#795548",alt_17:"#9E9E9E",alt_18:"#607D8B",alt_19:"#880E4F",alt_20:"#4A148C",alt_21:"#311B92",alt_22:"#1A237E",alt_23:"#0D47A1",alt_24:"#01579B",alt_25:"#006064",alt_26:"#004D40",alt_27:"#1B5E20",alt_28:"#33691E",alt_29:"#827717",alt_30:"#F57F17",alt_31:"#FF6F00",alt_32:"#E65100",alt_33:"#BF360C",alt_34:"#3E2723",alt_35:"#212121"}),_export("colors",colors)}}}),System.register("src/gui/base/icons/FontIcons.js",[],function(_export,_context){"use strict";var FontIcons;return{setters:[],execute:function(){_export("FontIcons",FontIcons={Reply:"",Forward:"",Confidential:"",Attach:"",Warning:"",Folder:"",Inbox:"",Sent:"",Trash:"",Archive:"",Spam:"",Edit:""}),_export("FontIcons",FontIcons)}}}),System.register("src/gui/base/Badge.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,Badge;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default}],execute:function(){Badge=function(){function Badge(){_classCallCheck(this,Badge)}return _createClass(Badge,[{key:"view",value:function(vnode){return m(".b.teamLabel.pl-s.pr-s.border-radius.no-wrap"+(vnode.attrs.classes||""),vnode.children)}}]),Badge}(),_export("default",Badge)}}}),System.register("src/mail/MailListView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","node_modules/systemjs-plugin-babel/babel-helpers/defineProperty.js","mithril","../misc/Formatter","../misc/LanguageViewModel","../gui/base/List","../api/common/EntityFunctions","../api/main/Entity","../gui/AlternateColors","../api/common/TutanotaConstants","./MailView","../api/entities/tutanota/Mail","../api/Env","./MailUtils","./InboxRuleHandler","../api/common/error/RestError","../gui/size","../gui/base/Icon","../gui/base/icons/Icons","./MailModel","../api/main/LoginController","../gui/base/icons/FontIcons","../gui/base/Badge","../gui/base/ButtonN","../gui/base/Dialog","../api/entities/monitor/Services","../api/entities/monitor/WriteCounterData","../api/common/utils/Utils","../api/main/WorkerClient"],function(_export,_context){"use strict";var _classCallCheck,_createClass,_defineProperty,m,formatDateTimeFromYesterdayOn,lang,List,HttpMethod,sortCompareByReverseId,load,loadRange,serviceRequestVoid,colors,CounterType_UnreadMails,getMailFolderType,MailFolderType,ReplyType,MailTypeRef,assertMainOrNode,getArchiveFolder,getFolderName,getInboxFolder,getSenderOrRecipientHeading,isTutanotaTeamMail,showDeleteConfirmationDialog,findAndApplyMatchingRule,isInboxList,NotFoundError,px,size,Icon,Icons,mailModel,logins,FontIcons,Badge,ButtonColors,ButtonN,ButtonType,Dialog,MonitorService,createWriteCounterData,debounce,worker,_iconMap,className,iconMap,MailListView,MailRow;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersDefinePropertyJs){_defineProperty=_node_modulesSystemjsPluginBabelBabelHelpersDefinePropertyJs.default},function(_mithril){m=_mithril.default},function(_miscFormatter){formatDateTimeFromYesterdayOn=_miscFormatter.formatDateTimeFromYesterdayOn},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseList){List=_guiBaseList.List},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod,sortCompareByReverseId=_apiCommonEntityFunctions.sortCompareByReverseId},function(_apiMainEntity){load=_apiMainEntity.load,loadRange=_apiMainEntity.loadRange,serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_guiAlternateColors){colors=_guiAlternateColors.colors},function(_apiCommonTutanotaConstants){CounterType_UnreadMails=_apiCommonTutanotaConstants.CounterType_UnreadMails,getMailFolderType=_apiCommonTutanotaConstants.getMailFolderType,MailFolderType=_apiCommonTutanotaConstants.MailFolderType,ReplyType=_apiCommonTutanotaConstants.ReplyType},function(_MailView){_MailView.MailView},function(_apiEntitiesTutanotaMail){MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_MailUtils){getArchiveFolder=_MailUtils.getArchiveFolder,getFolderName=_MailUtils.getFolderName,getInboxFolder=_MailUtils.getInboxFolder,getSenderOrRecipientHeading=_MailUtils.getSenderOrRecipientHeading,isTutanotaTeamMail=_MailUtils.isTutanotaTeamMail,showDeleteConfirmationDialog=_MailUtils.showDeleteConfirmationDialog},function(_InboxRuleHandler){findAndApplyMatchingRule=_InboxRuleHandler.findAndApplyMatchingRule,isInboxList=_InboxRuleHandler.isInboxList},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiSize){px=_guiSize.px,size=_guiSize.size},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_MailModel){mailModel=_MailModel.mailModel},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseIconsFontIcons){FontIcons=_guiBaseIconsFontIcons.FontIcons},function(_guiBaseBadge){Badge=_guiBaseBadge.default},function(_guiBaseButtonN){ButtonColors=_guiBaseButtonN.ButtonColors,ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiEntitiesMonitorServices){MonitorService=_apiEntitiesMonitorServices.MonitorService},function(_apiEntitiesMonitorWriteCounterData){createWriteCounterData=_apiEntitiesMonitorWriteCounterData.createWriteCounterData},function(_apiCommonUtilsUtils){debounce=_apiCommonUtilsUtils.debounce},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker}],execute:function(){assertMainOrNode(),className="mail-list",_defineProperty(_iconMap={},MailFolderType.CUSTOM,FontIcons.Folder),_defineProperty(_iconMap,MailFolderType.INBOX,FontIcons.Inbox),_defineProperty(_iconMap,MailFolderType.SENT,FontIcons.Sent),_defineProperty(_iconMap,MailFolderType.TRASH,FontIcons.Trash),_defineProperty(_iconMap,MailFolderType.ARCHIVE,FontIcons.Archive),_defineProperty(_iconMap,MailFolderType.SPAM,FontIcons.Spam),_defineProperty(_iconMap,MailFolderType.DRAFT,FontIcons.Edit),iconMap=_iconMap,_export("MailListView",MailListView=function(){function MailListView(mailListId,mailView){var _this=this;_classCallCheck(this,MailListView),this._fixCounterIfNeeded=debounce(2e3,function(listId,listLength){if(_this.listId===listId&&"connected"===worker.wsConnection()()&&listLength===_this.list.getLoadedEntities().length){var unreadMails=_this.list.getLoadedEntities().reduce(function(acc,mail){return mail.unread&&acc++,acc},0);mailModel.getCounterValue(_this.listId).then(function(counterValue){null!=counterValue&&counterValue!==unreadMails&&mailModel.getMailboxDetailsForMailListId(_this.listId).then(function(mailboxDetails){var data=createWriteCounterData({counterType:CounterType_UnreadMails,row:mailboxDetails.mailGroup._id,column:_this.listId,value:String(unreadMails)});serviceRequestVoid(MonitorService.CounterService,HttpMethod.POST,data)})})}}),this.listId=mailListId,this.mailView=mailView,this.list=new List({rowHeight:size.list_row_height,fetch:function(start,count){return _this._loadMailRange(start,count)},loadSingle:function(elementId){return load(MailTypeRef,[_this.listId,elementId]).catch(NotFoundError,function(e){})},sortCompare:sortCompareByReverseId,elementSelected:function(entities,elementClicked,selectionChanged,multiSelectionActive){return mailView.elementSelected(entities,elementClicked,selectionChanged,multiSelectionActive)},createVirtualRow:function(){return new MailRow(!1)},showStatus:!1,className:className,swipe:{renderLeftSpacer:function(){return logins.isInternalUserLoggedIn()?[m(Icon,{icon:Icons.Folder}),m(".pl-s",_this.targetInbox()?lang.get("received_action"):lang.get("archive_action"))]:[]},renderRightSpacer:function(){return[m(Icon,{icon:Icons.Folder}),m(".pl-s",lang.get("delete_action"))]},swipeLeft:function(listElement){return showDeleteConfirmationDialog([listElement]).then(function(confirmed){if(!0!==confirmed)return Promise.resolve();_this.list.selectNone(),mailModel.deleteMails([listElement])})},swipeRight:function(listElement){return logins.isInternalUserLoggedIn()?_this.targetInbox()?(_this.list.selectNone(),mailModel.getMailboxFolders(listElement).then(function(folders){return mailModel.moveMails([listElement],getInboxFolder(folders))})):(_this.list.selectNone(),mailModel.getMailboxFolders(listElement).then(function(folders){return mailModel.moveMails([listElement],getArchiveFolder(folders))})):Promise.resolve()},enabled:!0},elementsDraggable:!0,multiSelectionAllowed:!0,emptyMessage:lang.get("noMails_msg"),listLoadedCompletly:function(){return _this._fixCounterIfNeeded(_this.listId,_this.list.getLoadedEntities().length)}})}return _createClass(MailListView,[{key:"view",value:function(){var _this2=this,folder=this.mailView.selectedFolder,purgeButtonAttrs={label:"clearFolder_action",type:ButtonType.Primary,colors:ButtonColors.Nav,click:function(){null!=folder?Dialog.confirm(function(){return lang.get("confirmDeleteFinallySystemFolder_msg",{"{1}":getFolderName(folder)})}).then(function(confirmed){confirmed&&_this2.mailView._finallyDeleteAllMailsInSelectedFolder(folder)}):console.warn("Cannot delete folder, no folder is selected")}};return this.showingTrashOrSpamFolder()?m(".flex.flex-column.fill-absolute",[m(".flex.flex-column.justify-center.plr-l.list-border-right.list-bg.list-header",[m(".small.flex-grow.pt",lang.get("storageDeletion_msg")),m(".mr-negative-s.align-self-end",m(ButtonN,purgeButtonAttrs))]),m(".rel.flex-grow",m(this.list))]):m(this.list)}},{key:"targetInbox",value:function(){return!!this.mailView.selectedFolder&&(this.mailView.selectedFolder.folderType===MailFolderType.ARCHIVE||this.mailView.selectedFolder.folderType===MailFolderType.TRASH)}},{key:"showingTrashOrSpamFolder",value:function(){return!!this.mailView.selectedFolder&&(this.mailView.selectedFolder.folderType===MailFolderType.SPAM||this.mailView.selectedFolder.folderType===MailFolderType.TRASH)}},{key:"_loadMailRange",value:function(start,count){var _this3=this;return loadRange(MailTypeRef,this.listId,start,count,!0).then(function(mails){return mailModel.getMailboxDetailsForMailListId(_this3.listId).then(function(mailboxDetail){return isInboxList(mailboxDetail,_this3.listId)?Promise.filter(mails,function(mail){return findAndApplyMatchingRule(mailboxDetail,mail).then(function(matchingMailId){return!matchingMailId})}).then(function(inboxMails){return mails.length===count&&inboxMails.length<mails.length?_this3._loadMailRange(mails[mails.length-1]._id[1],mails.length-inboxMails.length).then(function(filteredMails){return inboxMails.concat(filteredMails)}):inboxMails}):mails})})}}]),MailListView}()),_export("MailListView",MailListView),_export("MailRow",MailRow=function(){function MailRow(showFolderIcon){_classCallCheck(this,MailRow),this.top=0,this.entity=null,this._showFolderIcon=showFolderIcon,this._domFolderIcons={}}return _createClass(MailRow,[{key:"stringToPicto",value:function(s){var color=(s.charCodeAt(0)+s.charCodeAt(s.length-1)+s.length)%36;return{capitalLetter:(s=s.trim()).charAt(0).toUpperCase(),color:colors["alt_"+color]}}},{key:"update",value:function(mail,selected){this.domElement&&(selected?(this.domElement.classList.add("row-selected"),this._iconsDom.classList.add("secondary")):(this.domElement.classList.remove("row-selected"),this._iconsDom.classList.remove("secondary")),this._iconsDom.textContent=this._iconsText(mail),this._domDate.textContent=formatDateTimeFromYesterdayOn(mail.receivedDate),this._domSender.textContent=getSenderOrRecipientHeading(mail,!0),this._domSubject.textContent=mail.subject,mail.unread?(this._domUnread.classList.remove("hidden"),this._domSubject.classList.add("b")):(this._domUnread.classList.add("hidden"),this._domSubject.classList.remove("b")),isTutanotaTeamMail(mail)?this._domTeamLabel.style.display="":this._domTeamLabel.style.display="none")}},{key:"_iconsText",value:function(mail){var iconText="";if(this._showFolderIcon){var folder=mailModel.getMailFolder(mail._id[0]);iconText+=folder?this._getFolderIcon(getMailFolderType(folder)):""}switch(iconText+=mail._errors?FontIcons.Warning:"",mail.replyType){case ReplyType.REPLY:iconText+=FontIcons.Reply;break;case ReplyType.FORWARD:iconText+=FontIcons.Forward;break;case ReplyType.REPLY_FORWARD:iconText+=FontIcons.Reply,iconText+=FontIcons.Forward}return mail.confidential&&(iconText+=FontIcons.Confidential),mail.attachments.length>0&&(iconText+=FontIcons.Attach),iconText}},{key:"render",value:function(){var _this4=this;return m(".flex",[m(".flex.items-start.flex-no-grow.no-shrink.pr-s.pb-xs",m(".circle.bg-accent-fg.hidden",{oncreate:function(vnode){return _this4._domUnread=vnode.dom}})),m(".flex-grow.min-width-0",[m(".top.flex.badge-line-height",[m(Badge,{classes:".small.mr-s",oncreate:function(vnode){return _this4._domTeamLabel=vnode.dom}},"Tutanota Team"),m("small.text-ellipsis",{oncreate:function(vnode){return _this4._domSender=vnode.dom}}),m(".flex-grow"),m("small.text-ellipsis.flex-fixed",{oncreate:function(vnode){return _this4._domDate=vnode.dom}})]),m(".bottom.flex-space-between",{style:{marginTop:px(2)}},[m(".text-ellipsis.flex-grow",{oncreate:function(vnode){return _this4._domSubject=vnode.dom}}),m("span.ion.ml-s.list-font-icons.secondary",{oncreate:function(vnode){return _this4._iconsDom=vnode.dom}})])])])}},{key:"_getFolderIcon",value:function(type){return iconMap[type]}}]),MailRow}()),_export("MailRow",MailRow)}}}),System.register("src/api/common/error/UserError.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/possibleConstructorReturn.js","node_modules/systemjs-plugin-babel/babel-helpers/inherits.js","./TutanotaError"],function(_export,_context){"use strict";var _classCallCheck,_possibleConstructorReturn,_inherits,TutanotaError,UserError;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersPossibleConstructorReturnJs){_possibleConstructorReturn=_node_modulesSystemjsPluginBabelBabelHelpersPossibleConstructorReturnJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersInheritsJs){_inherits=_node_modulesSystemjsPluginBabelBabelHelpersInheritsJs.default},function(_TutanotaError2){TutanotaError=_TutanotaError2.TutanotaError}],execute:function(){_export("UserError",UserError=function(_TutanotaError){function UserError(m){return _classCallCheck(this,UserError),_possibleConstructorReturn(this,(UserError.__proto__||Object.getPrototypeOf(UserError)).call(this,"UserError",m))}return _inherits(UserError,TutanotaError),UserError}()),_export("UserError",UserError)}}}),System.register("src/contacts/ContactEditor.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","../gui/base/Dialog","../gui/base/Button","../gui/base/TextField","../misc/LanguageViewModel","../misc/Formatter","../misc/FormatValidator","./ContactUtils","../api/common/TutanotaConstants","../gui/animation/Animations","../api/main/Entity","../api/entities/tutanota/ContactMailAddress","../api/entities/tutanota/ContactPhoneNumber","../api/entities/tutanota/ContactAddress","../api/entities/tutanota/ContactSocialId","../api/entities/tutanota/Contact","../api/common/EntityFunctions","../api/common/utils/Utils","../api/Env","../api/common/utils/ArrayUtils","../misc/WindowFacade","../api/main/LoginController","../gui/base/icons/Icons","../api/entities/tutanota/Birthday","../api/common/error/RestError","../gui/base/ButtonN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,Dialog,Button,createDropDownButton,TextField,Type,lang,parseBirthday,isMailAddress,ContactMailAddressTypeToLabel,ContactPhoneNumberTypeToLabel,ContactSocialTypeToLabel,formatBirthdayNumeric,getContactAddressTypeLabel,getContactPhoneNumberTypeLabel,getContactSocialTypeLabel,migrateToNewBirthday,ContactAddressType,ContactPhoneNumberType,ContactSocialType,GroupType,Keys,animations,DefaultAnimationTime,height,opacity,setup,update,ContactMailAddressTypeRef,createContactMailAddress,ContactPhoneNumberTypeRef,createContactPhoneNumber,ContactAddressTypeRef,createContactAddress,ContactSocialIdTypeRef,createContactSocialId,createContact,isSameTypeRef,clone,identity,neverNull,noOp,assertMainOrNode,remove,windowFacade,logins,Icons,createBirthday,NotFoundError,ButtonType,ContactEditor,ContactAggregateEditor;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_guiBaseButton){Button=_guiBaseButton.Button,createDropDownButton=_guiBaseButton.createDropDownButton},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField,Type=_guiBaseTextField.Type},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_miscFormatter){parseBirthday=_miscFormatter.parseBirthday},function(_miscFormatValidator){isMailAddress=_miscFormatValidator.isMailAddress},function(_ContactUtils){ContactMailAddressTypeToLabel=_ContactUtils.ContactMailAddressTypeToLabel,ContactPhoneNumberTypeToLabel=_ContactUtils.ContactPhoneNumberTypeToLabel,ContactSocialTypeToLabel=_ContactUtils.ContactSocialTypeToLabel,formatBirthdayNumeric=_ContactUtils.formatBirthdayNumeric,getContactAddressTypeLabel=_ContactUtils.getContactAddressTypeLabel,getContactPhoneNumberTypeLabel=_ContactUtils.getContactPhoneNumberTypeLabel,getContactSocialTypeLabel=_ContactUtils.getContactSocialTypeLabel,migrateToNewBirthday=_ContactUtils.migrateToNewBirthday},function(_apiCommonTutanotaConstants){ContactAddressType=_apiCommonTutanotaConstants.ContactAddressType,ContactPhoneNumberType=_apiCommonTutanotaConstants.ContactPhoneNumberType,ContactSocialType=_apiCommonTutanotaConstants.ContactSocialType,GroupType=_apiCommonTutanotaConstants.GroupType,Keys=_apiCommonTutanotaConstants.Keys},function(_guiAnimationAnimations){animations=_guiAnimationAnimations.animations,DefaultAnimationTime=_guiAnimationAnimations.DefaultAnimationTime,height=_guiAnimationAnimations.height,opacity=_guiAnimationAnimations.opacity},function(_apiMainEntity){setup=_apiMainEntity.setup,update=_apiMainEntity.update},function(_apiEntitiesTutanotaContactMailAddress){ContactMailAddressTypeRef=_apiEntitiesTutanotaContactMailAddress.ContactMailAddressTypeRef,createContactMailAddress=_apiEntitiesTutanotaContactMailAddress.createContactMailAddress},function(_apiEntitiesTutanotaContactPhoneNumber){ContactPhoneNumberTypeRef=_apiEntitiesTutanotaContactPhoneNumber.ContactPhoneNumberTypeRef,createContactPhoneNumber=_apiEntitiesTutanotaContactPhoneNumber.createContactPhoneNumber},function(_apiEntitiesTutanotaContactAddress){ContactAddressTypeRef=_apiEntitiesTutanotaContactAddress.ContactAddressTypeRef,createContactAddress=_apiEntitiesTutanotaContactAddress.createContactAddress},function(_apiEntitiesTutanotaContactSocialId){ContactSocialIdTypeRef=_apiEntitiesTutanotaContactSocialId.ContactSocialIdTypeRef,createContactSocialId=_apiEntitiesTutanotaContactSocialId.createContactSocialId},function(_apiEntitiesTutanotaContact){createContact=_apiEntitiesTutanotaContact.createContact},function(_apiCommonEntityFunctions){isSameTypeRef=_apiCommonEntityFunctions.isSameTypeRef},function(_apiCommonUtilsUtils){clone=_apiCommonUtilsUtils.clone,identity=_apiCommonUtilsUtils.identity,neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiCommonUtilsArrayUtils){remove=_apiCommonUtilsArrayUtils.remove},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiEntitiesTutanotaBirthday){createBirthday=_apiEntitiesTutanotaBirthday.createBirthday},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType}],execute:function(){assertMainOrNode(),_export("ContactEditor",ContactEditor=function(){function ContactEditor(contact,listId,newContactIdReceiver){var _this=this;if(_classCallCheck(this,ContactEditor),this.contact=contact?clone(contact):createContact(),migrateToNewBirthday(this.contact),this._newContactIdReceiver=newContactIdReceiver,null==contact&&null==listId)throw new Error("must provide contact to edit or listId for the new contact");this.listId=listId||neverNull(contact)._id[0];var firstName=new TextField("firstName_placeholder").setValue(this.contact.firstName).onUpdate(function(value){return _this.contact.firstName=value}),nickname=new TextField("nickname_placeholder").setValue(this.contact.nickname).onUpdate(function(value){return _this.contact.nickname=value}),lastName=new TextField("lastName_placeholder").setValue(this.contact.lastName).onUpdate(function(value){return _this.contact.lastName=value}),name=stream.merge([firstName.value,lastName.value]).map(function(names){return names.join(" ")});this.invalidBirthday=!1;this.birthday=new TextField("birthday_alt",function(){var bday=createBirthday();return bday.day="22",bday.month="9",bday.year="2000",_this.invalidBirthday?lang.get("invalidDateFormat_msg",{"{1}":formatBirthdayNumeric(bday)}):""}).setValue(this.contact.birthday?formatBirthdayNumeric(this.contact.birthday):"").onUpdate(function(value){if(0===value.trim().length)_this.contact.birthday=null,_this.invalidBirthday=!1;else{var birthday=parseBirthday(value);birthday?(_this.contact.birthday=birthday,_this.invalidBirthday=!1):_this.invalidBirthday=!0}});var comment=new TextField("comment_label").setType(Type.Area).setValue(this.contact.comment).onUpdate(function(value){return _this.contact.comment=value}),company=new TextField("company_label").setValue(this.contact.company).onUpdate(function(value){return _this.contact.company=value}),role=new TextField("role_placeholder").setValue(this.contact.role).onUpdate(function(value){return _this.contact.role=value}),title=new TextField("title_placeholder").setValue(this.contact.title).onUpdate(function(value){return _this.contact.title=value});this.mailAddressEditors=this.contact.mailAddresses.map(function(ma){return new ContactAggregateEditor(ma,function(e){return remove(_this.mailAddressEditors,e)})}),this.createNewMailAddressEditor(),this.phoneEditors=this.contact.phoneNumbers.map(function(p){return new ContactAggregateEditor(p,function(e){return remove(_this.phoneEditors,e)})}),this.createNewPhoneEditor(),this.addressEditors=this.contact.addresses.map(function(p){return new ContactAggregateEditor(p,function(e){return remove(_this.addressEditors,e)})}),this.createNewAddressEditor(),this.socialEditors=this.contact.socialIds.map(function(p){return new ContactAggregateEditor(p,function(e){return remove(_this.socialEditors,e)})}),this.createNewSocialEditor();var presharedPassword=this.contact.presharedPassword||!contact?new TextField("password_label").setValue(this.contact.presharedPassword).onUpdate(function(value){return _this.contact.presharedPassword=value}):null,headerBarAttrs={left:[{label:"close_alt",click:function(e,dom){return _this._close()},type:ButtonType.Secondary}],middle:name,right:[{label:"save_action",click:function(){return _this.save()},type:ButtonType.Primary}]},windowCloseUnsubscribe=function(){};this.view=function(){return m("#contact-editor",{oncreate:function(){windowCloseUnsubscribe=windowFacade.addWindowCloseListener(function(){})},onremove:function(){return windowCloseUnsubscribe()}},[m(".wrapping-row",[m(firstName),m(lastName)]),m(".wrapping-row",[m(title),m(_this.birthday)]),m(".wrapping-row",[m(role),m(company),m(nickname),m(comment)]),m(".wrapping-row",[m(".mail.mt-xl",[m(".h4",lang.get("email_label")),m(".aggregateEditors",[_this.mailAddressEditors.map(function(editor){return m(editor,{key:editor.id})})])]),m(".phone.mt-xl",[m(".h4",lang.get("phone_label")),m(".aggregateEditors",[_this.phoneEditors.map(function(editor){return m(editor,{key:editor.id})})])])]),m(".wrapping-row",[m(".address.mt-xl",[m(".h4",lang.get("address_label")),m(".aggregateEditors",[_this.addressEditors.map(function(editor){return m(editor,{key:editor.id})})])]),m(".social.mt-xl",[m(".h4",lang.get("social_label")),m(".aggregateEditors",[_this.socialEditors.map(function(editor){return m(editor,{key:editor.id})})])])]),presharedPassword?m(".wrapping-row",[m(".passwords.mt-xl",[m(".h4",lang.get("presharedPassword_label")),m(presharedPassword)]),m(".spacer")]):null,m(".pb")])},this.dialog=Dialog.largeDialog(headerBarAttrs,this).addShortcut({key:Keys.ESC,exec:function(){return _this._close()},help:"close_alt"}).addShortcut({key:Keys.S,ctrl:!0,exec:function(){return _this.save()},help:"save_action"}).setCloseHandler(function(){return _this._close()})}return _createClass(ContactEditor,[{key:"show",value:function(){this.dialog.show()}},{key:"_close",value:function(){this.dialog.close()}},{key:"save",value:function(){var _this2=this;if(this.invalidBirthday)Dialog.error("invalidBirthday_msg");else{this.contact.mailAddresses=this.mailAddressEditors.filter(function(e){return e.isInitialized}).map(function(e){return e.aggregate}),this.contact.phoneNumbers=this.phoneEditors.filter(function(e){return e.isInitialized}).map(function(e){return e.aggregate}),this.contact.addresses=this.addressEditors.filter(function(e){return e.isInitialized}).map(function(e){return e.aggregate}),this.contact.socialIds=this.socialEditors.filter(function(e){return e.isInitialized}).map(function(e){return e.aggregate});var promise=void 0;this.contact._id?promise=update(this.contact).catch(NotFoundError,noOp):(this.contact._area="0",this.contact.autoTransmitPassword="",this.contact._owner=logins.getUserController().user._id,this.contact._ownerGroup=neverNull(logins.getUserController().user.memberships.find(function(m){return m.groupType===GroupType.Contact})).group,promise=setup(this.listId,this.contact).then(function(contactId){_this2._newContactIdReceiver&&_this2._newContactIdReceiver(contactId)})),promise.then(function(){return _this2._close()})}}},{key:"createNewMailAddressEditor",value:function(){var _this3=this,a=createContactMailAddress();a.type=ContactAddressType.WORK,a.customTypeName="",a.address="";var editor=new ContactAggregateEditor(a,function(e){return remove(_this3.mailAddressEditors,e)},!0,!1),value=editor.textfield.value.map(identity);value.map(function(address){address.trim().length>0&&(editor.isInitialized=!0,editor.animateCreate=!1,_this3.createNewMailAddressEditor(),value.end(!0))}),this.mailAddressEditors.push(editor)}},{key:"createNewPhoneEditor",value:function(){var _this4=this,a=createContactPhoneNumber();a.type=ContactPhoneNumberType.MOBILE,a.customTypeName="",a.number="";var editor=new ContactAggregateEditor(a,function(e){return remove(_this4.phoneEditors,e)},!0,!1),value=editor.textfield.value.map(identity);value.map(function(address){address.trim().length>0&&(editor.isInitialized=!0,editor.animateCreate=!1,_this4.createNewPhoneEditor(),value.end(!0))}),this.phoneEditors.push(editor)}},{key:"createNewAddressEditor",value:function(){var _this5=this,a=createContactAddress();a.type=ContactAddressType.WORK,a.customTypeName="",a.address="";var editor=new ContactAggregateEditor(a,function(e){return remove(_this5.addressEditors,e)},!0,!1),value=editor.textfield.value.map(identity);value.map(function(address){address.trim().length>0&&(editor.isInitialized=!0,editor.animateCreate=!1,_this5.createNewAddressEditor(),value.end(!0))}),this.addressEditors.push(editor)}},{key:"createNewSocialEditor",value:function(){var _this6=this,a=createContactSocialId();a.type=ContactSocialType.TWITTER,a.customTypeName="",a.socialId="";var editor=new ContactAggregateEditor(a,function(e){return remove(_this6.socialEditors,e)},!0,!1),value=editor.textfield.value.map(identity);value.map(function(address){address.trim().length>0&&(editor.isInitialized=!0,editor.animateCreate=!1,_this6.createNewSocialEditor(),value.end(!0))}),this.socialEditors.push(editor)}}]),ContactEditor}()),_export("ContactEditor",ContactEditor),ContactAggregateEditor=function(){function ContactAggregateEditor(aggregate,cancelAction){var _this7=this,animateCreate=arguments.length>2&&void 0!==arguments[2]&&arguments[2],allowCancel=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];_classCallCheck(this,ContactAggregateEditor),this.aggregate=aggregate,this.isInitialized=allowCancel,this.animateCreate=animateCreate,this.id=aggregate._id||String(Date.now());var value="",onUpdate=function(){},label="",isCustom=function(type){return!1},TypeToLabelMap={};isSameTypeRef(aggregate._type,ContactMailAddressTypeRef)||isSameTypeRef(aggregate._type,ContactAddressTypeRef)?(value=aggregate.address,onUpdate=function(value){return aggregate.address=value},label=function(){return getContactAddressTypeLabel(_this7.aggregate.type,_this7.aggregate.customTypeName)},isCustom=function(type){return type===ContactAddressType.CUSTOM},TypeToLabelMap=ContactMailAddressTypeToLabel):isSameTypeRef(aggregate._type,ContactPhoneNumberTypeRef)?(value=aggregate.number,onUpdate=function(value){return aggregate.number=value},label=function(){return getContactPhoneNumberTypeLabel(_this7.aggregate.type,_this7.aggregate.customTypeName)},isCustom=function(type){return type===ContactPhoneNumberType.CUSTOM},TypeToLabelMap=ContactPhoneNumberTypeToLabel):isSameTypeRef(aggregate._type,ContactSocialIdTypeRef)&&(value=aggregate.socialId,onUpdate=function(value){return aggregate.socialId=value},label=function(){return getContactSocialTypeLabel(_this7.aggregate.type,_this7.aggregate.customTypeName)},isCustom=function(type){return type===ContactSocialType.CUSTOM},TypeToLabelMap=ContactSocialTypeToLabel),this.textfield=new TextField(label,function(){return isSameTypeRef(aggregate._type,ContactMailAddressTypeRef)&&_this7.textfield.value().trim().length>0&&!isMailAddress(_this7.textfield.value().trim(),!1)?lang.get("invalidInputFormat_msg"):lang.get("emptyString_msg")}).setValue(value).onUpdate(onUpdate),isSameTypeRef(aggregate._type,ContactAddressTypeRef)&&this.textfield.setType(Type.Area);var typeButton=createDropDownButton("more_label",function(){return Icons.More},function(){return Object.keys(TypeToLabelMap).map(function(key){return new Button(TypeToLabelMap[key],function(e){isCustom(key)?setTimeout(function(){Dialog.showTextInputDialog("customLabel_label","customLabel_label",null,_this7.aggregate.customTypeName,null).then(function(name){_this7.aggregate.customTypeName=name,_this7.aggregate.type=key})},DefaultAnimationTime):_this7.aggregate.type=key}).setType(ButtonType.Dropdown)})}),cancelButton=new Button("cancel_action",function(){return cancelAction(_this7)},function(){return Icons.Cancel});this.textfield._injectionsRight=function(){return[m(typeButton),_this7.isInitialized?m(cancelButton,{oncreate:function(vnode){return vnode.dom.style.opacity=0,animations.add(vnode.dom,opacity(0,1,!0))}}):null]},this.oncreate=function(vnode){_this7.animateCreate&&_this7.animate(vnode.dom,!0)},this.onbeforeremove=function(vnode){return _this7.animate(vnode.dom,!1)},this.view=function(){return m(".wrapper.child-grow",m(_this7.textfield))}}return _createClass(ContactAggregateEditor,[{key:"animate",value:function(domElement,fadein){var childHeight=domElement.offsetHeight;return fadein&&(domElement.style.opacity="0"),Promise.all([animations.add(domElement,fadein?opacity(0,1,!0):opacity(1,0,!0)),animations.add(domElement,fadein?height(0,childHeight):height(childHeight,0)).then(function(){domElement.style.height=""})])}}]),ContactAggregateEditor}()}}}),System.register("src/gui/base/BubbleTextField.js",["node_modules/systemjs-plugin-babel/babel-helpers/toConsumableArray.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../size","mithril","./TextField","./../animation/Animations","../../api/Env","./Icon","./ButtonN"],function(_export,_context){"use strict";var _toConsumableArray,_classCallCheck,_createClass,size,m,TextField,animations,height,assertMainOrNode,progressIcon,ButtonN,isSelected,BubbleTextField,Bubble;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs){_toConsumableArray=_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_size){size=_size.size},function(_mithril){m=_mithril.default},function(_TextField){TextField=_TextField.TextField},function(_animationAnimations){animations=_animationAnimations.animations,height=_animationAnimations.height},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_Icon){progressIcon=_Icon.progressIcon},function(_ButtonN){ButtonN=_ButtonN.ButtonN,isSelected=_ButtonN.isSelected}],execute:function(){assertMainOrNode(),_export("BubbleTextField",BubbleTextField=function(){function BubbleTextField(label,bubbleHandler){var _this=this;_classCallCheck(this,BubbleTextField),this.loading=null,this.suggestions=[],this.selectedSuggestion=null,this.suggestionAnimation=Promise.resolve(),this.previousQuery="",this.textField=new TextField(label),this.textField.value.map(function(value){_this._updateSuggestions()}),this.bubbles=[],this.textField._injectionsLeft=function(){return _this.bubbles.map(function(b,i){return m("",[m(ButtonN,b.buttonAttrs),_this.textField.isActive()||i<_this.bubbles.length-1?m("span.pr",","):null])})},this.textField._injectionsRight=function(){return null!=_this.loading?m(".align-right",progressIcon()):null},this.originalIsEmpty=this.textField.isEmpty.bind(this.textField),this.textField.isEmpty=function(){return _this.originalIsEmpty()&&0===_this.bubbles.length},this.textField.baseLabelPosition=size.text_field_label_top,this.textField.onblur.map(function(){return _this.createBubbles()}),this.textField._keyHandler=function(key){return _this.handleKey(key)},this.bubbleHandler=bubbleHandler,this.view=function(){return m(".bubble-text-field",[m(_this.textField),m(".suggestions.text-ellipsis.ml-negative-l",{oncreate:function(vnode){return _this._domSuggestions=vnode.dom},onmousedown:function(e){return _this.textField.skipNextBlur=!0}},_this.suggestions.map(function(s){return m(s,{mouseDownHandler:function(e){_this.selectedSuggestion=s,_this.createBubbles()}})}))])}}return _createClass(BubbleTextField,[{key:"_updateSuggestions",value:function(){var _this2=this,value=this.textField.value();this.textField._domInput&&(this.textField._domInput.size=value.length+3);var query=value.trim();null!=this.loading||(query.length>0&&!(this.previousQuery.length>0&&0===query.indexOf(this.previousQuery)&&0===this.suggestions.length)?this.loading=this.bubbleHandler.getSuggestions(query).then(function(newSuggestions){if(_this2.loading=null,query===_this2.textField.value().trim()){_this2.animateSuggestionsHeight(_this2.suggestions.length,newSuggestions.length),_this2.suggestions=newSuggestions,_this2.suggestions.length>0?(_this2.selectedSuggestion=_this2.suggestions[0],_this2.selectedSuggestion.selected=!0):_this2.selectedSuggestion=null,_this2.previousQuery=query;var input=_this2.textField._domInput;input&&_this2.textField.value()!==input.value&&_this2.textField.value(input.value),m.redraw()}else _this2._updateSuggestions()}):0===query.length&&query!==this.previousQuery&&(this.animateSuggestionsHeight(this.suggestions.length,0),this.suggestions=[],this.selectedSuggestion=null,this.previousQuery=query))}},{key:"animateSuggestionsHeight",value:function(currentCount,newCount){var _this3=this,currentHeight=this.bubbleHandler.suggestionHeight*currentCount,newHeight=this.bubbleHandler.suggestionHeight*newCount;this.suggestionAnimation=this.suggestionAnimation.then(function(){return animations.add(_this3._domSuggestions,height(currentHeight,newHeight))})}},{key:"handleKey",value:function(key){switch(key.keyCode){case 13:case 32:case 188:return this.createBubbles();case 8:return this.handleBackspace();case 46:return this.handleDelete();case 37:return this.handleLeftArrow();case 39:return this.handleRightArrow();case 38:return this.handleUpArrow();case 40:return this.handleDownArrow();case 65:if(key.ctrl)return this.selectAll();break;case 17:return!0}return this.removeBubbleSelection(),!0}},{key:"createBubbles",value:function(){var value=this.textField.value().trim();if(""===value)return!1;if(null!=this.selectedSuggestion){var _bubble=this.bubbleHandler.createBubbleFromSuggestion(this.selectedSuggestion);_bubble&&(this.bubbles.push(_bubble),this.textField.value(""))}else{var _bubbles,bubbles=this.bubbleHandler.createBubblesFromText(value);if(bubbles.length>0)(_bubbles=this.bubbles).push.apply(_bubbles,_toConsumableArray(bubbles)),this.textField.value("")}return m.redraw(),!1}},{key:"handleBackspace",value:function(){var input=this.textField._domInput;if(input&&this.bubbles.length>0&&0===input.selectionStart&&0===input.selectionEnd){var _bubble2=this.bubbles.pop();return this.bubbleHandler.bubbleDeleted(_bubble2),this.textField.value(_bubble2.text),!1}return!0}},{key:"handleDelete",value:function(){var selected=this.bubbles.find(function(b){return isSelected(b.buttonAttrs)});if(selected){var selectedIndex=this.bubbles.indexOf(selected);return this.deleteSelectedBubbles(),selectedIndex>=0&&selectedIndex<this.bubbles.length&&(this.bubbles[selectedIndex].buttonAttrs.isSelected=function(){return!0}),!1}return!0}},{key:"handleLeftArrow",value:function(){var selected=this.bubbles.find(function(b){return isSelected(b.buttonAttrs)});if(selected){var selectedIndex=this.bubbles.indexOf(selected);selectedIndex>0&&(selected.buttonAttrs.isSelected=function(){return!1},this.bubbles[selectedIndex-1].buttonAttrs.isSelected=function(){return!0})}else this.textField._domInput&&0===this.textField._domInput.selectionStart&&0===this.textField._domInput.selectionEnd&&this.selectLastBubble();return!0}},{key:"handleRightArrow",value:function(){var selected=this.bubbles.find(function(b){return isSelected(b.buttonAttrs)});if(selected){var selectedIndex=this.bubbles.indexOf(selected);return selected.buttonAttrs.isSelected=function(){return!1},selectedIndex>=0&&selectedIndex<this.bubbles.length-1&&(this.bubbles[selectedIndex+1].buttonAttrs.isSelected=function(){return!0}),!1}return!0}},{key:"handleUpArrow",value:function(){if(null!=this.selectedSuggestion){this.selectedSuggestion.selected=!1;var next=(this.suggestions.indexOf(this.selectedSuggestion)-1)%this.suggestions.length;-1===next&&(next=this.suggestions.length-1),this.selectedSuggestion=this.suggestions[next],this.selectedSuggestion.selected=!0}return!1}},{key:"handleDownArrow",value:function(){if(null!=this.selectedSuggestion){this.selectedSuggestion.selected=!1;var next=this.suggestions.indexOf(this.selectedSuggestion)+1;next===this.suggestions.length&&(next=0),this.selectedSuggestion=this.suggestions[next],this.selectedSuggestion.selected=!0}else this.suggestions.length>0&&(this.selectedSuggestion=this.suggestions[0],this.selectedSuggestion.selected=!0);return!1}},{key:"selectAll",value:function(){return this.bubbles.forEach(function(b){return b.buttonAttrs.isSelected=function(){return!0}}),!0}},{key:"removeBubbleSelection",value:function(){this.bubbles.forEach(function(b){return b.buttonAttrs.isSelected=function(){return!1}})}},{key:"deleteSelectedBubbles",value:function(){for(var i=this.bubbles.length-1;i>=0;i--)if(isSelected(this.bubbles[i].buttonAttrs)){var deletedBubble=this.bubbles.splice(i,1)[0];this.bubbleHandler.bubbleDeleted(deletedBubble)}}},{key:"isBubbleSelected",value:function(){return null!=this.bubbles.find(function(b){return isSelected(b.buttonAttrs)})}},{key:"selectLastBubble",value:function(){this.bubbles.length>0&&(this.bubbles[this.bubbles.length-1].buttonAttrs.isSelected=function(){return!0})}}]),BubbleTextField}()),_export("BubbleTextField",BubbleTextField),_export("Bubble",Bubble=function Bubble(entity,buttonAttrs,text){_classCallCheck(this,Bubble),this.entity=entity,this.buttonAttrs=buttonAttrs,this.text=text}),_export("Bubble",Bubble)}}}),System.register("src/misc/MailAddressBubbleHandler.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../gui/base/BubbleTextField","./FormatValidator","../contacts/ContactUtils","../api/common/error/DbError","../api/main/Entity","../api/entities/tutanota/Contact","../api/Env","../native/ContactApp","./Formatter","./ContactSuggestion"],function(_export,_context){"use strict";var _classCallCheck,_createClass,isMailAddress,LazyContactListId,searchForContacts,DbError,loadAll,ContactTypeRef,Mode,findRecipients,stringToNameAndMailAddress,ContactSuggestion,ContactSuggestionHeight,MailAddressBubbleHandler;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_guiBaseBubbleTextField){_guiBaseBubbleTextField.Bubble},function(_FormatValidator){isMailAddress=_FormatValidator.isMailAddress},function(_contactsContactUtils){LazyContactListId=_contactsContactUtils.LazyContactListId,searchForContacts=_contactsContactUtils.searchForContacts},function(_apiCommonErrorDbError){DbError=_apiCommonErrorDbError.DbError},function(_apiMainEntity){loadAll=_apiMainEntity.loadAll},function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_apiEnv){Mode=_apiEnv.Mode},function(_nativeContactApp){findRecipients=_nativeContactApp.findRecipients},function(_Formatter){stringToNameAndMailAddress=_Formatter.stringToNameAndMailAddress},function(_ContactSuggestion){ContactSuggestion=_ContactSuggestion.ContactSuggestion,ContactSuggestionHeight=_ContactSuggestion.ContactSuggestionHeight}],execute:function(){_export("MailAddressBubbleHandler",MailAddressBubbleHandler=function(){function MailAddressBubbleHandler(bubbleFactory){_classCallCheck(this,MailAddressBubbleHandler),this._bubbleFactory=bubbleFactory,this.suggestionHeight=ContactSuggestionHeight}return _createClass(MailAddressBubbleHandler,[{key:"getSuggestions",value:function(text){var query=text.trim().toLowerCase();return isMailAddress(query,!1)?Promise.resolve([]):searchForContacts('"'+query+'"',"recipient",10).catch(DbError,function(){return LazyContactListId.getAsync().then(function(listId){return loadAll(ContactTypeRef,listId)})}).map(function(contact){var name=(contact.firstName+" "+contact.lastName).trim();return(-1!==name.toLowerCase().indexOf(query)?contact.mailAddresses.filter(function(ma){return isMailAddress(ma.address.trim(),!1)}):contact.mailAddresses.filter(function(ma){return isMailAddress(ma.address.trim(),!1)&&-1!==ma.address.toLowerCase().indexOf(query)})).map(function(ma){return new ContactSuggestion(name,ma.address.trim(),contact)})}).reduce(function(a,b){return a.concat(b)},[]).then(function(suggestions){return env.mode===Mode.App?findRecipients(query,10,suggestions).then(function(){return suggestions}):suggestions}).then(function(suggestions){return suggestions.sort(function(suggestion1,suggestion2){return suggestion1.name.localeCompare(suggestion2.name)})})}},{key:"createBubbleFromSuggestion",value:function(suggestion){return this._bubbleFactory.createBubble(suggestion.name,suggestion.mailAddress,suggestion.contact)}},{key:"createBubblesFromText",value:function(text){var separator=-1!==text.indexOf(";")?";":",",textParts=text.split(separator),bubbles=[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=textParts[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var part=_step.value;if(0!==(part=part.trim()).length){var bubble=this.getBubbleFromText(part);if(!bubble)return[];bubbles.push(bubble)}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return bubbles}},{key:"bubbleDeleted",value:function(bubble){}},{key:"getBubbleFromText",value:function(text){if(""===(text=text.trim()))return null;var nameAndMailAddress=stringToNameAndMailAddress(text);if(nameAndMailAddress){var _name=nameAndMailAddress.name?nameAndMailAddress.name:null;return this._bubbleFactory.createBubble(_name,nameAndMailAddress.mailAddress,null)}return null}}]),MailAddressBubbleHandler}()),_export("MailAddressBubbleHandler",MailAddressBubbleHandler)}}}),System.register("src/misc/ContactSuggestion.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","mithril","../gui/size"],function(_export,_context){"use strict";var _classCallCheck,m,px,size,ContactSuggestion;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_mithril){m=_mithril.default},function(_guiSize){px=_guiSize.px,size=_guiSize.size}],execute:function(){_export("ContactSuggestionHeight",60),_export("ContactSuggestionHeight",60),_export("ContactSuggestion",ContactSuggestion=function ContactSuggestion(name,mailAddress,contact){var _this=this;_classCallCheck(this,ContactSuggestion),this.name=name,this.mailAddress=mailAddress,this.contact=contact,this.selected=!1,this.view=function(vnode){return m(".pt-s.pb-s.click.content-hover",{class:_this.selected?"content-accent-fg row-selected":"",onmousedown:vnode.attrs.mouseDownHandler,style:{"padding-left":_this.selected?px(size.hpad_large-3):px(size.hpad_large),"border-left":_this.selected?"3px solid":null,height:px(60)}},[m("small",_this.name),m(".name",_this.mailAddress)])}}),_export("ContactSuggestion",ContactSuggestion)}}}),System.register("src/native/ContactApp.js",["../api/Env","./NativeWrapper","../api/common/WorkerProtocol","../api/common/error/PermissionError","../misc/FormatValidator","../misc/ContactSuggestion"],function(_export,_context){"use strict";var assertMainOrNode,nativeApp,Request,PermissionError,isMailAddress,ContactSuggestion;return _export("findRecipients",function(text,maxNumberOfSuggestions,suggestions){return nativeApp.invokeNative(new Request("findSuggestions",[text])).then(function(addressBookSuggestions){var contactSuggestions=addressBookSuggestions.slice(0,maxNumberOfSuggestions).map(function(s){return new ContactSuggestion(s.name,s.mailAddress,null)}),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_loop=function(){var contact=_step.value;isMailAddress(contact.mailAddress,!1)&&!suggestions.find(function(s){return s.mailAddress===contact.mailAddress})&&suggestions.push(contact)},_iterator=contactSuggestions[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0)_loop()}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}).catch(PermissionError,function(){})}),{setters:[function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_NativeWrapper){nativeApp=_NativeWrapper.nativeApp},function(_apiCommonWorkerProtocol){Request=_apiCommonWorkerProtocol.Request},function(_apiCommonErrorPermissionError){PermissionError=_apiCommonErrorPermissionError.PermissionError},function(_miscFormatValidator){isMailAddress=_miscFormatValidator.isMailAddress},function(_miscContactSuggestion){ContactSuggestion=_miscContactSuggestion.ContactSuggestion}],execute:function(){assertMainOrNode()}}}),System.register("src/mail/MailEditor.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/Dialog","../gui/base/TextField","../gui/base/TextFieldN","../misc/LanguageViewModel","../misc/Formatter","../api/common/TutanotaConstants","../gui/animation/Animations","../api/main/Entity","../api/main/WorkerClient","../gui/base/BubbleTextField","../gui/base/Editor","../api/common/RecipientInfo","../api/common/error/RestError","../api/common/error/UserError","../api/common/error/RecipientsNotFoundError","../api/Env","../gui/base/PasswordIndicator","../misc/PasswordUtils","../api/common/utils/Utils","./MailUtils","../file/FileController","../api/common/utils/ArrayUtils","../api/entities/tutanota/File","../api/entities/tutanota/ConversationEntry","../api/entities/tutanota/Mail","../contacts/ContactEditor","../api/entities/tutanota/Contact","../api/common/EntityFunctions","../misc/WindowFacade","../native/FileApp","../api/common/error/PermissionError","../api/common/error/FileNotFoundError","../api/main/LoginController","../gui/base/icons/Icons","../gui/base/DropDownSelector","../api/entities/tutanota/MailAddress","../gui/base/ProgressDialog","./MailModel","../api/main/MainLocator","../contacts/ContactUtils","../api/common/error/RecipientNotResolvedError","mithril/stream/stream.js","../misc/ErrorHandlerImpl","../api/main/EventController","../misc/HtmlSanitizer","../gui/base/RichTextToolbar","../gui/base/ButtonN","../gui/base/ExpanderN","../gui/base/DropDownSelectorN","../gui/base/DropdownN","../api/common/error/FileOpenError","../misc/ClientDetector","../subscription/SubscriptionUtils","../subscription/UpgradeSubscriptionWizard","../api/entities/sys/CustomerProperties","../calendar/CalendarUtils","../misc/MailAddressBubbleHandler","../gui/size","../misc/FormatValidator","../api/common/error/DbError","../native/ContactApp","../api/entities/monitor/ApprovalMail"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,Dialog,TextField,TextFieldN,Type,_getSubstitutedLanguageCode,getAvailableLanguageCode,lang,languages,formatStorageSize,stringToNameAndMailAddress,ALLOWED_IMAGE_FORMATS,ConversationType,FeatureType,Keys,MAX_ATTACHMENT_SIZE,OperationType,ReplyType,animations,height,opacity,load,loadAll,setup,update,worker,Bubble,BubbleTextField,Editor,isExternal,recipientInfoType,AccessBlockedError,ConnectionError,NotAuthorizedError,NotFoundError,PreconditionFailedError,TooManyRequestsError,UserError,RecipientsNotFoundError,assertMainOrNode,isApp,Mode,PasswordIndicator,_getPasswordStrength,debounce,downcast,neverNull,createNewContact,createRecipientInfo,getDefaultSender,getDisplayText,getEmailSignature,getEnabledMailAddresses,getMailboxName,getSenderName,parseMailtoUrl,replaceCidsWithInlineImages,replaceInlineImagesWithCids,resolveRecipientInfo,fileController,contains,findAllAndRemove,remove,replace,FileTypeRef,ConversationEntryTypeRef,MailTypeRef,ContactEditor,ContactTypeRef,isSameId,stringToCustomId,windowFacade,fileApp,PermissionError,FileNotFoundError,logins,Icons,DropDownSelector,createMailAddress,showProgressDialog,mailModel,locator,getContactListName,LazyContactListId,searchForContacts,RecipientNotResolvedError,stream,checkApprovalStatus,isUpdateForTypeRef,htmlSanitizer,RichTextToolbar,ButtonColors,ButtonN,ButtonType,ExpanderButtonN,ExpanderPanelN,DropDownSelectorN,attachDropdown,createDropdown,FileOpenError,client,formatPrice,showUpgradeWizard,CustomerPropertiesTypeRef,getTimeZone,MailAddressBubbleHandler,px,size,isMailAddress,DbError,findRecipients,createApprovalMail,MailEditor,ContactSuggestionHeight,ContactSuggestion;return _export("newMail",function(mailboxDetails){return checkApprovalStatus(!1).then(function(sendAllowed){if(sendAllowed){var editor=new MailEditor(mailboxDetails);return editor.initWithTemplate({},"","<br/>"+getEmailSignature()),editor.show(),editor}return Promise.reject(new PermissionError("not allowed to send mail"))})}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN,Type=_guiBaseTextFieldN.Type},function(_miscLanguageViewModel){_getSubstitutedLanguageCode=_miscLanguageViewModel._getSubstitutedLanguageCode,getAvailableLanguageCode=_miscLanguageViewModel.getAvailableLanguageCode,lang=_miscLanguageViewModel.lang,languages=_miscLanguageViewModel.languages},function(_miscFormatter){formatStorageSize=_miscFormatter.formatStorageSize,stringToNameAndMailAddress=_miscFormatter.stringToNameAndMailAddress},function(_apiCommonTutanotaConstants){ALLOWED_IMAGE_FORMATS=_apiCommonTutanotaConstants.ALLOWED_IMAGE_FORMATS,ConversationType=_apiCommonTutanotaConstants.ConversationType,FeatureType=_apiCommonTutanotaConstants.FeatureType,Keys=_apiCommonTutanotaConstants.Keys,MAX_ATTACHMENT_SIZE=_apiCommonTutanotaConstants.MAX_ATTACHMENT_SIZE,OperationType=_apiCommonTutanotaConstants.OperationType,ReplyType=_apiCommonTutanotaConstants.ReplyType},function(_guiAnimationAnimations){animations=_guiAnimationAnimations.animations,height=_guiAnimationAnimations.height,opacity=_guiAnimationAnimations.opacity},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,setup=_apiMainEntity.setup,update=_apiMainEntity.update},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseBubbleTextField){Bubble=_guiBaseBubbleTextField.Bubble,BubbleTextField=_guiBaseBubbleTextField.BubbleTextField},function(_guiBaseEditor){Editor=_guiBaseEditor.Editor},function(_apiCommonRecipientInfo){isExternal=_apiCommonRecipientInfo.isExternal,recipientInfoType=_apiCommonRecipientInfo.recipientInfoType},function(_apiCommonErrorRestError){AccessBlockedError=_apiCommonErrorRestError.AccessBlockedError,ConnectionError=_apiCommonErrorRestError.ConnectionError,NotAuthorizedError=_apiCommonErrorRestError.NotAuthorizedError,NotFoundError=_apiCommonErrorRestError.NotFoundError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError,TooManyRequestsError=_apiCommonErrorRestError.TooManyRequestsError},function(_apiCommonErrorUserError){UserError=_apiCommonErrorUserError.UserError},function(_apiCommonErrorRecipientsNotFoundError){RecipientsNotFoundError=_apiCommonErrorRecipientsNotFoundError.RecipientsNotFoundError},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isApp=_apiEnv.isApp,Mode=_apiEnv.Mode},function(_guiBasePasswordIndicator){PasswordIndicator=_guiBasePasswordIndicator.PasswordIndicator},function(_miscPasswordUtils){_getPasswordStrength=_miscPasswordUtils.getPasswordStrength},function(_apiCommonUtilsUtils){debounce=_apiCommonUtilsUtils.debounce,downcast=_apiCommonUtilsUtils.downcast,neverNull=_apiCommonUtilsUtils.neverNull},function(_MailUtils){createNewContact=_MailUtils.createNewContact,createRecipientInfo=_MailUtils.createRecipientInfo,getDefaultSender=_MailUtils.getDefaultSender,getDisplayText=_MailUtils.getDisplayText,getEmailSignature=_MailUtils.getEmailSignature,getEnabledMailAddresses=_MailUtils.getEnabledMailAddresses,getMailboxName=_MailUtils.getMailboxName,getSenderName=_MailUtils.getSenderName,parseMailtoUrl=_MailUtils.parseMailtoUrl,replaceCidsWithInlineImages=_MailUtils.replaceCidsWithInlineImages,replaceInlineImagesWithCids=_MailUtils.replaceInlineImagesWithCids,resolveRecipientInfo=_MailUtils.resolveRecipientInfo},function(_fileFileController){fileController=_fileFileController.fileController},function(_apiCommonUtilsArrayUtils){contains=_apiCommonUtilsArrayUtils.contains,findAllAndRemove=_apiCommonUtilsArrayUtils.findAllAndRemove,remove=_apiCommonUtilsArrayUtils.remove,replace=_apiCommonUtilsArrayUtils.replace},function(_apiEntitiesTutanotaFile){FileTypeRef=_apiEntitiesTutanotaFile.FileTypeRef},function(_apiEntitiesTutanotaConversationEntry){ConversationEntryTypeRef=_apiEntitiesTutanotaConversationEntry.ConversationEntryTypeRef},function(_apiEntitiesTutanotaMail){MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_contactsContactEditor){ContactEditor=_contactsContactEditor.ContactEditor},function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_apiCommonEntityFunctions){isSameId=_apiCommonEntityFunctions.isSameId,stringToCustomId=_apiCommonEntityFunctions.stringToCustomId},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_nativeFileApp){fileApp=_nativeFileApp.fileApp},function(_apiCommonErrorPermissionError){PermissionError=_apiCommonErrorPermissionError.PermissionError},function(_apiCommonErrorFileNotFoundError){FileNotFoundError=_apiCommonErrorFileNotFoundError.FileNotFoundError},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_apiEntitiesTutanotaMailAddress){createMailAddress=_apiEntitiesTutanotaMailAddress.createMailAddress},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_MailModel){mailModel=_MailModel.mailModel},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_contactsContactUtils){getContactListName=_contactsContactUtils.getContactListName,LazyContactListId=_contactsContactUtils.LazyContactListId,searchForContacts=_contactsContactUtils.searchForContacts},function(_apiCommonErrorRecipientNotResolvedError){RecipientNotResolvedError=_apiCommonErrorRecipientNotResolvedError.RecipientNotResolvedError},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_miscErrorHandlerImpl){checkApprovalStatus=_miscErrorHandlerImpl.checkApprovalStatus},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_miscHtmlSanitizer){htmlSanitizer=_miscHtmlSanitizer.htmlSanitizer},function(_guiBaseRichTextToolbar){RichTextToolbar=_guiBaseRichTextToolbar.RichTextToolbar},function(_guiBaseButtonN){ButtonColors=_guiBaseButtonN.ButtonColors,ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseExpanderN){ExpanderButtonN=_guiBaseExpanderN.ExpanderButtonN,ExpanderPanelN=_guiBaseExpanderN.ExpanderPanelN},function(_guiBaseDropDownSelectorN){DropDownSelectorN=_guiBaseDropDownSelectorN.DropDownSelectorN},function(_guiBaseDropdownN){attachDropdown=_guiBaseDropdownN.attachDropdown,createDropdown=_guiBaseDropdownN.createDropdown},function(_apiCommonErrorFileOpenError){FileOpenError=_apiCommonErrorFileOpenError.FileOpenError},function(_miscClientDetector){client=_miscClientDetector.client},function(_subscriptionSubscriptionUtils){formatPrice=_subscriptionSubscriptionUtils.formatPrice},function(_subscriptionUpgradeSubscriptionWizard){showUpgradeWizard=_subscriptionUpgradeSubscriptionWizard.showUpgradeWizard},function(_apiEntitiesSysCustomerProperties){CustomerPropertiesTypeRef=_apiEntitiesSysCustomerProperties.CustomerPropertiesTypeRef},function(_calendarCalendarUtils){getTimeZone=_calendarCalendarUtils.getTimeZone},function(_miscMailAddressBubbleHandler){MailAddressBubbleHandler=_miscMailAddressBubbleHandler.MailAddressBubbleHandler},function(_guiSize){px=_guiSize.px,size=_guiSize.size},function(_miscFormatValidator){isMailAddress=_miscFormatValidator.isMailAddress},function(_apiCommonErrorDbError){DbError=_apiCommonErrorDbError.DbError},function(_nativeContactApp){findRecipients=_nativeContactApp.findRecipients},function(_apiEntitiesMonitorApprovalMail){createApprovalMail=_apiEntitiesMonitorApprovalMail.createApprovalMail}],execute:function(){assertMainOrNode(),_export("MailEditor",MailEditor=function(){function MailEditor(mailboxDetails){var _this=this;_classCallCheck(this,MailEditor),this._cleanupInlineAttachments=debounce(50,function(){var elementsToRemove=[];_this._inlineImageElements.forEach(function(inlineImage){if(_this._domElement&&!_this._domElement.contains(inlineImage)){var cid=inlineImage.getAttribute("cid"),attachmentIndex=_this._attachments.findIndex(function(a){return a.cid===cid});-1!==attachmentIndex&&(_this._attachments.splice(attachmentIndex,1),elementsToRemove.push(inlineImage),m.redraw())}}),findAllAndRemove(_this._inlineImageElements,function(imageElement){return elementsToRemove.includes(imageElement)})}),this.conversationType=ConversationType.NEW,this.toRecipients=new BubbleTextField("to_label",new MailAddressBubbleHandler(this)),this.ccRecipients=new BubbleTextField("cc_label",new MailAddressBubbleHandler(this)),this.bccRecipients=new BubbleTextField("bcc_label",new MailAddressBubbleHandler(this)),this._replyTos=[],this._mailAddressToPasswordField=new Map,this._attachments=[],this._mailChanged=!1,this._previousMail=null,this.draft=null,this._mailboxDetails=mailboxDetails,this._showToolbar=!1,this._objectURLs=[],this._blockExternalContent=!0,this._mentionedInlineImages=[],this._inlineImageElements=[];var props=logins.getUserController().props;this._senderField=new DropDownSelector("sender_label",null,getEnabledMailAddresses(this._mailboxDetails).sort().map(function(mailAddress){return{name:mailAddress,value:mailAddress}}),stream(getDefaultSender(this._mailboxDetails)),250);var sortedLanguages=languages.slice().sort(function(a,b){return lang.get(a.textId).localeCompare(lang.get(b.textId))});this._selectedNotificationLanguage=stream(getAvailableLanguageCode(props.notificationMailLanguage||lang.code)),this._getTemplateLanguages(sortedLanguages).then(function(filteredLanguages){if(filteredLanguages.length>0){var languageCodes=filteredLanguages.map(function(l){return l.code});_this._selectedNotificationLanguage(_getSubstitutedLanguageCode(props.notificationMailLanguage||lang.code,languageCodes)||languageCodes[0]),sortedLanguages=filteredLanguages}}),this._confidentialButtonState=!props.defaultUnconfidential,this.subject=new TextField("subject_label",function(){return _this.getConfidentialStateMessage()});var confidentialButtonAttrs={label:"confidential_action",click:function(event,attrs){return _this._confidentialButtonState=!_this._confidentialButtonState},icon:function(){return _this._confidentialButtonState?Icons.Lock:Icons.Unlock},isSelected:function(){return _this._confidentialButtonState},noBubble:!0},attachFilesButtonAttrs={label:"attachFiles_action",click:function(ev,attrs){return _this._showFileChooserForAttachments(ev.target.getBoundingClientRect())},icon:function(){return Icons.Attachment},noBubble:!0},toolbarButton=function(){return logins.getUserController().props.sendPlaintextOnly?null:m(ButtonN,{label:"showRichTextToolbar_action",icon:function(){return Icons.FontSize},click:function(){return _this._showToolbar=!_this._showToolbar},isSelected:function(){return _this._showToolbar},noBubble:!0})};this.subject._injectionsRight=function(){return _this._allRecipients().find(function(r){return r.type===recipientInfoType.external})?[m(ButtonN,confidentialButtonAttrs),m(ButtonN,attachFilesButtonAttrs),toolbarButton()]:[m(ButtonN,attachFilesButtonAttrs),toolbarButton()]},this.subject.onUpdate(function(v){return _this._mailChanged=!0});var closeButtonAttrs=attachDropdown({label:"close_alt",click:function(){return _this._close()},type:ButtonType.Secondary,oncreate:function(vnode){return _this._domCloseButton=vnode.dom}},function(){return[{label:"discardChanges_action",click:function(){return _this._close()},type:ButtonType.Dropdown},{label:"saveDraft_action",click:function(){return _this.saveDraft(!0,!0).then(function(){return _this._close()}).catch(FileNotFoundError,function(){return Dialog.error("couldNotAttachFile_msg")}).catch(PreconditionFailedError,function(){return Dialog.error("operationStillActive_msg")})},type:ButtonType.Dropdown}]},function(){return _this._mailChanged},250),headerBarAttrs={left:[closeButtonAttrs],right:[{label:"send_action",click:function(){return _this.send()},type:ButtonType.Primary}],middle:function(){return lang.get(_this._conversationTypeToTitleTextId())}},detailsExpanded=stream(!1);this._editor=new Editor(200,function(html,isPaste){var sanitized=htmlSanitizer.sanitizeFragment(html,!isPaste&&_this._blockExternalContent);return _this._mentionedInlineImages=sanitized.inlineImageCids,sanitized.html});var attachImageHandler=isApp()?null:function(ev){return _this._onAttachImageClicked(ev)};this._richTextToolbar=new RichTextToolbar(this._editor,attachImageHandler),logins.isInternalUserLoggedIn()?(this.toRecipients.textField._injectionsRight=function(){return m(ExpanderButtonN,{label:"show_action",expanded:detailsExpanded})},this._editor.initialized.promise.then(function(){_this._mailChanged=!1,_this._editor.addChangeListener(function(){return _this._mailChanged=!0})})):(this.toRecipients.textField.setDisabled(),this._editor.initialized.promise.then(function(){_this._mailChanged=!1,_this._editor.addChangeListener(function(){return _this._mailChanged=!0})}));var windowCloseUnsubscribe=function(){};this.view=function(){return m("#mail-editor.full-height.text.touch-callout",{oncreate:function(vnode){_this._domElement=vnode.dom,windowCloseUnsubscribe=windowFacade.addWindowCloseListener(function(){return closeButtonAttrs.click(document.createEvent("MouseEvent"),_this._domCloseButton)})},onremove:function(vnode){windowCloseUnsubscribe(),_this._objectURLs.forEach(function(url){return URL.revokeObjectURL(url)})},onclick:function(e){e.target===_this._domElement&&_this._editor.focus()},ondragover:function(ev){ev.stopPropagation(),ev.preventDefault()},ondrop:function(ev){ev.dataTransfer.files&&ev.dataTransfer.files.length>0&&(fileController.readLocalFiles(ev.dataTransfer.files).then(function(dataFiles){_this.attachFiles(dataFiles),m.redraw()}).catch(function(e){return console.log(e),Dialog.error("couldNotAttachFile_msg")}),ev.stopPropagation(),ev.preventDefault())}},[m(_this.toRecipients),m(ExpanderPanelN,{expanded:detailsExpanded},m(".details",[m(_this.ccRecipients),m(_this.bccRecipients),m(".wrapping-row",[m(_this._senderField),_this._languageDropDown(sortedLanguages)])])),_this._confidentialButtonState?m(".external-recipients.overflow-hidden",{oncreate:function(vnode){return _this.animate(vnode.dom,!0)},onbeforeremove:function(vnode){return _this.animate(vnode.dom,!1)}},_this._allRecipients().filter(function(r){return r.type===recipientInfoType.external&&!r.resolveContactPromise}).map(function(r){return m(TextFieldN,Object.assign({},_this.getPasswordField(r),{oncreate:function(vnode){return _this.animate(vnode.dom,!0)},onbeforeremove:function(vnode){return _this.animate(vnode.dom,!1)}}))})):null,m(".row",m(_this.subject)),m(".flex-start.flex-wrap.ml-negative-bubble",_this._getAttachmentButtons().map(function(a){return m(ButtonN,a)})),_this._attachments.length>0?m("hr.hr"):null,_this._showToolbar?m(_this._richTextToolbar):null,m(".pt-s.text.scroll-x.break-word-links",{onclick:function(){return _this._editor.focus()}},m(_this._editor)),m(".pb")])},this._entityEventReceived=function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _update=_step.value;_this._handleEntityEvent(_update)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}},this.dialog=Dialog.largeDialog(headerBarAttrs,this).addShortcut({key:Keys.ESC,exec:function(){return closeButtonAttrs.click(document.createEvent("MouseEvent"),_this._domCloseButton)},help:"close_alt"}).addShortcut({key:Keys.B,ctrl:!0,exec:function(){},help:"formatTextBold_msg"}).addShortcut({key:Keys.I,ctrl:!0,exec:function(){},help:"formatTextItalic_msg"}).addShortcut({key:Keys.U,ctrl:!0,exec:function(){},help:"formatTextUnderline_msg"}).addShortcut({key:Keys.S,ctrl:!0,exec:function(){_this.saveDraft(!0,!0).catch(FileNotFoundError,function(){return Dialog.error("couldNotAttachFile_msg")}).catch(PreconditionFailedError,function(){return Dialog.error("operationStillActive_msg")})},help:"save_action"}).addShortcut({key:Keys.S,ctrl:!0,shift:!0,exec:function(){_this.send()},help:"send_action"}).setCloseHandler(function(){return closeButtonAttrs.click(document.createEvent("MouseEvent"),_this._domCloseButton)}),this._mailChanged=!1}return _createClass(MailEditor,[{key:"_getTemplateLanguages",value:function(sortedLanguages){return logins.getUserController().loadCustomer().then(function(customer){return load(CustomerPropertiesTypeRef,neverNull(customer.properties))}).then(function(customerProperties){return sortedLanguages.filter(function(sL){return customerProperties.notificationMailTemplates.find(function(nmt){return nmt.language===sL.code})})}).catch(function(){return[]})}},{key:"_focusBodyOnLoad",value:function(){var _this2=this;this._editor.initialized.promise.then(function(){_this2._editor.focus()})}},{key:"_conversationTypeToTitleTextId",value:function(){switch(this.conversationType){case ConversationType.NEW:return"newMail_action";case ConversationType.REPLY:return"reply_action";case ConversationType.FORWARD:return"forward_action";default:return"emptyString_msg"}}},{key:"animate",value:function(domElement,fadein){var childHeight=domElement.offsetHeight;return animations.add(domElement,fadein?height(0,childHeight):height(childHeight,0)).then(function(){domElement.style.height=""})}},{key:"getPasswordField",value:function(recipientInfo){var _this3=this;if(!this._mailAddressToPasswordField.has(recipientInfo.mailAddress)){var passwordIndicator=new PasswordIndicator(function(){return _this3.getPasswordStrength(recipientInfo)}),textFieldAttrs={label:function(){return lang.get("passwordFor_label",{"{1}":recipientInfo.mailAddress})},helpLabel:function(){return m(passwordIndicator)},value:stream(""),type:Type.ExternalPassword};recipientInfo.contact&&recipientInfo.contact.presharedPassword&&textFieldAttrs.value(recipientInfo.contact.presharedPassword),this._mailAddressToPasswordField.set(recipientInfo.mailAddress,textFieldAttrs)}return neverNull(this._mailAddressToPasswordField.get(recipientInfo.mailAddress))}},{key:"getPasswordStrength",value:function(recipientInfo){logins.getUserController();var reserved=getEnabledMailAddresses(this._mailboxDetails).concat(getMailboxName(this._mailboxDetails),recipientInfo.mailAddress,recipientInfo.name);return Math.min(100,_getPasswordStrength(this.getPasswordField(recipientInfo).value(),reserved)/.8*1)}},{key:"initAsResponse",value:function(_ref){var _this4=this,previousMail=_ref.previousMail,conversationType=_ref.conversationType,senderMailAddress=_ref.senderMailAddress,toRecipients=_ref.toRecipients,ccRecipients=_ref.ccRecipients,bccRecipients=_ref.bccRecipients,attachments=_ref.attachments,subject=_ref.subject,bodyText=_ref.bodyText,replyTos=_ref.replyTos,addSignature=_ref.addSignature,inlineImages=_ref.inlineImages,blockExternalContent=_ref.blockExternalContent;if(this._blockExternalContent=blockExternalContent,addSignature){bodyText="<br/><br/><br/>"+bodyText;var signature=getEmailSignature();logins.getUserController().isInternalUser()&&signature&&(bodyText=signature+bodyText)}conversationType===ConversationType.REPLY&&this.dialog.setFocusOnLoadFunction(function(){return _this4._focusBodyOnLoad()});var previousMessageId=null;return load(ConversationEntryTypeRef,previousMail.conversationEntry).then(function(ce){previousMessageId=ce.messageId}).catch(NotFoundError,function(e){console.log("could not load conversation entry",e)}).then(function(){_this4._setMailData(previousMail,previousMail.confidential,conversationType,previousMessageId,senderMailAddress,toRecipients,ccRecipients,bccRecipients,attachments,subject,bodyText,replyTos).then(function(){return _this4._replaceInlineImages(inlineImages)})})}},{key:"initWithTemplate",value:function(recipients,subject,bodyText,confidential,senderMailAddress){var _this5=this;function toMailAddress(_ref2){var name=_ref2.name,address=_ref2.address;return createMailAddress({name:name||"",address:address})}var toRecipients=recipients.to?recipients.to.map(toMailAddress):[],ccRecipients=recipients.cc?recipients.cc.map(toMailAddress):[],bccRecipients=recipients.bcc?recipients.bcc.map(toMailAddress):[];toRecipients.length&&this.dialog.setFocusOnLoadFunction(function(){return _this5._focusBodyOnLoad()});var sender=senderMailAddress||this._senderField.selectedValue();return this._setMailData(null,confidential,ConversationType.NEW,null,sender,toRecipients,ccRecipients,bccRecipients,[],subject,bodyText,[]),Promise.resolve()}},{key:"initWithMailtoUrl",value:function(mailtoUrl,confidential){var result=parseMailtoUrl(mailtoUrl),bodyText=result.body,signature=getEmailSignature();return logins.getUserController().isInternalUser()&&signature&&(bodyText+=signature),this._setMailData(null,confidential,ConversationType.NEW,null,this._senderField.selectedValue(),result.to,result.cc,result.bcc,[],result.subject,bodyText,[]),Promise.resolve()}},{key:"initFromDraft",value:function(_ref3){var _this6=this,draftMail=_ref3.draftMail,attachments=_ref3.attachments,bodyText=_ref3.bodyText,inlineImages=_ref3.inlineImages,blockExternalContent=_ref3.blockExternalContent,conversationType=ConversationType.NEW,previousMessageId=null,previousMail=null;return this.draft=draftMail,this._blockExternalContent=blockExternalContent,load(ConversationEntryTypeRef,draftMail.conversationEntry).then(function(ce){if(conversationType=downcast(ce.conversationType),ce.previous)return load(ConversationEntryTypeRef,ce.previous).then(function(previousCe){if(previousMessageId=previousCe.messageId,previousCe.mail)return load(MailTypeRef,previousCe.mail).then(function(mail){previousMail=mail})}).catch(NotFoundError,function(e){})}).then(function(){var confidential=draftMail.confidential,sender=draftMail.sender,toRecipients=draftMail.toRecipients,ccRecipients=draftMail.ccRecipients,bccRecipients=draftMail.bccRecipients,subject=draftMail.subject,replyTos=draftMail.replyTos;_this6._setMailData(previousMail,confidential,conversationType,previousMessageId,sender.address,toRecipients,ccRecipients,bccRecipients,attachments,subject,bodyText,replyTos).then(function(){return _this6._replaceInlineImages(inlineImages)})})}},{key:"_setMailData",value:function(previousMail,confidential,conversationType,previousMessageId,senderMailAddress,toRecipients,ccRecipients,bccRecipients,attachments,subject,body,replyTos){var _this7=this;this._previousMail=previousMail,this.conversationType=conversationType,this.previousMessageId=previousMessageId,null!=confidential&&(this._confidentialButtonState=confidential),this._senderField.selectedValue(senderMailAddress),this.subject.setValue(subject),this._attachments=[],this._tempBody=body,this.attachFiles(attachments);var promise=this._editor.initialized.promise.then(function(){_this7._editor.getHTML()!==body&&(_this7._editor.setHTML(_this7._tempBody),_this7._mailChanged=!1,_this7._observeEditorMutations()),_this7._tempBody=null});return previousMail&&previousMail.restrictions&&previousMail.restrictions.participantGroupInfos.length>0&&(this.toRecipients.textField._injectionsRight=null,this.toRecipients.textField.setDisabled()),this.toRecipients.bubbles=toRecipients.filter(function(r){return isMailAddress(r.address,!1)}).map(function(r){return _this7.createBubble(r.name,r.address,null)}),this.ccRecipients.bubbles=ccRecipients.filter(function(r){return isMailAddress(r.address,!1)}).map(function(r){return _this7.createBubble(r.name,r.address,null)}),this.bccRecipients.bubbles=bccRecipients.filter(function(r){return isMailAddress(r.address,!1)}).map(function(r){return _this7.createBubble(r.name,r.address,null)}),this._replyTos=replyTos.map(function(ema){return createRecipientInfo(ema.address,ema.name,null,!0)}),this._mailChanged=!1,promise}},{key:"_replaceInlineImages",value:function(inlineImages){var _this8=this;inlineImages&&inlineImages.then(function(loadedInlineImages){Object.keys(loadedInlineImages).forEach(function(key){var file=loadedInlineImages[key].file;_this8._attachments.includes(file)||_this8._attachments.push(file),m.redraw()}),_this8._editor.initialized.promise.then(function(){_this8._inlineImageElements=replaceCidsWithInlineImages(_this8._editor.getDOM(),loadedInlineImages,function(file,event,dom){createDropdown(function(){return[{label:"download_action",click:function(){fileController.downloadAndOpen(file,!0).catch(FileOpenError,function(){return Dialog.error("canNotOpenFileOnDevice_msg")})},type:ButtonType.Dropdown}]})(event,dom)})})})}},{key:"show",value:function(){locator.eventController.addEntityListener(this._entityEventReceived),this.dialog.show()}},{key:"_close",value:function(){locator.eventController.removeEntityListener(this._entityEventReceived),this.dialog.close()}},{key:"_showFileChooserForAttachments",value:function(boundingRect,fileTypes){var _this9=this;return env.mode===Mode.App?fileApp.openFileChooser(boundingRect).then(function(files){return _this9.attachFiles(files),m.redraw(),files}).catch(PermissionError,function(){Dialog.error("fileAccessDeniedMobile_msg")}).catch(FileNotFoundError,function(){Dialog.error("couldNotAttachFile_msg")}):fileController.showFileChooser(!0,fileTypes).then(function(files){return _this9.attachFiles(files),m.redraw(),files})}},{key:"attachFiles",value:function(files){var _this10=this,totalSize=0;this._attachments.forEach(function(file){totalSize+=Number(file.size)});var tooBigFiles=[];files.forEach(function(file){totalSize+Number(file.size)>MAX_ATTACHMENT_SIZE?tooBigFiles.push(file.name):(totalSize+=Number(file.size),_this10._attachments.push(file))}),tooBigFiles.length>0&&Dialog.error(function(){return lang.get("tooBigAttachment_msg")+tooBigFiles.join(", ")}),this._mailChanged=!0,m.redraw()}},{key:"_getAttachmentButtons",value:function(){var _this11=this;return this._attachments.filter(function(item){return!1===_this11._mentionedInlineImages.includes(item.cid)}).map(function(file){var lazyButtonAttrs=[];return lazyButtonAttrs.push({label:"download_action",type:ButtonType.Secondary,click:function(){return"FileReference"===file._type?fileApp.open(file).catch(FileOpenError,function(){return Dialog.error("canNotOpenFileOnDevice_msg")}):"DataFile"===file._type?fileController.open(file):void fileController.downloadAndOpen(file,!0).catch(FileOpenError,function(){return Dialog.error("canNotOpenFileOnDevice_msg")})}}),lazyButtonAttrs.push({label:"remove_action",type:ButtonType.Secondary,click:function(){if(remove(_this11._attachments,file),file.cid){var imageElement=_this11._inlineImageElements.find(function(e){return e.getAttribute("cid")===file.cid});imageElement&&imageElement.remove()}_this11._mailChanged=!0,m.redraw()}}),attachDropdown({label:function(){return file.name},icon:function(){return Icons.Attachment},type:ButtonType.Bubble,staticRightText:"("+formatStorageSize(Number(file.size))+")",colors:ButtonColors.Elevated},function(){return lazyButtonAttrs})})}},{key:"_onAttachImageClicked",value:function(ev){var _this12=this;this._showFileChooserForAttachments(ev.target.getBoundingClientRect(),ALLOWED_IMAGE_FORMATS).then(function(files){files&&files.forEach(function(f){var dataFile=downcast(f),cid=Math.random().toString(30).substring(2);f.cid=cid;var blob=new Blob([dataFile.data],{type:f.mimeType}),objectUrl=URL.createObjectURL(blob);_this12._objectURLs.push(objectUrl),_this12._inlineImageElements.push(_this12._editor.insertImage(objectUrl,{cid:cid,style:"max-width: 100%"}))})})}},{key:"saveDraft",value:function(saveAttachments,showProgress){var _this13=this,attachments=saveAttachments?this._attachments:null,senderName=getSenderName(this._mailboxDetails),to=this.toRecipients.bubbles.map(function(bubble){return bubble.entity}),cc=this.ccRecipients.bubbles.map(function(bubble){return bubble.entity}),bcc=this.bccRecipients.bubbles.map(function(bubble){return bubble.entity}),body=null==this._tempBody?replaceInlineImagesWithCids(this._editor.getDOM()).innerHTML:this._tempBody,promise=null,createMailDraft=function(){return worker.createMailDraft(_this13.subject.value(),body,_this13._senderField.selectedValue(),senderName,to,cc,bcc,_this13.conversationType,_this13.previousMessageId,attachments,_this13._isConfidential(),_this13._replyTos)},draft=this.draft;return promise=(promise=null!=draft?worker.updateMailDraft(this.subject.value(),body,this._senderField.selectedValue(),senderName,to,cc,bcc,attachments,this._isConfidential(),draft).catch(NotFoundError,function(e){return console.log("draft has been deleted, creating new one"),createMailDraft()}):createMailDraft()).then(function(draft){return _this13.draft=draft,Promise.map(draft.attachments,function(fileId){return load(FileTypeRef,fileId)}).then(function(attachments){_this13._attachments=[],_this13.attachFiles(attachments),_this13._mailChanged=!1})}),showProgress?showProgressDialog("save_msg",promise):promise}},{key:"_isConfidential",value:function(){return this._confidentialButtonState||!this._containsExternalRecipients()}},{key:"getConfidentialStateMessage",value:function(){return this._isConfidential()?lang.get("confidentialStatus_msg"):lang.get("nonConfidentialStatus_msg")}},{key:"_containsExternalRecipients",value:function(){return null!=this._allRecipients().find(function(r){return isExternal(r)})}},{key:"send",value:function(){var _this14=this,showProgress=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],tooManyRequestsError=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"tooManyMails_msg";return Promise.resolve().then(function(){if(_this14.toRecipients.createBubbles(),_this14.ccRecipients.createBubbles(),_this14.bccRecipients.createBubbles(),""!==_this14.toRecipients.textField.value().trim()||""!==_this14.ccRecipients.textField.value().trim()||""!==_this14.bccRecipients.textField.value().trim())throw new UserError("invalidRecipients_msg");if(0===_this14.toRecipients.bubbles.length&&0===_this14.ccRecipients.bubbles.length&&0===_this14.bccRecipients.bubbles.length)throw new UserError("noRecipients_msg");var subjectConfirmPromise=Promise.resolve(!0);return 0===_this14.subject.value().trim().length&&(subjectConfirmPromise=Dialog.confirm("noSubject_msg")),subjectConfirmPromise}).then(function(confirmed){if(confirmed){var isApprovalMail=!1,send=_this14._waitForResolvedRecipients().then(function(recipients){return 1===recipients.length&&"approval@tutao.de"===recipients[0].mailAddress.toLowerCase().trim()?(isApprovalMail=!0,recipients):_this14.saveDraft(!0,!1).return(recipients)}).then(function(resolvedRecipients){if(isApprovalMail){var _m=createApprovalMail();return _m._id=["---------c--",stringToCustomId(_this14._senderField.selectedValue())],_m._ownerGroup=logins.getUserController().user.userGroup.group,_m.text="Subject: "+_this14.subject.value()+"<br>"+_this14._editor.getDOM().innerHTML,setup(_m._id[0],_m).catch(NotAuthorizedError,function(e){return console.log("not authorized for approval message")}).then(function(){return _this14._close()})}var externalRecipients=resolvedRecipients.filter(function(r){return isExternal(r)});if(_this14._confidentialButtonState&&externalRecipients.length>0&&null==externalRecipients.find(function(r){return""!==_this14.getPasswordField(r).value().trim()}))throw new UserError("noPreSharedPassword_msg");var sendMail=Promise.resolve(!0);return _this14._confidentialButtonState&&externalRecipients.reduce(function(min,current){return Math.min(min,_this14.getPasswordStrength(current))},100)<80&&(sendMail=Dialog.confirm("presharedPasswordNotStrongEnough_msg")),sendMail.then(function(ok){if(ok)return _this14._updateContacts(resolvedRecipients).then(function(){return worker.sendMailDraft(neverNull(_this14.draft),resolvedRecipients,_this14._selectedNotificationLanguage())}).then(function(){return _this14._updatePreviousMail()}).then(function(){return _this14._updateExternalLanguage()}).then(function(){return _this14._close()})})}).catch(RecipientNotResolvedError,function(e){return Dialog.error("tooManyAttempts_msg")}).catch(RecipientsNotFoundError,function(e){var invalidRecipients=e.message.join("\n");return Dialog.error(function(){return lang.get("invalidRecipients_msg")+"\n"+invalidRecipients})}).catch(TooManyRequestsError,function(e){return Dialog.error(tooManyRequestsError)}).catch(AccessBlockedError,function(e){return checkApprovalStatus(!0,"4").then(function(){console.log("could not send mail (blocked access)",e)})}).catch(FileNotFoundError,function(){return Dialog.error("couldNotAttachFile_msg")}).catch(PreconditionFailedError,function(){return Dialog.error("operationStillActive_msg")});return showProgress?showProgressDialog(_this14._confidentialButtonState?"sending_msg":"sendingUnencrypted_msg",send):send}}).catch(UserError,function(e){return Dialog.error(e.message)}).catch(function(e){throw console.log(typeof e,e),e})}},{key:"_updateExternalLanguage",value:function(){var props=logins.getUserController().props;props.notificationMailLanguage!==this._selectedNotificationLanguage()&&(props.notificationMailLanguage=this._selectedNotificationLanguage(),update(props))}},{key:"_updatePreviousMail",value:function(){if(this._previousMail){if(this._previousMail.replyType===ReplyType.NONE&&this.conversationType===ConversationType.REPLY)this._previousMail.replyType=ReplyType.REPLY;else if(this._previousMail.replyType===ReplyType.NONE&&this.conversationType===ConversationType.FORWARD)this._previousMail.replyType=ReplyType.FORWARD;else if(this._previousMail.replyType===ReplyType.FORWARD&&this.conversationType===ConversationType.REPLY)this._previousMail.replyType=ReplyType.REPLY_FORWARD;else{if(this._previousMail.replyType!==ReplyType.REPLY||this.conversationType!==ConversationType.FORWARD)return Promise.resolve();this._previousMail.replyType=ReplyType.REPLY_FORWARD}return update(this._previousMail).catch(NotFoundError,function(e){})}return Promise.resolve()}},{key:"_updateContacts",value:function(resolvedRecipients){var _this15=this;return Promise.all(resolvedRecipients.map(function(r){if(r.contact){var recipientContact=neverNull(r.contact);return!recipientContact._id&&(!logins.getUserController().props.noAutomaticContacts||isExternal(r)&&_this15._confidentialButtonState)?(isExternal(r)&&_this15._confidentialButtonState&&(recipientContact.presharedPassword=_this15.getPasswordField(r).value().trim()),LazyContactListId.getAsync().then(function(listId){return setup(listId,r.contact)})):recipientContact._id&&isExternal(r)&&_this15._confidentialButtonState&&recipientContact.presharedPassword!==_this15.getPasswordField(r).value().trim()?(recipientContact.presharedPassword=_this15.getPasswordField(r).value().trim(),update(recipientContact)):Promise.resolve()}return Promise.resolve()}))}},{key:"_allRecipients",value:function(){return this.toRecipients.bubbles.map(function(b){return b.entity}).concat(this.ccRecipients.bubbles.map(function(b){return b.entity})).concat(this.bccRecipients.bubbles.map(function(b){return b.entity}))}},{key:"_waitForResolvedRecipients",value:function(){return Promise.all(this._allRecipients().map(function(recipientInfo){return resolveRecipientInfo(recipientInfo).then(function(recipientInfo){return recipientInfo.resolveContactPromise?recipientInfo.resolveContactPromise.return(recipientInfo):recipientInfo})})).catch(TooManyRequestsError,function(e){throw new RecipientNotResolvedError})}},{key:"createBubble",value:function(name,mailAddress,contact){var _this16=this;this._mailChanged=!0;var recipientInfo=createRecipientInfo(mailAddress,name,contact,!1),bubbleWrapper={};return bubbleWrapper.buttonAttrs=attachDropdown({label:function(){return getDisplayText(recipientInfo.name,mailAddress,!1)},type:ButtonType.TextBubble,isSelected:function(){return!1},color:ButtonColors.Elevated},function(){return recipientInfo.resolveContactPromise?recipientInfo.resolveContactPromise.then(function(contact){return _this16._createBubbleContextButtons(recipientInfo.name,mailAddress,contact,function(){return bubbleWrapper.bubble})}):Promise.resolve(_this16._createBubbleContextButtons(recipientInfo.name,mailAddress,contact,function(){return bubbleWrapper.bubble}))},void 0,250),resolveRecipientInfo(recipientInfo).then(function(){return m.redraw()}).catch(ConnectionError,function(e){}).catch(TooManyRequestsError,function(e){Dialog.error("tooManyAttempts_msg")}),bubbleWrapper.bubble=new Bubble(recipientInfo,neverNull(bubbleWrapper.buttonAttrs),mailAddress),bubbleWrapper.bubble}},{key:"_createBubbleContextButtons",value:function(name,mailAddress,contact,bubbleResolver){var _this17=this,buttonAttrs=[mailAddress];return logins.getUserController().isInternalUser()&&(logins.isEnabled(FeatureType.DisableContacts)||(contact&&contact._id?buttonAttrs.push({label:"editContact_label",type:ButtonType.Secondary,click:function(){return new ContactEditor(contact).show()}}):buttonAttrs.push({label:"createContact_action",type:ButtonType.Secondary,click:function(){LazyContactListId.getAsync().then(function(contactListId){new ContactEditor(createNewContact(mailAddress,name),contactListId,function(contactElementId){var bubbles=[_this17.toRecipients.bubbles,_this17.ccRecipients.bubbles,_this17.bccRecipients.bubbles].find(function(b){return contains(b,bubbleResolver())});bubbles&&_this17._updateBubble(bubbles,bubbleResolver(),[contactListId,contactElementId])}).show()})}})),this._previousMail&&this._previousMail.restrictions&&0!==this._previousMail.restrictions.participantGroupInfos.length||buttonAttrs.push({label:"remove_action",type:ButtonType.Secondary,click:function(){return _this17._removeBubble(bubbleResolver())}})),buttonAttrs}},{key:"_handleEntityEvent",value:function(update){var _this18=this,operation=update.operation,instanceId=update.instanceId,instanceListId=update.instanceListId;if(isUpdateForTypeRef(ContactTypeRef,update)&&(operation===OperationType.UPDATE||operation===OperationType.DELETE)){var contactId=[neverNull(instanceListId),instanceId];[this.toRecipients.bubbles,this.ccRecipients.bubbles,this.bccRecipients.bubbles].forEach(function(bubbles){bubbles.forEach(function(bubble){(function(bubble){return bubble.entity.contact&&bubble.entity.contact._id&&isSameId(bubble.entity.contact._id,contactId)})&&(operation===OperationType.UPDATE?_this18._updateBubble(bubbles,bubble,contactId):_this18._removeBubble(bubble))})})}}},{key:"_updateBubble",value:function(bubbles,oldBubble,contactId){var _this19=this;this._mailChanged=!0;var emailAddress=oldBubble.entity.mailAddress;load(ContactTypeRef,contactId).then(function(updatedContact){if(updatedContact.mailAddresses.find(function(ma){return ma.address.trim().toLowerCase()===emailAddress.trim().toLowerCase()})){var newBubble=_this19.createBubble((updatedContact.firstName+" "+updatedContact.lastName).trim(),emailAddress,updatedContact);replace(bubbles,oldBubble,newBubble),updatedContact.presharedPassword&&_this19._mailAddressToPasswordField.has(emailAddress)&&neverNull(_this19._mailAddressToPasswordField.get(emailAddress)).value(updatedContact.presharedPassword||"")}else remove(bubbles,oldBubble)})}},{key:"_removeBubble",value:function(bubble){this._mailChanged=!0;var bubbles=[this.toRecipients.bubbles,this.ccRecipients.bubbles,this.bccRecipients.bubbles].find(function(b){return contains(b,bubble)});bubbles&&remove(bubbles,bubble)}},{key:"_languageDropDown",value:function(langs){var languageDropDownAttrs={label:"notificationMailLanguage_label",items:langs.map(function(language){return{name:lang.get(language.textId),value:language.code}}),selectedValue:this._selectedNotificationLanguage,dropdownWidth:250};return m("",this._confidentialButtonState&&this._containsExternalRecipients()?m("",{oncreate:function(vnode){return animations.add(vnode.dom,opacity(0,1,!1))},onbeforeremove:function(vnode){return animations.add(vnode.dom,opacity(1,0,!1))}},m(DropDownSelectorN,languageDropDownAttrs)):null)}},{key:"_observeEditorMutations",value:function(){new MutationObserver(this._cleanupInlineAttachments).observe(this._editor.getDOM(),{attributes:!1,childList:!0,subtree:!0})}}],[{key:"writeSupportMail",value:function(){mailModel.init().then(function(){if(logins.getUserController().isPremiumAccount())return mailModel.getUserMailboxDetails().then(function(mailboxDetails){var editor=new MailEditor(mailboxDetails),signature="<br><br>--";signature+="<br>Client: "+client.getIdentifier(),signature+="<br>Tutanota version: "+env.versionNumber,signature+="<br>Time zone: "+getTimeZone(),signature+="<br>User agent:<br>"+navigator.userAgent,editor.initWithTemplate({to:[{name:null,address:"premium@tutao.de"}]},"",signature,!0).then(function(){editor.show()})});var message=lang.get("premiumOffer_msg",{"{1}":formatPrice(1,!0)}),title=lang.get("upgradeReminderTitle_msg");Dialog.reminder(title,message,"https://tutanota.com/blog/posts/premium-pro-business").then(function(confirm){confirm&&showUpgradeWizard()})})}},{key:"writeInviteMail",value:function(){mailModel.getUserMailboxDetails().then(function(mailboxDetails){var editor=new MailEditor(mailboxDetails),username=logins.getUserController().userGroupInfo.name,body=lang.get("invitationMailBody_msg",{"{registrationLink}":"https://mail.tutanota.com/signup","{username}":username,"{githubLink}":"https://github.com/tutao/tutanota"});editor.initWithTemplate({},lang.get("invitationMailSubject_msg"),body,!1).then(function(){editor.show()})})}}]),MailEditor}()),_export("MailEditor",MailEditor),ContactSuggestionHeight=60,_export("ContactSuggestion",ContactSuggestion=function ContactSuggestion(name,mailAddress,contact){var _this20=this;_classCallCheck(this,ContactSuggestion),this.name=name,this.mailAddress=mailAddress,this.contact=contact,this.selected=!1,this.view=function(vnode){return m(".pt-s.pb-s.click.content-hover",{class:_this20.selected?"content-accent-fg row-selected":"",onmousedown:vnode.attrs.mouseDownHandler,style:{"padding-left":_this20.selected?px(size.hpad_large-3):px(size.hpad_large),"border-left":_this20.selected?"3px solid":null,height:px(ContactSuggestionHeight)}},[m("small",_this20.name),m(".name",_this20.mailAddress)])}}),_export("ContactSuggestion",ContactSuggestion),function(){function MailBubbleHandler(mailEditor){_classCallCheck(this,MailBubbleHandler),this._mailEditor=mailEditor,this.suggestionHeight=ContactSuggestionHeight}return _createClass(MailBubbleHandler,[{key:"getSuggestions",value:function(text){var query=text.trim().toLowerCase();return isMailAddress(query,!1)?Promise.resolve([]):searchForContacts('"'+query+'"',"recipient",10).catch(DbError,function(){return LazyContactListId.getAsync().then(function(listId){return loadAll(ContactTypeRef,listId)})}).map(function(contact){var name=getContactListName(contact);return(-1!==name.toLowerCase().indexOf(query)?contact.mailAddresses.filter(function(ma){return isMailAddress(ma.address.trim(),!1)}):contact.mailAddresses.filter(function(ma){return isMailAddress(ma.address.trim(),!1)&&-1!==ma.address.toLowerCase().indexOf(query)})).map(function(ma){return new ContactSuggestion(name,ma.address.trim(),contact)})}).reduce(function(a,b){return a.concat(b)},[]).then(function(suggestions){return env.mode===Mode.App?findRecipients(query,10,suggestions).then(function(){return suggestions}):suggestions}).then(function(suggestions){return suggestions.sort(function(suggestion1,suggestion2){return suggestion1.name.localeCompare(suggestion2.name)})})}},{key:"createBubbleFromSuggestion",value:function(suggestion){return this._mailEditor.createBubble(suggestion.name,suggestion.mailAddress,suggestion.contact)}},{key:"createBubblesFromText",value:function(text){var separator=-1!==text.indexOf(";")?";":",",textParts=text.split(separator),bubbles=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=textParts[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var part=_step2.value;if(0!==(part=part.trim()).length){var bubble=this.getBubbleFromText(part);if(!bubble)return[];bubbles.push(bubble)}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}return bubbles}},{key:"bubbleDeleted",value:function(bubble){}},{key:"getBubbleFromText",value:function(text){if(""===(text=text.trim()))return null;var nameAndMailAddress=stringToNameAndMailAddress(text);if(nameAndMailAddress){var _name=nameAndMailAddress.name?nameAndMailAddress.name:null;return this._mailEditor.createBubble(_name,nameAndMailAddress.mailAddress,null)}return null}}]),MailBubbleHandler}()}}}),System.register("src/mail/Exporter.js",["node_modules/systemjs-plugin-babel/babel-helpers/toConsumableArray.js","../api/common/utils/Encoding","../api/common/utils/StringUtils","../api/main/Entity","../api/entities/tutanota/File","../api/main/WorkerClient","../api/common/DataFile","../api/common/utils/Utils","../api/Env","../file/FileController","../misc/Formatter","../gui/base/ProgressDialog","../api/entities/tutanota/MailHeaders"],function(_export,_context){"use strict";var _toConsumableArray,stringToUtf8Uint8Array,uint8ArrayToBase64,pad,load,createFile,FileTypeRef,worker,createDataFile,getCleanedMimeType,getMailHeaders,neverNull,assertMainOrNode,fileController,formatSortableDateTime,showProgressDialog,MailHeadersTypeRef;function toEml(mail,sanitizedBodyText){return(mail.headers?load(MailHeadersTypeRef,mail.headers):Promise.resolve(null)).then(function(header){var _emlArray2,body=uint8ArrayToBase64(stringToUtf8Uint8Array(sanitizedBodyText)).match(/.{1,78}/g);body||(body=[]);var date,bodyText=body.join("\r\n"),emlArray=void 0;if(header){for(var i=(emlArray=getMailHeaders(header).split("\n")).length-1;i>=0;i--)emlArray[i].match(/^\s*(Content-Type:|boundary=)/)&&emlArray.splice(i,1);emlArray=[emlArray.join("\n")]}else{var _emlArray;emlArray=["From: "+mail.sender.address,"MIME-Version: 1.0"],mail.toRecipients.length>0&&emlArray.push(_formatRecipient("To: ",mail.toRecipients)),mail.ccRecipients.length>0&&emlArray.push(_formatRecipient("CC: ",mail.ccRecipients)),mail.bccRecipients.length>0&&emlArray.push(_formatRecipient("BCC: ",mail.bccRecipients));var subject=""===mail.subject.trim()?"":"=?UTF-8?B?"+uint8ArrayToBase64(stringToUtf8Uint8Array(mail.subject))+"?=";(_emlArray=emlArray).push.apply(_emlArray,["Subject: "+subject,"Date: "+(date=mail.sentDate,["Mon","Tue","Wed","Thu","Fri","Sat","Sun"][date.getUTCDay()]+", "+date.getUTCDate()+" "+["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][date.getUTCMonth()]+" "+date.getUTCFullYear()+" "+pad(date.getUTCHours(),2)+":"+pad(date.getUTCMinutes(),2)+":"+pad(date.getUTCSeconds(),2)+" +0000")])}return(_emlArray2=emlArray).push.apply(_emlArray2,['Content-Type: multipart/mixed; boundary="------------79Bu5A16qPEYcVIZL@tutanota"',"","--------------79Bu5A16qPEYcVIZL@tutanota","Content-Type: text/html; charset=UTF-8","Content-transfer-encoding: base64","",bodyText,""]),Promise.map(mail.attachments,function(fileId){return load(FileTypeRef,fileId).then(function(attachment){return worker.downloadFileContent(attachment).then(function(file){var _emlArray3,dataFile=file,base64Filename="=?UTF-8?B?"+uint8ArrayToBase64(stringToUtf8Uint8Array(attachment.name))+"?=",fileContent=uint8ArrayToBase64(dataFile.data),lines=["--------------79Bu5A16qPEYcVIZL@tutanota","Content-Type: "+getCleanedMimeType(attachment.mimeType)," name="+base64Filename,"Content-Transfer-Encoding: base64","Content-Disposition: attachment;"," filename="+base64Filename];attachment.cid&&lines.push("Content-Id: <"+attachment.cid+">"),lines.push(""),lines.push(fileContent.length>0?neverNull(fileContent.match(/.{1,78}/g)).join("\r\n"):fileContent),(_emlArray3=emlArray).push.apply(_emlArray3,lines)})})},{concurrency:1}).then(function(){return emlArray.push("--------------79Bu5A16qPEYcVIZL@tutanota--"),emlArray.join("\r\n")})})}function _formatRecipient(key,recipients){for(var recipientsString=key,i=0;i<recipients.length;i++)recipientsString+=recipients[i].address+",\r\n"+new Array(key.length).join(" ");return recipientsString.substr(0,recipientsString.length-(2+key.length))}return _export("exportAsEml",function(mail,sanitizedHtmlBody){return showProgressDialog("pleaseWait_msg",toEml(mail,sanitizedHtmlBody).then(function(emlString){var data=stringToUtf8Uint8Array(emlString),tmpFile=createFile(),filename=[].concat(_toConsumableArray(formatSortableDateTime(mail.sentDate).split(" ")),[mail.subject]).join("-");return 0===(filename=filename.trim()).length?filename="unnamed":filename.length>96&&(filename=filename.substring(0,95)+"_"),tmpFile.name=filename+".eml",tmpFile.mimeType="message/rfc822",tmpFile.size=String(data.byteLength),fileController.open(createDataFile(tmpFile,data))}))}),_export("toEml",toEml),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs){_toConsumableArray=_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs.default},function(_apiCommonUtilsEncoding){stringToUtf8Uint8Array=_apiCommonUtilsEncoding.stringToUtf8Uint8Array,uint8ArrayToBase64=_apiCommonUtilsEncoding.uint8ArrayToBase64},function(_apiCommonUtilsStringUtils){pad=_apiCommonUtilsStringUtils.pad},function(_apiMainEntity){load=_apiMainEntity.load},function(_apiEntitiesTutanotaFile){createFile=_apiEntitiesTutanotaFile.createFile,FileTypeRef=_apiEntitiesTutanotaFile.FileTypeRef},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonDataFile){createDataFile=_apiCommonDataFile.createDataFile,getCleanedMimeType=_apiCommonDataFile.getCleanedMimeType},function(_apiCommonUtilsUtils){getMailHeaders=_apiCommonUtilsUtils.getMailHeaders,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_fileFileController){fileController=_fileFileController.fileController},function(_miscFormatter){formatSortableDateTime=_miscFormatter.formatSortableDateTime},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiEntitiesTutanotaMailHeaders){MailHeadersTypeRef=_apiEntitiesTutanotaMailHeaders.MailHeadersTypeRef}],execute:function(){assertMainOrNode()}}}),System.register("src/gui/base/ColumnEmptyMessageBox.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../../misc/LanguageViewModel","../../api/Env","./Icon","../size"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,lang,assertMainOrNode,Icon,px,size,ColumnEmptyMessageBox;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_Icon){Icon=_Icon.Icon},function(_size){px=_size.px,size=_size.size}],execute:function(){assertMainOrNode(),ColumnEmptyMessageBox=function(){function ColumnEmptyMessageBox(){_classCallCheck(this,ColumnEmptyMessageBox)}return _createClass(ColumnEmptyMessageBox,[{key:"view",value:function(_ref){var _ref2,message,attrs=_ref.attrs;return m(".fill-absolute.flex.col.items-center.justify-center",m(".mt-negative-l.flex.col.items-center.justify-center.mlr",{style:{"margin-top":px(attrs.icon?-size.icon_message_box-size.vpad_xl:-size.vpad_xl)}},[attrs.icon?m(Icon,{icon:attrs.icon,style:{fill:attrs.color},class:"icon-message-box"}):null,m(".h2.text-center.text-preline",{style:{color:attrs.color}},(_ref2=attrs,message=_ref2.message,"function"==typeof message?message():lang.get(message)))]))}}]),ColumnEmptyMessageBox}(),_export("default",ColumnEmptyMessageBox)}}}),System.register("src/mail/MultiMailViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/Button","./MailView","../api/Env","../gui/base/ActionBar","../api/main/Entity","../api/entities/tutanota/MailBody","./Exporter","../misc/HtmlSanitizer","../gui/base/ColumnEmptyMessageBox","../misc/LanguageViewModel","../gui/base/icons/Icons","./MailUtils","./MailModel","../api/main/LoginController","../api/common/TutanotaConstants","../api/common/error/RestError","../api/common/utils/Utils","../gui/base/ButtonN","../gui/base/icons/BootIcons","../gui/theme"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,Button,createAsyncDropDownButton,createDropDownButton,assertMainOrNode,Mode,ActionBar,load,update,MailBodyTypeRef,exportAsEml,htmlSanitizer,ColumnEmptyMessageBox,lang,Icons,getFolderIcon,getFolderName,getSortedCustomFolders,getSortedSystemFolders,showDeleteConfirmationDialog,mailModel,logins,FeatureType,NotFoundError,getMailBodyText,noOp,ButtonType,BootIcons,theme,MultiMailViewer;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseButton){Button=_guiBaseButton.Button,createAsyncDropDownButton=_guiBaseButton.createAsyncDropDownButton,createDropDownButton=_guiBaseButton.createDropDownButton},function(_MailView){_MailView.MailView},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,Mode=_apiEnv.Mode},function(_guiBaseActionBar){ActionBar=_guiBaseActionBar.ActionBar},function(_apiMainEntity){load=_apiMainEntity.load,update=_apiMainEntity.update},function(_apiEntitiesTutanotaMailBody){MailBodyTypeRef=_apiEntitiesTutanotaMailBody.MailBodyTypeRef},function(_Exporter){exportAsEml=_Exporter.exportAsEml},function(_miscHtmlSanitizer){htmlSanitizer=_miscHtmlSanitizer.htmlSanitizer},function(_guiBaseColumnEmptyMessageBox){ColumnEmptyMessageBox=_guiBaseColumnEmptyMessageBox.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_MailUtils){getFolderIcon=_MailUtils.getFolderIcon,getFolderName=_MailUtils.getFolderName,getSortedCustomFolders=_MailUtils.getSortedCustomFolders,getSortedSystemFolders=_MailUtils.getSortedSystemFolders,showDeleteConfirmationDialog=_MailUtils.showDeleteConfirmationDialog},function(_MailModel){mailModel=_MailModel.mailModel},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonTutanotaConstants){FeatureType=_apiCommonTutanotaConstants.FeatureType},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_apiCommonUtilsUtils){getMailBodyText=_apiCommonUtilsUtils.getMailBodyText,noOp=_apiCommonUtilsUtils.noOp},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_guiTheme){theme=_guiTheme.theme}],execute:function(){assertMainOrNode(),_export("MultiMailViewer",MultiMailViewer=function(){function MultiMailViewer(mailView){var _this=this;_classCallCheck(this,MultiMailViewer),this._mailView=mailView;var actions=this.createActionBar(!0);this.view=function(){return[m(".fill-absolute.mt-xs.plr-l",{oncreate:function(vnode){_this._domMailViewer=vnode.dom}},mailView.mailList&&mailView.mailList.list.getSelectedEntities().length>0?[m(".button-height"),m(".flex-space-between",[m(".flex.items-center",_this._getMailSelectionMessage(mailView)),m(actions)])]:m(ColumnEmptyMessageBox,{message:function(){return _this._getMailSelectionMessage(mailView)},icon:BootIcons.Mail,color:theme.content_message_bg}))]}}return _createClass(MultiMailViewer,[{key:"getBounds",value:function(){return this._domMailViewer&&this._domMailViewer.getBoundingClientRect()}},{key:"_exportAll",value:function(mails){return Promise.map(mails,function(mail){return load(MailBodyTypeRef,mail.body).then(function(body){return exportAsEml(mail,htmlSanitizer.sanitize(getMailBodyText(body),!1).text)})},{concurrency:5}).return()}},{key:"_markAll",value:function(mails,unread){return Promise.all(mails.map(function(mail){return mail.unread!==unread?(mail.unread=unread,update(mail).catch(NotFoundError,noOp)):Promise.resolve()})).return()}},{key:"_getMailSelectionMessage",value:function(mailView){var nbrOfSelectedMails=mailView.mailList?mailView.mailList.list.getSelectedEntities().length:0;return 0===nbrOfSelectedMails?lang.get("noMail_msg"):1===nbrOfSelectedMails?lang.get("oneMailSelected_msg"):lang.get("nbrOfMailsSelected_msg",{"{1}":nbrOfSelectedMails})}},{key:"createActionBar",value:function(){var _this2=this,prependCancel=arguments.length>0&&void 0!==arguments[0]&&arguments[0],actions=new ActionBar;return prependCancel&&actions.add(new Button("cancel_action",function(){return _this2._mailView.mailList.list.selectNone()},function(){return Icons.Cancel})),actions.add(createAsyncDropDownButton("move_action",function(){return Icons.Folder},function(){return Promise.reduce(_this2._mailView.mailList.list.getSelectedEntities(),function(set,mail){return mailModel.getMailboxDetailsForMail(mail).then(function(mailBox){return set.indexOf(mailBox)<0&&set.push(mailBox),set})},[]).then(function(sourceMailboxes){return 1!==sourceMailboxes.length?[]:getSortedSystemFolders(sourceMailboxes[0].folders).concat(getSortedCustomFolders(sourceMailboxes[0].folders)).filter(function(f){return f!==_this2._mailView.selectedFolder}).map(function(f){return new Button(function(){return getFolderName(f)},_this2._actionBarAction(function(mails){return mailModel.moveMails(mails,f)}),getFolderIcon(f)).setType(ButtonType.Dropdown)})})})),actions.add(new Button("delete_action",function(){var mails=_this2._mailView.mailList.list.getSelectedEntities();showDeleteConfirmationDialog(mails).then(function(confirmed){confirmed&&(_this2._mailView.mailList.list.selectNone(),mailModel.deleteMails(mails))})},function(){return Icons.Trash})),actions.add(createDropDownButton("more_label",function(){return Icons.More},function(){var moreButtons=[];return moreButtons.push(new Button("markUnread_action",_this2._actionBarAction(function(mails){return _this2._markAll(mails,!0)}),function(){return Icons.NoEye}).setType(ButtonType.Dropdown)),moreButtons.push(new Button("markRead_action",_this2._actionBarAction(function(mails){return _this2._markAll(mails,!1)}),function(){return Icons.Eye}).setType(ButtonType.Dropdown)),env.mode===Mode.App||logins.isEnabled(FeatureType.DisableMailExport)||moreButtons.push(new Button("export_action",_this2._actionBarAction(function(mails){return _this2._exportAll(mails)}),function(){return Icons.Export}).setType(ButtonType.Dropdown)),moreButtons})),actions}},{key:"_actionBarAction",value:function(action){var _this3=this;return function(){var mails=_this3._mailView.mailList.list.getSelectedEntities();_this3._mailView.mailList.list.selectNone(),action(mails)}}}]),MultiMailViewer}()),_export("MultiMailViewer",MultiMailViewer)}}}),System.register("src/native/PushServiceApp.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../api/main/Entity","../api/entities/sys/PushIdentifier","../api/common/utils/Utils","../api/common/TutanotaConstants","../misc/LanguageViewModel","../api/Env","./NativeWrapper","../api/common/WorkerProtocol","../api/main/LoginController","../api/main/WorkerClient","../misc/ClientDetector.js","../api/common/EntityFunctions","../misc/DeviceConfig"],function(_export,_context){"use strict";var _classCallCheck,_createClass,load,loadAll,setup,update,PushIdentifierModel,createPushIdentifier,PushIdentifierTypeRef,neverNull,PushServiceType,lang,getHttpOrigin,isAndroidApp,isDesktop,isIOSApp,nativeApp,Request,logins,worker,client,getElementId,deviceConfig,PushServiceApp,pushServiceApp;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,setup=_apiMainEntity.setup,update=_apiMainEntity.update},function(_apiEntitiesSysPushIdentifier){PushIdentifierModel=_apiEntitiesSysPushIdentifier._TypeModel,createPushIdentifier=_apiEntitiesSysPushIdentifier.createPushIdentifier,PushIdentifierTypeRef=_apiEntitiesSysPushIdentifier.PushIdentifierTypeRef},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiCommonTutanotaConstants){PushServiceType=_apiCommonTutanotaConstants.PushServiceType},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){getHttpOrigin=_apiEnv.getHttpOrigin,isAndroidApp=_apiEnv.isAndroidApp,isDesktop=_apiEnv.isDesktop,isIOSApp=_apiEnv.isIOSApp},function(_NativeWrapper){nativeApp=_NativeWrapper.nativeApp},function(_apiCommonWorkerProtocol){Request=_apiCommonWorkerProtocol.Request},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_miscClientDetectorJs){client=_miscClientDetectorJs.client},function(_apiCommonEntityFunctions){getElementId=_apiCommonEntityFunctions.getElementId},function(_miscDeviceConfig){deviceConfig=_miscDeviceConfig.deviceConfig}],execute:function(){PushServiceApp=function(){function PushServiceApp(){_classCallCheck(this,PushServiceApp),this._pushNotification=null}return _createClass(PushServiceApp,[{key:"register",value:function(){var _this=this;return isAndroidApp()||isDesktop()?this._loadPushIdentifierFromNative().then(function(identifier){return identifier?(_this._currentIdentifier=identifier,_this._loadPushIdentifier(identifier).then(function(pushIdentifier){return pushIdentifier?_this._storePushIdentifierLocally(pushIdentifier).then(function(){return _this._scheduleAlarmsIfNeeded(pushIdentifier)}):_this._createPushIdentiferInstance(identifier,PushServiceType.SSE).then(function(pushIdentifier){return _this._storePushIdentifierLocally(pushIdentifier).then(function(){return _this._scheduleAlarmsIfNeeded(pushIdentifier)})})})):worker.generateSsePushIdentifer().then(function(identifier){return _this._createPushIdentiferInstance(identifier,PushServiceType.SSE)}).then(function(pushIdentifier){return _this._currentIdentifier=pushIdentifier.identifier,_this._storePushIdentifierLocally(pushIdentifier).then(function(){return _this._scheduleAlarmsIfNeeded(pushIdentifier)})})}).then(this._initPushNotifications):isIOSApp()?this._loadPushIdentifierFromNative().then(function(identifier){if(identifier)return _this._currentIdentifier=identifier,_this._loadPushIdentifier(identifier).then(function(pushIdentifier){return pushIdentifier?(pushIdentifier.language!==lang.code&&(pushIdentifier.language=lang.code,update(pushIdentifier)),_this._storePushIdentifierLocally(pushIdentifier).then(function(){return _this._scheduleAlarmsIfNeeded(pushIdentifier)})):_this._createPushIdentiferInstance(identifier,PushServiceType.IOS).then(function(pushIdentifier){return _this._storePushIdentifierLocally(pushIdentifier).then(function(){return _this._scheduleAlarmsIfNeeded(pushIdentifier)})})});console.log("denied by user")}):Promise.resolve()}},{key:"invalidateAlarms",value:function(){return console.log("invalidating alarms"),deviceConfig.setNoAlarmsScheduled(),logins.isUserLoggedIn()?this.register():Promise.resolve()}},{key:"_loadPushIdentifierFromNative",value:function(){return nativeApp.invokeNative(new Request("getPushIdentifier",[logins.getUserController().user._id,logins.getUserController().userGroupInfo.mailAddress]))}},{key:"_storePushIdentifierLocally",value:function(pushIdentifier){var userId=logins.getUserController().user._id;return worker.resolveSessionKey(PushIdentifierModel,pushIdentifier).then(function(skB64){return nativeApp.invokeNative(new Request("storePushIdentifierLocally",[pushIdentifier.identifier,userId,getHttpOrigin(),getElementId(pushIdentifier),skB64]))})}},{key:"_loadPushIdentifier",value:function(identifier){var list=logins.getUserController().user.pushIdentifierList;return loadAll(PushIdentifierTypeRef,neverNull(list).list).then(function(identifiers){return identifiers.find(function(i){return i.identifier===identifier})})}},{key:"_createPushIdentiferInstance",value:function(identifier,pushServiceType){var list=logins.getUserController().user.pushIdentifierList,pushIdentifier=createPushIdentifier();return pushIdentifier.displayName=client.getIdentifier(),pushIdentifier._owner=logins.getUserController().userGroupInfo.group,pushIdentifier._ownerGroup=logins.getUserController().userGroupInfo.group,pushIdentifier._area="0",pushIdentifier.pushServiceType=pushServiceType,pushIdentifier.identifier=identifier,pushIdentifier.language=lang.code,setup(neverNull(list).list,pushIdentifier).then(function(id){return[neverNull(list).list,id]}).then(function(id){return load(PushIdentifierTypeRef,id)})}},{key:"updateBadge",value:function(newValue){null!=this._pushNotification&&this._pushNotification.setApplicationIconBadgeNumber(function(){},function(){},newValue)}},{key:"closePushNotification",value:function(addresses){nativeApp.invokeNative(new Request("closePushNotifications",[addresses]))}},{key:"getPushIdentifier",value:function(){return this._currentIdentifier}},{key:"_initPushNotifications",value:function(){return nativeApp.invokeNative(new Request("initPushNotifications",[]))}},{key:"_scheduleAlarmsIfNeeded",value:function(pushIdentifier){var userId=logins.getUserController().user._id;return deviceConfig.hasScheduledAlarmsForUser(userId)?Promise.resolve():(console.log("Alarms not scheduled for user, scheduling!"),worker.scheduleAlarmsForNewDevice(pushIdentifier).then(function(){return deviceConfig.setAlarmsScheduledForUser(userId,!0)}))}}]),PushServiceApp}(),_export("pushServiceApp",pushServiceApp=new PushServiceApp),_export("pushServiceApp",pushServiceApp)}}}),System.register("src/gui/base/MultiSelectionBar.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","./icons/Icons","mithril","./Button"],function(_export,_context){"use strict";var _classCallCheck,_createClass,Icons,m,Button,MultiSelectionBar;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_iconsIcons){Icons=_iconsIcons.Icons},function(_mithril){m=_mithril.default},function(_Button){Button=_Button.Button}],execute:function(){_export("MultiSelectionBar",MultiSelectionBar=function(){function MultiSelectionBar(){_classCallCheck(this,MultiSelectionBar)}return _createClass(MultiSelectionBar,[{key:"view",value:function(vnode){var cancelButton=new Button("cancel_action",vnode.attrs.selectNoneHandler,function(){return Icons.Cancel});return m(".flex.items-center.justify-between.pl-s.pr-s",{style:{height:"100%"}},[m(cancelButton),m(".ml-s.b",vnode.attrs.selectedEntiesLength),m(vnode.attrs.content)])}}]),MultiSelectionBar}()),_export("MultiSelectionBar",MultiSelectionBar)}}}),System.register("src/mail/MailFolderView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/NavButtonN","../gui/base/ButtonN","../gui/animation/Animations"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,isNavButtonSelected,NavButtonN,ButtonN,animations,opacity,MailFolderView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseNavButtonN){isNavButtonSelected=_guiBaseNavButtonN.isNavButtonSelected,NavButtonN=_guiBaseNavButtonN.NavButtonN},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN},function(_guiAnimationAnimations){animations=_guiAnimationAnimations.animations,opacity=_guiAnimationAnimations.opacity}],execute:function(){_export("MailFolderView",MailFolderView=function(){function MailFolderView(){_classCallCheck(this,MailFolderView),this._hovered=!1}return _createClass(MailFolderView,[{key:"view",value:function(vnode){var _this=this,_vnode$attrs=vnode.attrs,count=_vnode$attrs.count,button=_vnode$attrs.button,rightButton=_vnode$attrs.rightButton;return m(".folder-row.plr-l.flex.flex-row"+(isNavButtonSelected(button)?".row-selected":""),{},[count>0?m(".folder-counter.z2",{onmouseenter:function(){_this._hovered=!0},onmouseleave:function(){_this._hovered=!1}},count<99||this._hovered?count:"99+"):null,m(NavButtonN,button),rightButton?m(ButtonN,Object.assign({},rightButton,{oncreate:function(vnode){return vnode.dom.style.opacity=0,animations.add(vnode.dom,opacity(0,1,!0))},onbeforeremove:function(vnode){return vnode.dom.style.opacity=1,animations.add(vnode.dom,opacity(1,0,!0))}})):null])}}]),MailFolderView}()),_export("MailFolderView",MailFolderView)}}}),System.register("src/mail/MailView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/ViewSlider","../gui/base/ViewColumn","../misc/LanguageViewModel","../gui/base/Button","../gui/base/ButtonN","../gui/base/NavButtonN","../api/entities/tutanota/Services","../api/main/Entity","./MailViewer","../gui/base/Dialog","../api/main/WorkerClient","../api/common/TutanotaConstants","../gui/base/Header","../api/common/EntityFunctions","../api/entities/tutanota/DeleteMailFolderData","../api/entities/tutanota/DeleteMailData","../api/entities/tutanota/Mail","../api/common/utils/Utils","./MailListView","./MailEditor","../api/Env","../misc/KeyManager","./MultiMailViewer","../api/main/LoginController","../gui/base/Expander","../gui/base/icons/Icons","../gui/theme","../api/common/error/RestError","../gui/base/ProgressDialog","./MailUtils","./MailModel","../api/main/MainLocator","../native/PushServiceApp","../gui/base/ActionBar","../gui/base/MultiSelectionBar","../api/main/EventController","../file/FileController","../api/common/error/PermissionError","../misc/RouteChange","../gui/base/DropdownN","./MailFolderView","../gui/styles","../gui/size","../gui/base/FolderColumnView","../gui/base/Modal","../gui/base/Dropdown"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,ViewSlider,ColumnType,ViewColumn,lang,Button,ButtonColors,ButtonN,ButtonType,isNavButtonSelected,isSelectedPrefix,TutanotaService,load,serviceRequestVoid,update,MailViewer,Dialog,worker,FeatureType,Keys,MailFolderType,OperationType,getListId,HttpMethod,isSameId,createDeleteMailFolderData,createDeleteMailData,MailTypeRef,lazyMemoized,neverNull,noOp,MailListView,MailEditor,newMail,assertMainOrNode,isApp,keyManager,MultiMailViewer,logins,ExpanderButton,ExpanderPanel,Icons,theme,NotFoundError,PreconditionFailedError,showProgressDialog,archiveMails,getFolder,getFolderIcon,getFolderName,getInboxFolder,getMailboxName,getSortedCustomFolders,getSortedSystemFolders,moveToInbox,showDeleteConfirmationDialog,mailModel,locator,pushServiceApp,MultiSelectionBar,isUpdateForTypeRef,fileController,PermissionError,MAIL_PREFIX,navButtonRoutes,throttleRoute,attachDropdown,DropdownN,MailFolderView,styles,size,FolderColumnView,modal,DomRectReadOnlyPolyfilled,MailView;function isNewMailActionAvailable(){return logins.isInternalUserLoggedIn()&&!logins.isEnabled(FeatureType.ReplyOnly)}return _export("isNewMailActionAvailable",isNewMailActionAvailable),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseViewSlider){ViewSlider=_guiBaseViewSlider.ViewSlider},function(_guiBaseViewColumn){ColumnType=_guiBaseViewColumn.ColumnType,ViewColumn=_guiBaseViewColumn.ViewColumn},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_guiBaseButtonN){ButtonColors=_guiBaseButtonN.ButtonColors,ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseNavButtonN){isNavButtonSelected=_guiBaseNavButtonN.isNavButtonSelected,isSelectedPrefix=_guiBaseNavButtonN.isSelectedPrefix},function(_apiEntitiesTutanotaServices){TutanotaService=_apiEntitiesTutanotaServices.TutanotaService},function(_apiMainEntity){load=_apiMainEntity.load,serviceRequestVoid=_apiMainEntity.serviceRequestVoid,update=_apiMainEntity.update},function(_MailViewer){MailViewer=_MailViewer.MailViewer},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonTutanotaConstants){FeatureType=_apiCommonTutanotaConstants.FeatureType,Keys=_apiCommonTutanotaConstants.Keys,MailFolderType=_apiCommonTutanotaConstants.MailFolderType,OperationType=_apiCommonTutanotaConstants.OperationType},function(_guiBaseHeader){_guiBaseHeader.CurrentView},function(_apiCommonEntityFunctions){getListId=_apiCommonEntityFunctions.getListId,HttpMethod=_apiCommonEntityFunctions.HttpMethod,isSameId=_apiCommonEntityFunctions.isSameId},function(_apiEntitiesTutanotaDeleteMailFolderData){createDeleteMailFolderData=_apiEntitiesTutanotaDeleteMailFolderData.createDeleteMailFolderData},function(_apiEntitiesTutanotaDeleteMailData){createDeleteMailData=_apiEntitiesTutanotaDeleteMailData.createDeleteMailData},function(_apiEntitiesTutanotaMail){MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_apiCommonUtilsUtils){lazyMemoized=_apiCommonUtilsUtils.lazyMemoized,neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_MailListView){MailListView=_MailListView.MailListView},function(_MailEditor){MailEditor=_MailEditor.MailEditor,newMail=_MailEditor.newMail},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isApp=_apiEnv.isApp},function(_miscKeyManager){keyManager=_miscKeyManager.keyManager},function(_MultiMailViewer){MultiMailViewer=_MultiMailViewer.MultiMailViewer},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseExpander){ExpanderButton=_guiBaseExpander.ExpanderButton,ExpanderPanel=_guiBaseExpander.ExpanderPanel},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiTheme){theme=_guiTheme.theme},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_MailUtils){archiveMails=_MailUtils.archiveMails,getFolder=_MailUtils.getFolder,getFolderIcon=_MailUtils.getFolderIcon,getFolderName=_MailUtils.getFolderName,getInboxFolder=_MailUtils.getInboxFolder,getMailboxName=_MailUtils.getMailboxName,getSortedCustomFolders=_MailUtils.getSortedCustomFolders,getSortedSystemFolders=_MailUtils.getSortedSystemFolders,moveToInbox=_MailUtils.moveToInbox,showDeleteConfirmationDialog=_MailUtils.showDeleteConfirmationDialog},function(_MailModel){mailModel=_MailModel.mailModel},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_nativePushServiceApp){pushServiceApp=_nativePushServiceApp.pushServiceApp},function(_guiBaseActionBar){_guiBaseActionBar.ActionBar},function(_guiBaseMultiSelectionBar){MultiSelectionBar=_guiBaseMultiSelectionBar.MultiSelectionBar},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_fileFileController){fileController=_fileFileController.fileController},function(_apiCommonErrorPermissionError){PermissionError=_apiCommonErrorPermissionError.PermissionError},function(_miscRouteChange){MAIL_PREFIX=_miscRouteChange.MAIL_PREFIX,navButtonRoutes=_miscRouteChange.navButtonRoutes,throttleRoute=_miscRouteChange.throttleRoute},function(_guiBaseDropdownN){attachDropdown=_guiBaseDropdownN.attachDropdown,DropdownN=_guiBaseDropdownN.DropdownN},function(_MailFolderView){MailFolderView=_MailFolderView.MailFolderView},function(_guiStyles){styles=_guiStyles.styles},function(_guiSize){size=_guiSize.size},function(_guiBaseFolderColumnView){FolderColumnView=_guiBaseFolderColumnView.FolderColumnView},function(_guiBaseModal){modal=_guiBaseModal.modal},function(_guiBaseDropdown){DomRectReadOnlyPolyfilled=_guiBaseDropdown.DomRectReadOnlyPolyfilled}],execute:function(){assertMainOrNode(),_export("MailView",MailView=function(){function MailView(){var _this=this;_classCallCheck(this,MailView),this.elementSelected=function(mails,elementClicked,selectionChanged,multiSelectOperation){if(1!==mails.length||multiSelectOperation||!selectionChanged&&_this.mailViewer)if(selectionChanged&&(0===mails.length||multiSelectOperation)&&_this.mailViewer){_this.mailViewer=null;var _url="/mail/"+_this.mailList.listId;_this.selectedFolder&&(_this._folderToUrl[_this.selectedFolder._id[1]]=_url),_this._setUrl(_url),m.redraw()}else selectionChanged&&m.redraw();else{_this.mailViewer=new MailViewer(mails[0],!1);var url="/mail/"+mails[0]._id.join("/");_this.selectedFolder&&(_this._folderToUrl[_this.selectedFolder._id[1]]=url),_this._setUrl(url),m.redraw()}_this.mailViewer&&!multiSelectOperation&&(mails[0].unread&&!mails[0]._errors&&(mails[0].unread=!1,update(mails[0]).catch(NotFoundError,function(e){return console.log("could not set read flag as mail has been moved/deleted already",e)})),elementClicked&&_this.mailList.list._loading.then(function(){_this.viewSlider.focus(_this.mailColumn)}))},this.mailViewer=null,this._mailboxExpanders={},this._folderToUrl={},this._throttledRouteSet=throttleRoute(),this.folderColumn=new ViewColumn({view:function(){return m(FolderColumnView,{button:!styles.isUsingBottomNavigation()&&isNewMailActionAvailable()?{label:"newMail_action",click:function(){return _this._newMail().catch(PermissionError,noOp)}}:null,content:Object.keys(_this._mailboxExpanders).map(function(mailGroupId){var expander=_this._mailboxExpanders[mailGroupId];return[m(".mr-negative-s.flex-space-between.plr-l.flex-no-grow-no-shrink-auto",m(expander.expanderButton)),m(neverNull(expander.expanderButton).panel)]}),ariaLabel:"folderTitle_label"})}},ColumnType.Foreground,size.first_col_min_width,size.first_col_max_width,function(){return lang.get("folderTitle_label")}),this.listColumn=new ViewColumn({view:function(){return m(".list-column",[_this.mailList?m(_this.mailList):null])}},ColumnType.Background,size.second_col_min_width,size.second_col_max_width,function(){return _this.selectedFolder?getFolderName(_this.selectedFolder):""}),this._multiMailViewer=new MultiMailViewer(this),this._actionBar=lazyMemoized(function(){return _this._multiMailViewer.createActionBar()});var mailColumnTitle=function(){var selectedEntities=_this.mailList?_this.mailList.list.getSelectedEntities():[];return selectedEntities.length>0?_this.mailList.list._loadedEntities.indexOf(selectedEntities[0])+1+"/"+_this.mailList.list._loadedEntities.length:""};this.mailColumn=new ViewColumn({view:function(){return m(".mail",null!=_this.mailViewer?m(_this.mailViewer):m(_this._multiMailViewer))}},ColumnType.Background,size.third_col_min_width,size.third_col_max_width,mailColumnTitle,function(){return lang.get("email_label")+" "+mailColumnTitle()}),this.viewSlider=new ViewSlider([this.folderColumn,this.listColumn,this.mailColumn],"MailView"),this.view=function(){return m("#mail.main-view",{ondragover:function(ev){ev.stopPropagation(),ev.preventDefault()},ondrop:function(ev){isNewMailActionAvailable()&&ev.dataTransfer.files&&ev.dataTransfer.files.length>0&&Promise.join(_this._newMail(),fileController.readLocalFiles(ev.dataTransfer.files),function(ed,dataFiles){ed.attachFiles(dataFiles),m.redraw()}).catch(PermissionError,noOp),ev.stopPropagation(),ev.preventDefault()}},m(_this.viewSlider))},this._setupShortcuts(),locator.eventController.addEntityListener(function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var _update=_step.value;_this.entityEventReceived(_update)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}})}return _createClass(MailView,[{key:"getViewSlider",value:function(){return this.viewSlider}},{key:"headerRightView",value:function(){var _this2=this;return isNewMailActionAvailable()?m(ButtonN,{label:"newMail_action",click:function(){return _this2._newMail().catch(PermissionError,noOp)},type:ButtonType.Action,icon:function(){return Icons.PencilSquare},colors:ButtonColors.Header}):null}},{key:"_setupShortcuts",value:function(){var _this3=this,shortcuts=[{key:Keys.PAGE_UP,exec:function(){_this3.mailViewer&&_this3.mailViewer.scrollUp()},help:"scrollUp_action"},{key:Keys.PAGE_DOWN,exec:function(){_this3.mailViewer&&_this3.mailViewer.scrollDown()},help:"scrollDown_action"},{key:Keys.HOME,exec:function(){_this3.mailViewer&&_this3.mailViewer.scrollToTop()},help:"scrollToTop_action"},{key:Keys.END,exec:function(){_this3.mailViewer&&_this3.mailViewer.scrollToBottom()},help:"scrollToBottom_action"},{key:Keys.UP,exec:function(){return _this3.mailList.list.selectPrevious(!1)},help:"selectPrevious_action"},{key:Keys.K,exec:function(){return _this3.mailList.list.selectPrevious(!1)},help:"selectPrevious_action"},{key:Keys.UP,shift:!0,exec:function(){return _this3.mailList.list.selectPrevious(!0)},help:"addPrevious_action"},{key:Keys.K,shift:!0,exec:function(){return _this3.mailList.list.selectPrevious(!0)},help:"addPrevious_action"},{key:Keys.DOWN,exec:function(){return _this3.mailList.list.selectNext(!1)},help:"selectNext_action"},{key:Keys.J,exec:function(){return _this3.mailList.list.selectNext(!1)},help:"selectNext_action"},{key:Keys.DOWN,shift:!0,exec:function(){return _this3.mailList.list.selectNext(!0)},help:"addNext_action"},{key:Keys.J,shift:!0,exec:function(){return _this3.mailList.list.selectNext(!0)},help:"addNext_action"},{key:Keys.N,exec:function(){return _this3._newMail().catch(PermissionError,noOp)},enabled:function(){return!!_this3.selectedFolder&&isNewMailActionAvailable()},help:"newMail_action"},{key:Keys.DELETE,exec:function(){_this3.deleteMails(_this3.mailList.list.getSelectedEntities())},help:"deleteEmails_action"},{key:Keys.A,exec:function(){return archiveMails(_this3.mailList.list.getSelectedEntities()),!0},help:"archive_action",enabled:function(){return logins.isInternalUserLoggedIn()}},{key:Keys.I,exec:function(){return moveToInbox(_this3.mailList.list.getSelectedEntities()),!0},help:"moveToInbox_action"},{key:Keys.V,exec:function(){return _this3._moveMails()},help:"move_action"},{key:Keys.ONE,exec:function(){return _this3.switchToFolder(MailFolderType.INBOX),!0},help:"switchInbox_action"},{key:Keys.TWO,exec:function(){return _this3.switchToFolder(MailFolderType.DRAFT),!0},help:"switchDrafts_action"},{key:Keys.THREE,exec:function(){return _this3.switchToFolder(MailFolderType.SENT),!0},help:"switchSentFolder_action"},{key:Keys.FOUR,exec:function(){return _this3.switchToFolder(MailFolderType.TRASH),!0},help:"switchTrash_action"},{key:Keys.FIVE,exec:function(){return _this3.switchToFolder(MailFolderType.ARCHIVE),!0},enabled:function(){return logins.isInternalUserLoggedIn()},help:"switchArchive_action"},{key:Keys.SIX,exec:function(){return _this3.switchToFolder(MailFolderType.SPAM),!0},enabled:function(){return logins.isInternalUserLoggedIn()&&!logins.isEnabled(FeatureType.InternalCommunication)},help:"switchSpam_action"}];mailModel.mailboxDetails.map(function(mailboxDetails){if(mailboxDetails.forEach(function(newMailboxDetail){_this3._mailboxExpanders[newMailboxDetail.mailGroup._id]?_this3._mailboxExpanders[newMailboxDetail.mailGroup._id].customFolderButtons=_this3.createFolderButtons(getSortedCustomFolders(newMailboxDetail.folders)):_this3.createMailboxExpander(newMailboxDetail)}),Object.keys(_this3._mailboxExpanders).forEach(function(mailGroupId){null==mailboxDetails.find(function(mailboxDetail){return mailboxDetail.mailGroup._id===mailGroupId})&&delete _this3._mailboxExpanders[mailGroupId]}),_this3.selectedFolder){var currentlySelectedFolder=mailModel.getMailFolder(_this3.selectedFolder.mails);if(currentlySelectedFolder)_this3.selectedFolder=currentlySelectedFolder;else{var url=_this3._folderToUrl[getInboxFolder(mailboxDetails[0].folders)._id[1]];isSelectedPrefix(MAIL_PREFIX)?_this3._setUrl(url):navButtonRoutes.mailUrl=url}}}),this.oncreate=function(){keyManager.registerShortcuts(shortcuts),_this3._countersStream=mailModel.mailboxCounters.map(m.redraw)},this.onbeforeremove=function(){keyManager.unregisterShortcuts(shortcuts),_this3._countersStream.end(!0)}}},{key:"_moveMails",value:function(){var _this4=this,selectedMails=this.mailList.list.getSelectedEntities();return 0!==selectedMails.length&&(mailModel.getMailboxFolders(selectedMails[0]).then(function(folders){var dropdown=new DropdownN(function(){var mailList=getListId(selectedMails[0]);if(selectedMails.some(function(m){return!isSameId(getListId(m),mailList)}))return[];var filteredFolders=folders.filter(function(f){return f.mails!==mailList});return getSortedSystemFolders(filteredFolders).concat(getSortedCustomFolders(filteredFolders)).map(function(f){return{label:function(){return getFolderName(f)},click:function(){return mailModel.moveMails(selectedMails,f)},icon:getFolderIcon(f),type:ButtonType.Dropdown}})},300),viewer=_this4.mailViewer||_this4._multiMailViewer,mailViewerOrigin=viewer&&viewer.getBounds();if(mailViewerOrigin){var origin=new DomRectReadOnlyPolyfilled(mailViewerOrigin.left,mailViewerOrigin.top,mailViewerOrigin.width,0);dropdown.setOrigin(origin),modal.displayUnique(dropdown)}}),!1)}},{key:"switchToFolder",value:function(folderType){var _this5=this;return this._getMailboxDetails().then(function(mailboxDetails){m.route.set(_this5._folderToUrl[getFolder(mailboxDetails.folders,folderType)._id[1]])})}},{key:"createMailboxExpander",value:function(mailboxDetail){this._mailboxExpanders[mailboxDetail.mailGroup._id]={details:mailboxDetail,expanderButton:this.createMailBoxExpanderButton(mailboxDetail),systemFolderButtons:this.createFolderButtons(getSortedSystemFolders(mailboxDetail.folders)),customFolderButtons:this.createFolderButtons(getSortedCustomFolders(mailboxDetail.folders)),folderAddButton:this.createFolderAddButton(mailboxDetail.mailGroup._id),counter:null}}},{key:"createMailBoxExpanderButton",value:function(mailboxDetails){var _this6=this,mailGroupId=mailboxDetails.mailGroup._id,mailboxExpander=new ExpanderButton(function(){return getMailboxName(mailboxDetails)},new ExpanderPanel({view:function(){var groupCounters=mailModel.mailboxCounters()[mailGroupId]||{};return m(".folders",_this6._mailboxExpanders[mailGroupId].systemFolderButtons.map(function(_ref){var id=_ref.id,button=_ref.button,count=groupCounters[id];return m(MailFolderView,{count:count,button:button,rightButton:null,key:id})}).concat(logins.isInternalUserLoggedIn()?[m(".folder-row.flex-space-between.plr-l",{key:"yourFolders"},[m("small.b.align-self-center.ml-negative-xs",{style:{color:theme.navigation_button}},lang.get("yourFolders_action").toLocaleUpperCase()),m(neverNull(_this6._mailboxExpanders[mailGroupId].folderAddButton))])]:[]).concat(_this6._mailboxExpanders[mailGroupId].customFolderButtons.map(function(_ref2){var id=_ref2.id,button=_ref2.button,folder=_ref2.folder,count=groupCounters[id];return m(MailFolderView,{count:count,button:button,rightButton:isNavButtonSelected(button)?_this6.createFolderMoreButton(mailGroupId,folder):null,key:id})})))}}),!1,{},function(){return theme.navigation_button});return mailboxExpander.toggle(),mailboxExpander}},{key:"updateUrl",value:function(args){var _this7=this;if(0===m.route.get().indexOf("/mailto")){if(location.hash.length>5){var url=location.hash.substring(5),decodedUrl=decodeURIComponent(url);mailModel.getUserMailboxDetails().then(function(mailboxDetails){var editor=new MailEditor(mailboxDetails);editor.initWithMailtoUrl(decodedUrl,!1),editor.show(),history.pushState("",document.title,window.location.pathname)})}}else"supportMail"===args.action&&logins.isGlobalAdminUserLoggedIn()&&MailEditor.writeSupportMail();if(isApp()){var userGroupInfo=logins.getUserController().userGroupInfo;pushServiceApp.closePushNotification(userGroupInfo.mailAddressAliases.map(function(alias){return alias.mailAddress}).concat(userGroupInfo.mailAddress||[]))}this.isInitialized()&&args.listId&&this.mailList&&args.listId!==this.mailList.listId?this._showList(args.listId,args.mailId):this.isInitialized()&&args.listId&&!this.mailList?this._showList(args.listId,args.mailId):this.isInitialized()&&args.listId&&this.mailList&&args.listId===this.mailList.listId&&args.mailId&&!this.mailList.list.isEntitySelected(args.mailId)?this.mailList.list.scrollToIdAndSelect(args.mailId):this.isInitialized()&&args.listId&&this.mailList&&args.listId===this.mailList.listId&&!args.mailId?this.viewSlider.focusedColumn===this.viewSlider.columns[2]&&this.viewSlider.focus(this.viewSlider.columns[1]):this.isInitialized()||mailModel.getMailboxDetails().then(function(mailboxDetails){void 0===args.listId?_this7._setUrl(_this7._folderToUrl[getInboxFolder(mailboxDetails[0].folders)._id[1]]):_this7._showList(args.listId,args.mailId)||_this7._setUrl(_this7._folderToUrl[getInboxFolder(mailboxDetails[0].folders)._id[1]]),m.redraw()})}},{key:"isInitialized",value:function(){return Object.keys(this._mailboxExpanders).length>0&&null!=this.selectedFolder}},{key:"_setUrl",value:function(url){navButtonRoutes.mailUrl=url,m.route.get().startsWith(MAIL_PREFIX)&&this._throttledRouteSet(url+location.hash)}},{key:"_showList",value:function(mailListId,mailElementId){this.mailList=new MailListView(mailListId,this);var folder=mailModel.getMailFolder(mailListId);return!!folder&&(this.selectedFolder=folder,navButtonRoutes.mailUrl=this._folderToUrl[folder._id[1]],mailElementId||(this.mailViewer=null),this.mailList.list.loadInitial(mailElementId),!0)}},{key:"createFolderButtons",value:function(folders){var _this8=this;return folders.map(function(folder){_this8._folderToUrl[folder._id[1]]="/mail/"+folder.mails;var button={label:function(){return getFolderName(folder)},icon:getFolderIcon(folder),href:function(){return _this8._folderToUrl[folder._id[1]]},isSelectedPrefix:MAIL_PREFIX+"/"+folder.mails,colors:ButtonColors.Nav,click:function(){return _this8.viewSlider.focus(_this8.listColumn)},dropHandler:function(droppedMailId){if(_this8.mailList.list.isEntitySelected(droppedMailId))mailModel.moveMails(_this8.mailList.list.getSelectedEntities(),folder);else{var entity=_this8.mailList.list.getEntity(droppedMailId);entity&&mailModel.moveMails([entity],folder)}}};return{id:folder.mails,button:button,folder:folder}})}},{key:"createFolderAddButton",value:function(mailGroupId){var _this9=this;return new Button("add_action",function(){return Dialog.showTextInputDialog("folderNameCreate_label","folderName_label",null,"",function(name){return _this9._checkFolderName(name,mailGroupId)}).then(function(name){return mailModel.getMailboxDetailsForMailGroup(mailGroupId).then(function(mailboxDetails){return worker.createMailFolder(name,getInboxFolder(mailboxDetails.folders)._id,mailGroupId)})})},function(){return Icons.Add}).setColors(ButtonColors.Nav)}},{key:"createFolderMoreButton",value:function(mailGroupId,folder){var _this10=this;return attachDropdown({label:"more_label",icon:function(){return Icons.More},colors:ButtonColors.Nav},function(){return[{label:"rename_action",icon:function(){return Icons.Edit},type:ButtonType.Dropdown,click:function(){return Dialog.showTextInputDialog("folderNameRename_label","folderName_label",null,getFolderName(folder),function(name){return _this10._checkFolderName(name,mailGroupId)}).then(function(newName){var renamedFolder=Object.assign({},folder,{name:newName});return update(renamedFolder)})}},{label:"delete_action",icon:function(){return Icons.Trash},type:ButtonType.Dropdown,click:function(){Dialog.confirm(function(){return lang.get("confirmDeleteFinallyCustomFolder_msg",{"{1}":getFolderName(folder)})}).then(function(confirmed){confirmed&&_this10._finallyDeleteCustomMailFolder(folder)})}}]})}},{key:"_newMail",value:function(){return this._getMailboxDetails().then(newMail)}},{key:"_getMailboxDetails",value:function(){return this.selectedFolder?mailModel.getMailboxDetailsForMailListId(this.selectedFolder.mails):mailModel.getUserMailboxDetails()}},{key:"_checkFolderName",value:function(name,mailGroupId){return mailModel.getMailboxDetailsForMailGroup(mailGroupId).then(function(mailboxDetails){return""===name.trim()?"folderNameNeutral_msg":mailboxDetails.folders.find(function(f){return f.name===name})?"folderNameInvalidExisting_msg":null})}},{key:"_finallyDeleteCustomMailFolder",value:function(folder){if(folder.folderType!==MailFolderType.CUSTOM)throw new Error("Cannot delete non-custom folder: "+String(folder._id));this.mailList.list.selectNone();var deleteMailFolderData=createDeleteMailFolderData();return deleteMailFolderData.folders.push(folder._id),serviceRequestVoid(TutanotaService.MailFolderService,HttpMethod.DELETE,deleteMailFolderData,null,"dummy").catch(NotFoundError,function(e){return console.log("mail folder already deleted")}).catch(PreconditionFailedError,function(e){return Dialog.error("operationStillActive_msg")})}},{key:"logout",value:function(){m.route.set("/")}},{key:"deleteMails",value:function(mails){return showDeleteConfirmationDialog(mails).then(function(confirmed){if(!confirmed)return Promise.resolve();mailModel.deleteMails(mails)})}},{key:"_finallyDeleteAllMailsInSelectedFolder",value:function(folder){if(folder.folderType!==MailFolderType.TRASH&&folder.folderType!==MailFolderType.SPAM)throw new Error("Cannot delete mails in folder "+String(folder._id)+" with type "+folder.folderType);this.mailList.list.selectNone();var deleteMailData=createDeleteMailData();return deleteMailData.folder=folder._id,showProgressDialog("progressDeleting_msg",serviceRequestVoid(TutanotaService.MailService,HttpMethod.DELETE,deleteMailData)).catch(PreconditionFailedError,function(e){return Dialog.error("operationStillActive_msg")})}},{key:"entityEventReceived",value:function(update){var _this11=this;if(isUpdateForTypeRef(MailTypeRef,update)&&this.mailList){var instanceListId=update.instanceListId,instanceId=update.instanceId,operation=update.operation,promise=Promise.resolve();instanceListId===this.mailList.listId&&(promise=this.mailList.list.entityEventReceived(instanceId,operation)),promise.then(function(){operation===OperationType.UPDATE&&_this11.mailViewer&&isSameId(_this11.mailViewer.mail._id,[neverNull(instanceListId),instanceId])&&load(MailTypeRef,_this11.mailViewer.mail._id).then(function(updatedMail){_this11.mailViewer=new MailViewer(updatedMail,!1)}).catch(function(){})})}}},{key:"headerView",value:function(){var _this12=this;return 1===this.viewSlider.getVisibleBackgroundColumns().length&&this.mailList&&this.mailList.list&&this.mailList.list.isMobileMultiSelectionActionActive()?m(MultiSelectionBar,{selectNoneHandler:function(){return _this12.mailList.list.selectNone()},selectedEntiesLength:this.mailList.list.getSelectedEntities().length,content:this._actionBar()}):null}}]),MailView}()),_export("MailView",MailView)}}}),System.register("src/gui/nav/DrawerMenu.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../base/ButtonN","../base/icons/BootIcons","../base/Header","./NavFunctions","../../api/Env","../../api/main/LoginController","../../misc/RouteChange","../HtmlUtils","../../mail/MailView","../base/icons/Icons","../../native/NativeWrapper","../../api/common/WorkerProtocol","../../api/common/utils/AriaUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,ButtonColors,ButtonN,ButtonType,BootIcons,LogoutUrl,showUpgradeDialog,writeInviteMail,writeSupportMail,isDesktop,isIOSApp,logins,navButtonRoutes,getSafeAreaInsetLeft,isNewMailActionAvailable,Icons,nativeApp,Request,AriaLandmarks,landmarkAttrs,DrawerMenu;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_baseButtonN){ButtonColors=_baseButtonN.ButtonColors,ButtonN=_baseButtonN.ButtonN,ButtonType=_baseButtonN.ButtonType},function(_baseIconsBootIcons){BootIcons=_baseIconsBootIcons.BootIcons},function(_baseHeader){LogoutUrl=_baseHeader.LogoutUrl},function(_NavFunctions){showUpgradeDialog=_NavFunctions.showUpgradeDialog,writeInviteMail=_NavFunctions.writeInviteMail,writeSupportMail=_NavFunctions.writeSupportMail},function(_apiEnv){isDesktop=_apiEnv.isDesktop,isIOSApp=_apiEnv.isIOSApp},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_miscRouteChange){navButtonRoutes=_miscRouteChange.navButtonRoutes},function(_HtmlUtils){getSafeAreaInsetLeft=_HtmlUtils.getSafeAreaInsetLeft},function(_mailMailView){isNewMailActionAvailable=_mailMailView.isNewMailActionAvailable},function(_baseIconsIcons){Icons=_baseIconsIcons.Icons},function(_nativeNativeWrapper){nativeApp=_nativeNativeWrapper.nativeApp},function(_apiCommonWorkerProtocol){Request=_apiCommonWorkerProtocol.Request},function(_apiCommonUtilsAriaUtils){AriaLandmarks=_apiCommonUtilsAriaUtils.AriaLandmarks,landmarkAttrs=_apiCommonUtilsAriaUtils.landmarkAttrs}],execute:function(){_export("DrawerMenu",DrawerMenu=function(){function DrawerMenu(){_classCallCheck(this,DrawerMenu)}return _createClass(DrawerMenu,[{key:"view",value:function(vnode){return m("drawer-menu"+landmarkAttrs(AriaLandmarks.Contentinfo,"drawer menu"),{style:{"padding-left":getSafeAreaInsetLeft()}},m(".flex.col.height-100p.items-center.pt.pb",[m(".flex-grow"),isDesktop()?m(ButtonN,{icon:function(){return Icons.NewWindow},label:"openNewWindow_action",click:function(){return nativeApp.invokeNative(new Request("openNewWindow",[]))},type:ButtonType.ActionLarge,colors:ButtonColors.DrawerNav}):null,!isIOSApp()&&logins.isUserLoggedIn()&&logins.getUserController().isFreeAccount()?m(ButtonN,{icon:function(){return BootIcons.Premium},label:"upgradePremium_label",click:function(){return showUpgradeDialog()},type:ButtonType.ActionLarge,colors:ButtonColors.DrawerNav}):null,logins.isUserLoggedIn()&&logins.getUserController().isPremiumAccount()?m(ButtonN,{icon:function(){return BootIcons.Help},label:"supportMenu_label",click:function(){return writeSupportMail()},type:ButtonType.ActionLarge,colors:ButtonColors.DrawerNav}):null,isNewMailActionAvailable()?m(ButtonN,{icon:function(){return BootIcons.Share},label:"invite_alt",click:function(){return writeInviteMail()},type:ButtonType.ActionLarge,colors:ButtonColors.DrawerNav}):null,logins.isInternalUserLoggedIn()?m(ButtonN,{icon:function(){return BootIcons.Settings},label:"settings_label",click:function(){return m.route.set(navButtonRoutes.settingsUrl)},type:ButtonType.ActionLarge,colors:ButtonColors.DrawerNav}):null,m(ButtonN,{icon:function(){return BootIcons.Logout},label:"logout_label",click:function(){return m.route.set(LogoutUrl)},type:ButtonType.ActionLarge,colors:ButtonColors.DrawerNav}),isDesktop()?m(ButtonN,{icon:function(){return Icons.Power},label:"quit_action",click:function(){return nativeApp.invokeNative(new Request("closeApp",[]))},type:ButtonType.ActionLarge,colors:ButtonColors.DrawerNav}):null]))}}]),DrawerMenu}()),_export("DrawerMenu",DrawerMenu)}}}),System.register("src/gui/base/FolderColumnView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../../api/Env","../nav/DrawerMenu","../theme","mithril","./ButtonN","../../misc/LanguageViewModel","../../api/common/utils/AriaUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,assertMainOrNode,DrawerMenu,theme,m,ButtonN,ButtonType,lang,AriaLandmarks,landmarkAttrs,FolderColumnView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_navDrawerMenu){DrawerMenu=_navDrawerMenu.DrawerMenu},function(_theme){theme=_theme.theme},function(_mithril){m=_mithril.default},function(_ButtonN){ButtonN=_ButtonN.ButtonN,ButtonType=_ButtonN.ButtonType},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonUtilsAriaUtils){AriaLandmarks=_apiCommonUtilsAriaUtils.AriaLandmarks,landmarkAttrs=_apiCommonUtilsAriaUtils.landmarkAttrs}],execute:function(){assertMainOrNode(),_export("FolderColumnView",FolderColumnView=function(){function FolderColumnView(){_classCallCheck(this,FolderColumnView)}return _createClass(FolderColumnView,[{key:"view",value:function(_ref){var attrs=_ref.attrs;return m(".flex.height-100p",[m(DrawerMenu),m(".folder-column.flex-grow.overflow-x-hidden.flex.col"+landmarkAttrs(AriaLandmarks.Navigation,lang.getMaybeLazy(attrs.ariaLabel)),[attrs.button?m(".mlr-l.mt.mb",m(ButtonN,{label:attrs.button.label,click:attrs.button.click,type:ButtonType.PrimaryBorder})):null,m(".scroll.overflow-x-hidden.flex.col.flex-grow",{onscroll:function(e){null==attrs.button||0===e.target.scrollTop?e.target.style.borderTop="":e.target.style.borderTop="1px solid "+theme.content_border}},attrs.content)])])}}]),FolderColumnView}()),_export("FolderColumnView",FolderColumnView)}}}),System.register("src/settings/SettingsView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../gui/base/ViewColumn","../gui/base/Expander","../gui/base/ViewSlider","./SettingsFolder","../misc/LanguageViewModel","./LoginSettingsViewer","./GlobalSettingsViewer","./DesktopSettingsViewer","./MailSettingsViewer","./UserListView","../api/entities/sys/User","../api/common/EntityFunctions","../api/main/Entity","../gui/base/Button","../gui/base/ButtonN","../api/main/LoginController","./GroupListView","./ContactFormListView","./WhitelabelSettingsViewer","../gui/base/icons/Icons","../gui/theme","../api/common/TutanotaConstants","../gui/base/icons/BootIcons","../api/main/MainLocator","./WhitelabelChildrenListView","../subscription/SubscriptionViewer","../subscription/PaymentViewer","../api/main/EventController","./UserViewer","../api/common/utils/LazyLoaded","./AddUserDialog","../api/entities/sys/CustomerInfo","./AppearanceSettingsViewer","../gui/base/NavButtonN","../gui/base/Dialog","./AboutDialog","../misc/RouteChange","../gui/size","../gui/base/FolderColumnView"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,isApp,isDesktop,isIOSApp,isTutanotaDomain,ColumnType,ViewColumn,ExpanderButton,ExpanderPanel,ViewSlider,SettingsFolder,lang,LoginSettingsViewer,GlobalSettingsViewer,DesktopSettingsViewer,MailSettingsViewer,UserListView,UserTypeRef,isSameId,load,Button,ButtonColors,logins,GroupListView,ContactFormListView,WhitelabelSettingsViewer,Icons,theme,FeatureType,GroupType,BootIcons,locator,WhitelabelChildrenListView,SubscriptionViewer,PaymentViewer,isUpdateForTypeRef,showUserImportDialog,LazyLoaded,getAvailableDomains,CustomerInfoTypeRef,AppearanceSettingsViewer,isNavButtonSelected,NavButtonN,Dialog,AboutDialog,navButtonRoutes,size,FolderColumnView,SettingsView;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isApp=_apiEnv.isApp,isDesktop=_apiEnv.isDesktop,isIOSApp=_apiEnv.isIOSApp,isTutanotaDomain=_apiEnv.isTutanotaDomain},function(_guiBaseViewColumn){ColumnType=_guiBaseViewColumn.ColumnType,ViewColumn=_guiBaseViewColumn.ViewColumn},function(_guiBaseExpander){ExpanderButton=_guiBaseExpander.ExpanderButton,ExpanderPanel=_guiBaseExpander.ExpanderPanel},function(_guiBaseViewSlider){ViewSlider=_guiBaseViewSlider.ViewSlider},function(_SettingsFolder){SettingsFolder=_SettingsFolder.SettingsFolder},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_LoginSettingsViewer){LoginSettingsViewer=_LoginSettingsViewer.LoginSettingsViewer},function(_GlobalSettingsViewer){GlobalSettingsViewer=_GlobalSettingsViewer.GlobalSettingsViewer},function(_DesktopSettingsViewer){DesktopSettingsViewer=_DesktopSettingsViewer.DesktopSettingsViewer},function(_MailSettingsViewer){MailSettingsViewer=_MailSettingsViewer.MailSettingsViewer},function(_UserListView){UserListView=_UserListView.UserListView},function(_apiEntitiesSysUser){UserTypeRef=_apiEntitiesSysUser.UserTypeRef},function(_apiCommonEntityFunctions){isSameId=_apiCommonEntityFunctions.isSameId},function(_apiMainEntity){load=_apiMainEntity.load},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_guiBaseButtonN){ButtonColors=_guiBaseButtonN.ButtonColors},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_GroupListView){GroupListView=_GroupListView.GroupListView},function(_ContactFormListView){ContactFormListView=_ContactFormListView.ContactFormListView},function(_WhitelabelSettingsViewer){WhitelabelSettingsViewer=_WhitelabelSettingsViewer.WhitelabelSettingsViewer},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiTheme){theme=_guiTheme.theme},function(_apiCommonTutanotaConstants){FeatureType=_apiCommonTutanotaConstants.FeatureType,GroupType=_apiCommonTutanotaConstants.GroupType},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_WhitelabelChildrenListView){WhitelabelChildrenListView=_WhitelabelChildrenListView.WhitelabelChildrenListView},function(_subscriptionSubscriptionViewer){SubscriptionViewer=_subscriptionSubscriptionViewer.SubscriptionViewer},function(_subscriptionPaymentViewer){PaymentViewer=_subscriptionPaymentViewer.PaymentViewer},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_UserViewer){showUserImportDialog=_UserViewer.showUserImportDialog},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_AddUserDialog){getAvailableDomains=_AddUserDialog.getAvailableDomains},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_AppearanceSettingsViewer){AppearanceSettingsViewer=_AppearanceSettingsViewer.AppearanceSettingsViewer},function(_guiBaseNavButtonN){isNavButtonSelected=_guiBaseNavButtonN.isNavButtonSelected,NavButtonN=_guiBaseNavButtonN.NavButtonN},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_AboutDialog){AboutDialog=_AboutDialog.AboutDialog},function(_miscRouteChange){navButtonRoutes=_miscRouteChange.navButtonRoutes},function(_guiSize){size=_guiSize.size},function(_guiBaseFolderColumnView){FolderColumnView=_guiBaseFolderColumnView.FolderColumnView}],execute:function(){assertMainOrNode(),_export("SettingsView",SettingsView=function(){function SettingsView(){var _this=this;_classCallCheck(this,SettingsView),this._userFolders=[new SettingsFolder("login_label",function(){return BootIcons.Contacts},"login",function(){return new LoginSettingsViewer}),new SettingsFolder("email_label",function(){return BootIcons.Mail},"mail",function(){return new MailSettingsViewer}),new SettingsFolder("appearanceSettings_label",function(){return Icons.Palette},"appearance",function(){return new AppearanceSettingsViewer})],isDesktop()&&this._userFolders.push(new SettingsFolder("desktop_label",function(){return Icons.Desktop},"desktop",function(){return new DesktopSettingsViewer})),this._adminFolders=[],this._adminFolders.push(new SettingsFolder("adminUserList_action",function(){return BootIcons.Contacts},"users",function(){return new UserListView(_this)})),logins.isEnabled(FeatureType.WhitelabelChild)||this._adminFolders.push(new SettingsFolder("groups_label",function(){return Icons.People},"groups",function(){return new GroupListView(_this)})),logins.getUserController().isGlobalAdmin()&&(this._adminFolders.push(new SettingsFolder("globalSettings_label",function(){return BootIcons.Settings},"global",function(){return new GlobalSettingsViewer})),logins.isEnabled(FeatureType.WhitelabelChild)||isIOSApp()||(this._adminFolders.push(new SettingsFolder("whitelabel_label",function(){return Icons.Wand},"whitelabel",function(){return new WhitelabelSettingsViewer})),logins.isEnabled(FeatureType.WhitelabelParent)&&this._adminFolders.push(new SettingsFolder("whitelabelAccounts_label",function(){return Icons.People},"whitelabelaccounts",function(){return new WhitelabelChildrenListView(_this)})))),logins.isEnabled(FeatureType.WhitelabelChild)||(this._adminFolders.push(new SettingsFolder("contactForms_label",function(){return Icons.Chat},"contactforms",function(){return new ContactFormListView(_this)})),logins.getUserController().isGlobalAdmin()&&(this._adminFolders.push(new SettingsFolder("adminSubscription_action",function(){return BootIcons.Premium},"subscription",function(){return new SubscriptionViewer}).setIsVisibleHandler(function(){return!isIOSApp()||!logins.getUserController().isFreeAccount()})),this._adminFolders.push(new SettingsFolder("adminPayment_action",function(){return Icons.Cash},"invoice",function(){return new PaymentViewer}).setIsVisibleHandler(function(){return!logins.getUserController().isFreeAccount()})))),this._selectedFolder=this._userFolders[0];var userFolderExpander=this._createFolderExpander("userSettings_label",this._userFolders),adminFolderExpander=this._createFolderExpander("adminSettings_label",this._adminFolders);this._settingsFoldersColumn=new ViewColumn({view:function(){return m(FolderColumnView,{button:null,content:m(".flex.flex-grow.col",[m(".plr-l",m(userFolderExpander)),m(userFolderExpander.panel),logins.getUserController().isGlobalOrLocalAdmin()?m(".plr-l",m(adminFolderExpander)):null,logins.getUserController().isGlobalOrLocalAdmin()?m(adminFolderExpander.panel):null,isTutanotaDomain()?_this._aboutThisSoftwareLink():null]),ariaLabel:"settings_label"})}},ColumnType.Foreground,size.first_col_min_width,size.first_col_max_width,function(){return lang.get("settings_label")}),this._settingsColumn=new ViewColumn({view:function(){return m(_this._getCurrentViewer())}},ColumnType.Background,400,600,function(){return lang.get(_this._selectedFolder.nameTextId)}),this._settingsDetailsColumn=new ViewColumn({view:function(){return _this.detailsViewer?m(_this.detailsViewer):m("")}},ColumnType.Background,600,2400,function(){return lang.get("settings_label")}),this.viewSlider=new ViewSlider([this._settingsFoldersColumn,this._settingsColumn,this._settingsDetailsColumn],"SettingsView"),this.view=function(){return m("#settings.main-view",m(_this.viewSlider))},locator.eventController.addEntityListener(function(updates){_this.entityEventsReceived(updates)}),this._customDomains=new LazyLoaded(function(){return getAvailableDomains(!0)}),this._customDomains.getAsync().then(function(){return m.redraw()})}return _createClass(SettingsView,[{key:"_createFolderExpander",value:function(textId,folders){var _this2=this,importUsersButton=new Button("importUsers_action",function(){return showUserImportDialog(_this2._customDomains.getLoaded())},function(){return Icons.ContactImport}).setColors(ButtonColors.Nav),buttons=folders.map(function(folder){return{label:folder.nameTextId,icon:folder.icon,href:folder.url,colors:ButtonColors.Nav,click:function(){return _this2.viewSlider.focus(_this2._settingsColumn)},isVisible:function(){return folder.isVisible()}}}),expander=new ExpanderButton(textId,new ExpanderPanel({view:function(){return m(".folders",buttons.map(function(fb){return fb.isVisible()?m(".folder-row.flex-start.plr-l"+(isNavButtonSelected(fb)?".row-selected":""),[m(NavButtonN,fb),!isApp()&&isNavButtonSelected(fb)&&_this2._selectedFolder&&m.route.get().startsWith("/settings/users")&&_this2._customDomains.isLoaded()&&_this2._customDomains.getLoaded().length>0?m(importUsersButton):null]):null}))}}),!1,{},function(){return theme.navigation_button});return expander.toggle(),expander}},{key:"_getCurrentViewer",value:function(){return this._currentViewer||(this.detailsViewer=null,this._currentViewer=this._selectedFolder.viewerCreator()),this._currentViewer}},{key:"updateUrl",value:function(args){if(args.folder){if(args.folder&&this._selectedFolder.path!==args.folder||!m.route.get().startsWith("/settings")){var folder=this._userFolders.find(function(f){return f.path===args.folder});!folder&&logins.getUserController().isGlobalOrLocalAdmin()&&(folder=this._adminFolders.find(function(f){return f.path===args.folder})),folder?(this._selectedFolder=folder,this._currentViewer=null,this.detailsViewer=null,this._getCurrentViewer(),navButtonRoutes.settingsUrl=folder.url,m.redraw()):this._setUrl(this._userFolders[0].url)}}else this._setUrl(this._userFolders[0].url)}},{key:"_setUrl",value:function(url){navButtonRoutes.settingsUrl=url,m.route.set(url+location.hash)}},{key:"_isGlobalOrLocalAdmin",value:function(user){return null!=user.memberships.find(function(m){return m.groupType===GroupType.Admin||m.groupType===GroupType.LocalAdmin})}},{key:"focusSettingsDetailsColumn",value:function(){this.viewSlider.focus(this._settingsDetailsColumn)}},{key:"entityEventsReceived",value:function(updates){var _this3=this,_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var update=_step.value;isUpdateForTypeRef(UserTypeRef,update)&&isSameId(update.instanceId,logins.getUserController().user._id)&&load(UserTypeRef,update.instanceId).then(function(user){!_this3._isGlobalOrLocalAdmin(user)&&_this3._currentViewer&&_this3._adminFolders.find(function(f){return f.isActive()})&&_this3._setUrl(_this3._userFolders[0].url),m.redraw()}),isUpdateForTypeRef(CustomerInfoTypeRef,update)&&(this._customDomains.reset(),this._customDomains.getAsync().then(function(){return m.redraw()}))}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}this._currentViewer&&this._currentViewer.entityEventsReceived(updates),this.detailsViewer&&this.detailsViewer.entityEventsReceived(updates)}},{key:"getViewSlider",value:function(){return this.viewSlider}},{key:"_aboutThisSoftwareLink",value:function(){var _this4=this;return m(".pb.pt-l.flex-no-shrink.flex.col.justify-end",[m("button.text-center.small.no-text-decoration",{style:{backgroundColor:"transparent"},href:"#",onclick:function(){_this4.viewSlider.focusNextColumn(),setTimeout(function(){Dialog.showActionDialog({title:function(){return lang.get("about_label")},child:function(){return m(AboutDialog)},allowOkWithReturn:!0,okAction:function(dialog){return dialog.close()},allowCancel:!1})},200)}},[m("","Tutanota v"+env.versionNumber),m(".b",{style:{color:theme.navigation_button_selected}},lang.get("about_label"))])])}}]),SettingsView}()),_export("SettingsView",SettingsView)}}}),System.register("src/gui/base/ActionBar.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./Button","../../api/Env"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,ActionBar;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_Button){_Button.Button},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode}],execute:function(){assertMainOrNode(),_export("ActionBar",ActionBar=function(){function ActionBar(){var _this=this;_classCallCheck(this,ActionBar),this._buttons=[],this.view=function(){return m(".action-bar.flex-end.items-center",_this._buttons.filter(function(b){return b.isVisible()}).map(function(b){return m(b)}))}}return _createClass(ActionBar,[{key:"add",value:function(button){return this._buttons.push(button),this}}]),ActionBar}()),_export("ActionBar",ActionBar)}}}),System.register("src/settings/LoadingUtils.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","../api/entities/sys/Group","../api/main/Entity","../api/entities/sys/User","../api/entities/sys/GroupInfo","../api/common/utils/Utils","../api/common/TutanotaConstants","../api/common/utils/ArrayUtils"],function(_export,_context){"use strict";var _classCallCheck,GroupTypeRef,load,loadAll,loadMultiple,UserTypeRef,GroupInfoTypeRef,getGroupInfoDisplayName,getUserGroupMemberships,neverNull,GroupType,flat,GroupData;return _export("loadGroupDisplayName",function(groupId){return load(GroupTypeRef,groupId).then(function(group){return group.user&&group.type!==GroupType.User?load(UserTypeRef,group.user).then(function(user){return load(GroupInfoTypeRef,user.userGroup.groupInfo)}):load(GroupInfoTypeRef,group.groupInfo)}).then(function(groupInfo){return getGroupInfoDisplayName(groupInfo)})}),_export("loadEnabledTeamMailGroups",function(customer){return loadAll(GroupInfoTypeRef,customer.teamGroups).filter(function(teamGroupInfo){return!teamGroupInfo.deleted&&load(GroupTypeRef,teamGroupInfo.group).then(function(teamGroup){return teamGroup.type===GroupType.Mail})}).map(function(mailTeamGroupInfo){return new GroupData(mailTeamGroupInfo.group,getGroupInfoDisplayName(mailTeamGroupInfo))})}),_export("loadEnabledUserMailGroups",function(customer){return loadAll(GroupInfoTypeRef,customer.userGroups).filter(function(g){return!g.deleted}).map(function(userGroupInfo){return load(GroupTypeRef,userGroupInfo.group).then(function(userGroup){return load(UserTypeRef,neverNull(userGroup.user)).then(function(user){return new GroupData(getUserGroupMemberships(user,GroupType.Mail)[0].group,getGroupInfoDisplayName(userGroupInfo))})})})}),_export("loadGroupInfos",function(groupInfoIds){var result,groupedParticipantGroupInfos=(result={},groupInfoIds.forEach(function(entry){null==result[entry[0]]&&(result[entry[0]]=[]),result[entry[0]].push(entry[1])}),result);return Promise.map(Object.keys(groupedParticipantGroupInfos),function(listId){return loadMultiple(GroupInfoTypeRef,listId,groupedParticipantGroupInfos[listId])},{concurrency:5}).then(flat)}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_apiEntitiesSysGroup){GroupTypeRef=_apiEntitiesSysGroup.GroupTypeRef},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,loadMultiple=_apiMainEntity.loadMultiple},function(_apiEntitiesSysUser){UserTypeRef=_apiEntitiesSysUser.UserTypeRef},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiCommonUtilsUtils){getGroupInfoDisplayName=_apiCommonUtilsUtils.getGroupInfoDisplayName,getUserGroupMemberships=_apiCommonUtilsUtils.getUserGroupMemberships,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiCommonTutanotaConstants){GroupType=_apiCommonTutanotaConstants.GroupType},function(_apiCommonUtilsArrayUtils){flat=_apiCommonUtilsArrayUtils.flat}],execute:function(){_export("GroupData",GroupData=function GroupData(groupId,displayName){_classCallCheck(this,GroupData),this.groupId=groupId,this.displayName=displayName}),_export("GroupData",GroupData)}}}),System.register("src/gui/base/DatePicker.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","./TextField","mithril","mithril/stream/stream.js","./icons/Icons","./Button","../../misc/ClientDetector","../../misc/Formatter","../../misc/LanguageViewModel","../size","./Dialog","../theme","./icons/BootIcons","../../api/common/utils/Utils","./Icon","../../api/common/utils/DateUtils","../../calendar/CalendarUtils","luxon"],function(_export,_context){"use strict";var _classCallCheck,_createClass,TextField,m,stream,Icons,Button,client,formatDate,formatDateWithMonth,formatMonthWithFullYear,parseDate,lang,px,Dialog,theme,BootIcons,neverNull,Icon,getDateIndicator,getStartOfDay,isSameDayOfDate,getCalendarMonth,DateTime,DatePicker,VisualDatePicker;function addMonth(date,toAdd){if(client.isIE()){var newDate=new Date(date);return newDate.setMonth(newDate.getMonth()+toAdd),newDate}return DateTime.fromJSDate(date).plus({months:toAdd}).toJSDate()}return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_TextField){TextField=_TextField.TextField},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_iconsIcons){Icons=_iconsIcons.Icons},function(_Button){Button=_Button.Button},function(_miscClientDetector){client=_miscClientDetector.client},function(_miscFormatter){formatDate=_miscFormatter.formatDate,formatDateWithMonth=_miscFormatter.formatDateWithMonth,formatMonthWithFullYear=_miscFormatter.formatMonthWithFullYear,parseDate=_miscFormatter.parseDate},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_size){px=_size.px},function(_Dialog){Dialog=_Dialog.Dialog},function(_theme){theme=_theme.theme},function(_iconsBootIcons){BootIcons=_iconsBootIcons.BootIcons},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_Icon){Icon=_Icon.Icon},function(_apiCommonUtilsDateUtils){getDateIndicator=_apiCommonUtilsDateUtils.getDateIndicator,getStartOfDay=_apiCommonUtilsDateUtils.getStartOfDay,isSameDayOfDate=_apiCommonUtilsDateUtils.isSameDayOfDate},function(_calendarCalendarUtils){getCalendarMonth=_calendarCalendarUtils.getCalendarMonth},function(_luxon){DateTime=_luxon.DateTime}],execute:function(){_export("DatePicker",DatePicker=function(){function DatePicker(startOfTheWeekOffset,labelTextIdOrTextFunction){var nullSelectionTextId=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"emptyString_msg",_this=this,forceCompact=arguments.length>3&&void 0!==arguments[3]&&arguments[3],disabled=arguments.length>4&&void 0!==arguments[4]&&arguments[4];_classCallCheck(this,DatePicker),this.view=function(vnode){return m("",[m(_this.input),_this._forceCompact||client.isMobileDevice()?null:m(VisualDatePicker,{selectedDate:_this.date(),onDateSelected:function(newDate){return _this.setDate(newDate)},wide:!1,startOfTheWeekOffset:_this._startOfTheWeekOffset})])},this._showPickerDialog=function(){var dialog=Dialog.showActionDialog({title:"",child:{view:function(){return m(VisualDatePicker,{selectedDate:_this.date(),onDateSelected:function(newDate,dayClick){dayClick&&(_this.setDate(newDate),dialog.close())},wide:!0,startOfTheWeekOffset:_this._startOfTheWeekOffset})}},okAction:null,allowCancel:!0})},this.date=stream(null),this._forceCompact=forceCompact,this._startOfTheWeekOffset=startOfTheWeekOffset;var pickerButton=new Button(labelTextIdOrTextFunction,this._showPickerDialog,function(){return BootIcons.Calendar}),inputDate=void 0;this.invalidDate=!1,this.input=new TextField(labelTextIdOrTextFunction,function(){return _this.invalidDate?lang.get("invalidDateFormat_msg",{"{1}":formatDate(new Date)}):null!=_this.date()?formatDateWithMonth(neverNull(inputDate)):lang.get(nullSelectionTextId)}),disabled&&this.input.setDisabled(),this.input._injectionsRight=function(){return!forceCompact&&!client.isMobileDevice()||disabled?null:[m(pickerButton)]},this.input.onUpdate(function(value){try{if(value.trim().length>0){var timestamp=parseDate(value);isNaN(timestamp)?(_this.invalidDate=!1,inputDate=null):(_this.invalidDate=!1,inputDate=new Date(timestamp))}else _this.invalidDate=!1,inputDate=null}catch(e){_this.invalidDate=!0}}),this.input.onblur.map(function(){_this.date(inputDate)})}return _createClass(DatePicker,[{key:"setDate",value:function(date){this.invalidDate=!1,this.date(date),this.input.isEmpty()&&this.input._domInput&&this.input.animate(),this.input.value(null!=date?formatDate(date):"")}}]),DatePicker}()),_export("DatePicker",DatePicker),_export("VisualDatePicker",VisualDatePicker=function(){function VisualDatePicker(vnode){var _this2=this;_classCallCheck(this,VisualDatePicker),this._onPrevMonthSelected=function(attrs){_this2._displayingDate.setMonth(_this2._displayingDate.getMonth()-1);var selectedDate=addMonth(_this2._lastSelectedDate||new Date,-1);attrs.onDateSelected&&attrs.onDateSelected(selectedDate,!1)},this._onNextMonthSelected=function(attrs){_this2._displayingDate.setMonth(_this2._displayingDate.getMonth()+1);var selectedDate=addMonth(_this2._lastSelectedDate||new Date,1);attrs.onDateSelected&&attrs.onDateSelected(selectedDate,!1)},this._displayingDate=vnode.attrs.selectedDate||getStartOfDay(new Date)}return _createClass(VisualDatePicker,[{key:"view",value:function(vnode){var _this3=this,selectedDate=vnode.attrs.selectedDate;this._currentDate=getStartOfDay(new Date),selectedDate&&!isSameDayOfDate(this._lastSelectedDate,selectedDate)&&(this._lastSelectedDate=selectedDate,this._displayingDate=new Date(selectedDate),this._displayingDate.setDate(1));var date=new Date(this._displayingDate),_getCalendarMonth=getCalendarMonth(this._displayingDate,vnode.attrs.startOfTheWeekOffset,!0),weeks=_getCalendarMonth.weeks,weekdays=_getCalendarMonth.weekdays;return m(".flex.flex-column",[m(".flex.flex-space-between.pt-s.pb-s.items-center",[this._switchMonthArrowIcon(!1,vnode.attrs),m(".b",{style:{fontSize:px(14)}},formatMonthWithFullYear(date)),this._switchMonthArrowIcon(!0,vnode.attrs)]),m(".flex.flex-space-between",this._weekdaysVdom(vnode.attrs.wide,weekdays)),m(".flex.flex-column.flex-space-around",{style:{fontSize:px(14),lineHeight:px(this._elWidth(vnode.attrs))}},weeks.map(function(w){return _this3._weekVdom(w,vnode.attrs)}))])}},{key:"_switchMonthArrowIcon",value:function(forward,attrs){var _this4=this,size=px(this._elWidth(attrs));return m(".icon.flex.justify-center.items-center.click",{onclick:forward?function(){return _this4._onNextMonthSelected(attrs)}:function(){return _this4._onPrevMonthSelected(attrs)},style:{fill:theme.content_fg,width:size,height:size}},m(Icon,{icon:forward?Icons.ArrowForward:BootIcons.Back,style:{fill:theme.content_fg}}))}},{key:"_dayVdom",value:function(_ref,attrs){var date=_ref.date,day=_ref.day,paddingDay=_ref.paddingDay,size=px(this._elWidth(attrs));return m(".center.click"+(paddingDay?"":getDateIndicator(date,attrs.selectedDate,this._currentDate)),{style:{height:size,width:size},onclick:!paddingDay&&function(){attrs.onDateSelected&&attrs.onDateSelected(date,!0)}},paddingDay?null:day)}},{key:"_elWidth",value:function(attrs){return attrs.wide?40:24}},{key:"_weekVdom",value:function(week,attrs){var _this5=this;return m(".flex.flex-space-between",week.map(function(d){return _this5._dayVdom(d,attrs)}))}},{key:"_weekdaysVdom",value:function(wide,weekdays){var size=px(wide?40:24),fontSize=px(14);return weekdays.map(function(wd){return m(".center",{style:{fontSize:fontSize,height:size,width:size,lineHeight:size,color:theme.content_border}},wd)})}}]),VisualDatePicker}()),_export("VisualDatePicker",VisualDatePicker)}}}),System.registerDynamic("libs/luxon.js",[],!0,function($__require,exports,module){"use strict";this||self;function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _inheritsLoose(subClass,superClass){subClass.prototype=Object.create(superClass.prototype),subClass.prototype.constructor=subClass,subClass.__proto__=superClass}function _getPrototypeOf(o){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o})(o,p)}function _construct(Parent,args,Class){return(_construct=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(Parent,args,Class){var a=[null];a.push.apply(a,args);var instance=new(Function.bind.apply(Parent,a));return Class&&_setPrototypeOf(instance,Class.prototype),instance}).apply(null,arguments)}function _wrapNativeSuper(Class){var _cache="function"==typeof Map?new Map:void 0;return(_wrapNativeSuper=function(Class){if(null===Class||(fn=Class,-1===Function.toString.call(fn).indexOf("[native code]")))return Class;var fn;if("function"!=typeof Class)throw new TypeError("Super expression must either be null or a function");if(void 0!==_cache){if(_cache.has(Class))return _cache.get(Class);_cache.set(Class,Wrapper)}function Wrapper(){return _construct(Class,arguments,_getPrototypeOf(this).constructor)}return Wrapper.prototype=Object.create(Class.prototype,{constructor:{value:Wrapper,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(Wrapper,Class)})(Class)}Object.defineProperty(exports,"__esModule",{value:!0});var LuxonError=function(_Error){function LuxonError(){return _Error.apply(this,arguments)||this}return _inheritsLoose(LuxonError,_Error),LuxonError}(_wrapNativeSuper(Error)),InvalidDateTimeError=function(_LuxonError){function InvalidDateTimeError(reason){return _LuxonError.call(this,"Invalid DateTime: "+reason.toMessage())||this}return _inheritsLoose(InvalidDateTimeError,_LuxonError),InvalidDateTimeError}(LuxonError),InvalidIntervalError=function(_LuxonError2){function InvalidIntervalError(reason){return _LuxonError2.call(this,"Invalid Interval: "+reason.toMessage())||this}return _inheritsLoose(InvalidIntervalError,_LuxonError2),InvalidIntervalError}(LuxonError),InvalidDurationError=function(_LuxonError3){function InvalidDurationError(reason){return _LuxonError3.call(this,"Invalid Duration: "+reason.toMessage())||this}return _inheritsLoose(InvalidDurationError,_LuxonError3),InvalidDurationError}(LuxonError),ConflictingSpecificationError=function(_LuxonError4){function ConflictingSpecificationError(){return _LuxonError4.apply(this,arguments)||this}return _inheritsLoose(ConflictingSpecificationError,_LuxonError4),ConflictingSpecificationError}(LuxonError),InvalidUnitError=function(_LuxonError5){function InvalidUnitError(unit){return _LuxonError5.call(this,"Invalid unit "+unit)||this}return _inheritsLoose(InvalidUnitError,_LuxonError5),InvalidUnitError}(LuxonError),InvalidArgumentError=function(_LuxonError6){function InvalidArgumentError(){return _LuxonError6.apply(this,arguments)||this}return _inheritsLoose(InvalidArgumentError,_LuxonError6),InvalidArgumentError}(LuxonError),ZoneIsAbstractError=function(_LuxonError7){function ZoneIsAbstractError(){return _LuxonError7.call(this,"Zone is an abstract class")||this}return _inheritsLoose(ZoneIsAbstractError,_LuxonError7),ZoneIsAbstractError}(LuxonError),n="numeric",s="short",l="long",DATE_SHORT={year:n,month:n,day:n},DATE_MED={year:n,month:s,day:n},DATE_FULL={year:n,month:l,day:n},DATE_HUGE={year:n,month:l,day:n,weekday:l},TIME_SIMPLE={hour:n,minute:n},TIME_WITH_SECONDS={hour:n,minute:n,second:n},TIME_WITH_SHORT_OFFSET={hour:n,minute:n,second:n,timeZoneName:s},TIME_WITH_LONG_OFFSET={hour:n,minute:n,second:n,timeZoneName:l},TIME_24_SIMPLE={hour:n,minute:n,hour12:!1},TIME_24_WITH_SECONDS={hour:n,minute:n,second:n,hour12:!1},TIME_24_WITH_SHORT_OFFSET={hour:n,minute:n,second:n,hour12:!1,timeZoneName:s},TIME_24_WITH_LONG_OFFSET={hour:n,minute:n,second:n,hour12:!1,timeZoneName:l},DATETIME_SHORT={year:n,month:n,day:n,hour:n,minute:n},DATETIME_SHORT_WITH_SECONDS={year:n,month:n,day:n,hour:n,minute:n,second:n},DATETIME_MED={year:n,month:s,day:n,hour:n,minute:n},DATETIME_MED_WITH_SECONDS={year:n,month:s,day:n,hour:n,minute:n,second:n},DATETIME_MED_WITH_WEEKDAY={year:n,month:s,day:n,weekday:s,hour:n,minute:n},DATETIME_FULL={year:n,month:l,day:n,hour:n,minute:n,timeZoneName:s},DATETIME_FULL_WITH_SECONDS={year:n,month:l,day:n,hour:n,minute:n,second:n,timeZoneName:s},DATETIME_HUGE={year:n,month:l,day:n,weekday:l,hour:n,minute:n,timeZoneName:l},DATETIME_HUGE_WITH_SECONDS={year:n,month:l,day:n,weekday:l,hour:n,minute:n,second:n,timeZoneName:l};function isUndefined(o){return void 0===o}function isNumber(o){return"number"==typeof o}function isInteger(o){return"number"==typeof o&&o%1==0}function hasIntl(){try{return"undefined"!=typeof Intl&&Intl.DateTimeFormat}catch(e){return!1}}function hasFormatToParts(){return!isUndefined(Intl.DateTimeFormat.prototype.formatToParts)}function hasRelative(){try{return"undefined"!=typeof Intl&&!!Intl.RelativeTimeFormat}catch(e){return!1}}function bestBy(arr,by,compare){if(0!==arr.length)return arr.reduce(function(best,next){var pair=[by(next),next];return best&&compare(best[0],pair[0])===best[0]?best:pair},null)[1]}function pick(obj,keys){return keys.reduce(function(a,k){return a[k]=obj[k],a},{})}function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}function integerBetween(thing,bottom,top){return isInteger(thing)&&thing>=bottom&&thing<=top}function padStart(input,n){return void 0===n&&(n=2),input.toString().length<n?("0".repeat(n)+input).slice(-n):input.toString()}function parseInteger(string){return isUndefined(string)||null===string||""===string?void 0:parseInt(string,10)}function parseMillis(fraction){if(!isUndefined(fraction)&&null!==fraction&&""!==fraction){var f=1e3*parseFloat("0."+fraction);return Math.floor(f)}}function roundTo(number,digits,towardZero){void 0===towardZero&&(towardZero=!1);var factor=Math.pow(10,digits);return(towardZero?Math.trunc:Math.round)(number*factor)/factor}function isLeapYear(year){return year%4==0&&(year%100!=0||year%400==0)}function daysInYear(year){return isLeapYear(year)?366:365}function daysInMonth(year,month){var x,n,modMonth=(x=month-1)-(n=12)*Math.floor(x/n)+1;return 2===modMonth?isLeapYear(year+(month-modMonth)/12)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][modMonth-1]}function objToLocalTS(obj){var d=Date.UTC(obj.year,obj.month-1,obj.day,obj.hour,obj.minute,obj.second,obj.millisecond);return obj.year<100&&obj.year>=0&&(d=new Date(d)).setUTCFullYear(d.getUTCFullYear()-1900),+d}function weeksInWeekYear(weekYear){var p1=(weekYear+Math.floor(weekYear/4)-Math.floor(weekYear/100)+Math.floor(weekYear/400))%7,last=weekYear-1,p2=(last+Math.floor(last/4)-Math.floor(last/100)+Math.floor(last/400))%7;return 4===p1||3===p2?53:52}function untruncateYear(year){return year>99?year:year>60?1900+year:2e3+year}function parseZoneInfo(ts,offsetFormat,locale,timeZone){void 0===timeZone&&(timeZone=null);var date=new Date(ts),intlOpts={hour12:!1,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};timeZone&&(intlOpts.timeZone=timeZone);var modified=Object.assign({timeZoneName:offsetFormat},intlOpts),intl=hasIntl();if(intl&&hasFormatToParts()){var parsed=new Intl.DateTimeFormat(locale,modified).formatToParts(date).find(function(m){return"timezonename"===m.type.toLowerCase()});return parsed?parsed.value:null}if(intl){var without=new Intl.DateTimeFormat(locale,intlOpts).format(date);return new Intl.DateTimeFormat(locale,modified).format(date).substring(without.length).replace(/^[, \u200e]+/,"")}return null}function signedOffset(offHourStr,offMinuteStr){var offHour=parseInt(offHourStr,10);Number.isNaN(offHour)&&(offHour=0);var offMin=parseInt(offMinuteStr,10)||0;return 60*offHour+(offHour<0||Object.is(offHour,-0)?-offMin:offMin)}function asNumber(value){var numericValue=Number(value);if("boolean"==typeof value||""===value||Number.isNaN(numericValue))throw new InvalidArgumentError("Invalid unit value "+value);return numericValue}function normalizeObject(obj,normalizer,nonUnitKeys){var normalized={};for(var u in obj)if(hasOwnProperty(obj,u)){if(nonUnitKeys.indexOf(u)>=0)continue;var v=obj[u];if(null==v)continue;normalized[normalizer(u)]=asNumber(v)}return normalized}function formatOffset(offset,format){var hours=Math.trunc(offset/60),minutes=Math.abs(offset%60),sign=hours>=0&&!Object.is(hours,-0)?"+":"-",base=""+sign+Math.abs(hours);switch(format){case"short":return""+sign+padStart(Math.abs(hours),2)+":"+padStart(minutes,2);case"narrow":return minutes>0?base+":"+minutes:base;case"techie":return""+sign+padStart(Math.abs(hours),2)+padStart(minutes,2);default:throw new RangeError("Value format "+format+" is out of range for property format")}}function timeObject(obj){return pick(obj,["hour","minute","second","millisecond"])}var ianaRegex=/[A-Za-z_+-]{1,256}(:?\/[A-Za-z_+-]{1,256}(\/[A-Za-z_+-]{1,256})?)?/;function stringify(obj){return JSON.stringify(obj,Object.keys(obj).sort())}var monthsLong=["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],monthsNarrow=["J","F","M","A","M","J","J","A","S","O","N","D"];function months(length){switch(length){case"narrow":return monthsNarrow;case"short":return monthsShort;case"long":return monthsLong;case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}var weekdaysLong=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],weekdaysShort=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],weekdaysNarrow=["M","T","W","T","F","S","S"];function weekdays(length){switch(length){case"narrow":return weekdaysNarrow;case"short":return weekdaysShort;case"long":return weekdaysLong;case"numeric":return["1","2","3","4","5","6","7"];default:return null}}var meridiems=["AM","PM"],erasLong=["Before Christ","Anno Domini"],erasShort=["BC","AD"],erasNarrow=["B","A"];function eras(length){switch(length){case"narrow":return erasNarrow;case"short":return erasShort;case"long":return erasLong;default:return null}}function stringifyTokens(splits,tokenToString){var s="",_iterator=splits,_isArray=Array.isArray(_iterator),_i=0;for(_iterator=_isArray?_iterator:_iterator[Symbol.iterator]();;){var _ref;if(_isArray){if(_i>=_iterator.length)break;_ref=_iterator[_i++]}else{if((_i=_iterator.next()).done)break;_ref=_i.value}var token=_ref;token.literal?s+=token.val:s+=tokenToString(token.val)}return s}var _macroTokenToFormatOpts={D:DATE_SHORT,DD:DATE_MED,DDD:DATE_FULL,DDDD:DATE_HUGE,t:TIME_SIMPLE,tt:TIME_WITH_SECONDS,ttt:TIME_WITH_SHORT_OFFSET,tttt:TIME_WITH_LONG_OFFSET,T:TIME_24_SIMPLE,TT:TIME_24_WITH_SECONDS,TTT:TIME_24_WITH_SHORT_OFFSET,TTTT:TIME_24_WITH_LONG_OFFSET,f:DATETIME_SHORT,ff:DATETIME_MED,fff:DATETIME_FULL,ffff:DATETIME_HUGE,F:DATETIME_SHORT_WITH_SECONDS,FF:DATETIME_MED_WITH_SECONDS,FFF:DATETIME_FULL_WITH_SECONDS,FFFF:DATETIME_HUGE_WITH_SECONDS},Formatter=function(){function Formatter(locale,formatOpts){this.opts=formatOpts,this.loc=locale,this.systemLoc=null}Formatter.create=function(locale,opts){return void 0===opts&&(opts={}),new Formatter(locale,opts)},Formatter.parseFormat=function(fmt){for(var current=null,currentFull="",bracketed=!1,splits=[],i=0;i<fmt.length;i++){var c=fmt.charAt(i);"'"===c?(currentFull.length>0&&splits.push({literal:bracketed,val:currentFull}),current=null,currentFull="",bracketed=!bracketed):bracketed?currentFull+=c:c===current?currentFull+=c:(currentFull.length>0&&splits.push({literal:!1,val:currentFull}),currentFull=c,current=c)}return currentFull.length>0&&splits.push({literal:bracketed,val:currentFull}),splits},Formatter.macroTokenToFormatOpts=function(token){return _macroTokenToFormatOpts[token]};var _proto=Formatter.prototype;return _proto.formatWithSystemDefault=function(dt,opts){return null===this.systemLoc&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(dt,Object.assign({},this.opts,opts)).format()},_proto.formatDateTime=function(dt,opts){return void 0===opts&&(opts={}),this.loc.dtFormatter(dt,Object.assign({},this.opts,opts)).format()},_proto.formatDateTimeParts=function(dt,opts){return void 0===opts&&(opts={}),this.loc.dtFormatter(dt,Object.assign({},this.opts,opts)).formatToParts()},_proto.resolvedOptions=function(dt,opts){return void 0===opts&&(opts={}),this.loc.dtFormatter(dt,Object.assign({},this.opts,opts)).resolvedOptions()},_proto.num=function(n,p){if(void 0===p&&(p=0),this.opts.forceSimple)return padStart(n,p);var opts=Object.assign({},this.opts);return p>0&&(opts.padTo=p),this.loc.numberFormatter(opts).format(n)},_proto.formatDateTimeFromString=function(dt,fmt){var _this=this,knownEnglish="en"===this.loc.listingMode(),useDateTimeFormatter=this.loc.outputCalendar&&"gregory"!==this.loc.outputCalendar&&hasFormatToParts(),string=function(opts,extract){return _this.loc.extract(dt,opts,extract)},formatOffset=function(opts){return dt.isOffsetFixed&&0===dt.offset&&opts.allowZ?"Z":dt.isValid?dt.zone.formatOffset(dt.ts,opts.format):""},meridiem=function(){return knownEnglish?function(dt){return meridiems[dt.hour<12?0:1]}(dt):string({hour:"numeric",hour12:!0},"dayperiod")},month=function(length,standalone){return knownEnglish?function(dt,length){return months(length)[dt.month-1]}(dt,length):string(standalone?{month:length}:{month:length,day:"numeric"},"month")},weekday=function(length,standalone){return knownEnglish?function(dt,length){return weekdays(length)[dt.weekday-1]}(dt,length):string(standalone?{weekday:length}:{weekday:length,month:"long",day:"numeric"},"weekday")},era=function(length){return knownEnglish?function(dt,length){return eras(length)[dt.year<0?0:1]}(dt,length):string({era:length},"era")};return stringifyTokens(Formatter.parseFormat(fmt),function(token){switch(token){case"S":return _this.num(dt.millisecond);case"u":case"SSS":return _this.num(dt.millisecond,3);case"s":return _this.num(dt.second);case"ss":return _this.num(dt.second,2);case"m":return _this.num(dt.minute);case"mm":return _this.num(dt.minute,2);case"h":return _this.num(dt.hour%12==0?12:dt.hour%12);case"hh":return _this.num(dt.hour%12==0?12:dt.hour%12,2);case"H":return _this.num(dt.hour);case"HH":return _this.num(dt.hour,2);case"Z":return formatOffset({format:"narrow",allowZ:_this.opts.allowZ});case"ZZ":return formatOffset({format:"short",allowZ:_this.opts.allowZ});case"ZZZ":return formatOffset({format:"techie",allowZ:!1});case"ZZZZ":return dt.zone.offsetName(dt.ts,{format:"short",locale:_this.loc.locale});case"ZZZZZ":return dt.zone.offsetName(dt.ts,{format:"long",locale:_this.loc.locale});case"z":return dt.zoneName;case"a":return meridiem();case"d":return useDateTimeFormatter?string({day:"numeric"},"day"):_this.num(dt.day);case"dd":return useDateTimeFormatter?string({day:"2-digit"},"day"):_this.num(dt.day,2);case"c":return _this.num(dt.weekday);case"ccc":return weekday("short",!0);case"cccc":return weekday("long",!0);case"ccccc":return weekday("narrow",!0);case"E":return _this.num(dt.weekday);case"EEE":return weekday("short",!1);case"EEEE":return weekday("long",!1);case"EEEEE":return weekday("narrow",!1);case"L":return useDateTimeFormatter?string({month:"numeric",day:"numeric"},"month"):_this.num(dt.month);case"LL":return useDateTimeFormatter?string({month:"2-digit",day:"numeric"},"month"):_this.num(dt.month,2);case"LLL":return month("short",!0);case"LLLL":return month("long",!0);case"LLLLL":return month("narrow",!0);case"M":return useDateTimeFormatter?string({month:"numeric"},"month"):_this.num(dt.month);case"MM":return useDateTimeFormatter?string({month:"2-digit"},"month"):_this.num(dt.month,2);case"MMM":return month("short",!1);case"MMMM":return month("long",!1);case"MMMMM":return month("narrow",!1);case"y":return useDateTimeFormatter?string({year:"numeric"},"year"):_this.num(dt.year);case"yy":return useDateTimeFormatter?string({year:"2-digit"},"year"):_this.num(dt.year.toString().slice(-2),2);case"yyyy":return useDateTimeFormatter?string({year:"numeric"},"year"):_this.num(dt.year,4);case"yyyyyy":return useDateTimeFormatter?string({year:"numeric"},"year"):_this.num(dt.year,6);case"G":return era("short");case"GG":return era("long");case"GGGGG":return era("narrow");case"kk":return _this.num(dt.weekYear.toString().slice(-2),2);case"kkkk":return _this.num(dt.weekYear,4);case"W":return _this.num(dt.weekNumber);case"WW":return _this.num(dt.weekNumber,2);case"o":return _this.num(dt.ordinal);case"ooo":return _this.num(dt.ordinal,3);case"q":return _this.num(dt.quarter);case"qq":return _this.num(dt.quarter,2);case"X":return _this.num(Math.floor(dt.ts/1e3));case"x":return _this.num(dt.ts);default:return function(token){var formatOpts=Formatter.macroTokenToFormatOpts(token);return formatOpts?_this.formatWithSystemDefault(dt,formatOpts):token}(token)}})},_proto.formatDurationFromString=function(dur,fmt){var lildur,_this2=this,tokenToField=function(token){switch(token[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"M":return"month";case"y":return"year";default:return null}},tokens=Formatter.parseFormat(fmt),realTokens=tokens.reduce(function(found,_ref2){var literal=_ref2.literal,val=_ref2.val;return literal?found:found.concat(val)},[]),collapsed=dur.shiftTo.apply(dur,realTokens.map(tokenToField).filter(function(t){return t}));return stringifyTokens(tokens,(lildur=collapsed,function(token){var mapped=tokenToField(token);return mapped?_this2.num(lildur.get(mapped),token.length):token}))},Formatter}(),Invalid=function(){function Invalid(reason,explanation){this.reason=reason,this.explanation=explanation}return Invalid.prototype.toMessage=function(){return this.explanation?this.reason+": "+this.explanation:this.reason},Invalid}(),Zone=function(){function Zone(){}var _proto=Zone.prototype;return _proto.offsetName=function(ts,opts){throw new ZoneIsAbstractError},_proto.formatOffset=function(ts,format){throw new ZoneIsAbstractError},_proto.offset=function(ts){throw new ZoneIsAbstractError},_proto.equals=function(otherZone){throw new ZoneIsAbstractError},_createClass(Zone,[{key:"type",get:function(){throw new ZoneIsAbstractError}},{key:"name",get:function(){throw new ZoneIsAbstractError}},{key:"universal",get:function(){throw new ZoneIsAbstractError}},{key:"isValid",get:function(){throw new ZoneIsAbstractError}}]),Zone}(),singleton=null,LocalZone=function(_Zone){function LocalZone(){return _Zone.apply(this,arguments)||this}_inheritsLoose(LocalZone,_Zone);var _proto=LocalZone.prototype;return _proto.offsetName=function(ts,_ref){return parseZoneInfo(ts,_ref.format,_ref.locale)},_proto.formatOffset=function(ts,format){return formatOffset(this.offset(ts),format)},_proto.offset=function(ts){return-new Date(ts).getTimezoneOffset()},_proto.equals=function(otherZone){return"local"===otherZone.type},_createClass(LocalZone,[{key:"type",get:function(){return"local"}},{key:"name",get:function(){return hasIntl()?(new Intl.DateTimeFormat).resolvedOptions().timeZone:"local"}},{key:"universal",get:function(){return!1}},{key:"isValid",get:function(){return!0}}],[{key:"instance",get:function(){return null===singleton&&(singleton=new LocalZone),singleton}}]),LocalZone}(Zone),matchingRegex=RegExp("^"+ianaRegex.source+"$"),dtfCache={};var typeToPos={year:0,month:1,day:2,hour:3,minute:4,second:5};var ianaZoneCache={},IANAZone=function(_Zone){function IANAZone(name){var _this;return(_this=_Zone.call(this)||this).zoneName=name,_this.valid=IANAZone.isValidZone(name),_this}_inheritsLoose(IANAZone,_Zone),IANAZone.create=function(name){return ianaZoneCache[name]||(ianaZoneCache[name]=new IANAZone(name)),ianaZoneCache[name]},IANAZone.resetCache=function(){ianaZoneCache={},dtfCache={}},IANAZone.isValidSpecifier=function(s){return!(!s||!s.match(matchingRegex))},IANAZone.isValidZone=function(zone){try{return new Intl.DateTimeFormat("en-US",{timeZone:zone}).format(),!0}catch(e){return!1}},IANAZone.parseGMTOffset=function(specifier){if(specifier){var match=specifier.match(/^Etc\/GMT([+-]\d{1,2})$/i);if(match)return-60*parseInt(match[1])}return null};var _proto=IANAZone.prototype;return _proto.offsetName=function(ts,_ref){return parseZoneInfo(ts,_ref.format,_ref.locale,this.name)},_proto.formatOffset=function(ts,format){return formatOffset(this.offset(ts),format)},_proto.offset=function(ts){var zone,date=new Date(ts),dtf=(zone=this.name,dtfCache[zone]||(dtfCache[zone]=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:zone,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})),dtfCache[zone]),_ref2=dtf.formatToParts?function(dtf,date){for(var formatted=dtf.formatToParts(date),filled=[],i=0;i<formatted.length;i++){var _formatted$i=formatted[i],type=_formatted$i.type,value=_formatted$i.value,pos=typeToPos[type];isUndefined(pos)||(filled[pos]=parseInt(value,10))}return filled}(dtf,date):function(dtf,date){var formatted=dtf.format(date).replace(/\u200E/g,""),parsed=/(\d+)\/(\d+)\/(\d+),? (\d+):(\d+):(\d+)/.exec(formatted),fMonth=parsed[1],fDay=parsed[2];return[parsed[3],fMonth,fDay,parsed[4],parsed[5],parsed[6]]}(dtf,date),year=_ref2[0],month=_ref2[1],day=_ref2[2],hour=_ref2[3],asTS=+date,over=asTS%1e3;return(objToLocalTS({year:year,month:month,day:day,hour:24===hour?0:hour,minute:_ref2[4],second:_ref2[5],millisecond:0})-(asTS-=over>=0?over:1e3+over))/6e4},_proto.equals=function(otherZone){return"iana"===otherZone.type&&otherZone.name===this.name},_createClass(IANAZone,[{key:"type",get:function(){return"iana"}},{key:"name",get:function(){return this.zoneName}},{key:"universal",get:function(){return!1}},{key:"isValid",get:function(){return this.valid}}]),IANAZone}(Zone),singleton$1=null,FixedOffsetZone=function(_Zone){function FixedOffsetZone(offset){var _this;return(_this=_Zone.call(this)||this).fixed=offset,_this}_inheritsLoose(FixedOffsetZone,_Zone),FixedOffsetZone.instance=function(offset){return 0===offset?FixedOffsetZone.utcInstance:new FixedOffsetZone(offset)},FixedOffsetZone.parseSpecifier=function(s){if(s){var r=s.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(r)return new FixedOffsetZone(signedOffset(r[1],r[2]))}return null},_createClass(FixedOffsetZone,null,[{key:"utcInstance",get:function(){return null===singleton$1&&(singleton$1=new FixedOffsetZone(0)),singleton$1}}]);var _proto=FixedOffsetZone.prototype;return _proto.offsetName=function(){return this.name},_proto.formatOffset=function(ts,format){return formatOffset(this.fixed,format)},_proto.offset=function(){return this.fixed},_proto.equals=function(otherZone){return"fixed"===otherZone.type&&otherZone.fixed===this.fixed},_createClass(FixedOffsetZone,[{key:"type",get:function(){return"fixed"}},{key:"name",get:function(){return 0===this.fixed?"UTC":"UTC"+formatOffset(this.fixed,"narrow")}},{key:"universal",get:function(){return!0}},{key:"isValid",get:function(){return!0}}]),FixedOffsetZone}(Zone),InvalidZone=function(_Zone){function InvalidZone(zoneName){var _this;return(_this=_Zone.call(this)||this).zoneName=zoneName,_this}_inheritsLoose(InvalidZone,_Zone);var _proto=InvalidZone.prototype;return _proto.offsetName=function(){return null},_proto.formatOffset=function(){return""},_proto.offset=function(){return NaN},_proto.equals=function(){return!1},_createClass(InvalidZone,[{key:"type",get:function(){return"invalid"}},{key:"name",get:function(){return this.zoneName}},{key:"universal",get:function(){return!1}},{key:"isValid",get:function(){return!1}}]),InvalidZone}(Zone);function normalizeZone(input,defaultZone){var offset;if(isUndefined(input)||null===input)return defaultZone;if(input instanceof Zone)return input;if("string"==typeof input){var lowered=input.toLowerCase();return"local"===lowered?defaultZone:"utc"===lowered||"gmt"===lowered?FixedOffsetZone.utcInstance:null!=(offset=IANAZone.parseGMTOffset(input))?FixedOffsetZone.instance(offset):IANAZone.isValidSpecifier(lowered)?IANAZone.create(input):FixedOffsetZone.parseSpecifier(lowered)||new InvalidZone(input)}return isNumber(input)?FixedOffsetZone.instance(input):"object"==typeof input&&input.offset&&"number"==typeof input.offset?input:new InvalidZone(input)}var now=function(){return Date.now()},defaultZone=null,defaultLocale=null,defaultNumberingSystem=null,defaultOutputCalendar=null,throwOnInvalid=!1,Settings=function(){function Settings(){}return Settings.resetCaches=function(){Locale.resetCache(),IANAZone.resetCache()},_createClass(Settings,null,[{key:"now",get:function(){return now},set:function(n){now=n}},{key:"defaultZoneName",get:function(){return Settings.defaultZone.name},set:function(z){defaultZone=z?normalizeZone(z):null}},{key:"defaultZone",get:function(){return defaultZone||LocalZone.instance}},{key:"defaultLocale",get:function(){return defaultLocale},set:function(locale){defaultLocale=locale}},{key:"defaultNumberingSystem",get:function(){return defaultNumberingSystem},set:function(numberingSystem){defaultNumberingSystem=numberingSystem}},{key:"defaultOutputCalendar",get:function(){return defaultOutputCalendar},set:function(outputCalendar){defaultOutputCalendar=outputCalendar}},{key:"throwOnInvalid",get:function(){return throwOnInvalid},set:function(t){throwOnInvalid=t}}]),Settings}(),intlDTCache={};function getCachedDTF(locString,opts){void 0===opts&&(opts={});var key=JSON.stringify([locString,opts]),dtf=intlDTCache[key];return dtf||(dtf=new Intl.DateTimeFormat(locString,opts),intlDTCache[key]=dtf),dtf}var intlNumCache={};var intlRelCache={};function getCachedRTF(locString,opts){void 0===opts&&(opts={});var _opts=opts,cacheKeyOpts=(_opts.base,function(source,excluded){if(null==source)return{};var key,i,target={},sourceKeys=Object.keys(source);for(i=0;i<sourceKeys.length;i++)key=sourceKeys[i],excluded.indexOf(key)>=0||(target[key]=source[key]);return target}(_opts,["base"])),key=JSON.stringify([locString,cacheKeyOpts]),inf=intlRelCache[key];return inf||(inf=new Intl.RelativeTimeFormat(locString,opts),intlRelCache[key]=inf),inf}var sysLocaleCache=null;function listStuff(loc,length,defaultOK,englishFn,intlFn){var mode=loc.listingMode(defaultOK);return"error"===mode?null:"en"===mode?englishFn(length):intlFn(length)}var PolyNumberFormatter=function(){function PolyNumberFormatter(intl,forceSimple,opts){if(this.padTo=opts.padTo||0,this.floor=opts.floor||!1,!forceSimple&&hasIntl()){var intlOpts={useGrouping:!1};opts.padTo>0&&(intlOpts.minimumIntegerDigits=opts.padTo),this.inf=function(locString,opts){void 0===opts&&(opts={});var key=JSON.stringify([locString,opts]),inf=intlNumCache[key];return inf||(inf=new Intl.NumberFormat(locString,opts),intlNumCache[key]=inf),inf}(intl,intlOpts)}}return PolyNumberFormatter.prototype.format=function(i){if(this.inf){var fixed=this.floor?Math.floor(i):i;return this.inf.format(fixed)}return padStart(this.floor?Math.floor(i):roundTo(i,3),this.padTo)},PolyNumberFormatter}(),PolyDateFormatter=function(){function PolyDateFormatter(dt,intl,opts){var z;if(this.opts=opts,this.hasIntl=hasIntl(),dt.zone.universal&&this.hasIntl?(z="UTC",opts.timeZoneName?this.dt=dt:this.dt=0===dt.offset?dt:DateTime.fromMillis(dt.ts+60*dt.offset*1e3)):"local"===dt.zone.type?this.dt=dt:(this.dt=dt,z=dt.zone.name),this.hasIntl){var intlOpts=Object.assign({},this.opts);z&&(intlOpts.timeZone=z),this.dtf=getCachedDTF(intl,intlOpts)}}var _proto2=PolyDateFormatter.prototype;return _proto2.format=function(){if(this.hasIntl)return this.dtf.format(this.dt.toJSDate());var tokenFormat=function(knownFormat){switch(stringify(pick(knownFormat,["weekday","era","year","month","day","hour","minute","second","timeZoneName","hour12"]))){case stringify(DATE_SHORT):return"M/d/yyyy";case stringify(DATE_MED):return"LLL d, yyyy";case stringify(DATE_FULL):return"LLLL d, yyyy";case stringify(DATE_HUGE):return"EEEE, LLLL d, yyyy";case stringify(TIME_SIMPLE):return"h:mm a";case stringify(TIME_WITH_SECONDS):return"h:mm:ss a";case stringify(TIME_WITH_SHORT_OFFSET):case stringify(TIME_WITH_LONG_OFFSET):return"h:mm a";case stringify(TIME_24_SIMPLE):return"HH:mm";case stringify(TIME_24_WITH_SECONDS):return"HH:mm:ss";case stringify(TIME_24_WITH_SHORT_OFFSET):case stringify(TIME_24_WITH_LONG_OFFSET):return"HH:mm";case stringify(DATETIME_SHORT):return"M/d/yyyy, h:mm a";case stringify(DATETIME_MED):return"LLL d, yyyy, h:mm a";case stringify(DATETIME_FULL):return"LLLL d, yyyy, h:mm a";case stringify(DATETIME_HUGE):return"EEEE, LLLL d, yyyy, h:mm a";case stringify(DATETIME_SHORT_WITH_SECONDS):return"M/d/yyyy, h:mm:ss a";case stringify(DATETIME_MED_WITH_SECONDS):return"LLL d, yyyy, h:mm:ss a";case stringify(DATETIME_MED_WITH_WEEKDAY):return"EEE, d LLL yyyy, h:mm a";case stringify(DATETIME_FULL_WITH_SECONDS):return"LLLL d, yyyy, h:mm:ss a";case stringify(DATETIME_HUGE_WITH_SECONDS):return"EEEE, LLLL d, yyyy, h:mm:ss a";default:return"EEEE, LLLL d, yyyy, h:mm a"}}(this.opts),loc=Locale.create("en-US");return Formatter.create(loc).formatDateTimeFromString(this.dt,tokenFormat)},_proto2.formatToParts=function(){return this.hasIntl&&hasFormatToParts()?this.dtf.formatToParts(this.dt.toJSDate()):[]},_proto2.resolvedOptions=function(){return this.hasIntl?this.dtf.resolvedOptions():{locale:"en-US",numberingSystem:"latn",outputCalendar:"gregory"}},PolyDateFormatter}(),PolyRelFormatter=function(){function PolyRelFormatter(intl,isEnglish,opts){this.opts=Object.assign({style:"long"},opts),!isEnglish&&hasRelative()&&(this.rtf=getCachedRTF(intl,opts))}var _proto3=PolyRelFormatter.prototype;return _proto3.format=function(count,unit){return this.rtf?this.rtf.format(count,unit):function(unit,count,numeric,narrow){void 0===numeric&&(numeric="always"),void 0===narrow&&(narrow=!1);var units={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},lastable=-1===["hours","minutes","seconds"].indexOf(unit);if("auto"===numeric&&lastable){var isDay="days"===unit;switch(count){case 1:return isDay?"tomorrow":"next "+units[unit][0];case-1:return isDay?"yesterday":"last "+units[unit][0];case 0:return isDay?"today":"this "+units[unit][0]}}var isInPast=Object.is(count,-0)||count<0,fmtValue=Math.abs(count),singular=1===fmtValue,lilUnits=units[unit],fmtUnit=narrow?singular?lilUnits[1]:lilUnits[2]||lilUnits[1]:singular?units[unit][0]:unit;return isInPast?fmtValue+" "+fmtUnit+" ago":"in "+fmtValue+" "+fmtUnit}(unit,count,this.opts.numeric,"long"!==this.opts.style)},_proto3.formatToParts=function(count,unit){return this.rtf?this.rtf.formatToParts(count,unit):[]},PolyRelFormatter}(),Locale=function(){function Locale(locale,numbering,outputCalendar,specifiedLocale){var _parseLocaleString=function(localeStr){var uIndex=localeStr.indexOf("-u-");if(-1===uIndex)return[localeStr];var options,smaller=localeStr.substring(0,uIndex);try{options=getCachedDTF(localeStr).resolvedOptions()}catch(e){options=getCachedDTF(smaller).resolvedOptions()}var _options=options;return[smaller,_options.numberingSystem,_options.calendar]}(locale),parsedLocale=_parseLocaleString[0],parsedNumberingSystem=_parseLocaleString[1],parsedOutputCalendar=_parseLocaleString[2];this.locale=parsedLocale,this.numberingSystem=numbering||parsedNumberingSystem||null,this.outputCalendar=outputCalendar||parsedOutputCalendar||null,this.intl=function(localeStr,numberingSystem,outputCalendar){return hasIntl()?outputCalendar||numberingSystem?(localeStr+="-u",outputCalendar&&(localeStr+="-ca-"+outputCalendar),numberingSystem&&(localeStr+="-nu-"+numberingSystem),localeStr):localeStr:[]}(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=specifiedLocale,this.fastNumbersCached=null}Locale.fromOpts=function(opts){return Locale.create(opts.locale,opts.numberingSystem,opts.outputCalendar,opts.defaultToEN)},Locale.create=function(locale,numberingSystem,outputCalendar,defaultToEN){void 0===defaultToEN&&(defaultToEN=!1);var specifiedLocale=locale||Settings.defaultLocale;return new Locale(specifiedLocale||(defaultToEN?"en-US":function(){if(sysLocaleCache)return sysLocaleCache;if(hasIntl()){var computedSys=(new Intl.DateTimeFormat).resolvedOptions().locale;return sysLocaleCache=computedSys&&"und"!==computedSys?computedSys:"en-US"}return sysLocaleCache="en-US"}()),numberingSystem||Settings.defaultNumberingSystem,outputCalendar||Settings.defaultOutputCalendar,specifiedLocale)},Locale.resetCache=function(){sysLocaleCache=null,intlDTCache={},intlNumCache={},intlRelCache={}},Locale.fromObject=function(_temp){var _ref=void 0===_temp?{}:_temp,locale=_ref.locale,numberingSystem=_ref.numberingSystem,outputCalendar=_ref.outputCalendar;return Locale.create(locale,numberingSystem,outputCalendar)};var _proto4=Locale.prototype;return _proto4.listingMode=function(defaultOK){void 0===defaultOK&&(defaultOK=!0);var hasFTP=hasIntl()&&hasFormatToParts(),isActuallyEn=this.isEnglish(),hasNoWeirdness=!(null!==this.numberingSystem&&"latn"!==this.numberingSystem||null!==this.outputCalendar&&"gregory"!==this.outputCalendar);return hasFTP||isActuallyEn&&hasNoWeirdness||defaultOK?!hasFTP||isActuallyEn&&hasNoWeirdness?"en":"intl":"error"},_proto4.clone=function(alts){return alts&&0!==Object.getOwnPropertyNames(alts).length?Locale.create(alts.locale||this.specifiedLocale,alts.numberingSystem||this.numberingSystem,alts.outputCalendar||this.outputCalendar,alts.defaultToEN||!1):this},_proto4.redefaultToEN=function(alts){return void 0===alts&&(alts={}),this.clone(Object.assign({},alts,{defaultToEN:!0}))},_proto4.redefaultToSystem=function(alts){return void 0===alts&&(alts={}),this.clone(Object.assign({},alts,{defaultToEN:!1}))},_proto4.months=function(length,format,defaultOK){var _this=this;return void 0===format&&(format=!1),void 0===defaultOK&&(defaultOK=!0),listStuff(this,length,defaultOK,months,function(){var intl=format?{month:length,day:"numeric"}:{month:length},formatStr=format?"format":"standalone";return _this.monthsCache[formatStr][length]||(_this.monthsCache[formatStr][length]=function(f){for(var ms=[],i=1;i<=12;i++){var dt=DateTime.utc(2016,i,1);ms.push(f(dt))}return ms}(function(dt){return _this.extract(dt,intl,"month")})),_this.monthsCache[formatStr][length]})},_proto4.weekdays=function(length,format,defaultOK){var _this2=this;return void 0===format&&(format=!1),void 0===defaultOK&&(defaultOK=!0),listStuff(this,length,defaultOK,weekdays,function(){var intl=format?{weekday:length,year:"numeric",month:"long",day:"numeric"}:{weekday:length},formatStr=format?"format":"standalone";return _this2.weekdaysCache[formatStr][length]||(_this2.weekdaysCache[formatStr][length]=function(f){for(var ms=[],i=1;i<=7;i++){var dt=DateTime.utc(2016,11,13+i);ms.push(f(dt))}return ms}(function(dt){return _this2.extract(dt,intl,"weekday")})),_this2.weekdaysCache[formatStr][length]})},_proto4.meridiems=function(defaultOK){var _this3=this;return void 0===defaultOK&&(defaultOK=!0),listStuff(this,void 0,defaultOK,function(){return meridiems},function(){if(!_this3.meridiemCache){var intl={hour:"numeric",hour12:!0};_this3.meridiemCache=[DateTime.utc(2016,11,13,9),DateTime.utc(2016,11,13,19)].map(function(dt){return _this3.extract(dt,intl,"dayperiod")})}return _this3.meridiemCache})},_proto4.eras=function(length,defaultOK){var _this4=this;return void 0===defaultOK&&(defaultOK=!0),listStuff(this,length,defaultOK,eras,function(){var intl={era:length};return _this4.eraCache[length]||(_this4.eraCache[length]=[DateTime.utc(-40,1,1),DateTime.utc(2017,1,1)].map(function(dt){return _this4.extract(dt,intl,"era")})),_this4.eraCache[length]})},_proto4.extract=function(dt,intlOpts,field){var matching=this.dtFormatter(dt,intlOpts).formatToParts().find(function(m){return m.type.toLowerCase()===field});return matching?matching.value:null},_proto4.numberFormatter=function(opts){return void 0===opts&&(opts={}),new PolyNumberFormatter(this.intl,opts.forceSimple||this.fastNumbers,opts)},_proto4.dtFormatter=function(dt,intlOpts){return void 0===intlOpts&&(intlOpts={}),new PolyDateFormatter(dt,this.intl,intlOpts)},_proto4.relFormatter=function(opts){return void 0===opts&&(opts={}),new PolyRelFormatter(this.intl,this.isEnglish(),opts)},_proto4.isEnglish=function(){return"en"===this.locale||"en-us"===this.locale.toLowerCase()||hasIntl()&&new Intl.DateTimeFormat(this.intl).resolvedOptions().locale.startsWith("en-us")},_proto4.equals=function(other){return this.locale===other.locale&&this.numberingSystem===other.numberingSystem&&this.outputCalendar===other.outputCalendar},_createClass(Locale,[{key:"fastNumbers",get:function(){var loc;return null==this.fastNumbersCached&&(this.fastNumbersCached=(!(loc=this).numberingSystem||"latn"===loc.numberingSystem)&&("latn"===loc.numberingSystem||!loc.locale||loc.locale.startsWith("en")||hasIntl()&&"latn"===new Intl.DateTimeFormat(loc.intl).resolvedOptions().numberingSystem)),this.fastNumbersCached}}]),Locale}();function combineRegexes(){for(var _len=arguments.length,regexes=new Array(_len),_key=0;_key<_len;_key++)regexes[_key]=arguments[_key];var full=regexes.reduce(function(f,r){return f+r.source},"");return RegExp("^"+full+"$")}function combineExtractors(){for(var _len2=arguments.length,extractors=new Array(_len2),_key2=0;_key2<_len2;_key2++)extractors[_key2]=arguments[_key2];return function(m){return extractors.reduce(function(_ref,ex){var mergedVals=_ref[0],mergedZone=_ref[1],cursor=_ref[2],_ex=ex(m,cursor),val=_ex[0],zone=_ex[1],next=_ex[2];return[Object.assign(mergedVals,val),mergedZone||zone,next]},[{},null,1]).slice(0,2)}}function parse(s){if(null==s)return[null,null];for(var _len3=arguments.length,patterns=new Array(_len3>1?_len3-1:0),_key3=1;_key3<_len3;_key3++)patterns[_key3-1]=arguments[_key3];for(var _i=0,_patterns=patterns;_i<_patterns.length;_i++){var _patterns$_i=_patterns[_i],regex=_patterns$_i[0],extractor=_patterns$_i[1],m=regex.exec(s);if(m)return extractor(m)}return[null,null]}function simpleParse(){for(var _len4=arguments.length,keys=new Array(_len4),_key4=0;_key4<_len4;_key4++)keys[_key4]=arguments[_key4];return function(match,cursor){var i,ret={};for(i=0;i<keys.length;i++)ret[keys[i]]=parseInteger(match[cursor+i]);return[ret,null,cursor+i]}}var offsetRegex=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,isoTimeBaseRegex=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,9}))?)?)?/,isoTimeRegex=RegExp(""+isoTimeBaseRegex.source+offsetRegex.source+"?"),isoTimeExtensionRegex=RegExp("(?:T"+isoTimeRegex.source+")?"),extractISOWeekData=simpleParse("weekYear","weekNumber","weekDay"),extractISOOrdinalData=simpleParse("year","ordinal"),sqlTimeRegex=RegExp(isoTimeBaseRegex.source+" ?(?:"+offsetRegex.source+"|("+ianaRegex.source+"))?"),sqlTimeExtensionRegex=RegExp("(?: "+sqlTimeRegex.source+")?");function int(match,pos,fallback){var m=match[pos];return isUndefined(m)?fallback:parseInteger(m)}function extractISOYmd(match,cursor){return[{year:int(match,cursor),month:int(match,cursor+1,1),day:int(match,cursor+2,1)},null,cursor+3]}function extractISOTime(match,cursor){return[{hour:int(match,cursor,0),minute:int(match,cursor+1,0),second:int(match,cursor+2,0),millisecond:parseMillis(match[cursor+3])},null,cursor+4]}function extractISOOffset(match,cursor){var local=!match[cursor]&&!match[cursor+1],fullOffset=signedOffset(match[cursor+1],match[cursor+2]);return[{},local?null:FixedOffsetZone.instance(fullOffset),cursor+3]}function extractIANAZone(match,cursor){return[{},match[cursor]?IANAZone.create(match[cursor]):null,cursor+1]}var isoDuration=/^P(?:(?:(-?\d{1,9})Y)?(?:(-?\d{1,9})M)?(?:(-?\d{1,9})W)?(?:(-?\d{1,9})D)?(?:T(?:(-?\d{1,9})H)?(?:(-?\d{1,9})M)?(?:(-?\d{1,9})(?:[.,](-?\d{1,9}))?S)?)?)$/;function extractISODuration(match){var yearStr=match[1],monthStr=match[2],weekStr=match[3],dayStr=match[4],hourStr=match[5],minuteStr=match[6],secondStr=match[7],millisecondsStr=match[8];return[{years:parseInteger(yearStr),months:parseInteger(monthStr),weeks:parseInteger(weekStr),days:parseInteger(dayStr),hours:parseInteger(hourStr),minutes:parseInteger(minuteStr),seconds:parseInteger(secondStr),milliseconds:parseMillis(millisecondsStr)}]}var obsOffsets={GMT:0,EDT:-240,EST:-300,CDT:-300,CST:-360,MDT:-360,MST:-420,PDT:-420,PST:-480};function fromStrings(weekdayStr,yearStr,monthStr,dayStr,hourStr,minuteStr,secondStr){var result={year:2===yearStr.length?untruncateYear(parseInteger(yearStr)):parseInteger(yearStr),month:monthsShort.indexOf(monthStr)+1,day:parseInteger(dayStr),hour:parseInteger(hourStr),minute:parseInteger(minuteStr)};return secondStr&&(result.second=parseInteger(secondStr)),weekdayStr&&(result.weekday=weekdayStr.length>3?weekdaysLong.indexOf(weekdayStr)+1:weekdaysShort.indexOf(weekdayStr)+1),result}var rfc2822=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function extractRFC2822(match){var offset,weekdayStr=match[1],dayStr=match[2],monthStr=match[3],yearStr=match[4],hourStr=match[5],minuteStr=match[6],secondStr=match[7],obsOffset=match[8],milOffset=match[9],offHourStr=match[10],offMinuteStr=match[11],result=fromStrings(weekdayStr,yearStr,monthStr,dayStr,hourStr,minuteStr,secondStr);return offset=obsOffset?obsOffsets[obsOffset]:milOffset?0:signedOffset(offHourStr,offMinuteStr),[result,new FixedOffsetZone(offset)]}var rfc1123=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,rfc850=/^(Monday|Tuesday|Wedsday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,ascii=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function extractRFC1123Or850(match){var weekdayStr=match[1],dayStr=match[2],monthStr=match[3];return[fromStrings(weekdayStr,match[4],monthStr,dayStr,match[5],match[6],match[7]),FixedOffsetZone.utcInstance]}function extractASCII(match){var weekdayStr=match[1],monthStr=match[2],dayStr=match[3],hourStr=match[4],minuteStr=match[5],secondStr=match[6];return[fromStrings(weekdayStr,match[7],monthStr,dayStr,hourStr,minuteStr,secondStr),FixedOffsetZone.utcInstance]}var isoYmdWithTimeExtensionRegex=combineRegexes(/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,isoTimeExtensionRegex),isoWeekWithTimeExtensionRegex=combineRegexes(/(\d{4})-?W(\d\d)(?:-?(\d))?/,isoTimeExtensionRegex),isoOrdinalWithTimeExtensionRegex=combineRegexes(/(\d{4})-?(\d{3})/,isoTimeExtensionRegex),isoTimeCombinedRegex=combineRegexes(isoTimeRegex),extractISOYmdTimeAndOffset=combineExtractors(extractISOYmd,extractISOTime,extractISOOffset),extractISOWeekTimeAndOffset=combineExtractors(extractISOWeekData,extractISOTime,extractISOOffset),extractISOOrdinalDataAndTime=combineExtractors(extractISOOrdinalData,extractISOTime),extractISOTimeAndOffset=combineExtractors(extractISOTime,extractISOOffset);var sqlYmdWithTimeExtensionRegex=combineRegexes(/(\d{4})-(\d\d)-(\d\d)/,sqlTimeExtensionRegex),sqlTimeCombinedRegex=combineRegexes(sqlTimeRegex),extractISOYmdTimeOffsetAndIANAZone=combineExtractors(extractISOYmd,extractISOTime,extractISOOffset,extractIANAZone),extractISOTimeOffsetAndIANAZone=combineExtractors(extractISOTime,extractISOOffset,extractIANAZone);var lowOrderMatrix={weeks:{days:7,hours:168,minutes:10080,seconds:604800,milliseconds:6048e5},days:{hours:24,minutes:1440,seconds:86400,milliseconds:864e5},hours:{minutes:60,seconds:3600,milliseconds:36e5},minutes:{seconds:60,milliseconds:6e4},seconds:{milliseconds:1e3}},casualMatrix=Object.assign({years:{months:12,weeks:52,days:365,hours:8760,minutes:525600,seconds:31536e3,milliseconds:31536e6},quarters:{months:3,weeks:13,days:91,hours:2184,minutes:131040,milliseconds:78624e5},months:{weeks:4,days:30,hours:720,minutes:43200,seconds:2592e3,milliseconds:2592e6}},lowOrderMatrix),accurateMatrix=Object.assign({years:{months:12,weeks:52.1775,days:365.2425,hours:8765.82,minutes:525949.2,seconds:525949.2*60,milliseconds:525949.2*60*1e3},quarters:{months:3,weeks:13.044375,days:91.310625,hours:2191.455,minutes:131487.3,seconds:525949.2*60/4,milliseconds:7889237999.999999},months:{weeks:30.436875/7,days:30.436875,hours:730.485,minutes:43829.1,seconds:2629746,milliseconds:2629746e3}},lowOrderMatrix),orderedUnits=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],reverseUnits=orderedUnits.slice(0).reverse();function clone(dur,alts,clear){void 0===clear&&(clear=!1);var conf={values:clear?alts.values:Object.assign({},dur.values,alts.values||{}),loc:dur.loc.clone(alts.loc),conversionAccuracy:alts.conversionAccuracy||dur.conversionAccuracy};return new Duration(conf)}function convert(matrix,fromMap,fromUnit,toMap,toUnit){var n,conv=matrix[toUnit][fromUnit],raw=fromMap[fromUnit]/conv,added=!(Math.sign(raw)===Math.sign(toMap[toUnit]))&&0!==toMap[toUnit]&&Math.abs(raw)<=1?(n=raw)<0?Math.floor(n):Math.ceil(n):Math.trunc(raw);toMap[toUnit]+=added,fromMap[fromUnit]-=added*conv}function normalizeValues(matrix,vals){reverseUnits.reduce(function(previous,current){return isUndefined(vals[current])?previous:(previous&&convert(matrix,vals,previous,vals,current),current)},null)}var Duration=function(){function Duration(config){var accurate="longterm"===config.conversionAccuracy||!1;this.values=config.values,this.loc=config.loc||Locale.create(),this.conversionAccuracy=accurate?"longterm":"casual",this.invalid=config.invalid||null,this.matrix=accurate?accurateMatrix:casualMatrix,this.isLuxonDuration=!0}Duration.fromMillis=function(count,opts){return Duration.fromObject(Object.assign({milliseconds:count},opts))},Duration.fromObject=function(obj){if(null==obj||"object"!=typeof obj)throw new InvalidArgumentError("Duration.fromObject: argument expected to be an object, got "+(null===obj?"null":typeof obj));return new Duration({values:normalizeObject(obj,Duration.normalizeUnit,["locale","numberingSystem","conversionAccuracy","zone"]),loc:Locale.fromObject(obj),conversionAccuracy:obj.conversionAccuracy})},Duration.fromISO=function(text,opts){var parsed=parse(text,[isoDuration,extractISODuration])[0];if(parsed){var obj=Object.assign(parsed,opts);return Duration.fromObject(obj)}return Duration.invalid("unparsable",'the input "'+text+"\" can't be parsed as ISO 8601")},Duration.invalid=function(reason,explanation){if(void 0===explanation&&(explanation=null),!reason)throw new InvalidArgumentError("need to specify a reason the Duration is invalid");var invalid=reason instanceof Invalid?reason:new Invalid(reason,explanation);if(Settings.throwOnInvalid)throw new InvalidDurationError(invalid);return new Duration({invalid:invalid})},Duration.normalizeUnit=function(unit){var normalized={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[unit?unit.toLowerCase():unit];if(!normalized)throw new InvalidUnitError(unit);return normalized},Duration.isDuration=function(o){return o&&o.isLuxonDuration||!1};var _proto=Duration.prototype;return _proto.toFormat=function(fmt,opts){void 0===opts&&(opts={});var fmtOpts=Object.assign({},opts,{floor:!1!==opts.round&&!1!==opts.floor});return this.isValid?Formatter.create(this.loc,fmtOpts).formatDurationFromString(this,fmt):"Invalid Duration"},_proto.toObject=function(opts){if(void 0===opts&&(opts={}),!this.isValid)return{};var base=Object.assign({},this.values);return opts.includeConfig&&(base.conversionAccuracy=this.conversionAccuracy,base.numberingSystem=this.loc.numberingSystem,base.locale=this.loc.locale),base},_proto.toISO=function(){if(!this.isValid)return null;var s="P";return 0!==this.years&&(s+=this.years+"Y"),0===this.months&&0===this.quarters||(s+=this.months+3*this.quarters+"M"),0!==this.weeks&&(s+=this.weeks+"W"),0!==this.days&&(s+=this.days+"D"),0===this.hours&&0===this.minutes&&0===this.seconds&&0===this.milliseconds||(s+="T"),0!==this.hours&&(s+=this.hours+"H"),0!==this.minutes&&(s+=this.minutes+"M"),0===this.seconds&&0===this.milliseconds||(s+=roundTo(this.seconds+this.milliseconds/1e3,3)+"S"),"P"===s&&(s+="T0S"),s},_proto.toJSON=function(){return this.toISO()},_proto.toString=function(){return this.toISO()},_proto.valueOf=function(){return this.as("milliseconds")},_proto.plus=function(duration){if(!this.isValid)return this;for(var dur=friendlyDuration(duration),result={},_i=0,_orderedUnits=orderedUnits;_i<_orderedUnits.length;_i++){var k=_orderedUnits[_i];(hasOwnProperty(dur.values,k)||hasOwnProperty(this.values,k))&&(result[k]=dur.get(k)+this.get(k))}return clone(this,{values:result},!0)},_proto.minus=function(duration){if(!this.isValid)return this;var dur=friendlyDuration(duration);return this.plus(dur.negate())},_proto.mapUnits=function(fn){if(!this.isValid)return this;for(var result={},_i2=0,_Object$keys=Object.keys(this.values);_i2<_Object$keys.length;_i2++){var k=_Object$keys[_i2];result[k]=asNumber(fn(this.values[k],k))}return clone(this,{values:result},!0)},_proto.get=function(unit){return this[Duration.normalizeUnit(unit)]},_proto.set=function(values){return this.isValid?clone(this,{values:Object.assign(this.values,normalizeObject(values,Duration.normalizeUnit,[]))}):this},_proto.reconfigure=function(_temp){var _ref=void 0===_temp?{}:_temp,locale=_ref.locale,numberingSystem=_ref.numberingSystem,conversionAccuracy=_ref.conversionAccuracy,opts={loc:this.loc.clone({locale:locale,numberingSystem:numberingSystem})};return conversionAccuracy&&(opts.conversionAccuracy=conversionAccuracy),clone(this,opts)},_proto.as=function(unit){return this.isValid?this.shiftTo(unit).get(unit):NaN},_proto.normalize=function(){if(!this.isValid)return this;var vals=this.toObject();return normalizeValues(this.matrix,vals),clone(this,{values:vals},!0)},_proto.shiftTo=function(){for(var _len=arguments.length,units=new Array(_len),_key=0;_key<_len;_key++)units[_key]=arguments[_key];if(!this.isValid)return this;if(0===units.length)return this;units=units.map(function(u){return Duration.normalizeUnit(u)});var lastUnit,built={},accumulated={},vals=this.toObject();normalizeValues(this.matrix,vals);for(var _i3=0,_orderedUnits2=orderedUnits;_i3<_orderedUnits2.length;_i3++){var k=_orderedUnits2[_i3];if(units.indexOf(k)>=0){lastUnit=k;var own=0;for(var ak in accumulated)own+=this.matrix[ak][k]*accumulated[ak],accumulated[ak]=0;isNumber(vals[k])&&(own+=vals[k]);var i=Math.trunc(own);for(var down in built[k]=i,accumulated[k]=own-i,vals)orderedUnits.indexOf(down)>orderedUnits.indexOf(k)&&convert(this.matrix,vals,down,built,k)}else isNumber(vals[k])&&(accumulated[k]=vals[k])}for(var key in accumulated)0!==accumulated[key]&&(built[lastUnit]+=key===lastUnit?accumulated[key]:accumulated[key]/this.matrix[lastUnit][key]);return clone(this,{values:built},!0).normalize()},_proto.negate=function(){if(!this.isValid)return this;for(var negated={},_i4=0,_Object$keys2=Object.keys(this.values);_i4<_Object$keys2.length;_i4++){var k=_Object$keys2[_i4];negated[k]=-this.values[k]}return clone(this,{values:negated},!0)},_proto.equals=function(other){if(!this.isValid||!other.isValid)return!1;if(!this.loc.equals(other.loc))return!1;for(var _i5=0,_orderedUnits3=orderedUnits;_i5<_orderedUnits3.length;_i5++){var u=_orderedUnits3[_i5];if(this.values[u]!==other.values[u])return!1}return!0},_createClass(Duration,[{key:"locale",get:function(){return this.isValid?this.loc.locale:null}},{key:"numberingSystem",get:function(){return this.isValid?this.loc.numberingSystem:null}},{key:"years",get:function(){return this.isValid?this.values.years||0:NaN}},{key:"quarters",get:function(){return this.isValid?this.values.quarters||0:NaN}},{key:"months",get:function(){return this.isValid?this.values.months||0:NaN}},{key:"weeks",get:function(){return this.isValid?this.values.weeks||0:NaN}},{key:"days",get:function(){return this.isValid?this.values.days||0:NaN}},{key:"hours",get:function(){return this.isValid?this.values.hours||0:NaN}},{key:"minutes",get:function(){return this.isValid?this.values.minutes||0:NaN}},{key:"seconds",get:function(){return this.isValid?this.values.seconds||0:NaN}},{key:"milliseconds",get:function(){return this.isValid?this.values.milliseconds||0:NaN}},{key:"isValid",get:function(){return null===this.invalid}},{key:"invalidReason",get:function(){return this.invalid?this.invalid.reason:null}},{key:"invalidExplanation",get:function(){return this.invalid?this.invalid.explanation:null}}]),Duration}();function friendlyDuration(durationish){if(isNumber(durationish))return Duration.fromMillis(durationish);if(Duration.isDuration(durationish))return durationish;if("object"==typeof durationish)return Duration.fromObject(durationish);throw new InvalidArgumentError("Unknown duration argument "+durationish+" of type "+typeof durationish)}var INVALID$1="Invalid Interval";function validateStartEnd(start,end){return start&&start.isValid?end&&end.isValid?end<start?Interval.invalid("end before start","The end of an interval must be after its start, but you had start="+start.toISO()+" and end="+end.toISO()):null:Interval.invalid("missing or invalid end"):Interval.invalid("missing or invalid start")}var Interval=function(){function Interval(config){this.s=config.start,this.e=config.end,this.invalid=config.invalid||null,this.isLuxonInterval=!0}Interval.invalid=function(reason,explanation){if(void 0===explanation&&(explanation=null),!reason)throw new InvalidArgumentError("need to specify a reason the Interval is invalid");var invalid=reason instanceof Invalid?reason:new Invalid(reason,explanation);if(Settings.throwOnInvalid)throw new InvalidIntervalError(invalid);return new Interval({invalid:invalid})},Interval.fromDateTimes=function(start,end){var builtStart=friendlyDateTime(start),builtEnd=friendlyDateTime(end),validateError=validateStartEnd(builtStart,builtEnd);return null==validateError?new Interval({start:builtStart,end:builtEnd}):validateError},Interval.after=function(start,duration){var dur=friendlyDuration(duration),dt=friendlyDateTime(start);return Interval.fromDateTimes(dt,dt.plus(dur))},Interval.before=function(end,duration){var dur=friendlyDuration(duration),dt=friendlyDateTime(end);return Interval.fromDateTimes(dt.minus(dur),dt)},Interval.fromISO=function(text,opts){var _split=(text||"").split("/",2),s=_split[0],e=_split[1];if(s&&e){var start=DateTime.fromISO(s,opts),end=DateTime.fromISO(e,opts);if(start.isValid&&end.isValid)return Interval.fromDateTimes(start,end);if(start.isValid){var dur=Duration.fromISO(e,opts);if(dur.isValid)return Interval.after(start,dur)}else if(end.isValid){var _dur=Duration.fromISO(s,opts);if(_dur.isValid)return Interval.before(end,_dur)}}return Interval.invalid("unparsable",'the input "'+text+"\" can't be parsed asISO 8601")},Interval.isInterval=function(o){return o&&o.isLuxonInterval||!1};var _proto=Interval.prototype;return _proto.length=function(unit){return void 0===unit&&(unit="milliseconds"),this.isValid?this.toDuration.apply(this,[unit]).get(unit):NaN},_proto.count=function(unit){if(void 0===unit&&(unit="milliseconds"),!this.isValid)return NaN;var start=this.start.startOf(unit),end=this.end.startOf(unit);return Math.floor(end.diff(start,unit).get(unit))+1},_proto.hasSame=function(unit){return!!this.isValid&&this.e.minus(1).hasSame(this.s,unit)},_proto.isEmpty=function(){return this.s.valueOf()===this.e.valueOf()},_proto.isAfter=function(dateTime){return!!this.isValid&&this.s>dateTime},_proto.isBefore=function(dateTime){return!!this.isValid&&this.e<=dateTime},_proto.contains=function(dateTime){return!!this.isValid&&(this.s<=dateTime&&this.e>dateTime)},_proto.set=function(_temp){var _ref=void 0===_temp?{}:_temp,start=_ref.start,end=_ref.end;return this.isValid?Interval.fromDateTimes(start||this.s,end||this.e):this},_proto.splitAt=function(){var _this=this;if(!this.isValid)return[];for(var _len=arguments.length,dateTimes=new Array(_len),_key=0;_key<_len;_key++)dateTimes[_key]=arguments[_key];for(var sorted=dateTimes.map(friendlyDateTime).filter(function(d){return _this.contains(d)}).sort(),results=[],s=this.s,i=0;s<this.e;){var added=sorted[i]||this.e,next=+added>+this.e?this.e:added;results.push(Interval.fromDateTimes(s,next)),s=next,i+=1}return results},_proto.splitBy=function(duration){var dur=friendlyDuration(duration);if(!this.isValid||!dur.isValid||0===dur.as("milliseconds"))return[];for(var added,next,s=this.s,results=[];s<this.e;)next=+(added=s.plus(dur))>+this.e?this.e:added,results.push(Interval.fromDateTimes(s,next)),s=next;return results},_proto.divideEqually=function(numberOfParts){return this.isValid?this.splitBy(this.length()/numberOfParts).slice(0,numberOfParts):[]},_proto.overlaps=function(other){return this.e>other.s&&this.s<other.e},_proto.abutsStart=function(other){return!!this.isValid&&+this.e==+other.s},_proto.abutsEnd=function(other){return!!this.isValid&&+other.e==+this.s},_proto.engulfs=function(other){return!!this.isValid&&(this.s<=other.s&&this.e>=other.e)},_proto.equals=function(other){return!(!this.isValid||!other.isValid)&&(this.s.equals(other.s)&&this.e.equals(other.e))},_proto.intersection=function(other){if(!this.isValid)return this;var s=this.s>other.s?this.s:other.s,e=this.e<other.e?this.e:other.e;return s>e?null:Interval.fromDateTimes(s,e)},_proto.union=function(other){if(!this.isValid)return this;var s=this.s<other.s?this.s:other.s,e=this.e>other.e?this.e:other.e;return Interval.fromDateTimes(s,e)},Interval.merge=function(intervals){var _intervals$sort$reduc=intervals.sort(function(a,b){return a.s-b.s}).reduce(function(_ref2,item){var sofar=_ref2[0],current=_ref2[1];return current?current.overlaps(item)||current.abutsStart(item)?[sofar,current.union(item)]:[sofar.concat([current]),item]:[sofar,item]},[[],null]),found=_intervals$sort$reduc[0],final=_intervals$sort$reduc[1];return final&&found.push(final),found},Interval.xor=function(intervals){var _Array$prototype,start=null,currentCount=0,results=[],ends=intervals.map(function(i){return[{time:i.s,type:"s"},{time:i.e,type:"e"}]}),_iterator=(_Array$prototype=Array.prototype).concat.apply(_Array$prototype,ends).sort(function(a,b){return a.time-b.time}),_isArray=Array.isArray(_iterator),_i=0;for(_iterator=_isArray?_iterator:_iterator[Symbol.iterator]();;){var _ref3;if(_isArray){if(_i>=_iterator.length)break;_ref3=_iterator[_i++]}else{if((_i=_iterator.next()).done)break;_ref3=_i.value}var i=_ref3;1===(currentCount+="s"===i.type?1:-1)?start=i.time:(start&&+start!=+i.time&&results.push(Interval.fromDateTimes(start,i.time)),start=null)}return Interval.merge(results)},_proto.difference=function(){for(var _this2=this,_len2=arguments.length,intervals=new Array(_len2),_key2=0;_key2<_len2;_key2++)intervals[_key2]=arguments[_key2];return Interval.xor([this].concat(intervals)).map(function(i){return _this2.intersection(i)}).filter(function(i){return i&&!i.isEmpty()})},_proto.toString=function(){return this.isValid?"["+this.s.toISO()+" – "+this.e.toISO()+")":INVALID$1},_proto.toISO=function(opts){return this.isValid?this.s.toISO(opts)+"/"+this.e.toISO(opts):INVALID$1},_proto.toISODate=function(){return this.isValid?this.s.toISODate()+"/"+this.e.toISODate():INVALID$1},_proto.toISOTime=function(opts){return this.isValid?this.s.toISOTime(opts)+"/"+this.e.toISOTime(opts):INVALID$1},_proto.toFormat=function(dateFormat,_temp2){var _ref4$separator=(void 0===_temp2?{}:_temp2).separator,separator=void 0===_ref4$separator?" – ":_ref4$separator;return this.isValid?""+this.s.toFormat(dateFormat)+separator+this.e.toFormat(dateFormat):INVALID$1},_proto.toDuration=function(unit,opts){return this.isValid?this.e.diff(this.s,unit,opts):Duration.invalid(this.invalidReason)},_proto.mapEndpoints=function(mapFn){return Interval.fromDateTimes(mapFn(this.s),mapFn(this.e))},_createClass(Interval,[{key:"start",get:function(){return this.isValid?this.s:null}},{key:"end",get:function(){return this.isValid?this.e:null}},{key:"isValid",get:function(){return null===this.invalidReason}},{key:"invalidReason",get:function(){return this.invalid?this.invalid.reason:null}},{key:"invalidExplanation",get:function(){return this.invalid?this.invalid.explanation:null}}]),Interval}(),Info=function(){function Info(){}return Info.hasDST=function(zone){void 0===zone&&(zone=Settings.defaultZone);var proto=DateTime.local().setZone(zone).set({month:12});return!zone.universal&&proto.offset!==proto.set({month:6}).offset},Info.isValidIANAZone=function(zone){return IANAZone.isValidSpecifier(zone)&&IANAZone.isValidZone(zone)},Info.normalizeZone=function(input){return normalizeZone(input,Settings.defaultZone)},Info.months=function(length,_temp){void 0===length&&(length="long");var _ref=void 0===_temp?{}:_temp,_ref$locale=_ref.locale,locale=void 0===_ref$locale?null:_ref$locale,_ref$numberingSystem=_ref.numberingSystem,numberingSystem=void 0===_ref$numberingSystem?null:_ref$numberingSystem,_ref$outputCalendar=_ref.outputCalendar,outputCalendar=void 0===_ref$outputCalendar?"gregory":_ref$outputCalendar;return Locale.create(locale,numberingSystem,outputCalendar).months(length)},Info.monthsFormat=function(length,_temp2){void 0===length&&(length="long");var _ref2=void 0===_temp2?{}:_temp2,_ref2$locale=_ref2.locale,locale=void 0===_ref2$locale?null:_ref2$locale,_ref2$numberingSystem=_ref2.numberingSystem,numberingSystem=void 0===_ref2$numberingSystem?null:_ref2$numberingSystem,_ref2$outputCalendar=_ref2.outputCalendar,outputCalendar=void 0===_ref2$outputCalendar?"gregory":_ref2$outputCalendar;return Locale.create(locale,numberingSystem,outputCalendar).months(length,!0)},Info.weekdays=function(length,_temp3){void 0===length&&(length="long");var _ref3=void 0===_temp3?{}:_temp3,_ref3$locale=_ref3.locale,locale=void 0===_ref3$locale?null:_ref3$locale,_ref3$numberingSystem=_ref3.numberingSystem,numberingSystem=void 0===_ref3$numberingSystem?null:_ref3$numberingSystem;return Locale.create(locale,numberingSystem,null).weekdays(length)},Info.weekdaysFormat=function(length,_temp4){void 0===length&&(length="long");var _ref4=void 0===_temp4?{}:_temp4,_ref4$locale=_ref4.locale,locale=void 0===_ref4$locale?null:_ref4$locale,_ref4$numberingSystem=_ref4.numberingSystem,numberingSystem=void 0===_ref4$numberingSystem?null:_ref4$numberingSystem;return Locale.create(locale,numberingSystem,null).weekdays(length,!0)},Info.meridiems=function(_temp5){var _ref5$locale=(void 0===_temp5?{}:_temp5).locale,locale=void 0===_ref5$locale?null:_ref5$locale;return Locale.create(locale).meridiems()},Info.eras=function(length,_temp6){void 0===length&&(length="short");var _ref6$locale=(void 0===_temp6?{}:_temp6).locale,locale=void 0===_ref6$locale?null:_ref6$locale;return Locale.create(locale,null,"gregory").eras(length)},Info.features=function(){var intl=!1,intlTokens=!1,zones=!1,relative=!1;if(hasIntl()){intl=!0,intlTokens=hasFormatToParts(),relative=hasRelative();try{zones="America/New_York"===new Intl.DateTimeFormat("en",{timeZone:"America/New_York"}).resolvedOptions().timeZone}catch(e){zones=!1}}return{intl:intl,intlTokens:intlTokens,zones:zones,relative:relative}},Info}();function dayDiff(earlier,later){var utcDayStart=function(dt){return dt.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf()},ms=utcDayStart(later)-utcDayStart(earlier);return Math.floor(Duration.fromMillis(ms).as("days"))}function _diff(earlier,later,units,opts){var _highOrderDiffs=function(cursor,later,units){for(var lowestOrder,highWater,results={},_i=0,_differs=[["years",function(a,b){return b.year-a.year}],["months",function(a,b){return b.month-a.month+12*(b.year-a.year)}],["weeks",function(a,b){var days=dayDiff(a,b);return(days-days%7)/7}],["days",dayDiff]];_i<_differs.length;_i++){var _differs$_i=_differs[_i],unit=_differs$_i[0],differ=_differs$_i[1];if(units.indexOf(unit)>=0){var _cursor$plus;lowestOrder=unit;var _cursor$plus2,delta=differ(cursor,later);(highWater=cursor.plus(((_cursor$plus={})[unit]=delta,_cursor$plus)))>later?(cursor=cursor.plus(((_cursor$plus2={})[unit]=delta-1,_cursor$plus2)),delta-=1):cursor=highWater,results[unit]=delta}}return[cursor,results,highWater,lowestOrder]}(earlier,later,units),cursor=_highOrderDiffs[0],results=_highOrderDiffs[1],highWater=_highOrderDiffs[2],lowestOrder=_highOrderDiffs[3],remainingMillis=later-cursor,lowerOrderUnits=units.filter(function(u){return["hours","minutes","seconds","milliseconds"].indexOf(u)>=0});if(0===lowerOrderUnits.length){var _cursor$plus3;if(highWater<later)highWater=cursor.plus(((_cursor$plus3={})[lowestOrder]=1,_cursor$plus3));highWater!==cursor&&(results[lowestOrder]=(results[lowestOrder]||0)+remainingMillis/(highWater-cursor))}var _Duration$fromMillis,duration=Duration.fromObject(Object.assign(results,opts));return lowerOrderUnits.length>0?(_Duration$fromMillis=Duration.fromMillis(remainingMillis,opts)).shiftTo.apply(_Duration$fromMillis,lowerOrderUnits).plus(duration):duration}var numberingSystems={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},numberingSystemsUTF16={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},hanidecChars=numberingSystems.hanidec.replace(/[\[|\]]/g,"").split("");function digitRegex(_ref,append){var numberingSystem=_ref.numberingSystem;return void 0===append&&(append=""),new RegExp(""+numberingSystems[numberingSystem||"latn"]+append)}var MISSING_FTP="missing Intl.DateTimeFormat.formatToParts support";function intUnit(regex,post){return void 0===post&&(post=function(i){return i}),{regex:regex,deser:function(_ref){var s=_ref[0];return post(function(str){var value=parseInt(str,10);if(isNaN(value)){value="";for(var i=0;i<str.length;i++){var code=str.charCodeAt(i);if(-1!==str[i].search(numberingSystems.hanidec))value+=hanidecChars.indexOf(str[i]);else for(var key in numberingSystemsUTF16){var _numberingSystemsUTF=numberingSystemsUTF16[key],min=_numberingSystemsUTF[0],max=_numberingSystemsUTF[1];code>=min&&code<=max&&(value+=code-min)}}return parseInt(value,10)}return value}(s))}}}function fixListRegex(s){return s.replace(/\./,"\\.?")}function stripInsensitivities(s){return s.replace(/\./,"").toLowerCase()}function oneOf(strings,startIndex){return null===strings?null:{regex:RegExp(strings.map(fixListRegex).join("|")),deser:function(_ref2){var s=_ref2[0];return strings.findIndex(function(i){return stripInsensitivities(s)===stripInsensitivities(i)})+startIndex}}}function offset(regex,groups){return{regex:regex,deser:function(_ref3){return signedOffset(_ref3[1],_ref3[2])},groups:groups}}function simple(regex){return{regex:regex,deser:function(_ref4){return _ref4[0]}}}var partTypeStyleToTokenVal={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour:{numeric:"h","2-digit":"hh"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"}};var dummyDateTimeCache=null;function maybeExpandMacroToken(token,locale){if(token.literal)return token;var formatOpts=Formatter.macroTokenToFormatOpts(token.val);if(!formatOpts)return token;var tokens=Formatter.create(locale,formatOpts).formatDateTimeParts((dummyDateTimeCache||(dummyDateTimeCache=DateTime.fromMillis(1555555555555)),dummyDateTimeCache)).map(function(p){return function(part,locale,formatOpts){var type=part.type,value=part.value;if("literal"===type)return{literal:!0,val:value};var style=formatOpts[type],val=partTypeStyleToTokenVal[type];return"object"==typeof val&&(val=val[style]),val?{literal:!1,val:val}:void 0}(p,0,formatOpts)});return tokens.includes(void 0)?token:tokens}function explainFromTokens(locale,input,format){var tokens=function(tokens,locale){var _Array$prototype;return(_Array$prototype=Array.prototype).concat.apply(_Array$prototype,tokens.map(function(t){return maybeExpandMacroToken(t,locale)}))}(Formatter.parseFormat(format),locale),units=tokens.map(function(t){return token=t,one=digitRegex(loc=locale),two=digitRegex(loc,"{2}"),three=digitRegex(loc,"{3}"),four=digitRegex(loc,"{4}"),six=digitRegex(loc,"{6}"),oneOrTwo=digitRegex(loc,"{1,2}"),oneToThree=digitRegex(loc,"{1,3}"),oneToSix=digitRegex(loc,"{1,6}"),oneToNine=digitRegex(loc,"{1,9}"),twoToFour=digitRegex(loc,"{2,4}"),fourToSix=digitRegex(loc,"{4,6}"),literal=function(t){return{regex:RegExp((value=t.val,value.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"))),deser:function(_ref5){return _ref5[0]},literal:!0};var value},(unit=function(t){if(token.literal)return literal(t);switch(t.val){case"G":return oneOf(loc.eras("short",!1),0);case"GG":return oneOf(loc.eras("long",!1),0);case"y":return intUnit(oneToSix);case"yy":return intUnit(twoToFour,untruncateYear);case"yyyy":return intUnit(four);case"yyyyy":return intUnit(fourToSix);case"yyyyyy":return intUnit(six);case"M":return intUnit(oneOrTwo);case"MM":return intUnit(two);case"MMM":return oneOf(loc.months("short",!0,!1),1);case"MMMM":return oneOf(loc.months("long",!0,!1),1);case"L":return intUnit(oneOrTwo);case"LL":return intUnit(two);case"LLL":return oneOf(loc.months("short",!1,!1),1);case"LLLL":return oneOf(loc.months("long",!1,!1),1);case"d":return intUnit(oneOrTwo);case"dd":return intUnit(two);case"o":return intUnit(oneToThree);case"ooo":return intUnit(three);case"HH":return intUnit(two);case"H":return intUnit(oneOrTwo);case"hh":return intUnit(two);case"h":return intUnit(oneOrTwo);case"mm":return intUnit(two);case"m":case"q":return intUnit(oneOrTwo);case"qq":return intUnit(two);case"s":return intUnit(oneOrTwo);case"ss":return intUnit(two);case"S":return intUnit(oneToThree);case"SSS":return intUnit(three);case"u":return simple(oneToNine);case"a":return oneOf(loc.meridiems(),0);case"kkkk":return intUnit(four);case"kk":return intUnit(twoToFour,untruncateYear);case"W":return intUnit(oneOrTwo);case"WW":return intUnit(two);case"E":case"c":return intUnit(one);case"EEE":return oneOf(loc.weekdays("short",!1,!1),1);case"EEEE":return oneOf(loc.weekdays("long",!1,!1),1);case"ccc":return oneOf(loc.weekdays("short",!0,!1),1);case"cccc":return oneOf(loc.weekdays("long",!0,!1),1);case"Z":case"ZZ":return offset(new RegExp("([+-]"+oneOrTwo.source+")(?::("+two.source+"))?"),2);case"ZZZ":return offset(new RegExp("([+-]"+oneOrTwo.source+")("+two.source+")?"),2);case"z":return simple(/[a-z_+-\/]{1,256}?/i);default:return literal(t)}}(token)||{invalidReason:MISSING_FTP}).token=token,unit;var token,loc,one,two,three,four,six,oneOrTwo,oneToThree,oneToSix,oneToNine,twoToFour,fourToSix,literal,unit}),disqualifyingUnit=units.find(function(t){return t.invalidReason});if(disqualifyingUnit)return{input:input,tokens:tokens,invalidReason:disqualifyingUnit.invalidReason};var _buildRegex=function(units){return["^"+units.map(function(u){return u.regex}).reduce(function(f,r){return f+"("+r.source+")"},"")+"$",units]}(units),regexString=_buildRegex[0],handlers=_buildRegex[1],regex=RegExp(regexString,"i"),_match=function(input,regex,handlers){var matches=input.match(regex);if(matches){var all={},matchIndex=1;for(var i in handlers)if(hasOwnProperty(handlers,i)){var h=handlers[i],groups=h.groups?h.groups+1:1;!h.literal&&h.token&&(all[h.token.val[0]]=h.deser(matches.slice(matchIndex,matchIndex+groups))),matchIndex+=groups}return[matches,all]}return[matches,{}]}(input,regex,handlers),rawMatches=_match[0],matches=_match[1],_ref6=matches?function(matches){var zone;return zone=isUndefined(matches.Z)?isUndefined(matches.z)?null:IANAZone.create(matches.z):new FixedOffsetZone(matches.Z),isUndefined(matches.q)||(matches.M=3*(matches.q-1)+1),isUndefined(matches.h)||(matches.h<12&&1===matches.a?matches.h+=12:12===matches.h&&0===matches.a&&(matches.h=0)),0===matches.G&&matches.y&&(matches.y=-matches.y),isUndefined(matches.u)||(matches.S=parseMillis(matches.u)),[Object.keys(matches).reduce(function(r,k){var f=function(token){switch(token){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}}(k);return f&&(r[f]=matches[k]),r},{}),zone]}(matches):[null,null],result=_ref6[0],zone=_ref6[1];if(hasOwnProperty(matches,"a")&&hasOwnProperty(matches,"H"))throw new ConflictingSpecificationError("Can't include meridiem when specifying 24-hour format");return{input:input,tokens:tokens,regex:regex,rawMatches:rawMatches,matches:matches,result:result,zone:zone}}var nonLeapLadder=[0,31,59,90,120,151,181,212,243,273,304,334],leapLadder=[0,31,60,91,121,152,182,213,244,274,305,335];function unitOutOfRange(unit,value){return new Invalid("unit out of range","you specified "+value+" (of type "+typeof value+") as a "+unit+", which is invalid")}function dayOfWeek(year,month,day){var js=new Date(Date.UTC(year,month-1,day)).getUTCDay();return 0===js?7:js}function computeOrdinal(year,month,day){return day+(isLeapYear(year)?leapLadder:nonLeapLadder)[month-1]}function uncomputeOrdinal(year,ordinal){var table=isLeapYear(year)?leapLadder:nonLeapLadder,month0=table.findIndex(function(i){return i<ordinal});return{month:month0+1,day:ordinal-table[month0]}}function gregorianToWeek(gregObj){var weekYear,year=gregObj.year,month=gregObj.month,day=gregObj.day,ordinal=computeOrdinal(year,month,day),weekday=dayOfWeek(year,month,day),weekNumber=Math.floor((ordinal-weekday+10)/7);return weekNumber<1?weekNumber=weeksInWeekYear(weekYear=year-1):weekNumber>weeksInWeekYear(year)?(weekYear=year+1,weekNumber=1):weekYear=year,Object.assign({weekYear:weekYear,weekNumber:weekNumber,weekday:weekday},timeObject(gregObj))}function weekToGregorian(weekData){var year,weekYear=weekData.weekYear,weekNumber=weekData.weekNumber,weekday=weekData.weekday,weekdayOfJan4=dayOfWeek(weekYear,1,4),yearInDays=daysInYear(weekYear),ordinal=7*weekNumber+weekday-weekdayOfJan4-3;ordinal<1?ordinal+=daysInYear(year=weekYear-1):ordinal>yearInDays?(year=weekYear+1,ordinal-=daysInYear(weekYear)):year=weekYear;var _uncomputeOrdinal=uncomputeOrdinal(year,ordinal),month=_uncomputeOrdinal.month,day=_uncomputeOrdinal.day;return Object.assign({year:year,month:month,day:day},timeObject(weekData))}function gregorianToOrdinal(gregData){var year=gregData.year,ordinal=computeOrdinal(year,gregData.month,gregData.day);return Object.assign({year:year,ordinal:ordinal},timeObject(gregData))}function ordinalToGregorian(ordinalData){var year=ordinalData.year,_uncomputeOrdinal2=uncomputeOrdinal(year,ordinalData.ordinal),month=_uncomputeOrdinal2.month,day=_uncomputeOrdinal2.day;return Object.assign({year:year,month:month,day:day},timeObject(ordinalData))}function hasInvalidGregorianData(obj){var validYear=isInteger(obj.year),validMonth=integerBetween(obj.month,1,12),validDay=integerBetween(obj.day,1,daysInMonth(obj.year,obj.month));return validYear?validMonth?!validDay&&unitOutOfRange("day",obj.day):unitOutOfRange("month",obj.month):unitOutOfRange("year",obj.year)}function hasInvalidTimeData(obj){var hour=obj.hour,minute=obj.minute,second=obj.second,millisecond=obj.millisecond,validHour=integerBetween(hour,0,23)||24===hour&&0===minute&&0===second&&0===millisecond,validMinute=integerBetween(minute,0,59),validSecond=integerBetween(second,0,59),validMillisecond=integerBetween(millisecond,0,999);return validHour?validMinute?validSecond?!validMillisecond&&unitOutOfRange("millisecond",millisecond):unitOutOfRange("second",second):unitOutOfRange("minute",minute):unitOutOfRange("hour",hour)}function unsupportedZone(zone){return new Invalid("unsupported zone",'the zone "'+zone.name+'" is not supported')}function possiblyCachedWeekData(dt){return null===dt.weekData&&(dt.weekData=gregorianToWeek(dt.c)),dt.weekData}function clone$1(inst,alts){var current={ts:inst.ts,zone:inst.zone,c:inst.c,o:inst.o,loc:inst.loc,invalid:inst.invalid};return new DateTime(Object.assign({},current,alts,{old:current}))}function fixOffset(localTS,o,tz){var utcGuess=localTS-60*o*1e3,o2=tz.offset(utcGuess);if(o===o2)return[utcGuess,o];utcGuess-=60*(o2-o)*1e3;var o3=tz.offset(utcGuess);return o2===o3?[utcGuess,o2]:[localTS-60*Math.min(o2,o3)*1e3,Math.max(o2,o3)]}function tsToObj(ts,offset){var d=new Date(ts+=60*offset*1e3);return{year:d.getUTCFullYear(),month:d.getUTCMonth()+1,day:d.getUTCDate(),hour:d.getUTCHours(),minute:d.getUTCMinutes(),second:d.getUTCSeconds(),millisecond:d.getUTCMilliseconds()}}function objToTS(obj,offset,zone){return fixOffset(objToLocalTS(obj),offset,zone)}function adjustTime(inst,dur){var _dur,keys=Object.keys(dur.values);-1===keys.indexOf("milliseconds")&&keys.push("milliseconds"),dur=(_dur=dur).shiftTo.apply(_dur,keys);var oPre=inst.o,year=inst.c.year+dur.years,month=inst.c.month+dur.months+3*dur.quarters,c=Object.assign({},inst.c,{year:year,month:month,day:Math.min(inst.c.day,daysInMonth(year,month))+dur.days+7*dur.weeks}),millisToAdd=Duration.fromObject({hours:dur.hours,minutes:dur.minutes,seconds:dur.seconds,milliseconds:dur.milliseconds}).as("milliseconds"),_fixOffset=fixOffset(objToLocalTS(c),oPre,inst.zone),ts=_fixOffset[0],o=_fixOffset[1];return 0!==millisToAdd&&(ts+=millisToAdd,o=inst.zone.offset(ts)),{ts:ts,o:o}}function parseDataToDateTime(parsed,parsedZone,opts,format,text){var setZone=opts.setZone,zone=opts.zone;if(parsed&&0!==Object.keys(parsed).length){var interpretationZone=parsedZone||zone,inst=DateTime.fromObject(Object.assign(parsed,opts,{zone:interpretationZone,setZone:void 0}));return setZone?inst:inst.setZone(zone)}return DateTime.invalid(new Invalid("unparsable",'the input "'+text+"\" can't be parsed as "+format))}function toTechFormat(dt,format){return dt.isValid?Formatter.create(Locale.create("en-US"),{allowZ:!0,forceSimple:!0}).formatDateTimeFromString(dt,format):null}function toTechTimeFormat(dt,_ref){var _ref$suppressSeconds=_ref.suppressSeconds,suppressSeconds=void 0!==_ref$suppressSeconds&&_ref$suppressSeconds,_ref$suppressMillisec=_ref.suppressMilliseconds,suppressMilliseconds=void 0!==_ref$suppressMillisec&&_ref$suppressMillisec,includeOffset=_ref.includeOffset,_ref$includeZone=_ref.includeZone,includeZone=void 0!==_ref$includeZone&&_ref$includeZone,_ref$spaceZone=_ref.spaceZone,spaceZone=void 0!==_ref$spaceZone&&_ref$spaceZone,fmt="HH:mm";return suppressSeconds&&0===dt.second&&0===dt.millisecond||(fmt+=":ss",suppressMilliseconds&&0===dt.millisecond||(fmt+=".SSS")),(includeZone||includeOffset)&&spaceZone&&(fmt+=" "),includeZone?fmt+="z":includeOffset&&(fmt+="ZZ"),toTechFormat(dt,fmt)}var defaultUnitValues={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},defaultWeekUnitValues={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},defaultOrdinalUnitValues={ordinal:1,hour:0,minute:0,second:0,millisecond:0},orderedUnits$1=["year","month","day","hour","minute","second","millisecond"],orderedWeekUnits=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],orderedOrdinalUnits=["year","ordinal","hour","minute","second","millisecond"];function normalizeUnit(unit){var normalized={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[unit.toLowerCase()];if(!normalized)throw new InvalidUnitError(unit);return normalized}function quickDT(obj,zone){for(var _i=0,_orderedUnits=orderedUnits$1;_i<_orderedUnits.length;_i++){var u=_orderedUnits[_i];isUndefined(obj[u])&&(obj[u]=defaultUnitValues[u])}var invalid=hasInvalidGregorianData(obj)||hasInvalidTimeData(obj);if(invalid)return DateTime.invalid(invalid);var tsNow=Settings.now(),_objToTS=objToTS(obj,zone.offset(tsNow),zone),ts=_objToTS[0],o=_objToTS[1];return new DateTime({ts:ts,zone:zone,o:o})}function diffRelative(start,end,opts){var round=!!isUndefined(opts.round)||opts.round,format=function(c,unit){return c=roundTo(c,round||opts.calendary?0:2,!0),end.loc.clone(opts).relFormatter(opts).format(c,unit)},differ=function(unit){return opts.calendary?end.hasSame(start,unit)?0:end.startOf(unit).diff(start.startOf(unit),unit).get(unit):end.diff(start,unit).get(unit)};if(opts.unit)return format(differ(opts.unit),opts.unit);var _iterator=opts.units,_isArray=Array.isArray(_iterator),_i2=0;for(_iterator=_isArray?_iterator:_iterator[Symbol.iterator]();;){var _ref2;if(_isArray){if(_i2>=_iterator.length)break;_ref2=_iterator[_i2++]}else{if((_i2=_iterator.next()).done)break;_ref2=_i2.value}var unit=_ref2,count=differ(unit);if(Math.abs(count)>=1)return format(count,unit)}return format(0,opts.units[opts.units.length-1])}var DateTime=function(){function DateTime(config){var zone=config.zone||Settings.defaultZone,invalid=config.invalid||(Number.isNaN(config.ts)?new Invalid("invalid input"):null)||(zone.isValid?null:unsupportedZone(zone));this.ts=isUndefined(config.ts)?Settings.now():config.ts;var c=null,o=null;if(!invalid)if(config.old&&config.old.ts===this.ts&&config.old.zone.equals(zone)){var _ref3=[config.old.c,config.old.o];c=_ref3[0],o=_ref3[1]}else{var ot=zone.offset(this.ts);c=tsToObj(this.ts,ot),c=(invalid=Number.isNaN(c.year)?new Invalid("invalid input"):null)?null:c,o=invalid?null:ot}this._zone=zone,this.loc=config.loc||Locale.create(),this.invalid=invalid,this.weekData=null,this.c=c,this.o=o,this.isLuxonDateTime=!0}DateTime.local=function(year,month,day,hour,minute,second,millisecond){return isUndefined(year)?new DateTime({ts:Settings.now()}):quickDT({year:year,month:month,day:day,hour:hour,minute:minute,second:second,millisecond:millisecond},Settings.defaultZone)},DateTime.utc=function(year,month,day,hour,minute,second,millisecond){return isUndefined(year)?new DateTime({ts:Settings.now(),zone:FixedOffsetZone.utcInstance}):quickDT({year:year,month:month,day:day,hour:hour,minute:minute,second:second,millisecond:millisecond},FixedOffsetZone.utcInstance)},DateTime.fromJSDate=function(date,options){void 0===options&&(options={});var o,ts=(o=date,"[object Date]"===Object.prototype.toString.call(o)?date.valueOf():NaN);if(Number.isNaN(ts))return DateTime.invalid("invalid input");var zoneToUse=normalizeZone(options.zone,Settings.defaultZone);return zoneToUse.isValid?new DateTime({ts:ts,zone:zoneToUse,loc:Locale.fromObject(options)}):DateTime.invalid(unsupportedZone(zoneToUse))},DateTime.fromMillis=function(milliseconds,options){if(void 0===options&&(options={}),isNumber(milliseconds))return milliseconds<-864e13||milliseconds>864e13?DateTime.invalid("Timestamp out of range"):new DateTime({ts:milliseconds,zone:normalizeZone(options.zone,Settings.defaultZone),loc:Locale.fromObject(options)});throw new InvalidArgumentError("fromMillis requires a numerical input")},DateTime.fromSeconds=function(seconds,options){if(void 0===options&&(options={}),isNumber(seconds))return new DateTime({ts:1e3*seconds,zone:normalizeZone(options.zone,Settings.defaultZone),loc:Locale.fromObject(options)});throw new InvalidArgumentError("fromSeconds requires a numerical input")},DateTime.fromObject=function(obj){var zoneToUse=normalizeZone(obj.zone,Settings.defaultZone);if(!zoneToUse.isValid)return DateTime.invalid(unsupportedZone(zoneToUse));var tsNow=Settings.now(),offsetProvis=zoneToUse.offset(tsNow),normalized=normalizeObject(obj,normalizeUnit,["zone","locale","outputCalendar","numberingSystem"]),containsOrdinal=!isUndefined(normalized.ordinal),containsGregorYear=!isUndefined(normalized.year),containsGregorMD=!isUndefined(normalized.month)||!isUndefined(normalized.day),containsGregor=containsGregorYear||containsGregorMD,definiteWeekDef=normalized.weekYear||normalized.weekNumber,loc=Locale.fromObject(obj);if((containsGregor||containsOrdinal)&&definiteWeekDef)throw new ConflictingSpecificationError("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(containsGregorMD&&containsOrdinal)throw new ConflictingSpecificationError("Can't mix ordinal dates with month/day");var units,defaultValues,useWeekData=definiteWeekDef||normalized.weekday&&!containsGregor,objNow=tsToObj(tsNow,offsetProvis);useWeekData?(units=orderedWeekUnits,defaultValues=defaultWeekUnitValues,objNow=gregorianToWeek(objNow)):containsOrdinal?(units=orderedOrdinalUnits,defaultValues=defaultOrdinalUnitValues,objNow=gregorianToOrdinal(objNow)):(units=orderedUnits$1,defaultValues=defaultUnitValues);var foundFirst=!1,_iterator2=units,_isArray2=Array.isArray(_iterator2),_i3=0;for(_iterator2=_isArray2?_iterator2:_iterator2[Symbol.iterator]();;){var _ref4;if(_isArray2){if(_i3>=_iterator2.length)break;_ref4=_iterator2[_i3++]}else{if((_i3=_iterator2.next()).done)break;_ref4=_i3.value}var u=_ref4;isUndefined(normalized[u])?normalized[u]=foundFirst?defaultValues[u]:objNow[u]:foundFirst=!0}var invalid=(useWeekData?function(obj){var validYear=isInteger(obj.weekYear),validWeek=integerBetween(obj.weekNumber,1,weeksInWeekYear(obj.weekYear)),validWeekday=integerBetween(obj.weekday,1,7);return validYear?validWeek?!validWeekday&&unitOutOfRange("weekday",obj.weekday):unitOutOfRange("week",obj.week):unitOutOfRange("weekYear",obj.weekYear)}(normalized):containsOrdinal?function(obj){var validYear=isInteger(obj.year),validOrdinal=integerBetween(obj.ordinal,1,daysInYear(obj.year));return validYear?!validOrdinal&&unitOutOfRange("ordinal",obj.ordinal):unitOutOfRange("year",obj.year)}(normalized):hasInvalidGregorianData(normalized))||hasInvalidTimeData(normalized);if(invalid)return DateTime.invalid(invalid);var _objToTS2=objToTS(useWeekData?weekToGregorian(normalized):containsOrdinal?ordinalToGregorian(normalized):normalized,offsetProvis,zoneToUse),inst=new DateTime({ts:_objToTS2[0],zone:zoneToUse,o:_objToTS2[1],loc:loc});return normalized.weekday&&containsGregor&&obj.weekday!==inst.weekday?DateTime.invalid("mismatched weekday","you can't specify both a weekday of "+normalized.weekday+" and a date of "+inst.toISO()):inst},DateTime.fromISO=function(text,opts){void 0===opts&&(opts={});var _parseISODate=parse(text,[isoYmdWithTimeExtensionRegex,extractISOYmdTimeAndOffset],[isoWeekWithTimeExtensionRegex,extractISOWeekTimeAndOffset],[isoOrdinalWithTimeExtensionRegex,extractISOOrdinalDataAndTime],[isoTimeCombinedRegex,extractISOTimeAndOffset]);return parseDataToDateTime(_parseISODate[0],_parseISODate[1],opts,"ISO 8601",text)},DateTime.fromRFC2822=function(text,opts){void 0===opts&&(opts={});var _parseRFC2822Date=parse(function(s){return s.replace(/\([^)]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}(text),[rfc2822,extractRFC2822]);return parseDataToDateTime(_parseRFC2822Date[0],_parseRFC2822Date[1],opts,"RFC 2822",text)},DateTime.fromHTTP=function(text,opts){void 0===opts&&(opts={});var _parseHTTPDate=parse(text,[rfc1123,extractRFC1123Or850],[rfc850,extractRFC1123Or850],[ascii,extractASCII]);return parseDataToDateTime(_parseHTTPDate[0],_parseHTTPDate[1],opts,"HTTP",opts)},DateTime.fromFormat=function(text,fmt,opts){if(void 0===opts&&(opts={}),isUndefined(text)||isUndefined(fmt))throw new InvalidArgumentError("fromFormat requires an input string and a format");var _opts=opts,_opts$locale=_opts.locale,locale=void 0===_opts$locale?null:_opts$locale,_opts$numberingSystem=_opts.numberingSystem,numberingSystem=void 0===_opts$numberingSystem?null:_opts$numberingSystem,_parseFromTokens=function(locale,input,format){var _explainFromTokens=explainFromTokens(locale,input,format);return[_explainFromTokens.result,_explainFromTokens.zone,_explainFromTokens.invalidReason]}(Locale.fromOpts({locale:locale,numberingSystem:numberingSystem,defaultToEN:!0}),text,fmt),vals=_parseFromTokens[0],parsedZone=_parseFromTokens[1],invalid=_parseFromTokens[2];return invalid?DateTime.invalid(invalid):parseDataToDateTime(vals,parsedZone,opts,"format "+fmt,text)},DateTime.fromString=function(text,fmt,opts){return void 0===opts&&(opts={}),DateTime.fromFormat(text,fmt,opts)},DateTime.fromSQL=function(text,opts){void 0===opts&&(opts={});var _parseSQL=parse(text,[sqlYmdWithTimeExtensionRegex,extractISOYmdTimeOffsetAndIANAZone],[sqlTimeCombinedRegex,extractISOTimeOffsetAndIANAZone]);return parseDataToDateTime(_parseSQL[0],_parseSQL[1],opts,"SQL",text)},DateTime.invalid=function(reason,explanation){if(void 0===explanation&&(explanation=null),!reason)throw new InvalidArgumentError("need to specify a reason the DateTime is invalid");var invalid=reason instanceof Invalid?reason:new Invalid(reason,explanation);if(Settings.throwOnInvalid)throw new InvalidDateTimeError(invalid);return new DateTime({invalid:invalid})},DateTime.isDateTime=function(o){return o&&o.isLuxonDateTime||!1};var _proto=DateTime.prototype;return _proto.get=function(unit){return this[unit]},_proto.resolvedLocaleOpts=function(opts){void 0===opts&&(opts={});var _Formatter$create$res=Formatter.create(this.loc.clone(opts),opts).resolvedOptions(this);return{locale:_Formatter$create$res.locale,numberingSystem:_Formatter$create$res.numberingSystem,outputCalendar:_Formatter$create$res.calendar}},_proto.toUTC=function(offset,opts){return void 0===offset&&(offset=0),void 0===opts&&(opts={}),this.setZone(FixedOffsetZone.instance(offset),opts)},_proto.toLocal=function(){return this.setZone(Settings.defaultZone)},_proto.setZone=function(zone,_temp){var _ref5=void 0===_temp?{}:_temp,_ref5$keepLocalTime=_ref5.keepLocalTime,keepLocalTime=void 0!==_ref5$keepLocalTime&&_ref5$keepLocalTime,_ref5$keepCalendarTim=_ref5.keepCalendarTime,keepCalendarTime=void 0!==_ref5$keepCalendarTim&&_ref5$keepCalendarTim;if((zone=normalizeZone(zone,Settings.defaultZone)).equals(this.zone))return this;if(zone.isValid){var newTS=this.ts;if(keepLocalTime||keepCalendarTime){var offsetGuess=zone.offset(this.ts);newTS=objToTS(this.toObject(),offsetGuess,zone)[0]}return clone$1(this,{ts:newTS,zone:zone})}return DateTime.invalid(unsupportedZone(zone))},_proto.reconfigure=function(_temp2){var _ref6=void 0===_temp2?{}:_temp2,locale=_ref6.locale,numberingSystem=_ref6.numberingSystem,outputCalendar=_ref6.outputCalendar;return clone$1(this,{loc:this.loc.clone({locale:locale,numberingSystem:numberingSystem,outputCalendar:outputCalendar})})},_proto.setLocale=function(locale){return this.reconfigure({locale:locale})},_proto.set=function(values){if(!this.isValid)return this;var mixed,normalized=normalizeObject(values,normalizeUnit,[]);!isUndefined(normalized.weekYear)||!isUndefined(normalized.weekNumber)||!isUndefined(normalized.weekday)?mixed=weekToGregorian(Object.assign(gregorianToWeek(this.c),normalized)):isUndefined(normalized.ordinal)?(mixed=Object.assign(this.toObject(),normalized),isUndefined(normalized.day)&&(mixed.day=Math.min(daysInMonth(mixed.year,mixed.month),mixed.day))):mixed=ordinalToGregorian(Object.assign(gregorianToOrdinal(this.c),normalized));var _objToTS4=objToTS(mixed,this.o,this.zone);return clone$1(this,{ts:_objToTS4[0],o:_objToTS4[1]})},_proto.plus=function(duration){return this.isValid?clone$1(this,adjustTime(this,friendlyDuration(duration))):this},_proto.minus=function(duration){return this.isValid?clone$1(this,adjustTime(this,friendlyDuration(duration).negate())):this},_proto.startOf=function(unit){if(!this.isValid)return this;var o={},normalizedUnit=Duration.normalizeUnit(unit);switch(normalizedUnit){case"years":o.month=1;case"quarters":case"months":o.day=1;case"weeks":case"days":o.hour=0;case"hours":o.minute=0;case"minutes":o.second=0;case"seconds":o.millisecond=0}if("weeks"===normalizedUnit&&(o.weekday=1),"quarters"===normalizedUnit){var q=Math.ceil(this.month/3);o.month=3*(q-1)+1}return this.set(o)},_proto.endOf=function(unit){var _this$plus;return this.isValid?this.plus((_this$plus={},_this$plus[unit]=1,_this$plus)).startOf(unit).minus(1):this},_proto.toFormat=function(fmt,opts){return void 0===opts&&(opts={}),this.isValid?Formatter.create(this.loc.redefaultToEN(opts)).formatDateTimeFromString(this,fmt):"Invalid DateTime"},_proto.toLocaleString=function(opts){return void 0===opts&&(opts=DATE_SHORT),this.isValid?Formatter.create(this.loc.clone(opts),opts).formatDateTime(this):"Invalid DateTime"},_proto.toLocaleParts=function(opts){return void 0===opts&&(opts={}),this.isValid?Formatter.create(this.loc.clone(opts),opts).formatDateTimeParts(this):[]},_proto.toISO=function(opts){return void 0===opts&&(opts={}),this.isValid?this.toISODate()+"T"+this.toISOTime(opts):null},_proto.toISODate=function(){var format="yyyy-MM-dd";return this.year>9999&&(format="+"+format),toTechFormat(this,format)},_proto.toISOWeekDate=function(){return toTechFormat(this,"kkkk-'W'WW-c")},_proto.toISOTime=function(_temp3){var _ref7=void 0===_temp3?{}:_temp3,_ref7$suppressMillise=_ref7.suppressMilliseconds,suppressMilliseconds=void 0!==_ref7$suppressMillise&&_ref7$suppressMillise,_ref7$suppressSeconds=_ref7.suppressSeconds,suppressSeconds=void 0!==_ref7$suppressSeconds&&_ref7$suppressSeconds,_ref7$includeOffset=_ref7.includeOffset;return toTechTimeFormat(this,{suppressSeconds:suppressSeconds,suppressMilliseconds:suppressMilliseconds,includeOffset:void 0===_ref7$includeOffset||_ref7$includeOffset})},_proto.toRFC2822=function(){return toTechFormat(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ")},_proto.toHTTP=function(){return toTechFormat(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")},_proto.toSQLDate=function(){return toTechFormat(this,"yyyy-MM-dd")},_proto.toSQLTime=function(_temp4){var _ref8=void 0===_temp4?{}:_temp4,_ref8$includeOffset=_ref8.includeOffset,includeOffset=void 0===_ref8$includeOffset||_ref8$includeOffset,_ref8$includeZone=_ref8.includeZone;return toTechTimeFormat(this,{includeOffset:includeOffset,includeZone:void 0!==_ref8$includeZone&&_ref8$includeZone,spaceZone:!0})},_proto.toSQL=function(opts){return void 0===opts&&(opts={}),this.isValid?this.toSQLDate()+" "+this.toSQLTime(opts):null},_proto.toString=function(){return this.isValid?this.toISO():"Invalid DateTime"},_proto.valueOf=function(){return this.toMillis()},_proto.toMillis=function(){return this.isValid?this.ts:NaN},_proto.toSeconds=function(){return this.isValid?this.ts/1e3:NaN},_proto.toJSON=function(){return this.toISO()},_proto.toBSON=function(){return this.toJSDate()},_proto.toObject=function(opts){if(void 0===opts&&(opts={}),!this.isValid)return{};var base=Object.assign({},this.c);return opts.includeConfig&&(base.outputCalendar=this.outputCalendar,base.numberingSystem=this.loc.numberingSystem,base.locale=this.loc.locale),base},_proto.toJSDate=function(){return new Date(this.isValid?this.ts:NaN)},_proto.diff=function(otherDateTime,unit,opts){if(void 0===unit&&(unit="milliseconds"),void 0===opts&&(opts={}),!this.isValid||!otherDateTime.isValid)return Duration.invalid(this.invalid||otherDateTime.invalid,"created by diffing an invalid DateTime");var thing,durOpts=Object.assign({locale:this.locale,numberingSystem:this.numberingSystem},opts),units=(thing=unit,Array.isArray(thing)?thing:[thing]).map(Duration.normalizeUnit),otherIsLater=otherDateTime.valueOf()>this.valueOf(),diffed=_diff(otherIsLater?this:otherDateTime,otherIsLater?otherDateTime:this,units,durOpts);return otherIsLater?diffed.negate():diffed},_proto.diffNow=function(unit,opts){return void 0===unit&&(unit="milliseconds"),void 0===opts&&(opts={}),this.diff(DateTime.local(),unit,opts)},_proto.until=function(otherDateTime){return this.isValid?Interval.fromDateTimes(this,otherDateTime):this},_proto.hasSame=function(otherDateTime,unit){if(!this.isValid)return!1;if("millisecond"===unit)return this.valueOf()===otherDateTime.valueOf();var inputMs=otherDateTime.valueOf();return this.startOf(unit)<=inputMs&&inputMs<=this.endOf(unit)},_proto.equals=function(other){return this.isValid&&other.isValid&&this.valueOf()===other.valueOf()&&this.zone.equals(other.zone)&&this.loc.equals(other.loc)},_proto.toRelative=function(options){if(void 0===options&&(options={}),!this.isValid)return null;var base=options.base||DateTime.fromObject({zone:this.zone}),padding=options.padding?this<base?-options.padding:options.padding:0;return diffRelative(base,this.plus(padding),Object.assign(options,{numeric:"always",units:["years","months","days","hours","minutes","seconds"]}))},_proto.toRelativeCalendar=function(options){return void 0===options&&(options={}),this.isValid?diffRelative(options.base||DateTime.fromObject({zone:this.zone}),this,Object.assign(options,{numeric:"auto",units:["years","months","days"],calendary:!0})):null},DateTime.min=function(){for(var _len=arguments.length,dateTimes=new Array(_len),_key=0;_key<_len;_key++)dateTimes[_key]=arguments[_key];if(!dateTimes.every(DateTime.isDateTime))throw new InvalidArgumentError("min requires all arguments be DateTimes");return bestBy(dateTimes,function(i){return i.valueOf()},Math.min)},DateTime.max=function(){for(var _len2=arguments.length,dateTimes=new Array(_len2),_key2=0;_key2<_len2;_key2++)dateTimes[_key2]=arguments[_key2];if(!dateTimes.every(DateTime.isDateTime))throw new InvalidArgumentError("max requires all arguments be DateTimes");return bestBy(dateTimes,function(i){return i.valueOf()},Math.max)},DateTime.fromFormatExplain=function(text,fmt,options){void 0===options&&(options={});var _options=options,_options$locale=_options.locale,locale=void 0===_options$locale?null:_options$locale,_options$numberingSys=_options.numberingSystem,numberingSystem=void 0===_options$numberingSys?null:_options$numberingSys;return explainFromTokens(Locale.fromOpts({locale:locale,numberingSystem:numberingSystem,defaultToEN:!0}),text,fmt)},DateTime.fromStringExplain=function(text,fmt,options){return void 0===options&&(options={}),DateTime.fromFormatExplain(text,fmt,options)},_createClass(DateTime,[{key:"isValid",get:function(){return null===this.invalid}},{key:"invalidReason",get:function(){return this.invalid?this.invalid.reason:null}},{key:"invalidExplanation",get:function(){return this.invalid?this.invalid.explanation:null}},{key:"locale",get:function(){return this.isValid?this.loc.locale:null}},{key:"numberingSystem",get:function(){return this.isValid?this.loc.numberingSystem:null}},{key:"outputCalendar",get:function(){return this.isValid?this.loc.outputCalendar:null}},{key:"zone",get:function(){return this._zone}},{key:"zoneName",get:function(){return this.isValid?this.zone.name:null}},{key:"year",get:function(){return this.isValid?this.c.year:NaN}},{key:"quarter",get:function(){return this.isValid?Math.ceil(this.c.month/3):NaN}},{key:"month",get:function(){return this.isValid?this.c.month:NaN}},{key:"day",get:function(){return this.isValid?this.c.day:NaN}},{key:"hour",get:function(){return this.isValid?this.c.hour:NaN}},{key:"minute",get:function(){return this.isValid?this.c.minute:NaN}},{key:"second",get:function(){return this.isValid?this.c.second:NaN}},{key:"millisecond",get:function(){return this.isValid?this.c.millisecond:NaN}},{key:"weekYear",get:function(){return this.isValid?possiblyCachedWeekData(this).weekYear:NaN}},{key:"weekNumber",get:function(){return this.isValid?possiblyCachedWeekData(this).weekNumber:NaN}},{key:"weekday",get:function(){return this.isValid?possiblyCachedWeekData(this).weekday:NaN}},{key:"ordinal",get:function(){return this.isValid?gregorianToOrdinal(this.c).ordinal:NaN}},{key:"monthShort",get:function(){return this.isValid?Info.months("short",{locale:this.locale})[this.month-1]:null}},{key:"monthLong",get:function(){return this.isValid?Info.months("long",{locale:this.locale})[this.month-1]:null}},{key:"weekdayShort",get:function(){return this.isValid?Info.weekdays("short",{locale:this.locale})[this.weekday-1]:null}},{key:"weekdayLong",get:function(){return this.isValid?Info.weekdays("long",{locale:this.locale})[this.weekday-1]:null}},{key:"offset",get:function(){return this.isValid?+this.o:NaN}},{key:"offsetNameShort",get:function(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}},{key:"offsetNameLong",get:function(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}},{key:"isOffsetFixed",get:function(){return this.isValid?this.zone.universal:null}},{key:"isInDST",get:function(){return!this.isOffsetFixed&&(this.offset>this.set({month:1}).offset||this.offset>this.set({month:5}).offset)}},{key:"isInLeapYear",get:function(){return isLeapYear(this.year)}},{key:"daysInMonth",get:function(){return daysInMonth(this.year,this.month)}},{key:"daysInYear",get:function(){return this.isValid?daysInYear(this.year):NaN}},{key:"weeksInWeekYear",get:function(){return this.isValid?weeksInWeekYear(this.weekYear):NaN}}],[{key:"DATE_SHORT",get:function(){return DATE_SHORT}},{key:"DATE_MED",get:function(){return DATE_MED}},{key:"DATE_FULL",get:function(){return DATE_FULL}},{key:"DATE_HUGE",get:function(){return DATE_HUGE}},{key:"TIME_SIMPLE",get:function(){return TIME_SIMPLE}},{key:"TIME_WITH_SECONDS",get:function(){return TIME_WITH_SECONDS}},{key:"TIME_WITH_SHORT_OFFSET",get:function(){return TIME_WITH_SHORT_OFFSET}},{key:"TIME_WITH_LONG_OFFSET",get:function(){return TIME_WITH_LONG_OFFSET}},{key:"TIME_24_SIMPLE",get:function(){return TIME_24_SIMPLE}},{key:"TIME_24_WITH_SECONDS",get:function(){return TIME_24_WITH_SECONDS}},{key:"TIME_24_WITH_SHORT_OFFSET",get:function(){return TIME_24_WITH_SHORT_OFFSET}},{key:"TIME_24_WITH_LONG_OFFSET",get:function(){return TIME_24_WITH_LONG_OFFSET}},{key:"DATETIME_SHORT",get:function(){return DATETIME_SHORT}},{key:"DATETIME_SHORT_WITH_SECONDS",get:function(){return DATETIME_SHORT_WITH_SECONDS}},{key:"DATETIME_MED",get:function(){return DATETIME_MED}},{key:"DATETIME_MED_WITH_SECONDS",get:function(){return DATETIME_MED_WITH_SECONDS}},{key:"DATETIME_MED_WITH_WEEKDAY",get:function(){return DATETIME_MED_WITH_WEEKDAY}},{key:"DATETIME_FULL",get:function(){return DATETIME_FULL}},{key:"DATETIME_FULL_WITH_SECONDS",get:function(){return DATETIME_FULL_WITH_SECONDS}},{key:"DATETIME_HUGE",get:function(){return DATETIME_HUGE}},{key:"DATETIME_HUGE_WITH_SECONDS",get:function(){return DATETIME_HUGE_WITH_SECONDS}}]),DateTime}();function friendlyDateTime(dateTimeish){if(DateTime.isDateTime(dateTimeish))return dateTimeish;if(dateTimeish&&dateTimeish.valueOf&&isNumber(dateTimeish.valueOf()))return DateTime.fromJSDate(dateTimeish);if(dateTimeish&&"object"==typeof dateTimeish)return DateTime.fromObject(dateTimeish);throw new InvalidArgumentError("Unknown datetime argument: "+dateTimeish+", of type "+typeof dateTimeish)}exports.DateTime=DateTime,exports.Duration=Duration,exports.FixedOffsetZone=FixedOffsetZone,exports.IANAZone=IANAZone,exports.Info=Info,exports.Interval=Interval,exports.InvalidZone=InvalidZone,exports.LocalZone=LocalZone,exports.Settings=Settings,exports.Zone=Zone}),System.register("src/api/common/utils/CommonCalendarUtils.js",["./DateUtils","../EntityFunctions"],function(_export,_context){"use strict";var DAY_IN_MILLIS,stringToCustomId,DAYS_SHIFTED_MS;function isAllDayEventByTimes(startTime,endTime){return 0===startTime.getUTCHours()&&0===startTime.getUTCMinutes()&&0===startTime.getUTCSeconds()&&0===endTime.getUTCHours()&&0===endTime.getUTCMinutes()&&0===endTime.getUTCSeconds()}function createEventElementId(timestamp,shiftDays){return stringToCustomId(String(timestamp+shiftDays))}return _export("isAllDayEvent",function(_ref){return isAllDayEventByTimes(_ref.startTime,_ref.endTime)}),_export("isAllDayEventByTimes",isAllDayEventByTimes),_export("getAllDayDateUTC",function(localDate){return new Date(Date.UTC(localDate.getFullYear(),localDate.getMonth(),localDate.getDate(),0,0,0,0))}),_export("getAllDayDateLocal",function(utcDate){return new Date(utcDate.getUTCFullYear(),utcDate.getUTCMonth(),utcDate.getUTCDate())}),_export("generateEventElementId",function(timestamp){return createEventElementId(timestamp,2*Math.floor(Math.random()*DAYS_SHIFTED_MS)-DAYS_SHIFTED_MS)}),_export("geEventElementMaxId",function(timestamp){return createEventElementId(timestamp,DAYS_SHIFTED_MS)}),_export("getEventElementMinId",function(timestamp){return createEventElementId(timestamp,-DAYS_SHIFTED_MS)}),_export("eventsAtTheSameTime",function(firstEvent,secondEvent){if(firstEvent.startTime!==secondEvent.startTime)return!1;var firstRule=firstEvent.repeatRule,secondRule=secondEvent.repeatRule;return firstRule&&secondRule?firstRule.frequency===secondRule.frequency&&firstRule.interval===secondRule.interval&&firstRule.endType===secondRule.endType&&firstRule.endValue===secondRule.endValue&&firstRule.timeZone===secondRule.timeZone:!firstRule&&!secondRule}),{setters:[function(_DateUtils){DAY_IN_MILLIS=_DateUtils.DAY_IN_MILLIS},function(_EntityFunctions){stringToCustomId=_EntityFunctions.stringToCustomId}],execute:function(){_export("DAYS_SHIFTED_MS",DAYS_SHIFTED_MS=15*DAY_IN_MILLIS),_export("DAYS_SHIFTED_MS",DAYS_SHIFTED_MS)}}}),System.register("src/calendar/CalendarUtils.js",["node_modules/systemjs-plugin-babel/babel-helpers/slicedToArray.js","node_modules/systemjs-plugin-babel/babel-helpers/toConsumableArray.js","../api/common/utils/DateUtils","../api/common/utils/StringUtils","../api/common/TutanotaConstants","luxon","../api/common/utils/Utils","../api/entities/tutanota/CalendarRepeatRule","../api/common/utils/CommonCalendarUtils","../misc/LanguageViewModel","../misc/Formatter","../gui/size","../api/Env","../api/main/LoginController","../api/common/EntityFunctions","../api/common/utils/MapUtils"],function(_export,_context){"use strict";var _slicedToArray,_toConsumableArray,getStartOfDay,incrementDate,pad,defaultCalendarColor,EventTextTimeOption,getWeekStart,GroupType,ShareCapability,WeekStart,DateTime,clone,neverNull,createCalendarRepeatRule,DAYS_SHIFTED_MS,generateEventElementId,isAllDayEvent,lang,formatTime,size,assertMainOrNode,logins,isSameId,getFromMap,CALENDAR_EVENT_HEIGHT;function timeStringFromParts(hours,minutes,amPm){var minutesString=pad(minutes,2);return amPm?0===hours?"12:"+minutesString+" am":12===hours?"12:"+minutesString+" pm":hours>12?hours-12+":"+minutesString+" pm":hours+":"+minutesString+" am":pad(hours,2)+":"+minutesString}function getAllDayDateForTimezone(utcDate,timeZone){return DateTime.fromObject({year:utcDate.getUTCFullYear(),month:utcDate.getUTCMonth()+1,day:utcDate.getUTCDate(),zone:timeZone}).toJSDate()}function getStartOfDayWithZone(date,zone){return DateTime.fromJSDate(date,{zone:zone}).set({hour:0,minute:0,second:0,millisecond:0}).toJSDate()}function getStartOfNextDayWithZone(date,zone){return DateTime.fromJSDate(date,{zone:zone}).set({hour:0,minute:0,second:0,millisecond:0}).plus({day:1}).toJSDate()}function getTimeZone(){return DateTime.local().zoneName}function isColorLight(c){var rgb=parseInt(c,16);return 1-(.299*(rgb>>16&255)+.587*(rgb>>8&255)+.114*(rgb>>0&255))/255<.5}function getCalculationEvent(event,zone,handleAsAllDay){if(handleAsAllDay){var calcEvent=clone(event);return isAllDayEvent(event)?(calcEvent.startTime=getAllDayDateForTimezone(event.startTime,zone),calcEvent.endTime=getAllDayDateForTimezone(event.endTime,zone)):(calcEvent.startTime=getStartOfDayWithZone(event.startTime,zone),calcEvent.endTime=getStartOfNextDayWithZone(event.endTime,zone)),calcEvent}return event}function collidesWith(a,b){return a.endTime.getTime()>b.startTime.getTime()&&a.startTime.getTime()<b.endTime.getTime()}function getStartOfWeek(date,firstDayOfWeekFromSundayOffset){var firstDay=void 0;return firstDay=firstDayOfWeekFromSundayOffset>date.getDay()?date.getDay()+7-firstDayOfWeekFromSundayOffset:date.getDay()-firstDayOfWeekFromSundayOffset,incrementDate(getStartOfDay(date),-firstDay)}function getStartOfTheWeekOffset(weekStart){switch(weekStart){case WeekStart.SUNDAY:return 0;case WeekStart.MONDAY:default:return 1}}function getEventEnd(event,timeZone){return isAllDayEvent(event)?getAllDayDateForTimezone(event.endTime,timeZone):event.endTime}function getEventStart(event,timeZone){return isAllDayEvent(event)?getAllDayDateForTimezone(event.startTime,timeZone):event.startTime}function isLongEvent(event,zone){return getEventEnd(event,zone).getTime()-getEventStart(event,zone).getTime()>DAYS_SHIFTED_MS}function isSharedGroupOwner(sharedGroup,userId){return!(!sharedGroup.user||!isSameId(sharedGroup.user,userId))}return _export("eventStartsBefore",function(currentDate,zone,event){return getEventStart(event,zone).getTime()<currentDate.getTime()}),_export("eventEndsAfterDay",function(currentDate,zone,event){return getEventEnd(event,zone).getTime()>getStartOfNextDayWithZone(currentDate,zone).getTime()}),_export("generateUid",function(event,timestamp){return""+neverNull(event._ownerGroup)+timestamp+"@tutanota.com"}),_export("parseTime",function(timeString){var suffix=void 0,hours=void 0,minutes=void 0,mt=timeString.match(/^(\d{1,2}):(\d{1,2})\s*(am|pm|a\.m\.|p\.m\.)?$/i);if(null!=mt)suffix=mt[3],hours=parseInt(mt[1],10),minutes=parseInt(mt[2],10);else{if(null==(mt=timeString.match(/^(\d{1,4})\s*(am|pm|a\.m\.|p\.m\.)?$/i)))return null;suffix=mt[2];var digits=mt[1];digits.length<=2?(hours=parseInt(digits,10),minutes=0):(hours=parseInt(digits.substr(0,digits.length-2),10),minutes=parseInt(digits.substr(-2,2),10))}if(isNaN(hours)||isNaN(minutes)||minutes>59)return null;if(suffix&&(suffix=suffix.toUpperCase()),"PM"===suffix||"P.M."==suffix){if(hours>12)return null;12!==hours&&(hours+=12)}else if("AM"===suffix||"A.M."==suffix){if(hours>12)return null;12===hours&&(hours=0)}else if(hours>23)return null;return{hours:hours,minutes:minutes}}),_export("filterInt",function(value){return/^\d+$/.test(value)?parseInt(value,10):NaN}),_export("timeString",function(date,amPm){return timeStringFromParts(date.getHours(),date.getMinutes(),amPm)}),_export("timeStringFromParts",timeStringFromParts),_export("shouldDefaultToAmPmTimeFormat",function(){return"en"===lang.code}),_export("getAllDayDateForTimezone",getAllDayDateForTimezone),_export("getMonth",function(date,zone){var startDateTime=DateTime.fromJSDate(date,{zone:zone}).set({day:1,hour:0,minute:0,second:0,millisecond:0});return{start:startDateTime.toJSDate(),end:startDateTime.plus({month:1}).toJSDate()}}),_export("getStartOfDayWithZone",getStartOfDayWithZone),_export("getStartOfNextDayWithZone",getStartOfNextDayWithZone),_export("getTimeZone",getTimeZone),_export("createRepeatRuleWithValues",function(frequency,interval){var rule=createCalendarRepeatRule();return rule.timeZone=getTimeZone(),rule.frequency=frequency,rule.interval=String(interval),rule}),_export("isColorLight",isColorLight),_export("colorForBg",function(color){return isColorLight(color)?"black":"white"}),_export("getCalendarMonth",function(date,firstDayOfWeekFromSundayOffset,weekdayNarrowFormat){var weeks=[[]],calculationDate=getStartOfDay(date);calculationDate.setDate(1);var currentYear=calculationDate.getFullYear(),month=calculationDate.getMonth(),firstDay=void 0;firstDay=firstDayOfWeekFromSundayOffset>calculationDate.getDay()?calculationDate.getDay()+7-firstDayOfWeekFromSundayOffset:calculationDate.getDay()-firstDayOfWeekFromSundayOffset;var dayCount=void 0;for(incrementDate(calculationDate,-firstDay),dayCount=0;dayCount<firstDay;dayCount++)weeks[0].push({date:new Date(calculationDate),day:calculationDate.getDate(),month:calculationDate.getMonth(),year:calculationDate.getFullYear(),paddingDay:!0}),incrementDate(calculationDate,1);for(;calculationDate.getMonth()===month;){weeks[0].length&&dayCount%7==0&&weeks.push([]);var dayInfo={date:new Date(currentYear,month,calculationDate.getDate()),year:currentYear,month:month,day:calculationDate.getDate(),paddingDay:!1};weeks[weeks.length-1].push(dayInfo),incrementDate(calculationDate,1),dayCount++}for(;dayCount<42;)dayCount%7==0&&weeks.push([]),weeks[weeks.length-1].push({day:calculationDate.getDate(),year:calculationDate.getFullYear(),month:calculationDate.getMonth(),date:new Date(calculationDate),paddingDay:!0}),incrementDate(calculationDate,1),dayCount++;var weekdays=[],weekdaysDate=new Date;incrementDate(weekdaysDate,-weekdaysDate.getDay()+firstDayOfWeekFromSundayOffset);for(var i=0;i<7;i++)weekdays.push(weekdayNarrowFormat?lang.formats.weekdayNarrow.format(weekdaysDate):lang.formats.weekdayShort.format(weekdaysDate)),incrementDate(weekdaysDate,1);return{weekdays:weekdays,weeks:weeks}}),_export("layOutEvents",function(events,zone,renderer,handleAsAllDay){events.sort(function(e1,e2){var e1Start=getEventStart(e1,zone),e2Start=getEventStart(e2,zone);if(e1Start<e2Start)return-1;if(e1Start>e2Start)return 1;var e1End=getEventEnd(e1,zone),e2End=getEventEnd(e2,zone);return e1End<e2End?-1:e1End>e2End?1:0});var lastEventEnding=null,columns=[],children=[],calcEvents=new Map;return events.forEach(function(e){var calcEvent=getFromMap(calcEvents,e,function(){return getCalculationEvent(e,zone,handleAsAllDay)});null!==lastEventEnding&&calcEvent.startTime.getTime()>=lastEventEnding&&(children.push.apply(children,_toConsumableArray(renderer(columns))),columns=[],lastEventEnding=null);for(var placed=!1,_loop=function(i){var col=columns[i],lastEvent=col[col.length-1];if(!collidesWith(getFromMap(calcEvents,lastEvent,function(){return getCalculationEvent(lastEvent,zone,handleAsAllDay)}),calcEvent))return col.push(e),placed=!0,"break"},i=0;i<columns.length&&"break"!==_loop(i);i++);placed||columns.push([e]),(null===lastEventEnding||calcEvent.endTime.getTime()>lastEventEnding)&&(lastEventEnding=calcEvent.endTime.getTime())}),children.push.apply(children,_toConsumableArray(renderer(columns))),children}),_export("getEventText",function(event,showTime){switch(showTime){case EventTextTimeOption.NO_TIME:return event.summary;case EventTextTimeOption.START_TIME:return formatTime(event.startTime)+" "+event.summary;case EventTextTimeOption.END_TIME:return"- "+formatTime(event.endTime)+" "+event.summary;case EventTextTimeOption.START_END_TIME:return formatTime(event.startTime)+" - "+formatTime(event.endTime)+" "+event.summary;case EventTextTimeOption.ALL_DAY:return lang.get("allDay_label")+" "+event.summary;default:throw new Error("Unknown time option "+showTime)}}),_export("expandEvent",function(ev,columnIndex,columns){for(var colSpan=1,i=columnIndex+1;i<columns.length;i++){for(var _col=columns[i],j=0;j<_col.length;j++)if(collidesWith(ev,_col[j]))return colSpan;colSpan++}return colSpan}),_export("getDiffInDays",function(a,b){return Math.floor(DateTime.fromJSDate(a).diff(DateTime.fromJSDate(b),"day").days)}),_export("getCalendarName",function(groupInfo,allowGroupNameOverride){var groupSettings=logins.getUserController().userSettingsGroupRoot.groupSettings.find(function(gc){return gc.group===groupInfo.group});return allowGroupNameOverride&&groupSettings&&groupSettings.name||groupInfo.name||lang.get("privateCalendar_label")}),_export("getEventColor",function(event,groupColors){return groupColors[neverNull(event._ownerGroup)]||defaultCalendarColor}),_export("getStartOfWeek",getStartOfWeek),_export("getCalendarWeek",function(dayInTheWeek,startOfTheWeek){for(var calculationDate=getStartOfWeek(dayInTheWeek,getStartOfTheWeekOffset(startOfTheWeek)),days=[],i=0;i<7;i++)days.push(calculationDate),calculationDate=incrementDate(new Date(calculationDate),1);return days}),_export("getStartOfTheWeekOffset",getStartOfTheWeekOffset),_export("getStartOfTheWeekOffsetForUser",function(){return getStartOfTheWeekOffset(getWeekStart(logins.getUserController().userSettingsGroupRoot))}),_export("getWeekNumber",function(startOfTheWeek){return DateTime.fromJSDate(startOfTheWeek).weekNumber}),_export("getEventEnd",getEventEnd),_export("getEventStart",getEventStart),_export("getAllDayDateUTCFromZone",function(date,timeZone){return DateTime.fromJSDate(date,{zone:timeZone}).setZone("utc",{keepLocalTime:!0}).toJSDate()}),_export("isLongEvent",isLongEvent),_export("createEventId",function(event,zone,groupRoot){var listId=event.repeatRule||isLongEvent(event,zone)?groupRoot.longEvents:groupRoot.shortEvents;event._id=[listId,generateEventElementId(event.startTime.getTime())]}),_export("hasCapabilityOnGroup",function(user,group,requiredCapability){if(group.type!==GroupType.Calendar)return!1;if(isSharedGroupOwner(group,user._id))return!0;var membership=user.memberships.find(function(gm){return isSameId(gm.group,group._id)});return!!membership&&null!=membership.capability&&Number(requiredCapability)<=Number(membership.capability)}),_export("isSharedGroupOwner",isSharedGroupOwner),_export("getCapabilityText",function(capability){switch(capability){case ShareCapability.Invite:return lang.get("calendarShareCapabilityInvite_label");case ShareCapability.Write:return lang.get("calendarShareCapabilityWrite_label");case ShareCapability.Read:return lang.get("calendarShareCapabilityRead_label");default:return lang.get("comboBoxSelectionNone_msg")}}),_export("isSameEvent",function(left,right){return isSameId(left._id,right._id)&&left.startTime.getTime()===right.startTime.getTime()}),_export("hasAlarmsForTheUser",function(event){var useAlarmList=neverNull(logins.getUserController().user.alarmInfoList).alarms;return event.alarmInfos.some(function(_ref){var listId=_slicedToArray(_ref,1)[0];return isSameId(listId,useAlarmList)})}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs){_slicedToArray=_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs){_toConsumableArray=_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs.default},function(_apiCommonUtilsDateUtils){getStartOfDay=_apiCommonUtilsDateUtils.getStartOfDay,incrementDate=_apiCommonUtilsDateUtils.incrementDate},function(_apiCommonUtilsStringUtils){pad=_apiCommonUtilsStringUtils.pad},function(_apiCommonTutanotaConstants){defaultCalendarColor=_apiCommonTutanotaConstants.defaultCalendarColor,EventTextTimeOption=_apiCommonTutanotaConstants.EventTextTimeOption,getWeekStart=_apiCommonTutanotaConstants.getWeekStart,GroupType=_apiCommonTutanotaConstants.GroupType,ShareCapability=_apiCommonTutanotaConstants.ShareCapability,WeekStart=_apiCommonTutanotaConstants.WeekStart},function(_luxon){DateTime=_luxon.DateTime},function(_apiCommonUtilsUtils){clone=_apiCommonUtilsUtils.clone,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEntitiesTutanotaCalendarRepeatRule){createCalendarRepeatRule=_apiEntitiesTutanotaCalendarRepeatRule.createCalendarRepeatRule},function(_apiCommonUtilsCommonCalendarUtils){DAYS_SHIFTED_MS=_apiCommonUtilsCommonCalendarUtils.DAYS_SHIFTED_MS,generateEventElementId=_apiCommonUtilsCommonCalendarUtils.generateEventElementId,isAllDayEvent=_apiCommonUtilsCommonCalendarUtils.isAllDayEvent},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_miscFormatter){formatTime=_miscFormatter.formatTime},function(_guiSize){size=_guiSize.size},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonEntityFunctions){isSameId=_apiCommonEntityFunctions.isSameId},function(_apiCommonUtilsMapUtils){getFromMap=_apiCommonUtilsMapUtils.getFromMap}],execute:function(){assertMainOrNode(),_export("CALENDAR_EVENT_HEIGHT",CALENDAR_EVENT_HEIGHT=size.calendar_line_height+2),_export("CALENDAR_EVENT_HEIGHT",CALENDAR_EVENT_HEIGHT)}}}),System.register("src/settings/ContactFormViewer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../misc/LanguageViewModel","../gui/base/TextField","../gui/base/TableN","../gui/base/Table","../api/main/Entity","../api/common/TutanotaConstants","../gui/base/ActionBar","../gui/base/Button","./ContactFormEditor","../api/entities/tutanota/ContactForm","./LoadingUtils","../gui/base/icons/Icons","../gui/base/TableLine","../gui/base/Dialog","../api/common/utils/Utils","../api/entities/sys/GroupInfo","../contacts/ContactFormUtils","../subscription/BuyDialog","../gui/base/ProgressDialog","../gui/base/DatePicker","../api/entities/tutanota/StatisticLogEntry","../api/common/utils/Encoding","../api/entities/tutanota/File","../api/common/DataFile","../file/FileController","../api/common/utils/DateUtils","../misc/Formatter","../calendar/CalendarUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,lang,TextField,ColumnWidth,Table,erase,load,loadAll,BookingItemFeatureType,InputFieldType,ActionBar,Button,ContactFormEditor,createContactForm,loadGroupInfos,Icons,TableLine,Dialog,getGroupInfoDisplayName,neverNull,GroupInfoTypeRef,getDefaultContactFormLanguage,BuyDialog,showProgressDialog,DatePicker,StatisticLogEntryTypeRef,stringToUtf8Uint8Array,timestampToGeneratedId,createFile,createDataFile,fileController,DAY_IN_MILLIS,formatSortableDate,getStartOfTheWeekOffsetForUser,ContactFormViewer;function statisticsFieldTypeToString(field){return field.type===InputFieldType.TEXT?lang.get("text_label"):field.type===InputFieldType.NUMBER?lang.get("number_label"):field.type===InputFieldType.ENUM?"["+field.enumValues.map(function(s){return s.name}).join(", ")+"]":""}function getContactFormUrl(domain,path){var pathPrefix="";return-1!==location.pathname.indexOf("client/build")&&(pathPrefix=":9000/client/build"),"https://"+domain+pathPrefix+"/contactform/"+path}return _export("statisticsFieldTypeToString",statisticsFieldTypeToString),_export("getContactFormUrl",getContactFormUrl),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth},function(_guiBaseTable){Table=_guiBaseTable.Table},function(_apiMainEntity){erase=_apiMainEntity.erase,load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll},function(_apiCommonTutanotaConstants){BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,InputFieldType=_apiCommonTutanotaConstants.InputFieldType},function(_guiBaseActionBar){ActionBar=_guiBaseActionBar.ActionBar},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_ContactFormEditor){ContactFormEditor=_ContactFormEditor},function(_apiEntitiesTutanotaContactForm){createContactForm=_apiEntitiesTutanotaContactForm.createContactForm},function(_LoadingUtils){loadGroupInfos=_LoadingUtils.loadGroupInfos},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseTableLine){TableLine=_guiBaseTableLine.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiCommonUtilsUtils){getGroupInfoDisplayName=_apiCommonUtilsUtils.getGroupInfoDisplayName,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_contactsContactFormUtils){getDefaultContactFormLanguage=_contactsContactFormUtils.getDefaultContactFormLanguage},function(_subscriptionBuyDialog){BuyDialog=_subscriptionBuyDialog},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_guiBaseDatePicker){DatePicker=_guiBaseDatePicker.DatePicker},function(_apiEntitiesTutanotaStatisticLogEntry){StatisticLogEntryTypeRef=_apiEntitiesTutanotaStatisticLogEntry.StatisticLogEntryTypeRef},function(_apiCommonUtilsEncoding){stringToUtf8Uint8Array=_apiCommonUtilsEncoding.stringToUtf8Uint8Array,timestampToGeneratedId=_apiCommonUtilsEncoding.timestampToGeneratedId},function(_apiEntitiesTutanotaFile){createFile=_apiEntitiesTutanotaFile.createFile},function(_apiCommonDataFile){createDataFile=_apiCommonDataFile.createDataFile},function(_fileFileController){fileController=_fileFileController.fileController},function(_apiCommonUtilsDateUtils){DAY_IN_MILLIS=_apiCommonUtilsDateUtils.DAY_IN_MILLIS},function(_miscFormatter){formatSortableDate=_miscFormatter.formatSortableDate},function(_calendarCalendarUtils){getStartOfTheWeekOffsetForUser=_calendarCalendarUtils.getStartOfTheWeekOffsetForUser}],execute:function(){assertMainOrNode(),_export("ContactFormViewer",ContactFormViewer=function(){function ContactFormViewer(contactForm,brandingDomain,newContactFormIdReceiver){var _this=this;_classCallCheck(this,ContactFormViewer),this.contactForm=contactForm,this._newContactFormIdReceiver=newContactFormIdReceiver;var actions=(new ActionBar).add(new Button("edit_action",function(){return ContactFormEditor.show(_this.contactForm,!1,_this._newContactFormIdReceiver)},function(){return Icons.Edit})).add(new Button("copy_action",function(){return _this._copy(brandingDomain)},function(){return Icons.Copy})).add(new Button("delete_action",function(){return _this._delete()},function(){return Icons.Trash})),urlField=new TextField("url_label").setValue(getContactFormUrl(brandingDomain,contactForm.path)).setDisabled(),mailGroupField=new TextField("receivingMailbox_label").setValue(lang.get("loading_msg")).setDisabled();load(GroupInfoTypeRef,neverNull(contactForm.targetGroupInfo)).then(function(groupInfo){mailGroupField.setValue(getGroupInfoDisplayName(groupInfo)),m.redraw()});var participantMailGroupsField=null;loadGroupInfos(contactForm.participantGroupInfos).map(function(groupInfo){return getGroupInfoDisplayName(groupInfo)}).then(function(mailGroupNames){mailGroupNames.length>0&&(participantMailGroupsField=new TextField("responsiblePersons_label").setValue(mailGroupNames.join("; ")).setDisabled(),m.redraw())});var language=getDefaultContactFormLanguage(this.contactForm.languages),pageTitleField=new TextField("pageTitle_label").setValue(language.pageTitle).setDisabled(),statisticsFieldsTable=null;language.statisticsFields.length>0&&(statisticsFieldsTable=new Table(["name_label","type_label"],[ColumnWidth.Largest,ColumnWidth.Largest],!1)).updateEntries(language.statisticsFields.map(function(f){return new TableLine([f.name,statisticsFieldTypeToString(f)])}));var startOfTheWeekOffset=getStartOfTheWeekOffsetForUser(),contactFormReportFrom=new DatePicker(startOfTheWeekOffset,"dateFrom_label"),contactFormReportTo=new DatePicker(startOfTheWeekOffset,"dateTo_label");contactFormReportFrom.setDate(new Date),contactFormReportTo.setDate(new Date);var contactFormReportButton=new Button("export_action",function(){return _this._contactFormReport(contactFormReportFrom.date(),contactFormReportTo.date())},function(){return Icons.Export});this.view=function(){return[m("#user-viewer.fill-absolute.scroll.plr-l.pb-floating",[m(".flex-space-between.pt",[m(".h4",lang.get("emailProcessing_label")),m(actions)]),m(mailGroupField),participantMailGroupsField?m(".mt-l",[m(participantMailGroupsField)]):null,m(".h4.mt-l",lang.get("display_action")),m(urlField),m(pageTitleField),statisticsFieldsTable?m(".h4.mt-l",lang.get("statisticsFields_label")):null,statisticsFieldsTable?m(statisticsFieldsTable):null,statisticsFieldsTable?m(".small",lang.get("statisticsFieldsInfo_msg")):null,m(".mt-l",[m(".h4",lang.get("contactFormReport_label")),m(".small",lang.get("contactFormReportInfo_msg")),m(".flex.items-center.mb-s",[m(".flex-column.pr-l",m(contactFormReportFrom)),m(".flex-column.pr-l",m(contactFormReportTo)),m(contactFormReportButton)])])])]}}return _createClass(ContactFormViewer,[{key:"_copy",value:function(brandingDomain){var newForm=createContactForm();newForm.targetGroupInfo=this.contactForm.targetGroupInfo,newForm.participantGroupInfos=this.contactForm.participantGroupInfos.slice(),newForm.path="",newForm.languages=this.contactForm.languages.map(function(l){return Object.assign({},l)}),ContactFormEditor.show(newForm,!0,this._newContactFormIdReceiver)}},{key:"_delete",value:function(){var _this2=this;Dialog.confirm("confirmDeleteContactForm_msg").then(function(confirmed){confirmed&&showProgressDialog("pleaseWait_msg",BuyDialog.show(BookingItemFeatureType.ContactForm,-1,0,!1).then(function(accepted){if(accepted)return erase(_this2.contactForm)}))})}},{key:"_contactFormReport",value:function(from,to){var _this3=this;null==from||null==to||from.getTime()>to.getTime()?Dialog.error("dateInvalidRange_msg"):showProgressDialog("loading_msg",loadAll(StatisticLogEntryTypeRef,neverNull(this.contactForm.statisticsLog).items,timestampToGeneratedId(neverNull(from).getTime()),timestampToGeneratedId(neverNull(to).getTime()+DAY_IN_MILLIS)).then(function(logEntries){var columns=Array.from(new Set(logEntries.map(function(e){return e.values.map(function(v){return v.name})}).reduce(function(a,b){return a.concat(b)},[]))),titleRow="contact form,path,date,"+columns.map(function(columnName){return'"'+columnName+'"'}).join(","),rows=logEntries.map(function(entry){var row=['"'+_this3._getContactFormTitle(_this3.contactForm)+'"',_this3.contactForm.path,formatSortableDate(entry.date)];row.length=3+columns.length;var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=entry.values[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var v=_step.value;row[3+columns.indexOf(v.name)]='"'+v.value+'"'}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return row.join(",")}),csv=[titleRow].concat(rows).join("\n"),data=stringToUtf8Uint8Array(csv),tmpFile=createFile();return tmpFile.name="report.csv",tmpFile.mimeType="text/csv",tmpFile.size=String(data.byteLength),fileController.open(createDataFile(tmpFile,data))}))}},{key:"_getContactFormTitle",value:function(contactForm){var pageTitle="",language=contactForm.languages.find(function(l){return l.code===lang.code});return language?pageTitle=language.pageTitle:contactForm.languages.length>0&&(pageTitle=contactForm.languages[0].pageTitle),pageTitle}},{key:"entityEventsReceived",value:function(updates){}}]),ContactFormViewer}()),_export("ContactFormViewer",ContactFormViewer)}}}),System.register("src/gui/base/Table.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./TableLine","../../misc/LanguageViewModel","./Button","../size","../../api/Env","./Icon"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,lang,px,size,assertMainOrNode,progressIcon,Table;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_TableLine){_TableLine.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_Button){_Button.Button},function(_size){px=_size.px,size=_size.size},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_Icon){progressIcon=_Icon.progressIcon}],execute:function(){assertMainOrNode(),_export("Table",Table=function(){function Table(columnHeadingTextIds,columnWidths,showActionButtonColumn,addButton){var _this=this;_classCallCheck(this,Table),this._lines=[],this._loading=!0,this.view=function(){return m("",[m("table.table",[[_this._createLine(columnHeadingTextIds.map(function(textId){return lang.get(textId)}),showActionButtonColumn,_this._loading?null:addButton,columnWidths,!0)].concat(_this._createContentLines(showActionButtonColumn,columnWidths))]),_this._loading?m(".flex-center.items-center.button-height",progressIcon()):null,_this._loading||0!==_this._lines.length?null:m(".flex-center.items-center.button-height",lang.get("noEntries_msg"))])}}return _createClass(Table,[{key:"_createContentLines",value:function(showActionButtonColumn,columnWidths){var _this2=this;return this._lines.map(function(line){return _this2._createLine(line.cells,showActionButtonColumn,showActionButtonColumn?line.actionButton:null,columnWidths,!1)})}},{key:"_createLine",value:function(texts,showActionButtonColumn,actionButton,columnWidths,bold){var cells=texts.map(function(text,index){return m("td.text-ellipsis.pr.pt-s.pb-s"+columnWidths[index]+(bold?".b":""),{title:text},text)});return showActionButtonColumn&&cells.push(m("td",{style:{width:px(size.button_height)}},actionButton?[m("",{style:{position:"relative",right:px(-size.hpad_button)}},m(actionButton))]:[])),m("tr.selectable",cells)}},{key:"updateEntries",value:function(lines){this._lines=lines,this._loading=!1,window.requestAnimationFrame(function(){return m.redraw()})}}]),Table}()),_export("Table",Table)}}}),System.register("src/gui/base/TableLine.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","../../api/Env","./Button"],function(_export,_context){"use strict";var _classCallCheck,assertMainOrNode;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_Button){_Button.Button}],execute:function(){assertMainOrNode(),_export("default",function TableLine(cells,actionButton){_classCallCheck(this,TableLine),this.cells=cells,this.actionButton=actionButton})}}}),System.register("src/gui/base/TableN.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../../misc/LanguageViewModel","../size","../../api/Env","./Icon","./ButtonN","../../api/common/utils/Utils","./DropdownN","./icons/Icons"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,lang,px,size,assertMainOrNode,progressIcon,ButtonN,ButtonType,isVisible,neverNull,createDropdown,Icons,ColumnWidth,_Table,TableN;return _export("createRowActions",function(instance,currentElement,indexOfElement){var prefixActions=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],elements=instance.getArray(),dropDownActions=prefixActions.concat([{label:"moveToTop_action",type:ButtonType.Dropdown,isVisible:function(){return indexOfElement>1},click:function(){elements.splice(indexOfElement,1),elements.unshift(currentElement),instance.updateInstance()}},{label:"moveUp_action",type:ButtonType.Dropdown,isVisible:function(){return indexOfElement>0},click:function(){var prev=elements[indexOfElement-1];elements[indexOfElement-1]=currentElement,elements[indexOfElement]=prev,instance.updateInstance()}},{label:"moveDown_action",type:ButtonType.Dropdown,isVisible:function(){return indexOfElement<instance.getArray().length-1},click:function(){var next=elements[indexOfElement+1];elements[indexOfElement+1]=currentElement,elements[indexOfElement]=next,instance.updateInstance()}},{label:"moveToBottom_action",type:ButtonType.Dropdown,isVisible:function(){return indexOfElement<instance.getArray().length-2},click:function(){elements.splice(indexOfElement,1),elements.push(currentElement),instance.updateInstance()}},{label:"delete_action",type:ButtonType.Dropdown,click:function(){elements.splice(indexOfElement,1),instance.updateInstance()}}]);return{label:"edit_action",click:createDropdown(function(){return dropDownActions},260),icon:function(){return Icons.Edit}}}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_size){px=_size.px,size=_size.size},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_Icon){progressIcon=_Icon.progressIcon},function(_ButtonN){ButtonN=_ButtonN.ButtonN,ButtonType=_ButtonN.ButtonType,isVisible=_ButtonN.isVisible},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_DropdownN){createDropdown=_DropdownN.createDropdown},function(_iconsIcons){Icons=_iconsIcons.Icons}],execute:function(){assertMainOrNode(),_export("ColumnWidth",ColumnWidth=Object.freeze({Small:".column-width-small",Largest:".column-width-largest"})),_export("ColumnWidth",ColumnWidth),_Table=function(){function _Table(){_classCallCheck(this,_Table)}return _createClass(_Table,[{key:"view",value:function(vnode){var _this=this,a=vnode.attrs,loading=!a.lines,alignments=a.columnAlignments||[],lineAttrs=a.lines?a.lines.map(function(lineAttrs){return _this._createLine(lineAttrs,a.showActionButtonColumn,a.columnWidths,!1,alignments)}):[];return m("",[m("table.table",[[this._createLine({cells:a.columnHeading.map(function(textIdOrFunction){return lang.getMaybeLazy(textIdOrFunction)}),actionButtonAttrs:loading?null:a.addButtonAttrs},a.showActionButtonColumn,a.columnWidths,!0,alignments)].concat(lineAttrs)]),loading?m(".flex-center.items-center.button-height",progressIcon()):null,loading||0!==neverNull(a.lines).length?null:m(".flex-center.items-center.button-height",lang.get("noEntries_msg"))])}},{key:"_createLine",value:function(lineAttrs,showActionButtonColumn,columnWidths,bold,columnAlignments){var cells=void 0;return cells="function"==typeof lineAttrs.cells?lineAttrs.cells().map(function(cellTextData,index){return m("td",[m(".text-ellipsis.pr.pt-s"+columnWidths[index]+(bold?".b":"")+(cellTextData.click?".click":""+(cellTextData.mainStyle?cellTextData.mainStyle:""))+(columnAlignments[index]?".right":""),{title:cellTextData.main,onclick:function(event){return cellTextData.click?cellTextData.click(event,event.target):null}},cellTextData.main),m(".small.text-ellipsis.pr"+(cellTextData.click?".click":""),{onclick:function(event){return cellTextData.click?cellTextData.click(event,event.target):null}},cellTextData.info)])}):lineAttrs.cells.map(function(text,index){return m("td.text-ellipsis.pr.pt-s.pb-s."+columnWidths[index]+(bold?".b":"")+(columnAlignments[index]?".right":""),{title:text},text)}),showActionButtonColumn&&cells.push(m("td",{style:{width:px(size.button_height)}},lineAttrs.actionButtonAttrs&&isVisible(lineAttrs.actionButtonAttrs)?[m("",{style:{position:"relative",right:px(-size.hpad_button)}},m(ButtonN,neverNull(lineAttrs.actionButtonAttrs)))]:[])),m("tr.selectable",cells)}}]),_Table}(),_export("TableN",TableN=_Table),_export("TableN",TableN)}}}),System.register("src/settings/AddStatisticsFieldDialog.js",["mithril","../api/Env","../gui/base/TextField","../gui/base/Dialog","../misc/LanguageViewModel","../api/common/TutanotaConstants","../gui/base/DropDownSelector","../gui/base/Table","../api/entities/tutanota/InputField","../api/entities/tutanota/Name","../gui/base/Button","../gui/base/TableLine","../api/common/utils/ArrayUtils","../gui/base/icons/Icons","../api/common/utils/Utils","mithril/stream/stream.js","../gui/base/TableN"],function(_export,_context){"use strict";var m,assertMainOrNode,TextField,Dialog,lang,InputFieldType,DropDownSelector,Table,createInputField,createName,Button,TableLine,remove,Icons,defer,stream,ColumnWidth;function _updateEnumTable(enumTable,enumNames){enumTable.updateEntries(enumNames.map(function(n){var deleteButton=new Button("delete_action",function(){remove(enumNames,n),_updateEnumTable(enumTable,enumNames)},function(){return Icons.Cancel});return new TableLine([n],deleteButton)}))}return _export("show",function(){var nameField=new TextField("name_label"),types=[{name:lang.get("text_label"),value:InputFieldType.TEXT},{name:lang.get("number_label"),value:InputFieldType.NUMBER},{name:lang.get("enum_label"),value:InputFieldType.ENUM}],typeField=new DropDownSelector("type_label",null,types,stream(types[0].value)),addButton=new Button("addEnumValue_action",function(){Dialog.showTextInputDialog("addEnumValue_action","enumValue_label",null,"",function(newName){return""===newName.trim()?"pleaseEnterEnumValues_msg":null}).then(function(name){enumNames.push(name),_updateEnumTable(enumTable,enumNames)})},function(){return Icons.Add}),enumNames=[],enumTable=new Table(["enumValue_label"],[ColumnWidth.Largest],!0,addButton);_updateEnumTable(enumTable,enumNames);var form={view:function(){return m("",[m(nameField),m(typeField),typeField.selectedValue()===InputFieldType.ENUM?m(enumTable):null])}},_defer=defer(),resolve=_defer.resolve,promise=_defer.promise;return Dialog.showActionDialog({title:lang.get("addStatisticsField_action"),child:form,validator:function(){return function(name,type,enumNames){return""===name.trim()?"enterName_msg":type===InputFieldType.ENUM&&enumNames.length<2?"pleaseEnterEnumValues_msg":void 0}(nameField.value(),typeField.selectedValue(),enumNames)},okAction:function(dialog){var f=createInputField();f.name=nameField.value(),f.type=typeField.selectedValue(),typeField.selectedValue()===InputFieldType.ENUM&&(f.enumValues=enumNames.map(function(name){var n=createName();return n.name=name,n})),dialog.close(),resolve(f)},cancelAction:function(){return resolve(null)}}),promise}),{setters:[function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonTutanotaConstants){InputFieldType=_apiCommonTutanotaConstants.InputFieldType},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_guiBaseTable){Table=_guiBaseTable.Table},function(_apiEntitiesTutanotaInputField){createInputField=_apiEntitiesTutanotaInputField.createInputField},function(_apiEntitiesTutanotaName){createName=_apiEntitiesTutanotaName.createName},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_guiBaseTableLine){TableLine=_guiBaseTableLine.default},function(_apiCommonUtilsArrayUtils){remove=_apiCommonUtilsArrayUtils.remove},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiCommonUtilsUtils){defer=_apiCommonUtilsUtils.defer},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth}],execute:function(){assertMainOrNode()}}}),System.register("src/settings/ContactFormEditor.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/Dialog","../gui/base/Button","../gui/base/TextField","../misc/LanguageViewModel","../api/common/TutanotaConstants","../api/main/Entity","../api/common/utils/Utils","../api/Env","../api/main/LoginController","../api/entities/sys/Customer","../api/entities/sys/GroupInfo","../gui/base/DropDownSelector","../api/entities/sys/Group","../api/common/EntityFunctions","../gui/base/Table","../gui/base/TableN","../gui/base/TableLine","../api/entities/tutanota/ContactForm","../api/common/utils/ArrayUtils","./ContactFormViewer","./AddStatisticsFieldDialog","../gui/base/HtmlEditor","../gui/base/icons/Icons","../api/entities/tutanota/CustomerContactFormGroupRoot","../api/common/error/RestError","../api/entities/tutanota/MailboxGroupRoot","../api/entities/sys/User","../gui/base/ProgressDialog","mithril/stream/stream.js","../api/entities/tutanota/ContactFormLanguage","../gui/animation/Animations","../contacts/ContactFormUtils","../subscription/BuyDialog","../gui/base/icons/BootIcons","../api/entities/sys/CustomerInfo","../misc/WindowFacade","../gui/base/ButtonN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,Dialog,Button,createDropDownButton,TextField,lang,languages,BookingItemFeatureType,GroupType,Keys,load,loadAll,setup,update,compareGroupInfos,getGroupInfoDisplayName,getWhitelabelDomain,neverNull,assertMainOrNode,logins,CustomerTypeRef,GroupInfoTypeRef,DropDownSelector,GroupTypeRef,isSameId,stringToCustomId,Table,ColumnWidth,TableLine,ContactFormTypeRef,createContactForm,mapAndFilterNull,remove,getContactFormUrl,statisticsFieldTypeToString,AddStatisticsFieldDialog,HtmlEditor,Icons,CustomerContactFormGroupRootTypeRef,NotFoundError,MailboxGroupRootTypeRef,UserTypeRef,showProgressDialog,stream,createContactFormLanguage,DefaultAnimationTime,getAdministratedGroupIds,getDefaultContactFormLanguage,BuyDialog,BootIcons,CustomerInfoTypeRef,windowFacade,ButtonType,PATH_PATTERN,ContactFormEditor;function getLanguageName(code){return lang.get(neverNull(languages.find(function(t){return t.code===code})).textId)}return _export("show",function(c,createNew,newContactFormIdReceiver){load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){load(CustomerInfoTypeRef,customer.customerInfo).then(function(customerInfo){var whitelabelDomain=getWhitelabelDomain(customerInfo);whitelabelDomain?showProgressDialog("loading_msg",loadAll(GroupInfoTypeRef,customer.userGroups).filter(function(g){return!g.deleted}).then(function(userGroupInfos){return logins.getUserController().isGlobalAdmin(),getAdministratedGroupIds().then(function(adminGroupIds){return loadAll(GroupInfoTypeRef,customer.teamGroups).filter(function(g){return!g.deleted}).filter(function(teamGroupInfo){return teamGroupInfo.groupType===GroupType.Mail}).then(function(sharedMailGroupInfos){new ContactFormEditor(c,createNew,newContactFormIdReceiver,userGroupInfos,sharedMailGroupInfos,whitelabelDomain.domain).dialog.show()})})})):Dialog.error("whitelabelDomainNeeded_msg")})})}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_guiBaseButton){Button=_guiBaseButton.Button,createDropDownButton=_guiBaseButton.createDropDownButton},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang,languages=_miscLanguageViewModel.languages},function(_apiCommonTutanotaConstants){BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,GroupType=_apiCommonTutanotaConstants.GroupType,Keys=_apiCommonTutanotaConstants.Keys},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,setup=_apiMainEntity.setup,update=_apiMainEntity.update},function(_apiCommonUtilsUtils){compareGroupInfos=_apiCommonUtilsUtils.compareGroupInfos,getGroupInfoDisplayName=_apiCommonUtilsUtils.getGroupInfoDisplayName,getWhitelabelDomain=_apiCommonUtilsUtils.getWhitelabelDomain,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_apiEntitiesSysGroup){GroupTypeRef=_apiEntitiesSysGroup.GroupTypeRef},function(_apiCommonEntityFunctions){isSameId=_apiCommonEntityFunctions.isSameId,stringToCustomId=_apiCommonEntityFunctions.stringToCustomId},function(_guiBaseTable){Table=_guiBaseTable.Table},function(_guiBaseTableN){ColumnWidth=_guiBaseTableN.ColumnWidth},function(_guiBaseTableLine){TableLine=_guiBaseTableLine.default},function(_apiEntitiesTutanotaContactForm){ContactFormTypeRef=_apiEntitiesTutanotaContactForm.ContactFormTypeRef,createContactForm=_apiEntitiesTutanotaContactForm.createContactForm},function(_apiCommonUtilsArrayUtils){mapAndFilterNull=_apiCommonUtilsArrayUtils.mapAndFilterNull,remove=_apiCommonUtilsArrayUtils.remove},function(_ContactFormViewer){getContactFormUrl=_ContactFormViewer.getContactFormUrl,statisticsFieldTypeToString=_ContactFormViewer.statisticsFieldTypeToString},function(_AddStatisticsFieldDialog){AddStatisticsFieldDialog=_AddStatisticsFieldDialog},function(_guiBaseHtmlEditor){HtmlEditor=_guiBaseHtmlEditor.HtmlEditor},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiEntitiesTutanotaCustomerContactFormGroupRoot){CustomerContactFormGroupRootTypeRef=_apiEntitiesTutanotaCustomerContactFormGroupRoot.CustomerContactFormGroupRootTypeRef},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_apiEntitiesTutanotaMailboxGroupRoot){MailboxGroupRootTypeRef=_apiEntitiesTutanotaMailboxGroupRoot.MailboxGroupRootTypeRef},function(_apiEntitiesSysUser){UserTypeRef=_apiEntitiesSysUser.UserTypeRef},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiEntitiesTutanotaContactFormLanguage){createContactFormLanguage=_apiEntitiesTutanotaContactFormLanguage.createContactFormLanguage},function(_guiAnimationAnimations){DefaultAnimationTime=_guiAnimationAnimations.DefaultAnimationTime},function(_contactsContactFormUtils){getAdministratedGroupIds=_contactsContactFormUtils.getAdministratedGroupIds,getDefaultContactFormLanguage=_contactsContactFormUtils.getDefaultContactFormLanguage},function(_subscriptionBuyDialog){BuyDialog=_subscriptionBuyDialog},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType}],execute:function(){assertMainOrNode(),PATH_PATTERN=/^[a-zA-Z0-9_\\-]+$/,_export("ContactFormEditor",ContactFormEditor=function(){function ContactFormEditor(c,createNew,newContactFormIdReceiver,allUserGroupInfos,allSharedMailboxGroupInfos,brandingDomain){var _this=this;if(_classCallCheck(this,ContactFormEditor),this._createNew=createNew,this._contactForm=c||createContactForm(),this._newContactFormIdReceiver=newContactFormIdReceiver,!logins.getUserController().isGlobalAdmin()){var localAdminGroupIds=logins.getUserController().getLocalAdminGroupMemberships().map(function(gm){return gm.group});allSharedMailboxGroupInfos=allSharedMailboxGroupInfos.filter(function(gi){return-1!==localAdminGroupIds.indexOf(gi.localAdmin)}),allUserGroupInfos=allUserGroupInfos.filter(function(gi){return-1!==localAdminGroupIds.indexOf(gi.localAdmin)})}allSharedMailboxGroupInfos.sort(compareGroupInfos),allUserGroupInfos.sort(compareGroupInfos);var selectedTargetGroupInfo=allSharedMailboxGroupInfos.length>0?allSharedMailboxGroupInfos[0]:allUserGroupInfos.length>0?allUserGroupInfos[0]:null;if(this._contactForm.targetGroupInfo){var groupInfo=allSharedMailboxGroupInfos.find(function(groupInfo){return isSameId(neverNull(_this._contactForm.targetGroupInfo),groupInfo._id)});groupInfo||(groupInfo=allUserGroupInfos.find(function(groupInfo){return isSameId(neverNull(_this._contactForm.targetGroupInfo),groupInfo._id)})),groupInfo&&(selectedTargetGroupInfo=groupInfo)}this._receivingMailboxField=new TextField("receivingMailbox_label").setDisabled(),this._receivingMailbox=stream(selectedTargetGroupInfo),this._receivingMailbox.map(function(groupInfo){if(groupInfo){var prefix=(groupInfo.groupType===GroupType.User?lang.get("account_label"):lang.get("sharedMailbox_label"))+": ";_this._receivingMailboxField.value(prefix+getGroupInfoDisplayName(groupInfo))}});var userDropdown=createDropDownButton("account_label",function(){return BootIcons.Contacts},function(){return allUserGroupInfos.map(function(gi){return new Button(function(){return getGroupInfoDisplayName(gi)},function(){_this._participantGroupInfoList.length=0,_this._updateParticipantGroupInfosTable(),_this._receivingMailbox(gi)}).setType(ButtonType.Dropdown).setSelected(function(){return _this._receivingMailbox()===gi})})},250),groupsDropdown=null;allSharedMailboxGroupInfos.length>0&&(groupsDropdown=createDropDownButton("groups_label",function(){return Icons.People},function(){return allSharedMailboxGroupInfos.map(function(gi){return new Button(function(){return getGroupInfoDisplayName(gi)},function(){return _this._receivingMailbox(gi)}).setType(ButtonType.Dropdown).setSelected(function(){return _this._receivingMailbox()===gi})})},250)),this._receivingMailboxField._injectionsRight=function(){return groupsDropdown?[m(userDropdown),m(groupsDropdown)]:[m(userDropdown)]},this._participantGroupInfoList=mapAndFilterNull(this._contactForm.participantGroupInfos,function(groupInfoId){return allUserGroupInfos.find(function(g){return isSameId(g._id,groupInfoId)})});var addParticipantMailGroupButton=new Button("addResponsiblePerson_label",function(){var availableGroupInfos=allUserGroupInfos.filter(function(g){return null==_this._participantGroupInfoList.find(function(alreadyAdded){return isSameId(alreadyAdded._id,g._id)})});if(availableGroupInfos.length>0){var dropdown=new DropDownSelector("group_label",null,availableGroupInfos.map(function(g){return{name:getGroupInfoDisplayName(g),value:g}}),stream(availableGroupInfos[0]),250);Dialog.showActionDialog({title:lang.get("responsiblePersons_label"),child:{view:function(){return m(dropdown)}},allowOkWithReturn:!0,okAction:function(dialog){_this._participantGroupInfoList.push(dropdown.selectedValue()),_this._updateParticipantGroupInfosTable(),dialog.close()}})}},function(){return Icons.Add});if(this._participantGroupInfosTable=new Table(["responsiblePersons_label"],[ColumnWidth.Largest],!0,addParticipantMailGroupButton),this._updateParticipantGroupInfosTable(),this._pathField=new TextField("urlPath_label",function(){return getContactFormUrl(brandingDomain,_this._pathField.value())}).setValue(this._contactForm.path),this._languages=this._contactForm.languages.map(function(l){return Object.assign({},l)}),0===this._languages.length){var l=createContactFormLanguage();l.code="de_sie"===lang.code?"de":lang.code,this._languages.push(l)}var previousLanguage=null,language=getDefaultContactFormLanguage(this._languages);this._language=stream(language),this._languageField=new TextField("language_label").setDisabled();var selectLanguageButton=createDropDownButton("more_label",function(){return Icons.More},function(){var buttons=_this._languages.map(function(l){return new Button(function(){return getLanguageName(l.code)},function(e){return _this._language(l)}).setType(ButtonType.Dropdown)}).sort(function(a,b){return a.getLabel().localeCompare(b.getLabel())});return buttons.push(new Button("addLanguage_action",function(e){var additionalLanguages=languages.filter(function(t){return!t.code.endsWith("_sie")&&null==_this._languages.find(function(l){return l.code===t.code})}).map(function(l){return{name:lang.get(l.textId),value:l.code}}).sort(function(a,b){return a.name.localeCompare(b.name)}),newLanguageCode=stream(additionalLanguages[0].value),tagName=new DropDownSelector("addLanguage_action",null,additionalLanguages,newLanguageCode,250);setTimeout(function(){Dialog.showActionDialog({title:lang.get("addLanguage_action"),child:{view:function(){return m(tagName)}},allowOkWithReturn:!0,okAction:function(dialog){var newLang=createContactFormLanguage();newLang.code=newLanguageCode(),_this._languages.push(newLang),_this._language(newLang),dialog.close()}})},DefaultAnimationTime)}).setType(ButtonType.Dropdown)),buttons},250),deleteLanguageButton=new Button("delete_action",function(){remove(_this._languages,_this._language()),_this._language(_this._languages[0])},function(){return Icons.Cancel});this._languageField._injectionsRight=function(){return[m(selectLanguageButton),_this._languages.length>1?m(deleteLanguageButton):null]},this._pageTitleField=new TextField("pageTitle_label"),this._headerField=new HtmlEditor(null,{enabled:!0}).setModeSwitcher("header_label").setMinHeight(200).showBorders(),this._footerField=new HtmlEditor(null,{enabled:!0}).setModeSwitcher("footer_label").setMinHeight(200).showBorders(),this._helpField=new HtmlEditor(null,{enabled:!0}).setModeSwitcher("helpPage_label").setMinHeight(200).showBorders();var addStatisticsFieldButton=new Button("addStatisticsField_action",function(){return AddStatisticsFieldDialog.show().then(function(inputField){inputField&&(_this._statisticsFields.push(inputField),_this._updateStatisticsFieldTable())})},function(){return Icons.Add});this._statisticsFieldsTable=new Table(["name_label","type_label"],[ColumnWidth.Largest,ColumnWidth.Largest],!0,addStatisticsFieldButton),this._language.map(function(l){previousLanguage&&l!==previousLanguage&&_this.updateLanguageFromFields(previousLanguage),previousLanguage=l,_this._languageField.setValue(getLanguageName(l.code)),_this._pageTitleField.setValue(l.pageTitle),_this._headerField.setValue(l.headerHtml),_this._footerField.setValue(l.footerHtml),_this._helpField.setValue(l.helpHtml),_this._statisticsFields=l.statisticsFields.slice(),_this._updateStatisticsFieldTable()});var cancelAction=function(){return _this._close()},headerBarAttrs={left:[{label:"cancel_action",click:cancelAction,type:ButtonType.Secondary}],right:[{label:"save_action",click:function(){return _this._save()},type:ButtonType.Primary}],middle:function(){return lang.get(_this._createNew?"createContactForm_label":"editContactForm_label")}},windowCloseUnsubscribe=void 0;this.view=function(){return m("#contact-editor.pb",{oncreate:function(vnode){return windowCloseUnsubscribe=windowFacade.addWindowCloseListener(function(){})},onremove:function(vnode){return windowCloseUnsubscribe()}},[m(".h4.mt-l",lang.get("emailProcessing_label")),m(_this._receivingMailboxField),_this._receivingMailbox()&&neverNull(_this._receivingMailbox()).groupType===GroupType.User?null:m(".mt-l",[m(_this._participantGroupInfosTable),m(".small",lang.get("responsiblePersonsInfo_msg"))]),m(".h4.mt-l",lang.get("display_action")),m(_this._pathField),m(_this._languageField),m(_this._pageTitleField),m(_this._headerField),m(_this._footerField),m(_this._helpField),m(".h4.mt-l",lang.get("statisticsFields_label")),m(_this._statisticsFieldsTable)])},this.dialog=Dialog.largeDialog(headerBarAttrs,this).addShortcut({key:Keys.ESC,exec:cancelAction,help:"close_alt"}).setCloseHandler(cancelAction)}return _createClass(ContactFormEditor,[{key:"updateLanguageFromFields",value:function(language){language.pageTitle=this._pageTitleField.value(),language.headerHtml=this._headerField.getValue(),language.footerHtml=this._footerField.getValue(),""===this._helpField.getValue().replace("<div>","").replace("</div>","").replace("<br>","").trim()?language.helpHtml="":language.helpHtml=this._helpField.getValue(),language.statisticsFields=this._statisticsFields}},{key:"_updateStatisticsFieldTable",value:function(){var _this2=this;this._statisticsFieldsTable.updateEntries(this._statisticsFields.map(function(field){var removeButton=new Button("removeStatisticsField_action",function(){remove(_this2._statisticsFields,field),_this2._updateStatisticsFieldTable()},function(){return Icons.Cancel});return new TableLine([field.name,statisticsFieldTypeToString(field)],removeButton)}))}},{key:"_updateParticipantGroupInfosTable",value:function(){var _this3=this;this._participantGroupInfosTable.updateEntries(this._participantGroupInfoList.map(function(groupInfo){var removeButton=new Button("removeGroup_action",function(){remove(_this3._participantGroupInfoList,groupInfo),_this3._updateParticipantGroupInfosTable()},function(){return Icons.Cancel});return new TableLine([getGroupInfoDisplayName(groupInfo)],removeButton)}))}},{key:"_close",value:function(){this.dialog.close()}},{key:"_save",value:function(){var _this4=this;PATH_PATTERN.test(this._pathField.value())?showProgressDialog("pleaseWait_msg",load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerContactFormGroupRootTypeRef,customer.customerGroup).then(function(root){var receivingMailbox=_this4._receivingMailbox();if(!receivingMailbox)return Dialog.error("noReceivingMailbox_label");var contactFormsListId=root.contactForms,customElementIdFromPath=stringToCustomId(_this4._pathField.value()),contactFormIdFromPath=[contactFormsListId,customElementIdFromPath],samePathFormCheck=Promise.resolve(!1);return _this4._contactForm._id&&isSameId(_this4._contactForm._id,contactFormIdFromPath)||(samePathFormCheck=load(ContactFormTypeRef,contactFormIdFromPath).then(function(cf){return!0}).catch(NotFoundError,function(e){return!1})),samePathFormCheck.then(function(samePathForm){return samePathForm?Dialog.error("pathAlreadyExists_msg"):load(GroupTypeRef,receivingMailbox.group).then(function(group){return group.user?load(UserTypeRef,group.user).then(function(user){return neverNull(user.memberships.find(function(m){return m.groupType===GroupType.Mail})).group}):group._id}).then(function(mailGroupId){return load(MailboxGroupRootTypeRef,mailGroupId).then(function(mailboxGroupRoot){var contactFormIdToCheck=_this4._createNew?contactFormIdFromPath:_this4._contactForm._id;if(mailboxGroupRoot.targetMailGroupContactForm&&!isSameId(mailboxGroupRoot.targetMailGroupContactForm,contactFormIdToCheck))return Dialog.error("receivingMailboxAlreadyUsed_msg");_this4._contactForm._ownerGroup=neverNull(logins.getUserController().user.memberships.find(function(m){return m.groupType===GroupType.Customer})).group,_this4._contactForm.targetGroup=receivingMailbox.group,_this4._contactForm.targetGroupInfo=receivingMailbox._id,_this4._contactForm.participantGroupInfos=_this4._participantGroupInfoList.map(function(groupInfo){return groupInfo._id}),_this4._contactForm.path=_this4._pathField.value(),_this4.updateLanguageFromFields(_this4._language()),_this4._contactForm.languages=_this4._languages;var p=void 0;return _this4._createNew?(_this4._contactForm._id=contactFormIdFromPath,p=BuyDialog.show(BookingItemFeatureType.ContactForm,1,0,!1).then(function(accepted){if(accepted)return setup(contactFormsListId,_this4._contactForm).then(function(){_this4._newContactFormIdReceiver(customElementIdFromPath)})})):p=update(_this4._contactForm).then(function(){_this4._newContactFormIdReceiver(customElementIdFromPath)}),p.then(function(){return _this4._close()})})})})})})):Dialog.error("pleaseEnterValidPath_msg")}}]),ContactFormEditor}()),_export("ContactFormEditor",ContactFormEditor)}}}),System.register("src/contacts/ContactFormUtils.js",["../misc/LanguageViewModel","../api/main/Entity","../api/main/LoginController","../api/entities/sys/AdministratedGroup","../api/entities/sys/Group","../api/entities/tutanota/ContactFormLanguage"],function(_export,_context){"use strict";var lang,loadAll,load,logins,AdministratedGroupTypeRef,GroupTypeRef,createContactFormLanguage;return _export("getDefaultContactFormLanguage",function(supportedLanguages){var language=supportedLanguages.find(function(l){return l.code===lang.code||l.code+"_sie"===lang.code});return language||(language=supportedLanguages.find(function(l){return"en"===l.code})),language||(language=supportedLanguages[0]),language||((language=createContactFormLanguage()).code=lang.code),language}),_export("getAdministratedGroupIds",function(){return Promise.all(logins.getUserController().getLocalAdminGroupMemberships().map(function(gm){return load(GroupTypeRef,gm.group)})).map(function(localAdminGroup){if(localAdminGroup.administratedGroups)return loadAll(AdministratedGroupTypeRef,localAdminGroup.administratedGroups.items).map(function(ag){return ag._id[1]})}).reduce(function(allAdministratedGroupIds,administratedGroupIds){return administratedGroupIds?allAdministratedGroupIds.concat(administratedGroupIds):allAdministratedGroupIds},[])}),{setters:[function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiMainEntity){loadAll=_apiMainEntity.loadAll,load=_apiMainEntity.load},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiEntitiesSysAdministratedGroup){AdministratedGroupTypeRef=_apiEntitiesSysAdministratedGroup.AdministratedGroupTypeRef},function(_apiEntitiesSysGroup){GroupTypeRef=_apiEntitiesSysGroup.GroupTypeRef},function(_apiEntitiesTutanotaContactFormLanguage){createContactFormLanguage=_apiEntitiesTutanotaContactFormLanguage.createContactFormLanguage}],execute:function(){}}}),System.register("src/gui/Notifications.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../api/common/utils/Utils","../api/Env","./base/icons/Icons"],function(_export,_context){"use strict";var _classCallCheck,_createClass,noOp,isApp,isDesktop,NotificationIcon,Notifications,notifications;function _showNotification(title,options,onclick){if("granted"===window.Notification.permission)try{var actualOptions=Object.assign({},{icon:NotificationIcon},options),notification=new window.Notification(title,actualOptions);return notification.onclick=onclick,notification}catch(e){console.warn("notification error",e)}return null}return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_apiCommonUtilsUtils){noOp=_apiCommonUtilsUtils.noOp},function(_apiEnv){isApp=_apiEnv.isApp,isDesktop=_apiEnv.isDesktop},function(_baseIconsIcons){NotificationIcon=_baseIconsIcons.NotificationIcon}],execute:function(){_export("Notifications",Notifications=function(){function Notifications(){_classCallCheck(this,Notifications),this.showNotification=isApp()||"undefined"==typeof Notification?noOp:_showNotification}return _createClass(Notifications,[{key:"requestPermission",value:function(){if(!isDesktop()&&!isApp()&&"undefined"!=typeof Notification)try{"denied"!==window.Notification.permission&&window.Notification.requestPermission()}catch(e){console.log("request notification permission error",e)}}}]),Notifications}()),_export("Notifications",Notifications),_export("notifications",notifications=new Notifications),_export("notifications",notifications)}}}),System.register("src/mail/InboxRuleHandler.js",["../api/entities/tutanota/MoveMailData","../api/main/Entity","../api/entities/tutanota/Services","../api/common/TutanotaConstants","../misc/FormatValidator","../api/common/EntityFunctions","../api/common/utils/Utils","../api/Env","../misc/LanguageViewModel","../api/entities/tutanota/MailHeaders","../api/main/LoginController","./MailUtils","../api/common/error/RestError"],function(_export,_context){"use strict";var createMoveMailData,load,serviceRequestVoid,TutanotaService,InboxRuleType,isDomainName,isRegularExpression,HttpMethod,isSameId,getElementId,getMailHeaders,neverNull,noOp,assertMainOrNode,lang,MailHeadersTypeRef,logins,getInboxFolder,NotFoundError,PreconditionFailedError;function getInboxRuleTypeNameMapping(){return[{value:InboxRuleType.FROM_EQUALS,name:lang.get("inboxRuleSenderEquals_action")},{value:InboxRuleType.RECIPIENT_TO_EQUALS,name:lang.get("inboxRuleToRecipientEquals_action")},{value:InboxRuleType.RECIPIENT_CC_EQUALS,name:lang.get("inboxRuleCCRecipientEquals_action")},{value:InboxRuleType.RECIPIENT_BCC_EQUALS,name:lang.get("inboxRuleBCCRecipientEquals_action")},{value:InboxRuleType.SUBJECT_CONTAINS,name:lang.get("inboxRuleSubjectContains_action")},{value:InboxRuleType.MAIL_HEADER_CONTAINS,name:lang.get("inboxRuleMailHeaderContains_action")}]}function _findMatchingRule(mail){return Promise.reduce(logins.getUserController().props.inboxRules,function(resultInboxRule,inboxRule){if(resultInboxRule)return resultInboxRule;var ruleType=inboxRule.type;return ruleType===InboxRuleType.FROM_EQUALS?_checkEmailAddresses([mail.sender],inboxRule):ruleType===InboxRuleType.RECIPIENT_TO_EQUALS?_checkEmailAddresses(mail.toRecipients,inboxRule):ruleType===InboxRuleType.RECIPIENT_CC_EQUALS?_checkEmailAddresses(mail.ccRecipients,inboxRule):ruleType===InboxRuleType.RECIPIENT_BCC_EQUALS?_checkEmailAddresses(mail.bccRecipients,inboxRule):ruleType===InboxRuleType.SUBJECT_CONTAINS?_checkContainsRule(mail.subject,inboxRule):ruleType===InboxRuleType.MAIL_HEADER_CONTAINS&&mail.headers?load(MailHeadersTypeRef,mail.headers).then(function(mailHeaders){return _checkContainsRule(getMailHeaders(mailHeaders),inboxRule)}).catch(NotFoundError,noOp):null},null)}function _checkContainsRule(value,inboxRule){return isRegularExpression(inboxRule.value)&&_matchesRegularExpression(value,inboxRule)?inboxRule:value.indexOf(inboxRule.value)>=0?inboxRule:null}function _matchesRegularExpression(value,inboxRule){return!!isRegularExpression(inboxRule.value)&&new RegExp(inboxRule.value.substring(1,inboxRule.value.length-1)).test(value)}function _checkEmailAddresses(mailAddresses,inboxRule){return mailAddresses.find(function(mailAddress){var cleanMailAddress=mailAddress.address.toLowerCase().trim();return isRegularExpression(inboxRule.value)?_matchesRegularExpression(cleanMailAddress,inboxRule):isDomainName(inboxRule.value)?cleanMailAddress.split("@")[1]===inboxRule.value:cleanMailAddress===inboxRule.value})?inboxRule:null}function isInboxList(mailboxDetail,listId){return isSameId(listId,getInboxFolder(mailboxDetail.folders).mails)}return _export("getInboxRuleTypeNameMapping",getInboxRuleTypeNameMapping),_export("getInboxRuleTypeName",function(type){var typeNameMapping=getInboxRuleTypeNameMapping().find(function(t){return t.value===type});return null!=typeNameMapping?typeNameMapping.name:""}),_export("findAndApplyMatchingRule",function(mailboxDetail,mail){return!mail._errors&&mail.unread&&isInboxList(mailboxDetail,mail._id[0])&&logins.getUserController().isPremiumAccount()?_findMatchingRule(mail).then(function(inboxRule){if(inboxRule){var targetFolder=mailboxDetail.folders.find(function(folder){return isSameId(folder._id,neverNull(inboxRule).targetFolder)});if(targetFolder){var moveMailData=createMoveMailData();return moveMailData.targetFolder=inboxRule.targetFolder,moveMailData.mails.push(mail._id),serviceRequestVoid(TutanotaService.MoveMailService,HttpMethod.POST,moveMailData).catch(PreconditionFailedError,function(e){}),[targetFolder.mails,getElementId(mail)]}return null}return null}):Promise.resolve(null)}),_export("_findMatchingRule",_findMatchingRule),_export("_matchesRegularExpression",_matchesRegularExpression),_export("isInboxList",isInboxList),{setters:[function(_apiEntitiesTutanotaMoveMailData){createMoveMailData=_apiEntitiesTutanotaMoveMailData.createMoveMailData},function(_apiMainEntity){load=_apiMainEntity.load,serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_apiEntitiesTutanotaServices){TutanotaService=_apiEntitiesTutanotaServices.TutanotaService},function(_apiCommonTutanotaConstants){InboxRuleType=_apiCommonTutanotaConstants.InboxRuleType},function(_miscFormatValidator){isDomainName=_miscFormatValidator.isDomainName,isRegularExpression=_miscFormatValidator.isRegularExpression},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod,isSameId=_apiCommonEntityFunctions.isSameId,getElementId=_apiCommonEntityFunctions.getElementId},function(_apiCommonUtilsUtils){getMailHeaders=_apiCommonUtilsUtils.getMailHeaders,neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEntitiesTutanotaMailHeaders){MailHeadersTypeRef=_apiEntitiesTutanotaMailHeaders.MailHeadersTypeRef},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_MailUtils){getInboxFolder=_MailUtils.getInboxFolder},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError}],execute:function(){assertMainOrNode()}}}),System.register("src/mail/MailModel.js",["node_modules/systemjs-plugin-babel/babel-helpers/slicedToArray.js","node_modules/systemjs-plugin-babel/babel-helpers/toConsumableArray.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","../api/common/utils/Utils","../api/entities/tutanota/MoveMailData","../api/main/Entity","../api/entities/tutanota/Services","../api/common/EntityFunctions","../api/common/error/RestError","../gui/base/Dialog","../api/main/LoginController","./MailUtils","../api/entities/tutanota/DeleteMailData","../api/entities/tutanota/MailBox","../api/entities/tutanota/MailboxGroupRoot","../api/entities/sys/GroupInfo","../api/entities/sys/Group","../api/entities/tutanota/MailFolder","../api/common/TutanotaConstants","@hot","../api/entities/sys/User","../api/main/MainLocator","../api/entities/tutanota/Mail","../api/main/EventController","../misc/LanguageViewModel","../gui/Notifications","../api/common/error/ProgrammingError","./InboxRuleHandler","../api/common/utils/MapUtils"],function(_export,_context){"use strict";var _slicedToArray,_toConsumableArray,_classCallCheck,_createClass,m,stream,containsEventOfType,neverNull,noOp,createMoveMailData,load,loadAll,serviceRequestVoid,TutanotaService,elementIdPart,getListId,HttpMethod,isSameId,listIdPart,PreconditionFailedError,Dialog,logins,getTrashFolder,isFinalDelete,createDeleteMailData,MailBoxTypeRef,MailboxGroupRootTypeRef,GroupInfoTypeRef,GroupTypeRef,MailFolderTypeRef,FeatureType,GroupType,MailFolderType,OperationType,replaced,UserTypeRef,locator,MailTypeRef,isUpdateForTypeRef,lang,Notifications,ProgrammingError,findAndApplyMatchingRule,getFromMap,MailModel,mailModel;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs){_slicedToArray=_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs){_toConsumableArray=_node_modulesSystemjsPluginBabelBabelHelpersToConsumableArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiCommonUtilsUtils){containsEventOfType=_apiCommonUtilsUtils.containsEventOfType,neverNull=_apiCommonUtilsUtils.neverNull,noOp=_apiCommonUtilsUtils.noOp},function(_apiEntitiesTutanotaMoveMailData){createMoveMailData=_apiEntitiesTutanotaMoveMailData.createMoveMailData},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_apiEntitiesTutanotaServices){TutanotaService=_apiEntitiesTutanotaServices.TutanotaService},function(_apiCommonEntityFunctions){elementIdPart=_apiCommonEntityFunctions.elementIdPart,getListId=_apiCommonEntityFunctions.getListId,HttpMethod=_apiCommonEntityFunctions.HttpMethod,isSameId=_apiCommonEntityFunctions.isSameId,listIdPart=_apiCommonEntityFunctions.listIdPart},function(_apiCommonErrorRestError){PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_MailUtils){getTrashFolder=_MailUtils.getTrashFolder,isFinalDelete=_MailUtils.isFinalDelete},function(_apiEntitiesTutanotaDeleteMailData){createDeleteMailData=_apiEntitiesTutanotaDeleteMailData.createDeleteMailData},function(_apiEntitiesTutanotaMailBox){MailBoxTypeRef=_apiEntitiesTutanotaMailBox.MailBoxTypeRef},function(_apiEntitiesTutanotaMailboxGroupRoot){MailboxGroupRootTypeRef=_apiEntitiesTutanotaMailboxGroupRoot.MailboxGroupRootTypeRef},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiEntitiesSysGroup){GroupTypeRef=_apiEntitiesSysGroup.GroupTypeRef},function(_apiEntitiesTutanotaMailFolder){MailFolderTypeRef=_apiEntitiesTutanotaMailFolder.MailFolderTypeRef},function(_apiCommonTutanotaConstants){FeatureType=_apiCommonTutanotaConstants.FeatureType,GroupType=_apiCommonTutanotaConstants.GroupType,MailFolderType=_apiCommonTutanotaConstants.MailFolderType,OperationType=_apiCommonTutanotaConstants.OperationType},function(_hot){replaced=_hot.module},function(_apiEntitiesSysUser){UserTypeRef=_apiEntitiesSysUser.UserTypeRef},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_apiEntitiesTutanotaMail){MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_apiMainEventController){_apiMainEventController.EventController,isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiNotifications){Notifications=_guiNotifications.Notifications},function(_apiCommonErrorProgrammingError){ProgrammingError=_apiCommonErrorProgrammingError.ProgrammingError},function(_InboxRuleHandler){findAndApplyMatchingRule=_InboxRuleHandler.findAndApplyMatchingRule},function(_apiCommonUtilsMapUtils){getFromMap=_apiCommonUtilsMapUtils.getFromMap}],execute:function(){_export("MailModel",MailModel=function(){function MailModel(notifications,eventController){_classCallCheck(this,MailModel),this.mailboxDetails=stream(),this.mailboxCounters=stream({}),this._initialization=null,this._notifications=notifications,this._eventController=eventController}return _createClass(MailModel,[{key:"init",value:function(){var _this=this;return this._initialization?this._initialization:(this._eventController.addEntityListener(function(updates){return _this.entityEventsReceived(updates)}),this._eventController.countersStream().map(function(update){_this._mailboxCountersUpdates(update)}),this._init())}},{key:"_init",value:function(){var _this2=this,mailGroupMemberships=logins.getUserController().getMailGroupMemberships();return this._initialization=Promise.all(mailGroupMemberships.map(function(mailGroupMembership){return Promise.all([load(MailboxGroupRootTypeRef,mailGroupMembership.group).then(function(mailGroupRoot){return load(MailBoxTypeRef,mailGroupRoot.mailbox)}),load(GroupInfoTypeRef,mailGroupMembership.groupInfo),load(GroupTypeRef,mailGroupMembership.group)]).spread(function(mailbox,mailGroupInfo,mailGroup){return _this2._loadFolders(neverNull(mailbox.systemFolders).folders,!0).then(function(folders){return{mailbox:mailbox,folders:folders,mailGroupInfo:mailGroupInfo,mailGroup:mailGroup}})})})).then(function(details){_this2.mailboxDetails(details)}).return(),this._initialization}},{key:"_loadFolders",value:function(folderListId,loadSubFolders){var _this3=this;return loadAll(MailFolderTypeRef,folderListId).then(function(folders){return loadSubFolders?Promise.map(folders,function(folder){return _this3._loadFolders(folder.subFolders,!1)}).then(function(subfolders){return folders.concat.apply(folders,_toConsumableArray(subfolders))}):folders}).then(function(folders){return folders.filter(function(f){return!!(f.folderType!==MailFolderType.SPAM&&f.folderType!==MailFolderType.ARCHIVE||logins.isInternalUserLoggedIn())&&(!logins.isEnabled(FeatureType.InternalCommunication)||f.folderType!==MailFolderType.SPAM)})})}},{key:"getMailboxDetails",value:function(){var _this4=this;return this.init().then(function(){return _this4.mailboxDetails()})}},{key:"getMailboxDetailsForMail",value:function(mail){return this.getMailboxDetailsForMailListId(mail._id[0])}},{key:"getMailboxDetailsForMailListId",value:function(mailListId){return this.getMailboxDetails().then(function(mailboxDetails){return neverNull(mailboxDetails.find(function(md){return null!=md.folders.find(function(f){return f.mails===mailListId})}))})}},{key:"getMailboxDetailsForMailGroup",value:function(mailGroupId){return this.getMailboxDetails().then(function(mailboxDetails){return neverNull(mailboxDetails.find(function(md){return mailGroupId===md.mailGroup._id}))})}},{key:"getUserMailboxDetails",value:function(){var userMailGroupMembership=logins.getUserController().getUserMailGroupMembership();return this.getMailboxDetails().then(function(mailboxDetails){return neverNull(mailboxDetails.find(function(md){return md.mailGroup._id===userMailGroupMembership.group}))})}},{key:"getMailboxFolders",value:function(mail){return this.getMailboxDetailsForMail(mail).then(function(md){return md.folders})}},{key:"getMailFolder",value:function(mailListId){var mailboxDetails=this.mailboxDetails()||[],_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=mailboxDetails[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var e=_step.value,_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=e.folders[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var f=_step2.value;if(f.mails===mailListId)return f}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}return null}},{key:"moveMails",value:function(mails,target){var moveMails=mails.filter(function(m){return m._id[0]!==target.mails&&target._ownerGroup===m._ownerGroup});if(moveMails.length>0){var _moveMailData$mails,moveMailData=createMoveMailData();return moveMailData.targetFolder=target._id,(_moveMailData$mails=moveMailData.mails).push.apply(_moveMailData$mails,_toConsumableArray(mails.map(function(m){return m._id}))),serviceRequestVoid(TutanotaService.MoveMailService,HttpMethod.POST,moveMailData).catch(PreconditionFailedError,function(e){return Dialog.error("operationStillActive_msg")})}return Promise.resolve()}},{key:"deleteMails",value:function(mails){var moveMap=new Map,mailBuckets=mails.reduce(function(buckets,mail){var folder=mailModel.getMailFolder(mail._id[0]);if(!folder)throw new ProgrammingError("tried to delete mail without folder");return isFinalDelete(folder)?buckets.trash.push(mail):getFromMap(buckets.move,folder._id,function(){return[]}).push(mail),buckets},{trash:[],move:moveMap}),promises=[];if(mailBuckets.trash.length>0){var _deleteMailData$mails,deleteMailData=createDeleteMailData(),trashFolder=neverNull(this.getMailFolder(getListId(mailBuckets.trash[0])));deleteMailData.folder=trashFolder._id,(_deleteMailData$mails=deleteMailData.mails).push.apply(_deleteMailData$mails,_toConsumableArray(mailBuckets.trash.map(function(m){return m._id}))),promises.push(serviceRequestVoid(TutanotaService.MailService,HttpMethod.DELETE,deleteMailData).catch(PreconditionFailedError,function(e){return Dialog.error("operationStillActive_msg")}))}if(mailBuckets.move.size>0){var _iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var _step3,_loop=function(){var _step3$value=_slicedToArray(_step3.value,2),mails=(_step3$value[0],_step3$value[1]);promises.push(mailModel.getMailboxFolders(mails[0]).then(function(folders){return mailModel.moveMails(mails,getTrashFolder(folders))}))},_iterator3=mailBuckets.move[Symbol.iterator]();!(_iteratorNormalCompletion3=(_step3=_iterator3.next()).done);_iteratorNormalCompletion3=!0)_loop()}catch(err){_didIteratorError3=!0,_iteratorError3=err}finally{try{!_iteratorNormalCompletion3&&_iterator3.return&&_iterator3.return()}finally{if(_didIteratorError3)throw _iteratorError3}}}return Promise.all(promises).return()}},{key:"entityEventsReceived",value:function(updates){var _this5=this,_iteratorNormalCompletion4=!0,_didIteratorError4=!1,_iteratorError4=void 0;try{for(var _step4,_loop2=function(){var update=_step4.value;if(isUpdateForTypeRef(MailFolderTypeRef,update))_this5._init().then(function(){return m.redraw()});else if(isUpdateForTypeRef(GroupInfoTypeRef,update))update.operation===OperationType.UPDATE&&_this5._init().then(function(){return m.redraw()});else if(isUpdateForTypeRef(UserTypeRef,update))update.operation===OperationType.UPDATE&&isSameId(logins.getUserController().user._id,update.instanceId)&&load(UserTypeRef,update.instanceId).then(function(updatedUser){var newMemberships=updatedUser.memberships.filter(function(membership){return membership.groupType===GroupType.Mail});_this5.getMailboxDetails().then(function(mailboxDetails){newMemberships.length!==mailboxDetails.length&&_this5._init().then(function(){return m.redraw()})})});else if(isUpdateForTypeRef(MailTypeRef,update)&&update.operation===OperationType.CREATE){var folder=_this5.getMailFolder(update.instanceListId);if(folder&&folder.folderType===MailFolderType.INBOX&&!containsEventOfType(updates,OperationType.DELETE,update.instanceId)){var mailId=[update.instanceListId,update.instanceId];load(MailTypeRef,mailId).then(function(mail){return mailModel.getMailboxDetailsForMailListId(update.instanceListId).then(function(mailboxDetail){return findAndApplyMatchingRule(mailboxDetail,mail)}).then(function(newId){return _this5._showNotification(newId||mailId)})}).catch(noOp)}}},_iterator4=updates[Symbol.iterator]();!(_iteratorNormalCompletion4=(_step4=_iterator4.next()).done);_iteratorNormalCompletion4=!0)_loop2()}catch(err){_didIteratorError4=!0,_iteratorError4=err}finally{try{!_iteratorNormalCompletion4&&_iterator4.return&&_iterator4.return()}finally{if(_didIteratorError4)throw _iteratorError4}}}},{key:"_mailboxCountersUpdates",value:function(counters){var normalized=this.mailboxCounters()||{},group=normalized[counters.mailGroup]||{};counters.counterValues.forEach(function(value){group[value.mailListId]=Number(value.count)||0}),normalized[counters.mailGroup]=group,this.mailboxCounters(normalized)}},{key:"_showNotification",value:function(mailId){this._notifications.showNotification(lang.get("newMails_msg"),{},function(e){m.route.set("/mail/"+listIdPart(mailId)+"/"+elementIdPart(mailId)),window.focus()})}},{key:"getCounterValue",value:function(listId){var _this6=this;return this.getMailboxDetailsForMailListId(listId).then(function(mailboxDetails){var mailGroupCounter=_this6.mailboxCounters()[mailboxDetails.mailGroup._id];return mailGroupCounter&&mailGroupCounter[listId]}).catch(function(){return null})}}]),MailModel}()),_export("MailModel",MailModel),_export("mailModel",mailModel=new MailModel(new Notifications,locator.eventController)),_export("mailModel",mailModel),replaced&&Object.assign(mailModel,replaced.mailModel)}}}),System.register("src/search/SearchUtils.js",["mithril","../api/entities/tutanota/Mail","../api/entities/tutanota/Contact","../api/entities/sys/GroupInfo","../api/Env","../api/common/EntityFunctions","../api/common/utils/Utils","../api/common/utils/DateUtils","../api/main/LoginController","../api/entities/sys/WhitelabelChild","../misc/RouteChange"],function(_export,_context){"use strict";var m,MailModel,MailTypeRef,ContactModel,ContactTypeRef,GroupInfoTypeRef,assertMainOrNode,isSameTypeRef,neverNull,getDayShifted,getStartOfDay,logins,WhitelabelChildTypeRef,throttleRoute,FIXED_FREE_SEARCH_DAYS,SEARCH_CATEGORIES,SEARCH_MAIL_FIELDS,routeSetThrottled;function getFreeSearchStartDate(){return getStartOfDay(getDayShifted(new Date,-FIXED_FREE_SEARCH_DAYS))}function createRestriction(searchCategory,start,end,field,listId){logins.getUserController().isFreeAccount()&&"mail"===searchCategory&&(start=null,end=getFreeSearchStartDate().getTime(),field=null,listId=null);var r={type:neverNull(SEARCH_CATEGORIES.find(function(c){return c.name===searchCategory})).typeRef,start:start,end:end,field:null,attributeIds:null,listId:listId};if(field&&"mail"===searchCategory){var fieldData=SEARCH_MAIL_FIELDS.find(function(f){return f.field===field});fieldData&&(r.field=field,r.attributeIds=fieldData.attributeIds)}else field&&"contact"===searchCategory&&("recipient"===field?(r.field=field,r.attributeIds=[ContactModel.values.firstName.id,ContactModel.values.lastName.id,ContactModel.associations.mailAddresses.id]):"mailAddress"===field&&(r.field=field,r.attributeIds=[ContactModel.associations.mailAddresses.id]));return r}function getValueFromRoute(route,name){var key="&"+name+"=",keyIndex=route.indexOf(key);if(-1!==keyIndex){var valueStartIndex=keyIndex+key.length,valueEndIndex=route.indexOf("&",valueStartIndex),value=-1===valueEndIndex?route.substring(valueStartIndex):route.substring(valueStartIndex,valueEndIndex);return decodeURIComponent(value)}return null}return _export("setSearchUrl",function(url){url!==m.route.get()&&routeSetThrottled(url)}),_export("getSearchUrl",function(query,restriction,selectedId){var url="/search/"+neverNull(SEARCH_CATEGORIES.find(function(c){return isSameTypeRef(c.typeRef,restriction.type)})).name+(selectedId?"/"+selectedId:"")+"?query="+encodeURIComponent(query||"");return restriction.start&&(url+="&start="+restriction.start),restriction.end&&(url+="&end="+restriction.end),restriction.listId&&(url+="&list="+restriction.listId),restriction.field&&(url+="&field="+restriction.field),url}),_export("getFreeSearchStartDate",getFreeSearchStartDate),_export("createRestriction",createRestriction),_export("getRestriction",function(route){var category="mail",start=null,end=null,field=null,listId=null;if(route.startsWith("/mail")||route.startsWith("/search/mail")){if(category="mail",route.startsWith("/search/mail"))try{var startString=getValueFromRoute(route,"start");startString&&(start=Number(startString));var endString=getValueFromRoute(route,"end");endString&&(end=Number(endString));var fieldString=getValueFromRoute(route,"field");SEARCH_MAIL_FIELDS.find(function(f){return f.field===fieldString})&&(field=fieldString);var listIdString=getValueFromRoute(route,"list");listIdString&&(listId=listIdString)}catch(e){console.log("invalid query: "+route,e)}}else if(route.startsWith("/contact")||route.startsWith("/search/contact"))category="contact";else if(route.startsWith("/settings/users")||route.startsWith("/settings/groups"))category="groupinfo";else{if(!route.startsWith("/settings/whitelabelaccounts"))throw new Error("invalid type "+route);category="whitelabelchild"}return createRestriction(category,start,end,field,listId)}),_export("isAdministratedGroup",function(localAdminGroupIds,gi){return!(!gi.localAdmin||-1===localAdminGroupIds.indexOf(gi.localAdmin))||-1!==localAdminGroupIds.indexOf(gi.group)}),{setters:[function(_mithril){m=_mithril.default},function(_apiEntitiesTutanotaMail){MailModel=_apiEntitiesTutanotaMail._TypeModel,MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_apiEntitiesTutanotaContact){ContactModel=_apiEntitiesTutanotaContact._TypeModel,ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_apiEntitiesSysGroupInfo){GroupInfoTypeRef=_apiEntitiesSysGroupInfo.GroupInfoTypeRef},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiCommonEntityFunctions){isSameTypeRef=_apiCommonEntityFunctions.isSameTypeRef},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiCommonUtilsDateUtils){getDayShifted=_apiCommonUtilsDateUtils.getDayShifted,getStartOfDay=_apiCommonUtilsDateUtils.getStartOfDay},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiEntitiesSysWhitelabelChild){WhitelabelChildTypeRef=_apiEntitiesSysWhitelabelChild.WhitelabelChildTypeRef},function(_miscRouteChange){throttleRoute=_miscRouteChange.throttleRoute}],execute:function(){assertMainOrNode(),FIXED_FREE_SEARCH_DAYS=28,_export("SEARCH_CATEGORIES",SEARCH_CATEGORIES=[{name:"mail",typeRef:MailTypeRef},{name:"contact",typeRef:ContactTypeRef},{name:"groupinfo",typeRef:GroupInfoTypeRef},{name:"whitelabelchild",typeRef:WhitelabelChildTypeRef}]),_export("SEARCH_CATEGORIES",SEARCH_CATEGORIES),_export("SEARCH_MAIL_FIELDS",SEARCH_MAIL_FIELDS=[{textId:"all_label",field:null,attributeIds:null},{textId:"subject_label",field:"subject",attributeIds:[MailModel.values.subject.id]},{textId:"mailBody_label",field:"body",attributeIds:[MailModel.associations.body.id]},{textId:"from_label",field:"from",attributeIds:[MailModel.associations.sender.id]},{textId:"to_label",field:"to",attributeIds:[MailModel.associations.toRecipients.id,MailModel.associations.ccRecipients.id,MailModel.associations.bccRecipients.id]},{textId:"attachmentName_label",field:"attachment",attributeIds:[MailModel.associations.attachments.id]}]),_export("SEARCH_MAIL_FIELDS",SEARCH_MAIL_FIELDS),routeSetThrottled=throttleRoute()}}}),System.register("src/contacts/ContactUtils.js",["node_modules/systemjs-plugin-babel/babel-helpers/defineProperty.js","../misc/LanguageViewModel.js","../api/common/TutanotaConstants","../api/Env","../search/SearchUtils","../api/main/Entity","../api/entities/tutanota/Contact","../api/common/utils/LazyLoaded","../api/entities/tutanota/ContactList","../api/common/error/RestError","../api/main/LoginController","../api/common/utils/Utils","../api/main/WorkerClient","../api/common/EntityFunctions","../api/entities/tutanota/Birthday","../misc/Formatter","../api/common/error/DbError"],function(_export,_context){"use strict";var _defineProperty,lang,ContactAddressType,ContactPhoneNumberType,ContactSocialType,assertMainOrNode,createRestriction,load,loadAll,loadRoot,ContactTypeRef,LazyLoaded,ContactListTypeRef,NotAuthorizedError,NotFoundError,logins,asyncFindAndMap,neverNull,worker,compareOldestFirst,sortCompareByReverseId,createBirthday,formatDate,formatDateWithMonth,formatSortableDate,DbError,_ContactMailAddressTy,_ContactPhoneNumberTy,_ContactSocialTypeToL,LazyContactListId,ContactMailAddressTypeToLabel,ContactPhoneNumberTypeToLabel,ContactSocialTypeToLabel;function oldBirthdayToBirthday(oldBirthday){var bDayDetails=createBirthday(),birthdayString=formatSortableDate(oldBirthday).split("-");return bDayDetails.day=String(Number(birthdayString[2])),bDayDetails.month=String(Number(birthdayString[1])),bDayDetails.year=String(Number(birthdayString[0])),bDayDetails}return _export("getContactAddressTypeLabel",function(type,custom){return type===ContactAddressType.CUSTOM?custom:lang.get(ContactMailAddressTypeToLabel[type])}),_export("getContactPhoneNumberTypeLabel",function(type,custom){return type===ContactPhoneNumberType.CUSTOM?custom:lang.get(ContactPhoneNumberTypeToLabel[type])}),_export("getContactSocialTypeLabel",function(type,custom){return type===ContactSocialType.CUSTOM?custom:lang.get(ContactSocialTypeToLabel[type])}),_export("compareContacts",function(contact1,contact2){var c1First=contact1.firstName.trim(),c2First=contact2.firstName.trim(),c1Last=contact1.lastName.trim(),c2Last=contact2.lastName.trim(),c1MailLength=contact1.mailAddresses.length,c2MailLength=contact2.mailAddresses.length;if(c1First||c1Last||(c1First=contact1.company),c2First||c2Last||(c2First=contact2.company),c1First&&!c2First)return-1;if(c2First&&!c1First)return 1;var result=c1First.localeCompare(c2First);if(0===result){if(c1Last&&!c2Last)return-1;if(c2Last&&!c1Last)return 1;result=c1Last.localeCompare(c2Last)}return 0===result?c1MailLength>0&&0===c2MailLength?-1:c2MailLength>0&&0===c1MailLength?1:0===c1MailLength&&0===c2MailLength?sortCompareByReverseId(contact1,contact2):0===(result=contact1.mailAddresses[0].address.trim().localeCompare(contact2.mailAddresses[0].address.trim()))?sortCompareByReverseId(contact1,contact2):result:result}),_export("searchForContacts",function(query,field,minSuggestionCount){return worker.search(query,createRestriction("contact",null,null,field,null),minSuggestionCount).then(function(result){return Promise.map(result.results,function(idTuple){return load(ContactTypeRef,idTuple).catch(NotFoundError,function(e){return null}).catch(NotAuthorizedError,function(e){return null})}).filter(function(contact){return null!=contact})})}),_export("searchForContactByMailAddress",function(mailAddress){var cleanMailAddress=mailAddress.trim().toLowerCase();return worker.search('"'+cleanMailAddress+'"',createRestriction("contact",null,null,"mailAddress",null),0).then(function(result){return result.results.sort(compareOldestFirst),asyncFindAndMap(result.results,function(contactId){return load(ContactTypeRef,contactId).then(function(contact){return contact.mailAddresses.find(function(a){return a.address.trim().toLowerCase()===cleanMailAddress})?contact:null}).catch(NotFoundError,function(e){return null}).catch(NotAuthorizedError,function(e){return null})})}).catch(DbError,function(){return LazyContactListId.getAsync().then(function(listId){return loadAll(ContactTypeRef,listId)}).then(function(contacts){return contacts.find(function(contact){return null!=contact.mailAddresses.find(function(a){return a.address.trim().toLowerCase()===cleanMailAddress})})})})}),_export("getContactDisplayName",function(contact){return contact.nickname?contact.nickname:(contact.firstName+" "+contact.lastName).trim()}),_export("getContactListName",function(contact){var name=(contact.firstName+" "+contact.lastName).trim();return 0===name.length&&(name=contact.company.trim()),name}),_export("formatBirthdayNumeric",function(birthday){if(birthday.year){var refYear=new Date,bdayString=formatDate(new Date(refYear.getFullYear(),Number(neverNull(birthday).month)-1,Number(neverNull(birthday).day)));return bdayString=bdayString.replace(/\d{4}/g,String(neverNull(birthday).year))}return lang.formats.simpleDateWithoutYear.format(new Date(Number(2011),Number(neverNull(birthday).month)-1,Number(neverNull(birthday).day)))}),_export("formatBirthdayWithMonthName",function(birthday){if(birthday.year){var refYear=new Date,bdayString=formatDateWithMonth(new Date(refYear.getFullYear(),Number(neverNull(birthday).month)-1,Number(neverNull(birthday).day)));return bdayString=bdayString.replace(/\d{4}/g,String(neverNull(birthday).year))}return lang.formats.dateWithoutYear.format(new Date(Number(2011),Number(neverNull(birthday).month)-1,Number(neverNull(birthday).day)))}),_export("oldBirthdayToBirthday",oldBirthdayToBirthday),_export("migrateToNewBirthday",function(contact){!contact.birthday&&contact.oldBirthday&&(contact.birthday=oldBirthdayToBirthday(contact.oldBirthday)),contact.oldBirthday&&(contact.oldBirthday=null)}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersDefinePropertyJs){_defineProperty=_node_modulesSystemjsPluginBabelBabelHelpersDefinePropertyJs.default},function(_miscLanguageViewModelJs){lang=_miscLanguageViewModelJs.lang},function(_apiCommonTutanotaConstants){ContactAddressType=_apiCommonTutanotaConstants.ContactAddressType,ContactPhoneNumberType=_apiCommonTutanotaConstants.ContactPhoneNumberType,ContactSocialType=_apiCommonTutanotaConstants.ContactSocialType},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_searchSearchUtils){createRestriction=_searchSearchUtils.createRestriction},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll,loadRoot=_apiMainEntity.loadRoot},function(_apiEntitiesTutanotaContact){ContactTypeRef=_apiEntitiesTutanotaContact.ContactTypeRef},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_apiEntitiesTutanotaContactList){ContactListTypeRef=_apiEntitiesTutanotaContactList.ContactListTypeRef},function(_apiCommonErrorRestError){NotAuthorizedError=_apiCommonErrorRestError.NotAuthorizedError,NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonUtilsUtils){asyncFindAndMap=_apiCommonUtilsUtils.asyncFindAndMap,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonEntityFunctions){compareOldestFirst=_apiCommonEntityFunctions.compareOldestFirst,sortCompareByReverseId=_apiCommonEntityFunctions.sortCompareByReverseId},function(_apiEntitiesTutanotaBirthday){createBirthday=_apiEntitiesTutanotaBirthday.createBirthday},function(_miscFormatter){formatDate=_miscFormatter.formatDate,formatDateWithMonth=_miscFormatter.formatDateWithMonth,formatSortableDate=_miscFormatter.formatSortableDate},function(_apiCommonErrorDbError){DbError=_apiCommonErrorDbError.DbError}],execute:function(){assertMainOrNode(),_export("LazyContactListId",LazyContactListId=new LazyLoaded(function(){return loadRoot(ContactListTypeRef,logins.getUserController().user.userGroup.group).then(function(contactList){return contactList.contacts}).catch(NotFoundError,function(e){if(logins.getUserController().isInternalUser())throw e;return null})})),_export("LazyContactListId",LazyContactListId),_export("ContactMailAddressTypeToLabel",(_defineProperty(_ContactMailAddressTy={},ContactAddressType.PRIVATE,"private_label"),_defineProperty(_ContactMailAddressTy,ContactAddressType.WORK,"work_label"),_defineProperty(_ContactMailAddressTy,ContactAddressType.OTHER,"other_label"),_defineProperty(_ContactMailAddressTy,ContactAddressType.CUSTOM,"custom_label"),ContactMailAddressTypeToLabel=_ContactMailAddressTy)),_export("ContactMailAddressTypeToLabel",ContactMailAddressTypeToLabel),_export("ContactPhoneNumberTypeToLabel",(_defineProperty(_ContactPhoneNumberTy={},ContactPhoneNumberType.PRIVATE,"private_label"),_defineProperty(_ContactPhoneNumberTy,ContactPhoneNumberType.WORK,"work_label"),_defineProperty(_ContactPhoneNumberTy,ContactPhoneNumberType.MOBILE,"mobile_label"),_defineProperty(_ContactPhoneNumberTy,ContactPhoneNumberType.FAX,"fax_label"),_defineProperty(_ContactPhoneNumberTy,ContactPhoneNumberType.OTHER,"other_label"),_defineProperty(_ContactPhoneNumberTy,ContactPhoneNumberType.CUSTOM,"custom_label"),ContactPhoneNumberTypeToLabel=_ContactPhoneNumberTy)),_export("ContactPhoneNumberTypeToLabel",ContactPhoneNumberTypeToLabel),_export("ContactSocialTypeToLabel",(_defineProperty(_ContactSocialTypeToL={},ContactSocialType.TWITTER,"twitter_label"),_defineProperty(_ContactSocialTypeToL,ContactSocialType.FACEBOOK,"facebook_label"),_defineProperty(_ContactSocialTypeToL,ContactSocialType.XING,"xing_label"),_defineProperty(_ContactSocialTypeToL,ContactSocialType.LINKED_IN,"linkedin_label"),_defineProperty(_ContactSocialTypeToL,ContactSocialType.OTHER,"other_label"),_defineProperty(_ContactSocialTypeToL,ContactSocialType.CUSTOM,"custom_label"),ContactSocialTypeToLabel=_ContactSocialTypeToL)),_export("ContactSocialTypeToLabel",ContactSocialTypeToLabel)}}}),System.register("src/file/FileController.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../gui/base/Dialog","../api/main/WorkerClient","../api/common/DataFile","../api/Env","../native/FileApp","../api/common/utils/Utils","../gui/base/ProgressDialog","../api/common/error/CryptoError","../misc/LanguageViewModel","../misc/ClientConstants","../misc/ClientDetector","../api/common/error/RestError","../api/common/utils/ArrayUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,Dialog,worker,createDataFile,assertMainOrNode,isAndroidApp,isApp,isDesktop,fileApp,putFileIntoDownloadsFolder,neverNull,showProgressDialog,CryptoError,lang,BrowserType,client,ConnectionError,splitInChunks,FileController,fileController;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonDataFile){createDataFile=_apiCommonDataFile.createDataFile},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isAndroidApp=_apiEnv.isAndroidApp,isApp=_apiEnv.isApp,isDesktop=_apiEnv.isDesktop},function(_nativeFileApp){fileApp=_nativeFileApp.fileApp,putFileIntoDownloadsFolder=_nativeFileApp.putFileIntoDownloadsFolder},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiCommonErrorCryptoError){CryptoError=_apiCommonErrorCryptoError.CryptoError},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_miscClientConstants){BrowserType=_miscClientConstants.BrowserType},function(_miscClientDetector){client=_miscClientDetector.client},function(_apiCommonErrorRestError){ConnectionError=_apiCommonErrorRestError.ConnectionError},function(_apiCommonUtilsArrayUtils){splitInChunks=_apiCommonUtilsArrayUtils.splitInChunks}],execute:function(){assertMainOrNode(),_export("FileController",FileController=function(){function FileController(){_classCallCheck(this,FileController)}return _createClass(FileController,[{key:"downloadAndOpen",value:function(tutanotaFile,open){var _this=this,downloadPromise=void 0;return downloadPromise=isApp()?worker.downloadFileContentNative(tutanotaFile).then(function(file){return(isAndroidApp()&&!open?putFileIntoDownloadsFolder(file.location):_this.open(file)).finally(function(){return _this._deleteFile(file.location)})}):isDesktop()?(open?worker.downloadFileContentNative(tutanotaFile):worker.downloadFileContent(tutanotaFile)).then(function(file){return _this.open(file)}):worker.downloadFileContent(tutanotaFile).then(function(file){return _this.open(file)}),showProgressDialog("pleaseWait_msg",downloadPromise.catch(CryptoError,function(e){return console.log(e),Dialog.error("corrupted_msg")}).catch(ConnectionError,function(e){return console.log(e),Dialog.error("couldNotAttachFile_msg")}))}},{key:"downloadAll",value:function(tutanotaFiles){var _this2=this;return Promise.map(tutanotaFiles,function(tutanotaFile){return(isApp()?worker.downloadFileContentNative(tutanotaFile):worker.downloadFileContent(tutanotaFile)).catch(CryptoError,function(e){return Dialog.error(function(){return lang.get("corrupted_msg")+" "+tutanotaFile.name}).return(null)}).catch(ConnectionError,function(e){return Dialog.error(function(){return lang.get("couldNotAttachFile_msg")+" "+tutanotaFile.name}).return(null)})},{concurrency:isAndroidApp()?1:5}).then(function(files){return files.filter(Boolean)}).then(function(files){return Promise.each(files,function(file){return(isAndroidApp()?putFileIntoDownloadsFolder(file.location):fileController.open(file)).finally(function(){return _this2._deleteFile(file.location)})})}).return()}},{key:"downloadBatched",value:function(attachments,batchSize,delay){var _this3=this;return splitInChunks(batchSize,attachments).reduce(function(p,chunk){return p.then(function(){return _this3.downloadAll(chunk)}).delay(delay)},Promise.resolve())}},{key:"showFileChooser",value:function(multiple,allowedExtensions){var _this4=this,fileInput=document.getElementById("hiddenFileChooser"),body=neverNull(document.body);fileInput&&body.removeChild(fileInput);var newFileInput=document.createElement("input");newFileInput.setAttribute("type","file"),multiple&&newFileInput.setAttribute("multiple","multiple"),newFileInput.setAttribute("id","hiddenFileChooser"),allowedExtensions&&newFileInput.setAttribute("accept",allowedExtensions.map(function(e){return"."+e}).join(",")),newFileInput.style.display="none";var promise=Promise.fromCallback(function(cb){newFileInput.addEventListener("change",function(e){_this4.readLocalFiles(e.target.files).then(function(dataFiles){cb(null,dataFiles)}).catch(function(e){return console.log(e),Dialog.error("couldNotAttachFile_msg").then(function(){cb(null,[])})})})});return body.appendChild(newFileInput),newFileInput.click(),promise}},{key:"readLocalFiles",value:function(fileList){for(var nativeFiles=[],i=0;i<fileList.length;i++)nativeFiles.push(fileList[i]);return Promise.map(nativeFiles,function(nativeFile){return Promise.fromCallback(function(cb){var reader=new FileReader;reader.onloadend=function(evt){evt.target.readyState===FileReader.DONE&&evt.target.result?cb(null,createDataFile(nativeFile,new Uint8Array(evt.target.result))):cb(new Error("could not load file"))},reader.readAsArrayBuffer(nativeFile)})})}},{key:"open",value:function(file){var _file=file;if("FileReference"===_file._type)return fileApp.open(_file);var dataFile=_file;if(isApp()||isDesktop())return fileApp.saveBlob(dataFile).catch(function(err){return Dialog.error("canNotOpenFileOnDevice_msg")}).return();var saveFunction=window.saveAs||window.webkitSaveAs||window.mozSaveAs||window.msSaveAs||navigator.saveBlob||navigator.msSaveOrOpenBlob||navigator.msSaveBlob||navigator.mozSaveBlob||navigator.webkitSaveBlob;if(saveFunction){var blob=new Blob([dataFile.data],{type:dataFile.mimeType});try{var navAny=navigator;return navAny.msSaveOrOpenBlob?navAny.msSaveOrOpenBlob(blob,dataFile.name):navAny.msSaveBlob?navAny.msSaveBlob(blob,dataFile.name):saveFunction(blob,dataFile.name),Promise.resolve()}catch(e){return console.log(e),Dialog.error("saveDownloadNotPossibleIe_msg")}}else try{var URL=window.URL||window.webkitURL||window.mozURL||window.msURL,_blob=new Blob([dataFile.data],{type:dataFile.mimeType}),url=URL.createObjectURL(_blob),a=document.createElement("a");if(void 0!==a.download){a.href=url,a.download=dataFile.name,a.style.display="none",a.target="_blank";var body=neverNull(document.body);body.appendChild(a),a.click(),body.removeChild(a),setTimeout(function(){window.URL.revokeObjectURL(url)},2e3)}else{if(!client.isIos()||client.browser!==BrowserType.CHROME||"function"!=typeof FileReader)return Dialog.legacyDownload(dataFile.name,url);var reader=new FileReader;reader.onloadend=function(){var url=reader.result;return Dialog.legacyDownload(dataFile.name,url)},reader.readAsDataURL(_blob)}return Promise.resolve()}catch(e){return console.log(e),Dialog.error("canNotOpenFileOnDevice_msg")}}},{key:"_deleteFile",value:function(filePath){isApp()&&fileApp.deleteFile(filePath).catch(function(e){return console.log("failed to delete file",filePath,e)})}}]),FileController}()),_export("FileController",FileController),_export("fileController",fileController=new FileController),_export("fileController",fileController)}}}),System.register("src/mail/MailUtils.js",["mithril","../api/common/RecipientInfo","../misc/Formatter","../api/entities/tutanota/Contact","../api/entities/tutanota/ContactMailAddress","../api/common/TutanotaConstants","../api/common/utils/Utils","../api/Env","../api/entities/sys/PublicKeyData","../api/main/Entity","../api/entities/sys/Services","../api/common/EntityFunctions","../api/entities/sys/PublicKeyReturn","../api/common/error/RestError","../misc/ClientDetector","../api/common/utils/ArrayUtils","../api/main/LoginController","../misc/HtmlSanitizer","../misc/LanguageViewModel","../api/entities/tutanota/MailAddress","../gui/base/icons/Icons","./MailModel","../contacts/ContactUtils","../gui/base/Dialog","../api/common/utils/StringUtils","../file/FileController","../api/common/utils/Encoding"],function(_export,_context){"use strict";var m,isTutanotaMailAddress,recipientInfoType,fullNameToFirstAndLastName,mailAddressToFirstAndLastName,stringToNameAndMailAddress,createContact,createContactMailAddress,ALLOWED_IMAGE_FORMATS,ContactAddressType,TutanotaConstants,getMailFolderType,GroupType,MailFolderType,MailState,MAX_BASE64_IMAGE_SIZE,getEnabledMailAddressesForGroupInfo,getGroupInfoDisplayName,neverNull,assertMainOrNode,isApp,isDesktop,createPublicKeyData,serviceRequest,SysService,HttpMethod,PublicKeyReturnTypeRef,NotFoundError,client,contains,logins,htmlSanitizer,lang,createMailAddress,Icons,mailModel,getContactDisplayName,searchForContactByMailAddress,Dialog,endsWith,fileController,uint8ArrayToBase64;function createNewContact(mailAddress,name){var firstAndLastName=""!==name.trim()?fullNameToFirstAndLastName(name):mailAddressToFirstAndLastName(mailAddress),contact=createContact();contact._owner=logins.getUserController().user._id,contact._ownerGroup=neverNull(logins.getUserController().user.memberships.find(function(m){return m.groupType===GroupType.Contact})).group,contact.firstName=firstAndLastName.firstName,contact.lastName=firstAndLastName.lastName;var ma=createContactMailAddress();return ma.address=mailAddress,ma.type=ContactAddressType.OTHER,ma.customTypeName="",contact.mailAddresses.push(ma),contact}function getDisplayText(name,mailAddress,preferNameOnly){return""===name?mailAddress:client.isMobileDevice()||preferNameOnly?name:name+" <"+mailAddress+">"}function isTutanotaTeamMail(mail){return mail.confidential&&mail.state===MailState.RECEIVED&&endsWith(mail.sender.address,"@tutao.de")}function isExcludedMailAddress(mailAddress){return"no-reply@tutao.de"===mailAddress}function getDefaultSignature(){return"<br><br>"+htmlSanitizer.sanitize(lang.get("defaultEmailSignature_msg",{"{1}":"https://tutanota.com"}),!0).text}function getFolderIconByType(folderType){switch(folderType){case"0":return function(){return Icons.Folder};case"1":return function(){return Icons.Inbox};case"2":return function(){return Icons.Send};case"3":return function(){return Icons.Trash};case"4":return function(){return Icons.Archive};case"5":return function(){return Icons.Spam};case"6":return function(){return Icons.Edit};default:return function(){return Icons.Folder}}}function getFolderIcon(folder){return getFolderIconByType(getMailFolderType(folder))}function getInboxFolder(folders){return getFolder(folders,MailFolderType.INBOX)}function getArchiveFolder(folders){return getFolder(folders,MailFolderType.ARCHIVE)}function getFolder(folders,type){return folders.find(function(f){return f.folderType===type})}function getEnabledMailAddresses(mailboxDetails){return isUserMailbox(mailboxDetails)?getEnabledMailAddressesForGroupInfo(logins.getUserController().userGroupInfo):getEnabledMailAddressesForGroupInfo(mailboxDetails.mailGroupInfo)}function isUserMailbox(mailboxDetails){return null!=mailboxDetails.mailGroup.user}function isFinalDelete(folder){return null!=folder&&(folder.folderType===MailFolderType.TRASH||folder.folderType===MailFolderType.SPAM)}return _export("createRecipientInfo",function(mailAddress,name,contact,doNotResolveContact){var recipientInfo={_type:"RecipientInfo",type:isTutanotaMailAddress(mailAddress)?recipientInfoType.internal:recipientInfoType.unknown,mailAddress:mailAddress,name:name||"",contact:contact,resolveContactPromise:null};return!contact&&!doNotResolveContact&&logins.getUserController()&&logins.getUserController().isInternalUser()&&(recipientInfo.resolveContactPromise=searchForContactByMailAddress(mailAddress).then(function(contact){return contact?(name||(recipientInfo.name=getContactDisplayName(contact)),recipientInfo.contact=contact):recipientInfo.contact=createNewContact(mailAddress,recipientInfo.name),recipientInfo.resolveContactPromise=null,m.redraw(),recipientInfo.contact}).catch(function(e){return console.log("error resolving contact",e),recipientInfo.contact=createNewContact(mailAddress,recipientInfo.name),recipientInfo.resolveContactPromise=null,m.redraw(),recipientInfo.contact})),recipientInfo}),_export("createNewContact",createNewContact),_export("resolveRecipientInfo",function(recipientInfo){if(recipientInfo.type!==recipientInfoType.unknown)return Promise.resolve(recipientInfo);var keyData=createPublicKeyData();return keyData.mailAddress=recipientInfo.mailAddress,serviceRequest(SysService.PublicKeyService,HttpMethod.GET,keyData,PublicKeyReturnTypeRef).then(function(publicKeyData){return recipientInfo.type=recipientInfoType.internal,recipientInfo}).catch(NotFoundError,function(e){return recipientInfo.type=recipientInfoType.external,recipientInfo})}),_export("getDisplayText",getDisplayText),_export("getSenderOrRecipientHeading",function(mail,preferNameOnly){if(mail.state===MailState.RECEIVED)return isExcludedMailAddress(mail.sender.address)?"":getDisplayText(mail.sender.name,mail.sender.address,preferNameOnly);var allRecipients=mail.toRecipients.concat(mail.ccRecipients).concat(mail.bccRecipients);return allRecipients.length>0?getDisplayText(allRecipients[0].name,allRecipients[0].address,preferNameOnly)+(allRecipients.length>1?", ...":""):""}),_export("getSenderOrRecipientHeadingTooltip",function(mail){return isTutanotaTeamMail(mail)&&!isExcludedMailAddress(mail.sender.address)?lang.get("tutaoInfo_msg"):""}),_export("isTutanotaTeamMail",isTutanotaTeamMail),_export("isExcludedMailAddress",isExcludedMailAddress),_export("getDefaultSenderFromUser",function(){var props=logins.getUserController().props;return props.defaultSender&&contains(getEnabledMailAddressesForGroupInfo(logins.getUserController().userGroupInfo),props.defaultSender)?props.defaultSender:neverNull(logins.getUserController().userGroupInfo.mailAddress)}),_export("getDefaultSignature",getDefaultSignature),_export("parseMailtoUrl",function(mailtoUrl){var url=new URL(mailtoUrl),toRecipients=[],ccRecipients=[],bccRecipients=[],addresses=url.pathname.split(","),subject="",body="",createMailAddressFromString=function(address){var nameAndMailAddress=stringToNameAndMailAddress(address);if(nameAndMailAddress){var mailAddress=createMailAddress();return mailAddress.name=nameAndMailAddress.name,mailAddress.address=nameAndMailAddress.mailAddress,mailAddress}return null};if(addresses.forEach(function(address){if(address){var decodedAddress=decodeURIComponent(address);if(decodedAddress){var mailAddressObject=createMailAddressFromString(decodedAddress);mailAddressObject&&toRecipients.push(mailAddressObject)}}}),url.searchParams&&"function"==typeof url.searchParams.entries){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=url.searchParams.entries()[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var pair=_step.value,paramName=pair[0].toLowerCase(),paramValue=pair[1];"subject"===paramName?subject=paramValue:"body"===paramName?body=paramValue.replace(/\r\n/g,"<br>").replace(/\n/g,"<br>"):"cc"===paramName?paramValue.split(",").forEach(function(ccAddress){if(ccAddress){var addressObject=createMailAddressFromString(ccAddress);addressObject&&ccRecipients.push(addressObject)}}):"bcc"===paramName?paramValue.split(",").forEach(function(bccAddress){if(bccAddress){var addressObject=createMailAddressFromString(bccAddress);addressObject&&bccRecipients.push(addressObject)}}):"to"===paramName&&paramValue.split(",").forEach(function(toAddress){if(toAddress){var addressObject=createMailAddressFromString(toAddress);addressObject&&toRecipients.push(addressObject)}})}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}return{to:toRecipients,cc:ccRecipients,bcc:bccRecipients,subject:subject,body:body}}),_export("getFolderName",function(folder){switch(folder.folderType){case"0":return folder.name;case"1":return lang.get("received_action");case"2":return lang.get("sent_action");case"3":return lang.get("trash_action");case"4":return lang.get("archive_action");case"5":return lang.get("spam_action");case"6":return lang.get("draft_action");default:return""}}),_export("getFolderIconByType",getFolderIconByType),_export("getFolderIcon",getFolderIcon),_export("getTrashFolder",function(folders){return folders.find(function(f){return f.folderType===MailFolderType.TRASH})}),_export("getInboxFolder",getInboxFolder),_export("getArchiveFolder",getArchiveFolder),_export("getFolder",getFolder),_export("getSortedSystemFolders",function(folders){return folders.filter(function(f){return f.folderType!==MailFolderType.CUSTOM}).sort(function(folder1,folder2){return folder1.folderType===MailFolderType.DRAFT?1.5-Number(folder2.folderType):folder2.folderType===MailFolderType.DRAFT?Number(folder1.folderType)-1.5:Number(folder1.folderType)-Number(folder2.folderType)})}),_export("getSortedCustomFolders",function(folders){return folders.filter(function(f){return f.folderType===MailFolderType.CUSTOM}).sort(function(folder1,folder2){return folder1.name.localeCompare(folder2.name)})}),_export("getEnabledMailAddresses",getEnabledMailAddresses),_export("isUserMailbox",isUserMailbox),_export("getDefaultSender",function(mailboxDetails){if(isUserMailbox(mailboxDetails)){var props=logins.getUserController().props;return props.defaultSender&&contains(getEnabledMailAddresses(mailboxDetails),props.defaultSender)?props.defaultSender:neverNull(logins.getUserController().userGroupInfo.mailAddress)}return neverNull(mailboxDetails.mailGroupInfo.mailAddress)}),_export("isFinalDelete",isFinalDelete),_export("showDeleteConfirmationDialog",function(mails){var groupedMails=mails.reduce(function(all,mail){return isFinalDelete(mailModel.getMailFolder(mail._id[0]))?all.trash.push(mail):all.move.push(mail),all},{trash:[],move:[]}),confirmationTextId=null;return groupedMails.trash.length>0&&(confirmationTextId=groupedMails.move.length>0?"finallyDeleteSelectedEmails_msg":"finallyDeleteEmails_msg"),null!=confirmationTextId?Dialog.confirm(confirmationTextId):Promise.resolve(!0)}),_export("getSenderName",function(mailboxDetails){return isUserMailbox(mailboxDetails)?logins.getUserController().userGroupInfo.name:mailboxDetails.mailGroupInfo?mailboxDetails.mailGroupInfo.name:""}),_export("getEmailSignature",function(){var type=logins.getUserController().props.emailSignatureType;return type===TutanotaConstants.EMAIL_SIGNATURE_TYPE_DEFAULT?getDefaultSignature():TutanotaConstants.EMAIL_SIGNATURE_TYPE_CUSTOM===type?logins.getUserController().props.customEmailSignature:""}),_export("getMailboxName",function(mailboxDetails){return logins.isInternalUserLoggedIn()?isUserMailbox(mailboxDetails)?getGroupInfoDisplayName(logins.getUserController().userGroupInfo):getGroupInfoDisplayName(neverNull(mailboxDetails.mailGroupInfo)):lang.get("mailbox_label")}),_export("getMailFolderIcon",function(mail){var folder=mailModel.getMailFolder(mail._id[0]);return folder?getFolderIcon(folder)():Icons.Folder}),_export("insertInlineImageB64ClickHandler",function(ev,handler){fileController.showFileChooser(!0,ALLOWED_IMAGE_FORMATS).then(function(files){var tooBig=[],_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=files[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var file=_step2.value;if(file.size>MAX_BASE64_IMAGE_SIZE)tooBig.push(file);else{var b64=uint8ArrayToBase64(file.data),dataUrlString="data:"+file.mimeType+";base64,"+b64;handler.insertImage(dataUrlString,{style:"max-width: 100%"})}}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2.return&&_iterator2.return()}finally{if(_didIteratorError2)throw _iteratorError2}}tooBig.length>0&&Dialog.error(function(){return lang.get("tooBigInlineImages_msg",{"{size}":MAX_BASE64_IMAGE_SIZE/1024})})})}),_export("replaceCidsWithInlineImages",function(dom,inlineImages,onContext){var imageElements=Array.from(dom.querySelectorAll("img[cid]")),elementsWithCid=[];return imageElements.forEach(function(imageElement){var cid=imageElement.getAttribute("cid");if(cid){var inlineImage=inlineImages[cid];if(inlineImage){if(elementsWithCid.push(imageElement),imageElement.setAttribute("src",inlineImages[cid].url),imageElement.classList.remove("tutanota-placeholder"),isApp()){var timeoutId=void 0,startCoords=void 0;imageElement.addEventListener("touchstart",function(e){var touch=e.touches[0];touch&&(startCoords={x:touch.clientX,y:touch.clientY},timeoutId=setTimeout(function(){onContext(inlineImage.file,e,imageElement)},800))}),imageElement.addEventListener("touchmove",function(e){var touch=e.touches[0];touch&&startCoords&&timeoutId&&(Math.abs(touch.clientX-startCoords.x)>40||Math.abs(touch.clientY-startCoords.y)>40)&&clearTimeout(timeoutId)}),imageElement.addEventListener("touchend",function(){timeoutId&&clearTimeout(timeoutId)})}isDesktop()&&imageElement.addEventListener("contextmenu",function(e){onContext(inlineImage.file,e,imageElement),e.preventDefault()})}}}),elementsWithCid}),_export("replaceInlineImagesWithCids",function(dom){var domClone=dom.cloneNode(!0);return Array.from(domClone.querySelectorAll("img[cid]")).forEach(function(inlineImage){var cid=inlineImage.getAttribute("cid");inlineImage.setAttribute("src","cid:"+(cid||"")),inlineImage.removeAttribute("cid")}),domClone}),_export("archiveMails",function(mails){return mails.length>0?mailModel.getMailboxFolders(mails[0]).then(function(folders){return mailModel.moveMails(mails,getArchiveFolder(folders))}):Promise.resolve()}),_export("moveToInbox",function(mails){return mails.length>0?mailModel.getMailboxFolders(mails[0]).then(function(folders){return mailModel.moveMails(mails,getInboxFolder(folders))}):Promise.resolve()}),{setters:[function(_mithril){m=_mithril.default},function(_apiCommonRecipientInfo){isTutanotaMailAddress=_apiCommonRecipientInfo.isTutanotaMailAddress,recipientInfoType=_apiCommonRecipientInfo.recipientInfoType},function(_miscFormatter){fullNameToFirstAndLastName=_miscFormatter.fullNameToFirstAndLastName,mailAddressToFirstAndLastName=_miscFormatter.mailAddressToFirstAndLastName,stringToNameAndMailAddress=_miscFormatter.stringToNameAndMailAddress},function(_apiEntitiesTutanotaContact){createContact=_apiEntitiesTutanotaContact.createContact},function(_apiEntitiesTutanotaContactMailAddress){createContactMailAddress=_apiEntitiesTutanotaContactMailAddress.createContactMailAddress},function(_apiCommonTutanotaConstants){ALLOWED_IMAGE_FORMATS=_apiCommonTutanotaConstants.ALLOWED_IMAGE_FORMATS,ContactAddressType=_apiCommonTutanotaConstants.ContactAddressType,TutanotaConstants=_apiCommonTutanotaConstants.EmailSignatureType,getMailFolderType=_apiCommonTutanotaConstants.getMailFolderType,GroupType=_apiCommonTutanotaConstants.GroupType,MailFolderType=_apiCommonTutanotaConstants.MailFolderType,MailState=_apiCommonTutanotaConstants.MailState,MAX_BASE64_IMAGE_SIZE=_apiCommonTutanotaConstants.MAX_BASE64_IMAGE_SIZE},function(_apiCommonUtilsUtils){getEnabledMailAddressesForGroupInfo=_apiCommonUtilsUtils.getEnabledMailAddressesForGroupInfo,getGroupInfoDisplayName=_apiCommonUtilsUtils.getGroupInfoDisplayName,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isApp=_apiEnv.isApp,isDesktop=_apiEnv.isDesktop},function(_apiEntitiesSysPublicKeyData){createPublicKeyData=_apiEntitiesSysPublicKeyData.createPublicKeyData},function(_apiMainEntity){serviceRequest=_apiMainEntity.serviceRequest},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_apiEntitiesSysPublicKeyReturn){PublicKeyReturnTypeRef=_apiEntitiesSysPublicKeyReturn.PublicKeyReturnTypeRef},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_miscClientDetector){client=_miscClientDetector.client},function(_apiCommonUtilsArrayUtils){contains=_apiCommonUtilsArrayUtils.contains},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_miscHtmlSanitizer){htmlSanitizer=_miscHtmlSanitizer.htmlSanitizer},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEntitiesTutanotaMailAddress){createMailAddress=_apiEntitiesTutanotaMailAddress.createMailAddress},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_MailModel){mailModel=_MailModel.mailModel},function(_contactsContactUtils){getContactDisplayName=_contactsContactUtils.getContactDisplayName,searchForContactByMailAddress=_contactsContactUtils.searchForContactByMailAddress},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiCommonUtilsStringUtils){endsWith=_apiCommonUtilsStringUtils.endsWith},function(_fileFileController){fileController=_fileFileController.fileController},function(_apiCommonUtilsEncoding){uint8ArrayToBase64=_apiCommonUtilsEncoding.uint8ArrayToBase64}],execute:function(){assertMainOrNode()}}}),System.register("src/gui/base/WizardDialog.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./Dialog","../../api/Env","../../misc/WindowFacade","./ButtonN","./icons/Icons","./Icon","../theme","../../misc/LanguageViewModel","../../api/common/TutanotaConstants"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,Dialog,assertMainOrNode,windowFacade,ButtonType,Icons,Icon,getContentButtonIconBackground,theme,lang,Keys,WizardDialog,WizardPagingButton;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_Dialog){Dialog=_Dialog.Dialog},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_ButtonN){ButtonType=_ButtonN.ButtonType},function(_iconsIcons){Icons=_iconsIcons.Icons},function(_Icon){Icon=_Icon.Icon},function(_theme){getContentButtonIconBackground=_theme.getContentButtonIconBackground,theme=_theme.theme},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonTutanotaConstants){Keys=_apiCommonTutanotaConstants.Keys}],execute:function(){assertMainOrNode(),_export("WizardDialog",WizardDialog=function(){function WizardDialog(wizardPages,closeAction){var _this=this;_classCallCheck(this,WizardDialog),this._closeAction=closeAction,this._pages=wizardPages,this._currentPage=this._getEnabledPages()[0],this._pages.forEach(function(page){return page.setPageActionHandler({cancel:function(){return _this._close()},showNext:function(wizardData){return _this._handlePageConfirm(wizardData)}})});var backAction=function(){var pageIndex=_this._getEnabledPages().indexOf(_this._currentPage);pageIndex>0?(_this._backAction(pageIndex-1),m.redraw()):_this._close()},headerBarAttrs={left:[{label:function(){return 0===_this._getEnabledPages().indexOf(_this._currentPage)?lang.get("cancel_action"):lang.get("back_action")},click:backAction,type:ButtonType.Secondary}],right:[{label:"next_action",click:function(){return _this._nextAction()},type:ButtonType.Secondary,isVisible:function(){return _this._currentPage.isNextAvailable()&&_this._getEnabledPages().indexOf(_this._currentPage)!==_this._getEnabledPages().length-1}}],middle:function(){return _this._currentPage.headerTitle()}},windowCloseUnsubscribe=void 0;this.view=function(){return m("#wizardDialogContent.pt",{oncreate:function(vnode){return windowCloseUnsubscribe=windowFacade.addWindowCloseListener(function(){})},onremove:function(vnode){return windowCloseUnsubscribe()}},[m("#wizard-paging.flex-space-around.border-top",{style:{height:"22px",marginTop:"22px"}},_this._getEnabledPages().map(function(p,index){return m(WizardPagingButton,{pageIndex:index,getSelectedPageIndex:function(){return _this._getEnabledPages().indexOf(_this._currentPage)},navigateBackHandler:function(index){return _this._backAction(index)}})})),m(_this._currentPage)])},this.dialog=Dialog.largeDialog(headerBarAttrs,this).addShortcut({key:Keys.ESC,exec:function(){return _this._close()},help:"close_alt"}).setCloseHandler(backAction)}return _createClass(WizardDialog,[{key:"_getEnabledPages",value:function(){var data=this._currentPage?this._currentPage.getUncheckedWizardData():this._pages[0].getUncheckedWizardData();return this._pages.filter(function(p){return p.isEnabled(data)})}},{key:"_backAction",value:function(targetIndex){var pages=this._getEnabledPages(),wizardData=this._currentPage.getUncheckedWizardData();this._currentPage=pages[targetIndex],this._currentPage.updateWizardData(wizardData)}},{key:"_nextAction",value:function(){var _this2=this;this._currentPage.nextAction().then(function(wizardData){wizardData&&_this2._handlePageConfirm(wizardData)})}},{key:"_handlePageConfirm",value:function(wizardData){var pages=this._getEnabledPages(),currentIndex=pages.indexOf(this._currentPage),lastIndex=pages.length-1;currentIndex===lastIndex?this._close():(this._currentPage=currentIndex<lastIndex?pages[currentIndex+1]:pages[lastIndex],this._currentPage.updateWizardData(wizardData))}},{key:"show",value:function(){this.dialog.show()}},{key:"_close",value:function(){var _this3=this;this._closeAction().then(function(){_this3.dialog.close()})}}]),WizardDialog}()),_export("WizardDialog",WizardDialog),WizardPagingButton=function(){function WizardPagingButton(){_classCallCheck(this,WizardPagingButton)}return _createClass(WizardPagingButton,[{key:"view",value:function(vnode){var selectedPageIndex=vnode.attrs.getSelectedPageIndex(),pageIndex=vnode.attrs.pageIndex,filledBg=getContentButtonIconBackground();return m(".button-content.flex-center.items-center",{style:{marginTop:"-22px",cursor:pageIndex<selectedPageIndex?"pointer":"auto"},onclick:function(){pageIndex<selectedPageIndex&&vnode.attrs.navigateBackHandler(pageIndex)}},m(".button-icon.flex-center.items-center",{style:{border:selectedPageIndex===pageIndex?"2px solid "+theme.content_accent:"1px solid "+filledBg,color:selectedPageIndex===pageIndex?theme.content_accent:"inherit","background-color":pageIndex<selectedPageIndex?filledBg:theme.content_bg}},pageIndex<selectedPageIndex?m(Icon,{icon:Icons.Checkmark,style:{fill:theme.content_button_icon,"background-color":filledBg}}):""+(pageIndex+1)))}}]),WizardPagingButton}()}}}),System.register("src/subscription/InvoiceDataInput.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../misc/LanguageViewModel","../gui/base/DropDownSelector","mithril/stream/stream.js","../gui/base/TextField","../api/common/CountryList","../gui/base/HtmlEditor","../api/main/Entity","../api/common/EntityFunctions","../api/entities/sys/Services","../api/entities/sys/LocationServiceGetReturn"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,lang,DropDownSelector,stream,TextField,Countries,CountryType,HtmlEditor,Mode,serviceRequest,HttpMethod,SysService,LocationServiceGetReturnTypeRef,InvoiceDataInput;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_apiCommonCountryList){Countries=_apiCommonCountryList.Countries,CountryType=_apiCommonCountryList.CountryType},function(_guiBaseHtmlEditor){HtmlEditor=_guiBaseHtmlEditor.HtmlEditor,Mode=_guiBaseHtmlEditor.Mode},function(_apiMainEntity){serviceRequest=_apiMainEntity.serviceRequest},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiEntitiesSysLocationServiceGetReturn){LocationServiceGetReturnTypeRef=_apiEntitiesSysLocationServiceGetReturn.LocationServiceGetReturnTypeRef}],execute:function(){_export("InvoiceDataInput",InvoiceDataInput=function(){function InvoiceDataInput(subscriptionOptions,invoiceData){var _this=this;_classCallCheck(this,InvoiceDataInput),this._subscriptionOptions=subscriptionOptions,this._invoiceAddressComponent=(new HtmlEditor).setMinHeight(120).showBorders().setPlaceholderId("invoiceAddress_label").setMode(Mode.HTML).setHtmlMonospace(!1),this._vatNumberField=new TextField("invoiceVatIdNo_label",function(){return lang.get("invoiceVatIdNoInfoBusiness_msg")});var countries=Countries.map(function(c){return{value:c,name:c.n}});countries.push({value:null,name:lang.get("choose_label")}),this.selectedCountry=stream(null);var countryInput=new DropDownSelector("invoiceCountry_label",function(){return lang.get("invoiceCountryInfoConsumer_msg")},countries,this.selectedCountry,250).setSelectionChangedHandler(function(value){_this.selectedCountry(value)});this._invoiceAddressComponent.setValue(invoiceData.invoiceAddress),this._vatNumberField.setValue(invoiceData.vatNumber),this.selectedCountry(invoiceData.country),this.view=function(){return[m(".pt",m(_this._invoiceAddressComponent)),m(".small",lang.get("invoiceAddressInput_msg")),m(countryInput),_this._isVatIdFieldVisible()?m(_this._vatNumberField):null]},this.oncreate=function(){serviceRequest(SysService.LocationService,HttpMethod.GET,null,LocationServiceGetReturnTypeRef).then(function(location){if(!_this.selectedCountry()){var country=Countries.find(function(c){return c.a===location.country});country&&(_this.selectedCountry(country),m.redraw())}})}}return _createClass(InvoiceDataInput,[{key:"validateInvoiceData",value:function(){var address=this._getAddress();if(this._subscriptionOptions.businessUse()){if(""===address.trim()||address.split("\n").length>5)return"invoiceAddressInfoBusiness_msg";if(!this.selectedCountry())return"invoiceCountryInfoBusiness_msg";if(this._isVatIdFieldVisible()&&""===this._vatNumberField.value().trim())return"invoiceVatIdNoMissing_msg"}else{if(!this.selectedCountry())return"invoiceCountryInfoBusiness_msg";if(address.split("\n").length>4)return"invoiceAddressInfoBusiness_msg"}return null}},{key:"_isVatIdFieldVisible",value:function(){var selectedCountry=this.selectedCountry();return this._subscriptionOptions.businessUse()&&null!=selectedCountry&&selectedCountry.t===CountryType.EU}},{key:"getInvoiceData",value:function(){var address=this._getAddress(),selectedCountry=this.selectedCountry();return{invoiceAddress:address,country:selectedCountry,vatNumber:selectedCountry&&selectedCountry.t===CountryType.EU&&this._subscriptionOptions.businessUse()?this._vatNumberField.value():""}}},{key:"_getAddress",value:function(){return this._invoiceAddressComponent.getValue().split("\n").filter(function(line){return line.trim().length>0}).join("\n")}}]),InvoiceDataInput}()),_export("InvoiceDataInput",InvoiceDataInput)}}}),System.register("src/subscription/CreditCardInput.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../gui/base/TextField","mithril","../misc/LanguageViewModel","../api/entities/sys/CreditCard"],function(_export,_context){"use strict";var _classCallCheck,_createClass,TextField,m,lang,createCreditCard,CreditCardInput;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEntitiesSysCreditCard){createCreditCard=_apiEntitiesSysCreditCard.createCreditCard}],execute:function(){_export("CreditCardInput",CreditCardInput=function(){function CreditCardInput(){var _this=this;_classCallCheck(this,CreditCardInput),this.creditCardNumber=new TextField("creditCardNumber_label"),this.cardHolderName=new TextField("creditCardCardHolderName_label"),this.cvv=new TextField("creditCardCVV_label"),this.expirationDate=new TextField("creditCardExpirationDate_label",function(){return lang.get("creditCardExpirationDateFormat_msg")}),this.view=function(){return[m(_this.creditCardNumber),m(_this.cardHolderName),m(_this.cvv),m(_this.expirationDate)]}}return _createClass(CreditCardInput,[{key:"getCreditCardData",value:function(){var monthAndYear=this.expirationDate.value().split("/"),cc=createCreditCard();return cc.number=this.creditCardNumber.value(),cc.cardHolderName=this.cardHolderName.value(),cc.cvv=this.cvv.value(),cc.expirationMonth=monthAndYear.length>0?monthAndYear[0]:"",cc.expirationYear=monthAndYear.length>1?monthAndYear[1]:"",cc}},{key:"setCreditCardData",value:function(data){data?(this.creditCardNumber.value(data.number),this.cardHolderName.value(data.cardHolderName),this.cvv.value(data.cvv),data.expirationMonth&&data.expirationYear&&this.expirationDate.value(data.expirationMonth+"/"+data.expirationYear)):(this.creditCardNumber.value(""),this.cardHolderName.value(""),this.cvv.value(""),this.expirationDate.value(""))}}]),CreditCardInput}()),_export("CreditCardInput",CreditCardInput)}}}),System.register("src/gui/base/MessageBoxN.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../../misc/LanguageViewModel","../../api/Env","../size","../theme"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,lang,assertMainOrNode,px,theme,MessageBoxN;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_size){px=_size.px},function(_theme){theme=_theme.theme}],execute:function(){assertMainOrNode(),_export("MessageBoxN",MessageBoxN=function(){function MessageBoxN(){_classCallCheck(this,MessageBoxN)}return _createClass(MessageBoxN,[{key:"view",value:function(vnode){var _this=this,a=vnode.attrs;return m("#error-dialog.justify-center.items-start",{oncreate:function(vnode){_this._messageNode=vnode.dom,vnode.attrs.visible&&vnode.attrs.visible.map(function(show){_this._messageNode.style.display=show?"flex":"none"})}},[m(".dialog-width-s.pt.pb.plr.border-radius",{style:{"margin-top":px(a.marginTop?a.marginTop:100),"white-space":"pre-wrap","text-align":"center",border:"2px solid "+theme.content_border}},vnode.children.length>0?vnode.children:lang.getMaybeLazy(a.label))])}}]),MessageBoxN}()),_export("MessageBoxN",MessageBoxN)}}}),System.register("src/subscription/PaymentMethodInput.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../misc/LanguageViewModel","../api/common/CountryList","../api/common/TutanotaConstants","./CreditCardInput","../gui/base/icons/Icons","../api/main/Entity","../api/common/utils/LazyLoaded","../gui/base/ProgressDialog","../api/entities/sys/AccountingInfo","../api/main/MainLocator","../api/main/EventController","../gui/base/MessageBoxN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,lang,CountryType,PaymentMethodType,CreditCardInput,PayPalLogo,load,showProgressDialog,AccountingInfoTypeRef,locator,isUpdateForTypeRef,MessageBoxN,PaymentMethodInput;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonCountryList){CountryType=_apiCommonCountryList.CountryType},function(_apiCommonTutanotaConstants){PaymentMethodType=_apiCommonTutanotaConstants.PaymentMethodType},function(_CreditCardInput){CreditCardInput=_CreditCardInput.CreditCardInput},function(_guiBaseIconsIcons){PayPalLogo=_guiBaseIconsIcons.PayPalLogo},function(_apiMainEntity){load=_apiMainEntity.load},function(_apiCommonUtilsLazyLoaded){_apiCommonUtilsLazyLoaded.LazyLoaded},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiEntitiesSysAccountingInfo){AccountingInfoTypeRef=_apiEntitiesSysAccountingInfo.AccountingInfoTypeRef},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_guiBaseMessageBoxN){MessageBoxN=_guiBaseMessageBoxN.MessageBoxN}],execute:function(){_export("PaymentMethodInput",PaymentMethodInput=function(){function PaymentMethodInput(subscriptionOptions,selectedCountry,accountingInfo,payPalRequestUrl){var _this=this;_classCallCheck(this,PaymentMethodInput),this._selectedCountry=selectedCountry,this._subscriptionOptions=subscriptionOptions,this._creditCardComponent=new CreditCardInput,this._accountingInfo=accountingInfo,this._payPalRequestUrl=payPalRequestUrl;var accountingInfoListener=function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var update=_step.value;isUpdateForTypeRef(AccountingInfoTypeRef,update)&&load(AccountingInfoTypeRef,update.instanceId).then(function(accountingInfo){_this._accountingInfo=accountingInfo,m.redraw()})}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}};this._payPalComponent={view:function(){return[m(".flex-center",{style:{"margin-top":"50px"}},m("button.button-height.flex.items-center.plr.border.border-radius.bg-white",{title:"PayPal",style:{cursor:"pointer"},onclick:function(){_this._payPalRequestUrl.isLoaded()?window.open(_this._payPalRequestUrl.getSync()):showProgressDialog("payPalRedirect_msg",_this._payPalRequestUrl.getAsync()).then(function(url){return window.open(url)})}},m("img[src="+PayPalLogo+"]"))),m(".small.pt.center",_this.isPaypalAssigned()?lang.get("paymentDataPayPalFinished_msg",{"{accountAddress}":_this._accountingInfo.paymentMethodInfo}):lang.get("paymentDataPayPalLogin_msg"))]}},this._invoiceComponent={view:function(){return m(".flex-center",m(MessageBoxN,{label:_this.isOnAccountAllowed()?"paymentMethodOnAccount_msg":"paymentMethodNotAvailable_msg",marginTop:16}))}},this._currentPaymentMethodComponent=this._creditCardComponent,this._selectedPaymentMethod=PaymentMethodType.CreditCard,this.view=function(){return m(_this._currentPaymentMethodComponent)},this.oncreate=function(){return locator.eventController.addEntityListener(accountingInfoListener)},this.onremove=function(){return locator.eventController.removeEntityListener(accountingInfoListener)}}return _createClass(PaymentMethodInput,[{key:"isPaypalAssigned",value:function(){return null!=this._accountingInfo.paypalBillingAgreement}},{key:"isOnAccountAllowed",value:function(){var country=this._selectedCountry();return!!country&&(this._accountingInfo.paymentMethod===PaymentMethodType.Invoice||!(!this._subscriptionOptions.businessUse()||country.t===CountryType.OTHER))}},{key:"validatePaymentData",value:function(){this._selectedCountry();if(!this._selectedPaymentMethod)return"invoicePaymentMethodInfo_msg";if(this._selectedPaymentMethod===PaymentMethodType.Invoice){if(!this.isOnAccountAllowed())return"paymentMethodNotAvailable_msg"}else{if(this._selectedPaymentMethod===PaymentMethodType.Paypal)return this.isPaypalAssigned()?null:"paymentDataPayPalLogin_msg";if(this._selectedPaymentMethod===PaymentMethodType.CreditCard){var cc=this._creditCardComponent.getCreditCardData();if(""===cc.number)return"creditCardNumberFormat_msg";if(""===cc.cardHolderName)return"creditCardCardHolderName_msg";if(""===cc.cvv)return"creditCardCVVFormat_label";if(2!==cc.expirationMonth.length||4!==cc.expirationYear.length&&2!==cc.expirationYear.length)return"creditCardExprationDateInvalid_msg"}}}},{key:"updatePaymentMethod",value:function(value,paymentData){this._selectedPaymentMethod=value,value===PaymentMethodType.CreditCard?(this._currentPaymentMethodComponent=this._creditCardComponent,paymentData&&this._creditCardComponent.setCreditCardData(paymentData.creditCardData)):value===PaymentMethodType.Paypal?(this._payPalRequestUrl.getAsync().then(function(){return m.redraw()}),this._currentPaymentMethodComponent=this._payPalComponent):value===PaymentMethodType.Invoice&&(this._currentPaymentMethodComponent=this._invoiceComponent),m.redraw()}},{key:"getPaymentData",value:function(){return{paymentMethod:this._selectedPaymentMethod,creditCardData:this._selectedPaymentMethod===PaymentMethodType.CreditCard?this._creditCardComponent.getCreditCardData():null}}},{key:"getVisiblePaymentMethods",value:function(){var availablePaymentMethods=[{name:lang.get("paymentMethodCreditCard_label"),value:PaymentMethodType.CreditCard},{name:"PayPal",value:PaymentMethodType.Paypal}];return(this._subscriptionOptions.businessUse()||this._accountingInfo.paymentMethod===PaymentMethodType.Invoice)&&availablePaymentMethods.push({name:lang.get("paymentMethodOnAccount_label"),value:PaymentMethodType.Invoice}),availablePaymentMethods}}]),PaymentMethodInput}()),_export("PaymentMethodInput",PaymentMethodInput)}}}),System.register("src/subscription/PaymentDataDialog.js",["mithril","mithril/stream/stream.js","../gui/base/Dialog","../misc/LanguageViewModel","../api/common/CountryList","../gui/base/DropDownSelector","./PaymentMethodInput","./InvoiceAndPaymentDataPage","../gui/size","../misc/Formatter","../gui/base/ProgressDialog","../api/common/TutanotaConstants","../api/common/utils/LazyLoaded","../api/main/Entity","../api/entities/sys/PaymentDataServiceGetReturn","../api/entities/sys/Services","../api/common/EntityFunctions","../api/common/utils/Utils"],function(_export,_context){"use strict";var m,stream,Dialog,lang,getByAbbreviation,DropDownSelector,PaymentMethodInput,updatePaymentData,px,formatNameAndAddress,showProgressDialog,getPaymentMethodType,PaymentMethodType,LazyLoaded,serviceRequest,PaymentDataServiceGetReturnTypeRef,SysService,HttpMethod,neverNull;function getLazyLoadedPayPalUrl(){return new LazyLoaded(function(){return serviceRequest(SysService.PaymentDataService,HttpMethod.GET,null,PaymentDataServiceGetReturnTypeRef).then(function(result){return result.loginUrl})},null)}return _export("show",function(accountingInfo){var payPalRequestUrl=getLazyLoadedPayPalUrl(),invoiceData={invoiceAddress:formatNameAndAddress(accountingInfo.invoiceName,accountingInfo.invoiceAddress),country:accountingInfo.invoiceCountry?getByAbbreviation(accountingInfo.invoiceCountry):null,vatNumber:accountingInfo.invoiceVatIdNo},subscriptionOptions={businessUse:stream(accountingInfo.business),paymentInterval:stream(Number(accountingInfo.paymentInterval))},paymentMethodInput=new PaymentMethodInput(subscriptionOptions,stream(invoiceData.country),neverNull(accountingInfo),payPalRequestUrl),availablePaymentMethods=paymentMethodInput.getVisiblePaymentMethods(),paymentMethod=getPaymentMethodType(accountingInfo),selectedPaymentMethod=stream(paymentMethod);paymentMethodInput.updatePaymentMethod(paymentMethod);var paymentMethodSelector=new DropDownSelector("paymentMethod_label",null,availablePaymentMethods,selectedPaymentMethod,250);return paymentMethodSelector.setSelectionChangedHandler(function(value){value!==PaymentMethodType.Paypal||payPalRequestUrl.isLoaded()?(selectedPaymentMethod(value),paymentMethodInput.updatePaymentMethod(value)):showProgressDialog("pleaseWait_msg",payPalRequestUrl.getAsync().then(function(){selectedPaymentMethod(value),paymentMethodInput.updatePaymentMethod(value)}))}),Promise.fromCallback(function(cb){var dialog=Dialog.showActionDialog({title:lang.get("adminPayment_action"),child:{view:function(){return m("#changePaymentDataDialog",{style:{minHeight:px(310)}},[m(paymentMethodSelector),m(paymentMethodInput)])}},okAction:function(){var error=paymentMethodInput.validatePaymentData();error?Dialog.error(error):showProgressDialog("updatePaymentDataBusy_msg",updatePaymentData(subscriptionOptions,invoiceData,paymentMethodInput.getPaymentData(),invoiceData.country,!1)).then(function(success){success&&(dialog.close(),cb(null,!0))})},allowCancel:!0,okActionTextId:"save_action",cancelAction:function(){return cb(null,!1)}})})}),_export("getLazyLoadedPayPalUrl",getLazyLoadedPayPalUrl),{setters:[function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonCountryList){getByAbbreviation=_apiCommonCountryList.getByAbbreviation},function(_guiBaseDropDownSelector){DropDownSelector=_guiBaseDropDownSelector.DropDownSelector},function(_PaymentMethodInput){PaymentMethodInput=_PaymentMethodInput.PaymentMethodInput},function(_InvoiceAndPaymentDataPage){updatePaymentData=_InvoiceAndPaymentDataPage.updatePaymentData},function(_guiSize){px=_guiSize.px},function(_miscFormatter){formatNameAndAddress=_miscFormatter.formatNameAndAddress},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiCommonTutanotaConstants){getPaymentMethodType=_apiCommonTutanotaConstants.getPaymentMethodType,PaymentMethodType=_apiCommonTutanotaConstants.PaymentMethodType},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_apiMainEntity){serviceRequest=_apiMainEntity.serviceRequest},function(_apiEntitiesSysPaymentDataServiceGetReturn){PaymentDataServiceGetReturnTypeRef=_apiEntitiesSysPaymentDataServiceGetReturn.PaymentDataServiceGetReturnTypeRef},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull}],execute:function(){}}}),System.register("src/subscription/InvoiceAndPaymentDataPage.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/Dialog","../misc/LanguageViewModel","./InvoiceDataInput","./PaymentMethodInput","mithril/stream/stream.js","../api/common/TutanotaConstants","../api/main/WorkerClient","../gui/base/ProgressDialog","./PaymentDataDialog","../api/main/LoginController","../misc/ClientDetector","../api/entities/sys/AccountingInfo","../api/entities/sys/CustomerInfo","../api/common/utils/Utils","../api/main/Entity","../api/entities/sys/Customer","./SubscriptionUtils","../gui/base/ButtonN","../gui/base/SegmentControl"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,Dialog,lang,InvoiceDataInput,PaymentMethodInput,stream,PaymentDataResultType,worker,showProgressDialog,getLazyLoadedPayPalUrl,logins,client,AccountingInfoTypeRef,CustomerInfoTypeRef,neverNull,load,CustomerTypeRef,SubscriptionType,UpgradeType,ButtonN,ButtonType,SegmentControl,InvoiceAndPaymentDataPage;function updatePaymentData(subscriptionOptions,invoiceData,paymentData,confirmedCountry,isSignup){return worker.updatePaymentData(subscriptionOptions.businessUse(),subscriptionOptions.paymentInterval(),invoiceData,paymentData,confirmedCountry).then(function(paymentResult){var statusCode=paymentResult.result;if(statusCode===PaymentDataResultType.OK)return!0;if(statusCode===PaymentDataResultType.COUNTRY_MISMATCH){var countryName=invoiceData.country?invoiceData.country.n:"",confirmMessage=lang.get("confirmCountry_msg",{"{1}":countryName});return Dialog.confirm(function(){return confirmMessage}).then(function(confirmed){return!!confirmed&&updatePaymentData(subscriptionOptions,invoiceData,paymentData,invoiceData.country,isSignup)})}return statusCode===PaymentDataResultType.INVALID_VATID_NUMBER?Dialog.error(function(){return lang.get("invalidVatIdNumber_msg")+(isSignup?" "+lang.get("accountWasStillCreated_msg"):"")}):statusCode===PaymentDataResultType.CREDIT_CARD_DECLINED?Dialog.error(function(){return lang.get("creditCardNumberInvalid_msg")+(isSignup?" "+lang.get("accountWasStillCreated_msg"):"")}):statusCode===PaymentDataResultType.CREDIT_CARD_CVV_INVALID?Dialog.error("creditCardCVVInvalid_msg"):statusCode===PaymentDataResultType.PAYMENT_PROVIDER_NOT_AVAILABLE?Dialog.error(function(){return lang.get("paymentProviderNotAvailableError_msg")+(isSignup?" "+lang.get("accountWasStillCreated_msg"):"")}):statusCode===PaymentDataResultType.OTHER_PAYMENT_ACCOUNT_REJECTED?Dialog.error(function(){return lang.get("paymentAccountRejected_msg")+(isSignup?" "+lang.get("accountWasStillCreated_msg"):"")}):statusCode===PaymentDataResultType.CREDIT_CARD_DATE_INVALID?Dialog.error("creditCardExprationDateInvalid_msg"):statusCode===PaymentDataResultType.CREDIT_CARD_NUMBER_INVALID?Dialog.error(function(){return lang.get("creditCardNumberInvalid_msg")+(isSignup?" "+lang.get("accountWasStillCreated_msg"):"")}):statusCode===PaymentDataResultType.COULD_NOT_VERIFY_VATID?Dialog.error(function(){return lang.get("invalidVatIdValidationFailed_msg")+(isSignup?" "+lang.get("accountWasStillCreated_msg"):"")}):Dialog.error(function(){return lang.get("otherPaymentProviderError_msg")+(isSignup?" "+lang.get("accountWasStillCreated_msg"):"")}),!1})}return _export("updatePaymentData",updatePaymentData),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_InvoiceDataInput){InvoiceDataInput=_InvoiceDataInput.InvoiceDataInput},function(_PaymentMethodInput){PaymentMethodInput=_PaymentMethodInput.PaymentMethodInput},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiCommonTutanotaConstants){PaymentDataResultType=_apiCommonTutanotaConstants.PaymentDataResultType},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_PaymentDataDialog){getLazyLoadedPayPalUrl=_PaymentDataDialog.getLazyLoadedPayPalUrl},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_miscClientDetector){client=_miscClientDetector.client},function(_apiEntitiesSysAccountingInfo){AccountingInfoTypeRef=_apiEntitiesSysAccountingInfo.AccountingInfoTypeRef},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiMainEntity){load=_apiMainEntity.load},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_SubscriptionUtils){SubscriptionType=_SubscriptionUtils.SubscriptionType,UpgradeType=_SubscriptionUtils.UpgradeType},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseSegmentControl){SegmentControl=_guiBaseSegmentControl.SegmentControl}],execute:function(){_export("InvoiceAndPaymentDataPage",InvoiceAndPaymentDataPage=function(){function InvoiceAndPaymentDataPage(upgradeData){var _this=this;_classCallCheck(this,InvoiceAndPaymentDataPage),this._selectedPaymentMethod=stream(),this._upgradeData=upgradeData;var onNextClick=function(){var error=_this._invoiceDataInput.validateInvoiceData()||_this._paymentMethodInput.validatePaymentData();if(error)return Dialog.error(error).then(function(){return null});_this._upgradeData.invoiceData=_this._invoiceDataInput.getInvoiceData(),_this._upgradeData.paymentData=_this._paymentMethodInput.getPaymentData(),showProgressDialog("updatePaymentDataBusy_msg",updatePaymentData(_this._upgradeData.options,_this._upgradeData.invoiceData,_this._upgradeData.paymentData,null,_this._upgradeData.upgradeType===UpgradeType.Signup).then(function(success){success&&_this._pageActionHandler.showNext(_this._upgradeData)}))};this.view=function(){return m("#upgrade-account-dialog.pt",_this._availablePaymentMethods?[m(SegmentControl,{items:_this._availablePaymentMethods,selectedValue:_this._selectedPaymentMethod}),m(".flex-space-around.flex-wrap.pt",[m(".flex-grow-shrink-half.plr-l",{style:{minWidth:"260px"}},m(_this._invoiceDataInput)),m(".flex-grow-shrink-half.plr-l",{style:{minWidth:"260px"}},m(_this._paymentMethodInput))]),m(".flex-center.full-width.pt-l",m("",{style:{width:"260px"}},m(ButtonN,{label:"next_action",click:onNextClick,type:ButtonType.Login})))]:null)},this._selectedPaymentMethod.map(function(method){return _this._paymentMethodInput.updatePaymentMethod(method)})}return _createClass(InvoiceAndPaymentDataPage,[{key:"nextAction",value:function(){return Promise.resolve(null)}},{key:"headerTitle",value:function(){return lang.get("adminPayment_action")}},{key:"isNextAvailable",value:function(){return!1}},{key:"setPageActionHandler",value:function(handler){this._pageActionHandler=handler}},{key:"getUncheckedWizardData",value:function(){return this._invoiceDataInput&&this._paymentMethodInput&&(this._upgradeData.invoiceData=this._invoiceDataInput.getInvoiceData(),this._upgradeData.paymentData=this._paymentMethodInput.getPaymentData()),this._upgradeData}},{key:"updateWizardData",value:function(data){var _this2=this;this._upgradeData=data;var login=Promise.resolve();logins.isUserLoggedIn()||(login=worker.createSession(neverNull(data.newAccountData).mailAddress,neverNull(data.newAccountData).password,client.getIdentifier(),!1,!0)),login.then(function(){if(!data.accountingInfo)return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerInfoTypeRef,customer.customerInfo)}).then(function(customerInfo){return load(AccountingInfoTypeRef,customerInfo.accountingInfo).then(function(accountingInfo){data.accountingInfo=accountingInfo})})}).then(function(){_this2._invoiceDataInput=new InvoiceDataInput(data.options,data.invoiceData);var payPalRequestUrl=getLazyLoadedPayPalUrl();logins.isUserLoggedIn()&&payPalRequestUrl.getAsync(),_this2._paymentMethodInput=new PaymentMethodInput(data.options,_this2._invoiceDataInput.selectedCountry,neverNull(data.accountingInfo),payPalRequestUrl),_this2._availablePaymentMethods=_this2._paymentMethodInput.getVisiblePaymentMethods(),_this2._selectedPaymentMethod(data.paymentData.paymentMethod),_this2._paymentMethodInput.updatePaymentMethod(data.paymentData.paymentMethod,data.paymentData)})}},{key:"isEnabled",value:function(data){return data.type!==SubscriptionType.Free}}]),InvoiceAndPaymentDataPage}()),_export("InvoiceAndPaymentDataPage",InvoiceAndPaymentDataPage)}}}),System.register("src/misc/ClipboardUtils.js",["./ClientDetector"],function(_export,_context){"use strict";var client;return _export("copyToClipboard",function(text){return Promise.try(function(){return navigator.clipboard.writeText(text)}).catch(function(){return console.log("copy failed, trying fallback"),client.isIos()?function(text){var el=document.createElement("textarea");el.value=text,el.contentEditable="true",el.readOnly=!0,window.document.body.appendChild(el);var range=document.createRange();range.selectNodeContents(el);var s=window.getSelection();s.removeAllRanges(),s.addRange(range),el.setSelectionRange(0,999999),window.document.execCommand("copy"),window.document.body.removeChild(el)}(text):function(text){return new Promise(function(resolve,reject){var textArea=document.createElement("textarea");textArea.value=text,window.document.body.appendChild(textArea),textArea.focus(),textArea.select();try{document.execCommand("copy")}catch(err){reject("fallback copy failed")}window.document.body.removeChild(textArea),console.log("fallback copy successful"),resolve()})}(text)})}),{setters:[function(_ClientDetector){client=_ClientDetector.client}],execute:function(){}}}),System.register("src/settings/RecoverCodeDialog.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../misc/LanguageViewModel","mithril/stream/stream.js","../gui/base/ProgressDialog","../gui/base/Dialog","../api/common/utils/Utils","mithril","../api/main/WorkerClient","../api/Env","../gui/base/icons/Icons","../misc/ClipboardUtils","../gui/base/ButtonN","../api/common/error/RestError"],function(_export,_context){"use strict";var _classCallCheck,_createClass,lang,stream,showProgressDialog,Dialog,DialogType,neverNull,m,worker,assertMainOrNode,isApp,Icons,copyToClipboard,ButtonN,AccessBlockedError,NotAuthenticatedError,RecoverCodeField;function showRecoverCodeDialog(recoverCode,showMessage){return new Promise(function(resolve){Dialog.showActionDialog({title:lang.get("recoveryCode_label"),child:{view:function(){return m(RecoverCodeField,{showMessage:showMessage,recoverCode:recoverCode})}},allowCancel:!1,allowOkWithReturn:!0,okAction:function(dialog){dialog.close(),resolve()},type:DialogType.EditMedium})})}return _export("showRecoverCodeDialogAfterPasswordVerification",function(action){var showMessage=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],errorMessage=stream(lang.get("emptyString_msg"));Dialog.showRequestPasswordDialog(errorMessage).map(function(pw){return showProgressDialog("loading_msg","get"===action?worker.getRecoveryCode(pw):worker.createRecoveryCode(pw)).then(function(recoverCode){errorMessage(""),showRecoverCodeDialog(recoverCode,showMessage)}).catch(NotAuthenticatedError,function(){return errorMessage(lang.get("invalidPassword_msg"))}).catch(AccessBlockedError,function(){return errorMessage(lang.get("tooManyAttempts_msg"))})})}),_export("showRecoverCodeDialog",showRecoverCodeDialog),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_mithril){m=_mithril.default},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isApp=_apiEnv.isApp},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_miscClipboardUtils){copyToClipboard=_miscClipboardUtils.copyToClipboard},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN},function(_apiCommonErrorRestError){AccessBlockedError=_apiCommonErrorRestError.AccessBlockedError,NotAuthenticatedError=_apiCommonErrorRestError.NotAuthenticatedError}],execute:function(){assertMainOrNode(),_export("RecoverCodeField",RecoverCodeField=function(){function RecoverCodeField(){_classCallCheck(this,RecoverCodeField)}return _createClass(RecoverCodeField,[{key:"view",value:function(vnode){var lnk=lang.getInfoLink("recoverCode_link");return[vnode.attrs.showMessage?m(".pt.pb",[lang.get("recoveryCode_msg"),m("",[m("small",lang.get("moreInfo_msg")+" "),m("small.text-break",[m("a[href="+lnk+"][target=_blank]",lnk)])])]):m("",lang.get("emptyString_msg")),m(".text-break.monospace.selectable.flex.flex-wrap.border.pt.pb.plr",neverNull(vnode.attrs.recoverCode.match(/.{4}/g)).map(function(el,i){return m("span.pr-s.no-wrap",el)})),m(".flex.flex-end.mt-m",[m(ButtonN,{label:"copy_action",icon:function(){return Icons.Copy},click:function(){return copyToClipboard(vnode.attrs.recoverCode)}}),isApp()||"function"!=typeof window.print?null:m(ButtonN,{label:"print_action",icon:function(){return Icons.Print},click:function(){return window.print()}})])]}}]),RecoverCodeField}()),_export("RecoverCodeField",RecoverCodeField)}}}),System.register("src/subscription/UpgradeConfirmPage.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/Dialog","../misc/LanguageViewModel","../gui/base/TextField","../gui/base/Button","./PriceUtils","../gui/base/icons/Icons","../api/entities/sys/SwitchAccountTypeData","../api/common/TutanotaConstants","../api/entities/sys/Services","../api/main/Entity","../gui/base/ProgressDialog","../api/main/WorkerClient","../api/common/EntityFunctions","./UpgradeSubscriptionWizard","../api/common/error/RestError","../settings/RecoverCodeDialog","../api/main/LoginController","./SubscriptionUtils","../gui/base/ButtonN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,Dialog,lang,TextField,getPaymentMethodName,HabReminderImage,createSwitchAccountTypeData,AccountType,Const,PaidSubscriptionType,SysService,serviceRequestVoid,showProgressDialog,worker,HttpMethod,deleteCampaign,BadGatewayError,PreconditionFailedError,RecoverCodeField,logins,formatPrice,getPreconditionFailedPaymentMsg,SubscriptionType,UpgradeType,ButtonN,ButtonType,UpgradeConfirmPage;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_guiBaseButton){_guiBaseButton.Button},function(_PriceUtils){getPaymentMethodName=_PriceUtils.getPaymentMethodName},function(_guiBaseIconsIcons){HabReminderImage=_guiBaseIconsIcons.HabReminderImage},function(_apiEntitiesSysSwitchAccountTypeData){createSwitchAccountTypeData=_apiEntitiesSysSwitchAccountTypeData.createSwitchAccountTypeData},function(_apiCommonTutanotaConstants){AccountType=_apiCommonTutanotaConstants.AccountType,Const=_apiCommonTutanotaConstants.Const,PaidSubscriptionType=_apiCommonTutanotaConstants.PaidSubscriptionType},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiMainEntity){serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_UpgradeSubscriptionWizard){deleteCampaign=_UpgradeSubscriptionWizard.deleteCampaign},function(_apiCommonErrorRestError){BadGatewayError=_apiCommonErrorRestError.BadGatewayError,PreconditionFailedError=_apiCommonErrorRestError.PreconditionFailedError},function(_settingsRecoverCodeDialog){RecoverCodeField=_settingsRecoverCodeDialog.RecoverCodeField},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_SubscriptionUtils){formatPrice=_SubscriptionUtils.formatPrice,getPreconditionFailedPaymentMsg=_SubscriptionUtils.getPreconditionFailedPaymentMsg,SubscriptionType=_SubscriptionUtils.SubscriptionType,UpgradeType=_SubscriptionUtils.UpgradeType},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType}],execute:function(){_export("UpgradeConfirmPage",UpgradeConfirmPage=function(){function UpgradeConfirmPage(data){var _this=this;_classCallCheck(this,UpgradeConfirmPage),this._orderField=new TextField("subscription_label").setDisabled(),this._subscriptionField=new TextField("subscriptionPeriod_label").setDisabled(),this._priceField=new TextField(function(){return _this._upgradeData.priceNextYear?lang.get("priceFirstYear_label"):lang.get("price_label")}).setDisabled(),this._priceNextYearField=new TextField("priceForNextYear_label").setDisabled(),this._paymentMethodField=new TextField("paymentMethod_label").setDisabled(),this.updateWizardData(data);var upgrade=function(){var serviceData=createSwitchAccountTypeData();serviceData.accountType=AccountType.PREMIUM,serviceData.subscriptionType=_this._subscriptionTypeToPaidSubscriptionType(data.type),serviceData.date=Const.CURRENT_DATE,serviceData.campaign=_this._upgradeData.campaign,showProgressDialog("pleaseWait_msg",serviceRequestVoid(SysService.SwitchAccountTypeService,HttpMethod.POST,serviceData).then(function(){return worker.switchFreeToPremiumGroup()})).then(function(){return deleteCampaign(),_this.close()}).catch(PreconditionFailedError,function(e){Dialog.error(function(){return lang.get(getPreconditionFailedPaymentMsg(e))+(data.upgradeType===UpgradeType.Signup?" "+lang.get("accountWasStillCreated_msg"):"")})}).catch(BadGatewayError,function(e){Dialog.error(function(){return lang.get("paymentProviderNotAvailableError_msg")+(data.upgradeType===UpgradeType.Signup?" "+lang.get("accountWasStillCreated_msg"):"")})})};this.view=function(){var newAccountData=_this._upgradeData.newAccountData;return[newAccountData?m(".plr-l",[m(".center.h4.pt",lang.get("recoveryCode_label")),m(RecoverCodeField,{showMessage:!0,recoverCode:newAccountData.recoverCode})]):null,_this._upgradeData.type===SubscriptionType.Free?[m(".flex-space-around.flex-wrap",[m(".flex-grow-shrink-half.plr-l.flex-center.items-end",m("img[src="+HabReminderImage+"].pt.bg-white.border-radius",{style:{width:"200px"}}))]),m(".flex-center.full-width.pt-l",m("",{style:{width:"260px"}},m(ButtonN,{label:"ok_action",click:function(){return _this.close()},type:ButtonType.Login})))]:[m(".center.h4.pt",lang.get("upgradeConfirm_msg")),m(".flex-space-around.flex-wrap",[m(".flex-grow-shrink-half.plr-l",[m(_this._orderField),m(_this._subscriptionField),m(_this._priceField),_this._upgradeData.priceNextYear?m(_this._priceNextYearField):null,m(_this._paymentMethodField)]),m(".flex-grow-shrink-half.plr-l.flex-center.items-end",m("img[src="+HabReminderImage+"].pt.bg-white.border-radius",{style:{width:"200px"}}))]),m(".flex-center.full-width.pt-l",m("",{style:{width:"260px"}},m(ButtonN,{label:"buy_action",click:upgrade,type:ButtonType.Login})))]]}}return _createClass(UpgradeConfirmPage,[{key:"_subscriptionTypeToPaidSubscriptionType",value:function(subscriptionType){if(subscriptionType===SubscriptionType.Premium)return PaidSubscriptionType.Premium;if(subscriptionType===SubscriptionType.Teams)return PaidSubscriptionType.Teams;if(subscriptionType===SubscriptionType.Pro)return PaidSubscriptionType.Pro;throw new Error("not a valid Premium subscription type: "+subscriptionType)}},{key:"close",value:function(){var _this2=this,promise=Promise.resolve();this._upgradeData.newAccountData&&logins.isUserLoggedIn()&&(promise=logins.logout(!1)),promise.then(function(){_this2._pageActionHandler.showNext(_this2._upgradeData)})}},{key:"headerTitle",value:function(){return lang.get("summary_label")}},{key:"nextAction",value:function(){return Promise.resolve(null)}},{key:"isNextAvailable",value:function(){return!1}},{key:"setPageActionHandler",value:function(handler){this._pageActionHandler=handler}},{key:"updateWizardData",value:function(wizardData){this._upgradeData=wizardData,this._orderField.setValue(this._upgradeData.type),this._subscriptionField.setValue((12===this._upgradeData.options.paymentInterval()?lang.get("pricing.yearly_label"):lang.get("pricing.monthly_label"))+", "+lang.get("automaticRenewal_label"));var netOrGross=this._upgradeData.options.businessUse()?lang.get("net_label"):lang.get("gross_label");this._priceField.setValue(formatPrice(Number(this._upgradeData.price),!0)+" "+(12===this._upgradeData.options.paymentInterval()?lang.get("pricing.perYear_label"):lang.get("pricing.perMonth_label"))+" ("+netOrGross+")"),this._upgradeData.priceNextYear&&this._priceNextYearField.setValue(formatPrice(Number(this._upgradeData.priceNextYear),!0)+" "+(12===this._upgradeData.options.paymentInterval()?lang.get("pricing.perYear_label"):lang.get("pricing.perMonth_label"))+" ("+netOrGross+")"),this._paymentMethodField.setValue(getPaymentMethodName(this._upgradeData.paymentData.paymentMethod))}},{key:"getUncheckedWizardData",value:function(){return this._upgradeData}},{key:"isEnabled",value:function(data){return!0}}]),UpgradeConfirmPage}()),_export("UpgradeConfirmPage",UpgradeConfirmPage)}}}),System.register("src/subscription/BuyOptionBox.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/size","../misc/LanguageViewModel","./SubscriptionUtils","../api/common/utils/Utils","../gui/base/icons/Icons","../gui/base/Icon","../gui/base/SegmentControl"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,px,lang,PaymentIntervalItems,neverNull,Icons,Icon,SegmentControl,_BuyOptionBox,BuyOptionBox;return _export("getActiveSubscriptionActionButtonReplacement",function(){return{view:function(){return m(".buyOptionBox.content-accent-fg.center-vertically.text-center",{style:{"border-radius":"3px"}},lang.get("pricing.currentPlan_label"))}}}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiSize){px=_guiSize.px},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_SubscriptionUtils){PaymentIntervalItems=_SubscriptionUtils.PaymentIntervalItems},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon},function(_guiBaseSegmentControl){SegmentControl=_guiBaseSegmentControl.SegmentControl}],execute:function(){_BuyOptionBox=function(){function _BuyOptionBox(){_classCallCheck(this,_BuyOptionBox)}return _createClass(_BuyOptionBox,[{key:"view",value:function(vnode){return m("",{style:{margin:"10px",width:px(vnode.attrs.width),padding:"10px"}},[m(".buyOptionBox"+(vnode.attrs.highlighted?".highlighted":""),{style:{height:px(vnode.attrs.height),"border-radius":"3px"}},[vnode.attrs.showReferenceDiscount&&vnode.attrs.price!==vnode.attrs.originalPrice?m(".ribbon-vertical",m(".text-center.b.h4",{style:{"padding-top":px(22)}},"%")):null,m(".h4.text-center.dialog-header.dialog-header-line-height",vnode.attrs.heading),m(".text-center.pt.flex.center-vertically.center-horizontally",[m("span.h1",vnode.attrs.price),vnode.attrs.showReferenceDiscount&&vnode.attrs.price!==vnode.attrs.originalPrice?[m("span",{style:{opacity:"0",width:"0",height:"0"}},"Original price: "),m("s.pl","("+vnode.attrs.originalPrice+")")]:null]),m(".small.text-center.pb-s",lang.getMaybeLazy(vnode.attrs.helpLabel)),vnode.attrs.paymentInterval?m(SegmentControl,{selectedValue:vnode.attrs.paymentInterval,items:PaymentIntervalItems}):null,vnode.attrs.actionButton?m(".button-min-height",{style:{position:"absolute",bottom:px(10),left:px(10),right:px(10)}},m(neverNull(vnode.attrs.actionButton))):null]),m("div.mt-m.pl",vnode.attrs.features().map(function(f){return m(".flex",[m(Icon,{icon:Icons.Checkmark,style:{"padding-top":"5px"}}),m(".align-self-center.pt-xs.pb-xs.pl-xs"+(window.innerWidth>809?".text-ellipsis":""),{title:window.innerWidth>809?f:""},f)])}))])}}]),_BuyOptionBox}(),_export("BuyOptionBox",BuyOptionBox=_BuyOptionBox),_export("BuyOptionBox",BuyOptionBox)}}}),System.register("src/gui/base/SegmentControl.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../size"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,px,SegmentControl;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_size){px=_size.px}],execute:function(){_export("SegmentControl",SegmentControl=function(){function SegmentControl(){_classCallCheck(this,SegmentControl)}return _createClass(SegmentControl,[{key:"view",value:function(vnode){var _this=this;return[m(".segmentControl.flex.center-horizontally.button-height",{role:"tablist"},vnode.attrs.items.map(function(item){return m("button.segmentControlItem.flex.center-horizontally.center-vertically.text-ellipsis.small"+(item.value===vnode.attrs.selectedValue()?".segmentControl-border-active.content-accent-fg":".segmentControl-border"),{style:{flex:"0 1 "+(void 0!==vnode.attrs.itemMaxWidth?px(vnode.attrs.itemMaxWidth):px(120))},title:item.name,role:"tab","aria-selected":String(item.value===vnode.attrs.selectedValue()),onclick:function(){return _this._onSelected(item,vnode.attrs)}},item.name)}))]}},{key:"_onSelected",value:function(item,attrs){item.value!==attrs.selectedValue()&&attrs.selectedValue(item.value)}}]),SegmentControl}()),_export("SegmentControl",SegmentControl)}}}),System.register("src/subscription/SubscriptionSelector.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../misc/LanguageViewModel","./BuyOptionBox","./SubscriptionUtils","../gui/size","../gui/base/SegmentControl"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,lang,BuyOptionBox,getActiveSubscriptionActionButtonReplacement,BusinessUseItems,formatPrice,getFormattetUpgradePrice,SubscriptionType,UpgradePriceType,size,SegmentControl,_SubscriptionSelector,SubscriptionSelector;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_BuyOptionBox){BuyOptionBox=_BuyOptionBox.BuyOptionBox,getActiveSubscriptionActionButtonReplacement=_BuyOptionBox.getActiveSubscriptionActionButtonReplacement},function(_SubscriptionUtils){BusinessUseItems=_SubscriptionUtils.BusinessUseItems,formatPrice=_SubscriptionUtils.formatPrice,getFormattetUpgradePrice=_SubscriptionUtils.getFormattetUpgradePrice,SubscriptionType=_SubscriptionUtils.SubscriptionType,UpgradePriceType=_SubscriptionUtils.UpgradePriceType},function(_guiSize){size=_guiSize.size},function(_guiBaseSegmentControl){SegmentControl=_guiBaseSegmentControl.SegmentControl}],execute:function(){_SubscriptionSelector=function(){function _SubscriptionSelector(){_classCallCheck(this,_SubscriptionSelector)}return _createClass(_SubscriptionSelector,[{key:"view",value:function(vnode){var buyBoxesViewPlacement=void 0;return buyBoxesViewPlacement=vnode.attrs.options.businessUse()?[m(BuyOptionBox,this._createPremiumUpgradeBoxAttr(vnode.attrs)),m(BuyOptionBox,this._createTeamsUpgradeBoxAttr(vnode.attrs)),m(BuyOptionBox,this._createProUpgradeBoxAttr(vnode.attrs))]:window.innerWidth<size.desktop_layout_width+90?[m(BuyOptionBox,this._createPremiumUpgradeBoxAttr(vnode.attrs)),m(BuyOptionBox,this._createTeamsUpgradeBoxAttr(vnode.attrs)),m(BuyOptionBox,this._createFreeUpgradeBoxAttr(vnode.attrs))]:[m(BuyOptionBox,this._createFreeUpgradeBoxAttr(vnode.attrs)),m(BuyOptionBox,this._createPremiumUpgradeBoxAttr(vnode.attrs)),m(BuyOptionBox,this._createTeamsUpgradeBoxAttr(vnode.attrs))],[vnode.attrs.isInitialUpgrade?m(SegmentControl,{selectedValue:vnode.attrs.options.businessUse,items:BusinessUseItems}):null,vnode.attrs.campaignInfoTextId&&lang.exists(vnode.attrs.campaignInfoTextId)?m(".b.center.mt",lang.get(vnode.attrs.campaignInfoTextId)):null,m(".flex.center-horizontally.wrap",buyBoxesViewPlacement)]}},{key:"_createFreeUpgradeBoxAttr",value:function(selectorAttrs){return{heading:"Free",actionButton:selectorAttrs.currentlyActive===SubscriptionType.Free?getActiveSubscriptionActionButtonReplacement():selectorAttrs.freeActionButton,price:formatPrice(0,!0),originalPrice:formatPrice(0,!0),helpLabel:"pricing.upgradeLater_msg",features:function(){return[lang.get("pricing.comparisonUsersFree_msg"),lang.get("pricing.comparisonStorage_msg",{"{amount}":1}),lang.get("pricing.comparisonDomainFree_msg"),lang.get("pricing.comparisonSearchFree_msg"),lang.get("pricing.comparisonOneCalendar_msg")]},width:selectorAttrs.boxWidth,height:selectorAttrs.boxHeight,paymentInterval:null,showReferenceDiscount:selectorAttrs.isInitialUpgrade}}},{key:"_createPremiumUpgradeBoxAttr",value:function(selectorAttrs){var sharingFeatureArray=selectorAttrs.currentlyActive===SubscriptionType.Premium&&selectorAttrs.currentlySharingOrdered?[lang.get("pricing.comparisonSharingCalendar_msg")]:[],whitelabelFeatureArray=selectorAttrs.currentlyActive===SubscriptionType.Premium&&selectorAttrs.currentlyWhitelabelOrdered?[lang.get("pricing.comparisonLoginPro_msg"),lang.get("pricing.comparisonThemePro_msg"),lang.get("pricing.comparisonContactFormPro_msg",{"{price}":getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Pro,UpgradePriceType.ContactFormPrice)})]:[];return{heading:"Premium",actionButton:selectorAttrs.currentlyActive===SubscriptionType.Premium?getActiveSubscriptionActionButtonReplacement():selectorAttrs.premiumActionButton,price:getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Premium,UpgradePriceType.PlanActualPrice),originalPrice:getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Premium,UpgradePriceType.PlanReferencePrice),helpLabel:selectorAttrs.options.businessUse()?"pricing.basePriceExcludesTaxes_msg":"pricing.basePriceIncludesTaxes_msg",features:function(){return[lang.get("pricing.comparisonAddUser_msg",{"{1}":getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Premium,UpgradePriceType.AdditionalUserPrice)}),lang.get("pricing.comparisonStorage_msg",{"{amount}":selectorAttrs.premiumPrices.includedStorage}),lang.get("pricing.comparisonDomainPremium_msg"),lang.get("pricing.comparisonSearchPremium_msg"),lang.get("pricing.comparisonMultipleCalendars_msg"),lang.get("pricing.mailAddressAliasesShort_label",{"{amount}":selectorAttrs.premiumPrices.includedAliases}),lang.get("pricing.comparisonInboxRulesPremium_msg"),lang.get("pricing.comparisonSupportPremium_msg")].concat(sharingFeatureArray).concat(whitelabelFeatureArray)},width:selectorAttrs.boxWidth,height:selectorAttrs.boxHeight,paymentInterval:selectorAttrs.isInitialUpgrade?selectorAttrs.options.paymentInterval:null,highlighted:!selectorAttrs.options.businessUse()&&selectorAttrs.highlightPremium,showReferenceDiscount:selectorAttrs.isInitialUpgrade}}},{key:"_createTeamsUpgradeBoxAttr",value:function(selectorAttrs){var whitelabelFeatureArray=selectorAttrs.currentlyActive!==SubscriptionType.Premium&&selectorAttrs.currentlyActive!==SubscriptionType.Teams||!selectorAttrs.currentlyWhitelabelOrdered?[]:[lang.get("pricing.comparisonLoginPro_msg"),lang.get("pricing.comparisonThemePro_msg"),lang.get("pricing.comparisonContactFormPro_msg",{"{price}":getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Pro,UpgradePriceType.ContactFormPrice)})];return{heading:"Teams",actionButton:selectorAttrs.currentlyActive===SubscriptionType.Teams?getActiveSubscriptionActionButtonReplacement():selectorAttrs.teamsActionButton,price:getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Teams,UpgradePriceType.PlanActualPrice),originalPrice:getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Teams,UpgradePriceType.PlanReferencePrice),helpLabel:selectorAttrs.options.businessUse()?"pricing.basePriceExcludesTaxes_msg":"pricing.basePriceIncludesTaxes_msg",features:function(){return[lang.get("pricing.comparisonAddUser_msg",{"{1}":getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Teams,UpgradePriceType.AdditionalUserPrice)}),lang.get("pricing.comparisonStorage_msg",{"{amount}":selectorAttrs.teamsPrices.includedStorage}),lang.get("pricing.comparisonDomainPremium_msg"),lang.get("pricing.comparisonSearchPremium_msg"),lang.get("pricing.comparisonMultipleCalendars_msg"),lang.get("pricing.mailAddressAliasesShort_label",{"{amount}":selectorAttrs.teamsPrices.includedAliases}),lang.get("pricing.comparisonInboxRulesPremium_msg"),lang.get("pricing.comparisonSupportPremium_msg"),lang.get("pricing.comparisonSharingCalendar_msg")].concat(whitelabelFeatureArray)},width:selectorAttrs.boxWidth,height:selectorAttrs.boxHeight,paymentInterval:selectorAttrs.isInitialUpgrade?selectorAttrs.options.paymentInterval:null,showReferenceDiscount:selectorAttrs.isInitialUpgrade}}},{key:"_createProUpgradeBoxAttr",value:function(selectorAttrs){return{heading:"Pro",actionButton:selectorAttrs.currentlyActive===SubscriptionType.Pro?getActiveSubscriptionActionButtonReplacement():selectorAttrs.proActionButton,price:getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Pro,UpgradePriceType.PlanActualPrice),originalPrice:getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Pro,UpgradePriceType.PlanReferencePrice),helpLabel:selectorAttrs.options.businessUse()?"pricing.basePriceExcludesTaxes_msg":"pricing.basePriceIncludesTaxes_msg",features:function(){return[lang.get("pricing.comparisonAddUser_msg",{"{1}":getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Pro,UpgradePriceType.AdditionalUserPrice)}),lang.get("pricing.comparisonStorage_msg",{"{amount}":selectorAttrs.proPrices.includedStorage}),lang.get("pricing.comparisonDomainPremium_msg"),lang.get("pricing.comparisonSearchPremium_msg"),lang.get("pricing.comparisonMultipleCalendars_msg"),lang.get("pricing.mailAddressAliasesShort_label",{"{amount}":selectorAttrs.proPrices.includedAliases}),lang.get("pricing.comparisonInboxRulesPremium_msg"),lang.get("pricing.comparisonSupportPro_msg"),lang.get("pricing.comparisonSharingCalendar_msg"),lang.get("pricing.comparisonLoginPro_msg"),lang.get("pricing.comparisonThemePro_msg"),lang.get("pricing.comparisonContactFormPro_msg",{"{price}":getFormattetUpgradePrice(selectorAttrs,SubscriptionType.Pro,UpgradePriceType.ContactFormPrice)})]},width:selectorAttrs.boxWidth,height:selectorAttrs.boxHeight,paymentInterval:selectorAttrs.isInitialUpgrade?selectorAttrs.options.paymentInterval:null,showReferenceDiscount:selectorAttrs.isInitialUpgrade}}}]),_SubscriptionSelector}(),_export("SubscriptionSelector",SubscriptionSelector=_SubscriptionSelector),_export("SubscriptionSelector",SubscriptionSelector)}}}),System.register("src/subscription/UpgradeSubscriptionPage.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../misc/LanguageViewModel","./SubscriptionSelector","../api/Env","../misc/ClientDetector","../gui/base/ButtonN","./SubscriptionUtils","../gui/base/Dialog"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,lang,SubscriptionSelector,isApp,isTutanotaDomain,client,ButtonN,ButtonType,getUpgradePrice,SubscriptionType,UpgradePriceType,UpgradeType,Dialog,UpgradeSubscriptionPage;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_SubscriptionSelector){SubscriptionSelector=_SubscriptionSelector.SubscriptionSelector},function(_apiEnv){isApp=_apiEnv.isApp,isTutanotaDomain=_apiEnv.isTutanotaDomain},function(_miscClientDetector){client=_miscClientDetector.client},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_SubscriptionUtils){getUpgradePrice=_SubscriptionUtils.getUpgradePrice,SubscriptionType=_SubscriptionUtils.SubscriptionType,UpgradePriceType=_SubscriptionUtils.UpgradePriceType,UpgradeType=_SubscriptionUtils.UpgradeType},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog}],execute:function(){_export("UpgradeSubscriptionPage",UpgradeSubscriptionPage=function(){function UpgradeSubscriptionPage(upgradeData,currentSubscription){var _this=this;_classCallCheck(this,UpgradeSubscriptionPage),this._upgradeData=upgradeData,this.view=function(){return m("#upgrade-account-dialog.pt",[m(SubscriptionSelector,{options:_this._upgradeData.options,campaignInfoTextId:upgradeData.campaignInfoTextId,boxWidth:230,boxHeight:250,highlightPremium:!0,premiumPrices:upgradeData.premiumPrices,teamsPrices:upgradeData.teamsPrices,proPrices:upgradeData.proPrices,isInitialUpgrade:upgradeData.upgradeType!==UpgradeType.Switch,currentlyActive:currentSubscription,currentlySharingOrdered:!1,currentlyWhitelabelOrdered:!1,freeActionButton:{view:function(){return m(ButtonN,{label:"pricing.select_action",click:function(){Dialog.confirm("signupOneFreeAccountConfirm_msg").then(function(confirmed){confirmed&&(_this._upgradeData.type=SubscriptionType.Free,_this._upgradeData.price="0",_this._upgradeData.priceNextYear="0",_this._pageActionHandler.showNext(_this._upgradeData))})},type:ButtonType.Login})}},premiumActionButton:{view:function(){return m(ButtonN,{label:"pricing.select_action",click:function(){_this._upgradeData.type=SubscriptionType.Premium,_this._upgradeData.price=String(getUpgradePrice(upgradeData,SubscriptionType.Premium,UpgradePriceType.PlanActualPrice));var nextYear=String(getUpgradePrice(upgradeData,SubscriptionType.Premium,UpgradePriceType.PlanNextYearsPrice));_this._upgradeData.priceNextYear=_this._upgradeData.price!==nextYear?nextYear:null,_this._pageActionHandler.showNext(_this._upgradeData)},type:ButtonType.Login})}},teamsActionButton:{view:function(){return m(ButtonN,{label:"pricing.select_action",click:function(){_this._upgradeData.type=SubscriptionType.Teams,_this._upgradeData.price=String(getUpgradePrice(upgradeData,SubscriptionType.Teams,UpgradePriceType.PlanActualPrice));var nextYear=String(getUpgradePrice(upgradeData,SubscriptionType.Teams,UpgradePriceType.PlanNextYearsPrice));_this._upgradeData.priceNextYear=_this._upgradeData.price!==nextYear?nextYear:null,_this._pageActionHandler.showNext(_this._upgradeData)},type:ButtonType.Login})}},proActionButton:{view:function(){return m(ButtonN,{label:"pricing.select_action",click:function(){_this._upgradeData.type=SubscriptionType.Pro,_this._upgradeData.price=String(getUpgradePrice(upgradeData,SubscriptionType.Pro,UpgradePriceType.PlanActualPrice));var nextYear=String(getUpgradePrice(upgradeData,SubscriptionType.Pro,UpgradePriceType.PlanNextYearsPrice));_this._upgradeData.priceNextYear=_this._upgradeData.price!==nextYear?nextYear:null,_this._pageActionHandler.showNext(_this._upgradeData)},type:ButtonType.Login})}}})])}}return _createClass(UpgradeSubscriptionPage,[{key:"headerTitle",value:function(){return lang.get("subscription_label")}},{key:"nextAction",value:function(){return Promise.resolve(null)}},{key:"isNextAvailable",value:function(){return!1}},{key:"setPageActionHandler",value:function(handler){this._pageActionHandler=handler}},{key:"updateWizardData",value:function(wizardData){this._upgradeData=wizardData}},{key:"getUncheckedWizardData",value:function(){return this._upgradeData}},{key:"isEnabled",value:function(data){return isTutanotaDomain()&&!(isApp()&&client.isIos())}}]),UpgradeSubscriptionPage}()),_export("UpgradeSubscriptionPage",UpgradeSubscriptionPage)}}}),System.register("src/settings/SelectMailAddressForm.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","../misc/LanguageViewModel","../api/Env","../api/common/RecipientInfo","../misc/FormatValidator","../api/main/WorkerClient","../gui/base/icons/Icons","../gui/base/TextFieldN","../gui/base/ButtonN","../gui/base/DropdownN","../api/common/error/RestError","../api/common/utils/Utils.js"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,lang,assertMainOrNode,isTutanotaMailAddress,isMailAddress,worker,Icons,TextFieldN,ButtonN,ButtonType,attachDropdown,AccessDeactivatedError,neverNull,SelectMailAddressForm;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiCommonRecipientInfo){isTutanotaMailAddress=_apiCommonRecipientInfo.isTutanotaMailAddress},function(_miscFormatValidator){isMailAddress=_miscFormatValidator.isMailAddress},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseDropdownN){attachDropdown=_guiBaseDropdownN.attachDropdown},function(_apiCommonErrorRestError){AccessDeactivatedError=_apiCommonErrorRestError.AccessDeactivatedError},function(_apiCommonUtilsUtilsJs){neverNull=_apiCommonUtilsUtilsJs.neverNull}],execute:function(){assertMainOrNode(),"mailAddressAvailable_msg",_export("SelectMailAddressForm",SelectMailAddressForm=function(){function SelectMailAddressForm(availableDomains){var _this=this;_classCallCheck(this,SelectMailAddressForm),this._messageId=stream("mailAddressNeutral_msg"),this._availableDomains=availableDomains,this._checkAddressTimeout=null,this.domain=stream(availableDomains[0]),this._username=stream(""),this.cleanMailAddress=stream.merge([this._username,this.domain]).map(function(vals){return(vals[0]+"@"+vals[1]).trim().toLowerCase()}),this.cleanMailAddress.map(function(){return _this._verifyMailAddress()}),stream.merge([this._messageId,this.cleanMailAddress]).map(m.redraw)}return _createClass(SelectMailAddressForm,[{key:"view",value:function(){var _this2=this,domainChooserAttrs=attachDropdown({label:"domain_label",icon:function(){return Icons.More},noBubble:!0},function(){return _this2._availableDomains.map(function(domain){return{label:function(){return domain},click:function(){return _this2.domain(domain)},type:ButtonType.Dropdown}})},function(){return!0},250),userNameAttrs={label:"mailAddress_label",value:this._username,alignRight:!0,helpLabel:function(){return lang.get(_this2._messageId())},injectionsRight:function(){return[m(".flex.items-end.mr-s",{style:{"padding-bottom":"1px",flex:"1 1 auto"}},"@"+_this2.domain()),m(ButtonN,domainChooserAttrs)]}};return m(TextFieldN,userNameAttrs)}},{key:"_verifyMailAddress",value:function(){var _this3=this;clearTimeout(neverNull(this._checkAddressTimeout));var cleanMailAddress=this.cleanMailAddress(),cleanUsername=this._username().trim().toLowerCase();""!==cleanUsername?!isMailAddress(cleanMailAddress,!0)||isTutanotaMailAddress(cleanMailAddress)&&cleanUsername.length<3?this._messageId("mailAddressInvalid_msg"):(this._messageId("mailAddressBusy_msg"),this._checkAddressTimeout=setTimeout(function(){_this3.cleanMailAddress()===cleanMailAddress&&worker.initialized.then(function(){return worker.isMailAddressAvailable(cleanMailAddress)}).then(function(available){_this3.cleanMailAddress()===cleanMailAddress&&_this3._messageId(available?"mailAddressAvailable_msg":"mailAddressNA_msg")}).catch(AccessDeactivatedError,function(){return _this3._messageId("mailAddressDelay_msg")})},500)):this._messageId("mailAddressNeutral_msg")}},{key:"getCleanMailAddress",value:function(){return this.cleanMailAddress()}},{key:"getErrorMessageId",value:function(){return"mailAddressAvailable_msg"===this._messageId()?null:this._messageId()}}]),SelectMailAddressForm}()),_export("SelectMailAddressForm",SelectMailAddressForm)}}}),System.register("src/gui/base/Checkbox.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","../../misc/LanguageViewModel","./Flash","../../api/Env","./Icon","./icons/BootIcons"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,lang,addFlash,removeFlash,assertMainOrNodeBoot,Icon,BootIcons,Checkbox;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_Flash){addFlash=_Flash.addFlash,removeFlash=_Flash.removeFlash},function(_apiEnv){assertMainOrNodeBoot=_apiEnv.assertMainOrNodeBoot},function(_Icon){Icon=_Icon.Icon},function(_iconsBootIcons){BootIcons=_iconsBootIcons.BootIcons}],execute:function(){assertMainOrNodeBoot(),_export("Checkbox",Checkbox=function(){function Checkbox(lazyChildren,helpLabel){var _this=this;_classCallCheck(this,Checkbox),this.getChildren=lazyChildren,this.helpLabel=helpLabel,this.checked=stream(!1),this.focused=stream(!1),this.enabled=!0,this._disabledTextId="emptyString_msg",this.view=function(){return m(".checkbox.pt"+(_this.enabled?".click":".click-disabled"),{onclick:function(e){e.target!==_this._domInput&&_this.toggle(e)}},[m(".wrapper.flex.items-center",{oncreate:function(vnode){return _this.enabled?addFlash(vnode.dom):null},onbeforeremove:function(vnode){return removeFlash(vnode.dom)}},[m("input[type=checkbox]",{oncreate:function(vnode){return _this._domInput=vnode.dom},onchange:function(e){return _this.toggle(e)},checked:_this.checked(),onfocus:function(){return _this.focused(!0)},onblur:function(){return _this.focused(!1)},onremove:function(e){_this._domInput.onblur=null},disabled:!_this.enabled,style:{opacity:0,position:"absolute",cursor:"pointer",z_index:-1}}),m(Icon,{icon:_this.checked()?BootIcons.CheckboxSelected:BootIcons.Checkbox,class:_this.focused()?"svg-content-accent-fg":"svg-content-fg",onclick:function(e){return _this.toggle(e)}}),m(".pl",{class:_this.focused()?"content-accent-fg":"content-fg"},_this.getChildren())]),_this.helpLabel?m("small.block.content-fg",_this.enabled?_this.helpLabel():lang.get(_this._disabledTextId)):[]])}}return _createClass(Checkbox,[{key:"toggle",value:function(event){this.enabled&&(this.checked(!this.checked()),this._domInput&&this._domInput.focus()),event.stopPropagation()}},{key:"setDisabled",value:function(disabledTextId){this.enabled=!1,this._disabledTextId=disabledTextId}}]),Checkbox}()),_export("Checkbox",Checkbox)}}}),System.register("src/gui/base/Expander.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../../misc/LanguageViewModel","../../../src/gui/animation/Animations","./Icon","./icons/Icons","./icons/BootIcons","../theme","./Flash","../size"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,lang,animations,height,opacity,transform,Icon,Icons,BootIcons,theme,addFlash,removeFlash,px,ExpanderButton,ExpanderPanel;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_srcGuiAnimationAnimations){animations=_srcGuiAnimationAnimations.animations,height=_srcGuiAnimationAnimations.height,opacity=_srcGuiAnimationAnimations.opacity,transform=_srcGuiAnimationAnimations.transform},function(_Icon){Icon=_Icon.Icon},function(_iconsIcons){Icons=_iconsIcons.Icons},function(_iconsBootIcons){BootIcons=_iconsBootIcons.BootIcons},function(_theme){theme=_theme.theme},function(_Flash){addFlash=_Flash.addFlash,removeFlash=_Flash.removeFlash},function(_size){px=_size.px}],execute:function(){_export("ExpanderButton",ExpanderButton=function(){function ExpanderButton(labelTextIdOrLabelFunction,panel,showWarning){var _this=this,style=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},color=arguments.length>4&&void 0!==arguments[4]?arguments[4]:function(){return theme.content_button};_classCallCheck(this,ExpanderButton),this.panel=panel,this.getLabel="function"==typeof labelTextIdOrLabelFunction?labelTextIdOrLabelFunction:lang.get.bind(lang,labelTextIdOrLabelFunction),this._showWarning=showWarning,this.view=function(){return style.color=color(),m(".flex.limit-width",[m("button.expander.bg-transparent.pt-s.hover-ul.limit-width",{style:style,onclick:function(event){_this.toggle(),event.stopPropagation()},oncreate:function(vnode){return addFlash(vnode.dom)},onbeforeremove:function(vnode){return removeFlash(vnode.dom)},"aria-expanded":String(!!_this.panel.expanded)},m(".flex.items-center",[_this._showWarning?m(Icon,{icon:Icons.Warning,style:{fill:color()}}):null,m("small.b.text-ellipsis",_this.getLabel().toUpperCase()),m(Icon,{icon:BootIcons.Expand,class:"flex-center items-center",style:{fill:color(),"margin-right":px(-4)},oncreate:function(vnode){_this._domIcon=vnode.dom,_this.panel.expanded&&(_this._domIcon.style.transform="rotateZ(180deg)")}})]))])}}return _createClass(ExpanderButton,[{key:"toggle",value:function(){if(this._domIcon){var start=this.panel.expanded?180:0;animations.add(this._domIcon,transform("rotateZ",start,start+180))}this.panel.setExpanded(!this.panel.expanded)}},{key:"setShowWarning",value:function(showWarning){this._showWarning=showWarning}}]),ExpanderButton}()),_export("ExpanderButton",ExpanderButton),_export("ExpanderPanel",ExpanderPanel=function(){function ExpanderPanel(child){var _this2=this;_classCallCheck(this,ExpanderPanel),this.child=child,this.expanded=!1,this.view=function(){return m(".expander-panel.overflow-hidden.no-shrink",[_this2.expanded?m("div",{oncreate:function(vnode){_this2._domPanel=vnode.dom,vnode.dom.style.height=0,_this2._animate(!0)},onbeforeremove:function(vnode){return _this2._animate(!1)}},m(_this2.child)):null])}}return _createClass(ExpanderPanel,[{key:"_animate",value:function(fadeIn){var _this3=this;animations.add(this._domPanel,fadeIn?opacity(0,1,!0):opacity(1,0,!0));var childHeight=Array.from(this._domPanel.children).map(function(domElement){return domElement.offsetHeight}).reduce(function(current,previous){return current+previous},0);return animations.add(this._domPanel,height(fadeIn?0:childHeight,fadeIn?childHeight:0)).then(function(){fadeIn&&(_this3._domPanel.style.height="")})}},{key:"setExpanded",value:function(expanded){this.expanded=expanded;var c=this.child;return c.setExpanded&&c.setExpanded(expanded),this}}]),ExpanderPanel}()),_export("ExpanderPanel",ExpanderPanel)}}}),System.registerDynamic("src/misc/u2f-api.js",[],!0,function($__require,exports,module){"use strict";this||self;var js_api_version,u2f=u2f||{};u2f.EXTENSION_ID="kmendfapggjehodndflmmgagdbamhnfd",u2f.MessageTypes={U2F_REGISTER_REQUEST:"u2f_register_request",U2F_REGISTER_RESPONSE:"u2f_register_response",U2F_SIGN_REQUEST:"u2f_sign_request",U2F_SIGN_RESPONSE:"u2f_sign_response",U2F_GET_API_VERSION_REQUEST:"u2f_get_api_version_request",U2F_GET_API_VERSION_RESPONSE:"u2f_get_api_version_response"},u2f.ErrorCodes={OK:0,OTHER_ERROR:1,BAD_REQUEST:2,CONFIGURATION_UNSUPPORTED:3,DEVICE_INELIGIBLE:4,TIMEOUT:5},u2f.U2fRequest,u2f.U2fResponse,u2f.Error,u2f.Transport,u2f.Transports,u2f.SignRequest,u2f.SignResponse,u2f.RegisterRequest,u2f.RegisterResponse,u2f.RegisteredKey,u2f.GetJsApiVersionResponse,u2f.getMessagePort=function(callback){if("undefined"!=typeof chrome&&chrome.runtime){var msg={type:u2f.MessageTypes.U2F_SIGN_REQUEST,signRequests:[]};chrome.runtime.sendMessage(u2f.EXTENSION_ID,msg,function(){chrome.runtime.lastError?u2f.getIframePort_(callback):u2f.getChromeRuntimePort_(callback)})}else u2f.isAndroidChrome_()?u2f.getAuthenticatorPort_(callback):u2f.isIosChrome_()?u2f.getIosPort_(callback):u2f.getIframePort_(callback)},u2f.isAndroidChrome_=function(){var userAgent=navigator.userAgent;return-1!==userAgent.indexOf("Chrome")&&-1!==userAgent.indexOf("Android")},u2f.isIosChrome_=function(){return["iPhone","iPad","iPod"].indexOf(navigator.platform)>-1},u2f.getChromeRuntimePort_=function(callback){var port=chrome.runtime.connect(u2f.EXTENSION_ID,{includeTlsChannelId:!0});setTimeout(function(){callback(new u2f.WrappedChromeRuntimePort_(port))},0)},u2f.getAuthenticatorPort_=function(callback){setTimeout(function(){callback(new u2f.WrappedAuthenticatorPort_)},0)},u2f.getIosPort_=function(callback){setTimeout(function(){callback(new u2f.WrappedIosPort_)},0)},u2f.WrappedChromeRuntimePort_=function(port){this.port_=port},u2f.formatSignRequest_=function(appId,challenge,registeredKeys,timeoutSeconds,reqId){if(void 0===js_api_version||js_api_version<1.1){for(var signRequests=[],i=0;i<registeredKeys.length;i++)signRequests[i]={version:registeredKeys[i].version,challenge:challenge,keyHandle:registeredKeys[i].keyHandle,appId:appId};return{type:u2f.MessageTypes.U2F_SIGN_REQUEST,signRequests:signRequests,timeoutSeconds:timeoutSeconds,requestId:reqId}}return{type:u2f.MessageTypes.U2F_SIGN_REQUEST,appId:appId,challenge:challenge,registeredKeys:registeredKeys,timeoutSeconds:timeoutSeconds,requestId:reqId}},u2f.formatRegisterRequest_=function(appId,registeredKeys,registerRequests,timeoutSeconds,reqId){if(void 0===js_api_version||js_api_version<1.1){for(var i=0;i<registerRequests.length;i++)registerRequests[i].appId=appId;var signRequests=[];for(i=0;i<registeredKeys.length;i++)signRequests[i]={version:registeredKeys[i].version,challenge:registerRequests[0],keyHandle:registeredKeys[i].keyHandle,appId:appId};return{type:u2f.MessageTypes.U2F_REGISTER_REQUEST,signRequests:signRequests,registerRequests:registerRequests,timeoutSeconds:timeoutSeconds,requestId:reqId}}return{type:u2f.MessageTypes.U2F_REGISTER_REQUEST,appId:appId,registerRequests:registerRequests,registeredKeys:registeredKeys,timeoutSeconds:timeoutSeconds,requestId:reqId}},u2f.WrappedChromeRuntimePort_.prototype.postMessage=function(message){this.port_.postMessage(message)},u2f.WrappedChromeRuntimePort_.prototype.addEventListener=function(eventName,handler){var name=eventName.toLowerCase();"message"===name||"onmessage"===name?this.port_.onMessage.addListener(function(message){handler({data:message})}):console.error("WrappedChromeRuntimePort only supports onMessage")},u2f.WrappedAuthenticatorPort_=function(){this.requestId_=-1,this.requestObject_=null},u2f.WrappedAuthenticatorPort_.prototype.postMessage=function(message){var intentUrl=u2f.WrappedAuthenticatorPort_.INTENT_URL_BASE_+";S.request="+encodeURIComponent(JSON.stringify(message))+";end";document.location=intentUrl},u2f.WrappedAuthenticatorPort_.prototype.getPortType=function(){return"WrappedAuthenticatorPort_"},u2f.WrappedAuthenticatorPort_.prototype.addEventListener=function(eventName,handler){if("message"===eventName.toLowerCase()){window.addEventListener("message",this.onRequestUpdate_.bind(this,handler),!1)}else console.error("WrappedAuthenticatorPort only supports message")},u2f.WrappedAuthenticatorPort_.prototype.onRequestUpdate_=function(callback,message){var messageObject=JSON.parse(message.data),responseObject=(messageObject.intentURL,messageObject.errorCode,null);messageObject.hasOwnProperty("data")&&(responseObject=JSON.parse(messageObject.data)),callback({data:responseObject})},u2f.WrappedAuthenticatorPort_.INTENT_URL_BASE_="intent:#Intent;action=com.google.android.apps.authenticator.AUTHENTICATE",u2f.WrappedIosPort_=function(){},u2f.WrappedIosPort_.prototype.postMessage=function(message){var str=JSON.stringify(message),url="u2f://auth?"+encodeURI(str);location.replace(url)},u2f.WrappedIosPort_.prototype.getPortType=function(){return"WrappedIosPort_"},u2f.WrappedIosPort_.prototype.addEventListener=function(eventName,handler){"message"!==eventName.toLowerCase()&&console.error("WrappedIosPort only supports message")},u2f.getIframePort_=function(callback){var iframeOrigin="chrome-extension://"+u2f.EXTENSION_ID,iframe=document.createElement("iframe");iframe.src=iframeOrigin+"/u2f-comms.html",iframe.setAttribute("style","display:none"),document.body.appendChild(iframe);var channel=new MessageChannel,ready=function(message){"ready"===message.data?(channel.port1.removeEventListener("message",ready),callback(channel.port1)):console.error('First event on iframe port was not "ready"')};channel.port1.addEventListener("message",ready),channel.port1.start(),iframe.addEventListener("load",function(){iframe.contentWindow.postMessage("init",iframeOrigin,[channel.port2])})},u2f.EXTENSION_TIMEOUT_SEC=30,u2f.port_=null,u2f.waitingForPort_=[],u2f.reqCounter_=0,u2f.callbackMap_={},u2f.getPortSingleton_=function(callback){u2f.port_?callback(u2f.port_):(0===u2f.waitingForPort_.length&&u2f.getMessagePort(function(port){for(u2f.port_=port,u2f.port_.addEventListener("message",u2f.responseHandler_);u2f.waitingForPort_.length;)u2f.waitingForPort_.shift()(u2f.port_)}),u2f.waitingForPort_.push(callback))},u2f.responseHandler_=function(message){if(message.data){var response=message.data,reqId=response.requestId;if(reqId&&u2f.callbackMap_[reqId]){var cb=u2f.callbackMap_[reqId];delete u2f.callbackMap_[reqId],cb(response.responseData)}else console.error("Unknown or missing requestId in response.")}},u2f.sign=function(appId,challenge,registeredKeys,callback,opt_timeoutSeconds){void 0===js_api_version?u2f.getApiVersion(function(response){js_api_version=void 0===response.js_api_version?0:response.js_api_version,console.log("Extension JS API Version: ",js_api_version),u2f.sendSignRequest(appId,challenge,registeredKeys,callback,opt_timeoutSeconds)}):u2f.sendSignRequest(appId,challenge,registeredKeys,callback,opt_timeoutSeconds)},u2f.sendSignRequest=function(appId,challenge,registeredKeys,callback,opt_timeoutSeconds){u2f.getPortSingleton_(function(port){var reqId=++u2f.reqCounter_;u2f.callbackMap_[reqId]=callback;var timeoutSeconds=void 0!==opt_timeoutSeconds?opt_timeoutSeconds:u2f.EXTENSION_TIMEOUT_SEC,req=u2f.formatSignRequest_(appId,challenge,registeredKeys,timeoutSeconds,reqId);port.postMessage(req)})},u2f.register=function(appId,registerRequests,registeredKeys,callback,opt_timeoutSeconds){void 0===js_api_version?u2f.getApiVersion(function(response){js_api_version=void 0===response.js_api_version?0:response.js_api_version,console.log("Extension JS API Version: ",js_api_version),u2f.sendRegisterRequest(appId,registerRequests,registeredKeys,callback,opt_timeoutSeconds)}):u2f.sendRegisterRequest(appId,registerRequests,registeredKeys,callback,opt_timeoutSeconds)},u2f.sendRegisterRequest=function(appId,registerRequests,registeredKeys,callback,opt_timeoutSeconds){u2f.getPortSingleton_(function(port){var reqId=++u2f.reqCounter_;u2f.callbackMap_[reqId]=callback;var timeoutSeconds=void 0!==opt_timeoutSeconds?opt_timeoutSeconds:u2f.EXTENSION_TIMEOUT_SEC,req=u2f.formatRegisterRequest_(appId,registeredKeys,registerRequests,timeoutSeconds,reqId);port.postMessage(req)})},u2f.getApiVersion=function(callback,opt_timeoutSeconds){u2f.getPortSingleton_(function(port){if(port.getPortType){var apiVersion;switch(port.getPortType()){case"WrappedIosPort_":case"WrappedAuthenticatorPort_":apiVersion=1.1;break;default:apiVersion=0}callback({js_api_version:apiVersion})}else{var reqId=++u2f.reqCounter_;u2f.callbackMap_[reqId]=callback;var req={type:u2f.MessageTypes.U2F_GET_API_VERSION_REQUEST,timeoutSeconds:void 0!==opt_timeoutSeconds?opt_timeoutSeconds:u2f.EXTENSION_TIMEOUT_SEC,requestId:reqId};port.postMessage(req)}})},module.exports=u2f}),System.register("src/misc/U2fClient.js",["node_modules/systemjs-plugin-babel/babel-helpers/possibleConstructorReturn.js","node_modules/systemjs-plugin-babel/babel-helpers/inherits.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../api/common/error/TutanotaError","../api/common/utils/Encoding","../api/Env","../api/common/error/RestError","../api/entities/sys/U2fRegisteredDevice","../api/entities/sys/U2fResponseData","./u2f-api","../api/common/TutanotaConstants","./ClientConstants","./ClientDetector"],function(_export,_context){"use strict";var _possibleConstructorReturn,_inherits,_classCallCheck,_createClass,TutanotaError,base64ToBase64Url,base64ToUint8Array,base64UrlToBase64,uint8ArrayToBase64,assertMainOrNode,getHttpOrigin,isApp,BadRequestError,createU2fRegisteredDevice,createU2fResponseData,u2fApi,SECOND_MS,BrowserType,client,U2fClient,REGISTRATION_RESERVED_BYTE_VALUE,U2fTimeoutError,U2fWrongDeviceError,U2fError;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersPossibleConstructorReturnJs){_possibleConstructorReturn=_node_modulesSystemjsPluginBabelBabelHelpersPossibleConstructorReturnJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersInheritsJs){_inherits=_node_modulesSystemjsPluginBabelBabelHelpersInheritsJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_apiCommonErrorTutanotaError){TutanotaError=_apiCommonErrorTutanotaError.TutanotaError},function(_apiCommonUtilsEncoding){base64ToBase64Url=_apiCommonUtilsEncoding.base64ToBase64Url,base64ToUint8Array=_apiCommonUtilsEncoding.base64ToUint8Array,base64UrlToBase64=_apiCommonUtilsEncoding.base64UrlToBase64,uint8ArrayToBase64=_apiCommonUtilsEncoding.uint8ArrayToBase64},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,getHttpOrigin=_apiEnv.getHttpOrigin,isApp=_apiEnv.isApp},function(_apiCommonErrorRestError){BadRequestError=_apiCommonErrorRestError.BadRequestError},function(_apiEntitiesSysU2fRegisteredDevice){createU2fRegisteredDevice=_apiEntitiesSysU2fRegisteredDevice.createU2fRegisteredDevice},function(_apiEntitiesSysU2fResponseData){createU2fResponseData=_apiEntitiesSysU2fResponseData.createU2fResponseData},function(_u2fApi){u2fApi=_u2fApi.default},function(_apiCommonTutanotaConstants){SECOND_MS=_apiCommonTutanotaConstants.SECOND_MS},function(_ClientConstants){BrowserType=_ClientConstants.BrowserType},function(_ClientDetector){client=_ClientDetector.client}],execute:function(){assertMainOrNode(),180,_export("U2fClient",U2fClient=function(){function U2fClient(){_classCallCheck(this,U2fClient),window.location.hostname.endsWith("tutanota.com")?this.appId="https://tutanota.com/u2f-appid.json":this.appId=getHttpOrigin()+"/u2f-appid.json"}return _createClass(U2fClient,[{key:"isSupported",value:function(){return Promise.resolve(!isApp()&&client.browser!==BrowserType.EDGE&&(window.u2f&&window.u2f.register||this.checkVersionWithTimeout())).catch(function(){return!1})}},{key:"checkVersionWithTimeout",value:function(){return Promise.race([new Promise(function(resolve){console.log("u2fApi.getApiVersion"),u2fApi.getApiVersion(function(responseOrError){console.log("u2fApi.getApiVersion response",responseOrError),resolve(null!=responseOrError.js_api_version)},2)}),Promise.delay(SECOND_MS,!1)])}},{key:"register",value:function(){var _this=this,random=new Uint8Array(32);("undefined"!=typeof crypto?crypto:msCrypto).getRandomValues(random);var challenge=base64ToBase64Url(uint8ArrayToBase64(random));return Promise.fromCallback(function(cb){(window.u2f||u2fApi).register(_this.appId,[{version:"U2F_V2",challenge:challenge}],[],function(r){return _this._handleError(r,cb)},180)}).then(function(rawRegisterResponse){return _this._decodeRegisterResponse(rawRegisterResponse)}).then(function(registerResponse){var u2fDevice=createU2fRegisteredDevice();return u2fDevice.keyHandle=registerResponse.keyHandle,u2fDevice.appId=_this.appId,u2fDevice.publicKey=registerResponse.userPublicKey,u2fDevice.compromised=!1,u2fDevice.counter="-1",u2fDevice})}},{key:"_handleError",value:function(rawResponse,cb){console.log("U2f error",rawResponse.errorCode,JSON.stringify(rawResponse)),rawResponse.errorCode?4===rawResponse.errorCode?cb(new U2fWrongDeviceError):5===rawResponse.errorCode?cb(new U2fTimeoutError):cb(new U2fError("U2f error code: "+rawResponse.errorCode)):cb(null,rawResponse)}},{key:"sign",value:function(sessionId,challenge){var _this2=this,registeredKeys=challenge.keys.map(function(key){return{version:"U2F_V2",keyHandle:base64ToBase64Url(uint8ArrayToBase64(key.keyHandle)),appId:_this2.appId}}),challengeData=base64ToBase64Url(uint8ArrayToBase64(challenge.challenge));return Promise.fromCallback(function(cb){(window.u2f||u2fApi).sign(_this2.appId,challengeData,registeredKeys,function(r){return _this2._handleError(r,cb)},180)}).then(function(rawAuthenticationResponse){var u2fSignatureResponse=createU2fResponseData();return u2fSignatureResponse.keyHandle=rawAuthenticationResponse.keyHandle,u2fSignatureResponse.clientData=rawAuthenticationResponse.clientData,u2fSignatureResponse.signatureData=rawAuthenticationResponse.signatureData,u2fSignatureResponse})}},{key:"_decodeRegisterResponse",value:function(rawRegisterResponse){var msg=base64ToUint8Array(base64UrlToBase64(rawRegisterResponse.registrationData)),keyHandleEnd=67+msg[66],reservedByte=msg[0];if(reservedByte!==REGISTRATION_RESERVED_BYTE_VALUE)throw new BadRequestError("Incorrect value of reserved byte. Expected: "+REGISTRATION_RESERVED_BYTE_VALUE+". Was: "+reservedByte);return{userPublicKey:msg.slice(1,66),keyHandle:msg.slice(67,keyHandleEnd)}}}]),U2fClient}()),_export("U2fClient",U2fClient),REGISTRATION_RESERVED_BYTE_VALUE=5,_export("U2fTimeoutError",U2fTimeoutError=function(_TutanotaError){function U2fTimeoutError(){return _classCallCheck(this,U2fTimeoutError),_possibleConstructorReturn(this,(U2fTimeoutError.__proto__||Object.getPrototypeOf(U2fTimeoutError)).call(this,"U2fTimeoutError",""))}return _inherits(U2fTimeoutError,TutanotaError),U2fTimeoutError}()),_export("U2fTimeoutError",U2fTimeoutError),_export("U2fWrongDeviceError",U2fWrongDeviceError=function(_TutanotaError2){function U2fWrongDeviceError(){return _classCallCheck(this,U2fWrongDeviceError),_possibleConstructorReturn(this,(U2fWrongDeviceError.__proto__||Object.getPrototypeOf(U2fWrongDeviceError)).call(this,"U2fWrongDeviceError",""))}return _inherits(U2fWrongDeviceError,TutanotaError),U2fWrongDeviceError}()),_export("U2fWrongDeviceError",U2fWrongDeviceError),_export("U2fError",U2fError=function(_TutanotaError3){function U2fError(msg){return _classCallCheck(this,U2fError),_possibleConstructorReturn(this,(U2fError.__proto__||Object.getPrototypeOf(U2fError)).call(this,"U2fError",msg))}return _inherits(U2fError,TutanotaError),U2fError}()),_export("U2fError",U2fError)}}}),System.register("src/login/SecondFactorHandler.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/entities/sys/Session","../api/main/Entity","../gui/base/Dialog","../api/entities/sys/Services","../api/common/EntityFunctions","../api/entities/sys/SecondFactorAuthData","../api/common/TutanotaConstants","../misc/LanguageViewModel","../api/common/utils/Utils","../misc/U2fClient","../api/Env","../api/common/error/RestError","../gui/base/icons/Icons","../gui/base/TextField","../api/main/MainLocator","../api/main/WorkerClient","../api/main/EventController","./RecoverLoginDialog","../gui/base/Icon"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,SessionTypeRef,load,serviceRequestVoid,Dialog,SysService,HttpMethod,isSameId,createSecondFactorAuthData,OperationType,SecondFactorType,SessionState,lang,neverNull,U2fClient,U2fError,U2fWrongDeviceError,assertMainOrNode,AccessBlockedError,BadRequestError,NotAuthenticatedError,NotFoundError,SecondFactorImage,TextField,locator,worker,isUpdateForTypeRef,RecoverLoginDialog,progressIcon,SecondFactorHandler,secondFactorHandler;function appIdToLoginDomain(appId){var domain=appId.split("/")[2];return"tutanota.com"!==domain?domain:"mail.tutanota.com"}return _export("appIdToLoginDomain",appIdToLoginDomain),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEntitiesSysSession){SessionTypeRef=_apiEntitiesSysSession.SessionTypeRef},function(_apiMainEntity){load=_apiMainEntity.load,serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod,isSameId=_apiCommonEntityFunctions.isSameId},function(_apiEntitiesSysSecondFactorAuthData){createSecondFactorAuthData=_apiEntitiesSysSecondFactorAuthData.createSecondFactorAuthData},function(_apiCommonTutanotaConstants){OperationType=_apiCommonTutanotaConstants.OperationType,SecondFactorType=_apiCommonTutanotaConstants.SecondFactorType,SessionState=_apiCommonTutanotaConstants.SessionState},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_miscU2fClient){U2fClient=_miscU2fClient.U2fClient,U2fError=_miscU2fClient.U2fError,U2fWrongDeviceError=_miscU2fClient.U2fWrongDeviceError},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiCommonErrorRestError){AccessBlockedError=_apiCommonErrorRestError.AccessBlockedError,BadRequestError=_apiCommonErrorRestError.BadRequestError,NotAuthenticatedError=_apiCommonErrorRestError.NotAuthenticatedError,NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiBaseIconsIcons){SecondFactorImage=_guiBaseIconsIcons.SecondFactorImage},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_RecoverLoginDialog){RecoverLoginDialog=_RecoverLoginDialog},function(_guiBaseIcon){progressIcon=_guiBaseIcon.progressIcon}],execute:function(){assertMainOrNode(),_export("SecondFactorHandler",SecondFactorHandler=function(){function SecondFactorHandler(){_classCallCheck(this,SecondFactorHandler),this._otherLoginSessionId=null,this._otherLoginDialog=null,this._otherLoginListenerInitialized=!1,this._waitingForSecondFactorDialog=null}return _createClass(SecondFactorHandler,[{key:"setupAcceptOtherClientLoginListener",value:function(){var _this=this;this._otherLoginListenerInitialized||(this._otherLoginListenerInitialized=!0,locator.eventController.addEntityListener(function(updates){return Promise.each(updates,function(update){var sessionId=[neverNull(update.instanceListId),update.instanceId];if(isUpdateForTypeRef(SessionTypeRef,update)){if(update.operation===OperationType.CREATE)return load(SessionTypeRef,sessionId).then(function(session){if(session.state===SessionState.SESSION_STATE_PENDING){null!=_this._otherLoginDialog&&_this._otherLoginDialog.close(),_this._otherLoginSessionId=session._id;var text=void 0;text=session.loginIpAddress?lang.get("secondFactorConfirmLogin_msg",{"{clientIdentifier}":session.clientIdentifier,"{ipAddress}":session.loginIpAddress}):lang.get("secondFactorConfirmLoginNoIp_msg",{"{clientIdentifier}":session.clientIdentifier}),_this._otherLoginDialog=Dialog.showActionDialog({title:lang.get("secondFactorConfirmLogin_label"),child:{view:function(){return m(".text-break.pt",text)}},okAction:function(){var serviceData=createSecondFactorAuthData();serviceData.session=session._id,serviceData.type=null,serviceRequestVoid(SysService.SecondFactorAuthService,HttpMethod.POST,serviceData),_this._otherLoginDialog&&(_this._otherLoginDialog.close(),_this._otherLoginSessionId=null,_this._otherLoginDialog=null)}});var _sessionId=session._id;setTimeout(function(){_this._otherLoginDialog&&isSameId(neverNull(_this._otherLoginSessionId),_sessionId)&&(_this._otherLoginDialog.close(),_this._otherLoginSessionId=null,_this._otherLoginDialog=null)},6e4)}}).catch(NotFoundError,function(e){return console.log("Failed to load session",e)});if(update.operation===OperationType.UPDATE&&_this._otherLoginSessionId&&isSameId(_this._otherLoginSessionId,sessionId))return load(SessionTypeRef,sessionId).then(function(session){session.state!==SessionState.SESSION_STATE_PENDING&&_this._otherLoginDialog&&isSameId(neverNull(_this._otherLoginSessionId),sessionId)&&(_this._otherLoginDialog.close(),_this._otherLoginSessionId=null,_this._otherLoginDialog=null)}).catch(NotFoundError,function(e){return console.log("Failed to load session",e)})}}).return()}))}},{key:"closeWaitingForSecondFactorDialog",value:function(){this._waitingForSecondFactorDialog&&(this._waitingForSecondFactorDialog.close(),this._waitingForSecondFactorDialog=null)}},{key:"showWaitingForSecondFactorDialog",value:function(sessionId,challenges,mailAddress){var _this2=this;if(!this._waitingForSecondFactorDialog){var u2fChallenge=challenges.find(function(challenge){return challenge.type===SecondFactorType.u2f}),otpChallenge=challenges.find(function(challenge){return challenge.type===SecondFactorType.totp}),u2fClient=new U2fClient,keys=u2fChallenge?neverNull(u2fChallenge.u2f).keys:[],otpCodeField=new TextField("totpCode_label"),showingProgress=!1,otpClickHandler=function(){showingProgress=!0;var auth=createSecondFactorAuthData();return auth.type=SecondFactorType.totp,auth.session=sessionId,auth.otpCode=otpCodeField.value().replace(/ /g,""),serviceRequestVoid(SysService.SecondFactorAuthService,HttpMethod.POST,auth).then(function(){_this2._waitingForSecondFactorDialog&&_this2._waitingForSecondFactorDialog.close()}).catch(NotAuthenticatedError,function(){return Dialog.error("loginFailed_msg")}).catch(BadRequestError,function(){return Dialog.error("loginFailed_msg")}).catch(AccessBlockedError,function(){return Dialog.error("loginFailedOften_msg")}).finally(function(){showingProgress=!1})};u2fClient.isSupported().then(function(u2fSupport){console.log("u2fSupport",u2fSupport);var keyForThisDomainExisting=keys.filter(function(key){return key.appId===u2fClient.appId}).length>0,otherDomainAppIds=keys.filter(function(key){return key.appId!==u2fClient.appId}).map(function(key){return key.appId}),otherLoginDomain=otherDomainAppIds.length>0?appIdToLoginDomain(otherDomainAppIds[0]):null,cancelAction=function(){worker.cancelCreateSession(),_this2.closeWaitingForSecondFactorDialog()};if(_this2._waitingForSecondFactorDialog=Dialog.showActionDialog({title:"",allowOkWithReturn:!0,child:{view:function(){return m("",[showingProgress?m(".mt.flex-center",progressIcon()):null,u2fSupport&&keyForThisDomainExisting?m(".flex-center",m("img[src="+SecondFactorImage+"]")):null,m("p",[m(".center",lang.get(u2fSupport&&keyForThisDomainExisting||otpChallenge?"secondFactorPending_msg":"secondFactorPendingOtherClientOnly_msg")),otpChallenge?m(".left.mlr-l",m(otpCodeField)):null]),otherLoginDomain&&!keyForThisDomainExisting&&u2fSupport?m("a",{href:"https://"+otherLoginDomain},lang.get("differentSecurityKeyDomain_msg",{"{domain}":"https://"+otherLoginDomain})):null,mailAddress?m(".small.right",[m("a[href=#]",{onclick:function(e){cancelAction(),_this2._waitingForSecondFactorDialog&&_this2._waitingForSecondFactorDialog.close(),RecoverLoginDialog.show(mailAddress,"secondFactor"),e.preventDefault()}},lang.get("recoverAccountAccess_action"))]):null])}},okAction:otpChallenge?otpClickHandler:null,cancelAction:cancelAction}),u2fSupport&&keyForThisDomainExisting){!function registerResumeOnError(){u2fClient.sign(sessionId,neverNull(neverNull(u2fChallenge).u2f)).then(function(u2fSignatureResponse){var auth=createSecondFactorAuthData();return auth.type=SecondFactorType.u2f,auth.session=sessionId,auth.u2f=u2fSignatureResponse,serviceRequestVoid(SysService.SecondFactorAuthService,HttpMethod.POST,auth)}).catch(function(e){e instanceof U2fError?Dialog.error("u2fUnexpectedError_msg"):e instanceof AccessBlockedError?Dialog.error("loginFailedOften_msg"):(e instanceof U2fWrongDeviceError?Dialog.error("u2fAuthUnregisteredDevice_msg"):e instanceof NotAuthenticatedError&&Dialog.error("loginFailed_msg"),_this2._waitingForSecondFactorDialog&&_this2._waitingForSecondFactorDialog.visible&&registerResumeOnError())})}()}})}}}]),SecondFactorHandler}()),_export("SecondFactorHandler",SecondFactorHandler),_export("secondFactorHandler",secondFactorHandler=new SecondFactorHandler),_export("secondFactorHandler",secondFactorHandler)}}}),function(doc,undefined){"use strict";var ELEMENT_NODE=1,TEXT_NODE=3,DOCUMENT_NODE=9,DOCUMENT_FRAGMENT_NODE=11,SHOW_ELEMENT=1,ZWS="​",win=doc.defaultView,ua=navigator.userAgent,isAndroid=/Android/.test(ua),isIOS=/iP(?:ad|hone|od)/.test(ua),isMac=/Mac OS X/.test(ua),isWin=/Windows NT/.test(ua),isGecko=/Gecko\//.test(ua),isIElt11=/Trident\/[456]\./.test(ua),isPresto=!!win.opera,isEdge=/Edge\//.test(ua),isWebKit=!isEdge&&/WebKit\//.test(ua),isIE=/Trident\/[4567]\./.test(ua),ctrlKey=isMac?"meta-":"ctrl-",useTextFixer=isIElt11||isPresto,cantFocusEmptyTextNodes=isIElt11||isWebKit,losesSelectionOnBlur=isIElt11,canObserveMutations="undefined"!=typeof MutationObserver,canWeakMap="undefined"!=typeof WeakMap,notWS=/[^ \t\r\n]/,indexOf=Array.prototype.indexOf;Object.create||(Object.create=function(proto){var F=function(){};return F.prototype=proto,new F});var typeToBitArray={1:1,2:2,3:4,8:128,9:256,11:1024},always=function(){return!0};function TreeWalker(root,nodeType,filter){this.root=this.currentNode=root,this.nodeType=nodeType,this.filter=filter||always}TreeWalker.prototype.nextNode=function(){for(var node,current=this.currentNode,root=this.root,nodeType=this.nodeType,filter=this.filter;;){for(node=current.firstChild;!node&&current&&current!==root;)(node=current.nextSibling)||(current=current.parentNode);if(!node)return null;if(typeToBitArray[node.nodeType]&nodeType&&filter(node))return this.currentNode=node,node;current=node}},TreeWalker.prototype.previousNode=function(){for(var node,current=this.currentNode,root=this.root,nodeType=this.nodeType,filter=this.filter;;){if(current===root)return null;if(node=current.previousSibling)for(;current=node.lastChild;)node=current;else node=current.parentNode;if(!node)return null;if(typeToBitArray[node.nodeType]&nodeType&&filter(node))return this.currentNode=node,node;current=node}},TreeWalker.prototype.previousPONode=function(){for(var node,current=this.currentNode,root=this.root,nodeType=this.nodeType,filter=this.filter;;){for(node=current.lastChild;!node&&current&&current!==root;)(node=current.previousSibling)||(current=current.parentNode);if(!node)return null;if(typeToBitArray[node.nodeType]&nodeType&&filter(node))return this.currentNode=node,node;current=node}};var inlineNodeNames=/^(?:#text|A(?:BBR|CRONYM)?|B(?:R|D[IO])?|C(?:ITE|ODE)|D(?:ATA|EL|FN)|EM|FONT|HR|I(?:FRAME|MG|NPUT|NS)?|KBD|Q|R(?:P|T|UBY)|S(?:AMP|MALL|PAN|TR(?:IKE|ONG)|U[BP])?|TIME|U|VAR|WBR)$/,leafNodeNames={BR:1,HR:1,IFRAME:1,IMG:1,INPUT:1};var UNKNOWN=0,INLINE=1,BLOCK=2,CONTAINER=3,nodeCategoryCache=canWeakMap?new WeakMap:null;function isLeaf(node){return node.nodeType===ELEMENT_NODE&&!!leafNodeNames[node.nodeName]}function getNodeCategory(node){switch(node.nodeType){case TEXT_NODE:return INLINE;case ELEMENT_NODE:case DOCUMENT_FRAGMENT_NODE:if(canWeakMap&&nodeCategoryCache.has(node))return nodeCategoryCache.get(node);break;default:return UNKNOWN}var nodeCategory;return nodeCategory=function(nodeList,fn){for(var l=nodeList.length;l--;)if(!fn(nodeList[l]))return!1;return!0}(node.childNodes,isInline)?inlineNodeNames.test(node.nodeName)?INLINE:BLOCK:CONTAINER,canWeakMap&&nodeCategoryCache.set(node,nodeCategory),nodeCategory}function isInline(node){return getNodeCategory(node)===INLINE}function isBlock(node){return getNodeCategory(node)===BLOCK}function isContainer(node){return getNodeCategory(node)===CONTAINER}function getBlockWalker(node,root){var walker=new TreeWalker(root,SHOW_ELEMENT,isBlock);return walker.currentNode=node,walker}function getPreviousBlock(node,root){return(node=getBlockWalker(node,root).previousNode())!==root?node:null}function getNextBlock(node,root){return(node=getBlockWalker(node,root).nextNode())!==root?node:null}function isEmptyBlock(block){return!block.textContent&&!block.querySelector("IMG")}function areAlike(node,node2){return!isLeaf(node)&&node.nodeType===node2.nodeType&&node.nodeName===node2.nodeName&&"A"!==node.nodeName&&node.className===node2.className&&(!node.style&&!node2.style||node.style.cssText===node2.style.cssText)}function hasTagAttributes(node,tag,attributes){if(node.nodeName!==tag)return!1;for(var attr in attributes)if(node.getAttribute(attr)!==attributes[attr])return!1;return!0}function getNearest(node,root,tag,attributes){for(;node&&node!==root;){if(hasTagAttributes(node,tag,attributes))return node;node=node.parentNode}return null}function isOrContains(parent,node){for(;node;){if(node===parent)return!0;node=node.parentNode}return!1}function getLength(node){var nodeType=node.nodeType;return nodeType===ELEMENT_NODE||nodeType===DOCUMENT_FRAGMENT_NODE?node.childNodes.length:node.length||0}function detach(node){var parent=node.parentNode;return parent&&parent.removeChild(node),node}function replaceWith(node,node2){var parent=node.parentNode;parent&&parent.replaceChild(node2,node)}function empty(node){for(var frag=node.ownerDocument.createDocumentFragment(),childNodes=node.childNodes,l=childNodes?childNodes.length:0;l--;)frag.appendChild(node.firstChild);return frag}function createElement(doc,tag,props,children){var attr,i,l,el=doc.createElement(tag);if(props instanceof Array&&(children=props,props=null),props)for(attr in props)props[attr]!==undefined&&el.setAttribute(attr,props[attr]);if(children)for(i=0,l=children.length;i<l;i+=1)el.appendChild(children[i]);return el}function fixCursor(node,root){var fixer,child,self=root.__squire__,doc=node.ownerDocument,originalNode=node;if(node===root&&((child=node.firstChild)&&"BR"!==child.nodeName||(fixer=self.createDefaultBlock(),child?node.replaceChild(fixer,child):node.appendChild(fixer),node=fixer,fixer=null)),node.nodeType===TEXT_NODE)return originalNode;if(isInline(node)){for(child=node.firstChild;cantFocusEmptyTextNodes&&child&&child.nodeType===TEXT_NODE&&!child.data;)node.removeChild(child),child=node.firstChild;child||(cantFocusEmptyTextNodes?(fixer=doc.createTextNode(ZWS),self._didAddZWS()):fixer=doc.createTextNode(""))}else if(useTextFixer){for(;node.nodeType!==TEXT_NODE&&!isLeaf(node);){if(!(child=node.firstChild)){fixer=doc.createTextNode("");break}node=child}node.nodeType===TEXT_NODE?/^ +$/.test(node.data)&&(node.data=""):isLeaf(node)&&node.parentNode.insertBefore(doc.createTextNode(""),node)}else if(!node.querySelector("BR"))for(fixer=createElement(doc,"BR");(child=node.lastElementChild)&&!isInline(child);)node=child;if(fixer)try{node.appendChild(fixer)}catch(error){self.didError({name:"Squire: fixCursor – "+error,message:"Parent: "+node.nodeName+"/"+node.innerHTML+" appendChild: "+fixer.nodeName})}return originalNode}function fixContainer(container,root){var i,l,child,isBR,children=container.childNodes,doc=container.ownerDocument,wrapper=null,config=root.__squire__._config;for(i=0,l=children.length;i<l;i+=1)!(isBR="BR"===(child=children[i]).nodeName)&&isInline(child)?(wrapper||(wrapper=createElement(doc,config.blockTag,config.blockAttributes)),wrapper.appendChild(child),i-=1,l-=1):(isBR||wrapper)&&(wrapper||(wrapper=createElement(doc,config.blockTag,config.blockAttributes)),fixCursor(wrapper,root),isBR?container.replaceChild(wrapper,child):(container.insertBefore(wrapper,child),i+=1,l+=1),wrapper=null),isContainer(child)&&fixContainer(child,root);return wrapper&&container.appendChild(fixCursor(wrapper,root)),container}function split(node,offset,stopNode,root){var parent,clone,next,nodeType=node.nodeType;if(nodeType===TEXT_NODE&&node!==stopNode)return split(node.parentNode,node.splitText(offset),stopNode,root);if(nodeType===ELEMENT_NODE){if("number"==typeof offset&&(offset=offset<node.childNodes.length?node.childNodes[offset]:null),node===stopNode)return offset;for(parent=node.parentNode,clone=node.cloneNode(!1);offset;)next=offset.nextSibling,clone.appendChild(offset),offset=next;return"OL"===node.nodeName&&getNearest(node,root,"BLOCKQUOTE")&&(clone.start=(+node.start||1)+node.childNodes.length-1),fixCursor(node,root),fixCursor(clone,root),(next=node.nextSibling)?parent.insertBefore(clone,next):parent.appendChild(clone),split(parent,clone,stopNode,root)}return offset}function mergeInlines(node,range){if(node.nodeType===TEXT_NODE&&(node=node.parentNode),node.nodeType===ELEMENT_NODE){var fakeRange={startContainer:range.startContainer,startOffset:range.startOffset,endContainer:range.endContainer,endOffset:range.endOffset};!function _mergeInlines(node,fakeRange){for(var child,prev,len,children=node.childNodes,l=children.length,frags=[];l--;)if(child=children[l],prev=l&&children[l-1],l&&isInline(child)&&areAlike(child,prev)&&!leafNodeNames[child.nodeName])fakeRange.startContainer===child&&(fakeRange.startContainer=prev,fakeRange.startOffset+=getLength(prev)),fakeRange.endContainer===child&&(fakeRange.endContainer=prev,fakeRange.endOffset+=getLength(prev)),fakeRange.startContainer===node&&(fakeRange.startOffset>l?fakeRange.startOffset-=1:fakeRange.startOffset===l&&(fakeRange.startContainer=prev,fakeRange.startOffset=getLength(prev))),fakeRange.endContainer===node&&(fakeRange.endOffset>l?fakeRange.endOffset-=1:fakeRange.endOffset===l&&(fakeRange.endContainer=prev,fakeRange.endOffset=getLength(prev))),detach(child),child.nodeType===TEXT_NODE?prev.appendData(child.data):frags.push(empty(child));else if(child.nodeType===ELEMENT_NODE){for(len=frags.length;len--;)child.appendChild(frags.pop());_mergeInlines(child,fakeRange)}}(node,fakeRange),range.setStart(fakeRange.startContainer,fakeRange.startOffset),range.setEnd(fakeRange.endContainer,fakeRange.endOffset)}}function mergeWithBlock(block,next,range,root){for(var parent,last,offset,container=next;(parent=container.parentNode)&&parent!==root&&parent.nodeType===ELEMENT_NODE&&1===parent.childNodes.length;)container=parent;detach(container),offset=block.childNodes.length,(last=block.lastChild)&&"BR"===last.nodeName&&(block.removeChild(last),offset-=1),block.appendChild(empty(next)),range.setStart(block,offset),range.collapse(!0),mergeInlines(block,range),isPresto&&(last=block.lastChild)&&"BR"===last.nodeName&&block.removeChild(last)}function mergeContainers(node,root){var needsFix,block,prev=node.previousSibling,first=node.firstChild,doc=node.ownerDocument,isListItem="LI"===node.nodeName;if(!isListItem||first&&/^[OU]L$/.test(first.nodeName))if(prev&&areAlike(prev,node)){if(!isContainer(prev)){if(!isListItem)return;(block=createElement(doc,"DIV")).appendChild(empty(prev)),prev.appendChild(block)}detach(node),needsFix=!isContainer(node),prev.appendChild(empty(node)),needsFix&&fixContainer(prev,root),first&&mergeContainers(first,root)}else isListItem&&(prev=createElement(doc,"DIV"),node.insertBefore(prev,first),fixCursor(prev,root))}var getNodeBefore=function(node,offset){for(var children=node.childNodes;offset&&node.nodeType===ELEMENT_NODE;)offset=(children=(node=children[offset-1]).childNodes).length;return node},getNodeAfter=function(node,offset){if(node.nodeType===ELEMENT_NODE){var children=node.childNodes;if(offset<children.length)node=children[offset];else{for(;node&&!node.nextSibling;)node=node.parentNode;node&&(node=node.nextSibling)}}return node},insertNodeInRange=function(range,node){var parent,children,childCount,afterSplit,startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset;startContainer.nodeType===TEXT_NODE?(children=(parent=startContainer.parentNode).childNodes,startOffset===startContainer.length?(startOffset=indexOf.call(children,startContainer)+1,range.collapsed&&(endContainer=parent,endOffset=startOffset)):(startOffset&&(afterSplit=startContainer.splitText(startOffset),endContainer===startContainer?(endOffset-=startOffset,endContainer=afterSplit):endContainer===parent&&(endOffset+=1),startContainer=afterSplit),startOffset=indexOf.call(children,startContainer)),startContainer=parent):children=startContainer.childNodes,startOffset===(childCount=children.length)?startContainer.appendChild(node):startContainer.insertBefore(node,children[startOffset]),startContainer===endContainer&&(endOffset+=children.length-childCount),range.setStart(startContainer,startOffset),range.setEnd(endContainer,endOffset)},extractContentsOfRange=function(range,common,root){var startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset;common||(common=range.commonAncestorContainer),common.nodeType===TEXT_NODE&&(common=common.parentNode);for(var next,before,after,beforeText,afterText,endNode=split(endContainer,endOffset,common,root),startNode=split(startContainer,startOffset,common,root),frag=common.ownerDocument.createDocumentFragment();startNode!==endNode;)next=startNode.nextSibling,frag.appendChild(startNode),startNode=next;return startContainer=common,startOffset=endNode?indexOf.call(common.childNodes,endNode):common.childNodes.length,(before=(after=common.childNodes[startOffset])&&after.previousSibling)&&before.nodeType===TEXT_NODE&&after.nodeType===TEXT_NODE&&(startContainer=before,startOffset=before.length,beforeText=before.data,afterText=after.data," "===beforeText.charAt(beforeText.length-1)&&" "===afterText.charAt(0)&&(afterText=" "+afterText.slice(1)),before.appendData(afterText),detach(after)),range.setStart(startContainer,startOffset),range.collapse(!0),fixCursor(common,root),frag},deleteContentsOfRange=function(range,root){var frag,child,startBlock=getStartBlockOfRange(range,root),endBlock=getEndBlockOfRange(range,root),needsMerge=startBlock!==endBlock;return moveRangeBoundariesDownTree(range),moveRangeBoundariesUpTree(range,startBlock,endBlock,root),frag=extractContentsOfRange(range,null,root),moveRangeBoundariesDownTree(range),needsMerge&&(endBlock=getEndBlockOfRange(range,root),startBlock&&endBlock&&startBlock!==endBlock&&mergeWithBlock(startBlock,endBlock,range,root)),startBlock&&fixCursor(startBlock,root),(child=root.firstChild)&&"BR"!==child.nodeName?range.collapse(!0):(fixCursor(root,root),range.selectNodeContents(root.firstChild)),frag},insertTreeFragmentIntoRange=function(range,frag,root){var node,block,blockContentsAfterSplit,stopPoint,container,offset,replaceBlock,firstBlockInFrag,nodeAfterSplit,nodeBeforeSplit,tempRange;for(fixContainer(frag,root),node=frag;node=getNextBlock(node,root);)fixCursor(node,root);if(range.collapsed||deleteContentsOfRange(range,root),moveRangeBoundariesDownTree(range),range.collapse(!1),stopPoint=getNearest(range.endContainer,root,"BLOCKQUOTE")||root,block=getStartBlockOfRange(range,root),firstBlockInFrag=getNextBlock(frag,frag),replaceBlock=!!block&&isEmptyBlock(block),block&&firstBlockInFrag&&!replaceBlock&&!getNearest(firstBlockInFrag,frag,"PRE")&&!getNearest(firstBlockInFrag,frag,"TABLE")){if(moveRangeBoundariesUpTree(range,block,block,root),range.collapse(!0),container=range.endContainer,offset=range.endOffset,cleanupBRs(block,root,!1),isInline(container)&&(container=(nodeAfterSplit=split(container,offset,getPreviousBlock(container,root),root)).parentNode,offset=indexOf.call(container.childNodes,nodeAfterSplit)),offset!==getLength(container))for(blockContentsAfterSplit=root.ownerDocument.createDocumentFragment();node=container.childNodes[offset];)blockContentsAfterSplit.appendChild(node);mergeWithBlock(container,firstBlockInFrag,range,root),offset=indexOf.call(container.parentNode.childNodes,container)+1,container=container.parentNode,range.setEnd(container,offset)}getLength(frag)&&(replaceBlock&&(range.setEndBefore(block),range.collapse(!1),detach(block)),moveRangeBoundariesUpTree(range,stopPoint,stopPoint,root),nodeBeforeSplit=(nodeAfterSplit=split(range.endContainer,range.endOffset,stopPoint,root))?nodeAfterSplit.previousSibling:stopPoint.lastChild,stopPoint.insertBefore(frag,nodeAfterSplit),nodeAfterSplit?range.setEndBefore(nodeAfterSplit):range.setEnd(stopPoint,getLength(stopPoint)),block=getEndBlockOfRange(range,root),moveRangeBoundariesDownTree(range),container=range.endContainer,offset=range.endOffset,nodeAfterSplit&&isContainer(nodeAfterSplit)&&mergeContainers(nodeAfterSplit,root),(nodeAfterSplit=nodeBeforeSplit&&nodeBeforeSplit.nextSibling)&&isContainer(nodeAfterSplit)&&mergeContainers(nodeAfterSplit,root),range.setEnd(container,offset)),blockContentsAfterSplit&&(mergeWithBlock(block,blockContentsAfterSplit,tempRange=range.cloneRange(),root),range.setEnd(tempRange.endContainer,tempRange.endOffset)),moveRangeBoundariesDownTree(range)},isNodeContainedInRange=function(range,node,partial){var nodeRange=node.ownerDocument.createRange();if(nodeRange.selectNode(node),partial){var nodeEndBeforeStart=range.compareBoundaryPoints(3,nodeRange)>-1,nodeStartAfterEnd=range.compareBoundaryPoints(1,nodeRange)<1;return!nodeEndBeforeStart&&!nodeStartAfterEnd}var nodeStartAfterStart=range.compareBoundaryPoints(0,nodeRange)<1,nodeEndBeforeEnd=range.compareBoundaryPoints(2,nodeRange)>-1;return nodeStartAfterStart&&nodeEndBeforeEnd},moveRangeBoundariesDownTree=function(range){for(var child,startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset,maySkipBR=!0;startContainer.nodeType!==TEXT_NODE&&(child=startContainer.childNodes[startOffset])&&!isLeaf(child);)startContainer=child,startOffset=0;if(endOffset)for(;endContainer.nodeType!==TEXT_NODE;){if(!(child=endContainer.childNodes[endOffset-1])||isLeaf(child)){if(maySkipBR&&child&&"BR"===child.nodeName){endOffset-=1,maySkipBR=!1;continue}break}endOffset=getLength(endContainer=child)}else for(;endContainer.nodeType!==TEXT_NODE&&(child=endContainer.firstChild)&&!isLeaf(child);)endContainer=child;range.collapsed?(range.setStart(endContainer,endOffset),range.setEnd(startContainer,startOffset)):(range.setStart(startContainer,startOffset),range.setEnd(endContainer,endOffset))},moveRangeBoundariesUpTree=function(range,startMax,endMax,root){var parent,startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset,maySkipBR=!0;for(startMax||(startMax=range.commonAncestorContainer),endMax||(endMax=startMax);!startOffset&&startContainer!==startMax&&startContainer!==root;)parent=startContainer.parentNode,startOffset=indexOf.call(parent.childNodes,startContainer),startContainer=parent;for(;maySkipBR&&endContainer.nodeType!==TEXT_NODE&&endContainer.childNodes[endOffset]&&"BR"===endContainer.childNodes[endOffset].nodeName&&(endOffset+=1,maySkipBR=!1),endContainer!==endMax&&endContainer!==root&&endOffset===getLength(endContainer);)parent=endContainer.parentNode,endOffset=indexOf.call(parent.childNodes,endContainer)+1,endContainer=parent;range.setStart(startContainer,startOffset),range.setEnd(endContainer,endOffset)},getStartBlockOfRange=function(range,root){var block,container=range.startContainer;return(block=isInline(container)?getPreviousBlock(container,root):container!==root&&isBlock(container)?container:getNextBlock(block=getNodeBefore(container,range.startOffset),root))&&isNodeContainedInRange(range,block,!0)?block:null},getEndBlockOfRange=function(range,root){var block,child,container=range.endContainer;if(isInline(container))block=getPreviousBlock(container,root);else if(container!==root&&isBlock(container))block=container;else{if(!(block=getNodeAfter(container,range.endOffset))||!isOrContains(root,block))for(block=root;child=block.lastChild;)block=child;block=getPreviousBlock(block,root)}return block&&isNodeContainedInRange(range,block,!0)?block:null},contentWalker=new TreeWalker(null,4|SHOW_ELEMENT,function(node){return node.nodeType===TEXT_NODE?notWS.test(node.data):"IMG"===node.nodeName}),rangeDoesStartAtBlockBoundary=function(range,root){var nodeAfterCursor,startContainer=range.startContainer,startOffset=range.startOffset;if(contentWalker.root=null,startContainer.nodeType===TEXT_NODE){if(startOffset)return!1;nodeAfterCursor=startContainer}else if((nodeAfterCursor=getNodeAfter(startContainer,startOffset))&&!isOrContains(root,nodeAfterCursor)&&(nodeAfterCursor=null),!nodeAfterCursor&&(nodeAfterCursor=getNodeBefore(startContainer,startOffset)).nodeType===TEXT_NODE&&nodeAfterCursor.length)return!1;return contentWalker.currentNode=nodeAfterCursor,contentWalker.root=getStartBlockOfRange(range,root),!contentWalker.previousNode()},rangeDoesEndAtBlockBoundary=function(range,root){var length,endContainer=range.endContainer,endOffset=range.endOffset;if(contentWalker.root=null,endContainer.nodeType===TEXT_NODE){if((length=endContainer.data.length)&&endOffset<length)return!1;contentWalker.currentNode=endContainer}else contentWalker.currentNode=getNodeBefore(endContainer,endOffset);return contentWalker.root=getEndBlockOfRange(range,root),!contentWalker.nextNode()},expandRangeToBlockBoundaries=function(range,root){var parent,start=getStartBlockOfRange(range,root),end=getEndBlockOfRange(range,root);start&&end&&(parent=start.parentNode,range.setStart(parent,indexOf.call(parent.childNodes,start)),parent=end.parentNode,range.setEnd(parent,indexOf.call(parent.childNodes,end)+1))},keys={8:"backspace",9:"tab",13:"enter",32:"space",33:"pageup",34:"pagedown",37:"left",39:"right",46:"delete",219:"[",221:"]"},onKey=function(event){var code=event.keyCode,key=keys[code],modifiers="",range=this.getSelection();event.defaultPrevented||(key||(key=String.fromCharCode(code).toLowerCase(),/^[A-Za-z0-9]$/.test(key)||(key="")),isPresto&&46===event.which&&(key="."),111<code&&code<124&&(key="f"+(code-111)),"backspace"!==key&&"delete"!==key&&(event.altKey&&(modifiers+="alt-"),event.ctrlKey&&(modifiers+="ctrl-"),event.metaKey&&(modifiers+="meta-")),event.shiftKey&&(modifiers+="shift-"),key=modifiers+key,this._keyHandlers[key]?this._keyHandlers[key](this,event,range):range.collapsed||event.isComposing||event.ctrlKey||event.metaKey||1!==(event.key||key).length||(this.saveUndoState(range),deleteContentsOfRange(range,this._root),this._ensureBottomLine(),this.setSelection(range),this._updatePath(range,!0)))},mapKeyTo=function(method){return function(self,event){event.preventDefault(),self[method]()}},mapKeyToFormat=function(tag,remove){return remove=remove||null,function(self,event){event.preventDefault();var range=self.getSelection();self.hasFormat(tag,null,range)?self.changeFormat(null,{tag:tag},range):self.changeFormat({tag:tag},remove,range)}},afterDelete=function(self,range){try{range||(range=self.getSelection());var parent,node=range.startContainer;for(node.nodeType===TEXT_NODE&&(node=node.parentNode),parent=node;isInline(parent)&&(!parent.textContent||parent.textContent===ZWS);)parent=(node=parent).parentNode;node!==parent&&(range.setStart(parent,indexOf.call(parent.childNodes,node)),range.collapse(!0),parent.removeChild(node),isBlock(parent)||(parent=getPreviousBlock(parent,self._root)),fixCursor(parent,self._root),moveRangeBoundariesDownTree(range)),node===self._root&&(node=node.firstChild)&&"BR"===node.nodeName&&detach(node),self._ensureBottomLine(),self.setSelection(range),self._updatePath(range,!0)}catch(error){self.didError(error)}},keyHandlers={enter:function(self,event,range){var block,parent,node,offset,nodeAfterSplit,root=self._root;if(event.preventDefault(),self._recordUndoState(range),addLinks(range.startContainer,root,self),self._removeZWS(),self._getRangeAndRemoveBookmark(range),range.collapsed||deleteContentsOfRange(range,root),(block=getStartBlockOfRange(range,root))&&(parent=getNearest(block,root,"PRE")))return moveRangeBoundariesDownTree(range),node=range.startContainer,offset=range.startOffset,node.nodeType!==TEXT_NODE&&(node=self._doc.createTextNode(""),parent.insertBefore(node,parent.firstChild)),event.shiftKey||"\n"!==node.data.charAt(offset-1)&&!rangeDoesStartAtBlockBoundary(range,root)||"\n"!==node.data.charAt(offset)&&!rangeDoesEndAtBlockBoundary(range,root)?(node.insertData(offset,"\n"),fixCursor(parent,root),node.length===offset+1?range.setStartAfter(node):range.setStart(node,offset+1)):(node.deleteData(offset&&offset-1,offset?2:1),(node=(nodeAfterSplit=split(node,offset&&offset-1,root,root)).previousSibling).textContent||detach(node),node=self.createDefaultBlock(),nodeAfterSplit.parentNode.insertBefore(node,nodeAfterSplit),nodeAfterSplit.textContent||detach(nodeAfterSplit),range.setStart(node,0)),range.collapse(!0),self.setSelection(range),self._updatePath(range,!0),void self._docWasChanged();if(!block||event.shiftKey||/^T[HD]$/.test(block.nodeName))return(parent=getNearest(range.endContainer,root,"A"))&&(parent=parent.parentNode,moveRangeBoundariesUpTree(range,parent,parent,root),range.collapse(!1)),insertNodeInRange(range,self.createElement("BR")),range.collapse(!1),self.setSelection(range),void self._updatePath(range,!0);if((parent=getNearest(block,root,"LI"))&&(block=parent),isEmptyBlock(block)){if(getNearest(block,root,"UL")||getNearest(block,root,"OL"))return self.decreaseListLevel(range);if(getNearest(block,root,"BLOCKQUOTE"))return self.modifyBlocks(removeBlockQuote,range)}for(nodeAfterSplit=splitBlock(self,block,range.startContainer,range.startOffset),removeZWS(block),removeEmptyInlines(block),fixCursor(block,root);nodeAfterSplit.nodeType===ELEMENT_NODE;){var next,child=nodeAfterSplit.firstChild;if("A"===nodeAfterSplit.nodeName&&(!nodeAfterSplit.textContent||nodeAfterSplit.textContent===ZWS)){replaceWith(nodeAfterSplit,child=self._doc.createTextNode("")),nodeAfterSplit=child;break}for(;child&&child.nodeType===TEXT_NODE&&!child.data&&(next=child.nextSibling)&&"BR"!==next.nodeName;)detach(child),child=next;if(!child||"BR"===child.nodeName||child.nodeType===TEXT_NODE&&!isPresto)break;nodeAfterSplit=child}range=self.createRange(nodeAfterSplit,0),self.setSelection(range),self._updatePath(range,!0)},"shift-enter":function(self,event,range){return self._keyHandlers.enter(self,event,range)},backspace:function(self,event,range){var root=self._root;if(self._removeZWS(),self.saveUndoState(range),range.collapsed)if(rangeDoesStartAtBlockBoundary(range,root)){event.preventDefault();var previous,current=getStartBlockOfRange(range,root);if(!current)return;if(fixContainer(current.parentNode,root),previous=getPreviousBlock(current,root)){if(!previous.isContentEditable)return void detach(previous);for(mergeWithBlock(previous,current,range,root),current=previous.parentNode;current!==root&&!current.nextSibling;)current=current.parentNode;current!==root&&(current=current.nextSibling)&&mergeContainers(current,root),self.setSelection(range)}else if(current){if(getNearest(current,root,"UL")||getNearest(current,root,"OL"))return self.decreaseListLevel(range);if(getNearest(current,root,"BLOCKQUOTE"))return self.modifyBlocks(decreaseBlockQuoteLevel,range);self.setSelection(range),self._updatePath(range,!0)}}else self.setSelection(range),setTimeout(function(){afterDelete(self)},0);else event.preventDefault(),deleteContentsOfRange(range,root),afterDelete(self,range)},delete:function(self,event,range){var current,next,originalRange,cursorContainer,cursorOffset,nodeAfterCursor,root=self._root;if(self._removeZWS(),self.saveUndoState(range),range.collapsed)if(rangeDoesEndAtBlockBoundary(range,root)){if(event.preventDefault(),!(current=getStartBlockOfRange(range,root)))return;if(fixContainer(current.parentNode,root),next=getNextBlock(current,root)){if(!next.isContentEditable)return void detach(next);for(mergeWithBlock(current,next,range,root),next=current.parentNode;next!==root&&!next.nextSibling;)next=next.parentNode;next!==root&&(next=next.nextSibling)&&mergeContainers(next,root),self.setSelection(range),self._updatePath(range,!0)}}else{if(originalRange=range.cloneRange(),moveRangeBoundariesUpTree(range,root,root,root),cursorContainer=range.endContainer,cursorOffset=range.endOffset,cursorContainer.nodeType===ELEMENT_NODE&&(nodeAfterCursor=cursorContainer.childNodes[cursorOffset])&&"IMG"===nodeAfterCursor.nodeName)return event.preventDefault(),detach(nodeAfterCursor),moveRangeBoundariesDownTree(range),void afterDelete(self,range);self.setSelection(originalRange),setTimeout(function(){afterDelete(self)},0)}else event.preventDefault(),deleteContentsOfRange(range,root),afterDelete(self,range)},tab:function(self,event,range){var node,parent,root=self._root;if(self._removeZWS(),range.collapsed&&rangeDoesStartAtBlockBoundary(range,root))for(node=getStartBlockOfRange(range,root);parent=node.parentNode;){if("UL"===parent.nodeName||"OL"===parent.nodeName){event.preventDefault(),self.increaseListLevel(range);break}node=parent}},"shift-tab":function(self,event,range){var node,root=self._root;self._removeZWS(),range.collapsed&&rangeDoesStartAtBlockBoundary(range,root)&&(getNearest(node=range.startContainer,root,"UL")||getNearest(node,root,"OL"))&&(event.preventDefault(),self.decreaseListLevel(range))},space:function(self,_,range){var node,root=self._root;if(self._recordUndoState(range),addLinks(range.startContainer,root,self),self._getRangeAndRemoveBookmark(range),node=range.endContainer,range.collapsed&&range.endOffset===getLength(node))do{if("A"===node.nodeName){range.setStartAfter(node);break}}while(!node.nextSibling&&(node=node.parentNode)&&node!==root);range.collapsed||(deleteContentsOfRange(range,root),self._ensureBottomLine(),self.setSelection(range),self._updatePath(range,!0)),self.setSelection(range)},left:function(self){self._removeZWS()},right:function(self){self._removeZWS()}};isMac&&isGecko&&(keyHandlers["meta-left"]=function(self,event){event.preventDefault();var sel=getWindowSelection(self);sel&&sel.modify&&sel.modify("move","backward","lineboundary")},keyHandlers["meta-right"]=function(self,event){event.preventDefault();var sel=getWindowSelection(self);sel&&sel.modify&&sel.modify("move","forward","lineboundary")}),isMac||(keyHandlers.pageup=function(self){self.moveCursorToStart()},keyHandlers.pagedown=function(self){self.moveCursorToEnd()}),keyHandlers[ctrlKey+"b"]=mapKeyToFormat("B"),keyHandlers[ctrlKey+"i"]=mapKeyToFormat("I"),keyHandlers[ctrlKey+"u"]=mapKeyToFormat("U"),keyHandlers[ctrlKey+"shift-7"]=mapKeyToFormat("S"),keyHandlers[ctrlKey+"shift-5"]=mapKeyToFormat("SUB",{tag:"SUP"}),keyHandlers[ctrlKey+"shift-6"]=mapKeyToFormat("SUP",{tag:"SUB"}),keyHandlers[ctrlKey+"shift-8"]=mapKeyTo("makeUnorderedList"),keyHandlers[ctrlKey+"shift-9"]=mapKeyTo("makeOrderedList"),keyHandlers[ctrlKey+"["]=mapKeyTo("decreaseQuoteLevel"),keyHandlers[ctrlKey+"]"]=mapKeyTo("increaseQuoteLevel"),keyHandlers[ctrlKey+"d"]=mapKeyTo("toggleCode"),keyHandlers[ctrlKey+"y"]=mapKeyTo("redo"),keyHandlers[ctrlKey+"z"]=mapKeyTo("undo"),keyHandlers[ctrlKey+"shift-z"]=mapKeyTo("redo");var fontSizes={1:10,2:13,3:16,4:18,5:24,6:32,7:48},styleToSemantic={backgroundColor:{regexp:notWS,replace:function(doc,classNames,colour){return createElement(doc,"SPAN",{class:classNames.highlight,style:"background-color:"+colour})}},color:{regexp:notWS,replace:function(doc,classNames,colour){return createElement(doc,"SPAN",{class:classNames.colour,style:"color:"+colour})}},fontWeight:{regexp:/^bold|^700/i,replace:function(doc){return createElement(doc,"B")}},fontStyle:{regexp:/^italic/i,replace:function(doc){return createElement(doc,"I")}},fontFamily:{regexp:notWS,replace:function(doc,classNames,family){return createElement(doc,"SPAN",{class:classNames.fontFamily,style:"font-family:"+family})}},fontSize:{regexp:notWS,replace:function(doc,classNames,size){return createElement(doc,"SPAN",{class:classNames.fontSize,style:"font-size:"+size})}},textDecoration:{regexp:/^underline/i,replace:function(doc){return createElement(doc,"U")}}},replaceWithTag=function(tag){return function(node,parent){var el=createElement(node.ownerDocument,tag);return parent.replaceChild(el,node),el.appendChild(empty(node)),el}},replaceStyles=function(node,parent,config){var attr,converter,css,newTreeBottom,newTreeTop,el,style=node.style,doc=node.ownerDocument;for(attr in styleToSemantic)converter=styleToSemantic[attr],(css=style[attr])&&converter.regexp.test(css)&&(el=converter.replace(doc,config.classNames,css),newTreeTop||(newTreeTop=el),newTreeBottom&&newTreeBottom.appendChild(el),newTreeBottom=el,node.style[attr]="");return newTreeTop&&(newTreeBottom.appendChild(empty(node)),"SPAN"===node.nodeName?parent.replaceChild(newTreeTop,node):node.appendChild(newTreeTop)),newTreeBottom||node},stylesRewriters={P:replaceStyles,SPAN:replaceStyles,STRONG:replaceWithTag("B"),EM:replaceWithTag("I"),INS:replaceWithTag("U"),STRIKE:replaceWithTag("S"),FONT:function(node,parent,config){var fontSpan,sizeSpan,colourSpan,newTreeBottom,newTreeTop,face=node.face,size=node.size,colour=node.color,doc=node.ownerDocument,classNames=config.classNames;return face&&(newTreeTop=fontSpan=createElement(doc,"SPAN",{class:classNames.fontFamily,style:"font-family:"+face}),newTreeBottom=fontSpan),size&&(sizeSpan=createElement(doc,"SPAN",{class:classNames.fontSize,style:"font-size:"+fontSizes[size]+"px"}),newTreeTop||(newTreeTop=sizeSpan),newTreeBottom&&newTreeBottom.appendChild(sizeSpan),newTreeBottom=sizeSpan),colour&&/^#?([\dA-F]{3}){1,2}$/i.test(colour)&&("#"!==colour.charAt(0)&&(colour="#"+colour),colourSpan=createElement(doc,"SPAN",{class:classNames.colour,style:"color:"+colour}),newTreeTop||(newTreeTop=colourSpan),newTreeBottom&&newTreeBottom.appendChild(colourSpan),newTreeBottom=colourSpan),newTreeTop||(newTreeTop=newTreeBottom=createElement(doc,"SPAN")),parent.replaceChild(newTreeTop,node),newTreeBottom.appendChild(empty(node)),newTreeBottom},TT:function(node,parent,config){var el=createElement(node.ownerDocument,"SPAN",{class:config.classNames.fontFamily,style:'font-family:menlo,consolas,"courier new",monospace'});return parent.replaceChild(el,node),el.appendChild(empty(node)),el}},allowedBlock=/^(?:A(?:DDRESS|RTICLE|SIDE|UDIO)|BLOCKQUOTE|CAPTION|D(?:[DLT]|IV)|F(?:IGURE|IGCAPTION|OOTER)|H[1-6]|HEADER|L(?:ABEL|EGEND|I)|O(?:L|UTPUT)|P(?:RE)?|SECTION|T(?:ABLE|BODY|D|FOOT|H|HEAD|R)|COL(?:GROUP)?|UL)$/,blacklist=/^(?:HEAD|META|STYLE)/,walker=new TreeWalker(null,4|SHOW_ELEMENT),cleanTree=function cleanTree(node,config,preserveWS){var nonInlineParent,i,l,child,nodeName,nodeType,rewriter,childLength,startsWithWS,endsWithWS,data,sibling,children=node.childNodes;for(nonInlineParent=node;isInline(nonInlineParent);)nonInlineParent=nonInlineParent.parentNode;for(walker.root=nonInlineParent,i=0,l=children.length;i<l;i+=1)if(nodeName=(child=children[i]).nodeName,nodeType=child.nodeType,rewriter=stylesRewriters[nodeName],nodeType===ELEMENT_NODE){if(childLength=child.childNodes.length,rewriter)child=rewriter(child,node,config);else{if(blacklist.test(nodeName)){node.removeChild(child),i-=1,l-=1;continue}if(!allowedBlock.test(nodeName)&&!isInline(child)){i-=1,l+=childLength-1,node.replaceChild(empty(child),child);continue}}childLength&&cleanTree(child,config,preserveWS||"PRE"===nodeName)}else{if(nodeType===TEXT_NODE){if(data=child.data,startsWithWS=!notWS.test(data.charAt(0)),endsWithWS=!notWS.test(data.charAt(data.length-1)),preserveWS||!startsWithWS&&!endsWithWS)continue;if(startsWithWS){for(walker.currentNode=child;(sibling=walker.previousPONode())&&!("IMG"===(nodeName=sibling.nodeName)||"#text"===nodeName&&notWS.test(sibling.data));)if(!isInline(sibling)){sibling=null;break}data=data.replace(/^[ \t\r\n]+/g,sibling?" ":"")}if(endsWithWS){for(walker.currentNode=child;(sibling=walker.nextNode())&&!("IMG"===nodeName||"#text"===nodeName&&notWS.test(sibling.data));)if(!isInline(sibling)){sibling=null;break}data=data.replace(/[ \t\r\n]+$/g,sibling?" ":"")}if(data){child.data=data;continue}}node.removeChild(child),i-=1,l-=1}return node},removeEmptyInlines=function removeEmptyInlines(node){for(var child,children=node.childNodes,l=children.length;l--;)(child=children[l]).nodeType!==ELEMENT_NODE||isLeaf(child)?child.nodeType!==TEXT_NODE||child.data||node.removeChild(child):(removeEmptyInlines(child),isInline(child)&&!child.firstChild&&node.removeChild(child))},notWSTextNode=function(node){return node.nodeType===ELEMENT_NODE?"BR"===node.nodeName:notWS.test(node.data)},isLineBreak=function(br,isLBIfEmptyBlock){for(var walker,block=br.parentNode;isInline(block);)block=block.parentNode;return(walker=new TreeWalker(block,4|SHOW_ELEMENT,notWSTextNode)).currentNode=br,!!walker.nextNode()||isLBIfEmptyBlock&&!walker.previousNode()},cleanupBRs=function(node,root,keepForBlankLine){var i,br,parent,brs=node.querySelectorAll("BR"),brBreaksLine=[],l=brs.length;for(i=0;i<l;i+=1)brBreaksLine[i]=isLineBreak(brs[i],keepForBlankLine);for(;l--;)(parent=(br=brs[l]).parentNode)&&(brBreaksLine[l]?isInline(parent)||fixContainer(parent,root):detach(br))},setClipboardData=function(clipboardData,node,root,config){var html,text,body=node.ownerDocument.body,willCutCopy=config.willCutCopy;cleanupBRs(node,root,!0),node.setAttribute("style","position:fixed;overflow:hidden;bottom:100%;right:100%;"),body.appendChild(node),html=node.innerHTML,text=node.innerText||node.textContent,willCutCopy&&(html=willCutCopy(html)),isWin&&(text=text.replace(/\r?\n/g,"\r\n")),clipboardData.setData("text/html",html),clipboardData.setData("text/plain",text),body.removeChild(node)},onCut=function(event){var startBlock,copyRoot,contents,parent,newContents,node,clipboardData=event.clipboardData,range=this.getSelection(),root=this._root,self=this;if(range.collapsed)event.preventDefault();else{if(this.saveUndoState(range),isEdge||isIOS||!clipboardData)setTimeout(function(){try{self._ensureBottomLine()}catch(error){self.didError(error)}},0);else{for(copyRoot=(startBlock=getStartBlockOfRange(range,root))===getEndBlockOfRange(range,root)&&startBlock||root,contents=deleteContentsOfRange(range,root),(parent=range.commonAncestorContainer).nodeType===TEXT_NODE&&(parent=parent.parentNode);parent&&parent!==copyRoot;)(newContents=parent.cloneNode(!1)).appendChild(contents),contents=newContents,parent=parent.parentNode;(node=this.createElement("div")).appendChild(contents),setClipboardData(clipboardData,node,root,this._config),event.preventDefault()}this.setSelection(range)}},onCopy=function(event){var startBlock,copyRoot,contents,parent,newContents,node,clipboardData=event.clipboardData,range=this.getSelection(),root=this._root;if(!isEdge&&!isIOS&&clipboardData){for(copyRoot=(startBlock=getStartBlockOfRange(range,root))===getEndBlockOfRange(range,root)&&startBlock||root,range=range.cloneRange(),moveRangeBoundariesDownTree(range),moveRangeBoundariesUpTree(range,copyRoot,copyRoot,root),contents=range.cloneContents(),(parent=range.commonAncestorContainer).nodeType===TEXT_NODE&&(parent=parent.parentNode);parent&&parent!==copyRoot;)(newContents=parent.cloneNode(!1)).appendChild(contents),contents=newContents,parent=parent.parentNode;(node=this.createElement("div")).appendChild(contents),setClipboardData(clipboardData,node,root,this._config),event.preventDefault()}};function monitorShiftKey(event){this.isShiftDown=event.shiftKey}var onPaste=function(event){var l,item,type,types,data,clipboardData=event.clipboardData,items=clipboardData&&clipboardData.items,choosePlain=this.isShiftDown,fireDrop=!1,hasImage=!1,plainItem=null,self=this;if(isEdge&&items){for(l=items.length;l--;)!choosePlain&&/^image\/.*/.test(items[l].type)&&(hasImage=!0);hasImage||(items=null)}if(items){for(event.preventDefault(),l=items.length;l--;){if(type=(item=items[l]).type,!choosePlain&&"text/html"===type)return void item.getAsString(function(html){self.insertHTML(html,!0)});"text/plain"===type&&(plainItem=item),!choosePlain&&/^image\/.*/.test(type)&&(hasImage=!0)}hasImage?(this.fireEvent("dragover",{dataTransfer:clipboardData,preventDefault:function(){fireDrop=!0}}),fireDrop&&this.fireEvent("drop",{dataTransfer:clipboardData})):plainItem&&plainItem.getAsString(function(text){self.insertPlainText(text,!0)})}else{if(types=clipboardData&&clipboardData.types,!isEdge&&types&&(indexOf.call(types,"text/html")>-1||!isGecko&&indexOf.call(types,"text/plain")>-1&&indexOf.call(types,"text/rtf")<0))return event.preventDefault(),void(!choosePlain&&(data=clipboardData.getData("text/html"))?this.insertHTML(data,!0):((data=clipboardData.getData("text/plain"))||(data=clipboardData.getData("text/uri-list")))&&this.insertPlainText(data,!0));this._awaitingPaste=!0;var body=this._doc.body,range=this.getSelection(),startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset,pasteArea=this.createElement("DIV",{contenteditable:"true",style:"position:fixed; overflow:hidden; top:0; right:100%; width:1px; height:1px;"});body.appendChild(pasteArea),range.selectNodeContents(pasteArea),this.setSelection(range),setTimeout(function(){try{self._awaitingPaste=!1;for(var first,range,html="",next=pasteArea;pasteArea=next;)next=pasteArea.nextSibling,detach(pasteArea),(first=pasteArea.firstChild)&&first===pasteArea.lastChild&&"DIV"===first.nodeName&&(pasteArea=first),html+=pasteArea.innerHTML;range=self.createRange(startContainer,startOffset,endContainer,endOffset),self.setSelection(range),html&&self.insertHTML(html,!0)}catch(error){self.didError(error)}},0)}},onDrop=function(event){for(var types=event.dataTransfer.types,l=types.length,hasPlain=!1,hasHTML=!1;l--;)switch(types[l]){case"text/plain":hasPlain=!0;break;case"text/html":hasHTML=!0;break;default:return}(hasHTML||hasPlain)&&this.saveUndoState()};function mergeObjects(base,extras,mayOverride){var prop,value;if(base||(base={}),extras)for(prop in extras)!mayOverride&&prop in base||(value=extras[prop],base[prop]=value&&value.constructor===Object?mergeObjects(base[prop],value,mayOverride):value);return base}function Squire(root,config){root.nodeType===DOCUMENT_NODE&&(root=root.body);var mutation,doc=root.ownerDocument,win=doc.defaultView;this._win=win,this._doc=doc,this._root=root,this._events={},this._isFocused=!1,this._lastSelection=null,losesSelectionOnBlur&&this.addEventListener("beforedeactivate",this.getSelection),this._hasZWS=!1,this._lastAnchorNode=null,this._lastFocusNode=null,this._path="",this._willUpdatePath=!1,"onselectionchange"in doc?this.addEventListener("selectionchange",this._updatePathOnEvent):(this.addEventListener("keyup",this._updatePathOnEvent),this.addEventListener("mouseup",this._updatePathOnEvent)),this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0,this._isInUndoState=!1,this._ignoreChange=!1,this._ignoreAllChanges=!1,canObserveMutations?((mutation=new MutationObserver(this._docWasChanged.bind(this))).observe(root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._mutation=mutation):this.addEventListener("keyup",this._keyUpDetectChange),this._restoreSelection=!1,this.addEventListener("blur",enableRestoreSelection),this.addEventListener("mousedown",disableRestoreSelection),this.addEventListener("touchstart",disableRestoreSelection),this.addEventListener("focus",restoreSelection),this._awaitingPaste=!1,this.addEventListener(isIElt11?"beforecut":"cut",onCut),this.addEventListener("copy",onCopy),this.addEventListener("keydown",monitorShiftKey),this.addEventListener("keyup",monitorShiftKey),this.addEventListener(isIElt11?"beforepaste":"paste",onPaste),this.addEventListener("drop",onDrop),this.addEventListener(isPresto?"keypress":"keydown",onKey),this._keyHandlers=Object.create(keyHandlers),this.setConfig(config),isIElt11&&(win.Text.prototype.splitText=function(offset){var afterSplit=this.ownerDocument.createTextNode(this.data.slice(offset)),next=this.nextSibling,parent=this.parentNode,toDelete=this.length-offset;return next?parent.insertBefore(afterSplit,next):parent.appendChild(afterSplit),toDelete&&this.deleteData(offset,toDelete),afterSplit}),root.setAttribute("contenteditable","true");try{doc.execCommand("enableObjectResizing",!1,"false"),doc.execCommand("enableInlineTableEditing",!1,"false")}catch(error){}root.__squire__=this,this.setHTML("")}var proto=Squire.prototype,sanitizeToDOMFragment=function(html,isPaste,self){var doc=self._doc,frag=html?DOMPurify.sanitize(html,{ALLOW_UNKNOWN_PROTOCOLS:!0,WHOLE_DOCUMENT:!1,RETURN_DOM:!0,RETURN_DOM_FRAGMENT:!0}):null;return frag?doc.importNode(frag,!0):doc.createDocumentFragment()};proto.setConfig=function(config){return(config=mergeObjects({blockTag:"DIV",blockAttributes:null,tagAttributes:{blockquote:null,ul:null,ol:null,li:null,a:null},classNames:{colour:"colour",fontFamily:"font",fontSize:"size",highlight:"highlight"},leafNodeNames:leafNodeNames,undo:{documentSizeThreshold:-1,undoLimit:-1},isInsertedHTMLSanitized:!0,isSetHTMLSanitized:!0,sanitizeToDOMFragment:"undefined"!=typeof DOMPurify&&DOMPurify.isSupported?sanitizeToDOMFragment:null,willCutCopy:null},config,!0)).blockTag=config.blockTag.toUpperCase(),this._config=config,this},proto.createElement=function(tag,props,children){return createElement(this._doc,tag,props,children)},proto.createDefaultBlock=function(children){var config=this._config;return fixCursor(this.createElement(config.blockTag,config.blockAttributes,children),this._root)},proto.didError=function(error){console.log(error)},proto.getDocument=function(){return this._doc},proto.getRoot=function(){return this._root},proto.modifyDocument=function(modificationCallback){var mutation=this._mutation;mutation&&(mutation.takeRecords().length&&this._docWasChanged(),mutation.disconnect()),this._ignoreAllChanges=!0,modificationCallback(),this._ignoreAllChanges=!1,mutation&&(mutation.observe(this._root,{childList:!0,attributes:!0,characterData:!0,subtree:!0}),this._ignoreChange=!1)};var customEvents={pathChange:1,select:1,input:1,undoStateChange:1};proto.fireEvent=function(type,event){var isFocused,l,obj,handlers=this._events[type];if(/^(?:focus|blur)/.test(type))if(isFocused=this._root===this._doc.activeElement,"focus"===type){if(!isFocused||this._isFocused)return this;this._isFocused=!0}else{if(isFocused||!this._isFocused)return this;this._isFocused=!1}if(handlers)for(event||(event={}),event.type!==type&&(event.type=type),l=(handlers=handlers.slice()).length;l--;){obj=handlers[l];try{obj.handleEvent?obj.handleEvent(event):obj.call(this,event)}catch(error){error.details="Squire: fireEvent error. Event type: "+type,this.didError(error)}}return this},proto.destroy=function(){var type,events=this._events;for(type in events)this.removeEventListener(type);this._mutation&&this._mutation.disconnect(),delete this._root.__squire__,this._undoIndex=-1,this._undoStack=[],this._undoStackLength=0},proto.handleEvent=function(event){this.fireEvent(event.type,event)},proto.addEventListener=function(type,fn){var handlers=this._events[type],target=this._root;return fn?(handlers||(handlers=this._events[type]=[],customEvents[type]||("selectionchange"===type&&(target=this._doc),target.addEventListener(type,this,!0))),handlers.push(fn),this):(this.didError({name:"Squire: addEventListener with null or undefined fn",message:"Event type: "+type}),this)},proto.removeEventListener=function(type,fn){var l,handlers=this._events[type],target=this._root;if(handlers){if(fn)for(l=handlers.length;l--;)handlers[l]===fn&&handlers.splice(l,1);else handlers.length=0;handlers.length||(delete this._events[type],customEvents[type]||("selectionchange"===type&&(target=this._doc),target.removeEventListener(type,this,!0)))}return this},proto.createRange=function(range,startOffset,endContainer,endOffset){if(range instanceof this._win.Range)return range.cloneRange();var domRange=this._doc.createRange();return domRange.setStart(range,startOffset),endContainer?domRange.setEnd(endContainer,endOffset):domRange.setEnd(range,startOffset),domRange},proto.getCursorPosition=function(range){if(!range&&!(range=this.getSelection())||!range.getBoundingClientRect)return null;var node,parent,rect=range.getBoundingClientRect();return rect&&!rect.top&&(this._ignoreChange=!0,(node=this._doc.createElement("SPAN")).textContent=ZWS,insertNodeInRange(range,node),rect=node.getBoundingClientRect(),(parent=node.parentNode).removeChild(node),mergeInlines(parent,range)),rect},proto._moveCursorTo=function(toStart){var root=this._root,range=this.createRange(root,toStart?0:root.childNodes.length);return moveRangeBoundariesDownTree(range),this.setSelection(range),this},proto.moveCursorToStart=function(){return this._moveCursorTo(!0)},proto.moveCursorToEnd=function(){return this._moveCursorTo(!1)};var getWindowSelection=function(self){return self._win.getSelection()||null};function enableRestoreSelection(){this._restoreSelection=!0}function disableRestoreSelection(){this._restoreSelection=!1}function restoreSelection(){this._restoreSelection&&this.setSelection(this._lastSelection)}proto.setSelection=function(range){if(range)if(this._lastSelection=range,this._isFocused)if(isAndroid&&!this._restoreSelection)enableRestoreSelection.call(this),this.blur(),this.focus();else{isIOS&&this._win.focus();var sel=getWindowSelection(this);sel&&(sel.removeAllRanges(),sel.addRange(range))}else enableRestoreSelection.call(this);return this},proto.getSelection=function(){var selection,startContainer,endContainer,node,sel=getWindowSelection(this),root=this._root;return this._isFocused&&sel&&sel.rangeCount&&(startContainer=(selection=sel.getRangeAt(0).cloneRange()).startContainer,endContainer=selection.endContainer,startContainer&&isLeaf(startContainer)&&selection.setStartBefore(startContainer),endContainer&&isLeaf(endContainer)&&selection.setEndBefore(endContainer)),selection&&isOrContains(root,selection.commonAncestorContainer)?this._lastSelection=selection:isOrContains((node=(selection=this._lastSelection).commonAncestorContainer).ownerDocument,node)||(selection=null),selection||(selection=this.createRange(root.firstChild,0)),selection},proto.getSelectedText=function(){var range=this.getSelection();if(!range||range.collapsed)return"";var value,walker=new TreeWalker(range.commonAncestorContainer,4|SHOW_ELEMENT,function(node){return isNodeContainedInRange(range,node,!0)}),startContainer=range.startContainer,endContainer=range.endContainer,node=walker.currentNode=startContainer,textContent="",addedTextInBlock=!1;for(walker.filter(node)||(node=walker.nextNode());node;)node.nodeType===TEXT_NODE?(value=node.data)&&/\S/.test(value)&&(node===endContainer&&(value=value.slice(0,range.endOffset)),node===startContainer&&(value=value.slice(range.startOffset)),textContent+=value,addedTextInBlock=!0):("BR"===node.nodeName||addedTextInBlock&&!isInline(node))&&(textContent+="\n",addedTextInBlock=!1),node=walker.nextNode();return textContent},proto.getPath=function(){return this._path};var removeZWS=function(root,keepNode){for(var parent,node,index,walker=new TreeWalker(root,4);node=walker.nextNode();)for(;(index=node.data.indexOf(ZWS))>-1&&(!keepNode||node.parentNode!==keepNode);){if(1===node.length){do{(parent=node.parentNode).removeChild(node),node=parent,walker.currentNode=parent}while(isInline(node)&&!getLength(node));break}node.deleteData(index,1)}};proto._didAddZWS=function(){this._hasZWS=!0},proto._removeZWS=function(){this._hasZWS&&(removeZWS(this._root),this._hasZWS=!1)},proto._updatePath=function(range,force){if(range){var newPath,anchor=range.startContainer,focus=range.endContainer;(force||anchor!==this._lastAnchorNode||focus!==this._lastFocusNode)&&(this._lastAnchorNode=anchor,this._lastFocusNode=focus,newPath=anchor&&focus?anchor===focus?function getPath(node,root,config){var id,className,classNames,dir,styleNames,path="";return node&&node!==root&&(path=getPath(node.parentNode,root,config),node.nodeType===ELEMENT_NODE&&(path+=(path?">":"")+node.nodeName,(id=node.id)&&(path+="#"+id),(className=node.className.trim())&&((classNames=className.split(/\s\s*/)).sort(),path+=".",path+=classNames.join(".")),(dir=node.dir)&&(path+="[dir="+dir+"]"),classNames&&(styleNames=config.classNames,indexOf.call(classNames,styleNames.highlight)>-1&&(path+="[backgroundColor="+node.style.backgroundColor.replace(/ /g,"")+"]"),indexOf.call(classNames,styleNames.colour)>-1&&(path+="[color="+node.style.color.replace(/ /g,"")+"]"),indexOf.call(classNames,styleNames.fontFamily)>-1&&(path+="[fontFamily="+node.style.fontFamily.replace(/ /g,"")+"]"),indexOf.call(classNames,styleNames.fontSize)>-1&&(path+="[fontSize="+node.style.fontSize+"]")))),path}(focus,this._root,this._config):"(selection)":"",this._path!==newPath&&(this._path=newPath,this.fireEvent("pathChange",{path:newPath}))),this.fireEvent(range.collapsed?"cursor":"select",{range:range})}},proto._updatePathOnEvent=function(event){var self=this;self._isFocused&&!self._willUpdatePath&&(self._willUpdatePath=!0,setTimeout(function(){self._willUpdatePath=!1,self._updatePath(self.getSelection())},0))},proto.focus=function(){return this._root.focus(),isIE&&this.fireEvent("focus"),this},proto.blur=function(){return this._root.blur(),isIE&&this.fireEvent("blur"),this};var endSelectionId="squire-selection-end";proto._saveRangeToBookmark=function(range){var temp,startNode=this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),endNode=this.createElement("INPUT",{id:endSelectionId,type:"hidden"});insertNodeInRange(range,startNode),range.collapse(!1),insertNodeInRange(range,endNode),2&startNode.compareDocumentPosition(endNode)&&(startNode.id=endSelectionId,endNode.id="squire-selection-start",temp=startNode,startNode=endNode,endNode=temp),range.setStartAfter(startNode),range.setEndBefore(endNode)},proto._getRangeAndRemoveBookmark=function(range){var root=this._root,start=root.querySelector("#squire-selection-start"),end=root.querySelector("#"+endSelectionId);if(start&&end){var startContainer=start.parentNode,endContainer=end.parentNode,startOffset=indexOf.call(startContainer.childNodes,start),endOffset=indexOf.call(endContainer.childNodes,end);startContainer===endContainer&&(endOffset-=1),detach(start),detach(end),range||(range=this._doc.createRange()),range.setStart(startContainer,startOffset),range.setEnd(endContainer,endOffset),mergeInlines(startContainer,range),startContainer!==endContainer&&mergeInlines(endContainer,range),range.collapsed&&(startContainer=range.startContainer).nodeType===TEXT_NODE&&((endContainer=startContainer.childNodes[range.startOffset])&&endContainer.nodeType===TEXT_NODE||(endContainer=startContainer.childNodes[range.startOffset-1]),endContainer&&endContainer.nodeType===TEXT_NODE&&(range.setStart(endContainer,0),range.collapse(!0)))}return range||null},proto._keyUpDetectChange=function(event){var code=event.keyCode;event.ctrlKey||event.metaKey||event.altKey||!(code<16||code>20)||!(code<33||code>45)||this._docWasChanged()},proto._docWasChanged=function(){canWeakMap&&(nodeCategoryCache=new WeakMap),this._ignoreAllChanges||(canObserveMutations&&this._ignoreChange?this._ignoreChange=!1:(this._isInUndoState&&(this._isInUndoState=!1,this.fireEvent("undoStateChange",{canUndo:!0,canRedo:!1})),this.fireEvent("input")))},proto._recordUndoState=function(range,replace){if(!this._isInUndoState||replace){var html,undoIndex=this._undoIndex,undoStack=this._undoStack,undoConfig=this._config.undo,undoThreshold=undoConfig.documentSizeThreshold,undoLimit=undoConfig.undoLimit;replace||(undoIndex+=1),undoIndex<this._undoStackLength&&(undoStack.length=this._undoStackLength=undoIndex),range&&this._saveRangeToBookmark(range),html=this._getHTML(),undoThreshold>-1&&2*html.length>undoThreshold&&undoLimit>-1&&undoIndex>undoLimit&&(undoStack.splice(0,undoIndex-undoLimit),undoIndex=undoLimit,this._undoStackLength=undoLimit),undoStack[undoIndex]=html,this._undoIndex=undoIndex,this._undoStackLength+=1,this._isInUndoState=!0}},proto.saveUndoState=function(range){return range===undefined&&(range=this.getSelection()),this._recordUndoState(range,this._isInUndoState),this._getRangeAndRemoveBookmark(range),this},proto.undo=function(){if(0!==this._undoIndex||!this._isInUndoState){this._recordUndoState(this.getSelection(),!1),this._undoIndex-=1,this._setHTML(this._undoStack[this._undoIndex]);var range=this._getRangeAndRemoveBookmark();range&&this.setSelection(range),this._isInUndoState=!0,this.fireEvent("undoStateChange",{canUndo:0!==this._undoIndex,canRedo:!0}),this.fireEvent("input")}return this},proto.redo=function(){var undoIndex=this._undoIndex,undoStackLength=this._undoStackLength;if(undoIndex+1<undoStackLength&&this._isInUndoState){this._undoIndex+=1,this._setHTML(this._undoStack[this._undoIndex]);var range=this._getRangeAndRemoveBookmark();range&&this.setSelection(range),this.fireEvent("undoStateChange",{canUndo:!0,canRedo:undoIndex+2<undoStackLength}),this.fireEvent("input")}return this},proto.hasFormat=function(tag,attributes,range){if(tag=tag.toUpperCase(),attributes||(attributes={}),!range&&!(range=this.getSelection()))return!1;!range.collapsed&&range.startContainer.nodeType===TEXT_NODE&&range.startOffset===range.startContainer.length&&range.startContainer.nextSibling&&range.setStartBefore(range.startContainer.nextSibling),!range.collapsed&&range.endContainer.nodeType===TEXT_NODE&&0===range.endOffset&&range.endContainer.previousSibling&&range.setEndAfter(range.endContainer.previousSibling);var walker,node,root=this._root,common=range.commonAncestorContainer;if(getNearest(common,root,tag,attributes))return!0;if(common.nodeType===TEXT_NODE)return!1;walker=new TreeWalker(common,4,function(node){return isNodeContainedInRange(range,node,!0)});for(var seenNode=!1;node=walker.nextNode();){if(!getNearest(node,root,tag,attributes))return!1;seenNode=!0}return seenNode},proto.getFontInfo=function(range){var element,style,attr,fontInfo={color:undefined,backgroundColor:undefined,family:undefined,size:undefined},seenAttributes=0;if(!range&&!(range=this.getSelection()))return fontInfo;if(element=range.commonAncestorContainer,range.collapsed||element.nodeType===TEXT_NODE)for(element.nodeType===TEXT_NODE&&(element=element.parentNode);seenAttributes<4&&element;)(style=element.style)&&(!fontInfo.color&&(attr=style.color)&&(fontInfo.color=attr,seenAttributes+=1),!fontInfo.backgroundColor&&(attr=style.backgroundColor)&&(fontInfo.backgroundColor=attr,seenAttributes+=1),!fontInfo.family&&(attr=style.fontFamily)&&(fontInfo.family=attr,seenAttributes+=1),!fontInfo.size&&(attr=style.fontSize)&&(fontInfo.size=attr,seenAttributes+=1)),element=element.parentNode;return fontInfo},proto._addFormat=function(tag,attributes,range){var el,walker,startContainer,endContainer,startOffset,endOffset,node,block,root=this._root;if(range.collapsed){for(el=fixCursor(this.createElement(tag,attributes),root),insertNodeInRange(range,el),range.setStart(el.firstChild,el.firstChild.length),range.collapse(!0),block=el;isInline(block);)block=block.parentNode;removeZWS(block,el)}else{if(walker=new TreeWalker(range.commonAncestorContainer,4|SHOW_ELEMENT,function(node){return(node.nodeType===TEXT_NODE||"BR"===node.nodeName||"IMG"===node.nodeName)&&isNodeContainedInRange(range,node,!0)}),startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset,walker.currentNode=startContainer,walker.filter(startContainer)||(startContainer=walker.nextNode(),startOffset=0),!startContainer)return range;do{!getNearest(node=walker.currentNode,root,tag,attributes)&&(node===endContainer&&node.length>endOffset&&node.splitText(endOffset),node===startContainer&&startOffset&&(node=node.splitText(startOffset),endContainer===startContainer&&(endContainer=node,endOffset-=startOffset),startContainer=node,startOffset=0),replaceWith(node,el=this.createElement(tag,attributes)),el.appendChild(node))}while(walker.nextNode());endContainer.nodeType!==TEXT_NODE&&(node.nodeType===TEXT_NODE?(endContainer=node,endOffset=node.length):(endContainer=node.parentNode,endOffset=1)),range=this.createRange(startContainer,startOffset,endContainer,endOffset)}return range},proto._removeFormat=function(tag,attributes,range,partial){this._saveRangeToBookmark(range);var fixer,doc=this._doc;range.collapsed&&(cantFocusEmptyTextNodes?(fixer=doc.createTextNode(ZWS),this._didAddZWS()):fixer=doc.createTextNode(""),insertNodeInRange(range,fixer));for(var root=range.commonAncestorContainer;isInline(root);)root=root.parentNode;var startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset,toWrap=[],examineNode=function(node,exemplar){if(!isNodeContainedInRange(range,node,!1)){var child,next,isText=node.nodeType===TEXT_NODE;if(isNodeContainedInRange(range,node,!0))if(isText)node===endContainer&&endOffset!==node.length&&toWrap.push([exemplar,node.splitText(endOffset)]),node===startContainer&&startOffset&&(node.splitText(startOffset),toWrap.push([exemplar,node]));else for(child=node.firstChild;child;child=next)next=child.nextSibling,examineNode(child,exemplar);else"INPUT"===node.nodeName||isText&&!node.data||toWrap.push([exemplar,node])}},formatTags=Array.prototype.filter.call(root.getElementsByTagName(tag),function(el){return isNodeContainedInRange(range,el,!0)&&hasTagAttributes(el,tag,attributes)});return partial||formatTags.forEach(function(node){examineNode(node,node)}),toWrap.forEach(function(item){var el=item[0].cloneNode(!1),node=item[1];replaceWith(node,el),el.appendChild(node)}),formatTags.forEach(function(el){replaceWith(el,empty(el))}),this._getRangeAndRemoveBookmark(range),fixer&&range.collapse(!1),mergeInlines(root,range),range},proto.changeFormat=function(add,remove,range,partial){return range||(range=this.getSelection())?(this.saveUndoState(range),remove&&(range=this._removeFormat(remove.tag.toUpperCase(),remove.attributes||{},range,partial)),add&&(range=this._addFormat(add.tag.toUpperCase(),add.attributes||{},range)),this.setSelection(range),this._updatePath(range,!0),canObserveMutations||this._docWasChanged(),this):this};var tagAfterSplit={DT:"DD",DD:"DT",LI:"LI",PRE:"PRE"},splitBlock=function(self,block,node,offset){var splitTag=tagAfterSplit[block.nodeName],splitProperties=null,nodeAfterSplit=split(node,offset,block.parentNode,self._root),config=self._config;return splitTag||(splitTag=config.blockTag,splitProperties=config.blockAttributes),hasTagAttributes(nodeAfterSplit,splitTag,splitProperties)||(block=createElement(nodeAfterSplit.ownerDocument,splitTag,splitProperties),nodeAfterSplit.dir&&(block.dir=nodeAfterSplit.dir),replaceWith(nodeAfterSplit,block),block.appendChild(empty(nodeAfterSplit)),nodeAfterSplit=block),nodeAfterSplit};proto.forEachBlock=function(fn,mutates,range){if(!range&&!(range=this.getSelection()))return this;mutates&&this.saveUndoState(range);var root=this._root,start=getStartBlockOfRange(range,root),end=getEndBlockOfRange(range,root);if(start&&end)do{if(fn(start)||start===end)break}while(start=getNextBlock(start,root));return mutates&&(this.setSelection(range),this._updatePath(range,!0),canObserveMutations||this._docWasChanged()),this},proto.modifyBlocks=function(modify,range){if(!range&&!(range=this.getSelection()))return this;this._recordUndoState(range,this._isInUndoState);var frag,root=this._root;return expandRangeToBlockBoundaries(range,root),moveRangeBoundariesUpTree(range,root,root,root),frag=extractContentsOfRange(range,root,root),insertNodeInRange(range,modify.call(this,frag)),range.endOffset<range.endContainer.childNodes.length&&mergeContainers(range.endContainer.childNodes[range.endOffset],root),mergeContainers(range.startContainer.childNodes[range.startOffset],root),this._getRangeAndRemoveBookmark(range),this.setSelection(range),this._updatePath(range,!0),canObserveMutations||this._docWasChanged(),this};var decreaseBlockQuoteLevel=function(frag){var root=this._root,blockquotes=frag.querySelectorAll("blockquote");return Array.prototype.filter.call(blockquotes,function(el){return!getNearest(el.parentNode,root,"BLOCKQUOTE")}).forEach(function(el){replaceWith(el,empty(el))}),frag},removeBlockQuote=function(){return this.createDefaultBlock([this.createElement("INPUT",{id:"squire-selection-start",type:"hidden"}),this.createElement("INPUT",{id:endSelectionId,type:"hidden"})])},makeList=function(self,frag,type){for(var node,tag,prev,newLi,walker=getBlockWalker(frag,self._root),tagAttributes=self._config.tagAttributes,listAttrs=tagAttributes[type.toLowerCase()],listItemAttrs=tagAttributes.li;node=walker.nextNode();)"LI"===node.parentNode.nodeName&&(node=node.parentNode,walker.currentNode=node.lastChild),"LI"!==node.nodeName?(newLi=self.createElement("LI",listItemAttrs),node.dir&&(newLi.dir=node.dir),(prev=node.previousSibling)&&prev.nodeName===type?(prev.appendChild(newLi),detach(node)):replaceWith(node,self.createElement(type,listAttrs,[newLi])),newLi.appendChild(empty(node)),walker.currentNode=newLi):(tag=(node=node.parentNode).nodeName)!==type&&/^[OU]L$/.test(tag)&&replaceWith(node,self.createElement(type,listAttrs,[empty(node)]))},getListSelection=function(range,root){for(var list=range.commonAncestorContainer,startLi=range.startContainer,endLi=range.endContainer;list&&list!==root&&!/^[OU]L$/.test(list.nodeName);)list=list.parentNode;if(!list||list===root)return null;for(startLi===list&&(startLi=startLi.childNodes[range.startOffset]),endLi===list&&(endLi=endLi.childNodes[range.endOffset]);startLi&&startLi.parentNode!==list;)startLi=startLi.parentNode;for(;endLi&&endLi.parentNode!==list;)endLi=endLi.parentNode;return[list,startLi,endLi]};proto.increaseListLevel=function(range){if(!range&&!(range=this.getSelection()))return this.focus();var root=this._root,listSelection=getListSelection(range,root);if(!listSelection)return this.focus();var list=listSelection[0],startLi=listSelection[1],endLi=listSelection[2];if(!startLi||startLi===list.firstChild)return this.focus();this._recordUndoState(range,this._isInUndoState);var listAttrs,next,type=list.nodeName,newParent=startLi.previousSibling;newParent.nodeName!==type&&(listAttrs=this._config.tagAttributes[type.toLowerCase()],newParent=this.createElement(type,listAttrs),list.insertBefore(newParent,startLi));do{next=startLi===endLi?null:startLi.nextSibling,newParent.appendChild(startLi)}while(startLi=next);return(next=newParent.nextSibling)&&mergeContainers(next,root),this._getRangeAndRemoveBookmark(range),this.setSelection(range),this._updatePath(range,!0),canObserveMutations||this._docWasChanged(),this.focus()},proto.decreaseListLevel=function(range){if(!range&&!(range=this.getSelection()))return this.focus();var root=this._root,listSelection=getListSelection(range,root);if(!listSelection)return this.focus();var list=listSelection[0],startLi=listSelection[1],endLi=listSelection[2];startLi||(startLi=list.firstChild),endLi||(endLi=list.lastChild),this._recordUndoState(range,this._isInUndoState);var next,newParent=list.parentNode,insertBefore=endLi.nextSibling?split(list,endLi.nextSibling,newParent,root):list.nextSibling;if(newParent!==root&&"LI"===newParent.nodeName){for(newParent=newParent.parentNode;insertBefore;)next=insertBefore.nextSibling,endLi.appendChild(insertBefore),insertBefore=next;insertBefore=list.parentNode.nextSibling}var makeNotList=!/^[OU]L$/.test(newParent.nodeName);do{next=startLi===endLi?null:startLi.nextSibling,list.removeChild(startLi),makeNotList&&"LI"===startLi.nodeName&&(startLi=this.createDefaultBlock([empty(startLi)])),newParent.insertBefore(startLi,insertBefore)}while(startLi=next);return list.firstChild||detach(list),insertBefore&&mergeContainers(insertBefore,root),this._getRangeAndRemoveBookmark(range),this.setSelection(range),this._updatePath(range,!0),canObserveMutations||this._docWasChanged(),this.focus()},proto._ensureBottomLine=function(){var root=this._root,last=root.lastElementChild;last&&last.nodeName===this._config.blockTag&&isBlock(last)||root.appendChild(this.createDefaultBlock())},proto.setKeyHandler=function(key,fn){return this._keyHandlers[key]=fn,this},proto._getHTML=function(){return this._root.innerHTML},proto._setHTML=function(html){var root=this._root,node=root;node.innerHTML=html;do{fixCursor(node,root)}while(node=getNextBlock(node,root));this._ignoreChange=!0},proto.getHTML=function(withBookMark){var root,node,fixer,html,l,range,brs=[];if(withBookMark&&(range=this.getSelection())&&this._saveRangeToBookmark(range),useTextFixer)for(node=root=this._root;node=getNextBlock(node,root);)node.textContent||node.querySelector("BR")||(fixer=this.createElement("BR"),node.appendChild(fixer),brs.push(fixer));if(html=this._getHTML().replace(/\u200B/g,""),useTextFixer)for(l=brs.length;l--;)detach(brs[l]);return range&&this._getRangeAndRemoveBookmark(range),html},proto.setHTML=function(html){var div,frag,child,config=this._config,sanitizeToDOMFragment=config.isSetHTMLSanitized?config.sanitizeToDOMFragment:null,root=this._root;"function"==typeof sanitizeToDOMFragment?frag=sanitizeToDOMFragment(html,!1,this):((div=this.createElement("DIV")).innerHTML=html,(frag=this._doc.createDocumentFragment()).appendChild(empty(div))),cleanTree(frag,config),cleanupBRs(frag,root,!1),fixContainer(frag,root);for(var node=frag;node=getNextBlock(node,root);)fixCursor(node,root);for(this._ignoreChange=!0;child=root.lastChild;)root.removeChild(child);root.appendChild(frag),fixCursor(root,root),this._undoIndex=-1,this._undoStack.length=0,this._undoStackLength=0,this._isInUndoState=!1;var range=this._getRangeAndRemoveBookmark()||this.createRange(root.firstChild,0);return this.saveUndoState(range),this._lastSelection=range,enableRestoreSelection.call(this),this._updatePath(range,!0),this},proto.insertElement=function(el,range){if(range||(range=this.getSelection()),range.collapse(!0),isInline(el))insertNodeInRange(range,el),range.setStartAfter(el);else{for(var nodeAfterSplit,root=this._root,splitNode=getStartBlockOfRange(range,root)||root;splitNode!==root&&!splitNode.nextSibling;)splitNode=splitNode.parentNode;splitNode!==root&&(nodeAfterSplit=split(splitNode.parentNode,splitNode.nextSibling,root,root)),nodeAfterSplit?root.insertBefore(el,nodeAfterSplit):(root.appendChild(el),nodeAfterSplit=this.createDefaultBlock(),root.appendChild(nodeAfterSplit)),range.setStart(nodeAfterSplit,0),range.setEnd(nodeAfterSplit,0),moveRangeBoundariesDownTree(range)}return this.focus(),this.setSelection(range),this._updatePath(range),canObserveMutations||this._docWasChanged(),this},proto.insertImage=function(src,attributes){var img=this.createElement("IMG",mergeObjects({src:src},attributes,!0));return this.insertElement(img),img},proto.linkRegExp=/\b((?:(?:ht|f)tps?:\/\/|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,}\/)(?:[^\s()<>]+|\([^\s()<>]+\))+(?:\((?:[^\s()<>]+|(?:\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'".,<>?«»“”‘’]))|([\w\-.%+]+@(?:[\w\-]+\.)+[A-Z]{2,}\b)(?:\?[^&?\s]+=[^&?\s]+(?:&[^&?\s]+=[^&?\s]+)*)?/i;var addLinks=function(frag,root,self){var node,data,parent,match,index,endIndex,child,doc=frag.ownerDocument,walker=new TreeWalker(frag,4,function(node){return!getNearest(node,root,"A")}),linkRegExp=self.linkRegExp,defaultAttributes=self._config.tagAttributes.a;if(linkRegExp)for(;node=walker.nextNode();)for(data=node.data,parent=node.parentNode;match=linkRegExp.exec(data);)endIndex=(index=match.index)+match[0].length,index&&(child=doc.createTextNode(data.slice(0,index)),parent.insertBefore(child,node)),(child=self.createElement("A",mergeObjects({href:match[1]?/^(?:ht|f)tps?:/i.test(match[1])?match[1]:"http://"+match[1]:"mailto:"+match[0]},defaultAttributes,!1))).textContent=data.slice(index,endIndex),parent.insertBefore(child,node),node.data=data=data.slice(endIndex)};proto.insertHTML=function(html,isPaste){var startFragmentIndex,endFragmentIndex,div,frag,root,node,event,config=this._config,sanitizeToDOMFragment=config.isInsertedHTMLSanitized?config.sanitizeToDOMFragment:null,range=this.getSelection(),doc=this._doc;"function"==typeof sanitizeToDOMFragment?frag=sanitizeToDOMFragment(html,isPaste,this):(isPaste&&(startFragmentIndex=html.indexOf("\x3c!--StartFragment--\x3e"),endFragmentIndex=html.lastIndexOf("\x3c!--EndFragment--\x3e"),startFragmentIndex>-1&&endFragmentIndex>-1&&(html=html.slice(startFragmentIndex+20,endFragmentIndex))),/<\/td>((?!<\/tr>)[\s\S])*$/i.test(html)&&(html="<TR>"+html+"</TR>"),/<\/tr>((?!<\/table>)[\s\S])*$/i.test(html)&&(html="<TABLE>"+html+"</TABLE>"),(div=this.createElement("DIV")).innerHTML=html,(frag=doc.createDocumentFragment()).appendChild(empty(div))),this.saveUndoState(range);try{for(root=this._root,node=frag,event={fragment:frag,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},addLinks(frag,frag,this),cleanTree(frag,config),cleanupBRs(frag,root,!1),removeEmptyInlines(frag),frag.normalize();node=getNextBlock(node,frag);)fixCursor(node,root);isPaste&&this.fireEvent("willPaste",event),event.defaultPrevented||(insertTreeFragmentIntoRange(range,event.fragment,root),canObserveMutations||this._docWasChanged(),range.collapse(!1),this._ensureBottomLine()),this.setSelection(range),this._updatePath(range,!0),isPaste&&this.focus()}catch(error){this.didError(error)}return this};var escapeHTMLFragement=function(text){return text.split("&").join("&amp;").split("<").join("&lt;").split(">").join("&gt;").split('"').join("&quot;")};proto.insertPlainText=function(plainText,isPaste){var range=this.getSelection();if(range.collapsed&&getNearest(range.startContainer,this._root,"PRE")){var text,event,node=range.startContainer,offset=range.startOffset;return node&&node.nodeType===TEXT_NODE||(text=this._doc.createTextNode(""),node.insertBefore(text,node.childNodes[offset]),node=text,offset=0),event={text:plainText,preventDefault:function(){this.defaultPrevented=!0},defaultPrevented:!1},isPaste&&this.fireEvent("willPaste",event),event.defaultPrevented||(plainText=event.text,node.insertData(offset,plainText),range.setStart(node,offset+plainText.length),range.collapse(!0)),this.setSelection(range),this}var attr,i,l,line,lines=plainText.split("\n"),config=this._config,tag=config.blockTag,attributes=config.blockAttributes,closeBlock="</"+tag+">",openBlock="<"+tag;for(attr in attributes)openBlock+=" "+attr+'="'+escapeHTMLFragement(attributes[attr])+'"';for(openBlock+=">",i=0,l=lines.length;i<l;i+=1)line=lines[i],line=escapeHTMLFragement(line).replace(/ (?= )/g,"&nbsp;"),lines[i]=openBlock+(line||"<BR>")+closeBlock;return this.insertHTML(lines.join(""),isPaste)};var command=function(method,arg,arg2){return function(){return this[method](arg,arg2),this.focus()}};proto.addStyles=function(styles){if(styles){var head=this._doc.documentElement.firstChild,style=this.createElement("STYLE",{type:"text/css"});style.appendChild(this._doc.createTextNode(styles)),head.appendChild(style)}return this},proto.bold=command("changeFormat",{tag:"B"}),proto.italic=command("changeFormat",{tag:"I"}),proto.underline=command("changeFormat",{tag:"U"}),proto.strikethrough=command("changeFormat",{tag:"S"}),proto.subscript=command("changeFormat",{tag:"SUB"},{tag:"SUP"}),proto.superscript=command("changeFormat",{tag:"SUP"},{tag:"SUB"}),proto.removeBold=command("changeFormat",null,{tag:"B"}),proto.removeItalic=command("changeFormat",null,{tag:"I"}),proto.removeUnderline=command("changeFormat",null,{tag:"U"}),proto.removeStrikethrough=command("changeFormat",null,{tag:"S"}),proto.removeSubscript=command("changeFormat",null,{tag:"SUB"}),proto.removeSuperscript=command("changeFormat",null,{tag:"SUP"}),proto.makeLink=function(url,attributes){var range=this.getSelection();if(range.collapsed){var protocolEnd=url.indexOf(":")+1;if(protocolEnd)for(;"/"===url[protocolEnd];)protocolEnd+=1;insertNodeInRange(range,this._doc.createTextNode(url.slice(protocolEnd)))}return attributes=mergeObjects(mergeObjects({href:url},attributes,!0),this._config.tagAttributes.a,!1),this.changeFormat({tag:"A",attributes:attributes},{tag:"A"},range),this.focus()},proto.removeLink=function(){return this.changeFormat(null,{tag:"A"},this.getSelection(),!0),this.focus()},proto.setFontFace=function(name){var className=this._config.classNames.fontFamily;return this.changeFormat(name?{tag:"SPAN",attributes:{class:className,style:"font-family: "+name+", sans-serif;"}}:null,{tag:"SPAN",attributes:{class:className}}),this.focus()},proto.setFontSize=function(size){var className=this._config.classNames.fontSize;return this.changeFormat(size?{tag:"SPAN",attributes:{class:className,style:"font-size: "+("number"==typeof size?size+"px":size)}}:null,{tag:"SPAN",attributes:{class:className}}),this.focus()},proto.setTextColour=function(colour){var className=this._config.classNames.colour;return this.changeFormat(colour?{tag:"SPAN",attributes:{class:className,style:"color:"+colour}}:null,{tag:"SPAN",attributes:{class:className}}),this.focus()},proto.setHighlightColour=function(colour){var className=this._config.classNames.highlight;return this.changeFormat(colour?{tag:"SPAN",attributes:{class:className,style:"background-color:"+colour}}:colour,{tag:"SPAN",attributes:{class:className}}),this.focus()},proto.setTextAlignment=function(alignment){return this.forEachBlock(function(block){var className=block.className.split(/\s+/).filter(function(klass){return!!klass&&!/^align/.test(klass)}).join(" ");alignment?(block.className=className+" align-"+alignment,block.style.textAlign=alignment):(block.className=className,block.style.textAlign="")},!0),this.focus()},proto.setTextDirection=function(direction){return this.forEachBlock(function(block){direction?block.dir=direction:block.removeAttribute("dir")},!0),this.focus()};var addPre=function(frag){for(var node,root=this._root,document=this._doc,output=document.createDocumentFragment(),walker=getBlockWalker(frag,root);node=walker.nextNode();){var i,br,nodes=node.querySelectorAll("BR"),brBreaksLine=[],l=nodes.length;for(i=0;i<l;i+=1)brBreaksLine[i]=isLineBreak(nodes[i],!1);for(;l--;)br=nodes[l],brBreaksLine[l]?replaceWith(br,document.createTextNode("\n")):detach(br);for(l=(nodes=node.querySelectorAll("CODE")).length;l--;)detach(nodes[l]);output.childNodes.length&&output.appendChild(document.createTextNode("\n")),output.appendChild(empty(node))}for(walker=new TreeWalker(output,4);node=walker.nextNode();)node.data=node.data.replace(/ /g," ");return output.normalize(),fixCursor(this.createElement("PRE",this._config.tagAttributes.pre,[output]),root)},removePre=function(frag){for(var pre,walker,node,value,contents,index,document=this._doc,root=this._root,pres=frag.querySelectorAll("PRE"),l=pres.length;l--;){for(walker=new TreeWalker(pre=pres[l],4);node=walker.nextNode();){for(value=(value=node.data).replace(/ (?= )/g," "),contents=document.createDocumentFragment();(index=value.indexOf("\n"))>-1;)contents.appendChild(document.createTextNode(value.slice(0,index))),contents.appendChild(document.createElement("BR")),value=value.slice(index+1);node.parentNode.insertBefore(contents,node),node.data=value}fixContainer(pre,root),replaceWith(pre,empty(pre))}return frag};proto.code=function(){var range=this.getSelection();return range.collapsed||isContainer(range.commonAncestorContainer)?this.modifyBlocks(addPre,range):this.changeFormat({tag:"CODE",attributes:this._config.tagAttributes.code},null,range),this.focus()},proto.removeCode=function(){var range=this.getSelection();return getNearest(range.commonAncestorContainer,this._root,"PRE")?this.modifyBlocks(removePre,range):this.changeFormat(null,{tag:"CODE"},range),this.focus()},proto.toggleCode=function(){return this.hasFormat("PRE")||this.hasFormat("CODE")?this.removeCode():this.code(),this},proto.removeAllFormatting=function(range){if(!range&&!(range=this.getSelection())||range.collapsed)return this;for(var root=this._root,stopNode=range.commonAncestorContainer;stopNode&&!isBlock(stopNode);)stopNode=stopNode.parentNode;if(stopNode||(expandRangeToBlockBoundaries(range,root),stopNode=root),stopNode.nodeType===TEXT_NODE)return this;this.saveUndoState(range),moveRangeBoundariesUpTree(range,stopNode,stopNode,root);for(var nextNode,childNodes,doc=stopNode.ownerDocument,startContainer=range.startContainer,startOffset=range.startOffset,endContainer=range.endContainer,endOffset=range.endOffset,formattedNodes=doc.createDocumentFragment(),cleanNodes=doc.createDocumentFragment(),nodeAfterSplit=split(endContainer,endOffset,stopNode,root),nodeInSplit=split(startContainer,startOffset,stopNode,root);nodeInSplit!==nodeAfterSplit;)nextNode=nodeInSplit.nextSibling,formattedNodes.appendChild(nodeInSplit),nodeInSplit=nextNode;return function removeFormatting(self,root,clean){var node,next;for(node=root.firstChild;node;node=next){if(next=node.nextSibling,isInline(node)){if(node.nodeType===TEXT_NODE||"BR"===node.nodeName||"IMG"===node.nodeName){clean.appendChild(node);continue}}else if(isBlock(node)){clean.appendChild(self.createDefaultBlock([removeFormatting(self,node,self._doc.createDocumentFragment())]));continue}removeFormatting(self,node,clean)}return clean}(this,formattedNodes,cleanNodes),cleanNodes.normalize(),nodeInSplit=cleanNodes.firstChild,nextNode=cleanNodes.lastChild,childNodes=stopNode.childNodes,nodeInSplit?(stopNode.insertBefore(cleanNodes,nodeAfterSplit),startOffset=indexOf.call(childNodes,nodeInSplit),endOffset=indexOf.call(childNodes,nextNode)+1):endOffset=startOffset=indexOf.call(childNodes,nodeAfterSplit),range.setStart(stopNode,startOffset),range.setEnd(stopNode,endOffset),mergeInlines(stopNode,range),moveRangeBoundariesDownTree(range),this.setSelection(range),this._updatePath(range,!0),this.focus()},proto.increaseQuoteLevel=command("modifyBlocks",function(frag){return this.createElement("BLOCKQUOTE",this._config.tagAttributes.blockquote,[frag])}),proto.decreaseQuoteLevel=command("modifyBlocks",decreaseBlockQuoteLevel),proto.makeUnorderedList=command("modifyBlocks",function(frag){return makeList(this,frag,"UL"),frag}),proto.makeOrderedList=command("modifyBlocks",function(frag){return makeList(this,frag,"OL"),frag}),proto.removeList=command("modifyBlocks",function(frag){var i,l,list,listFrag,item,lists=frag.querySelectorAll("UL, OL"),items=frag.querySelectorAll("LI"),root=this._root;for(i=0,l=lists.length;i<l;i+=1)fixContainer(listFrag=empty(list=lists[i]),root),replaceWith(list,listFrag);for(i=0,l=items.length;i<l;i+=1)isBlock(item=items[i])?replaceWith(item,this.createDefaultBlock([empty(item)])):(fixContainer(item,root),replaceWith(item,empty(item)));return frag}),Squire.isInline=isInline,Squire.isBlock=isBlock,Squire.isContainer=isContainer,Squire.getBlockWalker=getBlockWalker,Squire.getPreviousBlock=getPreviousBlock,Squire.getNextBlock=getNextBlock,Squire.areAlike=areAlike,Squire.hasTagAttributes=hasTagAttributes,Squire.getNearest=getNearest,Squire.isOrContains=isOrContains,Squire.detach=detach,Squire.replaceWith=replaceWith,Squire.empty=empty,Squire.getNodeBefore=getNodeBefore,Squire.getNodeAfter=getNodeAfter,Squire.insertNodeInRange=insertNodeInRange,Squire.extractContentsOfRange=extractContentsOfRange,Squire.deleteContentsOfRange=deleteContentsOfRange,Squire.insertTreeFragmentIntoRange=insertTreeFragmentIntoRange,Squire.isNodeContainedInRange=isNodeContainedInRange,Squire.moveRangeBoundariesDownTree=moveRangeBoundariesDownTree,Squire.moveRangeBoundariesUpTree=moveRangeBoundariesUpTree,Squire.getStartBlockOfRange=getStartBlockOfRange,Squire.getEndBlockOfRange=getEndBlockOfRange,Squire.contentWalker=contentWalker,Squire.rangeDoesStartAtBlockBoundary=rangeDoesStartAtBlockBoundary,Squire.rangeDoesEndAtBlockBoundary=rangeDoesEndAtBlockBoundary,Squire.expandRangeToBlockBoundaries=expandRangeToBlockBoundaries,Squire.onPaste=onPaste,Squire.addLinks=addLinks,Squire.splitBlock=splitBlock,Squire.startSelectionId="squire-selection-start",Squire.endSelectionId=endSelectionId,"object"==typeof exports?module.exports=Squire:System.registerDynamic("libs/squire-raw.js",[],!1,function($__require,$__exports,$__module){return function(){return Squire}.call(this)})}(document),System.register("src/gui/base/Editor.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","squire-rte","../../api/common/utils/Utils","../size","./Dialog","../../misc/FormatValidator.js"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,SquireEditor,defer,px,Dialog,isMailAddress,Editor;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_squireRte){SquireEditor=_squireRte.default},function(_apiCommonUtilsUtils){defer=_apiCommonUtilsUtils.defer},function(_size){px=_size.px},function(_Dialog){Dialog=_Dialog.Dialog},function(_miscFormatValidatorJs){isMailAddress=_miscFormatValidatorJs.isMailAddress}],execute:function(){_export("Editor",Editor=function(){function Editor(minHeight,sanitizer){var _this=this;_classCallCheck(this,Editor),this.styles={b:!1,i:!1,u:!1,c:!1,a:!1,alignment:"left",listing:null},this.hasStyle=function(style){return!!_this._squire&&_this._styleActions[style][2]()},this.getStylesAtPath=function(){if(_this._squire){var pathSegments=_this._squire.getPath().split(">"),ulIndex=pathSegments.lastIndexOf("UL"),olIndex=pathSegments.lastIndexOf("OL");_this.styles.listing=-1===ulIndex?olIndex>-1?"ol":null:-1===olIndex?ulIndex>-1?"ul":null:olIndex>ulIndex?"ol":"ul",_this.styles.a=pathSegments.includes("A");var alignment=pathSegments.find(function(f){return f.includes("align")});if(void 0!==alignment)switch(alignment.split(".")[1].substring(6)){case"left":_this.styles.alignment="left";break;case"right":_this.styles.alignment="right";break;case"center":_this.styles.alignment="center";break;default:_this.styles.alignment="justify"}else _this.styles.alignment="left";_this.styles.c=void 0!==pathSegments.find(function(f){return f.includes("monospace")}),_this.styles.b=_this._squire.hasFormat("b"),_this.styles.u=_this._squire.hasFormat("u"),_this.styles.i=_this._squire.hasFormat("i")}},this._enabled=!0,this._active=!1,this._minHeight=minHeight,this._sanitizer=sanitizer,this.initialized=defer(),this.onbeforeupdate=function(){return!(null!=_this._squire)},this.onremove=function(){_this._squire&&(_this._squire.destroy(),_this._squire=null,_this.initialized=defer())},this._styleActions=Object.freeze({b:[function(){return _this._squire.bold()},function(){return _this._squire.removeBold()},function(){return _this.styles.b}],i:[function(){return _this._squire.italic()},function(){return _this._squire.removeItalic()},function(){return _this.styles.i}],u:[function(){return _this._squire.underline()},function(){return _this._squire.removeUnderline()},function(){return _this.styles.u}],c:[function(){return _this._squire.setFontFace("monospace")},function(){return _this._squire.setFontFace("sans-serif")},function(){return _this.styles.c}],a:[function(){return _this.makeLink()},function(){return _this._squire.removeLink()},function(){return _this.styles.a}]}),this.view=function(){return m(".hide-outline.selectable",{role:"textbox","aria-multiline":"true",oncreate:function(vnode){return _this.initSquire(vnode.dom)},style:_this._minHeight?{"min-height":px(_this._minHeight)}:{}})}}return _createClass(Editor,[{key:"isEmpty",value:function(){return!this._squire||"<div><br></div>"===this._squire.getHTML()}},{key:"getValue",value:function(){return this.isEmpty()?"":this._squire.getHTML()}},{key:"addChangeListener",value:function(callback){this._squire.addEventListener("input",callback)}},{key:"setMinHeight",value:function(minHeight){return this._minHeight=minHeight,this}},{key:"initSquire",value:function(domElement){var _this2=this,squire=new SquireEditor(domElement,{sanitizeToDOMFragment:this._sanitizer}).addEventListener("keyup",function(e){if(32===e.which){var blocks=[];squire.forEachBlock(function(block){blocks.push(block)}),createList(blocks,/^1\.\s$/,!0),createList(blocks,/^\*\s$/,!1)}});function createList(blocks,regex,ordered){1===blocks.length&&blocks[0].textContent.match(regex)&&(squire.modifyBlocks(function(fragment){if(fragment.firstChild&&fragment.firstChild.firstChild){for(var textNode=fragment.firstChild.firstChild;textNode.nodeType!==Node.TEXT_NODE&&null!==textNode.firstChild&&"li"!==textNode.nodeName.toLowerCase();)textNode=textNode.firstChild;textNode.nodeType===Node.TEXT_NODE&&(textNode.textContent=textNode.textContent.replace(regex,""))}return fragment}),ordered?squire.makeOrderedList():squire.makeUnorderedList())}this._squire=squire,this._squire.addEventListener("pathChange",function(){_this2.getStylesAtPath(),m.redraw()}),this._domElement=domElement,this.setEnabled(this._enabled),this.initialized.resolve()}},{key:"setEnabled",value:function(enabled){this._enabled=enabled,this._domElement&&this._domElement.setAttribute("contenteditable",String(enabled))}},{key:"isEnabled",value:function(){return this._enabled}},{key:"setHTML",value:function(html){this._squire.setHTML(html)}},{key:"getHTML",value:function(){return this._squire.getHTML()}},{key:"setStyle",value:function(state,style){(state?this._styleActions[style][0]:this._styleActions[style][1])()}},{key:"makeLink",value:function(){var _this3=this;Dialog.showTextInputDialog("makeLink_action","url_label",null,"",null).then(function(url){isMailAddress(url,!1)?url="mailto:"+url:url.startsWith("http://")||url.startsWith("https://")||url.startsWith("mailto:")||url.startsWith("{")||(url="https://"+url),_this3._squire.makeLink(url)})}},{key:"insertImage",value:function(srcAttr,attrs){return this._squire.insertImage(srcAttr,attrs)}},{key:"getDOM",value:function(){return this._squire.getRoot()}},{key:"focus",value:function(){this._squire.focus(),this.getStylesAtPath()}},{key:"isAttached",value:function(){return null!=this._squire}},{key:"removeAllFormatting",value:function(){var range=document.createRange();range.selectNode(this._squire.getRoot()),this._squire.removeAllFormatting(range)}}]),Editor}()),_export("Editor",Editor)}}}),System.register("src/gui/base/DropDownSelector.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./Button","./TextField","../../api/Env","./icons/Icons","../../api/common/utils/StringUtils","./ButtonN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,Button,createDropDownButton,TextField,assertMainOrNode,Icons,lazyStringValue,ButtonType,DropDownSelector;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_Button){Button=_Button.Button,createDropDownButton=_Button.createDropDownButton},function(_TextField){TextField=_TextField.TextField},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_iconsIcons){Icons=_iconsIcons.Icons},function(_apiCommonUtilsStringUtils){lazyStringValue=_apiCommonUtilsStringUtils.lazyStringValue},function(_ButtonN){ButtonType=_ButtonN.ButtonType}],execute:function(){assertMainOrNode(),_export("DropDownSelector",DropDownSelector=function(){function DropDownSelector(labelIdOrLabelTextFunction,helpLabel,items,selectedValue,dropdownWidth){var _this=this;_classCallCheck(this,DropDownSelector),this.selectedValue=selectedValue,this._items=items,this._field=new TextField(labelIdOrLabelTextFunction,helpLabel).setDisabled(),this._field.value=this.selectedValue.map(function(value){var selectedItem=items.find(function(item){return item.value===_this.selectedValue()});return selectedItem?selectedItem.name:(console.log("Dropdown "+lazyStringValue(_this._field.label)+" couldn't find element for value: "+String(value)),"")});var itemChooser=createDropDownButton(labelIdOrLabelTextFunction,function(){return Icons.Edit},function(){return items.map(function(item){return new Button(function(){return item.name},function(){_this.selectedValue()!==item.value&&(_this._changeHandler?_this._changeHandler(item.value):(_this.selectedValue(item.value),m.redraw()))}).setType(ButtonType.Dropdown).setSelected(function(){return _this.selectedValue()===item.value})})},dropdownWidth||void 0);this._field._injectionsRight=function(){return[m(itemChooser)]},this.view=function(){return m(_this._field)}}return _createClass(DropDownSelector,[{key:"setSelectionChangedHandler",value:function(handler){return this._changeHandler=handler,this}}]),DropDownSelector}()),_export("DropDownSelector",DropDownSelector)}}}),System.register("src/gui/base/RichTextToolbar.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./icons/Icons","mithril/stream/stream.js","../../api/common/utils/ArrayUtils","./ButtonN","../size.js","../../api/common/utils/Utils","./DropdownN","../../misc/LanguageViewModel.js","../animation/Animations","../../misc/ClientDetector","../../misc/ClientConstants"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,Icons,stream,numberRange,ButtonColors,ButtonN,ButtonType,size,noOp,attachDropdown,lang,animations,height,opacity,client,BrowserType,RichTextToolbar;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_iconsIcons){Icons=_iconsIcons.Icons},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiCommonUtilsArrayUtils){numberRange=_apiCommonUtilsArrayUtils.numberRange},function(_ButtonN){ButtonColors=_ButtonN.ButtonColors,ButtonN=_ButtonN.ButtonN,ButtonType=_ButtonN.ButtonType},function(_sizeJs){size=_sizeJs.size},function(_apiCommonUtilsUtils){noOp=_apiCommonUtilsUtils.noOp},function(_DropdownN){attachDropdown=_DropdownN.attachDropdown},function(_miscLanguageViewModelJs){lang=_miscLanguageViewModelJs.lang},function(_animationAnimations){animations=_animationAnimations.animations,height=_animationAnimations.height,opacity=_animationAnimations.opacity},function(_miscClientDetector){client=_miscClientDetector.client},function(_miscClientConstants){BrowserType=_miscClientConstants.BrowserType}],execute:function(){_export("RichTextToolbar",RichTextToolbar=function(){function RichTextToolbar(editor,attachFileHandler){var _this=this;_classCallCheck(this,RichTextToolbar),this.selectedSize=stream(size.font_size_base);var styleToggleAttrs=[{style:"b",title:function(){return lang.get("formatTextBold_msg")+" (Ctrl + B)"},icon:Icons.Bold},{style:"i",title:function(){return lang.get("formatTextItalic_msg")+" (Ctrl + I)"},icon:Icons.Italic},{style:"u",title:function(){return lang.get("formatTextUnderline_msg")+" (Ctrl + U)"},icon:Icons.Underline},{style:"c",title:"formatTextMonospace_msg",icon:Icons.Code},{style:"a",title:function(){return editor.hasStyle("a")?lang.get("breakLink_action"):lang.get("makeLink_action")},icon:Icons.Link}].map(function(o){return{label:"emptyString_msg",title:o.title,click:function(){return editor.setStyle(!editor.hasStyle(o.style),o.style)},icon:function(){return o.icon},type:ButtonType.Toggle,noBubble:!0,isSelected:function(){return editor.hasStyle(o.style)},colors:ButtonColors.Elevated}}),alignToggleAttrs=[{name:"left",title:"formatTextLeft_msg",icon:Icons.AlignLeft},{name:"center",title:"formatTextCenter_msg",icon:Icons.AlignCenter},{name:"right",title:"formatTextRight_msg",icon:Icons.AlignRight},{name:"justify",title:"formatTextJustify_msg",icon:Icons.AlignJustified}].map(function(o){return{label:"emptyString_msg",title:o.title,click:function(){editor._squire.setTextAlignment(o.name),setTimeout(function(){return editor._squire.focus()},100),m.redraw()},icon:function(){return o.icon},type:ButtonType.Toggle,isSelected:function(){return!1},colors:ButtonColors.Elevated}});styleToggleAttrs.unshift({label:"emptyString_msg",title:function(){return lang.get("formatTextUl_msg")+" (Ctrl + Shift + 8)"},click:function(){"ul"===editor.styles.listing?editor._squire.removeList():editor._squire.makeUnorderedList()},icon:function(){return Icons.ListUnordered},type:ButtonType.Toggle,noBubble:!0,isSelected:function(){return"ul"===editor.styles.listing},colors:ButtonColors.Elevated},{label:"emptyString_msg",title:function(){return lang.get("formatTextOl_msg")+" (Ctrl + Shift + 9)"},click:function(){"ol"===editor.styles.listing?editor._squire.removeList():editor._squire.makeOrderedList()},icon:function(){return Icons.ListOrdered},type:ButtonType.Toggle,noBubble:!0,isSelected:function(){return"ol"===editor.styles.listing},colors:ButtonColors.Elevated});var attachHandler=attachFileHandler;attachHandler&&styleToggleAttrs.unshift({label:"emptyString_msg",title:"insertImage_action",click:function(ev){return attachHandler(ev,editor)},type:ButtonType.Toggle,icon:function(){return Icons.Picture},colors:ButtonColors.Elevated});var alignDropdownAttrs=attachDropdown({label:function(){return"▼"},title:"formatTextAlignment_msg",icon:function(){switch(editor.styles.alignment){case"left":return Icons.AlignLeft;case"center":return Icons.AlignCenter;case"right":return Icons.AlignRight;default:return Icons.AlignJustified}},type:ButtonType.Toggle,noBubble:!0,colors:ButtonColors.Elevated},function(){return alignToggleAttrs},function(){return!0},2*size.hpad_large+size.button_height),removeFormattingButtonAttrs={label:"emptyString_msg",title:"removeFormatting_action",icon:function(){return Icons.Close},type:ButtonType.Toggle,click:function(){return editor._squire.removeAllFormatting()},noBubble:!0,colors:ButtonColors.Elevated},sizeButtonAttrs=attachDropdown({label:function(){return"▼"},title:"formatTextFontSize_msg",icon:function(){return Icons.FontSize},type:ButtonType.Toggle,click:noOp,noBubble:!0,colors:ButtonColors.Elevated},function(){return numberRange(8,144).map(function(n){return{label:function(){return n.toString()},type:ButtonType.Dropdown,click:function(){editor._squire.setFontSize(n),_this.selectedSize(n),setTimeout(function(){return editor._squire.focus()},100),m.redraw()}}})});this.view=function(){try{_this.selectedSize(parseInt(editor._squire.getFontInfo().size.slice(0,-2)))}catch(e){_this.selectedSize(size.font_size_base)}return m(".elevated-bg.overflow-hidden.pb-2",{style:{top:"0px",position:client.browser===BrowserType.SAFARI?client.isMacOS?"-webkit-sticky":"inherit":"sticky"}},[m(".flex-end.wrap",styleToggleAttrs.concat(alignDropdownAttrs,sizeButtonAttrs,removeFormattingButtonAttrs).map(function(t){return m(ButtonN,t)})),m("hr.hr")])}}return _createClass(RichTextToolbar,[{key:"oncreate",value:function(vnode){vnode.dom.style.height=0,this._animate(vnode,!0)}},{key:"onbeforeremove",value:function(vnode){return this._animate(vnode,!1)}},{key:"_animate",value:function(vnode,appear){var childHeight=Array.from(vnode.dom.children).map(function(domElement){return domElement.offsetHeight}).reduce(function(current,previous){return Math.max(current,previous)},0);return animations.add(vnode.dom,[height(appear?0:childHeight,appear?childHeight:0),appear?opacity(0,1,!1):opacity(1,0,!1)]).then(function(){appear&&(vnode.dom.style.height="")})}}]),RichTextToolbar}()),_export("RichTextToolbar",RichTextToolbar)}}}),System.register("src/gui/base/HtmlEditor.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","./Editor.js","./DropDownSelector","../../misc/LanguageViewModel","../size","../../misc/HtmlSanitizer","./RichTextToolbar"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,Editor,DropDownSelector,lang,px,htmlSanitizer,RichTextToolbar,Mode,HtmlEditor;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_EditorJs){Editor=_EditorJs.Editor},function(_DropDownSelector){DropDownSelector=_DropDownSelector.DropDownSelector},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_size){px=_size.px},function(_miscHtmlSanitizer){htmlSanitizer=_miscHtmlSanitizer.htmlSanitizer},function(_RichTextToolbar){RichTextToolbar=_RichTextToolbar.RichTextToolbar}],execute:function(){_export("Mode",Mode=Object.freeze({HTML:"html",WYSIWYG:"what you see is what you get"})),_export("Mode",Mode),_export("HtmlEditor",HtmlEditor=function(){function HtmlEditor(labelIdOrLabelFunction){var _this=this,richToolbarOptions=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{enabled:!1};_classCallCheck(this,HtmlEditor),this._editor=new Editor(null,function(html){return htmlSanitizer.sanitizeFragment(html,!1).html}),this._mode=stream(Mode.WYSIWYG),this._active=!1,this._disabled=!1,this._showBorders=!1,this._minHeight=null,this._placeholderId=null,this._value=stream(""),this._modeSwitcher=null,this._htmlMonospace=!0,this._richToolbarOptions=richToolbarOptions,this._mode.map(function(v){_this.setValue(_this._value()),_this._editor.initialized.promise.then(function(){_this._editor._domElement.onfocus=function(e){return focus()},_this._editor._domElement.onblur=function(e){return blur()}})});var focus=function(){_this._active||(_this._active=!0),_this._showBorders&&(_this._modeSwitcher&&_this._borderDomElement.classList.remove("editor-no-top-border"),_this._borderDomElement.classList.add("editor-border-active"),_this._borderDomElement.classList.remove("editor-border"))},blur=function(){_this._active&&(_this._active=!1),_this._mode()===Mode.WYSIWYG?_this._value(_this._editor.getValue()):_this._value(_this._domTextArea.value),_this._showBorders&&(_this._modeSwitcher&&_this._borderDomElement.classList.add("editor-no-top-border"),_this._borderDomElement.classList.remove("editor-border-active"),_this._borderDomElement.classList.add("editor-border")),m.redraw()},label=labelIdOrLabelFunction,toolbar=new RichTextToolbar(this._editor,richToolbarOptions.imageButtonClickHandler);this.view=function(){return m(".html-editor",[_this._modeSwitcher?m(_this._modeSwitcher):null,label?m(".small.mt-form",lang.getMaybeLazy(label)):null,m((_this._showBorders?".editor-border":"")+(_this._modeSwitcher?".editor-no-top-border":""),{oncreate:function(vnode){return _this._borderDomElement=vnode.dom}},[!_this._active&&_this.isEmpty()?m(".abs.text-ellipsis.noselect.backface_fix.z1.i.pr-s",{oncreate:function(vnode){return _this._placeholderDomElement=vnode.dom},onclick:function(){return _this._mode()===Mode.WYSIWYG?_this._editor._domElement.focus():_this._domTextArea.focus()}},_this._placeholderId?lang.get(_this._placeholderId):""):null,_this._mode()===Mode.WYSIWYG?m(".wysiwyg.rel.overflow-hidden.selectable",[_this._editor.isEnabled()&&_this._richToolbarOptions.enabled?m(toolbar):null,m(_this._editor)]):null,_this._mode()===Mode.HTML?m(".html",m("textarea.input-area.selectable",{oncreate:function(vnode){_this._domTextArea=vnode.dom,_this.isEmpty()||(_this._domTextArea.value=_this._value())},onfocus:function(e){return focus()},onblur:function(e){return blur()},oninput:function(e){_this._domTextArea.style.height="0px",_this._domTextArea.style.height=_this._domTextArea.scrollHeight+"px"},style:{"font-family":_this._htmlMonospace?"monospace":"inherit","min-height":_this._minHeight?px(_this._minHeight):"initial"},disabled:!_this._editor._enabled})):null])])}}return _createClass(HtmlEditor,[{key:"setModeSwitcher",value:function(label){var _this2=this;return this._modeSwitcher=new DropDownSelector(label,null,[{name:lang.get("richText_label"),value:Mode.WYSIWYG},{name:lang.get("htmlSourceCode_label"),value:Mode.HTML}],this._mode).setSelectionChangedHandler(function(v){_this2._mode(v)}),this}},{key:"showBorders",value:function(){return this._showBorders=!0,this}},{key:"setMinHeight",value:function(height){return this._minHeight=height,this._editor.setMinHeight(height),this}},{key:"setPlaceholderId",value:function(placeholderId){return this._placeholderId=placeholderId,this}},{key:"getValue",value:function(){return this._mode()===Mode.WYSIWYG?this._editor.isAttached()?this._editor.getHTML():this._value():this._domTextArea?htmlSanitizer.sanitize(this._domTextArea.value,!1).text:this._value()}},{key:"setValue",value:function(html){var _this3=this;return this._mode()===Mode.WYSIWYG?this._editor.initialized.promise.then(function(){return _this3._editor.setHTML(html)}):this._domTextArea&&(this._domTextArea.value=html),this._value(html),this}},{key:"isActive",value:function(){return this._active}},{key:"isEmpty",value:function(){return""===this._value()}},{key:"setEnabled",value:function(enabled){return this._editor.setEnabled(enabled),this._domTextArea&&(this._domTextArea.disabled=!enabled),this}},{key:"setMode",value:function(mode){return this._mode(mode),this}},{key:"setHtmlMonospace",value:function(monospace){return this._htmlMonospace=monospace,this}}]),HtmlEditor}()),_export("HtmlEditor",HtmlEditor)}}}),System.register("src/login/RecoverLoginDialog.js",["mithril","mithril/stream/stream.js","../gui/base/ButtonN","../gui/base/DropdownN.js","../api/common/error/RestError","../gui/base/ProgressDialog","../misc/FormatValidator","../gui/base/TextField","../misc/LanguageViewModel","../settings/PasswordForm","../gui/base/icons/Icons","../misc/DeviceConfig","../gui/base/TextFieldN","../gui/base/Dialog","../api/Env","./SecondFactorHandler","../gui/base/HtmlEditor","../api/main/WorkerClient","../misc/ClientDetector","../api/common/error/CancelledError"],function(_export,_context){"use strict";var m,stream,ButtonN,ButtonType,createDropdown,AccessBlockedError,AccessDeactivatedError,NotAuthenticatedError,TooManyRequestsError,showProgressDialog,isMailAddress,Type,lang,PasswordForm,Icons,deviceConfig,TextFieldN,Dialog,DialogType,assertMainOrNode,secondFactorHandler,HtmlEditor,Mode,worker,client,CancelledError;function handleError(e){return Promise.reject(e).catch(NotAuthenticatedError,function(){Dialog.error("loginFailed_msg")}).catch(AccessBlockedError,function(){Dialog.error("loginFailedOften_msg")}).catch(CancelledError,function(){m.redraw()}).catch(AccessDeactivatedError,function(e){Dialog.error("loginFailed_msg")}).catch(TooManyRequestsError,function(e){Dialog.error("tooManyAttempts_msg")})}return _export("show",function(mailAddress,resetAction){var selectedAction=stream(resetAction),passwordForm=new PasswordForm(!1,!0,!0),passwordValueStream=stream(""),emailAddressStream=stream(mailAddress||""),resetPasswordAction={label:"recoverSetNewPassword_action",click:function(){selectedAction("password")},type:ButtonType.Dropdown},resetSecondFactorAction={label:"recoverResetFactors_action",click:function(){selectedAction("secondFactor")},type:ButtonType.Dropdown},resetActionButtonAttrs={label:"action_label",click:createDropdown(function(){return[resetPasswordAction,resetSecondFactorAction]},300),icon:function(){return Icons.Edit}},selectedValueLabelStream=selectedAction.map(function(v){return"password"===v?lang.get("recoverSetNewPassword_action"):"secondFactor"===v?lang.get("recoverResetFactors_action"):lang.get("choose_label")}),editor=new HtmlEditor("recoveryCode_label");editor.setMode(Mode.HTML),editor.setHtmlMonospace(!0),editor.setMinHeight(80),editor.showBorders();var recoverDialog=Dialog.showActionDialog({title:lang.get("recover_label"),type:DialogType.EditSmall,child:{view:function(){return[m(TextFieldN,{label:"mailAddress_label",value:emailAddressStream}),m(editor),m(TextFieldN,{label:"action_label",value:selectedValueLabelStream,injectionsRight:function(){return m(ButtonN,resetActionButtonAttrs)},disabled:!0}),null==selectedAction()?null:"password"===selectedAction()?m(passwordForm):m(TextFieldN,{label:"password_label",type:Type.Password,value:passwordValueStream})]}},okAction:function(){var cleanMailAddress=emailAddressStream().trim().toLowerCase(),cleanRecoverCodeValue=editor.getValue().replace(/\s/g,"").toLowerCase();if(isMailAddress(cleanMailAddress,!0)){if(""===cleanRecoverCodeValue)Dialog.error("recoveryCodeEmpty_msg");else if("password"===selectedAction()){var errorMessageId=passwordForm.getErrorMessageId();errorMessageId?Dialog.error(errorMessageId):showProgressDialog("pleaseWait_msg",worker.initialized.then(function(){return worker.recoverLogin(cleanMailAddress,cleanRecoverCodeValue,passwordForm.getNewPassword(),client.getIdentifier())})).then(function(){recoverDialog.close(),deviceConfig.delete(cleanMailAddress),m.route.set("/login",{loginWith:cleanMailAddress,noAutoLogin:!0})}).catch(function(e){return handleError(e)}).finally(function(){return secondFactorHandler.closeWaitingForSecondFactorDialog()})}else if("secondFactor"===selectedAction()){var passwordValue=passwordValueStream();showProgressDialog("pleaseWait_msg",worker.initialized.then(function(){return worker.resetSecondFactors(cleanMailAddress,passwordValue,cleanRecoverCodeValue)})).then(function(){recoverDialog.close(),deviceConfig.delete(cleanMailAddress),m.route.set("/login",{loginWith:cleanMailAddress,noAutoLogin:!0})}).catch(function(e){return handleError(e)})}}else Dialog.error("mailAddressInvalid_msg")},cancelAction:function(){return m.route.set("/login")}});return recoverDialog}),{setters:[function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseDropdownNJs){createDropdown=_guiBaseDropdownNJs.createDropdown},function(_apiCommonErrorRestError){AccessBlockedError=_apiCommonErrorRestError.AccessBlockedError,AccessDeactivatedError=_apiCommonErrorRestError.AccessDeactivatedError,NotAuthenticatedError=_apiCommonErrorRestError.NotAuthenticatedError,TooManyRequestsError=_apiCommonErrorRestError.TooManyRequestsError},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_miscFormatValidator){isMailAddress=_miscFormatValidator.isMailAddress},function(_guiBaseTextField){Type=_guiBaseTextField.Type},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_settingsPasswordForm){PasswordForm=_settingsPasswordForm.PasswordForm},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_miscDeviceConfig){deviceConfig=_miscDeviceConfig.deviceConfig},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_SecondFactorHandler){secondFactorHandler=_SecondFactorHandler.secondFactorHandler},function(_guiBaseHtmlEditor){HtmlEditor=_guiBaseHtmlEditor.HtmlEditor,Mode=_guiBaseHtmlEditor.Mode},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_miscClientDetector){client=_miscClientDetector.client},function(_apiCommonErrorCancelledError){CancelledError=_apiCommonErrorCancelledError.CancelledError}],execute:function(){assertMainOrNode()}}}),System.register("src/login/LoginView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","../gui/base/TextField","../gui/base/Checkbox","../gui/base/Button","../misc/ClientDetector","../api/Env","../misc/LanguageViewModel","../api/common/utils/Utils","../misc/DeviceConfig","../gui/base/Expander","../gui/theme","../misc/KeyManager","../gui/base/icons/BootIcons","../api/common/TutanotaConstants","../api/common/utils/Encoding","../gui/base/ProgressDialog","../misc/WindowFacade","../misc/ClientConstants","../gui/base/ButtonN","./RecoverLoginDialog","../gui/base/Header","../api/common/utils/AriaUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,TextField,Type,Checkbox,Button,client,assertMainOrNode,isApp,isDesktop,isTutanotaDomain,lang,asyncImport,neverNull,deviceConfig,ExpanderButton,ExpanderPanel,themeId,keyManager,BootIcons,BootstrapFeatureType,Keys,base64ToUint8Array,base64UrlToBase64,utf8Uint8ArrayToString,showProgressDialog,windowFacade,DeviceType,ButtonN,ButtonType,show,header,AriaLandmarks,landmarkAttrs,liveDataAttrs,DisplayMode,LoginView,login;function getWhitelabelRegistrationDomains(){return whitelabelCustomizations&&whitelabelCustomizations.registrationDomains?whitelabelCustomizations.registrationDomains:[]}function getImprintLink(){return whitelabelCustomizations?whitelabelCustomizations.imprintUrl:"https://tutanota.com/about"}function getPrivacyStatementLink(){return whitelabelCustomizations?whitelabelCustomizations.privacyStatementUrl:"https://tutanota.com/privacy"}function renderPrivacyAndImprintLinks(){return m("div.center.flex.flex-grow.items-end.justify-center.mb-l.mt-xl",[getPrivacyStatementLink()?m("a.plr",{href:getPrivacyStatementLink(),target:"_blank"},lang.get("privacyLink_label")):null,getImprintLink()?m("a.plr",{href:getImprintLink(),target:"_blank"},lang.get("imprint_label")):null])}return _export("getWhitelabelRegistrationDomains",getWhitelabelRegistrationDomains),_export("getImprintLink",getImprintLink),_export("getPrivacyStatementLink",getPrivacyStatementLink),_export("renderPrivacyAndImprintLinks",renderPrivacyAndImprintLinks),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField,Type=_guiBaseTextField.Type},function(_guiBaseCheckbox){Checkbox=_guiBaseCheckbox.Checkbox},function(_guiBaseButton){Button=_guiBaseButton.Button},function(_miscClientDetector){client=_miscClientDetector.client},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isApp=_apiEnv.isApp,isDesktop=_apiEnv.isDesktop,isTutanotaDomain=_apiEnv.isTutanotaDomain},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonUtilsUtils){asyncImport=_apiCommonUtilsUtils.asyncImport,neverNull=_apiCommonUtilsUtils.neverNull},function(_miscDeviceConfig){deviceConfig=_miscDeviceConfig.deviceConfig},function(_guiBaseExpander){ExpanderButton=_guiBaseExpander.ExpanderButton,ExpanderPanel=_guiBaseExpander.ExpanderPanel},function(_guiTheme){themeId=_guiTheme.themeId},function(_miscKeyManager){keyManager=_miscKeyManager.keyManager},function(_guiBaseIconsBootIcons){BootIcons=_guiBaseIconsBootIcons.BootIcons},function(_apiCommonTutanotaConstants){BootstrapFeatureType=_apiCommonTutanotaConstants.BootstrapFeatureType,Keys=_apiCommonTutanotaConstants.Keys},function(_apiCommonUtilsEncoding){base64ToUint8Array=_apiCommonUtilsEncoding.base64ToUint8Array,base64UrlToBase64=_apiCommonUtilsEncoding.base64UrlToBase64,utf8Uint8ArrayToString=_apiCommonUtilsEncoding.utf8Uint8ArrayToString},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_miscClientConstants){DeviceType=_miscClientConstants.DeviceType},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_RecoverLoginDialog){show=_RecoverLoginDialog.show},function(_guiBaseHeader){header=_guiBaseHeader.header},function(_apiCommonUtilsAriaUtils){AriaLandmarks=_apiCommonUtilsAriaUtils.AriaLandmarks,landmarkAttrs=_apiCommonUtilsAriaUtils.landmarkAttrs,liveDataAttrs=_apiCommonUtilsAriaUtils.liveDataAttrs}],execute:function(){assertMainOrNode(),DisplayMode=Object.freeze({Credentials:"credentials",Form:"form"}),_export("LoginView",LoginView=function(){function LoginView(){var _this=this;_classCallCheck(this,LoginView),this.targetPath="/mail",this._requestedPath=this.targetPath,this.mailAddress=new TextField("mailAddress_label").setType(Type.Email),this.mailAddress.autocomplete="username",this.helpText=lang.get("emptyString_msg"),this.password=new TextField("password_label").setType(Type.Password),this.password.autocomplete="password",this.savePassword=new Checkbox(function(){return lang.get("storePassword_action")},function(){return lang.get("onlyPrivateComputer_msg")}),client.localStorage()||this.savePassword.setDisabled("functionNotSupported_msg"),this.appButtons=[new Button("appInfoAndroidImageAlt_alt",function(){return _this.openUrl("https://play.google.com/store/apps/details?id=de.tutao.tutanota")},function(){return BootIcons.Android}).setIsVisibleHandler(function(){return client.isDesktopDevice()||client.device===DeviceType.ANDROID}).setType(ButtonType.ActionLarge),new Button("appInfoIosImageAlt_alt",function(){return _this.openUrl("https://itunes.apple.com/app/tutanota/id922429609?mt=8&uo=4&at=10lSfb")},function(){return BootIcons.Apple}).setIsVisibleHandler(function(){return client.isDesktopDevice()||client.device===DeviceType.IPAD||client.device===DeviceType.IPHONE}).setType(ButtonType.ActionLarge),new Button("appInfoFDroidImageAlt_alt",function(){return _this.openUrl("https://f-droid.org/packages/de.tutao.tutanota/")},function(){return BootIcons.FDroid}).setIsVisibleHandler(function(){return client.isDesktopDevice()||client.device===DeviceType.ANDROID}).setType(ButtonType.ActionLarge)],this._knownCredentials=[],this._isDeleteCredentials=!1,this._viewController=asyncImport("undefined"!=typeof module?module.id:_context.id,env.rootPathPrefix+"src/login/LoginViewController.js").then(function(module){return new module.LoginViewController(_this)}),window.location.href.includes("signup")?(this.permitAutoLogin=!1,this._signup()):window.location.href.endsWith("recover")?(this.permitAutoLogin=!1,show()):this.permitAutoLogin=!0;var optionsExpander=this._expanderButton();this._setupShortcuts();var bottomMargin=0,keyboardListener=function(keyboardSize){bottomMargin=keyboardSize,m.redraw()};this.view=function(){return m("#login-view.main-view.flex.col",{oncreate:function(){return windowFacade.addKeyboardSizeListener(keyboardListener)},onremove:function(){return windowFacade.removeKeyboardSizeListener(keyboardListener)},style:{marginBottom:bottomMargin+"px"}},[m(header),m(".flex-grow.flex-center.scroll",m(".flex-grow-shrink-auto.max-width-s.pt.plr-l"+landmarkAttrs(AriaLandmarks.Main,lang.get("login_label")),{oncreate:function(vnode){vnode.dom.focus()},style:{width:client.isDesktopDevice()?"360px":null}},[_this._displayMode===DisplayMode.Credentials?_this.credentialsSelector():_this.loginForm(),_this._anyMoreItemVisible()?m(".flex-center.pt-l",[m(optionsExpander)]):null,_this._anyMoreItemVisible()?m("",[m(optionsExpander.panel)]):null,!isApp()||isDesktop()?renderPrivacyAndImprintLinks():null]))])}}return _createClass(LoginView,[{key:"_setupShortcuts",value:function(){var _this2=this,shortcuts=[{key:Keys.RETURN,exec:function(){return _this2.login()},help:"login_label"}];this.oncreate=function(){keyManager.registerShortcuts(shortcuts),_this2._formsUpdateStream=stream.combine(function(){requestAnimationFrame(function(){_this2.mailAddress.updateValue(),_this2.password.updateValue()})},[_this2.mailAddress.value,_this2.password.value])},this.onremove=function(){_this2.password.value(""),keyManager.unregisterShortcuts(shortcuts),_this2._formsUpdateStream&&_this2._formsUpdateStream.end(!0)}}},{key:"_signupLinkVisible",value:function(){return this._displayMode!==DisplayMode.Credentials&&(isTutanotaDomain()||getWhitelabelRegistrationDomains().length>0)}},{key:"_loginAnotherLinkVisible",value:function(){return this._displayMode===DisplayMode.Credentials}},{key:"_deleteCredentialsLinkVisible",value:function(){return this._displayMode===DisplayMode.Credentials}},{key:"_knownCredentialsLinkVisible",value:function(){return!this._displayMode!==DisplayMode.Credentials&&this._knownCredentials.length>0}},{key:"_switchThemeLinkVisible",value:function(){return"custom"!==themeId()}},{key:"_recoverLoginVisible",value:function(){return isTutanotaDomain()}},{key:"_anyMoreItemVisible",value:function(){return this._signupLinkVisible()||this._loginAnotherLinkVisible()||this._deleteCredentialsLinkVisible()||this._knownCredentialsLinkVisible()||this._switchThemeLinkVisible()||this._recoverLoginVisible()}},{key:"_expanderButton",value:function(){var _this3=this;return new ExpanderButton("more_label",new ExpanderPanel({view:function(){return m(".flex-center.flex-column",[_this3._loginAnotherLinkVisible()?m(ButtonN,{label:"loginOtherAccount_action",type:ButtonType.Secondary,click:function(){return _this3._showLoginForm("")}}):null,_this3._deleteCredentialsLinkVisible()?m(ButtonN,{label:_this3._isDeleteCredentials?"cancel_action":"deleteCredentials_action",type:ButtonType.Secondary,click:function(){return _this3._switchDeleteCredentialsState()}}):null,_this3._knownCredentialsLinkVisible()?m(ButtonN,{label:"knownCredentials_label",type:ButtonType.Secondary,click:function(){return _this3._showCredentials()}}):null,_this3._signupLinkVisible()?m(ButtonN,{label:"register_label",type:ButtonType.Secondary,click:function(){return m.route.set("/signup")}}):null,_this3._switchThemeLinkVisible()?m(ButtonN,{label:"switchColorTheme_action",type:ButtonType.Secondary,click:function(){switch(themeId()){case"light":return deviceConfig.setTheme("dark");case"dark":return deviceConfig.setTheme("light")}}}):null,_this3._recoverLoginVisible()?m(ButtonN,{label:"recoverAccountAccess_action",click:function(){m.route.set("/recover"),show()},type:ButtonType.Secondary}):null])}}),!1)}},{key:"login",value:function(){this._viewController.then(function(viewController){return viewController.formLogin()})}},{key:"loginForm",value:function(){var _this4=this;return m("form",{onsubmit:function(e){e.preventDefault()}},[m(this.mailAddress),m(this.password),whitelabelCustomizations&&-1!==whitelabelCustomizations.bootstrapCustomizations.indexOf(BootstrapFeatureType.DisableSavePassword)?null:m(this.savePassword),m(".pt",m(ButtonN,{label:"login_action",click:function(){return _this4.login()},type:ButtonType.Login})),m("p.center.statusTextColor",m("small"+liveDataAttrs(),[this.helpText+" ",this.invalidCredentials&&this._recoverLoginVisible()?m("a",{href:"/recover",onclick:function(e){m.route.set("/recover"),show(_this4.mailAddress.value(),"password"),e.preventDefault()}},lang.get("recoverAccountAccess_action")):null])),isApp()||isDesktop()||!isTutanotaDomain()?null:m(".flex-center.pt-l",this.appButtons.map(function(button){return m(button)}))])}},{key:"credentialsSelector",value:function(){var _this5=this;return this._knownCredentials.map(function(c){var credentialButtons=[];return credentialButtons.push(m(ButtonN,{label:function(){return c.mailAddress},click:function(){return _this5._viewController.then(function(viewController){return viewController.autologin(c)})},type:ButtonType.Login})),_this5._isDeleteCredentials&&credentialButtons.push(m(ButtonN,{label:"delete_action",click:function(){return _this5._viewController.then(function(viewController){return viewController.deleteCredentialsNotLoggedIn(c)})},type:ButtonType.Secondary})),m(".flex-space-between.pt-l.child-grow.last-child-fixed",credentialButtons)})}},{key:"setKnownCredentials",value:function(credentials){this._knownCredentials=credentials,this._displayMode===DisplayMode.Credentials&&0===credentials.length&&(this._displayMode=DisplayMode.Form),m.redraw()}},{key:"_signup",value:function(){this._showingSignup||(this._showingSignup=!0,showProgressDialog("loading_msg",this._viewController.then(function(c){return c.loadSignupWizard()})).then(function(dialog){return dialog.show()}))}},{key:"updateUrl",value:function(args,requestedPath){var _this6=this;if(requestedPath.startsWith("/signup"))this._signup();else if(!requestedPath.startsWith("/recover")){this._showingSignup=!1,args.requestedPath?this._requestedPath=args.requestedPath:args.action?this._requestedPath=this.targetPath+"?action="+args.action:this._requestedPath=this.targetPath;var promise=Promise.resolve();if(args.migrateCredentials&&client.localStorage()&&!localStorage.getItem("tutanotaConfig"))try{var oldCredentials=JSON.parse(utf8Uint8ArrayToString(base64ToUint8Array(base64UrlToBase64(args.migrateCredentials))))._credentials||[];promise=showProgressDialog("loading_msg",this._viewController.then(function(viewController){return viewController.migrateDeviceConfig(oldCredentials)}))}catch(e){console.log("Failed to parse old credentials",e)}else if(client.localStorage()&&localStorage.getItem("config"))if(localStorage.getItem("tutanotaConfig"))localStorage.removeItem("config");else{var _oldCredentials=JSON.parse(neverNull(localStorage.getItem("config")))._credentials||[];promise=showProgressDialog("loading_msg",this._viewController.then(function(viewController){return viewController.migrateDeviceConfig(_oldCredentials)}).finally(function(){return localStorage.removeItem("config")}))}promise.then(function(){if(!_this6._displayMode){if(!args.loginWith&&!args.userId||(args.loginWith&&deviceConfig.get(args.loginWith)||args.userId&&deviceConfig.getByUserId(args.userId))){_this6._knownCredentials=deviceConfig.getAllInternal(),_this6._displayMode=_this6._knownCredentials.length>0?DisplayMode.Credentials:DisplayMode.Form;var autoLoginCredentials=null;!0!==args.noAutoLogin&&_this6.permitAutoLogin&&(args.loginWith&&deviceConfig.get(args.loginWith)?autoLoginCredentials=deviceConfig.get(args.loginWith):args.userId&&deviceConfig.getByUserId(args.userId)?autoLoginCredentials=deviceConfig.getByUserId(args.userId):1===_this6._knownCredentials.length&&(autoLoginCredentials=_this6._knownCredentials[0])),m.redraw(),autoLoginCredentials&&_this6._viewController.then(function(viewController){return viewController.autologin(neverNull(autoLoginCredentials))})}else _this6.mailAddress.setValue(args.loginWith),_this6.mailAddress._domInput&&_this6.mailAddress.animate(),_this6.password.focus(),_this6._knownCredentials=[],_this6._displayMode=DisplayMode.Form,m.redraw();_this6._isDeleteCredentials&&_this6._switchDeleteCredentialsState()}})}}},{key:"_showLoginForm",value:function(mailAddress){this.mailAddress.value(mailAddress),this._isDeleteCredentials=!1,this._displayMode=DisplayMode.Form,m.redraw()}},{key:"_showCredentials",value:function(){this._displayMode=DisplayMode.Credentials,m.redraw()}},{key:"onBackPress",value:function(){return this._displayMode!==DisplayMode.Credentials&&this._knownCredentials.length>0&&(this._showCredentials(),!0)}},{key:"openUrl",value:function(url){window.open(url,"_blank")}},{key:"_switchDeleteCredentialsState",value:function(){this._isDeleteCredentials=!this._isDeleteCredentials,m.redraw()}}]),LoginView}()),_export("LoginView",LoginView),_export("login",login=new LoginView),_export("login",login)}}}),System.register("src/misc/PasswordUtils.js",["../api/Env"],function(_export,_context){"use strict";var assertMainOrNode,_BAD_SEQUENCES,_BAD_STRINGS;function _getNbrOfSequenceChars(password,sequences,reverseToo){var s=sequences;reverseToo&&(s=sequences.concat(sequences.map(function(s1){return s1.split("").reverse().join("")})));for(var nbrOfSequenceDigits=0,i=0;i<password.length-3;i++){for(var maxFoundLen=0,sequenceLen=3;i+sequenceLen<=password.length;sequenceLen++)for(var substringToCheck=password.substring(i,i+sequenceLen),a=0;a<s.length;a++)if(-1!==s[a].indexOf(substringToCheck)){maxFoundLen=sequenceLen;break}maxFoundLen>0&&(nbrOfSequenceDigits+=maxFoundLen,i+=maxFoundLen-1)}return nbrOfSequenceDigits}function _getNbrOfOccurrences(string,regexp){var result=string.match(regexp);return result?result.length:0}function _getLongestResult(string,regexp){var result=string.match(regexp);return result?result.reduce(function(max,val){return Math.max(max,val.length)},0):0}return _export("getPasswordStrength",function(password,badStrings){if(0===password.length)return 0;var nbrOfLowerChars=_getNbrOfOccurrences(password,/[a-z ]/g),nbrOfConsecutiveLowerChars=Math.max(0,_getLongestResult(password,/[a-z ]*/g)-2),nbrOfUpperChars=_getNbrOfOccurrences(password,/[A-Z]/g),nbrOfConsecutiveUpperChars=Math.max(0,_getLongestResult(password,/[A-Z]*/g)-2),nbrOfDigits=_getNbrOfOccurrences(password,/[0-9]/g),nbrOfConsecutiveDigits=Math.max(0,_getLongestResult(password,/[0-9]*/g)-2),nbrOfOtherChars=password.length-nbrOfDigits-nbrOfLowerChars-nbrOfUpperChars,nbrOfConsecutiveOtherChars=Math.max(0,_getLongestResult(password,/[^a-z A-Z0-9]*/g)-2),nbrOfConsecutiveSame=Math.max(0,_getLongestResult(password,/(.)\1+/g)-2),minNbrOfCharsPerType=password.length/4,nbrOfMissingLowerChars=Math.max(0,minNbrOfCharsPerType-nbrOfLowerChars),nbrOfMissingUpperChars=Math.max(0,minNbrOfCharsPerType-nbrOfUpperChars),nbrOfMissingDigits=Math.max(0,minNbrOfCharsPerType-nbrOfDigits),nbrOfMissingOtherChars=Math.max(0,minNbrOfCharsPerType-nbrOfOtherChars),nbrOfSameChars=function(password){for(var characterObject={},i=0;i<password.length;i++)characterObject[password[i]]=!0;return password.length-Object.keys(characterObject).length}(password),nbrOfSequenceDigits=_getNbrOfSequenceChars(password,_BAD_SEQUENCES,!0),nbrOfBadStringDigits=_getNbrOfSequenceChars(password,badStrings.concat(_BAD_STRINGS),!1),strength=11*password.length;return strength-=3*nbrOfMissingLowerChars,strength-=3*nbrOfMissingUpperChars,strength-=3*nbrOfMissingDigits,strength-=3*nbrOfMissingOtherChars,strength-=2*nbrOfConsecutiveLowerChars,strength-=2*nbrOfConsecutiveUpperChars,strength-=2*nbrOfConsecutiveDigits,strength-=2*nbrOfConsecutiveOtherChars,strength-=2*nbrOfConsecutiveSame,strength-=5*nbrOfSameChars,strength-=4*nbrOfSequenceDigits,strength-=4*nbrOfBadStringDigits,Math.min(100,Math.max(0,Math.round(strength)))}),_export("_getNbrOfSequenceChars",_getNbrOfSequenceChars),{setters:[function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode}],execute:function(){assertMainOrNode(),_export("_BAD_SEQUENCES",_BAD_SEQUENCES=["^1234567890ß´",'°!"§$%&/()=?`',"qwertzuiopü+","QWERTZUIOPÜ*","asdfghjklöä#","ASDFGHJKLÖÄ'","<yxcvbnm,.-",">YXCVBNM:_","`1234567890-=","~!@#$%^&*()_+","qwertyuiop[]","QWERTYUIOP{}","asdfghjkl'\\",'ASDFGHJKL:"|',"\\zxcvbnm,./","|ZXCVBNM<>?","abcdefghijklmnopqrstuvwxyz","ABCDEFGHIJKLMNOPQRSTUVWXYZ"]),_export("_BAD_SEQUENCES",_BAD_SEQUENCES),_BAD_STRINGS=["passwort","Passwort","password","Password","tutanota","Tutanota","free","Free","starter","Starter","Test","test"]}}}),System.register("src/gui/base/StatusField.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../../api/Env","../../misc/LanguageViewModel"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,lang,StatusField;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang}],execute:function(){assertMainOrNode(),_export("StatusField",StatusField=function(){function StatusField(status){var _this=this;_classCallCheck(this,StatusField),this._status=status,this.view=function(){return m("",lang.get(_this._status().text))}}return _createClass(StatusField,[{key:"isValid",value:function(){return"valid"===this._status().type}},{key:"getErrorMessageId",value:function(){return"valid"!==this._status().type?this._status().text:null}}]),StatusField}()),_export("StatusField",StatusField)}}}),System.register("src/settings/PasswordForm.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../api/Env","../gui/base/TextField","../gui/base/PasswordIndicator","../misc/PasswordUtils","../gui/base/Dialog","../misc/LanguageViewModel","../gui/base/StatusField","mithril/stream/stream.js","../api/main/LoginController","../api/main/WorkerClient","../api/common/utils/Utils","../api/common/error/RestError","../gui/base/ProgressDialog","../misc/DeviceConfig"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,assertMainOrNode,TextField,Type,PasswordIndicator,getPasswordStrength,Dialog,lang,StatusField,Stream,logins,worker,getEnabledMailAddressesForGroupInfo,NotAuthenticatedError,showProgressDialog,deviceConfig,PasswordForm;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField,Type=_guiBaseTextField.Type},function(_guiBasePasswordIndicator){PasswordIndicator=_guiBasePasswordIndicator.PasswordIndicator},function(_miscPasswordUtils){getPasswordStrength=_miscPasswordUtils.getPasswordStrength},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_guiBaseStatusField){StatusField=_guiBaseStatusField.StatusField},function(_mithrilStreamStreamJs){Stream=_mithrilStreamStreamJs.default},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonUtilsUtils){getEnabledMailAddressesForGroupInfo=_apiCommonUtilsUtils.getEnabledMailAddressesForGroupInfo},function(_apiCommonErrorRestError){NotAuthenticatedError=_apiCommonErrorRestError.NotAuthenticatedError},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_miscDeviceConfig){deviceConfig=_miscDeviceConfig.deviceConfig}],execute:function(){assertMainOrNode(),_export("PasswordForm",PasswordForm=function(){function PasswordForm(validateOldPassword,enforcePasswordStrength,repeatPassword,passwordInfoTextId){var _this=this;_classCallCheck(this,PasswordForm),this._oldPasswordField=new TextField("oldPassword_label",function(){return m(_this._oldPasswordFieldStatus)}).setType(Type.Password).setPreventAutofill(!0),this._oldPasswordFieldStatus=new StatusField(this._oldPasswordField.value.map(function(pw){return validateOldPassword&&""===pw?{type:"neutral",text:"oldPasswordNeutral_msg"}:{type:"valid",text:"emptyString_msg"}}));var passwordIndicator=new PasswordIndicator(function(){return _this._getPasswordStrength()});this._newPasswordField=new TextField("newPassword_label",function(){return m(_this._newPasswordFieldStatus)}).setType(Type.Password).setPreventAutofill(!0),this._newPasswordField._injectionsRight=function(){return m(".mb-s.mlr",[m(passwordIndicator)])},this._newPasswordFieldStatus=new StatusField(Stream.combine(function(){return""===_this._newPasswordField.value()?{type:"neutral",text:"password1Neutral_msg"}:validateOldPassword&&_this._oldPasswordField.value()===_this._newPasswordField.value()?{type:"invalid",text:"password1InvalidSame_msg"}:_this.isPasswordUnsecure()?enforcePasswordStrength?{type:"invalid",text:"password1InvalidUnsecure_msg"}:{type:"valid",text:"password1InvalidUnsecure_msg"}:{type:"valid",text:"passwordValid_msg"}},[this._newPasswordField.value,this._oldPasswordField.value])),this._repeatedPasswordField=new TextField("repeatedPassword_label",function(){return m(_this._repeatedPasswordFieldStatus)}).setType(Type.Password),this._repeatedPasswordFieldStatus=new StatusField(Stream.combine(function(){return repeatPassword&&""===_this._repeatedPasswordField.value()?{type:"neutral",text:"password2Neutral_msg"}:repeatPassword&&_this._repeatedPasswordField.value()!==_this._newPasswordField.value()?{type:"invalid",text:"password2Invalid_msg"}:{type:"valid",text:"passwordValid_msg"}},[this._newPasswordField.value,this._repeatedPasswordField.value])),this.view=function(){return m("",{onremove:function(){_this._oldPasswordField.value(""),_this._newPasswordField.value(""),_this._repeatedPasswordField.value("")}},[validateOldPassword?m(_this._oldPasswordField):null,m(_this._newPasswordField),passwordInfoTextId?m(".small.mt-s",lang.get(passwordInfoTextId)):null,repeatPassword?m(_this._repeatedPasswordField):null])}}return _createClass(PasswordForm,[{key:"_getPasswordStrength",value:function(){var reserved=[];return logins.isUserLoggedIn()&&(reserved=getEnabledMailAddressesForGroupInfo(logins.getUserController().userGroupInfo).concat(logins.getUserController().userGroupInfo.name)),Math.min(100,getPasswordStrength(this._newPasswordField.value(),reserved)/.8*1)}},{key:"getErrorMessageId",value:function(){return this._oldPasswordFieldStatus.getErrorMessageId()||this._newPasswordFieldStatus.getErrorMessageId()||this._repeatedPasswordFieldStatus.getErrorMessageId()}},{key:"getOldPassword",value:function(){return this._oldPasswordField.value()}},{key:"getNewPassword",value:function(){return this._newPasswordField.value()}},{key:"isPasswordUnsecure",value:function(){return this._getPasswordStrength()<100}}],[{key:"showChangeOwnPasswordDialog",value:function(){var allowCancel=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],form=new PasswordForm(!0,!0,!0);Dialog.showActionDialog({title:lang.get("changePassword_label"),child:form,validator:function(){return form.getErrorMessageId()},okAction:function(dialog){var error=form.getErrorMessageId();error?Dialog.error(error):showProgressDialog("pleaseWait_msg",worker.changePassword(form.getOldPassword(),form.getNewPassword())).then(function(){deviceConfig.deleteByAccessToken(logins.getUserController().accessToken),Dialog.error("pwChangeValid_msg"),dialog.close()}).catch(NotAuthenticatedError,function(e){Dialog.error("oldPasswordInvalid_msg")}).catch(function(e){Dialog.error("passwordResetFailed_msg")})},allowCancel:allowCancel})}},{key:"showChangeUserPasswordAsAdminDialog",value:function(user){var form=new PasswordForm(!1,!1,!0);Dialog.showActionDialog({title:lang.get("changePassword_label"),child:form,validator:function(){return form.getErrorMessageId()},okAction:function(dialog){var p=worker.changeUserPassword(user,form.getNewPassword()).then(function(){Dialog.error("pwChangeValid_msg"),dialog.close()}).catch(function(e){Dialog.error("passwordResetFailed_msg")});showProgressDialog("pleaseWait_msg",p)}})}}]),PasswordForm}()),_export("PasswordForm",PasswordForm)}}}),System.register("src/misc/HtmlSanitizer.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","dompurify","../gui/base/icons/Icons","./ClientDetector"],function(_export,_context){"use strict";var _classCallCheck,_createClass,DOMPurify,ReplacementImage,client,PREVENT_EXTERNAL_IMAGE_LOADING_ICON,EXTERNAL_CONTENT_ATTRS,HtmlSanitizer,htmlSanitizer;return _export("stringifyFragment",function(fragment){var div=document.createElement("div");return div.appendChild(fragment),div.innerHTML}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_dompurify){DOMPurify=_dompurify.default},function(_guiBaseIconsIcons){ReplacementImage=_guiBaseIconsIcons.ReplacementImage},function(_ClientDetector){client=_ClientDetector.client}],execute:function(){_export("PREVENT_EXTERNAL_IMAGE_LOADING_ICON",PREVENT_EXTERNAL_IMAGE_LOADING_ICON="data:image/svg+xml;utf8,"+ReplacementImage.replace(/"/g,"'").replace(/#/g,"%23")),_export("PREVENT_EXTERNAL_IMAGE_LOADING_ICON",PREVENT_EXTERNAL_IMAGE_LOADING_ICON),EXTERNAL_CONTENT_ATTRS=["src","poster","srcset","background"],HtmlSanitizer=function(){function HtmlSanitizer(){var _this=this;_classCallCheck(this,HtmlSanitizer),this._blockExternalContent=!1,DOMPurify.isSupported&&(this.purifier=DOMPurify,this.purifier.addHook("afterSanitizeAttributes",function(currentNode,data,config){var allowedClasses=["tutanota_quote","MsoListParagraph","MsoListParagraphCxSpFirst","MsoListParagraphCxSpMiddle","MsoListParagraphCxSpLast"];if(currentNode.classList)for(var cl=currentNode.classList,i=cl.length;i>0;i--)-1===allowedClasses.indexOf(cl[0])&&cl.remove(cl[0]);if(_this._replaceAttributes(currentNode),currentNode.tagName&&("a"===currentNode.tagName.toLowerCase()||"area"===currentNode.tagName.toLowerCase()||"form"===currentNode.tagName.toLowerCase())){var href=currentNode.getAttribute("href");config.allowRelativeLinks||!href||function(link){if(client.isIE())return!0;try{return"file"!==new URL(link).protocol}catch(e){return!1}}(href)?(currentNode.setAttribute("rel","noopener noreferrer"),currentNode.setAttribute("target","_blank")):"{link}"===href.trim()?(currentNode.href="{link}",currentNode.setAttribute("rel","noopener noreferrer"),currentNode.setAttribute("target","_blank")):(console.log("Relative/invalid URL",currentNode,href),currentNode.href="javascript:void(0)")}return currentNode}))}return _createClass(HtmlSanitizer,[{key:"sanitize",value:function(html,blockExternalContent){var allowRelativeLinks=arguments.length>2&&void 0!==arguments[2]&&arguments[2],config=this._prepareSanitize(html,blockExternalContent,allowRelativeLinks);return{text:this.purifier.sanitize(html,config),externalContent:this._externalContent,inlineImageCids:this._inlineImageCids}}},{key:"sanitizeFragment",value:function(html,blockExternalContent){var allowRelativeLinks=arguments.length>2&&void 0!==arguments[2]&&arguments[2],config=Object.assign({},this._prepareSanitize(html,blockExternalContent,allowRelativeLinks),{RETURN_DOM_FRAGMENT:!0});return{html:this.purifier.sanitize(html,config),externalContent:this._externalContent,inlineImageCids:this._inlineImageCids}}},{key:"_prepareSanitize",value:function(html,blockExternalContent,allowRelativeLinks){return this._blockExternalContent=blockExternalContent,this._externalContent=[],this._inlineImageCids=[],{ADD_ATTR:["target","controls","cid"],ADD_URI_SAFE_ATTR:["poster"],FORBID_TAGS:["style"],allowRelativeLinks:allowRelativeLinks}}},{key:"_replaceAttributes",value:function(htmlNode){htmlNode.attributes&&this._replaceAttributeValue(htmlNode),htmlNode.style&&(this._blockExternalContent&&(htmlNode.style.backgroundImage&&(this._replaceStyleImage(htmlNode,"backgroundImage",!1),htmlNode.style.backgroundRepeat="no-repeat"),htmlNode.style.listStyleImage&&this._replaceStyleImage(htmlNode,"listStyleImage",!0),htmlNode.style.content&&this._replaceStyleImage(htmlNode,"content",!0),htmlNode.style.cursor&&this._removeStyleImage(htmlNode,"cursor"),htmlNode.style.filter&&this._removeStyleImage(htmlNode,"filter")),htmlNode.style.position&&htmlNode.style.removeProperty("position"))}},{key:"_replaceAttributeValue",value:function(htmlNode){var _this2=this;EXTERNAL_CONTENT_ATTRS.forEach(function(attrName){var attribute=htmlNode.attributes.getNamedItem(attrName);if(attribute)if(attribute.value.startsWith("cid:")){var cid=attribute.value.substring(4);_this2._inlineImageCids.push(cid),attribute.value=PREVENT_EXTERNAL_IMAGE_LOADING_ICON,htmlNode.setAttribute("cid",cid),htmlNode.classList.add("tutanota-placeholder")}else _this2._blockExternalContent&&"srcset"===attribute.name?(_this2._externalContent.push(attribute.value),htmlNode.removeAttribute("srcset"),htmlNode.setAttribute("src",PREVENT_EXTERNAL_IMAGE_LOADING_ICON),htmlNode.style["max-width"]="100px"):_this2._blockExternalContent&&!attribute.value.startsWith("data:")&&(_this2._externalContent.push(attribute.value),attribute.value=PREVENT_EXTERNAL_IMAGE_LOADING_ICON,htmlNode.attributes.setNamedItem(attribute),htmlNode.style["max-width"]="100px")})}},{key:"_removeStyleImage",value:function(htmlNode,styleAttributeName){var value=htmlNode.style[styleAttributeName];value.match(/url\(/)&&(this._externalContent.push(value),htmlNode.style.removeProperty(styleAttributeName))}},{key:"_replaceStyleImage",value:function(htmlNode,styleAttributeName,limitWidth){var value=htmlNode.style[styleAttributeName];if(value.match(/^url\(/)&&!value.match(/^url\(["']?data:/)){value=(value=value.replace(/^url\("*/,"")).replace(/"*\)$/,""),this._externalContent.push(value);var newImage='url("'+PREVENT_EXTERNAL_IMAGE_LOADING_ICON+'")';htmlNode.style[styleAttributeName]=newImage,limitWidth&&(htmlNode.style["max-width"]="100px")}}}]),HtmlSanitizer}(),_export("htmlSanitizer",htmlSanitizer=new HtmlSanitizer),_export("htmlSanitizer",htmlSanitizer)}}}),System.register("src/subscription/SignupPage.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","../misc/LanguageViewModel","./UpgradeSubscriptionWizard","../settings/SelectMailAddressForm","../gui/base/Checkbox","../api/Env","../login/LoginView","../gui/base/Dialog","../gui/base/TextField","../settings/PasswordForm","../gui/base/ButtonN","../api/common/TutanotaConstants","../api/entities/sys/Services","../api/main/WorkerClient","../api/common/error/RestError","../api/common/utils/Utils","../misc/HtmlSanitizer","../api/common/EntityFunctions","../api/main/Entity","../api/entities/sys/RegistrationCaptchaServiceReturn","../gui/base/ProgressDialog","../api/common/utils/Encoding","../gui/base/TextFieldN","../api/entities/sys/RegistrationCaptchaServiceGetData","../gui/base/DialogHeaderBar","../api/entities/sys/RegistrationCaptchaServiceData","../misc/DeviceConfig"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,lang,deleteCampaign,SelectMailAddressForm,Checkbox,isApp,isTutanotaDomain,getWhitelabelRegistrationDomains,Dialog,DialogType,TextField,PasswordForm,ButtonN,ButtonType,AccountType,TUTANOTA_MAIL_ADDRESS_DOMAINS,SysService,worker,AccessDeactivatedError,AccessExpiredError,InvalidDataError,asyncImport,neverNull,htmlSanitizer,HttpMethod,serviceRequest,serviceRequestVoid,RegistrationCaptchaServiceReturnTypeRef,showWorkerProgressDialog,uint8ArrayToBase64,TextFieldN,createRegistrationCaptchaServiceGetData,DialogHeaderBar,createRegistrationCaptchaServiceData,deviceConfig,SignupPage;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_UpgradeSubscriptionWizard){deleteCampaign=_UpgradeSubscriptionWizard.deleteCampaign},function(_settingsSelectMailAddressForm){SelectMailAddressForm=_settingsSelectMailAddressForm.SelectMailAddressForm},function(_guiBaseCheckbox){Checkbox=_guiBaseCheckbox.Checkbox},function(_apiEnv){isApp=_apiEnv.isApp,isTutanotaDomain=_apiEnv.isTutanotaDomain},function(_loginLoginView){getWhitelabelRegistrationDomains=_loginLoginView.getWhitelabelRegistrationDomains},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_settingsPasswordForm){PasswordForm=_settingsPasswordForm.PasswordForm},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_apiCommonTutanotaConstants){AccountType=_apiCommonTutanotaConstants.AccountType,TUTANOTA_MAIL_ADDRESS_DOMAINS=_apiCommonTutanotaConstants.TUTANOTA_MAIL_ADDRESS_DOMAINS},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonErrorRestError){AccessDeactivatedError=_apiCommonErrorRestError.AccessDeactivatedError,AccessExpiredError=_apiCommonErrorRestError.AccessExpiredError,InvalidDataError=_apiCommonErrorRestError.InvalidDataError},function(_apiCommonUtilsUtils){asyncImport=_apiCommonUtilsUtils.asyncImport,neverNull=_apiCommonUtilsUtils.neverNull},function(_miscHtmlSanitizer){htmlSanitizer=_miscHtmlSanitizer.htmlSanitizer},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_apiMainEntity){serviceRequest=_apiMainEntity.serviceRequest,serviceRequestVoid=_apiMainEntity.serviceRequestVoid},function(_apiEntitiesSysRegistrationCaptchaServiceReturn){RegistrationCaptchaServiceReturnTypeRef=_apiEntitiesSysRegistrationCaptchaServiceReturn.RegistrationCaptchaServiceReturnTypeRef},function(_guiBaseProgressDialog){showWorkerProgressDialog=_guiBaseProgressDialog.showWorkerProgressDialog},function(_apiCommonUtilsEncoding){uint8ArrayToBase64=_apiCommonUtilsEncoding.uint8ArrayToBase64},function(_guiBaseTextFieldN){TextFieldN=_guiBaseTextFieldN.TextFieldN},function(_apiEntitiesSysRegistrationCaptchaServiceGetData){createRegistrationCaptchaServiceGetData=_apiEntitiesSysRegistrationCaptchaServiceGetData.createRegistrationCaptchaServiceGetData},function(_guiBaseDialogHeaderBar){DialogHeaderBar=_guiBaseDialogHeaderBar.DialogHeaderBar},function(_apiEntitiesSysRegistrationCaptchaServiceData){createRegistrationCaptchaServiceData=_apiEntitiesSysRegistrationCaptchaServiceData.createRegistrationCaptchaServiceData},function(_miscDeviceConfig){deviceConfig=_miscDeviceConfig.deviceConfig}],execute:function(){_export("SignupPage",SignupPage=function(){function SignupPage(upgradeData){var _this=this;_classCallCheck(this,SignupPage),this._upgradeData=upgradeData;var mailAddressForm=new SelectMailAddressForm(isTutanotaDomain()?TUTANOTA_MAIL_ADDRESS_DOMAINS:getWhitelabelRegistrationDomains()),passwordForm=new PasswordForm(!1,!0,!0,"passwordImportance_msg"),codeField=new TextField("whitelabelRegistrationCode_label"),confirm=new Checkbox(function(){return[m("div",lang.get("termsAndConditions_label")),m("div",m("a[href="+_this._getTermsLink()+"][target=_blank]",{onclick:function(e){isApp()&&(_this.showTerms("terms"),e.preventDefault())}},lang.get("termsAndConditionsLink_label"))),m("div",m("a[href="+_this._getPrivacyLink()+"][target=_blank]",{onclick:function(e){isApp()&&(_this.showTerms("privacy"),e.preventDefault())}},lang.get("privacyLink_label")))]}),confirmAge=new Checkbox(function(){return[m("div",lang.get("ageConfirmation_msg"))]}),confirmStatus=confirm.checked.map(function(checked){return checked?{type:"valid",text:"emptyString_msg"}:{type:"neutral",text:"termsAcceptedNeutral_msg"}});this.view=function(){var newAccountData=_this._upgradeData.newAccountData;return m("#signup-account-dialog.flex-center",m(".flex-grow-shrink-auto.max-width-m.pt.pb.plr-l",[m("div",newAccountData?[m(TextFieldN,{label:"mailAddress_label",value:stream(newAccountData.mailAddress),disabled:!0}),m(".mt-l.mb-l",m(ButtonN,{label:"next_action",type:ButtonType.Login,click:function(){return _this._pageActionHandler.showNext(_this._upgradeData)}}))]:[m(mailAddressForm),m(passwordForm),getWhitelabelRegistrationDomains().length>0?m(codeField):null,m(confirm),m(confirmAge),m(".mt-l.mb-l",m(ButtonN,{label:"next_action",click:function(){return function(){var errorMessageId=mailAddressForm.getErrorMessageId()||passwordForm.getErrorMessageId()||("valid"!==confirmStatus().type?confirmStatus().text:null);if(errorMessageId)Dialog.error(errorMessageId);else{var p=Promise.resolve(!0);confirmAge.checked()||(p=Dialog.confirm("parentConfirmation_msg","paymentDataValidation_action")),p.then(function(confirmed){if(confirmed)return _this._signup(mailAddressForm.getCleanMailAddress(),passwordForm.getNewPassword(),codeField.value(),_this._upgradeData.campaign)})}}()},type:ButtonType.Login}))])]))}}return _createClass(SignupPage,[{key:"headerTitle",value:function(){return lang.get("subscription_label")}},{key:"nextAction",value:function(){return Promise.resolve(null)}},{key:"isNextAvailable",value:function(){return!1}},{key:"setPageActionHandler",value:function(handler){this._pageActionHandler=handler}},{key:"updateWizardData",value:function(wizardData){this._upgradeData=wizardData}},{key:"getUncheckedWizardData",value:function(){return this._upgradeData}},{key:"_getTermsLink",value:function(){return"de"===lang.code||"de_sie"===lang.code?"https://tutanota.com/de/terms#terms-free":"https://tutanota.com/terms#terms-free"}},{key:"_getPrivacyLink",value:function(){return"de"===lang.code||"de_sie"===lang.code?"https://tutanota.com/de/terms#privacy":"https://tutanota.com/terms#privacy"}},{key:"_signup",value:function(mailAddress,pw,registrationCode,campaign){var _this2=this;return showWorkerProgressDialog("createAccountRunning_msg",worker.generateSignupKeys().then(function(keyPairs){return _this2._runCaptcha(mailAddress,campaign).then(function(regDataId){if(regDataId)return worker.signup(keyPairs,AccountType.FREE,regDataId,mailAddress,pw,registrationCode,lang.code).then(function(recoverCode){deleteCampaign(),_this2._upgradeData.newAccountData={mailAddress:mailAddress,password:pw,recoverCode:recoverCode},_this2._pageActionHandler.showNext(_this2._upgradeData)})})})).catch(InvalidDataError,function(e){Dialog.error("invalidRegistrationCode_msg")})}},{key:"_runCaptcha",value:function(mailAddress,campaignToken){var _this3=this,data=createRegistrationCaptchaServiceGetData();return data.token=campaignToken,data.mailAddress=mailAddress,data.signupToken=deviceConfig.getSignupToken(),serviceRequest(SysService.RegistrationCaptchaService,HttpMethod.GET,data,RegistrationCaptchaServiceReturnTypeRef).then(function(captchaReturn){var regDataId=captchaReturn.token;return captchaReturn.challenge?Promise.fromCallback(function(callback){var dialog=void 0,cancelAction=function(){dialog.close(),callback(null)},actionBarAttrs={left:[{label:"cancel_action",click:cancelAction,type:ButtonType.Secondary}],right:[{label:"ok_action",click:function(){var captchaTime=captchaInput.value().trim();if(captchaTime.match(/^[0-2][0-9]:[0-5][05]$/)&&Number(captchaTime.substr(0,2))<24){var _data=createRegistrationCaptchaServiceData();_data.token=captchaReturn.token,_data.response=captchaTime,dialog.close(),serviceRequestVoid(SysService.RegistrationCaptchaService,HttpMethod.POST,_data).then(function(){callback(null,captchaReturn.token)}).catch(InvalidDataError,function(e){return Dialog.error("createAccountInvalidCaptcha_msg").then(function(){_this3._runCaptcha(mailAddress,campaignToken).then(function(regDataId){callback(null,regDataId)})})}).catch(AccessExpiredError,function(e){Dialog.error("createAccountAccessDeactivated_msg").then(function(){callback(null,null)})}).catch(function(e){callback(e)})}else Dialog.error("captchaEnter_msg")},type:ButtonType.Primary}],middle:function(){return lang.get("captchaDisplay_label")}},captchaInput=new TextField(function(){return lang.get("captchaInput_label")+" (hh:mm)"},function(){return lang.get("captchaInfo_msg")});dialog=new Dialog(DialogType.EditSmall,{view:function(){return[m(".dialog-header.plr-l",m(DialogHeaderBar,actionBarAttrs)),m(".plr-l.pb",[m("img.mt-l",{src:"data:image/png;base64,"+uint8ArrayToBase64(neverNull(captchaReturn.challenge)),alt:lang.get("captchaDisplay_label")}),m(captchaInput)])]}}).setCloseHandler(cancelAction).show()}):regDataId}).catch(AccessDeactivatedError,function(e){return Dialog.error("createAccountAccessDeactivated_msg")})}},{key:"updateUrl",value:function(args){}},{key:"showTerms",value:function(section){asyncImport("undefined"!=typeof module?module.id:_context.id,env.rootPathPrefix+"src/subscription/terms.js").then(function(terms){var dialog=void 0,visibleLang=lang.code,sanitizedTerms=void 0,headerBarAttrs={left:[{label:function(){return"EN/DE"},click:function(){visibleLang="de"===visibleLang?"en":"de",sanitizedTerms=htmlSanitizer.sanitize(terms[section+"_"+visibleLang],!1).text,m.redraw()},type:ButtonType.Secondary}],right:[{label:"ok_action",click:function(){return dialog.close()},type:ButtonType.Primary}]};sanitizedTerms=htmlSanitizer.sanitize(terms[section+"_"+visibleLang],!1).text,dialog=Dialog.largeDialog(headerBarAttrs,{view:function(){return m(".text-break",m.trust(sanitizedTerms))}}).show()})}},{key:"isEnabled",value:function(data){return!0}}]),SignupPage}()),_export("SignupPage",SignupPage)}}}),System.register("src/subscription/UpgradeSubscriptionWizard.js",["../api/Env","../api/common/utils/Utils","../api/entities/sys/Customer","../api/entities/sys/CustomerInfo","../api/entities/sys/AccountingInfo","../api/main/Entity","../api/main/LoginController","../api/common/TutanotaConstants","../api/common/CountryList","../gui/base/WizardDialog","./InvoiceAndPaymentDataPage","./UpgradeConfirmPage","./UpgradeSubscriptionPage","../misc/Formatter","./SignupPage","../misc/ClientDetector","mithril","./SubscriptionUtils","mithril/stream/stream.js","../api/common/EntityFunctions","../api/entities/sys/UpgradePriceServiceData","../api/entities/sys/Services","../api/entities/sys/UpgradePriceServiceReturn","../misc/LanguageViewModel"],function(_export,_context){"use strict";var assertMainOrNode,neverNull,CustomerTypeRef,CustomerInfoTypeRef,AccountingInfoTypeRef,load,serviceRequest,logins,Const,PaymentMethod,getByAbbreviation,WizardDialog,InvoiceAndPaymentDataPage,UpgradeConfirmPage,UpgradeSubscriptionPage,formatNameAndAddress,SignupPage,client,m,SubscriptionType,UpgradeType,stream,HttpMethod,createUpgradePriceServiceData,SysService,UpgradePriceServiceReturnTypeRef,assertTranslation,CAMPAIGN_KEY,TOKEN_PARAM_NAME;function getCampaign(){var hashString=location.hash;if(hashString.startsWith(TOKEN_PARAM_NAME)){var tokenFromUrl=hashString.substring(TOKEN_PARAM_NAME.length);return client.localStorage()&&localStorage.setItem(CAMPAIGN_KEY,tokenFromUrl),tokenFromUrl}return client.localStorage()?localStorage.getItem(CAMPAIGN_KEY):null}function loadUpgradePrices(){var data=createUpgradePriceServiceData();return data.date=Const.CURRENT_DATE,data.campaign=getCampaign(),serviceRequest(SysService.UpgradePriceService,HttpMethod.GET,data,UpgradePriceServiceReturnTypeRef)}return _export("deleteCampaign",function(){client.localStorage()&&localStorage.removeItem(CAMPAIGN_KEY)}),_export("showUpgradeWizard",function(){load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerInfoTypeRef,customer.customerInfo).then(function(customerInfo){return load(AccountingInfoTypeRef,customerInfo.accountingInfo).then(function(accountingInfo){return{customer:customer,customerInfo:customerInfo,accountingInfo:accountingInfo}})})}).then(function(_ref){_ref.customerInfo;var accountingInfo=_ref.accountingInfo;return loadUpgradePrices().then(function(prices){var upgradeData={options:{businessUse:stream(prices.business),paymentInterval:stream(Number(accountingInfo.paymentInterval))},invoiceData:{invoiceAddress:formatNameAndAddress(accountingInfo.invoiceName,accountingInfo.invoiceAddress),country:accountingInfo.invoiceCountry?getByAbbreviation(accountingInfo.invoiceCountry):null,vatNumber:accountingInfo.invoiceVatIdNo},paymentData:{paymentMethod:accountingInfo.paymentMethod||PaymentMethod.CreditCard,creditCardData:null},price:"",type:SubscriptionType.Premium,priceNextYear:null,accountingInfo:accountingInfo,newAccountData:null,campaign:getCampaign(),campaignInfoTextId:prices.messageTextId?assertTranslation(prices.messageTextId):null,upgradeType:UpgradeType.Initial,premiumPrices:prices.premiumPrices,teamsPrices:prices.teamsPrices,proPrices:prices.proPrices},wizardPages=[new UpgradeSubscriptionPage(upgradeData,SubscriptionType.Free),new InvoiceAndPaymentDataPage(upgradeData),new UpgradeConfirmPage(upgradeData)];new WizardDialog(wizardPages,function(){return Promise.resolve()}).show()})})}),_export("loadSignupWizard",function(){return loadUpgradePrices().then(function(prices){var signupData={options:{businessUse:stream(prices.business),paymentInterval:stream(12)},invoiceData:{invoiceAddress:"",country:null,vatNumber:""},paymentData:{paymentMethod:PaymentMethod.CreditCard,creditCardData:null},price:"",priceNextYear:null,type:SubscriptionType.Free,accountingInfo:null,newAccountData:null,campaign:getCampaign(),campaignInfoTextId:prices.messageTextId?assertTranslation(prices.messageTextId):null,upgradeType:UpgradeType.Signup,premiumPrices:prices.premiumPrices,teamsPrices:prices.teamsPrices,proPrices:prices.proPrices},wizardPages=[new UpgradeSubscriptionPage(signupData),new SignupPage(signupData),new InvoiceAndPaymentDataPage(signupData),new UpgradeConfirmPage(signupData)];return new WizardDialog(wizardPages,function(){return(logins.isUserLoggedIn()?logins.logout(!1):Promise.resolve()).then(function(){signupData.newAccountData?m.route.set("/login?loginWith="+signupData.newAccountData.mailAddress):m.route.set("/login")})})})}),{setters:[function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_apiEntitiesSysAccountingInfo){AccountingInfoTypeRef=_apiEntitiesSysAccountingInfo.AccountingInfoTypeRef},function(_apiMainEntity){load=_apiMainEntity.load,serviceRequest=_apiMainEntity.serviceRequest},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonTutanotaConstants){Const=_apiCommonTutanotaConstants.Const,PaymentMethod=_apiCommonTutanotaConstants.PaymentMethodType},function(_apiCommonCountryList){getByAbbreviation=_apiCommonCountryList.getByAbbreviation},function(_guiBaseWizardDialog){WizardDialog=_guiBaseWizardDialog.WizardDialog},function(_InvoiceAndPaymentDataPage){InvoiceAndPaymentDataPage=_InvoiceAndPaymentDataPage.InvoiceAndPaymentDataPage},function(_UpgradeConfirmPage){UpgradeConfirmPage=_UpgradeConfirmPage.UpgradeConfirmPage},function(_UpgradeSubscriptionPage){UpgradeSubscriptionPage=_UpgradeSubscriptionPage.UpgradeSubscriptionPage},function(_miscFormatter){formatNameAndAddress=_miscFormatter.formatNameAndAddress},function(_SignupPage){SignupPage=_SignupPage.SignupPage},function(_miscClientDetector){client=_miscClientDetector.client},function(_mithril){m=_mithril.default},function(_SubscriptionUtils){SubscriptionType=_SubscriptionUtils.SubscriptionType,UpgradeType=_SubscriptionUtils.UpgradeType},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiCommonEntityFunctions){HttpMethod=_apiCommonEntityFunctions.HttpMethod},function(_apiEntitiesSysUpgradePriceServiceData){createUpgradePriceServiceData=_apiEntitiesSysUpgradePriceServiceData.createUpgradePriceServiceData},function(_apiEntitiesSysServices){SysService=_apiEntitiesSysServices.SysService},function(_apiEntitiesSysUpgradePriceServiceReturn){UpgradePriceServiceReturnTypeRef=_apiEntitiesSysUpgradePriceServiceReturn.UpgradePriceServiceReturnTypeRef},function(_miscLanguageViewModel){assertTranslation=_miscLanguageViewModel.assertTranslation}],execute:function(){assertMainOrNode(),CAMPAIGN_KEY="campaign",TOKEN_PARAM_NAME="#token="}}}),System.register("src/gui/base/NotificationOverlay.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../size","../animation/Animations","./Overlay","../../api/Env","./ButtonN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,px,DefaultAnimationTime,transform,displayOverlay,assertMainOrNodeBoot,ButtonN,ButtonType,notificationQueue,currentAnimationTimeout,NotificationOverlay;function showNextNotification(){var _notificationQueue$=notificationQueue[0],message=_notificationQueue$.message,buttons=_notificationQueue$.buttons,closeButtonAttrs=_notificationQueue$.closeButtonAttrs;currentAnimationTimeout=null;var width=window.innerWidth,margin=(width-Math.min(400,width))/2,allButtons=buttons.slice(),closeFunction=displayOverlay({top:px(0),left:px(margin),right:px(margin)},{view:function(){return m(NotificationOverlay,{message:message,closeFunction:closeFunction,buttons:allButtons})}},function(dom){return transform(transform.type.translateY,-dom.offsetHeight,0)},function(dom){return transform(transform.type.translateY,0,-dom.offsetHeight)}),closeAndOpenNext=function(){null===currentAnimationTimeout&&(closeFunction(),notificationQueue.shift(),notificationQueue.length>0&&(currentAnimationTimeout=setTimeout(showNextNotification,2*DefaultAnimationTime)))};allButtons.forEach(function(b){var originClickHandler=b.click;b.click=function(){originClickHandler(),closeAndOpenNext()}});var closeFinalAttrs=Object.assign({},{label:"close_alt",click:closeAndOpenNext,type:ButtonType.Secondary},closeButtonAttrs);closeFinalAttrs.click=function(){closeButtonAttrs.click&&closeButtonAttrs.click(),closeAndOpenNext()},allButtons.unshift(closeFinalAttrs),m.redraw()}return _export("show",function(message,closeButtonAttrs,buttons){notificationQueue.push({message:message,buttons:buttons,closeButtonAttrs:closeButtonAttrs}),notificationQueue.length>1||showNextNotification()}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_size){px=_size.px},function(_animationAnimations){DefaultAnimationTime=_animationAnimations.DefaultAnimationTime,transform=_animationAnimations.transform},function(_Overlay){displayOverlay=_Overlay.displayOverlay},function(_apiEnv){assertMainOrNodeBoot=_apiEnv.assertMainOrNodeBoot},function(_ButtonN){ButtonN=_ButtonN.ButtonN,ButtonType=_ButtonN.ButtonType}],execute:function(){assertMainOrNodeBoot(),notificationQueue=[],currentAnimationTimeout=null,NotificationOverlay=function(){function NotificationOverlay(){_classCallCheck(this,NotificationOverlay)}return _createClass(NotificationOverlay,[{key:"view",value:function(vnode){return m(".notification-overlay-content.flex.flex-column.flex-space-between",[m(vnode.attrs.message),m(".flex.justify-end.flex-wrap",vnode.attrs.buttons.map(function(b){return m(ButtonN,b)}))])}}]),NotificationOverlay}()}}}),System.register("src/gui/base/CheckboxN.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","./icons/BootIcons","./Icon","./Flash"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,BootIcons,Icon,addFlash,removeFlash,_Checkbox,CheckboxN;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_iconsBootIcons){BootIcons=_iconsBootIcons.BootIcons},function(_Icon){Icon=_Icon.Icon},function(_Flash){addFlash=_Flash.addFlash,removeFlash=_Flash.removeFlash}],execute:function(){_export("_Checkbox",_Checkbox=function(){function _Checkbox(){_classCallCheck(this,_Checkbox),this.focused=stream(!1)}return _createClass(_Checkbox,[{key:"view",value:function(vnode){var _this=this,a=vnode.attrs;return m(".checkbox.click.pt",{onclick:function(e){e.target!==_this._domInput&&_this.toggle(e,a)}},[m(".wrapper.flex.items-center",{oncreate:function(vnode){return addFlash(vnode.dom)},onbeforeremove:function(vnode){return removeFlash(vnode.dom)}},[m("input[type=checkbox]",{oncreate:function(vnode){return _this._domInput=vnode.dom},onchange:function(e){return _this.toggle(e,a)},checked:a.checked(),onfocus:function(){return _this.focused(!0)},onblur:function(){return _this.focused(!1)},onremove:function(e){_this._domInput.onblur=null},style:{opacity:0,position:"absolute",cursor:"pointer",z_index:-1}}),m(Icon,{icon:a.checked()?BootIcons.CheckboxSelected:BootIcons.Checkbox,class:this.focused()?"svg-content-accent-fg":"svg-content-fg",oncreate:function(vnode){return _this._domIcon=vnode.dom},onclick:function(e){return _this.toggle(e,a)}}),m(".pl",{class:this.focused()?"content-accent-fg":"content-fg"},a.label())]),a.helpLabel?m("small.block.content-fg",a.helpLabel()):[]])}},{key:"toggle",value:function(event,attrs){attrs.disabled||attrs.checked(!attrs.checked()),event.stopPropagation(),this._domInput&&this._domInput.focus()}}]),_Checkbox}()),_export("_Checkbox",_Checkbox),_export("CheckboxN",CheckboxN=_Checkbox),_export("CheckboxN",CheckboxN)}}}),System.register("src/gui/base/ExpanderN.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../../misc/LanguageViewModel","../../../src/gui/animation/Animations","./Flash","./Icon","./icons/Icons","./icons/BootIcons","../theme","../../api/common/utils/Utils","../size"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,lang,animations,height,opacity,transform,addFlash,removeFlash,Icon,Icons,BootIcons,theme,neverNull,px,_ExpanderButton,_ExpanderPanel,ExpanderButtonN,ExpanderPanelN;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_srcGuiAnimationAnimations){animations=_srcGuiAnimationAnimations.animations,height=_srcGuiAnimationAnimations.height,opacity=_srcGuiAnimationAnimations.opacity,transform=_srcGuiAnimationAnimations.transform},function(_Flash){addFlash=_Flash.addFlash,removeFlash=_Flash.removeFlash},function(_Icon){Icon=_Icon.Icon},function(_iconsIcons){Icons=_iconsIcons.Icons},function(_iconsBootIcons){BootIcons=_iconsBootIcons.BootIcons},function(_theme){theme=_theme.theme},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_size){px=_size.px}],execute:function(){_ExpanderButton=function(){function _ExpanderButton(){_classCallCheck(this,_ExpanderButton)}return _createClass(_ExpanderButton,[{key:"view",value:function(vnode){var _this=this,a=vnode.attrs;return m(".flex.limit-width",[m("button.expander.bg-transparent.pt-s.hover-ul.limit-width.mr-s",{style:a.style,onclick:function(event){_this.toggle(a.expanded),event.stopPropagation()},oncreate:function(vnode){return addFlash(vnode.dom)},onbeforeremove:function(vnode){return removeFlash(vnode.dom)},"aria-expanded":String(!!a.expanded())},m(".flex.items-center",[a.showWarning?m(Icon,{icon:Icons.Warning,style:{fill:a.color?a.color:theme.content_button}}):null,m("small.b.text-ellipsis",lang.getMaybeLazy(a.label).toUpperCase()),m(Icon,{icon:BootIcons.Expand,class:"flex-center items-center",style:{fill:a.color?a.color:theme.content_button,"margin-right":px(-4)},oncreate:function(vnode){_this._domIcon=vnode.dom,a.expanded()&&(vnode.dom.style.transform="rotateZ(180deg)")}})]))])}},{key:"toggle",value:function(expanded){if(this._domIcon){var start=expanded()?180:0;animations.add(neverNull(this._domIcon),transform("rotateZ",start,start+180))}expanded(!expanded())}}]),_ExpanderButton}(),_ExpanderPanel=function(){function _ExpanderPanel(){_classCallCheck(this,_ExpanderPanel)}return _createClass(_ExpanderPanel,[{key:"view",value:function(vnode){var _this2=this;return m(".expander-panel.overflow-hidden",[vnode.attrs.expanded()?m("div",{oncreate:function(vnode){_this2._domPanel=vnode.dom,vnode.dom.style.height=0,_this2._animate(!0)},onbeforeremove:function(vnode){return _this2._animate(!1)},class:vnode.attrs.class},vnode.children):null])}},{key:"_animate",value:function(fadeIn){var _this3=this;animations.add(this._domPanel,fadeIn?opacity(0,1,!1):opacity(1,0,!1));var childHeight=Array.from(this._domPanel.children).map(function(domElement){return domElement.offsetHeight}).reduce(function(current,previous){return current+previous},0);return animations.add(this._domPanel,height(fadeIn?0:childHeight,fadeIn?childHeight:0)).then(function(){fadeIn&&(_this3._domPanel.style.height="")})}}]),_ExpanderPanel}(),_export("ExpanderButtonN",ExpanderButtonN=_ExpanderButton),_export("ExpanderButtonN",ExpanderButtonN),_export("ExpanderPanelN",ExpanderPanelN=_ExpanderPanel),_export("ExpanderPanelN",ExpanderPanelN)}}}),System.register("src/misc/ErrorHandlerImpl.js",["../api/common/error/RestError","../gui/base/Dialog","../api/main/WorkerClient","../gui/base/TextField","mithril","./LanguageViewModel","../api/Env","../api/common/TutanotaConstants","../api/common/utils/Utils","../mail/MailUtils","../api/main/LoginController","./ClientDetector","../api/common/error/OutOfSyncError","mithril/stream/stream.js","../api/common/error/SecondFactorPendingError","../login/SecondFactorHandler","../gui/base/ProgressDialog","../api/common/error/IndexingNotSupportedError","../subscription/UpgradeSubscriptionWizard","./WindowFacade","../api/common/utils/Encoding","../subscription/SubscriptionUtils","../gui/base/NotificationOverlay","../gui/base/ButtonN","../gui/base/CheckboxN","../gui/base/ExpanderN","../api/main/MainLocator","../api/common/error/QuotaExceededError"],function(_export,_context){"use strict";var AccessBlockedError,AccessDeactivatedError,AccessExpiredError,ConnectionError,InsufficientStorageError,InvalidSoftwareVersionError,NotAuthenticatedError,ServiceUnavailableError,SessionExpiredError,Dialog,DialogType,worker,TextField,Type,m,lang,assertMainOrNode,getHttpOrigin,isIOSApp,Mode,AccountType,ConversationType,errorToString,neverNull,createRecipientInfo,logins,client,OutOfSyncError,stream,SecondFactorPendingError,secondFactorHandler,showProgressDialog,IndexingNotSupportedError,showUpgradeWizard,windowFacade,generatedIdToTimestamp,formatPrice,notificationOverlay,ButtonType,CheckboxN,ExpanderButtonN,ExpanderPanelN,locator,QuotaExceededError,unknownErrorDialogActive,notConnectedDialogActive,invalidSoftwareVersionActive,loginDialogActive,isLoggingOut,serviceUnavailableDialogActive,shownQuotaError,ignoredMessages;function handleUncaughtError(e){var img;if(!isLoggingOut)if(e instanceof ConnectionError){if(!notConnectedDialogActive){notConnectedDialogActive=!0;(img=document.createElement("img")).onload=function(){Dialog.error("serverDownForMaintenance_msg").then(function(){notConnectedDialogActive=!1})},img.onerror=function(){Dialog.error("serverNotReachable_msg").then(function(){notConnectedDialogActive=!1})},img.src="https://tutanota.com/images/maintenancecheck.png"}}else if(e instanceof InvalidSoftwareVersionError)invalidSoftwareVersionActive||(invalidSoftwareVersionActive=!0,Dialog.error("outdatedClient_msg").then(function(){return invalidSoftwareVersionActive=!1}));else if(e instanceof NotAuthenticatedError||e instanceof AccessBlockedError||e instanceof AccessDeactivatedError||e instanceof AccessExpiredError)loginDialogActive||windowFacade.reload({});else if(e instanceof SessionExpiredError){if(!loginDialogActive){worker.resetSession(),loginDialogActive=!0;var errorMessage=stream(lang.get("emptyString_msg"));Dialog.showRequestPasswordDialog(errorMessage,{allowCancel:!1}).map(function(pw){showProgressDialog("pleaseWait_msg",worker.createSession(neverNull(logins.getUserController().userGroupInfo.mailAddress),pw,client.getIdentifier(),!1,!0)).then(function(){errorMessage(""),loginDialogActive=!1}).catch(AccessBlockedError,function(e){return errorMessage(lang.get("loginFailedOften_msg"))}).catch(NotAuthenticatedError,function(e){return errorMessage(lang.get("loginFailed_msg"))}).catch(AccessDeactivatedError,function(e){return errorMessage(lang.get("loginFailed_msg"))}).catch(ConnectionError,function(e){throw errorMessage(lang.get("emptyString_msg")),e}).finally(function(){return secondFactorHandler.closeWaitingForSecondFactorDialog()})})}}else e instanceof SecondFactorPendingError?secondFactorHandler.showWaitingForSecondFactorDialog(e.data.sessionId,e.data.challenges,e.data.mailAddress):e instanceof OutOfSyncError?Dialog.error("dataExpired_msg"):e instanceof InsufficientStorageError?logins.getUserController().isGlobalAdmin()?Dialog.error("insufficientStorageAdmin_msg").then(function(){}):Dialog.error("insufficientStorageUser_msg"):e instanceof ServiceUnavailableError?serviceUnavailableDialogActive||(serviceUnavailableDialogActive=!0,Dialog.error("serviceUnavailable_msg").then(function(){serviceUnavailableDialogActive=!1})):e instanceof IndexingNotSupportedError?(console.log("Indexing not supported",e),locator.search.indexingSupported=!1):e instanceof QuotaExceededError?shownQuotaError||(shownQuotaError=!0,Dialog.error("storageQuotaExceeded_msg")):function(e){return null!=e.message&&ignoredMessages.some(function(s){return e.message.includes(s)})}(e)||unknownErrorDialogActive||(unknownErrorDialogActive=!0,logins.isUserLoggedIn()?promptForFeedbackAndSend(e):(console.log("Unknown error",e),Dialog.error("unknownError_msg").then(function(){unknownErrorDialogActive=!1})))}function promptForFeedbackAndSend(e){return new Promise(function(resolve){var preparedContent=function(error){var _clientInfoString=clientInfoString(new Date),message=_clientInfoString.message,client=_clientInfoString.client,type=_clientInfoString.type;error&&(message+=errorToString(error));var subject="Feedback v"+env.versionNumber+" - "+(error&&error.name?error.name:"?")+" - "+type+" - "+client;return{message:message,subject:subject}}(e),detailsExpanded=stream(!1),textField=new TextField("yourMessage_label",function(){return lang.get("feedbackOnErrorInfo_msg")});textField.type=Type.Area;var errorOkAction=function(dialog){unknownErrorDialogActive=!1,preparedContent.message=textField.value()+"\n"+preparedContent.message,resolve(preparedContent),dialog.close()},ignoreChecked=stream();function addToIgnored(){ignoreChecked()&&ignoredMessages.push(e.message)}notificationOverlay.show({view:function(){return m("",["An error occurred",m(CheckboxN,{label:function(){return"Ignore the error for this session"},checked:ignoreChecked})])}},{label:"close_alt",click:function(){addToIgnored(),unknownErrorDialogActive=!1,resolve()}},[{label:function(){return"Send report"},click:function(){addToIgnored(),Dialog.showActionDialog({title:lang.get("sendErrorReport_action"),type:DialogType.EditMedium,child:{view:function(){return[m(textField),m(".flex-end",m(".right",m(ExpanderButtonN,{label:"details_label",expanded:detailsExpanded}))),m(ExpanderPanelN,{expanded:detailsExpanded},[m("",preparedContent.subject)].concat(preparedContent.message.split("\n").map(function(l){return""===l.trim()?m(".pb-m",""):m("",l)})))]}},okAction:errorOkAction,cancelAction:function(){unknownErrorDialogActive=!1,resolve(null)}})},type:ButtonType.Secondary}])}).then(function(content){content&&sendFeedbackMail(content)})}function clientInfoString(timestamp){var type=neverNull(Object.keys(AccountType).find(function(typeName){return AccountType[typeName]===logins.getUserController().user.accountType})),client=function(){var client=env.platformId;switch(env.mode){case Mode.App:case Mode.Desktop:client=env.platformId;break;case Mode.Browser:case Mode.Test:client=env.mode}return client||""}(),message="\n\n Client: "+client;return message+="\n Type: "+type,message+="\n Tutanota version: "+env.versionNumber,message+="\n Timestamp (UTC): "+timestamp.toUTCString(),{message:message+="\n User agent:\n"+navigator.userAgent+"\n",client:client,type:type}}function sendFeedbackMail(content){var recipient=createRecipientInfo("support@tutao.de","",null,!0);return worker.createMailDraft(content.subject,content.message.split("\n").join("<br>"),neverNull(logins.getUserController().userGroupInfo.mailAddress),"",[recipient],[],[],ConversationType.NEW,null,[],!0,[]).then(function(draft){return worker.sendMailDraft(draft,[recipient],"de")})}return _export("handleUncaughtError",handleUncaughtError),_export("promptForFeedbackAndSend",promptForFeedbackAndSend),_export("clientInfoString",clientInfoString),_export("sendFeedbackMail",sendFeedbackMail),_export("checkApprovalStatus",function(includeInvoiceNotPaidForAdmin,defaultStatus){return logins.getUserController().isInternalUser()?logins.getUserController().loadCustomer().then(function(customer){var status="0"===customer.approvalStatus&&defaultStatus?defaultStatus:customer.approvalStatus;return-1!==["1","5","7"].indexOf(status)?Dialog.error("waitingForApproval_msg").return(!1):"6"===status?(new Date).getTime()-generatedIdToTimestamp(customer._id)>1728e5?Dialog.error("requestApproval_msg").return(!0):Dialog.error("waitingForApproval_msg").return(!1):"3"===status?logins.getUserController().isGlobalAdmin()?!includeInvoiceNotPaidForAdmin||Dialog.error(function(){return lang.get("invoiceNotPaid_msg",{"{1}":getHttpOrigin()})}).then(function(){}).return(!0):Dialog.error("invoiceNotPaidUser_msg").return(!1):"4"!==status||(Dialog.error("loginAbuseDetected_msg"),!1)}):Promise.resolve(!0)}),_export("showNotAvailableForFreeDialog",function(isInPremiumIncluded){if(isIOSApp())Dialog.error("notAvailableInApp_msg");else{var _message=lang.get(isInPremiumIncluded?"onlyAvailableForPremium_msg":"onlyAvailableForPremiumNotIncluded_msg")+" "+lang.get("premiumOffer_msg",{"{1}":formatPrice(1,!0)});Dialog.reminder(lang.get("upgradeReminderTitle_msg"),_message,"https://tutanota.com/blog/posts/premium-pro-business").then(function(confirmed){confirmed&&showUpgradeWizard()})}}),_export("loggingOut",function(){isLoggingOut=!0,showProgressDialog("loggingOut_msg",Promise.fromCallback(function(cb){return null}))}),{setters:[function(_apiCommonErrorRestError){AccessBlockedError=_apiCommonErrorRestError.AccessBlockedError,AccessDeactivatedError=_apiCommonErrorRestError.AccessDeactivatedError,AccessExpiredError=_apiCommonErrorRestError.AccessExpiredError,ConnectionError=_apiCommonErrorRestError.ConnectionError,InsufficientStorageError=_apiCommonErrorRestError.InsufficientStorageError,InvalidSoftwareVersionError=_apiCommonErrorRestError.InvalidSoftwareVersionError,NotAuthenticatedError=_apiCommonErrorRestError.NotAuthenticatedError,ServiceUnavailableError=_apiCommonErrorRestError.ServiceUnavailableError,SessionExpiredError=_apiCommonErrorRestError.SessionExpiredError},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField,Type=_guiBaseTextField.Type},function(_mithril){m=_mithril.default},function(_LanguageViewModel){lang=_LanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,getHttpOrigin=_apiEnv.getHttpOrigin,isIOSApp=_apiEnv.isIOSApp,Mode=_apiEnv.Mode},function(_apiCommonTutanotaConstants){AccountType=_apiCommonTutanotaConstants.AccountType,ConversationType=_apiCommonTutanotaConstants.ConversationType},function(_apiCommonUtilsUtils){errorToString=_apiCommonUtilsUtils.errorToString,neverNull=_apiCommonUtilsUtils.neverNull},function(_mailMailUtils){createRecipientInfo=_mailMailUtils.createRecipientInfo},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_ClientDetector){client=_ClientDetector.client},function(_apiCommonErrorOutOfSyncError){OutOfSyncError=_apiCommonErrorOutOfSyncError.OutOfSyncError},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiCommonErrorSecondFactorPendingError){SecondFactorPendingError=_apiCommonErrorSecondFactorPendingError.SecondFactorPendingError},function(_loginSecondFactorHandler){secondFactorHandler=_loginSecondFactorHandler.secondFactorHandler},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog},function(_apiCommonErrorIndexingNotSupportedError){IndexingNotSupportedError=_apiCommonErrorIndexingNotSupportedError.IndexingNotSupportedError},function(_subscriptionUpgradeSubscriptionWizard){showUpgradeWizard=_subscriptionUpgradeSubscriptionWizard.showUpgradeWizard},function(_WindowFacade){windowFacade=_WindowFacade.windowFacade},function(_apiCommonUtilsEncoding){generatedIdToTimestamp=_apiCommonUtilsEncoding.generatedIdToTimestamp},function(_subscriptionSubscriptionUtils){formatPrice=_subscriptionSubscriptionUtils.formatPrice},function(_guiBaseNotificationOverlay){notificationOverlay=_guiBaseNotificationOverlay},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseCheckboxN){CheckboxN=_guiBaseCheckboxN.CheckboxN},function(_guiBaseExpanderN){ExpanderButtonN=_guiBaseExpanderN.ExpanderButtonN,ExpanderPanelN=_guiBaseExpanderN.ExpanderPanelN},function(_apiMainMainLocator){locator=_apiMainMainLocator.locator},function(_apiCommonErrorQuotaExceededError){QuotaExceededError=_apiCommonErrorQuotaExceededError.QuotaExceededError}],execute:function(){assertMainOrNode(),unknownErrorDialogActive=!1,notConnectedDialogActive=!1,invalidSoftwareVersionActive=!1,loginDialogActive=!1,isLoggingOut=!1,serviceUnavailableDialogActive=!1,shownQuotaError=!1,ignoredMessages=["webkitExitFullScreen","googletag","avast_submit"],"undefined"!=typeof window&&(window.tutao.testError=function(){return handleUncaughtError(new Error("test error!"))})}}}),System.register("src/subscription/PriceUtils.js",["../api/common/TutanotaConstants","../misc/LanguageViewModel.js","../subscription/SubscriptionUtils","../misc/ErrorHandlerImpl","../api/common/utils/Utils","../api/main/LoginController","../api/main/Entity","../api/entities/sys/Customer","../gui/base/Dialog"],function(_export,_context){"use strict";var PaymentMethodType,lang,formatPrice,showNotAvailableForFreeDialog,neverNull,logins,load,CustomerTypeRef,Dialog;function formatPriceWithInfo(price,paymentInterval,taxIncluded){var netOrGross=taxIncluded?lang.get("gross_label"):lang.get("net_label"),yearlyOrMonthly=12===paymentInterval?lang.get("pricing.perYear_label"):lang.get("pricing.perMonth_label");return formatPrice(price,!0)+" "+yearlyOrMonthly+" ("+netOrGross+")"}function getPriceItem(priceData,featureType){return priceData?priceData.items.find(function(item){return item.featureType===featureType}):null}return _export("getPaymentMethodName",function(paymentMethod){return paymentMethod===PaymentMethodType.Invoice?lang.get("paymentMethodOnAccount_label"):paymentMethod===PaymentMethodType.CreditCard?lang.get("paymentMethodCreditCard_label"):paymentMethod===PaymentMethodType.Sepa?"SEPA":paymentMethod===PaymentMethodType.Paypal?"PayPal":"<"+lang.get("comboBoxSelectionNone_msg")+">"}),_export("getPaymentMethodInfoText",function(accountingInfo){return accountingInfo.paymentMethodInfo?accountingInfo.paymentMethod===PaymentMethodType.CreditCard?lang.get("endsWith_label")+" "+neverNull(accountingInfo.paymentMethodInfo):neverNull(accountingInfo.paymentMethodInfo):""}),_export("formatPriceDataWithInfo",function(priceData){return formatPriceWithInfo(Number(priceData.price),Number(priceData.paymentInterval),priceData.taxIncluded)}),_export("formatPriceWithInfo",formatPriceWithInfo),_export("getPriceItem",getPriceItem),_export("getCountFromPriceData",function(priceData,featureType){var priceItem=getPriceItem(priceData,featureType);return priceItem?Number(priceItem.count):0}),_export("getPriceFromPriceData",function(priceData,featureType){var item=getPriceItem(priceData,featureType);return item?Number(item.price):0}),_export("getCurrentCount",function(featureType,booking){if(booking){var bookingItem=booking.items.find(function(item){return item.featureType===featureType});return bookingItem?Number(bookingItem.currentCount):0}return 0}),_export("createNotAvailableForFreeClickHandler",function(includedInPremium,click,available){return function(e,dom){available()?click(e,dom):showNotAvailableForFreeDialog(includedInPremium)}}),_export("premiumSubscriptionActive",function(included){return logins.getUserController().isFreeAccount()?(showNotAvailableForFreeDialog(included),Promise.resolve(!1)):load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return customer.canceledPremiumAccount?Dialog.error("subscriptionCancelledMessage_msg").return(!1):Promise.resolve(!0)})}),{setters:[function(_apiCommonTutanotaConstants){PaymentMethodType=_apiCommonTutanotaConstants.PaymentMethodType},function(_miscLanguageViewModelJs){lang=_miscLanguageViewModelJs.lang},function(_subscriptionSubscriptionUtils){formatPrice=_subscriptionSubscriptionUtils.formatPrice},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiMainEntity){load=_apiMainEntity.load},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog}],execute:function(){}}}),System.register("src/subscription/SubscriptionUtils.js",["../misc/LanguageViewModel","../api/common/TutanotaConstants","./PriceUtils","../api/common/error/RestError"],function(_export,_context){"use strict";var lang,AccountType,BookingItemFeatureType,getCurrentCount,SubscriptionType,UpgradeType,PaymentIntervalItems,BusinessUseItems,UpgradePriceType;function formatPrice(value,includeCurrency){return value=Math.round(100*value)/100,includeCurrency?value%1!=0?lang.formats.priceWithCurrency.format(value):lang.formats.priceWithCurrencyWithoutFractionDigits.format(value):value%1!=0?lang.formats.priceWithoutCurrency.format(value):lang.formats.priceWithoutCurrencyWithoutFractionDigits.format(value)}function getUpgradePrice(attrs,subscription,type){var prices=subscription===SubscriptionType.Premium?attrs.premiumPrices:subscription===SubscriptionType.Teams?attrs.teamsPrices:attrs.proPrices,monthlyPriceString=void 0,monthsFactor=12===attrs.options.paymentInterval()?10:1,discount=0;return type===UpgradePriceType.PlanReferencePrice?(monthlyPriceString=prices.monthlyReferencePrice,12===attrs.options.paymentInterval()&&(monthsFactor=12)):type===UpgradePriceType.PlanActualPrice?(monthlyPriceString=prices.monthlyPrice,12===attrs.options.paymentInterval()&&(discount=Number(prices.firstYearDiscount))):type===UpgradePriceType.PlanNextYearsPrice?monthlyPriceString=prices.monthlyPrice:type===UpgradePriceType.AdditionalUserPrice?monthlyPriceString=prices.additionalUserPriceMonthly:type===UpgradePriceType.ContactFormPrice&&(monthlyPriceString=prices.contactFormPriceMonthly),Number(monthlyPriceString)*monthsFactor-discount}function getTotalStorageCapacity(customer,customerInfo,lastBooking){var freeStorageCapacity=getIncludedStorageCapacity(customerInfo);return customer.type===AccountType.PREMIUM?Math.max(freeStorageCapacity,getCurrentCount(BookingItemFeatureType.Storage,lastBooking)):freeStorageCapacity}function getIncludedStorageCapacity(customerInfo){return Math.max(Number(customerInfo.includedStorageCapacity),Number(customerInfo.promotionStorageCapacity))}function getTotalAliases(customer,customerInfo,lastBooking){var freeAliases=getIncludedAliases(customerInfo);return customer.type===AccountType.PREMIUM?Math.max(freeAliases,getCurrentCount(BookingItemFeatureType.Alias,lastBooking)):freeAliases}function isWhitelabelActive(lastBooking){return 0!==getCurrentCount(BookingItemFeatureType.Branding,lastBooking)}function isSharingActive(lastBooking){return 0!==getCurrentCount(BookingItemFeatureType.Sharing,lastBooking)}function getIncludedAliases(customerInfo){return Math.max(Number(customerInfo.includedEmailAliases),Number(customerInfo.promotionEmailAliases))}return _export("formatPrice",formatPrice),_export("getUpgradePrice",getUpgradePrice),_export("getFormattetUpgradePrice",function(attrs,subscription,type){return formatPrice(getUpgradePrice(attrs,subscription,type),!0)}),_export("getTotalStorageCapacity",getTotalStorageCapacity),_export("getIncludedStorageCapacity",getIncludedStorageCapacity),_export("getTotalAliases",getTotalAliases),_export("getNbrOfUsers",function(lastBooking){return getCurrentCount(BookingItemFeatureType.Users,lastBooking)}),_export("isWhitelabelActive",isWhitelabelActive),_export("isSharingActive",isSharingActive),_export("getIncludedAliases",getIncludedAliases),_export("getSubscriptionType",function(lastBooking,customer,customerInfo){if(customer.type!==AccountType.PREMIUM)return SubscriptionType.Free;var aliases=getTotalAliases(customer,customerInfo,lastBooking),storage=getTotalStorageCapacity(customer,customerInfo,lastBooking);return isSharingActive(lastBooking)&&isWhitelabelActive(lastBooking)&&aliases>=20&&storage>=10?SubscriptionType.Pro:isSharingActive(lastBooking)&&storage>=10?SubscriptionType.Teams:SubscriptionType.Premium}),_export("getPreconditionFailedPaymentMsg",function(e){switch(e.data){case"paypal.change":return"payChangeError_msg";case"paypal.confirm_again":return"payPaypalConfirmAgainError_msg";case"paypal.other_source":return"payPaypalChangeSourceError_msg";case"card.contact_bank":return"payCardContactBankError_msg";case"card.insufficient_funds":return"payCardInsufficientFundsError_msg";case"card.expired_card":return"payCardExpiredError_msg";case"card.change":return"payChangeError_msg";default:return"payContactUsError_msg"}}),{setters:[function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonTutanotaConstants){AccountType=_apiCommonTutanotaConstants.AccountType,BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType},function(_PriceUtils){getCurrentCount=_PriceUtils.getCurrentCount},function(_apiCommonErrorRestError){_apiCommonErrorRestError.PreconditionFailedError}],execute:function(){_export("SubscriptionType",SubscriptionType=Object.freeze({Free:"Free",Premium:"Premium",Teams:"Teams",Pro:"Pro"})),_export("SubscriptionType",SubscriptionType),_export("UpgradeType",UpgradeType={Signup:"Signup",Initial:"Initial",Switch:"Switch"}),_export("UpgradeType",UpgradeType),_export("PaymentIntervalItems",PaymentIntervalItems=[{name:lang.get("pricing.yearly_label"),value:12},{name:lang.get("pricing.monthly_label"),value:1}]),_export("PaymentIntervalItems",PaymentIntervalItems),_export("BusinessUseItems",BusinessUseItems=[{name:lang.get("pricing.privateUse_label"),value:!1},{name:lang.get("pricing.businessUse_label"),value:!0}]),_export("BusinessUseItems",BusinessUseItems),_export("UpgradePriceType",UpgradePriceType=Object.freeze({PlanReferencePrice:"0",PlanActualPrice:"1",PlanNextYearsPrice:"2",AdditionalUserPrice:"3",ContactFormPrice:"4"})),_export("UpgradePriceType",UpgradePriceType)}}}),System.register("src/subscription/BuyDialog.js",["mithril","../api/Env","../api/main/WorkerClient","../gui/base/TextField","../gui/base/ButtonN","../gui/base/Dialog","../misc/LanguageViewModel","../api/common/TutanotaConstants","../api/common/utils/Utils","../misc/Formatter","../api/main/Entity","../api/entities/sys/Customer","../api/entities/sys/CustomerInfo","../api/entities/sys/AccountingInfo","../api/main/LoginController","../api/common/error/RestError","./PriceUtils","./SubscriptionUtils","../gui/base/DialogHeaderBar"],function(_export,_context){"use strict";var m,assertMainOrNode,worker,TextField,ButtonType,Dialog,DialogType,lang,AccountType,BookingItemFeatureType,FeatureType,neverNull,formatDate,load,CustomerTypeRef,CustomerInfoTypeRef,AccountingInfoTypeRef,logins,NotAuthorizedError,getPriceItem,formatPrice,DialogHeaderBar;function _isSinglePriceType(currentPriceData,futurePriceData,featureType){var item=getPriceItem(futurePriceData,featureType)||getPriceItem(currentPriceData,featureType);return neverNull(item).singleType}function _getPriceFromPriceData(priceData,featureType){var item=getPriceItem(priceData,featureType),itemPrice=item?Number(item.price):0;return featureType===BookingItemFeatureType.Users&&(itemPrice+=_getPriceFromPriceData(priceData,BookingItemFeatureType.Branding),itemPrice+=_getPriceFromPriceData(priceData,BookingItemFeatureType.Sharing)),itemPrice}return _export("show",function(featureType,count,freeAmount,reactivate){return logins.isEnabled(FeatureType.HideBuyDialogs)?Promise.resolve(!0):load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return customer.type===AccountType.PREMIUM&&customer.canceledPremiumAccount?Dialog.error("subscriptionCancelledMessage_msg").return(!1):worker.getPrice(featureType,count,reactivate).then(function(price){return function(price,featureType){return _getPriceFromPriceData(price.currentPriceNextPeriod,featureType)!==_getPriceFromPriceData(price.futurePriceNextPeriod,featureType)}(price,featureType)?load(CustomerInfoTypeRef,customer.customerInfo).then(function(customerInfo){return load(AccountingInfoTypeRef,customerInfo.accountingInfo).catch(NotAuthorizedError,function(e){}).then(function(accountingInfo){if(accountingInfo&&null==accountingInfo.paymentMethod)return Dialog.confirm("enterPaymentDataFirst_msg").then(function(confirm){return confirm&&m.route.set("/settings/invoice"),!1});var buy=function(price,featureType){return _getPriceFromPriceData(price.currentPriceNextPeriod,featureType)<_getPriceFromPriceData(price.futurePriceNextPeriod,featureType)}(price,featureType),orderField=new TextField("bookingOrder_label").setValue(function(price,featureType,count,freeAmount){if(_isSinglePriceType(price.currentPriceThisPeriod,price.futurePriceNextPeriod,featureType)){if(featureType===BookingItemFeatureType.Users){if(count>0){var additionalFeatures=[];return _getPriceFromPriceData(price.futurePriceNextPeriod,BookingItemFeatureType.Branding)>0&&additionalFeatures.push(lang.get("whitelabel_label")),_getPriceFromPriceData(price.futurePriceNextPeriod,BookingItemFeatureType.Sharing)>0&&additionalFeatures.push(lang.get("sharing_label")),additionalFeatures.length>0?count+" "+lang.get("bookingItemUsersIncluding_label")+" "+additionalFeatures.join(", "):count+" "+lang.get("bookingItemUsers_label")}return lang.get("cancelUserAccounts_label",{"{1}":Math.abs(count)})}return featureType===BookingItemFeatureType.Branding?count>0?lang.get("whitelabelBooking_label",{"{1}":neverNull(getPriceItem(price.futurePriceNextPeriod,BookingItemFeatureType.Branding)).count}):lang.get("cancelWhitelabelBooking_label",{"{1}":neverNull(getPriceItem(price.currentPriceNextPeriod,BookingItemFeatureType.Branding)).count}):featureType===BookingItemFeatureType.Sharing?count>0?lang.get("sharingBooking_label",{"{1}":neverNull(getPriceItem(price.futurePriceNextPeriod,BookingItemFeatureType.Sharing)).count}):lang.get("cancelSharingBooking_label",{"{1}":neverNull(getPriceItem(price.currentPriceNextPeriod,BookingItemFeatureType.Sharing)).count}):featureType===BookingItemFeatureType.ContactForm?count>0?count+" "+lang.get("contactForm_label"):lang.get("cancelContactForm_label"):featureType===BookingItemFeatureType.SharedMailGroup?count>0?count+" "+lang.get(1===count?"sharedMailbox_label":"sharedMailboxes_label"):lang.get("cancelSharedMailbox_label"):featureType===BookingItemFeatureType.LocalAdminGroup?count>0?count+" "+lang.get(1===count?"localAdminGroup_label":"localAdminGroups_label"):lang.get("cancelLocalAdminGroup_label"):""}var item=getPriceItem(price.futurePriceNextPeriod,featureType),newPackageCount=0;null!=item&&(newPackageCount=item.count);var visibleAmount=Math.max(count,freeAmount);return featureType===BookingItemFeatureType.Storage?count<1e3?lang.get("storageCapacity_label")+" "+visibleAmount+" GB":lang.get("storageCapacity_label")+" "+visibleAmount/1e3+" TB":featureType===BookingItemFeatureType.Users?count>0?lang.get("packageUpgradeUserAccounts_label",{"{1}":newPackageCount}):lang.get("packageDowngradeUserAccounts_label",{"{1}":newPackageCount}):featureType===BookingItemFeatureType.Alias?visibleAmount+" "+lang.get("mailAddressAliases_label"):""}(price,featureType,count,freeAmount)).setDisabled(),buyField=buy?new TextField("subscription_label",function(){return function(price){return lang.get("endOfSubscriptionPeriod_label",{"{1}":formatDate(price.periodEndDate)})}(price)}).setValue(function(price){return"12"===neverNull(price.futurePriceNextPeriod).paymentInterval?lang.get("pricing.yearly_label")+", "+lang.get("automaticRenewal_label"):lang.get("pricing.monthly_label")+", "+lang.get("automaticRenewal_label")}(price)).setDisabled():null,priceField=new TextField("price_label",function(){return function(price,featureType){return function(price,featureType){return _getPriceFromPriceData(price.currentPriceNextPeriod,featureType)>_getPriceFromPriceData(price.futurePriceNextPeriod,featureType)}(price,featureType)?lang.get("priceChangeValidFrom_label",{"{1}":formatDate(price.periodEndDate)}):price.currentPeriodAddedPrice&&Number(price.currentPeriodAddedPrice)>=0?lang.get("priceForCurrentAccountingPeriod_label",{"{1}":formatPrice(Number(price.currentPeriodAddedPrice),!0)}):""}(price,featureType)}).setValue(function(price,featureType){var netGrossText=neverNull(price.futurePriceNextPeriod).taxIncluded?lang.get("gross_label"):lang.get("net_label"),periodText="12"===neverNull(price.futurePriceNextPeriod).paymentInterval?lang.get("pricing.perYear_label"):lang.get("pricing.perMonth_label"),futurePriceNextPeriod=_getPriceFromPriceData(price.futurePriceNextPeriod,featureType),currentPriceNextPeriod=_getPriceFromPriceData(price.currentPriceNextPeriod,featureType);if(_isSinglePriceType(price.currentPriceThisPeriod,price.futurePriceNextPeriod,featureType)){var priceDiff=futurePriceNextPeriod-currentPriceNextPeriod;return formatPrice(priceDiff,!0)+" "+periodText+" ("+netGrossText+")"}return formatPrice(futurePriceNextPeriod,!0)+" "+periodText+" ("+netGrossText+")"}(price,featureType)).setDisabled();return new Promise(function(resolve){var dialog=void 0,doAction=function(res){dialog.close(),resolve(res)},actionBarAttrs={left:[{label:"cancel_action",click:function(){return doAction(!1)},type:ButtonType.Secondary}],right:[{label:buy?"buy_action":"order_action",click:function(){return doAction(!0)},type:ButtonType.Primary}],middle:function(){return lang.get("bookingSummary_label")}};dialog=new Dialog(DialogType.EditSmall,{view:function(){return[m(".dialog-header.plr-l",m(DialogHeaderBar,actionBarAttrs)),m(".plr-l.pb",m("",[m(orderField),buyField?m(buyField):null,m(priceField)]))]}}).setCloseHandler(function(){return doAction(!1)}).show()})})}):Promise.resolve(!0)})})}),{setters:[function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_guiBaseButtonN){ButtonType=_guiBaseButtonN.ButtonType},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog,DialogType=_guiBaseDialog.DialogType},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonTutanotaConstants){AccountType=_apiCommonTutanotaConstants.AccountType,BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,FeatureType=_apiCommonTutanotaConstants.FeatureType},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_miscFormatter){formatDate=_miscFormatter.formatDate},function(_apiMainEntity){load=_apiMainEntity.load},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_apiEntitiesSysAccountingInfo){AccountingInfoTypeRef=_apiEntitiesSysAccountingInfo.AccountingInfoTypeRef},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_apiCommonErrorRestError){NotAuthorizedError=_apiCommonErrorRestError.NotAuthorizedError},function(_PriceUtils){getPriceItem=_PriceUtils.getPriceItem},function(_SubscriptionUtils){formatPrice=_SubscriptionUtils.formatPrice},function(_guiBaseDialogHeaderBar){DialogHeaderBar=_guiBaseDialogHeaderBar.DialogHeaderBar}],execute:function(){assertMainOrNode()}}}),System.register("src/gui/base/DialogHeaderBar.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./ButtonN"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,ButtonN,isVisible,_DialogHeaderBar,DialogHeaderBar;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_ButtonN){ButtonN=_ButtonN.ButtonN,isVisible=_ButtonN.isVisible}],execute:function(){_DialogHeaderBar=function(){function _DialogHeaderBar(){_classCallCheck(this,_DialogHeaderBar)}return _createClass(_DialogHeaderBar,[{key:"view",value:function(vnode){var a=Object.assign({},{left:[],right:[]},vnode.attrs),columnClass=a.middle?".flex-third.overflow-hidden":".flex-half.overflow-hidden";return m(".flex-space-between.dialog-header-line-height",[m(columnClass+".ml-negative-s",a.left.map(function(a){return isVisible(a)?m(ButtonN,a):null})),a.middle?m("#dialog-title.flex-third-middle.overflow-hidden.flex.justify-center.items-center.b",[m(".text-ellipsis",a.middle())]):null,m(columnClass+".mr-negative-s.flex.justify-end",a.right.map(function(a){return isVisible(a)?m(ButtonN,a):null}))])}}]),_DialogHeaderBar}(),_export("DialogHeaderBar",DialogHeaderBar=_DialogHeaderBar),_export("DialogHeaderBar",DialogHeaderBar)}}}),System.register("src/api/common/CountryList.js",[],function(_export,_context){"use strict";var CountryType,DecimalSeparator,Countries;function getByAbbreviation(abbreviation){return Countries.find(function(c){return c.a===abbreviation})}return _export("getByAbbreviation",getByAbbreviation),_export("getDecimalSeparator",function(abbreviation){var country=getByAbbreviation(abbreviation);return country&&country.d===DecimalSeparator.DOT?".":","}),{setters:[],execute:function(){_export("CountryType",CountryType={GERMANY:0,EU:1,OTHER:2}),_export("CountryType",CountryType),_export("DecimalSeparator",DecimalSeparator={COMMA:0,DOT:1,UNKNOWN:2}),_export("DecimalSeparator",DecimalSeparator),_export("Countries",Countries=[{n:"Afghanistan",a:"AF",t:2,d:2},{n:"Åland Islands",a:"AX",t:2,d:2},{n:"Albania",a:"AL",t:2,d:0},{n:"Algeria",a:"DZ",t:2,d:0},{n:"American Samoa",a:"AS",t:2,d:2},{n:"Andorra",a:"AD",t:2,d:0},{n:"Angola",a:"AO",t:2,d:0},{n:"Anguilla",a:"AI",t:2,d:2},{n:"Antarctica",a:"AQ",t:2,d:2},{n:"Antigua and Barbuda",a:"AG",t:2,d:2},{n:"Argentina",a:"AR",t:2,d:0},{n:"Armenia",a:"AM",t:2,d:0},{n:"Aruba",a:"AW",t:2,d:2},{n:"Australia",a:"AU",t:2,d:1},{n:"Azerbaijan",a:"AZ",t:2,d:0},{n:"Bahamas",a:"BS",t:2,d:2},{n:"Bahrain",a:"BH",t:2,d:2},{n:"Bangladesh",a:"BD",t:2,d:1},{n:"Barbados",a:"BB",t:2,d:2},{n:"Belarus",a:"BY",t:2,d:0},{n:"Belgium",a:"BE",t:1,d:0},{n:"Belize",a:"BZ",t:2,d:2},{n:"Benin",a:"BJ",t:2,d:2},{n:"Bermuda",a:"BM",t:2,d:2},{n:"Bhutan",a:"BT",t:2,d:2},{n:"Bolivia (Plurinational State of)",a:"BO",t:2,d:0},{n:"Bonaire",a:"BQ",t:2,d:2},{n:"Bosnia and Herzegovina",a:"BA",t:2,d:0},{n:"Botswana",a:"BW",t:2,d:1},{n:"Bouvet Island",a:"BV",t:2,d:2},{n:"Brazil",a:"BR",t:2,d:0},{n:"British Indian Ocean Territory",a:"IO",t:2,d:2},{n:"Brunei Darussalam",a:"BN",t:2,d:1},{n:"Bulgaria",a:"BG",t:1,d:0},{n:"Burkina Faso",a:"BF",t:2,d:2},{n:"Burundi",a:"BI",t:2,d:2},{n:"Cabo Verde",a:"CV",t:2,d:2},{n:"Cambodia",a:"KH",t:2,d:1},{n:"Cameroon",a:"CM",t:2,d:0},{n:"Canada",a:"CA",t:2,d:1},{n:"Cayman Islands",a:"KY",t:2,d:2},{n:"Central African Republic",a:"CF",t:2,d:2},{n:"Chad",a:"TD",t:2,d:2},{n:"Chile",a:"CL",t:2,d:0},{n:"China",a:"CN",t:2,d:1},{n:"Christmas Island",a:"CX",t:2,d:2},{n:"Cocos (Keeling) Islands",a:"CC",t:2,d:2},{n:"Colombia",a:"CO",t:2,d:0},{n:"Comoros",a:"KM",t:2,d:2},{n:"Congo",a:"CG",t:2,d:2},{n:"Congo (Democratic Republic of the)",a:"CD",t:2,d:2},{n:"Cook Islands",a:"CK",t:2,d:2},{n:"Costa Rica",a:"CR",t:2,d:0},{n:"Côte d'Ivoire",a:"CI",t:2,d:2},{n:"Croatia",a:"HR",t:1,d:0},{n:"Cuba",a:"CU",t:2,d:0},{n:"Curaçao",a:"CW",t:2,d:2},{n:"Cyprus",a:"CY",t:1,d:0},{n:"Czech Republic",a:"CZ",t:1,d:0},{n:"Denmark",a:"DK",t:1,d:0},{n:"Deutschland",a:"DE",t:0,d:0},{n:"Djibouti",a:"DJ",t:2,d:2},{n:"Dominica",a:"DM",t:2,d:2},{n:"Dominican Republic",a:"DO",t:2,d:1},{n:"Ecuador",a:"EC",t:2,d:0},{n:"Egypt",a:"EG",t:2,d:1},{n:"El Salvador",a:"SV",t:2,d:1},{n:"Equatorial Guinea",a:"GQ",t:2,d:2},{n:"Eritrea",a:"ER",t:2,d:2},{n:"Estonia",a:"EE",t:1,d:0},{n:"Ethiopia",a:"ET",t:2,d:2},{n:"Falkland Islands (Malvinas)",a:"FK",t:2,d:2},{n:"Faroe Islands",a:"FO",t:2,d:0},{n:"Fiji",a:"FJ",t:2,d:2},{n:"Finland",a:"FI",t:1,d:0},{n:"France",a:"FR",t:1,d:0},{n:"French Guiana",a:"GF",t:2,d:2},{n:"French Polynesia",a:"PF",t:2,d:2},{n:"French Southern Territories",a:"TF",t:2,d:2},{n:"Gabon",a:"GA",t:2,d:2},{n:"Gambia",a:"GM",t:2,d:2},{n:"Georgia",a:"GE",t:2,d:0},{n:"Ghana",a:"GH",t:2,d:1},{n:"Gibraltar",a:"GI",t:2,d:2},{n:"Greece",a:"GR",t:1,d:0},{n:"Greenland",a:"GL",t:2,d:0},{n:"Grenada",a:"GD",t:2,d:2},{n:"Guadeloupe",a:"GP",t:2,d:2},{n:"Guam",a:"GU",t:2,d:2},{n:"Guatemala",a:"GT",t:2,d:1},{n:"Guernsey",a:"GG",t:2,d:2},{n:"Guinea",a:"GN",t:2,d:2},{n:"Guinea-Bissau",a:"GW",t:2,d:2},{n:"Guyana",a:"GY",t:2,d:2},{n:"Haiti",a:"HT",t:2,d:2},{n:"Heard Island and McDonald Islands",a:"HM",t:2,d:2},{n:"Holy See",a:"VA",t:2,d:2},{n:"Honduras",a:"HN",t:2,d:1},{n:"Hong Kong",a:"HK",t:2,d:1},{n:"Hungary",a:"HU",t:1,d:0},{n:"Iceland",a:"IS",t:2,d:0},{n:"India",a:"IN",t:2,d:1},{n:"Indonesia",a:"ID",t:2,d:0},{n:"Iran (Islamic Republic of)",a:"IR",t:2,d:2},{n:"Iraq",a:"IQ",t:2,d:2},{n:"Ireland",a:"IE",t:1,d:1},{n:"Isle of Man",a:"IM",t:2,d:2},{n:"Israel",a:"IL",t:2,d:1},{n:"Italy",a:"IT",t:1,d:0},{n:"Jamaica",a:"JM",t:2,d:2},{n:"Japan",a:"JP",t:2,d:1},{n:"Jersey",a:"JE",t:2,d:2},{n:"Jordan",a:"JO",t:2,d:1},{n:"Kazakhstan",a:"KZ",t:2,d:0},{n:"Kenya",a:"KE",t:2,d:1},{n:"Kiribati",a:"KI",t:2,d:2},{n:"Korea (Democratic People's Republic of)",a:"KP",t:2,d:1},{n:"Korea (Republic of)",a:"KR",t:2,d:1},{n:"Kuwait",a:"KW",t:2,d:2},{n:"Kyrgyzstan",a:"KG",t:2,d:0},{n:"Lao People's Democratic Republic",a:"LA",t:2,d:2},{n:"Latvia",a:"LV",t:1,d:0},{n:"Lebanon",a:"LB",t:2,d:2},{n:"Lesotho",a:"LS",t:2,d:2},{n:"Liberia",a:"LR",t:2,d:2},{n:"Libya",a:"LY",t:2,d:2},{n:"Liechtenstein",a:"LI",t:2,d:2},{n:"Lithuania",a:"LT",t:1,d:0},{n:"Luxembourg",a:"LU",t:1,d:2},{n:"Macao",a:"MO",t:2,d:2},{n:"Macedonia",a:"MK",t:2,d:0},{n:"Madagascar",a:"MG",t:2,d:2},{n:"Malawi",a:"MW",t:2,d:2},{n:"Malaysia",a:"MY",t:2,d:1},{n:"Maldives",a:"MV",t:2,d:2},{n:"Mali",a:"ML",t:2,d:2},{n:"Malta",a:"MT",t:1,d:1},{n:"Marshall Islands",a:"MH",t:2,d:2},{n:"Martinique",a:"MQ",t:2,d:2},{n:"Mauritania",a:"MR",t:2,d:2},{n:"Mauritius",a:"MU",t:2,d:2},{n:"Mayotte",a:"YT",t:2,d:2},{n:"Mexico",a:"MX",t:2,d:1},{n:"Micronesia (Federated States of)",a:"FM",t:2,d:2},{n:"Moldova (Republic of)",a:"MD",t:2,d:0},{n:"Monaco",a:"MC",t:2,d:2},{n:"Mongolia",a:"MN",t:2,d:2},{n:"Montenegro",a:"ME",t:2,d:2},{n:"Montserrat",a:"MS",t:2,d:2},{n:"Morocco",a:"MA",t:2,d:0},{n:"Mozambique",a:"MZ",t:2,d:0},{n:"Myanmar",a:"MM",t:2,d:1},{n:"Namibia",a:"NA",t:2,d:0},{n:"Nauru",a:"NR",t:2,d:2},{n:"Nepal",a:"NP",t:2,d:1},{n:"Netherlands",a:"NL",t:1,d:0},{n:"New Caledonia",a:"NC",t:2,d:2},{n:"New Zealand",a:"NZ",t:2,d:1},{n:"Nicaragua",a:"NI",t:2,d:1},{n:"Niger",a:"NE",t:2,d:2},{n:"Nigeria",a:"NG",t:2,d:1},{n:"Niue",a:"NU",t:2,d:2},{n:"Norfolk Island",a:"NF",t:2,d:2},{n:"Northern Mariana Islands",a:"MP",t:2,d:2},{n:"Norway",a:"NO",t:2,d:0},{n:"Oman",a:"OM",t:2,d:2},{n:"Österreich",a:"AT",t:1,d:0},{n:"Pakistan",a:"PK",t:2,d:1},{n:"Palau",a:"PW",t:2,d:2},{n:"Palestine",a:"PS",t:2,d:1},{n:"Panama",a:"PA",t:2,d:1},{n:"Papua New Guinea",a:"PG",t:2,d:2},{n:"Paraguay",a:"PY",t:2,d:0},{n:"Peru",a:"PE",t:2,d:0},{n:"Philippines",a:"PH",t:2,d:1},{n:"Pitcairn",a:"PN",t:2,d:2},{n:"Poland",a:"PL",t:1,d:0},{n:"Portugal",a:"PT",t:1,d:0},{n:"Puerto Rico",a:"PR",t:2,d:1},{n:"Qatar",a:"QA",t:2,d:2},{n:"Réunion",a:"RE",t:2,d:2},{n:"Romania",a:"RO",t:1,d:0},{n:"Russian Federation",a:"RU",t:2,d:0},{n:"Rwanda",a:"RW",t:2,d:2},{n:"Saint Barthélemy",a:"BL",t:2,d:2},{n:"Saint Helena",a:"SH",t:2,d:2},{n:"Saint Kitts and Nevis",a:"KN",t:2,d:2},{n:"Saint Lucia",a:"LC",t:2,d:2},{n:"Saint Martin (French part)",a:"MF",t:2,d:2},{n:"Saint Pierre and Miquelon",a:"PM",t:2,d:2},{n:"Saint Vincent and the Grenadines",a:"VC",t:2,d:2},{n:"Samoa",a:"WS",t:2,d:2},{n:"San Marino",a:"SM",t:2,d:2},{n:"Sao Tome and Principe",a:"ST",t:2,d:2},{n:"Saudi Arabia",a:"SA",t:2,d:2},{n:"Senegal",a:"SN",t:2,d:2},{n:"Serbia",a:"RS",t:2,d:0},{n:"Seychelles",a:"SC",t:2,d:2},{n:"Sierra Leone",a:"SL",t:2,d:2},{n:"Singapore",a:"SG",t:2,d:1},{n:"Sint Maarten (Dutch part)",a:"SX",t:2,d:2},{n:"Slovakia",a:"SK",t:1,d:0},{n:"Slovenia",a:"SI",t:1,d:0},{n:"Solomon Islands",a:"SB",t:2,d:2},{n:"Somalia",a:"SO",t:2,d:2},{n:"South Africa",a:"ZA",t:2,d:0},{n:"South Georgia and the South Sandwich Islands",a:"GS",t:2,d:2},{n:"South Sudan",a:"SS",t:2,d:2},{n:"Spain",a:"ES",t:1,d:0},{n:"Sri Lanka",a:"LK",t:2,d:1},{n:"Sudan",a:"SD",t:2,d:2},{n:"Suriname",a:"SR",t:2,d:2},{n:"Svalbard and Jan Mayen",a:"SJ",t:2,d:2},{n:"Swaziland",a:"SZ",t:2,d:2},{n:"Sweden",a:"SE",t:1,d:0},{n:"Switzerland",a:"CH",t:2,d:0},{n:"Syrian Arab Republic",a:"SY",t:2,d:2},{n:"Taiwan",a:"TW",t:2,d:1},{n:"Tajikistan",a:"TJ",t:2,d:2},{n:"Tanzania",a:"TZ",t:2,d:1},{n:"Thailand",a:"TH",t:2,d:1},{n:"Timor-Leste",a:"TL",t:2,d:0},{n:"Togo",a:"TG",t:2,d:2},{n:"Tokelau",a:"TK",t:2,d:2},{n:"Tonga",a:"TO",t:2,d:2},{n:"Trinidad and Tobago",a:"TT",t:2,d:2},{n:"Tunisia",a:"TN",t:2,d:0},{n:"Turkey",a:"TR",t:2,d:0},{n:"Turkmenistan",a:"TM",t:2,d:2},{n:"Turks and Caicos Islands",a:"TC",t:2,d:2},{n:"Tuvalu",a:"TV",t:2,d:2},{n:"Uganda",a:"UG",t:2,d:1},{n:"Ukraine",a:"UA",t:2,d:0},{n:"United Arab Emirates",a:"AE",t:2,d:2},{n:"United Kingdom",a:"GB",t:1,d:1},{n:"United States Minor Outlying Islands",a:"UM",t:2,d:2},{n:"United States of America",a:"US",t:2,d:1},{n:"Uruguay",a:"UY",t:2,d:0},{n:"Uzbekistan",a:"UZ",t:2,d:0},{n:"Vanuatu",a:"VU",t:2,d:2},{n:"Venezuela (Bolivarian Republic of)",a:"VE",t:2,d:0},{n:"Viet Nam",a:"VN",t:2,d:0},{n:"Virgin Islands (British)",a:"VG",t:2,d:2},{n:"Virgin Islands (U.S.)",a:"VI",t:2,d:2},{n:"Wallis and Futuna",a:"WF",t:2,d:2},{n:"Western Sahara",a:"EH",t:2,d:2},{n:"Yemen",a:"YE",t:2,d:2},{n:"Zambia",a:"ZM",t:2,d:2},{n:"Zimbabwe",a:"ZW",t:2,d:1}]),_export("Countries",Countries),Object.freeze(Countries)}}}),System.register("src/misc/FormatValidator.js",["../api/common/utils/StringUtils"],function(_export,_context){"use strict";var startsWith,DOMAIN_REGEXP,DOMAIN_OR_TLD_REGEXP,STRICT_USERNAME_MAIL_ADDR_REGEXP,EMAIL_ADDR_REGEXP;return _export("isMailAddress",function(string,strictUserName){return null!=string&&string===string.trim()&&0!==string.indexOf("-")&&-1===string.indexOf(",")&&-1===string.indexOf("(")&&-1===string.indexOf(")")&&-1===string.indexOf(":")&&-1===string.indexOf(";")&&-1===string.indexOf("<")&&-1===string.indexOf(">")&&-1===string.indexOf("[")&&-1===string.indexOf("]")&&-1===string.indexOf("\\")&&!(string.length>254)&&(strictUserName?!(string.indexOf("@")>64)&&STRICT_USERNAME_MAIL_ADDR_REGEXP.test(string):EMAIL_ADDR_REGEXP.test(string))}),_export("isDomainName",function(domainName){return null!=domainName&&domainName===domainName.trim()&&!startsWith(domainName,"-")&&DOMAIN_REGEXP.test(domainName)}),_export("isDomainOrTopLevelDomain",function(value){return!startsWith(value,"-")&&DOMAIN_OR_TLD_REGEXP.test(value)}),_export("isRegularExpression",function(value){return/^\/.*\/$/.test(value)}),{setters:[function(_apiCommonUtilsStringUtils){startsWith=_apiCommonUtilsStringUtils.startsWith}],execute:function(){"[\\w\\-\\+_]+",DOMAIN_REGEXP=new RegExp("^[\\w\\-\\+_]+\\.[\\w\\-\\+_]+(\\.[\\w\\-\\+_]+)*\\s*$"),DOMAIN_OR_TLD_REGEXP=new RegExp("^([\\w\\-\\+_]+.)*[\\w\\-\\+_]+$"),STRICT_USERNAME_MAIL_ADDR_REGEXP=new RegExp("^\\s*[\\w\\-\\+_]+(\\.[\\w\\-\\+_]+)*\\@[\\w\\-\\+_]+\\.[\\w\\-\\+_]+(\\.[\\w\\-\\+_]+)*\\s*$"),EMAIL_ADDR_REGEXP=new RegExp("^[^\\s\\@]+\\@[\\w\\-\\+_]+\\.[\\w\\-\\+_]+(\\.[\\w\\-\\+_]+)*\\s*$")}}}),System.register("src/misc/Formatter.js",["./LanguageViewModel","../api/Env","../api/common/CountryList","../api/common/utils/Utils","../api/entities/tutanota/Birthday","./FormatValidator"],function(_export,_context){"use strict";var lang,assertMainOrNode,getByAbbreviation,neverNull,createBirthday,isMailAddress,referenceDate;function formatDate(date){return lang.formats.simpleDate.format(date)}function formatDateWithWeekday(date){return date.getFullYear()===(new Date).getFullYear()?lang.formats.dateWithWeekday.format(date):lang.formats.dateWithWeekdayAndYear.format(date)}function formatTime(date){return lang.formats.time.format(date)}function formatDateTimeShort(date){return lang.formats.dateTimeShort.format(date)}function formatSortableDate(date){var month=("0"+(date.getMonth()+1)).slice(-2),day=("0"+date.getDate()).slice(-2);return date.getFullYear()+"-"+month+"-"+day}function _cleanupAndSplit(dateString){return"bg-bg"===lang.languageTag.toLowerCase()&&(dateString=dateString.replace(" г.","")),(dateString=(dateString=dateString.replace(/ /g,"")).replace(/‎/g,"")).split(/[.\/-]/g).filter(function(part){return part.trim().length>0}).map(function(part){return parseInt(part)})}function getCleanedMailAddress(mailAddress){var cleanedMailAddress=mailAddress.toLowerCase().trim();return isMailAddress(cleanedMailAddress,!1)?cleanedMailAddress:null}return _export("formatMonthWithYear",function(date){return lang.formats.monthWithYear.format(date)}),_export("formatMonthWithFullYear",function(date){return lang.formats.monthWithFullYear.format(date)}),_export("formatDate",formatDate),_export("formatDateWithMonth",function(date){return lang.formats.dateWithMonth.format(date)}),_export("formatDateWithWeekday",formatDateWithWeekday),_export("formatDateTimeFromYesterdayOn",function(date){var startOfToday=(new Date).setHours(0,0,0,0),startOfYesterday=startOfToday-864e5;return((date.getTime()>=startOfToday?"":startOfToday>date.getTime()&&date.getTime()>=startOfYesterday?lang.get("yesterday_label"):formatDateWithWeekday(date))+" "+formatTime(date)).trim()}),_export("formatTime",formatTime),_export("formatDateTime",function(date){return lang.formats.dateTime.format(date)}),_export("formatDateTimeShort",formatDateTimeShort),_export("formatDateWithWeekdayAndTime",function(date){return lang.formats.dateWithWeekdayAndTime.format(date)}),_export("formatDateWithTimeIfNotEven",function(date){return 0===date.getHours()&&0===date.getMinutes()||23===date.getHours()&&59===date.getMinutes()&&59===date.getSeconds()?formatDate(date):formatDateTimeShort(date)}),_export("formatWeekdayShort",function(date){return lang.formats.weekdayShort.format(date)}),_export("formatWeekdayNarrow",function(date){return lang.formats.weekdayNarrow.format(date)}),_export("dateWithWeekdayWoMonth",function(date){return lang.formats.dateWithWeekdayWoMonth.format(date)}),_export("formatSortableDate",formatSortableDate),_export("formatSortableDateTime",function(date){var hours=("0"+date.getHours()).slice(-2),minutes=("0"+date.getMinutes()).slice(-2),seconds=("0"+date.getSeconds()).slice(-2);return formatSortableDate(date)+" "+hours+"h"+minutes+"m"+seconds+"s"}),_export("parseDate",function(dateString){var languageTag=lang.languageTag.toLowerCase(),referenceParts=_cleanupAndSplit(formatDate(referenceDate)),dayPos=referenceParts.findIndex(function(e){return 23===e}),monthPos=referenceParts.findIndex(function(e){return 6===e}),yearPos=referenceParts.findIndex(function(e){return 2017===e}),parts=_cleanupAndSplit(dateString);if(3!==parts.length)throw new Error("could not parse dateString '"+dateString+"' for locale "+languageTag);var day=parts[dayPos],month=parts[monthPos]-1,year=parts[yearPos],parsed=new Date(year,month,day).getTime();if(isNaN(parsed))throw new Error("could not parse date '"+dateString+"' for locale "+languageTag);return parsed}),_export("parseBirthday",function(text){try{var referenceParts=_cleanupAndSplit(formatDate(new Date(2017,5,23))),dayPos=referenceParts.findIndex(function(e){return 23===e}),monthPos=referenceParts.findIndex(function(e){return 6===e}),yearPos=referenceParts.findIndex(function(e){return 2017===e}),birthdayValues=_cleanupAndSplit(text),birthday=createBirthday();if(!(String(birthdayValues[dayPos]).length<3&&String(birthdayValues[monthPos]).length<3))return null;if(!(birthdayValues[dayPos]<32))return null;if(birthday.day=String(birthdayValues[dayPos]),!(birthdayValues[monthPos]<13))return null;if(birthday.month=String(birthdayValues[monthPos]),birthdayValues[yearPos])if(4===String(birthdayValues[yearPos]).length)birthday.year=String(birthdayValues[yearPos]);else{if(2!==String(birthdayValues[yearPos]).length)return null;birthdayValues[yearPos]>Number(String((new Date).getFullYear()).substring(2))?birthday.year="19"+String(birthdayValues[yearPos]):birthday.year="20"+String(birthdayValues[yearPos])}else birthday.year=null;return birthday}catch(e){return null}}),_export("_cleanupAndSplit",_cleanupAndSplit),_export("stringToNameAndMailAddress",function(string){if(""===(string=string.trim()))return null;var startIndex=string.indexOf("<");if(-1!==startIndex){var endIndex=string.indexOf(">",startIndex);if(-1===endIndex)return null;var cleanedMailAddress=getCleanedMailAddress(string.substring(startIndex+1,endIndex));return null!=cleanedMailAddress&&isMailAddress(cleanedMailAddress,!1)?{name:string.substring(0,startIndex).trim(),mailAddress:cleanedMailAddress}:null}startIndex=string.lastIndexOf(" "),startIndex++;var _cleanedMailAddress=getCleanedMailAddress(string.substring(startIndex));return null!=_cleanedMailAddress&&isMailAddress(_cleanedMailAddress,!1)?{name:string.substring(0,startIndex).trim(),mailAddress:_cleanedMailAddress}:null}),_export("getCleanedMailAddress",getCleanedMailAddress),_export("fullNameToFirstAndLastName",function(fullName){if(""===(fullName=fullName.trim()))return{firstName:"",lastName:""};var separator=fullName.indexOf(" ");return-1!==separator?{firstName:fullName.substring(0,separator),lastName:fullName.substring(separator+1)}:{firstName:fullName,lastName:""}}),_export("mailAddressToFirstAndLastName",function(mailAddress){var addr=mailAddress.substring(0,mailAddress.indexOf("@")),nameData=[];nameData=-1!==addr.indexOf(".")?addr.split("."):-1!==addr.indexOf("_")?addr.split("_"):-1!==addr.indexOf("-")?addr.split("-"):[addr];for(var i=0;i<nameData.length;i++)nameData[i].length>0&&(nameData[i]=nameData[i].substring(0,1).toUpperCase()+nameData[i].substring(1));return{firstName:nameData[0],lastName:nameData.slice(1).join(" ")}}),_export("formatStorageSize",function(sizeInBytes){for(var unitIndex=0;sizeInBytes>=1e3;)sizeInBytes/=1e3,unitIndex++;return(sizeInBytes=Math.floor(10*sizeInBytes)/10)+" "+["B","KB","MB","GB","TB"][unitIndex]}),_export("urlEncodeHtmlTags",function(text){return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}),_export("formatNameAndAddress",function(name,address,countryCode){var result="";return name&&(result+=name),address&&(result&&(result+="\n"),result+=address),countryCode&&(result&&(result+="\n"),result+=neverNull(getByAbbreviation(countryCode)).n),result}),{setters:[function(_LanguageViewModel){lang=_LanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiCommonCountryList){getByAbbreviation=_apiCommonCountryList.getByAbbreviation},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEntitiesTutanotaBirthday){createBirthday=_apiEntitiesTutanotaBirthday.createBirthday},function(_FormatValidator){isMailAddress=_FormatValidator.isMailAddress}],execute:function(){assertMainOrNode(),referenceDate=new Date(2017,5,23)}}}),System.register("src/gui/base/TextFieldN.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","../size","./../animation/Animations","../animation/Easing","../theme","../../misc/LanguageViewModel","./ButtonN","./Dialog","../../misc/Formatter","./icons/Icons","../../api/common/utils/StringUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,px,size,animations,fontSize,transform,ease,theme,lang,ButtonN,Dialog,formatDate,parseDate,Icons,repeat,Type,inputLineHeight,inputMarginTop,baseLabelPosition,_TextField,TextFieldN;return _export("editableTextField",function(label,value,updateHandler){var area=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return m(TextFieldN,{label:function(_label){function label(){return _label.apply(this,arguments)}return label.toString=function(){return _label.toString()},label}(function(){return label}),value:stream(value||""),type:area?Type.Area:Type.Text,disabled:!0,injectionsRight:function(){return m(ButtonN,{label:function(){return"update"},icon:function(){return Icons.Edit},click:function(){return(area?Dialog.showTextAreaInputDialog:Dialog.showTextInputDialog)("edit_action",function(){return label},null,value||"").then(function(value){return updateHandler(value).catch(function(e){Dialog.error(function(){return'Could not update "'+label+'" with value '+value}),console.log(e)})})}})}})}),_export("editableDateField",function(label,value,updateHandler){return m(TextFieldN,{label:function(_label2){function label(){return _label2.apply(this,arguments)}return label.toString=function(){return _label2.toString()},label}(function(){return label}),value:stream(value?formatDate(value):""),disabled:!0,injectionsRight:function(){return m(ButtonN,{label:function(){return"update"},icon:function(){return Icons.Edit},click:function(){var invalidDate=!1,dateValue=stream(value?formatDate(value):"");dateValue.map(function(newDate){try{if(newDate.trim().length>0){var timestamp=parseDate(newDate);!isNaN(timestamp)&&new Date(timestamp)}invalidDate=!1}catch(e){invalidDate=!0}});var helpText=function(){return invalidDate?lang.get("invalidDateFormat_msg",{"{1}":formatDate(new Date)}):""},dialog=Dialog.showActionDialog({title:lang.get("edit_action"),child:{view:function(){return m(TextFieldN,{label:function(_label3){function label(){return _label3.apply(this,arguments)}return label.toString=function(){return _label3.toString()},label}(function(){return label}),value:dateValue,helpLabel:helpText})}},okAction:function(){try{var date=null;""!==dateValue().trim()&&(date=new Date(parseDate(dateValue()))),updateHandler(date).then(function(){return dialog.close()}).catch(function(e){Dialog.error(function(){return'Could not update "'+label+'" with value '+dateValue()}),console.log(e)})}catch(e){Dialog.error(function(){return helpText()})}}})}})}})}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_size){px=_size.px,size=_size.size},function(_animationAnimations){animations=_animationAnimations.animations,fontSize=_animationAnimations.fontSize,transform=_animationAnimations.transform},function(_animationEasing){ease=_animationEasing.ease},function(_theme){theme=_theme.theme},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_ButtonN){ButtonN=_ButtonN.ButtonN},function(_Dialog){Dialog=_Dialog.Dialog},function(_miscFormatter){formatDate=_miscFormatter.formatDate,parseDate=_miscFormatter.parseDate},function(_iconsIcons){Icons=_iconsIcons.Icons},function(_apiCommonUtilsStringUtils){repeat=_apiCommonUtilsStringUtils.repeat}],execute:function(){_export("Type",Type=Object.freeze({Text:"text",Email:"email",Password:"password",Area:"area",ExternalPassword:"externalpassword",Number:"number",Time:"time"})),_export("Type",Type),_export("inputLineHeight",inputLineHeight=size.font_size_base+8),_export("inputLineHeight",inputLineHeight),inputMarginTop=size.font_size_small+size.hpad_small+3,_export("baseLabelPosition",baseLabelPosition=size.text_field_label_top),_export("baseLabelPosition",baseLabelPosition),_export("_TextField",_TextField=function(){function _TextField(vnode){var _this=this;_classCallCheck(this,_TextField),this.active=!1,this.webkitAutofill=!1,"function"==typeof vnode.attrs.value.map&&vnode.attrs.value.map(function(value){_this._domInput&&(value&&!_this.active&&_this.animate(!0),value!==_this._domInput.value&&(_this._domInput.value=value))})}return _createClass(_TextField,[{key:"view",value:function(vnode){var _this2=this,a=vnode.attrs;return m(".text-field.rel.overflow-hidden.text",{id:vnode.attrs.id,oncreate:function(vnode){return _this2._domWrapper=vnode.dom},onclick:function(e){return _this2.focus(e,a)},class:null!=a.class?a.class:"pt"},[m("label.abs.text-ellipsis.noselect.backface_fix.z1.i.pr-s",{class:this.active?"content-accent-fg":"",oncreate:function(vnode){_this2._domLabel=vnode.dom,_this2.isEmpty(a.value())&&!a.disabled?(_this2._domLabel.style.fontSize=px(size.font_size_base),_this2._domLabel.style.transform="translateY("+baseLabelPosition+"px)"):(_this2._domLabel.style.fontSize=px(size.font_size_small),_this2._domLabel.style.transform="translateY(0px)")}},lang.getMaybeLazy(a.label)),m(".flex.flex-column",[m(".flex.items-end.flex-wrap",{style:{"min-height":px(size.button_height+2),"padding-bottom":this.active?px(0):px(1),"border-bottom":this.active?"2px solid "+theme.content_accent:"1px solid "+theme.content_border}},[a.injectionsLeft?a.injectionsLeft():null,m(".inputWrapper.flex-space-between.items-end",{},[a.type!==Type.Area?this._getInputField(a):this._getTextArea(a),a.injectionsRight?m(".mr-negative-s.flex-end",a.injectionsRight()):null])])]),a.helpLabel?m("small.noselect.click",{onclick:function(){_this2._domInput&&_this2._domInput.focus()}},a.helpLabel()):[]])}},{key:"_getInputField",value:function(a){var _this3=this;if(a.disabled)return m(".text-break.selectable",{style:{marginTop:px(inputMarginTop),lineHeight:px(inputLineHeight)}},a.value());var autofillGuard=a.preventAutofill?[m("input.abs",{style:{opacity:"0",height:"0"},type:Type.Text}),m("input.abs",{style:{opacity:"0",height:"0"},type:Type.Password}),m("input.abs",{style:{opacity:"0",height:"0"},type:Type.Text})]:[];return m(".flex-grow.rel",autofillGuard.concat([m("input.input"+(a.alignRight?".right":""),{autocomplete:a.preventAutofill?"off":"",type:a.type===Type.ExternalPassword?Type.Text:a.type,"aria-label":lang.getMaybeLazy(a.label),oncreate:function(vnode){_this3._domInput=vnode.dom,_this3._domInput.style.opacity=_this3._shouldShowPasswordOverlay(a)?"0":"1",_this3._domInput.value=a.value(),a.type===Type.ExternalPassword?vnode.dom.style.opacity="0":a.type===Type.Password&&vnode.dom.addEventListener("animationstart",function(e){"onAutoFillStart"===e.animationName?(_this3.animate(!0),_this3.webkitAutofill=!0):"onAutoFillCancel"===e.animationName&&(_this3.webkitAutofill=!1)})},onfocus:function(e){_this3.focus(e,a),a.onfocus&&a.onfocus(_this3._domWrapper,_this3._domInput)},onblur:function(e){return _this3.blur(e,a)},onkeydown:function(e){var key={keyCode:e.which,ctrl:e.ctrlKey,shift:e.shiftKey};return null==a.keyHandler||a.keyHandler(key)},onremove:function(e){_this3._domInput.onblur=null},onupdate:function(){_this3._domInput.style.opacity=_this3._shouldShowPasswordOverlay(a)?"0":"1",_this3._domInput.value=a.value()},oninput:function(){!_this3.isEmpty(a.value())||""===_this3._domInput.value||_this3.active||_this3.webkitAutofill||_this3.animate(!0),a.value(_this3._domInput.value),a.oninput&&a.oninput(_this3._domInput.value,_this3._domInput)},style:{minWidth:px(20),lineHeight:px(inputLineHeight)}}),this._shouldShowPasswordOverlay(a)?m(".abs",{style:{bottom:0,left:0,lineHeight:size.line_height}},repeat("•",a.value().length)):null]))}},{key:"_shouldShowPasswordOverlay",value:function(a){return a.type===Type.ExternalPassword&&!this.active}},{key:"_getTextArea",value:function(a){var _this4=this;return a.disabled?m(".text-prewrap.text-break.selectable",{style:{marginTop:px(inputMarginTop),lineHeight:px(inputLineHeight)}},a.value()):m("textarea.input-area.text-pre",{"aria-label":lang.getMaybeLazy(a.label),oncreate:function(vnode){_this4._domInput=vnode.dom,_this4._domInput.value=a.value(),_this4._domInput.style.height=px(Math.max(a.value().split("\n").length,1)*inputLineHeight)},onfocus:function(e){return _this4.focus(e,a)},onblur:function(e){return _this4.blur(e,a)},onkeydown:function(e){var key={keyCode:e.which,ctrl:e.ctrlKey,shift:e.shiftKey};return null==a.keyHandler||a.keyHandler(key)},oninput:function(e){_this4.isEmpty(a.value())&&""!==_this4._domInput.value&&!_this4.active&&_this4.animate(!0),_this4._domInput.style.height="0px",_this4._domInput.style.height=px(_this4._domInput.scrollHeight),a.value(_this4._domInput.value)},style:{marginTop:px(inputMarginTop),lineHeight:px(inputLineHeight),minWidth:px(20)}})}},{key:"focus",value:function(e,a){this.active||a.disabled||(this.active=!0,this._domInput.focus(),this._domWrapper.classList.add("active"),this.isEmpty(a.value())&&this.animate(!0))}},{key:"blur",value:function(e,a){this._domWrapper.classList.remove("active"),this.isEmpty(a.value())&&this.animate(!1),this.active=!1,a.onblur instanceof Function&&a.onblur(e)}},{key:"isEmpty",value:function(value){return""===value}},{key:"animate",value:function(fadeIn){var fontSizes=[size.font_size_base,size.font_size_small],top=[baseLabelPosition,0];return fadeIn||(fontSizes.reverse(),top.reverse()),animations.add(this._domLabel,[fontSize(fontSizes[0],fontSizes[1]),transform(transform.type.translateY,top[0],top[1])],{easing:ease.out})}}]),_TextField}()),_export("_TextField",_TextField),_export("TextFieldN",TextFieldN=_TextField),_export("TextFieldN",TextFieldN)}}}),System.register("src/gui/base/DropdownN.js",["node_modules/systemjs-plugin-babel/babel-helpers/slicedToArray.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","./Modal","./../animation/Animations","../animation/Easing","../size","../../misc/KeyManager","../../misc/ClientDetector","./ButtonN","./NavButtonN","../../api/Env","../../misc/LanguageViewModel","mithril/stream/stream.js","../../api/common/utils/Utils","../../api/common/TutanotaConstants"],function(_export,_context){"use strict";var _slicedToArray,_classCallCheck,_createClass,m,modal,animations,height,width,ease,px,size,focusNext,focusPrevious,client,ButtonN,isVisible,NavButtonN,assertMainOrNodeBoot,lang,stream,asyncImport,Keys,DropdownN;function createAsyncDropdown(lazyButtons){var width=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;return function(e,dom){var originalButtons=lazyButtons(),buttons=originalButtons;originalButtons.isPending()&&(buttons=Promise.race([originalButtons,Promise.all([Promise.delay(100),asyncImport("undefined"!=typeof module?module.id:_context.id,env.rootPathPrefix+"src/gui/base/ProgressDialog.js")]).then(function(_ref){var _ref2=_slicedToArray(_ref,2),module=(_ref2[0],_ref2[1]);return originalButtons.isPending()?module.showProgressDialog("loading_msg",originalButtons):originalButtons})])),buttons.then(function(buttons){var dropdown=new DropdownN(function(){return buttons},width);dropdown.setOrigin(dom.getBoundingClientRect()),modal.displayUnique(dropdown)})}}return _export("createDropdown",function(lazyButtons){return createAsyncDropdown(function(){return Promise.resolve(lazyButtons())},arguments.length>1&&void 0!==arguments[1]?arguments[1]:200)}),_export("createAsyncDropdown",createAsyncDropdown),_export("attachDropdown",function(mainButtonAttrs,childAttrs){var showDropdown=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){return!0},width=arguments[3],oldClick=mainButtonAttrs.click;return Object.assign({},mainButtonAttrs,{click:function(e,dom){showDropdown()?(createAsyncDropdown(function(){return Promise.resolve(childAttrs())},width)(e,dom),e.stopPropagation()):oldClick&&oldClick(e)}})}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs){_slicedToArray=_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_Modal){modal=_Modal.modal},function(_animationAnimations){animations=_animationAnimations.animations,height=_animationAnimations.height,width=_animationAnimations.width},function(_animationEasing){ease=_animationEasing.ease},function(_size){px=_size.px,size=_size.size},function(_miscKeyManager){focusNext=_miscKeyManager.focusNext,focusPrevious=_miscKeyManager.focusPrevious},function(_miscClientDetector){client=_miscClientDetector.client},function(_ButtonN){ButtonN=_ButtonN.ButtonN,isVisible=_ButtonN.isVisible},function(_NavButtonN){NavButtonN=_NavButtonN.NavButtonN},function(_apiEnv){assertMainOrNodeBoot=_apiEnv.assertMainOrNodeBoot},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiCommonUtilsUtils){asyncImport=_apiCommonUtilsUtils.asyncImport},function(_apiCommonTutanotaConstants){Keys=_apiCommonTutanotaConstants.Keys}],execute:function(){assertMainOrNodeBoot(),_export("DropdownN",DropdownN=function(){function DropdownN(lazyChildren,width){var _this=this;_classCallCheck(this,DropdownN),this.chooseMatch=function(){var filterString=_this._filterString().toLowerCase(),visibleElements=_this._visibleChildren().filter(function(b){return"string"!=typeof b}),matchingButton=1===visibleElements.length?visibleElements[0]:visibleElements.find(function(b){return lang.getMaybeLazy(b.label).toLowerCase()===filterString});return document.activeElement!==_this._domInput||!matchingButton||!matchingButton.click||(matchingButton.click(),!1)},this.children=[],this.maxHeight=0,this._width=width,this._buttonsHeight=0,this._filterString=stream(""),this.oninit=function(){_this.children=lazyChildren(),_this._isFilterable=_this.children.length>10,_this.children.map(function(child){if("string"==typeof child)return child;((child=child).click=_this.wrapClick(child.click?child.click:function(){return null}),child.isVisible=_this._isFilterable?_this.wrapVisible(child.isVisible,lang.getMaybeLazy(child.label)):child.isVisible,void 0!==child.noBubble)&&(child.noBubble=!1);return child})};var _shortcuts=this._createShortcuts();this.shortcuts=function(){return _shortcuts};this.view=function(){return m(".dropdown-panel.elevated-bg.border-radius.backface_fix",{oncreate:function(vnode){return _this._domDropdown=vnode.dom},onkeypress:function(e){_this._domInput&&_this._domInput.focus()}},[_this._isFilterable?m("input.dropdown-bar.elevated-bg.doNotClose.pl-l.button-height.abs",{placeholder:lang.get("typeToFilter_label"),oncreate:function(vnode){_this._domInput=vnode.dom,_this._domInput.value=_this._filterString()},oninput:function(e){_this._filterString(_this._domInput.value)},style:{paddingLeft:px(2*size.hpad_large),paddingRight:px(size.hpad_small),width:px(_this._width-size.hpad_large),top:0,height:px(size.button_height),left:0}},_this._filterString()):null,m(".dropdown-content.plr-l.scroll.abs",{oncreate:function(vnode){_this.setContentHeight(vnode.dom),_this.show(vnode.dom),window.requestAnimationFrame(function(){document.activeElement&&"function"==typeof document.activeElement.blur&&document.activeElement.blur()})},onscroll:function(ev){ev.target.scrollTop<0?ev.redraw=!0:ev.target.scrollTop+_this._domContents.offsetHeight>ev.target.scrollHeight?ev.redraw=!0:ev.redraw=!1},style:{width:px(_this._width),top:px(_this._getFilterHeight()),bottom:0}},_this._visibleChildren().map(function(child){return"string"==typeof child?m(".flex-v-center.center.button-height.b.text-break.doNotClose.selectable",child):void 0===child.href?m(ButtonN,child):m(NavButtonN,child)}))])}}return _createClass(DropdownN,[{key:"wrapClick",value:function(fn){var _this2=this;return function(e,dom){var r=fn(e,dom);return _this2.close(),r}}},{key:"wrapVisible",value:function(fn,label){var _this3=this;return function(){return(!(fn instanceof Function)||fn())&&label.toLowerCase().includes(_this3._filterString().toLowerCase())}}},{key:"backgroundClick",value:function(e){!this._domDropdown||e.target.classList.contains("doNotClose")||!this._domDropdown.contains(e.target)&&this._domDropdown.parentNode!==e.target||modal.remove(this)}},{key:"_createShortcuts",value:function(){var _this4=this;return[{key:Keys.ESC,exec:function(){return _this4.close()},help:"close_alt"},{key:Keys.TAB,shift:!0,exec:function(){return focusPrevious(_this4._domDropdown)},help:"selectPrevious_action"},{key:Keys.TAB,shift:!1,exec:function(){return focusNext(_this4._domDropdown)},help:"selectNext_action"},{key:Keys.UP,exec:function(){return focusPrevious(_this4._domDropdown)},help:"selectPrevious_action"},{key:Keys.DOWN,exec:function(){return focusNext(_this4._domDropdown)},help:"selectNext_action"},{key:Keys.RETURN,exec:function(){return _this4.chooseMatch()},help:"ok_action"}]}},{key:"setOrigin",value:function(origin){this.origin=origin}},{key:"close",value:function(){modal.remove(this)}},{key:"onClose",value:function(){this.close()}},{key:"popState",value:function(e){return this.close(),!0}},{key:"show",value:function(domElement){var _this5=this;if(this._domContents=domElement,this.origin){var left=this.origin.left,right=window.innerWidth-this.origin.right;left<right?(this._domDropdown.style.left=left+"px",this._domDropdown.style.right=""):(this._domDropdown.style.left="",this._domDropdown.style.right=right+"px");var top=this.origin.bottom,bottom=window.innerHeight-(this.origin.bottom-this.origin.height);return top<bottom?(this._domDropdown.style.top=top+"px",this._domDropdown.style.bottom=""):(this._domDropdown.style.top="",this._domDropdown.style.bottom=bottom+"px"),this._buttonsHeight=this._visibleChildren().reduce(function(sum,current){return sum+size.button_height},0)+2*size.vpad_small,this.maxHeight=Math.min(this._buttonsHeight+this._getFilterHeight(),Math.max(window.innerHeight-top,window.innerHeight-bottom)-10),animations.add(this._domDropdown,[width(0,this._width),height(0,this.maxHeight)],{easing:ease.out}).then(function(){if(_this5.maxHeight-_this5._getFilterHeight()<_this5._buttonsHeight&&(_this5._domContents.style.maxHeight=px(_this5.maxHeight-_this5._getFilterHeight()),_this5._domContents.style.overflowY=client.overflowAuto),_this5._domInput&&!client.isMobileDevice())_this5._domInput.focus();else{var button=_this5._domDropdown.querySelector("button");button&&button.focus()}})}}},{key:"setContentHeight",value:function(domElement){this._buttonsHeight>0&&(domElement.style.height=this._buttonsHeight+"px")}},{key:"hideAnimation",value:function(){return this._domContents&&this._domDropdown?(this._domDropdown.style.overflowY="hidden",animations.add(this._domDropdown,[width(this._width,0),height(this.maxHeight,0)],{easing:ease.out})):Promise.resolve()}},{key:"_visibleChildren",value:function(){var _this6=this;return this.children.filter(function(b){return"string"==typeof b?b.includes(_this6._filterString().toLowerCase()):isVisible(b)})}},{key:"_getFilterHeight",value:function(){return this._isFilterable?size.button_height+size.vpad_xs:0}}]),DropdownN}()),_export("DropdownN",DropdownN)}}}),System.register("src/gui/base/icons/Icons.js",["../../../api/Env"],function(_export,_context){"use strict";var assertMainOrNode,Icons,IconsSvg;return{setters:[function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode}],execute:function(){assertMainOrNode(),_export("Icons",Icons=Object.freeze({Add:"Add",AlignLeft:"AlignLeft",AlignRight:"AlignRight",AlignCenter:"AlignCenter",AlignJustified:"AlignJustified",Archive:"Archive",ArrowBackward:"ArrowBackward",ArrowForward:"ArrowForward",Attachment:"Attachment",Bold:"Bold",Call:"Call",Cancel:"Cancel",Checkmark:"Checkmark",Code:"Code",ContactImport:"ContactImport",Desktop:"Desktop",Download:"Download",Edit:"Edit",Folder:"Folder",Forward:"Forward",Inbox:"Inbox",Italic:"Italic",Link:"Link",ListUnordered:"ListUnordered",ListOrdered:"ListOrdered",Login:"Login",Lock:"Lock",MatchCase:"MatchCase",Mobile:"Mobile",More:"More",NewWindow:"NewWindow",Pin:"Pin",Reply:"Reply",ReplyAll:"ReplyAll",Send:"Send",Spam:"Spam",Trash:"Trash",TrashEmpty:"TrashEmpty",Underline:"Underline",Unlock:"Unlock",Warning:"Warning",WarningOutline:"WarningOutline",Wand:"Wand",NoEye:"NoEye",Eye:"Eye",People:"People",Print:"Print",Chat:"Chat",Copy:"Copy",Close:"Close",Cash:"Cash",Picture:"Picture",FontSize:"FontSize",Table:"Table",ListAlt:"ListAlt",Notifications:"Notifications",ArrowDropLeft:"ArrowDropLeft",ArrowDropRight:"ArrowDropRight",Power:"Power",Palette:"Palette",Import:"Import",Export:"Export",PencilSquare:"PencilSquare"})),_export("Icons",Icons),_export("IconsSvg",IconsSvg={Add:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M416 277.333H277.333V416h-42.666V277.333H96v-42.666h138.667V96h42.666v138.667H416v42.666z"/></svg>',AlignLeft:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M472.804 51.445H44.096v68.593h428.708zM409.092 160.086H44.096v68.593h364.996zM448.697 275.024H44.096v68.593h404.6zM212.79 387.062H44.096v68.593H212.79z"/></svg>',AlignRight:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M44.096 51.445h428.708v68.593H44.096zM107.808 160.086h364.996v68.593H107.808zM68.203 275.024h404.6v68.593h-404.6zM304.11 387.062h168.694v68.593H304.109z"/></svg>',AlignCenter:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="512" width="512"><path d="M112.689 51.445h291.522v68.593H112.689zM44.096 160.086h428.708v68.593H44.096zM159.234 275.024h198.431v68.593h-198.43zM75.943 387.062h365.014v68.593H75.943z"/></svg>',AlignJustified:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="512" width="512"><path d="M44.096 51.445h428.708v68.593H44.096zM44.096 160.086h428.708v68.593H44.096zM44.096 275.024h428.708v68.593H44.096zM44.096 387.062h428.708v68.593H44.096z"/></svg>',Archive:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M112 400h288V208H112v192zm112-160h64c8.8 0 16 7.2 16 16s-7.2 16-16 16h-64c-8.8 0-16-7.2-16-16s7.2-16 16-16zM96 112v80h320v-80z"/></svg>',ArrowBackward:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M352 128.4L319.7 96 160 256l159.7 160 32.3-32.4L224.7 256z"/></svg>',ArrowForward:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M287.3 256L160 383.6l32.3 32.4L352 256 192.3 96 160 128.4z"/></svg>',Attachment:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M341.334 128v234.666C341.334 409.604 302.938 448 256 448c-46.937 0-85.333-38.396-85.333-85.334V117.334C170.667 87.47 194.135 64 224 64c29.864 0 53.333 23.47 53.333 53.334v245.333c0 11.73-9.605 21.333-21.334 21.333-11.73 0-21.334-9.604-21.334-21.333V160h-32v202.667C202.666 392.53 226.136 416 256 416c29.865 0 53.334-23.47 53.334-53.333V117.334C309.334 70.4 270.938 32 224 32s-85.334 38.4-85.334 85.334v245.332C138.666 427.73 190.938 480 256 480c65.062 0 117.334-52.27 117.334-117.334V128h-32z"/></svg>',Bold:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M327.723 135.167q0-40.837-17.8-58.987-17.452-18.15-57.94-18.15h-48.516v162.998h51.308q37.347 0 55.147-19.545 17.8-19.546 17.8-66.316zm35.252 216.05q0-46.42-23.385-69.108-23.036-22.687-75.74-22.687h-60.383v189.873q50.261 2.094 79.23 2.094 40.837 0 60.383-24.78 19.895-24.782 19.895-75.392zM33.14 487.69v-25.48l60.383-9.424V54.191L33.14 45.116V19.637h227.22q93.191 0 137.518 25.13 44.327 24.782 44.327 80.627 0 41.884-26.177 72.25-26.178 30.365-70.156 39.789 65.27 6.632 98.776 35.601 33.507 28.62 33.507 78.183 0 68.061-50.26 103.314-50.26 35.252-144.15 35.252l-159.159-2.094z" aria-label="B" font-weight="400" font-size="148.92" font-family="sans-serif" letter-spacing="0" word-spacing="0" stroke-width="3.723"/></svg>',Call:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M426.666 330.667c-26.666 0-52.27-4.27-75.73-11.73-7.468-2.135-16-1.072-21.33 5.334l-46.94 46.93c-60.802-30.93-109.864-80-140.802-140.804l46.94-46.927c5.33-5.334 7.46-13.865 5.33-21.334-8.536-24.53-12.8-50.136-12.8-76.803 0-11.73-9.6-21.333-21.334-21.333H85.333C73.6 64 64 73.604 64 85.333 64 285.863 226.136 448 426.666 448c11.73 0 21.334-9.604 21.334-21.333V352c0-11.73-9.604-21.333-21.334-21.333z"/></svg>',Cancel:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M405 136.798L375.202 107 256 226.202 136.798 107 107 136.798 226.202 256 107 375.202 136.798 405 256 285.798 375.202 405 405 375.202 285.798 256z"/></svg>',Checkmark:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M186.3 339.893L96 249.46l-32 30.51L186.3 402 448 140.506 416 110z"/></svg>',Code:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M190.4 354.1L91.9 256l98.4-98.1-30-29.9L32 256l128.4 128 30-29.9zm131.2 0L420 256l-98.4-98.1 30-29.9L480 256 351.6 384l-30-29.9z"/></svg>',ContactImport:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M304 256c52.805 0 96-43.2 96-96s-43.195-96-96-96-96 43.2-96 96 43.195 96 96 96zm0 48c-63.598 0-192 32.402-192 96v48h384v-48c0-63.598-128.402-96-192-96zm-192-80v-64H80v64H16v32h64v64h32v-64h64v-32h-64z"/></svg>',Desktop:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M496 384V96H16v288h175v16h-64v16h257v-16h-64v-16h176zM32 112h448v256H32V112z"/><path d="M48 128h416v224H48z"/></svg>',Download:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M416 199.5h-91.4V64H187.4v135.5H96l160 158.1 160-158.1zM96 402.8V448h320v-45.2H96z"/></svg>',Edit:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M64 368v80h80l235.727-235.73-80-79.997L64 368zm377.602-217.602c8.53-8.53 8.53-21.334 0-29.865l-50.135-50.135c-8.53-8.53-21.334-8.53-29.865 0l-39.468 39.47 80 79.997 39.468-39.467z"/></svg>',Folder:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M448 119c0-13.3-9.4-23-22.8-23H230.9c-2.8 0-4.3-.6-6.1-2.4l-22.5-22.5-.2-.2c-4.9-4.6-8.9-6.9-17.3-6.9H88.7C74.9 64 64 74.3 64 87v57h384v-25zM64 160h-8.3c-12.8 0-25.3 5.1-23.5 24.3S55.7 423 55.7 423c2.7 17.8 11.7 25 25 25h352.5c12.7 0 21-7.8 23-25 0 0 22.2-212.9 23.6-233.5 1.4-20.5-8.9-29.5-23.6-29.5H64z"/></svg>',Forward:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M64 400h10.3l19.2-31.2c20.5-32.7 44.9-62.8 75.8-76.6 24.4-10.9 46.7-18.9 86.7-20V352l192-128L256 96v80.3c-63 2.8-108.1 20.7-143.3 56.2C60.4 285.2 64 351.5 64 368.2c.1 8.9 0 21.7 0 31.8z"/></svg>',Inbox:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 288c-29.8 0-54.9-20.4-62-48H80v144h352V240H318c-7.1 27.6-32.2 48-62 48z"/><path d="M368.5 128h-.5v80h-16v-80H160v80h-16v-80h-.5L80 224h128c0 26.5 21.5 48 48 48s48-21.5 48-48h128l-63.5-96z"/></svg>',Italic:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M252.47 463.91l58.532 9.52-2.821 18.688H119.54l2.82-18.688 62.058-9.52 72.988-416.774-58.531-9.168 2.82-18.688h189.347l-2.82 18.688-62.764 9.168z" aria-label="I" font-weight="400" font-size="150.443" font-family="sans-serif" letter-spacing="0" word-spacing="0" stroke-width="3.761"/></svg>',Link:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M273 340.9l-67.9 67.9c-13.5 13.5-31.6 21-50.9 21-19.3 0-37.4-7.4-50.9-21-13.5-13.5-21-31.6-21-50.9 0-19.3 7.4-37.4 21-50.9l67.9-67.9c3.4-3.4 7.2-6.5 11.3-9.2 4.6-3 9.5-5.5 14.7-7.4 4.8-1.8 9.8-3 14.9-3.7 3.4-.5 6.8-.7 10.1-.7 1.4 0 2.8.1 4.6.2 17.5 1.1 34 8.5 46.3 20.8 10.8 10.8 17.8 24.8 20.1 39.8 2.3-.1 8.2-.5 16.2-2.9s13.4-6.3 13.4-6.3c-3.3-21.2-11.6-37.8-27.1-53.2-15.4-15.4-35.5-25.6-57-29-1.9-.3-3.7-.6-5.6-.8a99.994 99.994 0 0 0-18.7-.3c-5.4.4-10.7 1.2-16 2.4-1.1.2-2.1.5-3.2.8-6.7 1.8-13.2 4.2-19.3 7.2-10.1 5-19.4 11.6-27.4 19.6l-67.9 67.9C61 303.9 50.3 330 50.3 357.8s10.8 54 30.3 73.5c19.6 19.6 45.7 30.3 73.5 30.3 27.9 0 54-10.8 73.5-30.3l67.9-67.9c7.2-7.2 13.2-15.4 18-24.3 0 0-11.2 2.7-23.6 2.7s-16.9-.9-16.9-.9z"/><path d="M431.4 80.6c-19.6-19.6-45.7-30.3-73.5-30.3s-54 10.8-73.5 30.3l-67.9 67.9c-7.2 7.2-13.2 15.4-18 24.3 5.2-1.2 15.3-2.4 24-2.4s16.2 1.1 16.2 1.1l68.3-68.1c13.5-13.5 31.6-21 50.9-21s37.4 7.4 50.9 21c13.5 13.5 21 31.6 21 50.9 0 19.3-7.4 37.4-21 50.9L340.9 273c-3.4 3.4-7.2 6.5-11.3 9.2-4.6 3-9.5 5.5-14.7 7.4-4.8 1.7-9.8 3-14.9 3.7-3.4.5-6.8.7-10.1.7-1.4 0-2.8-.1-4.6-.2-17.5-1.1-34-8.5-46.3-20.8a71.194 71.194 0 0 1-19.9-38.8s-6.6-.5-15.7 2.3c-5.7 1.7-11.6 4.2-14.2 5.5 3 21.5 11.4 37.7 27.1 53.5l.2.2c16.7 16.7 39 27.3 62.6 29.8a99.994 99.994 0 0 0 18.7.3c6.4-.5 12.9-1.5 19.1-3.2 6.7-1.8 13.2-4.2 19.3-7.2 10.1-5 19.4-11.6 27.4-19.6l67.9-67.9c19.6-19.6 30.3-45.7 30.3-73.5s-10.9-54.2-30.4-73.8z"/></svg>',ListUnordered:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="512" width="512"><path d="M128.326 125.79c0-26.88-21.808-48.688-48.689-48.688-26.88 0-48.689 21.808-48.689 48.689 0 26.88 21.809 48.689 48.69 48.689 26.88 0 48.688-21.809 48.688-48.69zm0 129.838c0-26.88-21.808-48.689-48.689-48.689-26.88 0-48.689 21.809-48.689 48.69 0 26.88 21.809 48.688 48.69 48.688 26.88 0 48.688-21.808 48.688-48.689zM485.38 150.135v-48.689c0-4.31-3.804-8.115-8.115-8.115H168.9c-4.31 0-8.114 3.804-8.114 8.115v48.69c0 4.31 3.803 8.114 8.114 8.114h308.364c4.311 0 8.115-3.804 8.115-8.115zm-357.053 235.33c0-26.88-21.808-48.689-48.689-48.689-26.88 0-48.689 21.81-48.689 48.69s21.809 48.688 48.69 48.688c26.88 0 48.688-21.808 48.688-48.689zM485.38 279.973v-48.69c0-4.31-3.804-8.114-8.115-8.114H168.9c-4.31 0-8.114 3.804-8.114 8.115v48.689c0 4.31 3.803 8.114 8.114 8.114h308.364c4.311 0 8.115-3.803 8.115-8.114zm0 129.837v-48.69c0-4.31-3.804-8.114-8.115-8.114H168.9c-4.31 0-8.114 3.804-8.114 8.115v48.689c0 4.31 3.803 8.115 8.114 8.115h308.364c4.311 0 8.115-3.804 8.115-8.115z"/></svg>',ListOrdered:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="512" width="512"><path d="M131.36 429.568c0 26.595-20.793 41.585-45.937 41.585-15.232 0-30.705-5.077-41.585-15.957l13.781-21.276c6.528 6.044 16.44 10.88 25.628 10.88 8.462 0 17.408-4.11 17.408-13.781 0-13.54-15.474-14.265-25.386-13.54l-6.287-13.539c8.704-11.122 16.683-23.452 27.079-32.881v-.242c-7.737 0-15.715.484-23.452.484v12.814H46.981v-36.75h80.51v21.276l-22.968 27.804c16.199 3.868 26.837 16.44 26.837 33.123zm.484-151.592v38.442H44.32c-.725-4.352-1.45-8.704-1.45-13.056 0-44.728 54.64-51.498 54.64-71.807 0-8.22-5.077-12.572-13.055-12.572-8.462 0-15.474 7.253-19.584 14.023l-20.55-14.264C52.3 202.059 68.74 192.63 87.114 192.63c22.485 0 41.827 13.298 41.827 37.233 0 35.783-52.465 43.761-53.19 62.62h30.705v-14.507zm340.658 77.126v46.42c0 4.11-3.626 7.737-7.736 7.737H170.769c-4.352 0-7.737-3.627-7.737-7.737v-46.42c0-4.352 3.385-7.737 7.737-7.737h293.997c4.11 0 7.736 3.385 7.736 7.737zM132.085 137.747v23.936H51.091v-23.936h25.87c0-19.583.242-39.167.242-58.75v-2.902h-.484c-2.66 5.32-7.495 8.946-12.089 13.056L47.465 70.776l32.88-30.705h25.629v97.676zm340.417 93.567v46.42c0 4.11-3.626 7.737-7.736 7.737H170.769c-4.352 0-7.737-3.627-7.737-7.737v-46.42c0-4.352 3.385-7.737 7.737-7.737h293.997c4.11 0 7.736 3.385 7.736 7.737zm0-123.788v46.42c0 4.11-3.626 7.737-7.736 7.737H170.769c-4.352 0-7.737-3.627-7.737-7.737v-46.42c0-4.11 3.385-7.737 7.737-7.737h293.997c4.11 0 7.736 3.627 7.736 7.737z"/></svg>',Login:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 48c-42.9 0-84.2 13-119.2 37.5-34.2 24-60.2 57.2-75.1 96.1L58 192h45.7l1.9-5c8.2-17.8 19.4-33.9 33.5-48 31.2-31.2 72.7-48.4 116.9-48.4s85.7 17.2 116.9 48.4c31.2 31.2 48.4 72.7 48.4 116.9 0 44.1-17.2 85.7-48.4 116.9-31.2 31.2-72.7 48.4-116.9 48.4-44.1 0-85.6-17.2-116.9-48.4-14-14-25.3-30.1-33.5-47.9l-1.9-5H58l3.6 10.4c14.9 38.9 40.9 72.1 75.1 96.1C171.8 451.1 213 464 256 464c114.7 0 208-93.3 208-208S370.7 48 256 48z"/><path d="M48 277.4h189.7l-43.6 44.7L224 352l96-96-96-96-31 29.9 44.7 44.7H48v42.8z"/></svg>',Lock:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M376 186h-20v-40c0-55-45-100-100-100S156 91 156 146v40h-20c-22.002 0-40 17.998-40 40v200c0 22.002 17.998 40 40 40h240c22.002 0 40-17.998 40-40V226c0-22.002-17.998-40-40-40zM256 368c-22.002 0-40-17.998-40-40s17.998-40 40-40 40 17.998 40 40-17.998 40-40 40zm62.002-182H193.998v-40c0-34.004 28.003-62.002 62.002-62.002 34.004 0 62.002 27.998 62.002 62.002v40z"/></svg>',MatchCase:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><g aria-label="Aa" style="line-height:1.25" font-weight="400" font-size="40" font-family="sans-serif" letter-spacing="0" word-spacing="0"><path d="M145.05 93.731L88.808 311.588h112.688zm-23.4-58.349h47.004l116.794 437.766h-43.105l-27.916-112.3H76.287l-27.915 112.3H4.652zM432.824 308.07q-45.773 0-63.425 14.953-17.652 14.954-17.652 51.02 0 28.734 13.136 45.74 13.342 16.713 36.126 16.713 31.405 0 50.289-31.667 19.089-31.96 19.089-84.738V308.07zm75.33-22.285v187.363h-37.767v-49.846q-12.931 29.908-32.226 44.275-19.294 14.074-47.21 14.074-35.304 0-56.241-28.148-20.731-28.442-20.731-75.942 0-55.417 25.863-83.566 26.068-28.148 77.588-28.148h52.957v-5.278q0-37.238-17.242-57.47-17.036-20.524-48.03-20.524-19.706 0-38.384 6.743-18.68 6.744-35.92 20.232v-49.846q20.73-11.435 40.23-17.006 19.5-5.864 37.973-5.864 49.878 0 74.51 36.944 24.63 36.945 24.63 112.007z"/></g></svg>',Mobile:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M335.7 32H177.1C158.8 32 144 46.6 144 64.9v381c0 18.4 14.8 34.1 33.1 34.1h158.5c18.3 0 32.3-15.7 32.3-34.1v-381C368 46.6 354 32 335.7 32zM241 55h30c2.2 0 4 1.8 4 4s-1.8 4-4 4h-30c-2.2 0-4-1.8-4-4s1.8-4 4-4zm15.5 414c-9.6 0-17.4-7.8-17.4-17.4 0-9.6 7.8-17.4 17.4-17.4 9.6 0 17.4 7.8 17.4 17.4 0 9.6-7.8 17.4-17.4 17.4zm95.5-45H160V83h192v341z"/><path d="M256.5 441.6c-5.5 0-10 4.5-10 9.9 0 5.5 4.5 10 10 10s10-4.5 10-10c-.1-5.4-4.5-9.9-10-9.9z"/></svg>',More:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M256 224c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32zm-127.6 0c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.4-32-32-32zm255.6 0c-17.7 0-32 14.3-32 32s14.3 32 32 32 32-14.3 32-32-14.3-32-32-32z"/></svg>',NewWindow:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" height="512" width="512"><path d="M184 112c-39.764 0-72 32.236-72 72v224c0 39.764 32.236 72 72 72h224c39.764 0 72-32.236 72-72V184c0-39.764-32.236-72-72-72zm17.295 67.705h190.928c25.298 0 45.664 20.366 45.664 45.664v168.262c0 25.298-20.366 45.664-45.664 45.664H201.295c-25.298 0-45.666-20.366-45.666-45.664V225.369c0-25.298 20.368-45.664 45.666-45.664z"/><path d="M160 80h235.88A72.12 72.12 0 0 0 328 32H104a72 72 0 0 0-72 72v224a72.12 72.12 0 0 0 48 67.88V160a80 80 0 0 1 80-80z"/><g style="line-height:1.25"><path d="M283.336 219.113a14.108 14.108 0 0 0-14.107 14.108v56.455h-56.456a14.108 14.108 0 0 0-14.107 14.105v21.537a14.108 14.108 0 0 0 14.107 14.108h56.456v56.453a14.108 14.108 0 0 0 14.107 14.107h21.283a14.108 14.108 0 0 0 14.106-14.107v-56.453h56.455a14.108 14.108 0 0 0 14.107-14.108v-21.537a14.108 14.108 0 0 0-14.107-14.105h-56.455V233.22a14.108 14.108 0 0 0-14.106-14.108zm10.635 93.91a14.108 14.108 0 0 0 1.547 1.518 14.108 14.108 0 0 0-1.536 1.535 14.108 14.108 0 0 0-1.546-1.517 14.108 14.108 0 0 0 1.535-1.536z" style="line-height:1.25;font-variant-ligatures:normal;font-variant-position:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-alternates:normal;font-feature-settings:normal;text-indent:0;text-align:start;text-decoration-line:none;text-decoration-style:solid;text-decoration-color:#000;text-transform:none;text-orientation:mixed;white-space:normal;shape-padding:0;isolation:auto;mix-blend-mode:normal;solid-color:#000;solid-opacity:1" color="#000" font-size="259.445" overflow="visible" stroke="none" aria-label="+" font-weight="400" font-family="sans-serif" letter-spacing="0" word-spacing="0" stroke-width="28.214" stroke-linecap="round" stroke-linejoin="round"/></g></svg>',Pin:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 48c-79.5 0-144 59.9-144 133.7 0 104 144 282.3 144 282.3s144-178.3 144-282.3C400 107.9 335.5 48 256 48zm0 190.9c-25.9 0-46.9-21-46.9-46.9s21-46.9 46.9-46.9 46.9 21 46.9 46.9-21 46.9-46.9 46.9z"/></svg>',Reply:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M447.9 368.2c0-16.8 3.6-83.1-48.7-135.7-35.2-35.4-80.3-53.4-143.3-56.2V96L64 224l192 128v-79.8c40 1.1 62.4 9.1 86.7 20 30.9 13.8 55.3 44 75.8 76.6l19.2 31.2H448c0-10.1-.1-22.9-.1-31.8z"/></svg>',ReplyAll:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M304.5 192v-80L152.7 255.8 304.5 390v-91.9c68 0 107.9 8.9 159.1 101.9 0 0-6.1-208-159.1-208z"/><path d="M47.5 256l144 126.5V324l-82.2-68 82.2-78.6v-57z"/></svg>',Send:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M464 48L48 270.9l110.5 47.5L456.1 56.2 214.7 349.5l-1.1 87.4 41.6-57.9L372 464z"/><path d="M169.6 330.3L197.7 460h.4v-.5l2.9-118.7 150.3-175.1z"/></svg>',Spam:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M374.6 127.3C345.4 88.5 303.1 64 256 64s-89.4 24.5-118.6 63.3c6.4 15.6 15.8 30 28.1 42.3 24.2 24.2 56.3 37.5 90.5 37.5s66.3-13.3 90.5-37.5c12.3-12.3 21.8-26.6 28.1-42.3z"/><path d="M126.8 142.8c-1.7 2.8-3.4 5.7-5 8.6-2.9-1.8-5.3-3.7-7.7-5.8-1.2-1-3-3.9-4.5-7.4 5.4-11.3 1.2-25-9.9-31.3-11.6-6.5-26.2-2.4-32.7 9.2-6.5 11.6-2.4 26.2 9.2 32.7 1.3.7 2.5 1.3 3.8 1.7 2.8 6.3 7.3 14.3 13.5 19.5 4.2 3.5 8.8 7.1 15.2 10.7-7.2 20.3-11.6 42.3-12.5 65.4-11 .2-18.6 2.1-25.5 4.1-4.2 1.2-8.2 3.4-11.8 5.9-1-.1-1.9-.2-2.9-.2-13.3 0-24 10.7-24 24s10.7 24 24 24c12.9 0 23.5-10.2 24-23 5-1.5 9.9-2.7 17.1-2.8 3.2 33 13.3 63.5 28.6 89.2-14.2 11-22.9 23-26.6 36.3 0 0-.8.4-1.9 1.4-1 .8-1.9 1.6-2.8 2.6-8.9 9.9-8.1 25 1.8 33.9 9.9 8.9 25 8.1 33.9-1.8 8.1-9 8.1-22.4.6-31.4 3.1-5.6 6.2-9 13.7-15 27.1 31.7 63.4 52 103.7 54.4V222.9c-53.3-2.9-98.9-34.8-121.3-80.1zM456 256.1c-1 0-2 .1-2.9.2-3.6-2.5-7.7-4.6-11.8-5.9-6.9-2-14.4-3.9-25.5-4.1-1-23.1-5.4-45.2-12.5-65.4 6.4-3.6 11-7.2 15.2-10.7 6.2-5.2 10.7-13.3 13.5-19.5 1.3-.5 2.6-1 3.8-1.7 11.6-6.5 15.7-21.1 9.2-32.7-6.5-11.6-21.1-15.7-32.7-9.2-11.1 6.2-15.3 19.9-9.9 31.3-1.6 3.4-3.4 6.4-4.5 7.4-2.4 2-4.8 3.9-7.7 5.8-1.6-2.9-3.3-5.8-5-8.6-22.4 45.3-67.9 77.1-121.2 80v225c40.3-2.4 76.6-22.8 103.7-54.4 7.4 5.9 10.6 9.4 13.7 15-7.5 9-7.5 22.4.6 31.4 8.9 9.9 24 10.7 33.9 1.8 9.9-8.9 10.7-24 1.8-33.9-.9-1-1.8-1.8-2.8-2.6-1.1-.9-1.9-1.4-1.9-1.4-3.7-13.3-12.4-25.3-26.6-36.3 15.3-25.7 25.4-56.2 28.6-89.2 7.2.1 12 1.3 17.1 2.8.5 12.8 11 23 24 23 13.3 0 24-10.7 24-24s-10.8-24.1-24.1-24.1z"/></svg>',Trash:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M128 405.43c0 23.416 19.198 42.57 42.667 42.57h170.667C364.802 448 384 428.846 384 405.43V160H128v245.43zM416 96h-80l-26.785-32h-106.43L176 96H96v32h320V96z"/></svg>',TrashEmpty:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M18.397 253.302C-.698 266.856-5.205 293.598 8.38 312.736l98.787 139.17c13.584 19.138 40.315 23.706 59.41 10.152l200.136-142.06-148.18-208.757zm493.146-70.445l-73.959-30.498-12.563-39.794-98.392-40.573-36.962 19.372-73.959-30.498L203.51 90.45l295.835 121.99z"/></svg>',Underline:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M389.262 47.272l-55.55-8.024V22.89h141.036v16.357l-53.082 8.024v247.2q0 74.375-41.045 111.409-40.737 37.034-118.508 37.034-82.4 0-123.446-37.034Q97.93 368.539 97.93 300.335V47.272L44.85 39.248V22.89h165.417v16.357l-53.082 8.024v248.434q0 112.644 109.558 112.644 59.254 0 90.732-28.084 31.788-28.084 31.788-83.326z" aria-label="U" font-weight="400" font-size="131.675" font-family="sans-serif" letter-spacing="0" word-spacing="0" stroke-width="3.292"/><path d="M35.15 451.524h442.785v38.781H35.15z"/></svg>',Unlock:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M376 186h-20v-40c0-55-45-100-100-100S156 91 156 146h37.998c0-34.004 28.003-62.002 62.002-62.002 34.004 0 62.002 27.998 62.002 62.002H318v40H136c-22.002 0-40 17.998-40 40v200c0 22.002 17.998 40 40 40h240c22.002 0 40-17.998 40-40V226c0-22.002-17.998-40-40-40zM256 368c-22.002 0-40-17.998-40-40s17.998-40 40-40 40 17.998 40 40-17.998 40-40 40z"/></svg>',Warning:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 64L48 448h416L256 64zm-11.8 144h24v65.7l-6 70.3h-12l-6-70.3V208zM256 400c-8.8 0-16-7.2-16-16s7.2-16 16-16 16 7.2 16 16-7.2 16-16 16z"/></svg>',WarningOutline:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 368c-8.8 0-16 7.2-16 16s7.2 16 16 16 16-7.2 16-16-7.2-16-16-16zm-11.8-94.3V208h24v65.7l-6 70.3h-12l-6-70.3z"/><path d="M256 97.5L437.2 432H74.8L256 97.5m0-33.5L48 448h416L256 64z"/></svg>',Wand:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M183 62h24v64h-24zm0 204h24v64h-24zm91-87h64v24h-64zm23.9-72.9l-16.6-16.6-45.2 45.3 16.6 16.7zm-202.8 3l45.2 45.4 16.6-16.7-45.2-45.3zm-3 170l16.6 16.7 45.2-45.3-16.6-16.7zM58 179h64v24H58zM192.2 153.4l-34 34.2 43.4 43.5 34.1-34.1zM447 408.8L251.7 213l-34.1 34.1L413 443z"/></svg>',NoEye:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256.1 144.8c56.2 0 101.9 45.3 101.9 101.1 0 13.1-2.6 25.5-7.3 37l59.5 59c30.8-25.5 55-58.4 69.9-96-35.3-88.7-122.3-151.6-224.2-151.6-28.5 0-55.8 5.1-81.1 14.1l44 43.7c11.6-4.6 24.1-7.3 37.3-7.3zM52.4 89.7l46.5 46.1 9.4 9.3c-33.9 26-60.4 60.8-76.3 100.8 35.2 88.7 122.2 151.6 224.1 151.6 31.6 0 61.7-6.1 89.2-17l8.6 8.5 59.7 59 25.9-25.7L78.2 64 52.4 89.7zM165 201.4l31.6 31.3c-1 4.2-1.6 8.7-1.6 13.1 0 33.5 27.3 60.6 61.1 60.6 4.5 0 9-.6 13.2-1.6l31.6 31.3c-13.6 6.7-28.7 10.7-44.8 10.7-56.2 0-101.9-45.3-101.9-101.1 0-15.8 4.1-30.7 10.8-44.3zm87.8-15.7l64.2 63.7.4-3.2c0-33.5-27.3-60.6-61.1-60.6l-3.5.1z"/></svg>',Eye:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 105c-101.8 0-188.4 62.4-224 151 35.6 88.6 122.2 151 224 151s188.4-62.4 224-151c-35.6-88.6-122.2-151-224-151zm0 251.7c-56 0-101.8-45.3-101.8-100.7S200 155.3 256 155.3 357.8 200.6 357.8 256 312 356.7 256 356.7zm0-161.1c-33.6 0-61.1 27.2-61.1 60.4s27.5 60.4 61.1 60.4 61.1-27.2 61.1-60.4-27.5-60.4-61.1-60.4z"/></svg>',People:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M337.454 232c33.6 0 61.092-27.002 61.092-60 0-32.997-27.493-60-61.092-60s-61.09 27.003-61.09 60c0 32.998 27.49 60 61.09 60zm-162.908 0c33.6 0 61.09-27.002 61.09-60 0-32.997-27.49-60-61.09-60s-61.092 27.003-61.092 60c0 32.998 27.493 60 61.092 60zm0 44C126.688 276 32 298.998 32 346v54h288v-54c0-47.002-97.6-70-145.454-70zm162.908 11.003c-6.105 0-10.325 0-17.454.997 23.426 17.002 32 28 32 58v54h128v-54c0-47.002-94.688-58.997-142.546-58.997z"/></svg>',Print:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M399.95 160h-287.9C76.824 160 48 188.803 48 224v138.667h79.9V448h256.2v-85.333H464V224c0-35.197-28.825-64-64.05-64zM352 416H160V288h192v128zm32.1-352H127.9v80h256.2V64z"/></svg>',Chat:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M336 48H48v224h112V160h176z"/><path d="M176 176v224h162.6l64 64H416v-64h48V176H176z"/></svg>',Copy:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M144 416V112h-32v336h240v-32H160z"/><path d="M325.3 64H160v336h240V139l-74.7-75zM368 176h-80V96h16v64h64v16z"/></svg>',Close:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path class="st0" d="M340.2 160l-84.4 84.3-84-83.9-11.8 11.8 84 83.8-84 83.9 11.8 11.7 84-83.8 84.4 84.2 11.8-11.7-84.4-84.3 84.4-84.2z"/></svg>',Cash:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M40 368h432v16H40zm8 32h416v16H48zm208-232c-30.9 0-56 25.1-56 56s25.1 56 56 56 56-25.1 56-56-25.1-56-56-56z"/><path d="M32 96v256h448V96H32zm96 224H64v-16h64v16zm0-176H64v-16h64v16zm128 152c-39.7 0-72-32.3-72-72s32.3-72 72-72 72 32.3 72 72-32.3 72-72 72zm192 24h-64v-16h64v16zm0-176h-64v-16h64v16z"/></svg>',Picture:'<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M174.9 166.48c0 27.719-22.489 50.208-50.208 50.208-27.719 0-50.208-22.489-50.208-50.208 0-27.719 22.489-50.208 50.208-50.208 27.719 0 50.208 22.489 50.208 50.208zM442.67 266.9v117.15H74.48v-50.208l83.68-83.68 41.84 41.84 133.89-133.89zm25.104-184.1h-418.4c-4.446 0-8.368 3.922-8.368 8.368v317.98c0 4.446 3.922 8.368 8.368 8.368h418.4c4.445 0 8.368-3.922 8.368-8.368V91.168c0-4.446-3.923-8.368-8.368-8.368zm41.84 8.368v317.98c0 23.012-18.828 41.84-41.84 41.84h-418.4c-23.012 0-41.84-18.828-41.84-41.84V91.168c0-23.012 18.828-41.84 41.84-41.84h418.4c23.012 0 41.84 18.828 41.84 41.84z"/></svg>',FontSize:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M45.318 69.468h241.467v60.81H199.92v325.766H132.36V130.277H45.318zM377.8 125.582h66.553v263.167H377.8zm-47.776 263.167l161.744.06-40.477 45.152-40.476 45.15-40.396-45.18zm162.613-263.088l-161.744-.06 40.477-45.152 40.476-45.15 40.396 45.18z"/></svg>',Table:'<svg width="512" height="512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M162.56 414.84v-56.061c0-5.256-4.088-9.344-9.344-9.344H59.781c-5.255 0-9.343 4.088-9.343 9.344v56.061c0 5.256 4.088 9.344 9.343 9.344h93.435c5.256 0 9.344-4.088 9.344-9.344zm0-112.12v-56.061c0-5.256-4.088-9.344-9.344-9.344H59.781c-5.255 0-9.343 4.088-9.343 9.344v56.061c0 5.256 4.088 9.343 9.343 9.343h93.435c5.256 0 9.344-4.087 9.344-9.343zm149.5 112.12v-56.061c0-5.256-4.088-9.344-9.344-9.344h-93.435c-5.255 0-9.343 4.088-9.343 9.344v56.061c0 5.256 4.088 9.344 9.343 9.344h93.435c5.256 0 9.344-4.088 9.344-9.344zm-149.5-224.25v-56.061c0-5.256-4.088-9.344-9.344-9.344H59.781c-5.255 0-9.343 4.088-9.343 9.344v56.061c0 5.256 4.088 9.343 9.343 9.343h93.435c5.256 0 9.344-4.087 9.344-9.343zm149.5 112.12v-56.061c0-5.256-4.088-9.344-9.344-9.344h-93.435c-5.255 0-9.343 4.088-9.343 9.344v56.061c0 5.256 4.088 9.344 9.343 9.344h93.435c5.256 0 9.344-4.088 9.344-9.344zm149.5 112.12v-56.061c0-5.256-4.088-9.344-9.344-9.344h-93.435c-5.255 0-9.343 4.088-9.343 9.344v56.061c0 5.256 4.088 9.344 9.343 9.344h93.435c5.256 0 9.344-4.088 9.344-9.344zm-149.5-224.25v-56.061c0-5.256-4.088-9.344-9.344-9.344h-93.435c-5.255 0-9.343 4.088-9.343 9.344v56.061c0 5.256 4.088 9.343 9.343 9.343h93.435c5.256 0 9.344-4.087 9.344-9.343zm149.5 112.12v-56.061c0-5.256-4.088-9.344-9.344-9.344h-93.435c-5.255 0-9.343 4.088-9.343 9.344V302.7c0 5.256 4.088 9.344 9.343 9.344h93.435c5.256 0 9.344-4.088 9.344-9.344zm0-112.12v-56.061c0-5.256-4.088-9.344-9.344-9.344h-93.435c-5.255 0-9.343 4.088-9.343 9.344v56.061c0 5.256 4.088 9.343 9.343 9.343h93.435c5.256 0 9.344-4.087 9.344-9.343zm37.374-93.436v317.68c0 25.695-21.023 46.718-46.718 46.718H59.786c-25.695 0-46.718-21.023-46.718-46.718V97.144c0-25.695 21.023-46.718 46.718-46.718h392.43c25.695 0 46.718 21.023 46.718 46.718z"/></svg>',ListAlt:'<svg width="512" height="512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M116.63 351.81v17.421c0 4.627-4.083 8.71-8.71 8.71H90.499c-4.628 0-8.71-4.083-8.71-8.71V351.81c0-4.627 4.082-8.71 8.71-8.71h17.42c4.628 0 8.711 4.083 8.711 8.71zm0-69.683v17.421c0 4.627-4.083 8.71-8.71 8.71H90.499c-4.628 0-8.71-4.083-8.71-8.71v-17.421c0-4.627 4.082-8.71 8.71-8.71h17.42c4.628 0 8.711 4.083 8.711 8.71zm0-69.683v17.421c0 4.627-4.083 8.71-8.71 8.71H90.499c-4.628 0-8.71-4.083-8.71-8.71v-17.421c0-4.627 4.082-8.71 8.71-8.71h17.42c4.628 0 8.711 4.083 8.711 8.71zm313.57 139.37v17.421c0 4.627-4.083 8.71-8.71 8.71H160.18c-4.628 0-8.71-4.083-8.71-8.71v-17.421c0-4.627 4.082-8.71 8.71-8.71h261.31c4.627 0 8.71 4.083 8.71 8.71zm0-69.683v17.421c0 4.627-4.083 8.71-8.71 8.71H160.18c-4.628 0-8.71-4.083-8.71-8.71v-17.421c0-4.627 4.082-8.71 8.71-8.71h261.31c4.627 0 8.71 4.083 8.71 8.71zm0-69.683v17.421c0 4.627-4.083 8.71-8.71 8.71H160.18c-4.628 0-8.71-4.083-8.71-8.71v-17.421c0-4.627 4.082-8.71 8.71-8.71h261.31c4.627 0 8.71 4.083 8.71 8.71zm34.842 191.63v-226.47c0-4.627-4.083-8.71-8.71-8.71H55.652c-4.628 0-8.71 4.083-8.71 8.71v226.47c0 4.627 4.082 8.71 8.71 8.71h400.68c4.627 0 8.71-4.083 8.71-8.71zm34.842-296.15v296.15c0 23.954-19.598 43.552-43.552 43.552H55.652c-23.954 0-43.552-19.598-43.552-43.552v-296.15c0-23.954 19.598-43.552 43.552-43.552h400.68c23.954 0 43.552 19.598 43.552 43.552z"/></svg>',Notifications:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M256 464c22.78 0 41.41-18.72 41.41-41.6h-82.82c0 22.88 18.633 41.6 41.412 41.6zm134.59-124.8V224.8c0-63.44-44.517-117.518-103.53-131.04V79.2C287.06 61.518 273.6 48 256 48s-31.06 13.518-31.06 31.2v14.56c-59.014 13.522-103.53 67.6-103.53 131.04v114.4L80 380.8v20.8h352v-20.8l-41.41-41.6z"/></svg>',ArrowDropLeft:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M320 128L192 256l128 128z"/></svg>',ArrowDropRight:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M192 128l128 128-128 128z"/></svg>',Power:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M279.1 48h-46.2v231.1h46.2V48zm111.6 50.2L357.9 131c36.5 29.4 59.9 74.4 59.9 125 0 89.4-72.3 161.8-161.8 161.8S94.2 345.4 94.2 256c0-50.6 23.3-95.7 59.6-125.3l-32.6-32.6C76.4 136.3 48 192.7 48 256c0 114.9 93.1 208 208 208s208-93.1 208-208c0-63.3-28.4-119.7-73.3-157.8z"/></svg>',Palette:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M430.1 347.9c-6.6-6.1-16.3-7.6-24.6-9-11.5-1.9-15.9-4-22.6-10-14.3-12.7-14.3-31.1 0-43.8l30.3-26.9c46.4-41 46.4-108.2 0-149.2-34.2-30.1-80.1-45-127.8-45-55.7 0-113.9 20.3-158.8 60.1-83.5 73.8-83.5 194.7 0 268.5 41.5 36.7 97.5 55 152.9 55.4h1.7c55.4 0 110-17.9 148.8-52.4 14.4-12.7 12-36.6.1-47.7zM120 216c0-17.7 14.3-32 32-32s32 14.3 32 32-14.3 32-32 32-32-14.3-32-32zm40 126c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm64-161c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32zm72 219c-26.5 0-48-21.5-48-48s21.5-48 48-48 48 21.5 48 48-21.5 48-48 48zm24-208c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z"/></svg>',Import:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M403.002 217C388.998 148.003 328.998 96 256 96c-57.998 0-107.998 32.998-132.998 81C63.002 183.003 16 234 16 296c0 65.996 54 120 120 120h260c55 0 100-45 100-100 0-52.998-40.996-96-92.998-99zM288 276v76h-64v-76h-68l100-100 100 100h-68z"/></svg>',Export:'<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><path d="M403.002 217C388.998 148.003 328.998 96 256 96c-57.998 0-107.998 32.998-132.998 81C63.002 183.003 16 234 16 296c0 65.996 54 120 120 120h260c55 0 100-45 100-100 0-52.998-40.996-96-92.998-99zM224 268v-76h64v76h68L256 368 156 268h68z"/></svg>',PencilSquare:'<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M255.03 344.31l29.101-29.101-38.133-38.133-29.101 29.101v14.049h24.084v24.084zm130.45-31.61v47.666c0 39.889-32.363 72.252-72.252 72.252h-208.73c-39.889 0-72.252-32.363-72.252-72.252v-208.73c0-39.889 32.363-72.252 72.252-72.252h208.73c10.035 0 20.07 2.007 29.352 6.272 2.258 1.003 4.014 3.261 4.516 5.77.501 2.76-.251 5.268-2.258 7.275l-12.293 12.293c-2.258 2.258-5.269 3.01-8.028 2.007-3.763-1.003-7.526-1.505-11.29-1.505h-208.73c-22.076 0-40.14 18.063-40.14 40.14v208.73c0 22.077 18.064 40.14 40.14 40.14h208.73c22.078 0 40.14-18.063 40.14-40.14v-31.61c0-2.007.753-4.014 2.259-5.52l16.056-16.055c2.508-2.509 5.77-3.01 8.78-1.756 3.01 1.254 5.018 4.014 5.018 7.275zm-24.084-185.14l72.252 72.252-168.59 168.59h-72.252V296.15zm111.39 33.115l-23.08 23.08-72.252-72.252 23.08-23.08c9.282-9.282 24.837-9.282 34.119 0l38.133 38.133c9.282 9.282 9.282 24.837 0 34.119z"/></svg>'}),_export("IconsSvg",IconsSvg),_export("SecondFactorImage","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAMAAAC5zwKfAAACH1BMVEVHcEw6OzwsKSMlIR0fHRlLTEpgZGRdYGC/s65ZW1lWWVktLS9AQUMtKickIx4fHRkxMjM3Ojs0MzI6Ozw3OjxHSEo2NjgmIh1GSEgkIRwhHxpBQ0YyMzMqKyw0NDVBQ0ZAREYdHBcdGxccGhcbGhYoJR8eHRpVWFc5Oz8tLClCQ0RAQEFIS0pAQkAdHBkgIBsdGxdAPz0mIx4dHBkqKCMsLC1OUFJYVUtOUk9KTU0mIx8jIiQiIyQkJCQjJCYkJigjIyUlJScjJCckJSYlJSYjIyIhIiMmJicnKCsmJyklJikjJCQiIiEVFRP72XkmJyoYFxUQEA8jJSUSEhEiIyYTExIfHx8bGxkgICApKiz92nP83IIbGhYcHBz82nYnJiT72Xz93H8eHRwqKSb934j72oAsLC7923wYGBf/44z613UnKCj+4pH923f63Yn93H3w04TsyWz624Saezv734/Mqlf/4IMzLiUwMDL/33z/549fTy3FpVaggD6qjEvLrWS5lkr20nD/3XkmJCG9mk3923kNDgxJRkAhGxSagk4bFg9DOCT/6JT82HAlIBb53YzlxXT20nelhkI5MB/WslpANil9aT/XvHd0ZUPjx3zdul+wkU69oF7wznHiwGzbumm4mleRd0Pnw2ZMPyY6NiyQcTcxKRnRu4SDdFS7pGrDp2LewXWIbj1uXDjVtGWljVTuznhoYlZoWz6WhV9QRS2ZIZsiAAAAPHRSTlMAnRM1vEgXDAIGMPzKQUry8M/DsOh7/V5ef8q73POuk7Dd69j5G5Uj3SiEcDlNhHLR/Kzz1+JWjnhtaf6zr7VHAAAHoklEQVR4Xu2X1ZNcxxXGRxatxSu00GKyHXPiJI2XCYaZGZZZzMzMLDMG/sCcu7FfR7Pw4ip93VXzcKt+db4D3T2+P7Pe6q0WLVmxccEs8r5arKva6lkjLlxVpVyj+t5ZIi5a23I5yFBXL5wN3pqJluEaXKWCoXXPnPju1oQhaECklHDD3TtT4qJNmkp1jeuaIVDu6lp314x4701ompvQqpqrQRoF16XakndnwNtY1V3d1RIJF0wLjIBxN7Fk+nb3UqBpCQ2gLqcomslEEaXa1unahWYWtFbCBWmapoTOBuy6HdX16sZpVXdOQtdc2Bps19CZ7Q8FAiHbH+dGYs40hmO1yjkkTHVdrwkNGrMD29evW78jFqeUJ7Z2TdXuZs0woALQKLAMHYD+ZT5P61qUc554f6p2VV33kNr/EygIrrL0949bdIGIvDoFYtceaGYuCZxwg+t6grucE3XzH+23EiJkRKru7xg4f0JX1Zbu5ZAbqqGDQ5XxxPzfvyY4xQRWdU2H8c2pcpDOVY2LOhjmhFDOuLD4Kx/ob4uxyJlJJKJW/94Jb0+3ykURPGKq66qu6QbnmBLCCUp8umTJWkrgM2OEEVGqzn9zePOrKsUcS1w3sSSB28lThlKDhCkxBENkOhcMAZCcML7ljcD3EyJhkiQFrWLdjtj+jCVRURQMTETKuE4NDngeFkhQYGFUX/mmZu6WMCOIiCgTsc9/c+nW1Yt2BhkCAduEeMUWNeBzyohJiBKpr3pDdVdwjIGIUf3soWMDPQcPDt17EUorXCIsyJnBMecQIvfMUhqN1K2lbdO3JkE4ZmKQI//555fLqX5QoXH9Vp1BxoJehIChElgXwtSMBeqfz23L61Yl7NWOSJmLPzZShUKtv3Ym65QHvolC1EwkVKM6hOfBkWVH6tveacf7cAXhEJwpqATZF8q1/kLtzOCJA07SKX9vBUVGOAlSbhJwSwQxGrLru33ttD8hiThIREaJGj/f50WXPfPw8GhvNpnqG2fYVGRgARYx+I0F/PW26VuwSsMi4yrl0Mskc/dgodDf23vy8PHjt7PZ1OX7YSwrSIHpYIxhFrdD/h372vJWUJGqgii6XIIIM48b/WdAJ4aP3B5OZlM9/xGwTBgyucgZQtFQxD+vrd0PqiLBkkiJa3CRU575oVHLZnt7m8dePnmYTKYa34VxUEFm0Bs5FINrYF37Z4uKJUQkouuaQDjXJXShUXOyTi/kL5m84qQa5zDGFg6aYFjxB9Lbd7W92L6UCMOQdVXQdUPnhEiJO41CLdubhJ28kiz03ati2YT0AXbSbvtuqUrY44U5hSXonHFKJr4v5yE6wDWzkMJ/qwzJMgIVA3bsL762WisyLBImE2+oAKmrIubqpwPlmgPKOsC7K5lYRia4rgfqO+e253W1TBGbmGDGGVF5OGwYjIhq69y3jbFUpZYvNx7cVzFG2ERmPBKqbwC77bW6iETCIUaGGIgwURcIQvrEv74d6enpefDdhIplS0IMZcDu7jffnX9NZExJkiZxCLCYEW6wIJalxNpz5167BHiIcC7X7eLOZR29hqwiZhIXAYk5QgIPchYGsCkFJQzVRWDYRDAcsW2dPQznWHYRppgxESGRww8NcsgYMpmJEZIBh5EMZ0F6d0e8Bd2l3J1bcSxjoigIfJuKgAkSgQgky8LIkhUlE/Dv/Liz59qKEr4/8OBqXII+U5ClmGGwTgBpIgUWQoqMkT9UX76vExwMcWn818sjPT9ejGPwiBRFYV5oIC9e2DJC0UgkNq+rowt9Zal053plqO/a8A8XLYmpJCwhZmEFwbIUBSPAs0ygHvtHR+F9uKmU+/m3Qmrsl8c9Bx9flTkTCWJeHhGQCPOElXootn1pR7yPFpdKFyqg0WflkZG+u+mcJAFSgSAhbVhmQMYW2N3Q2RN9Val169hYPu8cf1ru6xt4NPDreSwR7A0twcSrBcNmMQRnQUfpW7Bazb26kXecweF8pZL67ejlkfJPfhmbCIDIO+6B550FHQ0HzNtmNfqimXcOnB6t5Z2x07+k+q713DyUBiBUl8FGvKXYdvqTXZ2lrxUcf34gmz1x/Gkhnz/x6Fmhkhp4dK9xqI7RZEW8tvaG4zNfZ9oi/Xcwm70yeLPp5J3BIzdq+dSNFwMj18qHYvKkXSRbsZA/7dntcHzv3M4mb58+6eRPjp6Gyhw4PAymhy5cjcRkZEGIlt9O75jb+Yv3n9brlzdP92ad5s3BfCXf//WxSmUodaiUKwZilslYNOJPz5vKH7r9lvw6fuqw8/L4oJPvHxy+PlYpH7uUy8UCZwMZGWUi9fTHvilpTkbG6vjo0V6n6Tz7aawyNHT0VCmXDtnL06FQIBLbDnanpi1FjPGph83mmSOHnXz+xs+5nOX3b5vrW7rcD3bf8U1ZK2MI40tPnhx56jj911+1clE7PXmmdM37ZL1vGuraVMSyfOnIE8c58Hw8h2N2GmzORAu/LKrjR082m80XxVNW3e9dkDMkbo6rX59snnh1So7b6fVgd6baV4rGj47eQnLG//k632xoT84qlWSwu3yXb3b0kZyJR2P+LyB9s6T3ipFI8TPfLOqDLzYs8/359VZv9T8UG5sEW/KUGwAAAABJRU5ErkJggg=="),_export("SecondFactorImage","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAABQCAMAAAC5zwKfAAACH1BMVEVHcEw6OzwsKSMlIR0fHRlLTEpgZGRdYGC/s65ZW1lWWVktLS9AQUMtKickIx4fHRkxMjM3Ojs0MzI6Ozw3OjxHSEo2NjgmIh1GSEgkIRwhHxpBQ0YyMzMqKyw0NDVBQ0ZAREYdHBcdGxccGhcbGhYoJR8eHRpVWFc5Oz8tLClCQ0RAQEFIS0pAQkAdHBkgIBsdGxdAPz0mIx4dHBkqKCMsLC1OUFJYVUtOUk9KTU0mIx8jIiQiIyQkJCQjJCYkJigjIyUlJScjJCckJSYlJSYjIyIhIiMmJicnKCsmJyklJikjJCQiIiEVFRP72XkmJyoYFxUQEA8jJSUSEhEiIyYTExIfHx8bGxkgICApKiz92nP83IIbGhYcHBz82nYnJiT72Xz93H8eHRwqKSb934j72oAsLC7923wYGBf/44z613UnKCj+4pH923f63Yn93H3w04TsyWz624Saezv734/Mqlf/4IMzLiUwMDL/33z/549fTy3FpVaggD6qjEvLrWS5lkr20nD/3XkmJCG9mk3923kNDgxJRkAhGxSagk4bFg9DOCT/6JT82HAlIBb53YzlxXT20nelhkI5MB/WslpANil9aT/XvHd0ZUPjx3zdul+wkU69oF7wznHiwGzbumm4mleRd0Pnw2ZMPyY6NiyQcTcxKRnRu4SDdFS7pGrDp2LewXWIbj1uXDjVtGWljVTuznhoYlZoWz6WhV9QRS2ZIZsiAAAAPHRSTlMAnRM1vEgXDAIGMPzKQUry8M/DsOh7/V5ef8q73POuk7Dd69j5G5Uj3SiEcDlNhHLR/Kzz1+JWjnhtaf6zr7VHAAAHoklEQVR4Xu2X1ZNcxxXGRxatxSu00GKyHXPiJI2XCYaZGZZZzMzMLDMG/sCcu7FfR7Pw4ip93VXzcKt+db4D3T2+P7Pe6q0WLVmxccEs8r5arKva6lkjLlxVpVyj+t5ZIi5a23I5yFBXL5wN3pqJluEaXKWCoXXPnPju1oQhaECklHDD3TtT4qJNmkp1jeuaIVDu6lp314x4701ompvQqpqrQRoF16XakndnwNtY1V3d1RIJF0wLjIBxN7Fk+nb3UqBpCQ2gLqcomslEEaXa1unahWYWtFbCBWmapoTOBuy6HdX16sZpVXdOQtdc2Bps19CZ7Q8FAiHbH+dGYs40hmO1yjkkTHVdrwkNGrMD29evW78jFqeUJ7Z2TdXuZs0woALQKLAMHYD+ZT5P61qUc554f6p2VV33kNr/EygIrrL0949bdIGIvDoFYtceaGYuCZxwg+t6grucE3XzH+23EiJkRKru7xg4f0JX1Zbu5ZAbqqGDQ5XxxPzfvyY4xQRWdU2H8c2pcpDOVY2LOhjmhFDOuLD4Kx/ob4uxyJlJJKJW/94Jb0+3ykURPGKq66qu6QbnmBLCCUp8umTJWkrgM2OEEVGqzn9zePOrKsUcS1w3sSSB28lThlKDhCkxBENkOhcMAZCcML7ljcD3EyJhkiQFrWLdjtj+jCVRURQMTETKuE4NDngeFkhQYGFUX/mmZu6WMCOIiCgTsc9/c+nW1Yt2BhkCAduEeMUWNeBzyohJiBKpr3pDdVdwjIGIUf3soWMDPQcPDt17EUorXCIsyJnBMecQIvfMUhqN1K2lbdO3JkE4ZmKQI//555fLqX5QoXH9Vp1BxoJehIChElgXwtSMBeqfz23L61Yl7NWOSJmLPzZShUKtv3Ym65QHvolC1EwkVKM6hOfBkWVH6tveacf7cAXhEJwpqATZF8q1/kLtzOCJA07SKX9vBUVGOAlSbhJwSwQxGrLru33ttD8hiThIREaJGj/f50WXPfPw8GhvNpnqG2fYVGRgARYx+I0F/PW26VuwSsMi4yrl0Mskc/dgodDf23vy8PHjt7PZ1OX7YSwrSIHpYIxhFrdD/h372vJWUJGqgii6XIIIM48b/WdAJ4aP3B5OZlM9/xGwTBgyucgZQtFQxD+vrd0PqiLBkkiJa3CRU575oVHLZnt7m8dePnmYTKYa34VxUEFm0Bs5FINrYF37Z4uKJUQkouuaQDjXJXShUXOyTi/kL5m84qQa5zDGFg6aYFjxB9Lbd7W92L6UCMOQdVXQdUPnhEiJO41CLdubhJ28kiz03ati2YT0AXbSbvtuqUrY44U5hSXonHFKJr4v5yE6wDWzkMJ/qwzJMgIVA3bsL762WisyLBImE2+oAKmrIubqpwPlmgPKOsC7K5lYRia4rgfqO+e253W1TBGbmGDGGVF5OGwYjIhq69y3jbFUpZYvNx7cVzFG2ERmPBKqbwC77bW6iETCIUaGGIgwURcIQvrEv74d6enpefDdhIplS0IMZcDu7jffnX9NZExJkiZxCLCYEW6wIJalxNpz5167BHiIcC7X7eLOZR29hqwiZhIXAYk5QgIPchYGsCkFJQzVRWDYRDAcsW2dPQznWHYRppgxESGRww8NcsgYMpmJEZIBh5EMZ0F6d0e8Bd2l3J1bcSxjoigIfJuKgAkSgQgky8LIkhUlE/Dv/Liz59qKEr4/8OBqXII+U5ClmGGwTgBpIgUWQoqMkT9UX76vExwMcWn818sjPT9ejGPwiBRFYV5oIC9e2DJC0UgkNq+rowt9Zal053plqO/a8A8XLYmpJCwhZmEFwbIUBSPAs0ygHvtHR+F9uKmU+/m3Qmrsl8c9Bx9flTkTCWJeHhGQCPOElXootn1pR7yPFpdKFyqg0WflkZG+u+mcJAFSgSAhbVhmQMYW2N3Q2RN9Val169hYPu8cf1ru6xt4NPDreSwR7A0twcSrBcNmMQRnQUfpW7Bazb26kXecweF8pZL67ejlkfJPfhmbCIDIO+6B550FHQ0HzNtmNfqimXcOnB6t5Z2x07+k+q713DyUBiBUl8FGvKXYdvqTXZ2lrxUcf34gmz1x/Gkhnz/x6Fmhkhp4dK9xqI7RZEW8tvaG4zNfZ9oi/Xcwm70yeLPp5J3BIzdq+dSNFwMj18qHYvKkXSRbsZA/7dntcHzv3M4mb58+6eRPjp6Gyhw4PAymhy5cjcRkZEGIlt9O75jb+Yv3n9brlzdP92ad5s3BfCXf//WxSmUodaiUKwZilslYNOJPz5vKH7r9lvw6fuqw8/L4oJPvHxy+PlYpH7uUy8UCZwMZGWUi9fTHvilpTkbG6vjo0V6n6Tz7aawyNHT0VCmXDtnL06FQIBLbDnanpi1FjPGph83mmSOHnXz+xs+5nOX3b5vrW7rcD3bf8U1ZK2MI40tPnhx56jj911+1clE7PXmmdM37ZL1vGuraVMSyfOnIE8c58Hw8h2N2GmzORAu/LKrjR082m80XxVNW3e9dkDMkbo6rX59snnh1So7b6fVgd6baV4rGj47eQnLG//k632xoT84qlWSwu3yXb3b0kZyJR2P+LyB9s6T3ipFI8TPfLOqDLzYs8/359VZv9T8UG5sEW/KUGwAAAABJRU5ErkJggg=="),_export("NotificationIcon","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHIAAAByCAYAAACP3YV9AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAACXBIWXMAAGKUAABilAEuxU9tAAABWWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS40LjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgpMwidZAAAJaklEQVR4Ae2dC3BU1RnH/zf7yG42j82LTUICG7MJSoC8CEEBIQGKAxKBinVoLHbs+CIYBcpTEGthinaGOqNSgU4dFAWjnWJ1aqkKYpFhyqtTa5zhFQQCGEHzMMSEJP3OOrsT1g17N9m7e++558zs3Ne5557z/e53vnO+c+5Z6bPS8T0QQfMSMHZcuKj5QogCAEahjny8BlF8FEOUQmgkJ++AAClAciIBToohbCQnIEXVKkByIgFOiiE0khOQwkZyAlJopADJiQQ4KYbQSE5AChvJCUihkQIkJxLgpBhCIzkBKWwkJyCFRgqQnEiAk2IIjeQEpLCRnIAUGilAciIBToohNJITkMJGcgJSaKQAyYkEOCmG0EhOQAob2QukZDD0OtLWrtDIXrx6uroQZbEgymxyb6NTktHy+Re9Yqh3V4D0YdPV3g72Q3ML4vKH4+Z75+LS33fjyoGDPjHVdSi9l+kSn0gGYDJiw29hLynCgcq56GprCxA7MpeFjZQh98+WPYmYrCyU1b4mI3ZkooiqVYbc3Y0gSUJsXh7UWn0JkAFAGuPjMPaNbTBYotF+8ZIAGUBeqrqcNKYUGZUzkDSmBLGuHEQZjejp7saxJcvVC1JVElQwM9GDUmFzOmHNzIAlIx1WxyCYU1IQnZwEU0I8jHFxMNpiaD8BUtT1TQemiYcfrcE3h44omMOBJa3pqpW1JONzXYhhcNLTwWCZkxJhJhiGWBuM1hh3n7A/Hf2u9u/R+Ml+1P3uObQePzkwKYfhbk2BtKSnIfuX9yFtcjls2U53lddfGbHOf3dHp7vPeI26FEzrmqnzf+XQYXy171/ouHylv0lH5D7VgzTExKD4D88iddytMFH1Fyj09PT8AKf1O3R+8y3aGxvRdr4BbWfOouX4CTTV1bn3A6WjtetGNWd42OMLkbfwYUSZTAGzebXhAs698y6Ov/BHdJJXRm9BtRqZv2opch/6lSweh6oXuSHKisxpJFWCzJg5XTZEZusaPvhItd2CcL03UcxTobZfzv1VssvPWqTTD++HvbBAdeUIp1yv7zDJFp+yEU9v3xnUA4w2G8rfqcWMIwdQTA5uW1ZmUPfzEFmqVenoR2blnSjduEFWQ8cfiI6mZrScOImv9n+KL9/ehdbT9f6icXNOelOlIJmELQ4HJr75KuKynexwQKG7s9PdDbl89Bga/vEh/f4JZl95CdJOFYP0CNmefwuKfrMaySXFP3KfeeIEu2X9zc5vm9BEfUvmAKh/+69u0MGmo5b4mgDpEZaR3G4Fq1dgyKxKcr9ZPKdDtr12tR0tJ0/h0t59OLWzFt+RE0ErQdqhAY30J0zXL+bhlupHYE1z+LscknNusGRbGdiTOwhs/ZmQpKtEItIbGgXpEUZyUQGK1j6JpMJRkGjwV8nAHOktp0/jIlXFp3a85dZeJZ8XTNrS6xoH6SmsKTERo59Zg8w7psJgNntOK7rt+r4DLfX1aPhwL77YtAUdTU2KPu9GiXMD0ltI0sqRTyxE7v33wWxP8J5Weoc1ntrI33tm17uoe+nlsPt7pe2caKQ/UK6qe1FEjSOj1ervsmLn3FBpxIVB/XzT5rBAlV7jGCQjxVx4Y8jbc9Pds0PWdQnmDWBQm2lg+ui6DWjY83EwtwYVV3qVc5AeaVho9sDELS8hhRpHkQrtly+jbvOfSEu3hjwLugHpkdyIxx5FwZLHPYcR2bLW75m/vYdDT68LWbUrbdOJRvYmlnPPTzH2ufWKd1d6P9PfPpuZd/6DPdi3oAbd1AIeSDDMik9aO5AEtHjvlf/V4ev//BdOGvf0nTEXzvKwfm98zk0YTgPo1662ofHIsX4/XnpFhxrpkZajrBTTard7DiO+baWW7u57qtB69lzQeVHleGTQpejnDZcO/hvnPtrbz7tDf1vs4AzM+ng3nDSEF2yQ/qxjjWTCMtIsvXl1RyNuL33Bnaj9C/YvXu57us9jVU71COcUiU6a03q18es+BRSpC665c1C+dZPs6Su6B8lemmZyhKsxDPnJZJQ+tUoWTF3bSA+8nm6GU50h/4H5YL9AQZXTIQNlOtTXTTRgreZQumYlms9fwJfv7+4zm6JqJdHYXa4+BaSGC6y/WbHpeaTcYMqn7kE66FtIJaaNhPoFiCLn/wzq8zKfMTMEvj/d28gpW14MtcwVS88QbcaUzf7zq2uNvH3js7Ak2hUTvBIJO4oLkUojOD/SSN8TejlOJXuTO+cuJWSteJoVL2wUINmLCrI30155WXXeHLlvQBx9EpFLA+W9lU53NtJCk7SqDu6DNSlJrtxUGe82mjnYO+jKRtrzcjHvwB7EUMtP6yGalo0pW/lrr1bqBmRW+STMfX8XTOQk5yXkz6/SF8iR5OKaTjaRrZfDUzDR7MDMCbe5YfJVMh9KzB7O2LYFjoJRPlf4OSx65EGc/eRTcOtrLV7wEMoW13Cnhb6vYNrokh800t0c972q4WN7thMzt21FwtAhGi6F/KwbaY08Jw13cVW1Tlr/NPLn/SyiE6rkIwhdzKIHH+Cjah1Jn9jdunQxWJNcj8FBX6Jp2kYOm12J259aqfnO/UBfPvb1mSZBOqlPOHnDM4hV8CPXgQo33PdrCuRgGjuc+vv1sDuHhltOqn+eJho7zvKJmLhmBRJpVrYI/iWgao0soEZMWU01bKkp/nMvznoloDqQbCXICSuWYBR1I3jyi3olrtCOakBayZ02ed1auKZNgUHGsp4KyUOzyUbcRqbRSP2k1cuRMZoWQ1J4VQ7NUpKR8choJAEbS2vkFM7/OWI5GBuUIWfFo4QVZGK2ExXUgR86YZyoPkOMNiwgC2l1jTIabknQ4fKbIebVZ3KK2UgbVZkVtDRK7rSpYB56EZSVQMg1ctj0OzB+0WNIzs0RjRdl2V2XekhAmukjmPIVSzF89kxEx8Ze9wBxEB4JDAhkVlkpKlYtQ/qoEbobAwwPHvlPCdpGMs/L+JoFKKIGTIzG54bKF5P6Y8rWyMH0P1TlyxYjs7QE7MsgEdQlgRuCZLZv0pJFGEG2z6qxj13UJWblc+MX5HBaSGhc9cMYdPMw0fJUnkFInuC1kQm0xkvFyqXIm1IONvFVBG1JwDjhiWoU3D0HduF10RY5n9xK3d0qXtLCJ7PisG8J6O6zur5Foe0rAqS2+XlzL0B6RaHtHQFS2/y8uRcgvaLQ9o4AqW1+3twLkF5RaHtHgNQ2P2/u/w9BFUX/lz/CkQAAAABJRU5ErkJggg=="),_export("NotificationIcon","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHIAAAByCAYAAACP3YV9AAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAACXBIWXMAAGKUAABilAEuxU9tAAABWWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS40LjAiPgogICA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogICAgICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIgogICAgICAgICAgICB4bWxuczp0aWZmPSJodHRwOi8vbnMuYWRvYmUuY29tL3RpZmYvMS4wLyI+CiAgICAgICAgIDx0aWZmOk9yaWVudGF0aW9uPjE8L3RpZmY6T3JpZW50YXRpb24+CiAgICAgIDwvcmRmOkRlc2NyaXB0aW9uPgogICA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgpMwidZAAAJaklEQVR4Ae2dC3BU1RnH/zf7yG42j82LTUICG7MJSoC8CEEBIQGKAxKBinVoLHbs+CIYBcpTEGthinaGOqNSgU4dFAWjnWJ1aqkKYpFhyqtTa5zhFQQCGEHzMMSEJP3OOrsT1g17N9m7e++558zs3Ne5557z/e53vnO+c+5Z6bPS8T0QQfMSMHZcuKj5QogCAEahjny8BlF8FEOUQmgkJ++AAClAciIBToohbCQnIEXVKkByIgFOiiE0khOQwkZyAlJopADJiQQ4KYbQSE5AChvJCUihkQIkJxLgpBhCIzkBKWwkJyCFRgqQnEiAk2IIjeQEpLCRnIAUGilAciIBToohNJITkMJGcgJSaKQAyYkEOCmG0EhOQAob2QukZDD0OtLWrtDIXrx6uroQZbEgymxyb6NTktHy+Re9Yqh3V4D0YdPV3g72Q3ML4vKH4+Z75+LS33fjyoGDPjHVdSi9l+kSn0gGYDJiw29hLynCgcq56GprCxA7MpeFjZQh98+WPYmYrCyU1b4mI3ZkooiqVYbc3Y0gSUJsXh7UWn0JkAFAGuPjMPaNbTBYotF+8ZIAGUBeqrqcNKYUGZUzkDSmBLGuHEQZjejp7saxJcvVC1JVElQwM9GDUmFzOmHNzIAlIx1WxyCYU1IQnZwEU0I8jHFxMNpiaD8BUtT1TQemiYcfrcE3h44omMOBJa3pqpW1JONzXYhhcNLTwWCZkxJhJhiGWBuM1hh3n7A/Hf2u9u/R+Ml+1P3uObQePzkwKYfhbk2BtKSnIfuX9yFtcjls2U53lddfGbHOf3dHp7vPeI26FEzrmqnzf+XQYXy171/ouHylv0lH5D7VgzTExKD4D88iddytMFH1Fyj09PT8AKf1O3R+8y3aGxvRdr4BbWfOouX4CTTV1bn3A6WjtetGNWd42OMLkbfwYUSZTAGzebXhAs698y6Ov/BHdJJXRm9BtRqZv2opch/6lSweh6oXuSHKisxpJFWCzJg5XTZEZusaPvhItd2CcL03UcxTobZfzv1VssvPWqTTD++HvbBAdeUIp1yv7zDJFp+yEU9v3xnUA4w2G8rfqcWMIwdQTA5uW1ZmUPfzEFmqVenoR2blnSjduEFWQ8cfiI6mZrScOImv9n+KL9/ehdbT9f6icXNOelOlIJmELQ4HJr75KuKynexwQKG7s9PdDbl89Bga/vEh/f4JZl95CdJOFYP0CNmefwuKfrMaySXFP3KfeeIEu2X9zc5vm9BEfUvmAKh/+69u0MGmo5b4mgDpEZaR3G4Fq1dgyKxKcr9ZPKdDtr12tR0tJ0/h0t59OLWzFt+RE0ErQdqhAY30J0zXL+bhlupHYE1z+LscknNusGRbGdiTOwhs/ZmQpKtEItIbGgXpEUZyUQGK1j6JpMJRkGjwV8nAHOktp0/jIlXFp3a85dZeJZ8XTNrS6xoH6SmsKTERo59Zg8w7psJgNntOK7rt+r4DLfX1aPhwL77YtAUdTU2KPu9GiXMD0ltI0sqRTyxE7v33wWxP8J5Weoc1ntrI33tm17uoe+nlsPt7pe2caKQ/UK6qe1FEjSOj1ervsmLn3FBpxIVB/XzT5rBAlV7jGCQjxVx4Y8jbc9Pds0PWdQnmDWBQm2lg+ui6DWjY83EwtwYVV3qVc5AeaVho9sDELS8hhRpHkQrtly+jbvOfSEu3hjwLugHpkdyIxx5FwZLHPYcR2bLW75m/vYdDT68LWbUrbdOJRvYmlnPPTzH2ufWKd1d6P9PfPpuZd/6DPdi3oAbd1AIeSDDMik9aO5AEtHjvlf/V4ev//BdOGvf0nTEXzvKwfm98zk0YTgPo1662ofHIsX4/XnpFhxrpkZajrBTTard7DiO+baWW7u57qtB69lzQeVHleGTQpejnDZcO/hvnPtrbz7tDf1vs4AzM+ng3nDSEF2yQ/qxjjWTCMtIsvXl1RyNuL33Bnaj9C/YvXu57us9jVU71COcUiU6a03q18es+BRSpC665c1C+dZPs6Su6B8lemmZyhKsxDPnJZJQ+tUoWTF3bSA+8nm6GU50h/4H5YL9AQZXTIQNlOtTXTTRgreZQumYlms9fwJfv7+4zm6JqJdHYXa4+BaSGC6y/WbHpeaTcYMqn7kE66FtIJaaNhPoFiCLn/wzq8zKfMTMEvj/d28gpW14MtcwVS88QbcaUzf7zq2uNvH3js7Ak2hUTvBIJO4oLkUojOD/SSN8TejlOJXuTO+cuJWSteJoVL2wUINmLCrI30155WXXeHLlvQBx9EpFLA+W9lU53NtJCk7SqDu6DNSlJrtxUGe82mjnYO+jKRtrzcjHvwB7EUMtP6yGalo0pW/lrr1bqBmRW+STMfX8XTOQk5yXkz6/SF8iR5OKaTjaRrZfDUzDR7MDMCbe5YfJVMh9KzB7O2LYFjoJRPlf4OSx65EGc/eRTcOtrLV7wEMoW13Cnhb6vYNrokh800t0c972q4WN7thMzt21FwtAhGi6F/KwbaY08Jw13cVW1Tlr/NPLn/SyiE6rkIwhdzKIHH+Cjah1Jn9jdunQxWJNcj8FBX6Jp2kYOm12J259aqfnO/UBfPvb1mSZBOqlPOHnDM4hV8CPXgQo33PdrCuRgGjuc+vv1sDuHhltOqn+eJho7zvKJmLhmBRJpVrYI/iWgao0soEZMWU01bKkp/nMvznoloDqQbCXICSuWYBR1I3jyi3olrtCOakBayZ02ed1auKZNgUHGsp4KyUOzyUbcRqbRSP2k1cuRMZoWQ1J4VQ7NUpKR8choJAEbS2vkFM7/OWI5GBuUIWfFo4QVZGK2ExXUgR86YZyoPkOMNiwgC2l1jTIabknQ4fKbIebVZ3KK2UgbVZkVtDRK7rSpYB56EZSVQMg1ctj0OzB+0WNIzs0RjRdl2V2XekhAmukjmPIVSzF89kxEx8Ze9wBxEB4JDAhkVlkpKlYtQ/qoEbobAwwPHvlPCdpGMs/L+JoFKKIGTIzG54bKF5P6Y8rWyMH0P1TlyxYjs7QE7MsgEdQlgRuCZLZv0pJFGEG2z6qxj13UJWblc+MX5HBaSGhc9cMYdPMw0fJUnkFInuC1kQm0xkvFyqXIm1IONvFVBG1JwDjhiWoU3D0HduF10RY5n9xK3d0qXtLCJ7PisG8J6O6zur5Foe0rAqS2+XlzL0B6RaHtHQFS2/y8uRcgvaLQ9o4AqW1+3twLkF5RaHtHgNQ2P2/u/w9BFUX/lz/CkQAAAABJRU5ErkJggg=="),_export("HabReminderImage","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQQAAAEhCAYAAACZad6PAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wIbCiwbHx9n5gAAIABJREFUeNrtnXm8HVWV7783ubkZCZlIIEAICSBIZBIQRQLY0ShKN40IDTQo+gR8tgMaBfQB3dqoTTPIUxG1bRFBhofNIIMYCLMEQpghEBEMUxISIOMNN3d6f6x9vJWTOudU1ak6p86u3/fz2Z871albtWrvVWuvvfZabQhfGQmMA7YEJgBbALOB6cA2wHDgr8AbwALgNeB59/ObQK9EKERrMxY4GrgUuA/YAPTHbEuAK4GDJE4hWpNZwHKg273Z+1No3cAKZ2EIIXLObsCZwKqUFEBY6wOWAv8ucQuRT6YA1wJvZ6gIgq0XWAecKtELkR/GAT9rkBKo1M7SYxCiuXQAXwfWN1kZlNr5wCg9FiEaz0HAajeX789RWw3srMcjROOsgotypgTC2hx3rUKIjJgG3NsCyqDUrtMjEyIb9nHmeH+Ltfl6dEKky+wWVATB9hgWKSmEqJOjga4WVwj9wCt6lELUxwwPFEGwPaxHKkQy3uWJZVDeLtGjFSI+D3ioDErtGD1eIaLzNY+VQakdqscsRG3eh20vzvNgXuK+XoUlTUlyjpeAMXrcQlRnaQ4GfB/QycCOxn5sK3UntolqGDA+cM1zgI0ki2YULUKbRNBwTnYDLmu6gVuARVhKtH2xZCeLsI1Sa7CIyB+6Y9uBk7BUawtDzjcBuBg4LsG1jHSKRggRYKwbkFm//fcDJrPpPoN2YGjINQ1zA3YEMKjKtY9z1/+ofAlCpMPMDJXAWuBDGV//UOB04i+V9ujRC9E438HvgQMbdA+TgQcT+CvkSxAiwJlkl+LssAbfy3ZYRGKc63wa7XUQ4m+m9tMZKYSPNuF+hmEJUtbFvNbPqCsIAZ/PSBkcDQxuwv3sgmVzujPm9b6uriCKziAsuCdtZbCyiSb4WGx58g3MYRjnut+jLiGKzoaUlcEG8rGU9wcsniHOtT+i7pDvt5fIlqPcnDtNXgLuysG9PYNFL8ZhOrCHuoUUQlG5OoNzXp6D+xoN3I1lSorDFsCu6haiiHwgA9/BvTm5rynYSsPxCfwIZ6OweVkIBeSkDM6ZB4WwCjgA+DO2RyLuSseH1ffySbtEkBnj3Js0bVbm4N6eda0deBnbHDUkxuff65RIr7qJKAoHkH7FpWVY3YY8sQ/wItoWLQtBVGW/DObJt7rBlxc+5hRUkupNE9RFRJFYRvoOxeNydH8dwCRsY1WSxCnaASkKw05kE6qcx3Rk36vjfkTOkKc3G7LafZiXpboOYCKWYm18HYP7s+oqogj8PiMLoXyuPhq4DEvJ9gmaU6J9NvHjEErtJnUVUQRey0ghBC27g7HMRd1smsFoFQNZk5dhy4P/hSU2GV7nfQ3BnIF7YXsSVtZ5Py8A26i7CJ/ZIjAo02ylxKcHAT8CVjCw6/FNYDm1HZk3A3smvK8dgWsZSM+eRlsOTFWXET5zFMm87rXaucBZwJfdz48Dp7k5/NBAA7gDK7xa6VxTIt5LO7a0+N+kH1PR76ybD6rLCJ85l+wSqZ4OnEP1df+2gHl/BfBqiIK6h+q5FEpTi2+SfYbo76nLCF9pd4P2HbLZ1JQkIcqvGMhZsNy96fuAI6p8Zg5wH9GqS72G5Yt8MKEV8Zq6TX7QjrN0GQbcBhySwbknOr9BHEY4a2IGFkrdiaU/Gw78b8L3EozCUrpXosdNVz7gFEaJrYDfOR9HHHqItw9CZPxGE+kxiGzSmv21xiAd6gZ8yTcw3g329diOxAeB+yP+r2p7DHqxUu8Lge84y6DECuInSwFtcBIesyXxU4pFabcTHkQ2C/g1tsrQ6d62PYFpQY8bcKe446PkM7yCgVqPYfUV1gSmBm8ATzqz/3aSp4obpa4jfGSMeytnseQYzDkwCbjRDfjgIOx0g3md82UEB/YdRCvm0kntOhA9Kd5blxSC8JWxZOOJ/0nA37MTsNj9/n4sCUswKKkHeNsd+/HA316NeA8vVbiG1VicQw/mnOxK8f52UdfJz5xXpEdWTtr9nb9nGpbHcBrwhPt6bNmUZbDzG4DFEJQYQbRkr3eE/G4JVqnpcnf+iSTb8lyJqeo6+UBOxfyzFlgA/BS4wQ3yXiwkGcyxt9b5B1ZjCUv2YSDU+Q0sQ/OvseXQWoQVU5mChSyvyugeZwJ/1KOWQvBxypA2K7Elwkp83721x2HOvkOcOT/L/W4CFsNwW8T/92oFy2c48EmnaNK2hA5S1xE+clQG/oPFMQbgYHfsYDcdfAb4t5j38CnCVxc63d9/BvzAKZ2HSWffxpPqOrIQfGSrDM75ENHzDeznTP6Nzlo5hPjBTE+6zwd9BKVYgUXY1u7TsaCkVU7p1JtMdorri8qiJIXgFcMzOOfCGMcuYCBGYFnC//c88BSWGTnYT9qAedj+hm8CjzqlsdIpotnAUufL+DLxHNa9UgZSCD6yfwbn7Ik5sOpldIhVUdqZ+L+AC7BEr7c75fOv7m+lmo1fIP7q1Up1HeEjWcQgNFppT8XiGMK2KndihVmqsXuCe3xZXUf4xmSyzZLUKIZQPQS5FktJVtpe5AAFJqVHRwbnvLYJ9zGTygFMi2p8dg621Nkd839q163wji9lYB2c1IT76KDyfobrM5o2vYX8WbIQPONzGZxzfRPuYyMW3RjGETU+e3PC/9kmK0EKwSf2A3bI4LzNKtu2POHnlhAe+lyLEVhFaCGF4AXbkU1Vpc4m3c+ihJ+7FXOuJrEQhqkbSSH4wkcyOm+aqwzHA9tHNM27qiioJ6p8bmbCa+sG/qJuJHxhA9mkKd8zhWvbB9sp2Q98PcZn3iR8T8NaLBgpyBNYUtaXE97nalQNWnjCnu7tlkUMQtLSbIOxiMNdAufaAJwd+Hu1z95PtPiIXQM+h3oU4gp1o3ygpZ76mIgF1UzKaLrQnfCzO2N1E6dj6dT+G9gaOBWLRBzqzP9lWIakbbGkKmuxpc4oqdbWYtuq98SCmepZJVikriR84AvAu8muiMnuCa/rjMA5LnG/6wC+FjD9Hw98/zKWB6Gb7AuzhLVz1JWED5zMQGm1LNrHY17Ptm4uX/r870KswEFY5qVPYclNX3VTng1NUgb9wPvUlUSrMwwrwT6/zsGwFvhN4G0d/NucGNczBttHUDrHvBrHd2Dbtf/ipj3rmqgQpqg75QMtOyZnJJbUdEad51kMnICVRS+fh+8XUTFdhTnmtg6c44EK8/o2ZzX0ubl/F1bYZWQTZfm2upNodUYDh1N/jYLg0uIvCfe+V3L+nugGdnlhlTudsipnLPAhZ9n8I5b96Ekq70Bc7qYUy8jGMrjT+Tj0YhItzxhsfb+3jgFRHol4ZMgx/5fNlwnHOf/ASio7I4eGXHO78xt0uDYUW1HYHQu9vtYpi22xuIDx7n+NdxbMDOc3uRT4fyQransn5oydjqIThUdMdfP/et6Q5dubPxByzCvOGhnjBnQHtsy5sEyxLMGSn9Zr+id5W3/D+SwWYXUoO7GS85/Hwpl7sTTwQnjLNGfSJ1UG3Wwe8hyWtbkL+Ay2R6CUs/Ei4Dkswu8i4IMki/T7RNnPw7E4hPcH/A1TnUKK8jYf5qyJg7HNSp8GvgUcRzYp6oXIDdtTX2HXsLX3z1U5fjtn3o91A2xMgrf5rs7K2N793MtAtGGbm8/3AMcAW7jzD3bKZiqwt/u85vyeokjF+mSXNMvyTwivl1ApMnGle+NOwCo2/TbB/2zDCq2ALWf+uxvYi5yl87yb34dVaFrpWrtTguOxuAUhhGMKydbuq0XlhXn8b8EKvKahwErxDqvZtGDsoUR38P1Cj14Wggh/4w6OeGyPe+t+FbiywjFjsJoGazHv/VNujp/Gm3g8VkRmbywLU6dTBLWqLo9gYFl1XE7kXlo96VIXFHliuhsoUZYdT4xwvjOcD2FPzImXBnsCl2EFXK7EakTuH8MHcKGzUK7AsjeVljmPK1OMWTOsTEmNV/cTeWOnCIpgLtG962kNrCPdW/Qy4KPAjs7XEVUJ7O7Ogfv8UcAXQxTfUqyCU6OsMSFyzY6YE/DXIYpgOZZEpJEduQNLVHIqttQXdzp4ROD6Nzp/wxexaMY7sfiCP2GrD2DBS+cBP8IcnvuweV7JiQ2aPgjRdKa6uf4Xy5TBxRHm5mlzKFZi7RiSByb9NXAPvVgU5t4BxbIfFmhUydewo5NJkEkNuHf5wUQuGI8lFXkBc9Kd0eD/PxjbrzAf25eQlMkMVJjucfcT9mYfhS1NDs7RM/iW84vskrPrEgVkBOas+1mD/287VnT1QiwlWj3Zng9wlkEftjfh0ArH7YytSqymubsiwzgZq0R9sLqkaCYdwCkZm6yD3AAchUUpzsP2BpxI7WXAITXOe1XAItgr5PiS/+MwbIXhFGxJNE9si61AHEayYC0hWoqh2ErFzzHP/1YJzzMF2x2JO8+bWBBUranGWmw/wkecv+TQHMlmOpZp6WNOUZZWQb4N7IaFegshyngP5uj8uPt6CQObl8KmQbs7/8gRbBqJudrN2XfKyX29ReXl3l4sh8NvgYPUBYQY4HAss/JMajveTnPTiC4GUrHdUnbMOVj05Hxs+/a0JlgGLxEv7ft31A1EkZmAZVi+GktGEoWdsa3UpczLa6m+crLAHbcec+zt6nwdWTIGi7WIu39kGQM7PIUoDEe4N/cfgWOJtv9gNFa3YQmb52GoxunYLskpWCTkNpijNSumYcu8SbebH6PuIXxnCAO5HddgZdz3jfjZwVSuKRE12/PnGnSfg4D/ob7sVBeouwjf6HDTgT2wFYdrsWChBc4iKKda6PQ32Tzcer37/i8kLyOXJqXrT6v2xXR1IeETJ2L7CVZj0ZFPubn70CoK5DD3/Qg3LTjSvS3L6zReHjDJN1C78nSjciReRHpZnpcSno1aiJblq27gfjLi8ftg25VL1ZyfCQyQ1wLH/YHNKz33Y8t7VwP/BwtzftT5F/6rAfd6MumWl+sD/sMp0R1QuHMsk1LYzr6/w5x1k9yb+HHMafege1M3g4nOX1CLkVgk36UMJHBtw7ZGz3G//5SbIkxz9/VzrODLRMwz3+t+noCFOpcoFbnty+D+hjoFdUhG8nvbWVh3A//sZNKv7i6qsYMb8NXeOPe5gTYhR2+bNizT0jVsHqzTj8UjlLiw7O15bIQ39gYGsii9mtFL5QAaV0Zujbq6qMWRCTrWb92btJl8goGqzsH2KPAvIccHFV430ZbmRgFHO9P7p8DNWPhwWpmYx2OJXxtZW/I/ZS2LanPuVQk71qtEX/ZLk6OxvQnlFZzvCjl2AfAY4TUl1hIt3VuQ0W7qsD8Wi1Avn6U5BWc/q64vwjg7hc51H7ZHP+1AnUFYINBoN6XZ1c2FS/93A+YovMEpiTCilF97Dsu89C73/zoaJPvDsWxNzVAIdwOz1P1FOetT7GQ/TdEvgHOyrcaWCJ9h0zyHf6hxjh9gsQZx7+EtbMflrLJrycLK6W9y63PK9Gzys4lLNJHxKXewbuDGlK7ttgpvzxVlx93nvp4J3OTe9itTup8HMpL7cOCRHCgEhTuLTTgzo44135neSTgM29DzXcJ3+AX5upsSXJ3hIFnvzOtTsaQtw1OQ+y05VAZh8hUF4tg6nIlRd9zFcbq9F7geWzM/xg328nO+XPaZPjeN6GnQYFmPVYC6EUvZPizhtOLVHCuEEzQ0isUQLJKvEZ1rOZawpBZfxFKbvemUQqV1+RuwrEFx192zVBjfjSn/f86xMujHVm9EQWgDrmtCJzuuwvVsAXzPDZKzsMpLs92Uoy/EAVbuWKymBO7CqjedhaUc68zo3tZhcRxRE6dcn3OF8A5K4FoIRQCbxvU3snU7Z1953YIH3IB6xJnjpTqPlc4T5U2/EUudFsa6iAolyf2tcxbOm86pOY/NC8ru7qZE/TlvV6L6D14z2Q3IZne0VW7gdGM7EV8nXmqwqG1eBTl8q8H3Ox+LbRiGZXp+rAWUQT+WdVq7JD1lf8Kj9HxqQaXyH1Vk8WITrm01cIdzsm5sIZn+QkPHP/b2XBEENzJtdNONW6vI4+aCyCOt5n1q90EFUwjXF+Q+BwHPYtmJn61y3N+htfY4nCsR+MPxNG59vtntASxx6uM1ZKK3fnxn6c2yEPxgJ4qTIWcs8H1sSbUSZ7hj+mQlRKYdK3hTqvUwWiJpXb5TgDfYRqwo68Ux5PIEevPXs2riVYxCkSyE3gLcYxdWxfkrEY/vw6InRTLeh+3DOFgKofXYUIB7HIXVL4jC0VjAzSyyyYtYFEZiu0onSiG0Dm1YQIzvbATOj3hsqaZDG8VbbUqb0cBDeBDNWJSOMAv/U2SVIuq6gKkRP3MgFh7drTFdN1OdxdXSFMXrfj+2cch3K2gxloZsVQwlcjiWIm1QwMoo7xfdqIZBFHbHIjAXShT55XyK4fEulW3/QUz5/Arb4luqbLQ45Nwr3fRiHVpZqNW60HJkbplJtKSiPrS/xJTNP5T9fAUDJd7L90TMw6o9SyFEa0s09PJnPoNlIC5KJ1yagtxewTYf/cSZvRuwHZGl/RAPa7BHziS1s4Zhvri1YJ2wnrJyp4X87jnncAyyRIM9UtsAHKohmK+pgo8drYeBhCbLgd8Ffu5MWYYvu/OWljHHOC+6BnzttoJ0ks82HN+WHduwQJFLPVV0gwPPbC5WAXpQYMWgnLMS/p+R2FbfXgYKvK7C0tSL2gzFkvCIHCi42wr2NtqILQv2EV6/MQmldPRrsXj9LwGXYPUrZQFEa7fSuIpXosJb7caCdboznTOx9PO9IQM7CdOwpcZHgT8zkH24VwM9VrtWw7J5XFzADrc6xJkV5I465rKva0DnutqVqMAI4OfqeH9r/xqwDv4Ny2p8U0yZnuXOdT9wHoo/qLddgPaLNISxtE7m3ka2V1zrCvzuwpiyPTvwfSkp7U+Ap6mchHSeZF+x3avhmi1HqJPFXrL8UR3yvirwfSk0d3KIn0Kyrtz+6FYgRMocpc6VuF2KxRRkRZ9kXNMRDPHrX4oKfEWdKrR1lq0KVGsrgcszeDaX6TlEat/WMK6fycA9bF6IRM02cM0sm/fX2tT1CLZdN01uxv8iOGntiDxSQzo527q3mjpTuG/gwRCZnUvlYqylr2lzNa1VjanZAWU/1tCOz87qPDWrNJ0CXAN8LSC3Nixq8wznTCyv9Xgp6W/AWaXnEbvNzdinE4u854AbSvSkoUVlJRaQtBjL/nsvFlS0ApjjzPhXAsdfg4U6n5rBtSgVW3xmOd/LUc7aayp59XS2MbBM82H1mZqswQKQjgL2wEq0HR/4+w3u61IsunEZ8MOUr2E9FhUp73kyHnZ+hdckinCukjkZe5XhCuAbEeWb9vZcPYN00uCN0dDfnPPUORK1G2LIeGSKz+seyT619hAwWypggBnqFInbKmclNJLLJPdMNq29Vz4E25uwAqX8rpdRbk7fCFYAEyTy1HnL+c8ebeQ/zdMOrHYsJbiUQf282qD/87aUQWaMw7avf6SoAvgAtuwikzGddmPGz2uOZNyw9t2iKYNJbJ7sQ63+9laGz2yt5NuQVgrTP78RAzEv5vmtwC6yElNnOLAXFoyUJnfpeTXcz3cAtrT8J99v+BAU/96IlhZzJcumV4XKLKNzs52KQ4Bz3FeRLf3A3nWe41+AD0qUTWWKU8oTfVQIM52FIBrDPXV+/uPAMImx6bwbS4vvlQ9hBnC7OlhDGYolYd3SyT6u32CWRJgrpTAUW2J+s9VvZj/gBc0Hm9pejvG8zpC8ctvuLHM+puLBbBTDsTLkV0nB54JOou1p2CBLLte8hTkau1rJh7AHltlHyiA/jMC81tXSeV0jZZB7xgHPkoLDt1EWwmQsSYeKVeSXXwAnl/1uKvCSRNMyrGUgRX5uLYSJWCZgKYN883ng+sDPp0kZtBxbYJvNZuTRQihlPfoBcLqeVcswH1vrVjnz1mUlsCsJVh+yXnZ8EfiEnk9LsZ1704jWZQSWiu2hvCiEHYCFWFlxIUTj+Zgb33c1WyEMxpZBxumZCNFUDsayaEW2FNL2IWztTJU2lH1XiLxwQFSlkOagnQQ8SUabLoQQiVlNxGzOaS0Fbovl+pcyECJ/bIkV8NmqET6ErbFEkKMkdyFyyw5YXMkjWU8ZFmFrnkKI/NNBlZJ79VgI22M1BBXAIkTrsBVWISo1C6EN2+zyJLCT5CtES7EGCwnoTdNCuB5byhBCtN6U4S0qLEMmsRBOBn4muQrR0uyLRRPXpRAOwJYvlBRViNZmCba9fRPixCEMxwqJShkI0frsQEiNhzgK4WpguuQohDdMcYohtkI4Ffh7yU8Ir9gWOCiuQtgb+L5kJ4SXbJJdKYpT8XYKXJJaiAIwAsusXdNCGCNlIERxrIRaCuE3kpUQ3jMhqkKYIVkJ4T1HlL6p5kPYE1unHCF5CeE9bQDtFf44CDhbykB4xo9dx/8USuYTZEmtA/ZGRTTV/GulN+Eg4NtY/QLJJeArDPMhDMUyIAnhE99wX/uBPuBcLNvXVcANwIICy+bPpW/aK5hVQvjG3JDf9QDHBcbBNZiDrWhlB6dVshB2B/7R05vupUJSCOE9L2I1DyvR49ongQuBdUX1IZQrhH8Axnt6078Bfq2xUUjewAqWRJ1aTAW+g9UYKQLXVfrDX/HTadIFHOgetJxIxWu3Jxwog4CXCyCfH1ayEHbwVAPeCDzgFN6ZemEWjtUJP9cHfAZ43nP5PB2mELbz+IZPCnx/PnKcFo236/jsPGdd/tlj+TwephB8TZp6PLC+zIH0pTreGqL1WFbn598EdvFYPovDFMIpHt7oCuDBKg9ZFIOnUzrPXkR3TrYSa8IUwkEe3mgnlZeQ+jVOCsNTKZ3nCeCXHsrnsNI3pc1N7cBarACLL/RhfpGlFf6+DhipsVII2lI+35PAezySz+XAp4MWQg8RNji0GKdUUQaQTqFbkX8uy+CcezCQVtAHS/P3YVOGZzzqBHcDv6pxzDsaK4XgkYzO+y1ngbZ5IKPfhSmE6zyaKlxC7TDljRorhaArw3O/BnzZAxmFWjlD8CPq6nWsfl0trkMRfEVo722Af+LCFpbPf1a7uW4POsBpER/klhoshWiTGvCGHewcjX0tJpuNwMHBGxkUYgK1MvcCF0U8dg1wsyxq72nE1LDXORovaDHZLKXGkuyjLf42iJsU9kBsuVVvUn9bo2uR/riFZHNUrZv5fQs/+Jsj+g7K539LNGi8bffTnOXlk1pANneEXXj5lOHijL2yWTI3gXnYDzwrq9pbnqM5cQKXYZXS88oyKiRCKlcIK3AlnVqMh50yS8I8jRuv/QfNUAj9wAnO4u7OmUxewKo+r42iEF7Alu1aiW5gVp2OSOEnT9G8SMI2rGL6COC3OZHHYiyCt6KSGhQyuHpa7KF/pZK2i8iTGjde0gssb+L/LymiHuCzWHrCZkXHvgjMxJzoVS3icoUwmNaK8V8DzK/zHBtyaNaJ+hlMfvKDdgE3AcOxXBxLG/Q/n3FTl+nAfVgdiqq0hwyOBVj25VbgJuCxFM7zDo1fnhLZk8d06j/G9g7MAXbGKkjtm+KLeAnwB+e/uCWNE+5JaywpdZPexpJWDj1VC299wD/lWFm1uRdyh2sfdi+4pNGONwO7YoWWEivCsEItT7SI9j85RYdR0QpzFIGuKCZyk30MQX/dXDYtJrMHltVrSyyu4Tbn79o2MMV9F5bB6a6sL3Z+zrV/2mu88/RG9a6tJvuNTYWZY306x9e8DvhFyudcr67gHe9QvVqTiKEQlmBhn3ljJXA4cE/K552qruAd3RSvJFtmCuEd4KvkK6vQa9g66t0ZnHuVuoKXfVsrRykpBICFBHKtNZl5WN2IxRmd/2F1Be9YS3MDk7zlfJrrHDqjAfe4B3LC+dbu09CNT3uEY+Zg9Q3OasIccCsaU2FpNRbqqkzM/vCiRJAtH8S8to1YLroCGN3Ae5vofBR6s/rTttKQzZ6tgavILrLs01jcdaPZTQPIuyYayGxsg0Y9D2wDttX6FuDEJt/P4xpA3rV9NEyz8SGEcTsWN30ccDRwSIx53UKnTG7DNmE0m/dj+zeEX7RJBM1TKtOxdFU9Tjv3YtlqSluLv4tt4Bjmjs/T3oFz9DbVlEFko0XbsQKq3djmkt4WkMF+KA5BfVvUNWWoRA+NWSZMk9fVDYQwtO3Xlhv/JDEIIYVQ4kgU5uobikOQQkjMcuB6icEr9pYIpBDq4QvAMRKDN2wnEUgh1IuKv/rDLhJBfLQ0syknAJdLDN687BSPIAuhLv5JIvAGKQNZCHWzAYumFK1NN/ErgQtZCJvwZSynvWh9HpIIpBDq5T2ymLxhgUQghVAPg4ExEoM33CURSCHUQx+tsRFLqF9LcA2gH/ilxOANkyQCKYR6mQs8IjF4wXSJQAohDeZo6uAFqukohZAK9wD/IzFoylBUtMy2KR1Ypiehvi0LoeDsjyWPFa3PUokgGe0SAQBjsVWGGRKFF3RLBLIQ6uHbUgZeoaS5UgiJGQV8XWLwiuckAimEpGjN2j9ekAikEJLytETgHWskAimEpPRiWZeFPzwmEUgh1MPtwN0SgzeoVqcUQl10Aoeh5SpfeFMikEKol+mShzdslAikEOrlVCxRimh9zpMIpBDqYUvg/RKDNxyMfEJSCHUwGthNYvAKVW6SQkhMD9rl6KNC+KjEIIWQhGkoyapvDAV2kBikEOIwHjgfuB9V+vGRvVBehFgUdftzm1MAVwKzA78TfjE68KyFLISK9GNLU7PVBbxmjZSBFEIUzgC+oc7iPc/rGUshRPEbnKBpQiFYIRFIIdRiBJYURfhNJ/CKxCCFUIt2VOW5CKxGmZOkECKwCliuR+89G4F1EoMUQi260DbnIrANMFNikEKoxbFYwIrwmw7gQ8hxHIuiCWsG8JQee6EYBayXGGQhlLM1ME+PvHDsIhFIIZQzBPghsJUeeeHQpjVNGTZjKvCSHnch2RL+KJkDAAABLElEQVSlZZeFUMY39agLS4dEIAuhnHdQMFIR6cKcij0ShSyEEh+TMigsnRKBFEI5B+gxF5Z2iUAKoZxhesyFZQtsuVlIIfwNzR+LzZ0SQXR8L0wyBbgYW3oSxWQ85licK1EU20LYGbgX2F6PufB8FAUoRcLXZccJwDPARD1i4dgXWCgxFNNCOE/KQJRxoURQTIWwFfARPVpRxniJoJgK4d3Atnq0oowdJYJiKoQL9FhFCCOAAyWG6vjoVNS+BVGJ54FdJYbiWAjjpAxEFbZBkYuFUgiT9UhFFfqxHZCiIApB5e1FLYXwjsRQnAGk6YKo1d+HSwzFUQi76ZGKGv39LYmhOArh7/VIRRV+IxFUx7dlxz8B79djFRUYi5XyEwWxECbpkYoKXC5lUJv/D+kkr2q1ABx+AAAAAElFTkSuQmCC"),_export("HabReminderImage","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQQAAAEhCAYAAACZad6PAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4wIbCiwbHx9n5gAAIABJREFUeNrtnXm8HVWV7783ubkZCZlIIEAICSBIZBIQRQLY0ShKN40IDTQo+gR8tgMaBfQB3dqoTTPIUxG1bRFBhofNIIMYCLMEQpghEBEMUxISIOMNN3d6f6x9vJWTOudU1ak6p86u3/fz2Z871albtWrvVWuvvfZabQhfGQmMA7YEJgBbALOB6cA2wHDgr8AbwALgNeB59/ObQK9EKERrMxY4GrgUuA/YAPTHbEuAK4GDJE4hWpNZwHKg273Z+1No3cAKZ2EIIXLObsCZwKqUFEBY6wOWAv8ucQuRT6YA1wJvZ6gIgq0XWAecKtELkR/GAT9rkBKo1M7SYxCiuXQAXwfWN1kZlNr5wCg9FiEaz0HAajeX789RWw3srMcjROOsgotypgTC2hx3rUKIjJgG3NsCyqDUrtMjEyIb9nHmeH+Ltfl6dEKky+wWVATB9hgWKSmEqJOjga4WVwj9wCt6lELUxwwPFEGwPaxHKkQy3uWJZVDeLtGjFSI+D3ioDErtGD1eIaLzNY+VQakdqscsRG3eh20vzvNgXuK+XoUlTUlyjpeAMXrcQlRnaQ4GfB/QycCOxn5sK3UntolqGDA+cM1zgI0ki2YULUKbRNBwTnYDLmu6gVuARVhKtH2xZCeLsI1Sa7CIyB+6Y9uBk7BUawtDzjcBuBg4LsG1jHSKRggRYKwbkFm//fcDJrPpPoN2YGjINQ1zA3YEMKjKtY9z1/+ofAlCpMPMDJXAWuBDGV//UOB04i+V9ujRC9E438HvgQMbdA+TgQcT+CvkSxAiwJlkl+LssAbfy3ZYRGKc63wa7XUQ4m+m9tMZKYSPNuF+hmEJUtbFvNbPqCsIAZ/PSBkcDQxuwv3sgmVzujPm9b6uriCKziAsuCdtZbCyiSb4WGx58g3MYRjnut+jLiGKzoaUlcEG8rGU9wcsniHOtT+i7pDvt5fIlqPcnDtNXgLuysG9PYNFL8ZhOrCHuoUUQlG5OoNzXp6D+xoN3I1lSorDFsCu6haiiHwgA9/BvTm5rynYSsPxCfwIZ6OweVkIBeSkDM6ZB4WwCjgA+DO2RyLuSseH1ffySbtEkBnj3Js0bVbm4N6eda0deBnbHDUkxuff65RIr7qJKAoHkH7FpWVY3YY8sQ/wItoWLQtBVGW/DObJt7rBlxc+5hRUkupNE9RFRJFYRvoOxeNydH8dwCRsY1WSxCnaASkKw05kE6qcx3Rk36vjfkTOkKc3G7LafZiXpboOYCKWYm18HYP7s+oqogj8PiMLoXyuPhq4DEvJ9gmaU6J9NvHjEErtJnUVUQRey0ghBC27g7HMRd1smsFoFQNZk5dhy4P/hSU2GV7nfQ3BnIF7YXsSVtZ5Py8A26i7CJ/ZIjAo02ylxKcHAT8CVjCw6/FNYDm1HZk3A3smvK8dgWsZSM+eRlsOTFWXET5zFMm87rXaucBZwJfdz48Dp7k5/NBAA7gDK7xa6VxTIt5LO7a0+N+kH1PR76ybD6rLCJ85l+wSqZ4OnEP1df+2gHl/BfBqiIK6h+q5FEpTi2+SfYbo76nLCF9pd4P2HbLZ1JQkIcqvGMhZsNy96fuAI6p8Zg5wH9GqS72G5Yt8MKEV8Zq6TX7QjrN0GQbcBhySwbknOr9BHEY4a2IGFkrdiaU/Gw78b8L3EozCUrpXosdNVz7gFEaJrYDfOR9HHHqItw9CZPxGE+kxiGzSmv21xiAd6gZ8yTcw3g329diOxAeB+yP+r2p7DHqxUu8Lge84y6DECuInSwFtcBIesyXxU4pFabcTHkQ2C/g1tsrQ6d62PYFpQY8bcKe446PkM7yCgVqPYfUV1gSmBm8ATzqz/3aSp4obpa4jfGSMeytnseQYzDkwCbjRDfjgIOx0g3md82UEB/YdRCvm0kntOhA9Kd5blxSC8JWxZOOJ/0nA37MTsNj9/n4sCUswKKkHeNsd+/HA316NeA8vVbiG1VicQw/mnOxK8f52UdfJz5xXpEdWTtr9nb9nGpbHcBrwhPt6bNmUZbDzG4DFEJQYQbRkr3eE/G4JVqnpcnf+iSTb8lyJqeo6+UBOxfyzFlgA/BS4wQ3yXiwkGcyxt9b5B1ZjCUv2YSDU+Q0sQ/OvseXQWoQVU5mChSyvyugeZwJ/1KOWQvBxypA2K7Elwkp83721x2HOvkOcOT/L/W4CFsNwW8T/92oFy2c48EmnaNK2hA5S1xE+clQG/oPFMQbgYHfsYDcdfAb4t5j38CnCVxc63d9/BvzAKZ2HSWffxpPqOrIQfGSrDM75ENHzDeznTP6Nzlo5hPjBTE+6zwd9BKVYgUXY1u7TsaCkVU7p1JtMdorri8qiJIXgFcMzOOfCGMcuYCBGYFnC//c88BSWGTnYT9qAedj+hm8CjzqlsdIpotnAUufL+DLxHNa9UgZSCD6yfwbn7Ik5sOpldIhVUdqZ+L+AC7BEr7c75fOv7m+lmo1fIP7q1Up1HeEjWcQgNFppT8XiGMK2KndihVmqsXuCe3xZXUf4xmSyzZLUKIZQPQS5FktJVtpe5AAFJqVHRwbnvLYJ9zGTygFMi2p8dg621Nkd839q163wji9lYB2c1IT76KDyfobrM5o2vYX8WbIQPONzGZxzfRPuYyMW3RjGETU+e3PC/9kmK0EKwSf2A3bI4LzNKtu2POHnlhAe+lyLEVhFaCGF4AXbkU1Vpc4m3c+ihJ+7FXOuJrEQhqkbSSH4wkcyOm+aqwzHA9tHNM27qiioJ6p8bmbCa+sG/qJuJHxhA9mkKd8zhWvbB9sp2Q98PcZn3iR8T8NaLBgpyBNYUtaXE97nalQNWnjCnu7tlkUMQtLSbIOxiMNdAufaAJwd+Hu1z95PtPiIXQM+h3oU4gp1o3ygpZ76mIgF1UzKaLrQnfCzO2N1E6dj6dT+G9gaOBWLRBzqzP9lWIakbbGkKmuxpc4oqdbWYtuq98SCmepZJVikriR84AvAu8muiMnuCa/rjMA5LnG/6wC+FjD9Hw98/zKWB6Gb7AuzhLVz1JWED5zMQGm1LNrHY17Ptm4uX/r870KswEFY5qVPYclNX3VTng1NUgb9wPvUlUSrMwwrwT6/zsGwFvhN4G0d/NucGNczBttHUDrHvBrHd2Dbtf/ipj3rmqgQpqg75QMtOyZnJJbUdEad51kMnICVRS+fh+8XUTFdhTnmtg6c44EK8/o2ZzX0ubl/F1bYZWQTZfm2upNodUYDh1N/jYLg0uIvCfe+V3L+nugGdnlhlTudsipnLPAhZ9n8I5b96Ekq70Bc7qYUy8jGMrjT+Tj0YhItzxhsfb+3jgFRHol4ZMgx/5fNlwnHOf/ASio7I4eGXHO78xt0uDYUW1HYHQu9vtYpi22xuIDx7n+NdxbMDOc3uRT4fyQransn5oydjqIThUdMdfP/et6Q5dubPxByzCvOGhnjBnQHtsy5sEyxLMGSn9Zr+id5W3/D+SwWYXUoO7GS85/Hwpl7sTTwQnjLNGfSJ1UG3Wwe8hyWtbkL+Ay2R6CUs/Ei4Dkswu8i4IMki/T7RNnPw7E4hPcH/A1TnUKK8jYf5qyJg7HNSp8GvgUcRzYp6oXIDdtTX2HXsLX3z1U5fjtn3o91A2xMgrf5rs7K2N793MtAtGGbm8/3AMcAW7jzD3bKZiqwt/u85vyeokjF+mSXNMvyTwivl1ApMnGle+NOwCo2/TbB/2zDCq2ALWf+uxvYi5yl87yb34dVaFrpWrtTguOxuAUhhGMKydbuq0XlhXn8b8EKvKahwErxDqvZtGDsoUR38P1Cj14Wggh/4w6OeGyPe+t+FbiywjFjsJoGazHv/VNujp/Gm3g8VkRmbywLU6dTBLWqLo9gYFl1XE7kXlo96VIXFHliuhsoUZYdT4xwvjOcD2FPzImXBnsCl2EFXK7EakTuH8MHcKGzUK7AsjeVljmPK1OMWTOsTEmNV/cTeWOnCIpgLtG962kNrCPdW/Qy4KPAjs7XEVUJ7O7Ogfv8UcAXQxTfUqyCU6OsMSFyzY6YE/DXIYpgOZZEpJEduQNLVHIqttQXdzp4ROD6Nzp/wxexaMY7sfiCP2GrD2DBS+cBP8IcnvuweV7JiQ2aPgjRdKa6uf4Xy5TBxRHm5mlzKFZi7RiSByb9NXAPvVgU5t4BxbIfFmhUydewo5NJkEkNuHf5wUQuGI8lFXkBc9Kd0eD/PxjbrzAf25eQlMkMVJjucfcT9mYfhS1NDs7RM/iW84vskrPrEgVkBOas+1mD/287VnT1QiwlWj3Zng9wlkEftjfh0ArH7YytSqymubsiwzgZq0R9sLqkaCYdwCkZm6yD3AAchUUpzsP2BpxI7WXAITXOe1XAItgr5PiS/+MwbIXhFGxJNE9si61AHEayYC0hWoqh2ErFzzHP/1YJzzMF2x2JO8+bWBBUranGWmw/wkecv+TQHMlmOpZp6WNOUZZWQb4N7IaFegshyngP5uj8uPt6CQObl8KmQbs7/8gRbBqJudrN2XfKyX29ReXl3l4sh8NvgYPUBYQY4HAss/JMajveTnPTiC4GUrHdUnbMOVj05Hxs+/a0JlgGLxEv7ft31A1EkZmAZVi+GktGEoWdsa3UpczLa6m+crLAHbcec+zt6nwdWTIGi7WIu39kGQM7PIUoDEe4N/cfgWOJtv9gNFa3YQmb52GoxunYLskpWCTkNpijNSumYcu8SbebH6PuIXxnCAO5HddgZdz3jfjZwVSuKRE12/PnGnSfg4D/ob7sVBeouwjf6HDTgT2wFYdrsWChBc4iKKda6PQ32Tzcer37/i8kLyOXJqXrT6v2xXR1IeETJ2L7CVZj0ZFPubn70CoK5DD3/Qg3LTjSvS3L6zReHjDJN1C78nSjciReRHpZnpcSno1aiJblq27gfjLi8ftg25VL1ZyfCQyQ1wLH/YHNKz33Y8t7VwP/BwtzftT5F/6rAfd6MumWl+sD/sMp0R1QuHMsk1LYzr6/w5x1k9yb+HHMafege1M3g4nOX1CLkVgk36UMJHBtw7ZGz3G//5SbIkxz9/VzrODLRMwz3+t+noCFOpcoFbnty+D+hjoFdUhG8nvbWVh3A//sZNKv7i6qsYMb8NXeOPe5gTYhR2+bNizT0jVsHqzTj8UjlLiw7O15bIQ39gYGsii9mtFL5QAaV0Zujbq6qMWRCTrWb92btJl8goGqzsH2KPAvIccHFV430ZbmRgFHO9P7p8DNWPhwWpmYx2OJXxtZW/I/ZS2LanPuVQk71qtEX/ZLk6OxvQnlFZzvCjl2AfAY4TUl1hIt3VuQ0W7qsD8Wi1Avn6U5BWc/q64vwjg7hc51H7ZHP+1AnUFYINBoN6XZ1c2FS/93A+YovMEpiTCilF97Dsu89C73/zoaJPvDsWxNzVAIdwOz1P1FOetT7GQ/TdEvgHOyrcaWCJ9h0zyHf6hxjh9gsQZx7+EtbMflrLJrycLK6W9y63PK9Gzys4lLNJHxKXewbuDGlK7ttgpvzxVlx93nvp4J3OTe9itTup8HMpL7cOCRHCgEhTuLTTgzo44135neSTgM29DzXcJ3+AX5upsSXJ3hIFnvzOtTsaQtw1OQ+y05VAZh8hUF4tg6nIlRd9zFcbq9F7geWzM/xg328nO+XPaZPjeN6GnQYFmPVYC6EUvZPizhtOLVHCuEEzQ0isUQLJKvEZ1rOZawpBZfxFKbvemUQqV1+RuwrEFx192zVBjfjSn/f86xMujHVm9EQWgDrmtCJzuuwvVsAXzPDZKzsMpLs92Uoy/EAVbuWKymBO7CqjedhaUc68zo3tZhcRxRE6dcn3OF8A5K4FoIRQCbxvU3snU7Z1953YIH3IB6xJnjpTqPlc4T5U2/EUudFsa6iAolyf2tcxbOm86pOY/NC8ru7qZE/TlvV6L6D14z2Q3IZne0VW7gdGM7EV8nXmqwqG1eBTl8q8H3Ox+LbRiGZXp+rAWUQT+WdVq7JD1lf8Kj9HxqQaXyH1Vk8WITrm01cIdzsm5sIZn+QkPHP/b2XBEENzJtdNONW6vI4+aCyCOt5n1q90EFUwjXF+Q+BwHPYtmJn61y3N+htfY4nCsR+MPxNG59vtntASxx6uM1ZKK3fnxn6c2yEPxgJ4qTIWcs8H1sSbUSZ7hj+mQlRKYdK3hTqvUwWiJpXb5TgDfYRqwo68Ux5PIEevPXs2riVYxCkSyE3gLcYxdWxfkrEY/vw6InRTLeh+3DOFgKofXYUIB7HIXVL4jC0VjAzSyyyYtYFEZiu0onSiG0Dm1YQIzvbATOj3hsqaZDG8VbbUqb0cBDeBDNWJSOMAv/U2SVIuq6gKkRP3MgFh7drTFdN1OdxdXSFMXrfj+2cch3K2gxloZsVQwlcjiWIm1QwMoo7xfdqIZBFHbHIjAXShT55XyK4fEulW3/QUz5/Arb4luqbLQ45Nwr3fRiHVpZqNW60HJkbplJtKSiPrS/xJTNP5T9fAUDJd7L90TMw6o9SyFEa0s09PJnPoNlIC5KJ1yagtxewTYf/cSZvRuwHZGl/RAPa7BHziS1s4Zhvri1YJ2wnrJyp4X87jnncAyyRIM9UtsAHKohmK+pgo8drYeBhCbLgd8Ffu5MWYYvu/OWljHHOC+6BnzttoJ0ks82HN+WHduwQJFLPVV0gwPPbC5WAXpQYMWgnLMS/p+R2FbfXgYKvK7C0tSL2gzFkvCIHCi42wr2NtqILQv2EV6/MQmldPRrsXj9LwGXYPUrZQFEa7fSuIpXosJb7caCdboznTOx9PO9IQM7CdOwpcZHgT8zkH24VwM9VrtWw7J5XFzADrc6xJkV5I465rKva0DnutqVqMAI4OfqeH9r/xqwDv4Ny2p8U0yZnuXOdT9wHoo/qLddgPaLNISxtE7m3ka2V1zrCvzuwpiyPTvwfSkp7U+Ap6mchHSeZF+x3avhmi1HqJPFXrL8UR3yvirwfSk0d3KIn0Kyrtz+6FYgRMocpc6VuF2KxRRkRZ9kXNMRDPHrX4oKfEWdKrR1lq0KVGsrgcszeDaX6TlEat/WMK6fycA9bF6IRM02cM0sm/fX2tT1CLZdN01uxv8iOGntiDxSQzo527q3mjpTuG/gwRCZnUvlYqylr2lzNa1VjanZAWU/1tCOz87qPDWrNJ0CXAN8LSC3Nixq8wznTCyv9Xgp6W/AWaXnEbvNzdinE4u854AbSvSkoUVlJRaQtBjL/nsvFlS0ApjjzPhXAsdfg4U6n5rBtSgVW3xmOd/LUc7aayp59XS2MbBM82H1mZqswQKQjgL2wEq0HR/4+w3u61IsunEZ8MOUr2E9FhUp73kyHnZ+hdckinCukjkZe5XhCuAbEeWb9vZcPYN00uCN0dDfnPPUORK1G2LIeGSKz+seyT619hAwWypggBnqFInbKmclNJLLJPdMNq29Vz4E25uwAqX8rpdRbk7fCFYAEyTy1HnL+c8ebeQ/zdMOrHYsJbiUQf282qD/87aUQWaMw7avf6SoAvgAtuwikzGddmPGz2uOZNyw9t2iKYNJbJ7sQ63+9laGz2yt5NuQVgrTP78RAzEv5vmtwC6yElNnOLAXFoyUJnfpeTXcz3cAtrT8J99v+BAU/96IlhZzJcumV4XKLKNzs52KQ4Bz3FeRLf3A3nWe41+AD0qUTWWKU8oTfVQIM52FIBrDPXV+/uPAMImx6bwbS4vvlQ9hBnC7OlhDGYolYd3SyT6u32CWRJgrpTAUW2J+s9VvZj/gBc0Hm9pejvG8zpC8ctvuLHM+puLBbBTDsTLkV0nB54JOou1p2CBLLte8hTkau1rJh7AHltlHyiA/jMC81tXSeV0jZZB7xgHPkoLDt1EWwmQsSYeKVeSXXwAnl/1uKvCSRNMyrGUgRX5uLYSJWCZgKYN883ng+sDPp0kZtBxbYJvNZuTRQihlPfoBcLqeVcswH1vrVjnz1mUlsCsJVh+yXnZ8EfiEnk9LsZ1704jWZQSWiu2hvCiEHYCFWFlxIUTj+Zgb33c1WyEMxpZBxumZCNFUDsayaEW2FNL2IWztTJU2lH1XiLxwQFSlkOagnQQ8SUabLoQQiVlNxGzOaS0Fbovl+pcyECJ/bIkV8NmqET6ErbFEkKMkdyFyyw5YXMkjWU8ZFmFrnkKI/NNBlZJ79VgI22M1BBXAIkTrsBVWISo1C6EN2+zyJLCT5CtES7EGCwnoTdNCuB5byhBCtN6U4S0qLEMmsRBOBn4muQrR0uyLRRPXpRAOwJYvlBRViNZmCba9fRPixCEMxwqJShkI0frsQEiNhzgK4WpguuQohDdMcYohtkI4Ffh7yU8Ir9gWOCiuQtgb+L5kJ4SXbJJdKYpT8XYKXJJaiAIwAsusXdNCGCNlIERxrIRaCuE3kpUQ3jMhqkKYIVkJ4T1HlL6p5kPYE1unHCF5CeE9bQDtFf44CDhbykB4xo9dx/8USuYTZEmtA/ZGRTTV/GulN+Eg4NtY/QLJJeArDPMhDMUyIAnhE99wX/uBPuBcLNvXVcANwIICy+bPpW/aK5hVQvjG3JDf9QDHBcbBNZiDrWhlB6dVshB2B/7R05vupUJSCOE9L2I1DyvR49ongQuBdUX1IZQrhH8Axnt6078Bfq2xUUjewAqWRJ1aTAW+g9UYKQLXVfrDX/HTadIFHOgetJxIxWu3Jxwog4CXCyCfH1ayEHbwVAPeCDzgFN6ZemEWjtUJP9cHfAZ43nP5PB2mELbz+IZPCnx/PnKcFo236/jsPGdd/tlj+TwephB8TZp6PLC+zIH0pTreGqL1WFbn598EdvFYPovDFMIpHt7oCuDBKg9ZFIOnUzrPXkR3TrYSa8IUwkEe3mgnlZeQ+jVOCsNTKZ3nCeCXHsrnsNI3pc1N7cBarACLL/RhfpGlFf6+DhipsVII2lI+35PAezySz+XAp4MWQg8RNji0GKdUUQaQTqFbkX8uy+CcezCQVtAHS/P3YVOGZzzqBHcDv6pxzDsaK4XgkYzO+y1ngbZ5IKPfhSmE6zyaKlxC7TDljRorhaArw3O/BnzZAxmFWjlD8CPq6nWsfl0trkMRfEVo722Af+LCFpbPf1a7uW4POsBpER/klhoshWiTGvCGHewcjX0tJpuNwMHBGxkUYgK1MvcCF0U8dg1wsyxq72nE1LDXORovaDHZLKXGkuyjLf42iJsU9kBsuVVvUn9bo2uR/riFZHNUrZv5fQs/+Jsj+g7K539LNGi8bffTnOXlk1pANneEXXj5lOHijL2yWTI3gXnYDzwrq9pbnqM5cQKXYZXS88oyKiRCKlcIK3AlnVqMh50yS8I8jRuv/QfNUAj9wAnO4u7OmUxewKo+r42iEF7Alu1aiW5gVp2OSOEnT9G8SMI2rGL6COC3OZHHYiyCt6KSGhQyuHpa7KF/pZK2i8iTGjde0gssb+L/LymiHuCzWHrCZkXHvgjMxJzoVS3icoUwmNaK8V8DzK/zHBtyaNaJ+hlMfvKDdgE3AcOxXBxLG/Q/n3FTl+nAfVgdiqq0hwyOBVj25VbgJuCxFM7zDo1fnhLZk8d06j/G9g7MAXbGKkjtm+KLeAnwB+e/uCWNE+5JaywpdZPexpJWDj1VC299wD/lWFm1uRdyh2sfdi+4pNGONwO7YoWWEivCsEItT7SI9j85RYdR0QpzFIGuKCZyk30MQX/dXDYtJrMHltVrSyyu4Tbn79o2MMV9F5bB6a6sL3Z+zrV/2mu88/RG9a6tJvuNTYWZY306x9e8DvhFyudcr67gHe9QvVqTiKEQlmBhn3ljJXA4cE/K552qruAd3RSvJFtmCuEd4KvkK6vQa9g66t0ZnHuVuoKXfVsrRykpBICFBHKtNZl5WN2IxRmd/2F1Be9YS3MDk7zlfJrrHDqjAfe4B3LC+dbu09CNT3uEY+Zg9Q3OasIccCsaU2FpNRbqqkzM/vCiRJAtH8S8to1YLroCGN3Ae5vofBR6s/rTttKQzZ6tgavILrLs01jcdaPZTQPIuyYayGxsg0Y9D2wDttX6FuDEJt/P4xpA3rV9NEyz8SGEcTsWN30ccDRwSIx53UKnTG7DNmE0m/dj+zeEX7RJBM1TKtOxdFU9Tjv3YtlqSluLv4tt4Bjmjs/T3oFz9DbVlEFko0XbsQKq3djmkt4WkMF+KA5BfVvUNWWoRA+NWSZMk9fVDYQwtO3Xlhv/JDEIIYVQ4kgU5uobikOQQkjMcuB6icEr9pYIpBDq4QvAMRKDN2wnEUgh1IuKv/rDLhJBfLQ0syknAJdLDN687BSPIAuhLv5JIvAGKQNZCHWzAYumFK1NN/ErgQtZCJvwZSynvWh9HpIIpBDq5T2ymLxhgUQghVAPg4ExEoM33CURSCHUQx+tsRFLqF9LcA2gH/ilxOANkyQCKYR6mQs8IjF4wXSJQAohDeZo6uAFqukohZAK9wD/IzFoylBUtMy2KR1Ypiehvi0LoeDsjyWPFa3PUokgGe0SAQBjsVWGGRKFF3RLBLIQ6uHbUgZeoaS5UgiJGQV8XWLwiuckAimEpGjN2j9ekAikEJLytETgHWskAimEpPRiWZeFPzwmEUgh1MPtwN0SgzeoVqcUQl10Aoeh5SpfeFMikEKol+mShzdslAikEOrlVCxRimh9zpMIpBDqYUvg/RKDNxyMfEJSCHUwGthNYvAKVW6SQkhMD9rl6KNC+KjEIIWQhGkoyapvDAV2kBikEOIwHjgfuB9V+vGRvVBehFgUdftzm1MAVwKzA78TfjE68KyFLISK9GNLU7PVBbxmjZSBFEIUzgC+oc7iPc/rGUshRPEbnKBpQiFYIRFIIdRiBJYURfhNJ/CKxCCFUIt2VOW5CKxGmZOkECKwCliuR+89G4F1EoMUQi260DbnIrANMFNikEKoxbFYwIrwmw7gQ8hxHIuiCWsG8JQee6EYBayXGGQhlLM1ME+PvHDsIhFIIZQzBPghsJUeeeHQpjVNGTZjKvCSHnch2RL+KJkDAAABLElEQVSlZZeFUMY39agLS4dEIAuhnHdQMFIR6cKcij0ShSyEEh+TMigsnRKBFEI5B+gxF5Z2iUAKoZxhesyFZQtsuVlIIfwNzR+LzZ0SQXR8L0wyBbgYW3oSxWQ85licK1EU20LYGbgX2F6PufB8FAUoRcLXZccJwDPARD1i4dgXWCgxFNNCOE/KQJRxoURQTIWwFfARPVpRxniJoJgK4d3Atnq0oowdJYJiKoQL9FhFCCOAAyWG6vjoVNS+BVGJ54FdJYbiWAjjpAxEFbZBkYuFUgiT9UhFFfqxHZCiIApB5e1FLYXwjsRQnAGk6YKo1d+HSwzFUQi76ZGKGv39LYmhOArh7/VIRRV+IxFUx7dlxz8B79djFRUYi5XyEwWxECbpkYoKXC5lUJv/D+kkr2q1ABx+AAAAAElFTkSuQmCC"),_export("PayPalLogo","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAaCAYAAABByvnlAAAFRWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS41LWMwMTIgMS4xNDk2MDIsIDIwMTIvMTAvMTAtMTg6MTA6MjQgICAgICAgICI+CiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgICB4bWxuczpkYW09Imh0dHA6Ly93d3cuZGF5LmNvbS9kYW0vMS4wIgogICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iCiAgICB4bWxuczpQYXlQYWw9Ind3dy5wYXlwYWwuY29tL2Jhc2UvdjEiCiAgIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIgogICBkYzptb2RpZmllZD0iMjAxNC0wNy0yM1QxMzozNTo1My44LTA3OjAwIgogICBkYW06c2l6ZT0iMTQxNyIKICAgZGFtOlBoeXNpY2Fsd2lkdGhpbmluY2hlcz0iLTEuMCIKICAgZGFtOmV4dHJhY3RlZD0iMjAxNC0wNy0yM1QxMzozNTo1MC4xMDMtMDc6MDAiCiAgIGRhbTpzaGExPSI5YjE2YjMxZDY3ZjYxYmQ5MTdlMjU0Y2I4YzM3YzI1YmZkOTA1ZGUyIgogICBkYW06TnVtYmVyb2Z0ZXh0dWFsY29tbWVudHM9IjAiCiAgIGRhbTpGaWxlZm9ybWF0PSJQTkciCiAgIGRhbTpQcm9ncmVzc2l2ZT0ibm8iCiAgIGRhbTpQaHlzaWNhbGhlaWdodGluZHBpPSItMSIKICAgZGFtOk1JTUV0eXBlPSJpbWFnZS9wbmciCiAgIGRhbTpOdW1iZXJvZmltYWdlcz0iMSIKICAgZGFtOkJpdHNwZXJwaXhlbD0iMzIiCiAgIGRhbTpQaHlzaWNhbGhlaWdodGluaW5jaGVzPSItMS4wIgogICBkYW06UGh5c2ljYWx3aWR0aGluZHBpPSItMSIKICAgdGlmZjpJbWFnZUxlbmd0aD0iMjYiCiAgIHRpZmY6SW1hZ2VXaWR0aD0iMTAwIgogICBQYXlQYWw6c3RhdHVzPSJTb3VyY2VBcHByb3ZlZCIKICAgUGF5UGFsOnNvdXJjZU5vZGVQYXRoPSIvY29udGVudC9kYW0vUGF5UGFsRGlnaXRhbEFzc2V0cy9zcGFydGFJbWFnZXMvTG9jYWxpemVkSW1hZ2VzL2VuX1VTL2kvYnV0dG9ucy9QUF9sb2dvX2hfMTAweDI2LnBuZyIKICAgUGF5UGFsOmlzU291cmNlPSJ0cnVlIj4KICAgPGRjOmxhbmd1YWdlPgogICAgPHJkZjpCYWc+CiAgICAgPHJkZjpsaT5lbl9VUzwvcmRmOmxpPgogICAgPC9yZGY6QmFnPgogICA8L2RjOmxhbmd1YWdlPgogIDwvcmRmOkRlc2NyaXB0aW9uPgogPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KPD94cGFja2V0IGVuZD0iciI/PvtbKnkAAAVQSURBVHgB7dl5bJVVGoDx97bAFBJoEOM2YUKYSoGIt8aYxgUEE9GAqMENFyomCDSdsg0DZZWlfGKM1lqBsJS5TJjAEGaYYQbKVsABUTatpqUolBAgamQTREJs6TtP4rnJm3MJ97OtME3a5PfHbZqTfue5555zciXhJxqkJpECafErsS9wDhpSLaoxCNKi6YOkQRvofUjTagnSH9oID0KaTkuQANoIWyFNpyVIGbQRaiAtmi7IEahYd8/RSMZ4jLWMcRrpNkGlxxT+trAaEh6iQR+UY4cP/8I76AO57pYe/S02YIcP67EIg9EK0ghPY4fzb/dLRIMfoJb0mKqRLrmhyGPFtTJ28yxIaNFgPjSEpTcgSA40hN3oAGmgZVDnjA1SD7UimRPDB5lUrrLosDLR9yBskG3QkJ68zkECaEiFkAbaDXV2xmNkQX2RO8eHC5IxRmVJzc+DTty+GhJKNPga6tQhF3mYjys38mjNs6yFGvMwCoU4BzU+gTTQWaizNB5kHNQX6ZofbnU8t8wNiGm7DkCSigbpUKMSYvwVaiy6zkGqoUZ7iDMaalRAGuAWqDE+HmQlFMbccKujV0F8dQBT/rsbklQ0yIYaf4cYq6DGVAjaIh/bcRSHsRJZKETMGYFWWIyYMwriaY8PEHPyeI7WqIU6JyDGH6DGOghS8ALW4TCOogyD8BpizlsQPAw1BsaDVEAtuWtW8hjRKSolVWZA/LF8CSSpaDAMasyBOJ3xPdTojQwcgsJ3AXVQJwZBDdT5EWkQoxRqjOQ5ukONrRCnHT6FGhOQjs1QyzgHdaohGAk1usaDnIZa0nO6F8Do+SeVYSvNQEb+xmxIUtFgHtT4GDFswEWocRAdcRzquQL1YRIEhVBjAMQZCDXWI+KOomocQQxr8C3UuITbUQb1XIH6sBaCIqhzGSnxIHVQsbLxbKnKkOXAqwTI/49KcaU3uBHsPwMJJRr8ExrCJdyPIqixAp0RQT9/ReEpCHpBjQUQdPIOFadxm9s/JkNDysPzUGMfohBkogpqBBAv4ucQ4R+4FZpg3BYzQAiLa1RGbxoKCSUafAlNogoPINWb8L1IgRj+iusGcQ5BnRP20GA8Yzb05dAkvkMOBFugznl0ghiDoUYOBMegzup4kJehCd48ED4Gm7pM2LYAEko0aO2typ/wNmZiBnKRjQgEPaHGRIjnDW+8VhBnOtSYCzX+4p2w9kKN5ZjpjMGjaANxLkKdNRDPAKhxH9qhHurMgohbwppg4VfhYszdf4p3/CuQ0BIneDPkGnpDjRkQow2qvZUlRneoYR1HuhfkvPeOj0AMKwVqbIB4VkCNDsiCGi/Gg+yEivXQe1edfFbNWSn4cJVwkuIjbTKbcybkF4sGg6FGMeQafgc1zqA/2qIXNkGNf0A8X0A99ejnxbgDauyBJPEN1KnHcLRHFxRBjZMQDIEaWfEgJ6FiPWEueobZIxqHOwXUyIUksQ8aUiHEUwD1vAvxgjwCNWKQJEqgIZVDMNOL2C4e5DJUrJw1Vx9s7JabIY3GZzbU6AtJ4l6ch8JXCTWGQjx9oUYV0uAHyYMaBZAkOuEIFL5KqFECwd+gzjFIPIgmGLMpceDiqlpIk+BSiJhThDRICBlYiH2owCo8ju74M2KYj5sgRmvs9Tb9LAj8IH0Qc5YhExJCR8zGLlSgDMORjsWIoRRZELyOmPOSDVKKjWLN3nP5KneMU5BmKfHb0MnN4Asqo+RgXUKQabs+gzQ7nNC82/xHSG02QZj830B9nKyKIM2Nt79cwO8hzWuFjFiXwvE2FQCvIc0Sl0ukOBHI/7P/AdBwSAZsEaX1AAAAAElFTkSuQmCC"),_export("PayPalLogo","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAaCAYAAABByvnlAAAFRWlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNS41LWMwMTIgMS4xNDk2MDIsIDIwMTIvMTAvMTAtMTg6MTA6MjQgICAgICAgICI+CiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPgogIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iCiAgICB4bWxuczpkYW09Imh0dHA6Ly93d3cuZGF5LmNvbS9kYW0vMS4wIgogICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iCiAgICB4bWxuczpQYXlQYWw9Ind3dy5wYXlwYWwuY29tL2Jhc2UvdjEiCiAgIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIgogICBkYzptb2RpZmllZD0iMjAxNC0wNy0yM1QxMzozNTo1My44LTA3OjAwIgogICBkYW06c2l6ZT0iMTQxNyIKICAgZGFtOlBoeXNpY2Fsd2lkdGhpbmluY2hlcz0iLTEuMCIKICAgZGFtOmV4dHJhY3RlZD0iMjAxNC0wNy0yM1QxMzozNTo1MC4xMDMtMDc6MDAiCiAgIGRhbTpzaGExPSI5YjE2YjMxZDY3ZjYxYmQ5MTdlMjU0Y2I4YzM3YzI1YmZkOTA1ZGUyIgogICBkYW06TnVtYmVyb2Z0ZXh0dWFsY29tbWVudHM9IjAiCiAgIGRhbTpGaWxlZm9ybWF0PSJQTkciCiAgIGRhbTpQcm9ncmVzc2l2ZT0ibm8iCiAgIGRhbTpQaHlzaWNhbGhlaWdodGluZHBpPSItMSIKICAgZGFtOk1JTUV0eXBlPSJpbWFnZS9wbmciCiAgIGRhbTpOdW1iZXJvZmltYWdlcz0iMSIKICAgZGFtOkJpdHNwZXJwaXhlbD0iMzIiCiAgIGRhbTpQaHlzaWNhbGhlaWdodGluaW5jaGVzPSItMS4wIgogICBkYW06UGh5c2ljYWx3aWR0aGluZHBpPSItMSIKICAgdGlmZjpJbWFnZUxlbmd0aD0iMjYiCiAgIHRpZmY6SW1hZ2VXaWR0aD0iMTAwIgogICBQYXlQYWw6c3RhdHVzPSJTb3VyY2VBcHByb3ZlZCIKICAgUGF5UGFsOnNvdXJjZU5vZGVQYXRoPSIvY29udGVudC9kYW0vUGF5UGFsRGlnaXRhbEFzc2V0cy9zcGFydGFJbWFnZXMvTG9jYWxpemVkSW1hZ2VzL2VuX1VTL2kvYnV0dG9ucy9QUF9sb2dvX2hfMTAweDI2LnBuZyIKICAgUGF5UGFsOmlzU291cmNlPSJ0cnVlIj4KICAgPGRjOmxhbmd1YWdlPgogICAgPHJkZjpCYWc+CiAgICAgPHJkZjpsaT5lbl9VUzwvcmRmOmxpPgogICAgPC9yZGY6QmFnPgogICA8L2RjOmxhbmd1YWdlPgogIDwvcmRmOkRlc2NyaXB0aW9uPgogPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KPD94cGFja2V0IGVuZD0iciI/PvtbKnkAAAVQSURBVHgB7dl5bJVVGoDx97bAFBJoEOM2YUKYSoGIt8aYxgUEE9GAqMENFyomCDSdsg0DZZWlfGKM1lqBsJS5TJjAEGaYYQbKVsABUTatpqUolBAgamQTREJs6TtP4rnJm3MJ97OtME3a5PfHbZqTfue5555zciXhJxqkJpECafErsS9wDhpSLaoxCNKi6YOkQRvofUjTagnSH9oID0KaTkuQANoIWyFNpyVIGbQRaiAtmi7IEahYd8/RSMZ4jLWMcRrpNkGlxxT+trAaEh6iQR+UY4cP/8I76AO57pYe/S02YIcP67EIg9EK0ghPY4fzb/dLRIMfoJb0mKqRLrmhyGPFtTJ28yxIaNFgPjSEpTcgSA40hN3oAGmgZVDnjA1SD7UimRPDB5lUrrLosDLR9yBskG3QkJ68zkECaEiFkAbaDXV2xmNkQX2RO8eHC5IxRmVJzc+DTty+GhJKNPga6tQhF3mYjys38mjNs6yFGvMwCoU4BzU+gTTQWaizNB5kHNQX6ZofbnU8t8wNiGm7DkCSigbpUKMSYvwVaiy6zkGqoUZ7iDMaalRAGuAWqDE+HmQlFMbccKujV0F8dQBT/rsbklQ0yIYaf4cYq6DGVAjaIh/bcRSHsRJZKETMGYFWWIyYMwriaY8PEHPyeI7WqIU6JyDGH6DGOghS8ALW4TCOogyD8BpizlsQPAw1BsaDVEAtuWtW8hjRKSolVWZA/LF8CSSpaDAMasyBOJ3xPdTojQwcgsJ3AXVQJwZBDdT5EWkQoxRqjOQ5ukONrRCnHT6FGhOQjs1QyzgHdaohGAk1usaDnIZa0nO6F8Do+SeVYSvNQEb+xmxIUtFgHtT4GDFswEWocRAdcRzquQL1YRIEhVBjAMQZCDXWI+KOomocQQxr8C3UuITbUQb1XIH6sBaCIqhzGSnxIHVQsbLxbKnKkOXAqwTI/49KcaU3uBHsPwMJJRr8ExrCJdyPIqixAp0RQT9/ReEpCHpBjQUQdPIOFadxm9s/JkNDysPzUGMfohBkogpqBBAv4ucQ4R+4FZpg3BYzQAiLa1RGbxoKCSUafAlNogoPINWb8L1IgRj+iusGcQ5BnRP20GA8Yzb05dAkvkMOBFugznl0ghiDoUYOBMegzup4kJehCd48ED4Gm7pM2LYAEko0aO2typ/wNmZiBnKRjQgEPaHGRIjnDW+8VhBnOtSYCzX+4p2w9kKN5ZjpjMGjaANxLkKdNRDPAKhxH9qhHurMgohbwppg4VfhYszdf4p3/CuQ0BIneDPkGnpDjRkQow2qvZUlRneoYR1HuhfkvPeOj0AMKwVqbIB4VkCNDsiCGi/Gg+yEivXQe1edfFbNWSn4cJVwkuIjbTKbcybkF4sGg6FGMeQafgc1zqA/2qIXNkGNf0A8X0A99ejnxbgDauyBJPEN1KnHcLRHFxRBjZMQDIEaWfEgJ6FiPWEueobZIxqHOwXUyIUksQ8aUiHEUwD1vAvxgjwCNWKQJEqgIZVDMNOL2C4e5DJUrJw1Vx9s7JabIY3GZzbU6AtJ4l6ch8JXCTWGQjx9oUYV0uAHyYMaBZAkOuEIFL5KqFECwd+gzjFIPIgmGLMpceDiqlpIk+BSiJhThDRICBlYiH2owCo8ju74M2KYj5sgRmvs9Tb9LAj8IH0Qc5YhExJCR8zGLlSgDMORjsWIoRRZELyOmPOSDVKKjWLN3nP5KneMU5BmKfHb0MnN4Asqo+RgXUKQabs+gzQ7nNC82/xHSG02QZj830B9nKyKIM2Nt79cwO8hzWuFjFiXwvE2FQCvIc0Sl0ukOBHI/7P/AdBwSAZsEaX1AAAAAElFTkSuQmCC"),_export("ReplacementImage",'<svg version="1.1" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><rect width="512" height="512" fill="#f8f8f8"/><path d="m220 212c0 12.029-9.7597 21.789-21.789 21.789-12.029 0-21.789-9.7597-21.789-21.789s9.7597-21.789 21.789-21.789c12.029 0 21.789 9.7597 21.789 21.789zm116.21 43.578v50.841h-159.79v-21.789l36.315-36.315 18.158 18.158 58.104-58.104zm10.895-79.893h-181.58c-1.9292 0-3.6315 1.7023-3.6315 3.6315v138c0 1.9292 1.7023 3.6315 3.6315 3.6315h181.58c1.9292 0 3.6315-1.7023 3.6315-3.6315v-138c0-1.9292-1.7023-3.6315-3.6315-3.6315zm18.158 3.6315v138c0 9.9867-8.1709 18.158-18.158 18.158h-181.58c-9.9867 0-18.158-8.1709-18.158-18.158v-138c0-9.9867 8.1709-18.158 18.158-18.158h181.58c9.9867 0 18.158 8.1709 18.158 18.158z" fill="#b4b4b4" stroke-width=".11348"/></svg>'),_export("ReplacementImage",'<svg version="1.1" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><rect width="512" height="512" fill="#f8f8f8"/><path d="m220 212c0 12.029-9.7597 21.789-21.789 21.789-12.029 0-21.789-9.7597-21.789-21.789s9.7597-21.789 21.789-21.789c12.029 0 21.789 9.7597 21.789 21.789zm116.21 43.578v50.841h-159.79v-21.789l36.315-36.315 18.158 18.158 58.104-58.104zm10.895-79.893h-181.58c-1.9292 0-3.6315 1.7023-3.6315 3.6315v138c0 1.9292 1.7023 3.6315 3.6315 3.6315h181.58c1.9292 0 3.6315-1.7023 3.6315-3.6315v-138c0-1.9292-1.7023-3.6315-3.6315-3.6315zm18.158 3.6315v138c0 9.9867-8.1709 18.158-18.158 18.158h-181.58c-9.9867 0-18.158-8.1709-18.158-18.158v-138c0-9.9867 8.1709-18.158 18.158-18.158h181.58c9.9867 0 18.158 8.1709 18.158 18.158z" fill="#b4b4b4" stroke-width=".11348"/></svg>')}}}),System.register("src/gui/base/DropDownSelectorN.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","../../api/Env","./TextFieldN","./ButtonN","./DropdownN.js","./icons/Icons","../../api/common/utils/StringUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,assertMainOrNode,TextFieldN,ButtonN,ButtonType,_createDropdown,Icons,lazyStringValue,DropDownSelectorN;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_TextFieldN){TextFieldN=_TextFieldN.TextFieldN},function(_ButtonN){ButtonN=_ButtonN.ButtonN,ButtonType=_ButtonN.ButtonType},function(_DropdownNJs){_createDropdown=_DropdownNJs.createDropdown},function(_iconsIcons){Icons=_iconsIcons.Icons},function(_apiCommonUtilsStringUtils){lazyStringValue=_apiCommonUtilsStringUtils.lazyStringValue}],execute:function(){assertMainOrNode(),_export("DropDownSelectorN",DropDownSelectorN=function(){function DropDownSelectorN(){_classCallCheck(this,DropDownSelectorN)}return _createClass(DropDownSelectorN,[{key:"view",value:function(vnode){var _this=this,a=vnode.attrs;return m(TextFieldN,{label:a.label,value:stream(this.valueToText(a,a.selectedValue())||""),helpLabel:a.helpLabel,disabled:!0,injectionsRight:function(){return a.disabled?null:m(ButtonN,{label:a.label,icon:function(){return a.icon?a.icon:Icons.Edit},click:_this.createDropdown(a)})}})}},{key:"createDropdown",value:function(a){return _createDropdown(function(){return a.items.map(function(item){return{label:function(){return item.name},click:function(){a.selectionChangedHandler?a.selectionChangedHandler(item.value):(a.selectedValue(item.value),m.redraw())},type:ButtonType.Dropdown,isSelected:function(){return a.selectedValue()===item.value}}})},a.dropdownWidth)}},{key:"valueToText",value:function(a,value){var selectedItem=a.items.find(function(item){return item.value===a.selectedValue()});return selectedItem?selectedItem.name:(console.log("Dropdown "+lazyStringValue(a.label)+" couldn't find element for value: "+JSON.stringify(value)),null)}}]),DropDownSelectorN}()),_export("DropDownSelectorN",DropDownSelectorN)}}}),System.register("src/gui/base/Dialog.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","mithril/stream/stream.js","./Modal","../animation/Animations","../animation/Easing","../../misc/LanguageViewModel","../../api/Env","../../misc/KeyManager","../../api/common/utils/Utils","../theme","../size","./icons/Icons","../../misc/WindowFacade","../main-styles","./ButtonN","./DialogHeaderBar","./TextFieldN","./DropDownSelectorN","./ProgressDialog","../../api/common/TutanotaConstants","../../api/common/utils/AriaUtils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,stream,modal,alpha,animations,DefaultAnimationTime,opacity,transform,ease,lang,assertMainOrNode,focusNext,focusPrevious,neverNull,getElevatedBackground,px,size,HabReminderImage,windowFacade,requiresStatusBarHack,ButtonN,ButtonType,DialogHeaderBar,TextFieldN,Type,DropDownSelectorN,showProgressDialog,Keys,dialogAttrs,INPUT,DialogType,Dialog;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_Modal){modal=_Modal.modal},function(_animationAnimations){alpha=_animationAnimations.alpha,animations=_animationAnimations.animations,DefaultAnimationTime=_animationAnimations.DefaultAnimationTime,opacity=_animationAnimations.opacity,transform=_animationAnimations.transform},function(_animationEasing){ease=_animationEasing.ease},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscKeyManager){focusNext=_miscKeyManager.focusNext,focusPrevious=_miscKeyManager.focusPrevious},function(_apiCommonUtilsUtils){neverNull=_apiCommonUtilsUtils.neverNull},function(_theme){getElevatedBackground=_theme.getElevatedBackground},function(_size){px=_size.px,size=_size.size},function(_iconsIcons){HabReminderImage=_iconsIcons.HabReminderImage},function(_miscWindowFacade){windowFacade=_miscWindowFacade.windowFacade},function(_mainStyles){requiresStatusBarHack=_mainStyles.requiresStatusBarHack},function(_ButtonN){ButtonN=_ButtonN.ButtonN,ButtonType=_ButtonN.ButtonType},function(_DialogHeaderBar){DialogHeaderBar=_DialogHeaderBar.DialogHeaderBar},function(_TextFieldN){TextFieldN=_TextFieldN.TextFieldN,Type=_TextFieldN.Type},function(_DropDownSelectorN){DropDownSelectorN=_DropDownSelectorN.DropDownSelectorN},function(_ProgressDialog){showProgressDialog=_ProgressDialog.showProgressDialog},function(_apiCommonTutanotaConstants){Keys=_apiCommonTutanotaConstants.Keys},function(_apiCommonUtilsAriaUtils){dialogAttrs=_apiCommonUtilsAriaUtils.dialogAttrs}],execute:function(){assertMainOrNode(),_export("INPUT",INPUT="input, textarea, div[contenteditable='true']"),_export("INPUT",INPUT),_export("DialogType",DialogType=Object.freeze({Progress:"Progress",Alert:"Alert",Reminder:"Reminder",EditSmall:"EditSmall",EditMedium:"EditMedium",EditLarger:"EditLarger",EditLarge:"EditLarge"})),_export("DialogType",DialogType),_export("Dialog",Dialog=function(){function Dialog(dialogType,childComponent){var _this=this;_classCallCheck(this,Dialog),this.visible=!1,this._focusOnLoadFunction=this._defaultFocusOnLoad,this._shortcuts=[{key:Keys.TAB,shift:!0,exec:function(){return focusPrevious(_this._domDialog)},help:"selectPrevious_action"},{key:Keys.TAB,shift:!1,exec:function(){return focusNext(_this._domDialog)},help:"selectNext_action"}],this.view=function(){var mobileMargin=px(size.hpad);return m(_this._getDialogWrapperStyle(dialogType),{style:{paddingTop:requiresStatusBarHack()?"20px":"env(safe-area-inset-top)"}},m(".flex.justify-center.align-self-stretch.rel.overflow-hidden"+(dialogType===DialogType.EditLarge?".flex-grow":".transition-margin"),{style:{"margin-top":mobileMargin,"margin-left":mobileMargin,"margin-right":mobileMargin,"margin-bottom":Dialog._keyboardHeight>0?px(Dialog._keyboardHeight):dialogType===DialogType.EditLarge?0:mobileMargin}},m(_this._getDialogStyle(dialogType)+dialogAttrs("dialog-title","dialog-message"),{onclick:function(e){return e.stopPropagation()},oncreate:function(vnode){_this._domDialog=vnode.dom;var animation=null;if(dialogType===DialogType.EditLarge)vnode.dom.style.transform="translateY("+window.innerHeight+"px)",animation=animations.add(_this._domDialog,transform(transform.type.translateY,window.innerHeight,0));else{var bgcolor=getElevatedBackground(),children=Array.from(_this._domDialog.children);children.forEach(function(child){return child.style.opacity="0"}),_this._domDialog.style.backgroundColor="rgba(0, 0, 0, 0)",animation=Promise.all([animations.add(_this._domDialog,alpha(alpha.type.backgroundColor,bgcolor,0,1)),animations.add(children,opacity(0,1,!0),{delay:DefaultAnimationTime/2})])}window.requestAnimationFrame(function(){document.activeElement&&"function"==typeof document.activeElement.blur&&document.activeElement.blur()}),animation.then(function(){_this._focusOnLoadFunction()})}},m(childComponent))))}}return _createClass(Dialog,[{key:"_defaultFocusOnLoad",value:function(){var inputs=Array.from(this._domDialog.querySelectorAll(INPUT));if(inputs.length>0)inputs[0].focus();else{var button=this._domDialog.querySelector("button");button&&button.focus()}}},{key:"setFocusOnLoadFunction",value:function(callback){this._focusOnLoadFunction=callback}},{key:"_getDialogWrapperStyle",value:function(dialogType){var dialogWrapperStyle=".fill-absolute.flex.items-stretch.flex-column";return dialogType===DialogType.EditLarge?dialogWrapperStyle+=".flex-start":dialogWrapperStyle+=".flex-center",dialogWrapperStyle}},{key:"_getDialogStyle",value:function(dialogType){var dialogStyle=".dialog.elevated-bg.flex-grow";return dialogType===DialogType.Progress?dialogStyle+=".dialog-width-s.dialog-progress":dialogType===DialogType.Alert?dialogStyle+=".dialog-width-alert.pt":dialogType===DialogType.Reminder?dialogStyle+=".dialog-width-m.pt.flex.flex-column":dialogType===DialogType.EditSmall?dialogStyle+=".dialog-width-s.flex.flex-column":dialogType===DialogType.EditMedium?dialogStyle+=".dialog-width-m":dialogType!==DialogType.EditLarge&&dialogType!==DialogType.EditLarger||(dialogStyle+=".dialog-width-l"),dialogStyle}},{key:"addShortcut",value:function(shortcut){return this._shortcuts.push(shortcut),this}},{key:"setCloseHandler",value:function(closeHandler){return this._closeHandler=closeHandler,this}},{key:"shortcuts",value:function(){return this._shortcuts}},{key:"show",value:function(){return this._focusedBeforeShown=document.activeElement,modal.display(this),this.visible=!0,this}},{key:"close",value:function(){this.visible=!1,modal.remove(this),this._focusedBeforeShown&&this._focusedBeforeShown.focus()}},{key:"onClose",value:function(){this._closeHandler?this._closeHandler():this.close()}},{key:"popState",value:function(e){return this.onClose(),!1}},{key:"hideAnimation",value:function(){var bgcolor=getElevatedBackground();return this._domDialog?Promise.all([animations.add(this._domDialog.children,opacity(1,0,!0)),animations.add(this._domDialog,alpha(alpha.type.backgroundColor,bgcolor,1,0),{delay:DefaultAnimationTime/2,easing:ease.linear})]).return():Promise.resolve()}},{key:"backgroundClick",value:function(e){}}],[{key:"error",value:function(messageIdOrMessageFunction,infoToAppend){return new Promise(function(resolve){var dialog=void 0,closeAction=function(){dialog.close(),setTimeout(function(){return resolve()},DefaultAnimationTime)},lines=lang.getMaybeLazy(messageIdOrMessageFunction).split("\n");infoToAppend&&lines.push(infoToAppend);var buttonAttrs={label:"ok_action",click:closeAction,type:ButtonType.Primary};dialog=new Dialog(DialogType.Alert,{view:function(){return lines.map(function(line){return m(".dialog-contentButtonsBottom.text-break.selectable",line)}).concat(m(".flex-center.dialog-buttons",m(ButtonN,buttonAttrs)))}}).setCloseHandler(closeAction).addShortcut({key:Keys.RETURN,shift:!1,exec:closeAction,help:"close_alt"}).addShortcut({key:Keys.ESC,shift:!1,exec:closeAction,help:"close_alt"}).show()})}},{key:"legacyDownload",value:function(filename,url){return new Promise(function(resolve){var dialog=void 0,closeAction=function(){dialog.close(),setTimeout(function(){return resolve()},DefaultAnimationTime)},closeButtonAttrs={label:"close_alt",click:closeAction,type:ButtonType.Primary},downloadButtonAttrs={label:"download_action",click:function(){open("","_blank").location=url,dialog.close(),resolve()},type:ButtonType.Primary};dialog=new Dialog(DialogType.Alert,{view:function(){return m("",[m(".dialog-contentButtonsBottom.text-break",[m(ButtonN,downloadButtonAttrs),m(".pt",lang.get("saveDownloadNotPossibleIos_msg"))]),m(".flex-center.dialog-buttons",m(ButtonN,closeButtonAttrs))])}}).setCloseHandler(closeAction).show()})}},{key:"confirm",value:function(messageIdOrMessageFunction){var confirmId=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"ok_action";return new Promise(function(resolve){var dialog=void 0,closeAction=function(conf){dialog.close(),setTimeout(function(){return resolve(conf)},DefaultAnimationTime)},buttonAttrs=[{label:"cancel_action",click:function(){return closeAction(!1)},type:ButtonType.Secondary},{label:confirmId,click:function(){return closeAction(!0)},type:ButtonType.Primary}];dialog=new Dialog(DialogType.Alert,{view:function(){return[m("#dialog-message.dialog-contentButtonsBottom.text-break.text-prewrap.selectable",lang.getMaybeLazy(messageIdOrMessageFunction)),m(".flex-center.dialog-buttons",buttonAttrs.map(function(a){return m(ButtonN,a)}))]}}).setCloseHandler(function(){return closeAction(!1)}).addShortcut({key:Keys.ESC,shift:!1,exec:function(){return closeAction(!1)},help:"cancel_action"}).addShortcut({key:Keys.RETURN,shift:!1,exec:function(){return closeAction(!0)},help:neverNull(confirmId)}).show()})}},{key:"save",value:function(title,saveAction,child){return new Promise(function(resolve){var saveDialog=void 0,closeAction=function(){saveDialog.close(),setTimeout(function(){return resolve()},DefaultAnimationTime)},actionBarAttrs={left:[{label:"close_alt",click:closeAction,type:ButtonType.Secondary}],right:[{label:"save_action",click:function(){saveAction().then(function(){saveDialog.close(),setTimeout(function(){return resolve()},DefaultAnimationTime)})},type:ButtonType.Primary}],middle:title};saveDialog=new Dialog(DialogType.EditMedium,{view:function(){return m("",[m(".dialog-header.plr-l",m(DialogHeaderBar,actionBarAttrs)),m(".plr-l.pb.text-break",m(child))])}}).setCloseHandler(closeAction).show()})}},{key:"reminder",value:function(title,message,link){return new Promise(function(resolve){var dialog=void 0,closeAction=function(res){dialog.close(),setTimeout(function(){return resolve(res)},DefaultAnimationTime)},buttonAttrs=[{label:"upgradeReminderCancel_action",click:function(){return closeAction(!1)},type:ButtonType.Secondary},{label:"showMoreUpgrade_action",click:function(){return closeAction(!0)},type:ButtonType.Primary}];dialog=new Dialog(DialogType.Reminder,{view:function(){return[m(".dialog-contentButtonsBottom.text-break.scroll",[m(".h2.pb",title),m(".flex-direction-change.items-center",[m("#dialog-message.pb",message),m("img[src="+HabReminderImage+"].dialog-img.mb.bg-white.border-radius",{style:{"min-width":"150px"}})]),m("a[href="+link+"][target=_blank]",link)]),m(".flex-center.dialog-buttons.flex-no-grow-no-shrink-auto",buttonAttrs.map(function(a){return m(ButtonN,a)}))]}}).setCloseHandler(function(){return closeAction(!1)}).addShortcut({key:Keys.ESC,shift:!1,exec:function(){return closeAction(!1)},help:"cancel_action"}).show()})}},{key:"showActionDialog",value:function(props){return this.createActionDialog(props).show()}},{key:"createActionDialog",value:function(props){var dialog=void 0,_Object$assign=Object.assign({},{allowCancel:!0,allowOkWithReturn:!1,okActionTextId:"ok_action",cancelActionTextId:"cancel_action",type:DialogType.EditSmall},props),title=_Object$assign.title,child=_Object$assign.child,okAction=_Object$assign.okAction,validator=_Object$assign.validator,allowCancel=_Object$assign.allowCancel,allowOkWithReturn=_Object$assign.allowOkWithReturn,okActionTextId=_Object$assign.okActionTextId,cancelActionTextId=_Object$assign.cancelActionTextId,cancelAction=_Object$assign.cancelAction,type=_Object$assign.type,doCancel=function(){cancelAction&&cancelAction(dialog),dialog.close()},doAction=function(){if(okAction){var validationResult=null;validator&&(validationResult=validator());var finalizer=Promise.resolve(validationResult).then(function(error_id){error_id?Dialog.error(error_id):okAction(dialog)});validationResult instanceof Promise&&showProgressDialog("pleaseWait_msg",finalizer)}},actionBarAttrs={left:allowCancel?[{label:cancelActionTextId,click:doCancel,type:ButtonType.Secondary}]:[],right:okAction?[{label:okActionTextId,click:doAction,type:ButtonType.Primary}]:[],middle:"function"==typeof title?title:function(){return title}};return dialog=new Dialog(type,{view:function(){return[m(".dialog-header.plr-l",m(DialogHeaderBar,actionBarAttrs)),m(".dialog-max-height.plr-l.pb.text-break.scroll","function"==typeof child?child():m(child))]}}).setCloseHandler(doCancel),allowCancel&&dialog.addShortcut({key:Keys.ESC,shift:!1,exec:doCancel,help:"cancel_action"}),allowOkWithReturn&&dialog.addShortcut({key:Keys.RETURN,shift:!1,exec:doAction,help:"ok_action"}),dialog}},{key:"showTextInputDialog",value:function(titleId,labelIdOrLabelFunction,infoMsgId,value,inputValidator){return new Promise(function(resolve){var result=stream(value),textFieldAttrs={label:labelIdOrLabelFunction,value:result,helpLabel:function(){return infoMsgId?lang.getMaybeLazy(infoMsgId):""}};Dialog.showActionDialog({title:lang.getMaybeLazy(titleId),child:function(){return m(TextFieldN,textFieldAttrs)},validator:function(){return inputValidator?inputValidator(result()):null},allowOkWithReturn:!0,okAction:function(dialog){resolve(result()),dialog.close()}})})}},{key:"showTextAreaInputDialog",value:function(titleId,labelIdOrLabelFunction,infoMsgId,value,inputValidator){return new Promise(function(resolve){var result=stream(value),textFieldAttrs={label:labelIdOrLabelFunction,helpLabel:function(){return infoMsgId?lang.get(infoMsgId):""},value:result,type:Type.Area};Dialog.showActionDialog({title:lang.get(titleId),child:{view:function(){return m(TextFieldN,textFieldAttrs)}},validator:inputValidator?inputValidator(result()):null,okAction:function(dialog){resolve(result()),dialog.close()}})})}},{key:"showDropDownSelectionDialog",value:function(titleId,label,infoMsgId,items,selectedValue,dropdownWidth){return new Promise(function(resolve){Dialog.showActionDialog({title:lang.get(titleId),child:{view:function(){return m(DropDownSelectorN,{label:label,items:items,selectedValue:selectedValue})}},okAction:function(dialog){resolve(selectedValue()),dialog.close()}})})}},{key:"largeDialog",value:function(headerBarAttrs,child){return new Dialog(DialogType.EditLarge,{view:function(){return m("",[m(".dialog-header.plr-l",m(DialogHeaderBar,headerBarAttrs)),m(".dialog-container.scroll",m(".fill-absolute.plr-l",m(child)))])}})}},{key:"showRequestPasswordDialog",value:function(errorMessage){var props=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{allowCancel:!0},out=stream(),value=stream(""),textFieldAttrs={label:"password_label",helpLabel:errorMessage,value:value,preventAutoFill:!0,type:Type.Password,keyHandler:function(key){return 13!==key.keyCode||(out(value()),!1)}},dialog=Dialog.showActionDialog({title:lang.get("password_label"),child:{view:function(){return m(TextFieldN,textFieldAttrs)}},allowOkWithReturn:!0,okAction:function(){return out(value())},allowCancel:props.allowCancel,cancelAction:function(){return dialog.close()}});return errorMessage.map(function(v){return v?m.redraw():dialog.close()}),out}},{key:"_onKeyboardSizeChanged",value:function(newSize){Dialog._keyboardHeight=newSize,m.redraw()}}]),Dialog}()),_export("Dialog",Dialog),Dialog._keyboardHeight=0,windowFacade.addKeyboardSizeListener(Dialog._onKeyboardSizeChanged)}}}),System.register("src/gui/base/PasswordIndicator.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","mithril","../../api/Env"],function(_export,_context){"use strict";var _classCallCheck,m,assertMainOrNodeBoot,PasswordIndicator;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNodeBoot=_apiEnv.assertMainOrNodeBoot}],execute:function(){assertMainOrNodeBoot(),_export("PasswordIndicator",PasswordIndicator=function PasswordIndicator(strength){_classCallCheck(this,PasswordIndicator),this.view=function(){return m(".password-indicator-border.mt-s",{style:{width:"100px",height:"10px"}},m(".password-indicator-bg",{style:{width:strength()+"%",height:"100%"}}))}}),_export("PasswordIndicator",PasswordIndicator)}}}),System.register("src/api/main/UserController.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../common/TutanotaConstants","./Entity","../common/utils/Utils","../entities/sys/Customer","../entities/sys/User","../common/EntityFunctions","../entities/sys/GroupInfo","../Env","../entities/tutanota/TutanotaProperties","../entities/sys/Session","./EventController","../entities/tutanota/UserSettingsGroupRoot","../entities/sys/Services","../entities/sys/CloseSessionServicePost","./WorkerClient"],function(_export,_context){"use strict";var _classCallCheck,_createClass,AccountType,GroupType,OperationType,load,loadRoot,neverNull,CustomerTypeRef,UserTypeRef,isSameId,GroupInfoTypeRef,assertMainOrNode,getHttpOrigin,TutanotaPropertiesTypeRef,SessionModelType,isUpdateForTypeRef,UserSettingsGroupRootTypeRef,SysService,createCloseSessionServicePost,worker,UserController;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_commonTutanotaConstants){AccountType=_commonTutanotaConstants.AccountType,GroupType=_commonTutanotaConstants.GroupType,OperationType=_commonTutanotaConstants.OperationType},function(_Entity){load=_Entity.load,loadRoot=_Entity.loadRoot},function(_commonUtilsUtils){neverNull=_commonUtilsUtils.neverNull},function(_entitiesSysCustomer){CustomerTypeRef=_entitiesSysCustomer.CustomerTypeRef},function(_entitiesSysUser){UserTypeRef=_entitiesSysUser.UserTypeRef},function(_commonEntityFunctions){isSameId=_commonEntityFunctions.isSameId},function(_entitiesSysGroupInfo){GroupInfoTypeRef=_entitiesSysGroupInfo.GroupInfoTypeRef},function(_Env){assertMainOrNode=_Env.assertMainOrNode,getHttpOrigin=_Env.getHttpOrigin},function(_entitiesTutanotaTutanotaProperties){TutanotaPropertiesTypeRef=_entitiesTutanotaTutanotaProperties.TutanotaPropertiesTypeRef},function(_entitiesSysSession){SessionModelType=_entitiesSysSession._TypeModel},function(_EventController){isUpdateForTypeRef=_EventController.isUpdateForTypeRef},function(_entitiesTutanotaUserSettingsGroupRoot){UserSettingsGroupRootTypeRef=_entitiesTutanotaUserSettingsGroupRoot.UserSettingsGroupRootTypeRef},function(_entitiesSysServices){SysService=_entitiesSysServices.SysService},function(_entitiesSysCloseSessionServicePost){createCloseSessionServicePost=_entitiesSysCloseSessionServicePost.createCloseSessionServicePost},function(_WorkerClient){worker=_WorkerClient.worker}],execute:function(){assertMainOrNode(),_export("UserController",UserController=function(){function UserController(user,userGroupInfo,sessionId,props,accessToken,persistentSession,userSettingsGroupRoot){_classCallCheck(this,UserController),this.user=user,this.userGroupInfo=userGroupInfo,this.props=props,this.sessionId=sessionId,this.accessToken=accessToken,this.persistentSession=persistentSession,this.userSettingsGroupRoot=userSettingsGroupRoot}return _createClass(UserController,[{key:"isGlobalAdmin",value:function(){return!!this.isInternalUser()&&null!=this.user.memberships.find(function(m){return m.groupType===GroupType.Admin})}},{key:"isGlobalOrLocalAdmin",value:function(){return!!this.isInternalUser()&&null!=this.user.memberships.find(function(m){return m.groupType===GroupType.Admin||m.groupType===GroupType.LocalAdmin})}},{key:"isFreeAccount",value:function(){return this.user.accountType===AccountType.FREE}},{key:"isPremiumAccount",value:function(){return this.user.accountType===AccountType.PREMIUM}},{key:"isOutlookAccount",value:function(){return this.user.accountType===AccountType.STARTER}},{key:"isInternalUser",value:function(){return this.user.accountType!==AccountType.EXTERNAL}},{key:"loadCustomer",value:function(){return load(CustomerTypeRef,neverNull(this.user.customer))}},{key:"getMailGroupMemberships",value:function(){return this.user.memberships.filter(function(membership){return membership.groupType===GroupType.Mail})}},{key:"getCalendarMemberships",value:function(){return this.user.memberships.filter(function(membership){return membership.groupType===GroupType.Calendar})}},{key:"getUserMailGroupMembership",value:function(){return this.getMailGroupMemberships()[0]}},{key:"getLocalAdminGroupMemberships",value:function(){return this.user.memberships.filter(function(membership){return membership.groupType===GroupType.LocalAdmin})}},{key:"entityEventsReceived",value:function(updates,eventOwnerGroupId){var _this=this;return Promise.each(updates,function(update){var instanceListId=update.instanceListId,instanceId=update.instanceId,operation=update.operation;return operation===OperationType.UPDATE&&isUpdateForTypeRef(UserTypeRef,update)&&isSameId(_this.user.userGroup.group,eventOwnerGroupId)?load(UserTypeRef,_this.user._id).then(function(updatedUser){_this.user=updatedUser}):operation===OperationType.UPDATE&&isUpdateForTypeRef(GroupInfoTypeRef,update)&&isSameId(_this.userGroupInfo._id,[neverNull(instanceListId),instanceId])?load(GroupInfoTypeRef,_this.userGroupInfo._id).then(function(updatedUserGroupInfo){_this.userGroupInfo=updatedUserGroupInfo}):isUpdateForTypeRef(TutanotaPropertiesTypeRef,update)&&operation===OperationType.UPDATE?loadRoot(TutanotaPropertiesTypeRef,_this.user.userGroup.group).then(function(props){_this.props=props}):isUpdateForTypeRef(UserSettingsGroupRootTypeRef,update)?load(UserSettingsGroupRootTypeRef,_this.user.userGroup.group).then(function(userSettingsGroupRoot){_this.userSettingsGroupRoot=userSettingsGroupRoot}):Promise.resolve()}).return()}},{key:"deleteSession",value:function(sync){return this.persistentSession?Promise.resolve():sync?this.deleteSessionSync():worker.deleteSession(this.accessToken).then(function(){return worker.reset()})}},{key:"deleteSessionSync",value:function(){var _this2=this;return new Promise(function(resolve,reject){var sendBeacon=navigator.sendBeacon;if(sendBeacon)try{var path=getHttpOrigin()+"/rest/sys/"+SysService.CloseSessionService,requestObject=createCloseSessionServicePost({accessToken:_this2.accessToken,sessionId:_this2.sessionId});delete requestObject._type;var queued=sendBeacon.call(navigator,path,JSON.stringify(requestObject));console.log("queued closing session: ",queued),resolve()}catch(e){console.log("Failed to send beacon",e),reject(e)}else{var _path="/rest/sys/session/"+_this2.sessionId[0]+"/"+_this2.sessionId[1],xhr=new XMLHttpRequest;xhr.open("DELETE",getHttpOrigin()+_path,!1),xhr.setRequestHeader("accessToken",_this2.accessToken),xhr.setRequestHeader("v",SessionModelType.version),xhr.onload=function(){200===xhr.status?(console.log("deleted session"),resolve()):401===xhr.status?(console.log("authentication failed => session is already deleted"),resolve()):(console.error("could not delete session "+xhr.status),reject(new Error("could not delete session "+xhr.status)))},xhr.onerror=function(){console.error("failed to request delete session"),reject(new Error("failed to request delete session"))},xhr.send()}})}}]),UserController}()),_export("UserController",UserController)}}}),System.register("src/api/main/Entity.js",["../entities/sys/Services","./WorkerClient","../common/EntityFunctions","../entities/sys/VersionData","../entities/sys/RootInstance","../entities/sys/VersionReturn","../Env","../common/EntityConstants","../common/utils/Utils"],function(_export,_context){"use strict";var SysService,worker,_eraseEntity,_loadEntity,_loadEntityRange,_loadMultipleEntities,_loadReverseRangeBetween,_setupEntity,_updateEntity,_verifyType,CUSTOM_MIN_ID,firstBiggerThanSecond,GENERATED_MIN_ID,getEtId,getLetId,HttpMethod,RANGE_ITEM_LIMIT,resolveTypeReference,createVersionData,RootInstanceTypeRef,VersionReturnTypeRef,assertMainOrNode,EC,downcast,Type,ValueType;function load(typeRef,id,queryParams){return _loadEntity(typeRef,id,queryParams,worker)}function loadRange(typeRef,listId,start,count,reverse){return _loadEntityRange(typeRef,listId,start,count,reverse,worker)}function serviceRequest(service,method,requestEntity,responseTypeRef,queryParams,sk){return worker.serviceRequest(service,method,requestEntity,responseTypeRef,queryParams,sk)}return _export("setup",function(listId,instance){return _setupEntity(listId,instance,worker)}),_export("update",function(instance){return _updateEntity(instance,worker)}),_export("erase",function(instance){return _eraseEntity(instance,worker)}),_export("load",load),_export("loadMultiple",function(typeRef,listId,elementIds){return _loadMultipleEntities(typeRef,listId,elementIds,worker)}),_export("loadRange",loadRange),_export("loadAll",function(typeRef,listId,start,end){return resolveTypeReference(typeRef).then(function(typeModel){return start||(start=typeModel.values._id.type===ValueType.GeneratedId?GENERATED_MIN_ID:CUSTOM_MIN_ID),function _loadAll(typeRef,listId,start,end){return loadRange(typeRef,listId,start,RANGE_ITEM_LIMIT,!1).then(function(elements){if(0===elements.length)return Promise.resolve(elements);var lastElementId=getLetId(elements[elements.length-1])[1];return elements.length!==RANGE_ITEM_LIMIT||null!=end&&!firstBiggerThanSecond(end,lastElementId[1])?Promise.resolve(elements.filter(function(e){return null==end||firstBiggerThanSecond(end,getLetId(e)[1])||end===getLetId(e)[1]})):_loadAll(typeRef,listId,lastElementId,end).then(function(nextElements){return elements.concat(nextElements)})})}(typeRef,listId,start,end)})}),_export("loadReverseRangeBetween",function(typeRef,listId,start,end){var rangeItemLimit=arguments.length>4&&void 0!==arguments[4]?arguments[4]:RANGE_ITEM_LIMIT;return _loadReverseRangeBetween(typeRef,listId,start,end,worker,rangeItemLimit)}),_export("loadVersion",function(instance,version){return resolveTypeReference(instance._type).then(function(typeModel){if(!typeModel.versioned)throw new Error("unversioned instance: can't load version");return load(instance._type,instance._id,{version:version})})}),_export("loadVersionInfo",function(instance){return resolveTypeReference(instance._type).then(function(typeModel){if(!typeModel.versioned)throw new Error("unversioned instance: can't load version info");_verifyType(typeModel);var versionData=createVersionData();return versionData.application=typeModel.app,versionData.typeId=typeModel.id+"",typeModel.type===Type.ListElement?(versionData.id=getLetId(downcast(instance))[1],versionData.listId=getLetId(downcast(instance))[0]):versionData.id=getEtId(downcast(instance)),serviceRequest(SysService.VersionService,HttpMethod.GET,versionData,VersionReturnTypeRef)})}),_export("loadRoot",function(typeRef,groupId){return resolveTypeReference(typeRef).then(function(typeModel){var rootId=[groupId,typeModel.rootId];return load(RootInstanceTypeRef,rootId).then(function(root){return load(typeRef,root.reference)})})}),_export("serviceRequest",serviceRequest),_export("serviceRequestVoid",function(service,method,requestEntity,queryParams,sk){return worker.serviceRequest(service,method,requestEntity,null,queryParams,sk)}),{setters:[function(_entitiesSysServices){SysService=_entitiesSysServices.SysService},function(_WorkerClient){worker=_WorkerClient.worker},function(_commonEntityFunctions){_eraseEntity=_commonEntityFunctions._eraseEntity,_loadEntity=_commonEntityFunctions._loadEntity,_loadEntityRange=_commonEntityFunctions._loadEntityRange,_loadMultipleEntities=_commonEntityFunctions._loadMultipleEntities,_loadReverseRangeBetween=_commonEntityFunctions._loadReverseRangeBetween,_setupEntity=_commonEntityFunctions._setupEntity,_updateEntity=_commonEntityFunctions._updateEntity,_verifyType=_commonEntityFunctions._verifyType,CUSTOM_MIN_ID=_commonEntityFunctions.CUSTOM_MIN_ID,firstBiggerThanSecond=_commonEntityFunctions.firstBiggerThanSecond,GENERATED_MIN_ID=_commonEntityFunctions.GENERATED_MIN_ID,getEtId=_commonEntityFunctions.getEtId,getLetId=_commonEntityFunctions.getLetId,HttpMethod=_commonEntityFunctions.HttpMethod,RANGE_ITEM_LIMIT=_commonEntityFunctions.RANGE_ITEM_LIMIT,resolveTypeReference=_commonEntityFunctions.resolveTypeReference,_commonEntityFunctions.TypeRef},function(_entitiesSysVersionData){createVersionData=_entitiesSysVersionData.createVersionData},function(_entitiesSysRootInstance){RootInstanceTypeRef=_entitiesSysRootInstance.RootInstanceTypeRef},function(_entitiesSysVersionReturn){VersionReturnTypeRef=_entitiesSysVersionReturn.VersionReturnTypeRef},function(_Env){assertMainOrNode=_Env.assertMainOrNode},function(_commonEntityConstants){EC=_commonEntityConstants.default},function(_commonUtilsUtils){downcast=_commonUtilsUtils.downcast}],execute:function(){Type=EC.Type,ValueType=EC.ValueType,assertMainOrNode()}}}),System.register("src/api/main/EventController.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../common/utils/ArrayUtils","../Env","../common/EntityFunctions","mithril/stream/stream.js","../common/utils/Utils"],function(_export,_context){"use strict";var _classCallCheck,_createClass,remove,assertMainOrNode,isSameTypeRefByAttr,stream,downcast,identity,isUpdateForTypeRef,EventController;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_commonUtilsArrayUtils){remove=_commonUtilsArrayUtils.remove},function(_Env){assertMainOrNode=_Env.assertMainOrNode},function(_commonEntityFunctions){isSameTypeRefByAttr=_commonEntityFunctions.isSameTypeRefByAttr},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_commonUtilsUtils){downcast=_commonUtilsUtils.downcast,identity=_commonUtilsUtils.identity}],execute:function(){assertMainOrNode(),_export("isUpdateForTypeRef",isUpdateForTypeRef=function(typeRef,update){return isSameTypeRefByAttr(typeRef,update.application,update.type)}),_export("isUpdateForTypeRef",isUpdateForTypeRef),_export("EventController",EventController=function(){function EventController(logins){_classCallCheck(this,EventController),this._countersStream=stream(),this._entityListeners=[],this._logins=logins}return _createClass(EventController,[{key:"addEntityListener",value:function(listener){this._entityListeners.push(listener)}},{key:"removeEntityListener",value:function(listener){remove(this._entityListeners,listener)}},{key:"countersStream",value:function(){return this._countersStream.map(identity)}},{key:"notificationReceived",value:function(entityUpdates,eventOwnerGroupId){var _this=this,loginsUpdates=Promise.resolve();this._logins.isUserLoggedIn()&&(loginsUpdates=this._logins.getUserController().entityEventsReceived(entityUpdates,eventOwnerGroupId)),loginsUpdates.then(function(){_this._entityListeners.forEach(function(listener){listener(downcast(entityUpdates),eventOwnerGroupId)})})}},{key:"counterUpdateReceived",value:function(update){this._countersStream(update)}}]),EventController}()),_export("EventController",EventController)}}}),System.register("src/api/main/EntropyCollector.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../common/TutanotaConstants","../Env"],function(_export,_context){"use strict";var _classCallCheck,_createClass,EntropySrc,assertMainOrNode,EntropyCollector;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_commonTutanotaConstants){EntropySrc=_commonTutanotaConstants.EntropySrc},function(_Env){assertMainOrNode=_Env.assertMainOrNode}],execute:function(){assertMainOrNode(),_export("EntropyCollector",EntropyCollector=function(){function EntropyCollector(worker){var _this=this;_classCallCheck(this,EntropyCollector),this._worker=worker,this.SEND_INTERVAL=5e3,this.stopped=!0,this._entropyCache=[],this._mouse=function(e){var value=e.clientX^e.clientY;_this._addEntropy(value,2,EntropySrc.mouse)},this._keyDown=function(e){var value=e.keyCode;_this._addEntropy(value,2,EntropySrc.key)},this._touch=function(e){var value=e.touches[0].clientX^e.touches[0].clientY;_this._addEntropy(value,2,EntropySrc.touch)},this._accelerometer=function(e){window.orientation&&"number"==typeof window.orientation&&_this._addEntropy(window.orientation,0,EntropySrc.accelerometer),e.accelerationIncludingGravity&&_this._addEntropy(e.accelerationIncludingGravity.x^e.accelerationIncludingGravity.y^e.accelerationIncludingGravity.z,2,EntropySrc.accelerometer)}}return _createClass(EntropyCollector,[{key:"_addEntropy",value:function(data,entropy,source){data&&this._entropyCache.push({source:source,entropy:entropy,data:data}),"undefined"!=typeof window&&window.performance&&"function"==typeof window.performance.now?this._entropyCache.push({source:EntropySrc.time,entropy:2,data:window.performance.now()}):this._entropyCache.push({source:EntropySrc.time,entropy:2,data:(new Date).valueOf()})}},{key:"start",value:function(){var _this2=this;if(window.performance&&window.performance.timing){var values=window.performance.timing,added=[];for(var v in values)"number"==typeof values[v]&&0!==values[v]&&-1===added.indexOf(values[v])&&(this._addEntropy(values[v],1,EntropySrc.static),added.push(values[v]))}window.addEventListener("mousemove",this._mouse),window.addEventListener("click",this._mouse),window.addEventListener("touchstart",this._touch),window.addEventListener("touchmove",this._touch),window.addEventListener("keydown",this._keyDown),window.addEventListener("devicemotion",this._accelerometer),setInterval(function(){return _this2._sendEntropyToWorker()},this.SEND_INTERVAL),this.stopped=!1}},{key:"getInitialEntropy",value:function(){this._addNativeRandomValues(16);var cache=this._entropyCache;return this._entropyCache=[],cache}},{key:"_addNativeRandomValues",value:function(nbrOf32BitValues){var valueList=new Uint32Array(nbrOf32BitValues);("undefined"!=typeof crypto?crypto:msCrypto).getRandomValues(valueList);for(var i=0;i<valueList.length;i++)this._addEntropy(valueList[i],32,EntropySrc.random)}},{key:"_sendEntropyToWorker",value:function(){this._entropyCache.length>0&&(this._addNativeRandomValues(1),this._worker.entropy(this._entropyCache),this._entropyCache=[])}},{key:"stop",value:function(){this.stopped=!0,window.removeEventListener("mousemove",this._mouse),window.removeEventListener("mouseclick",this._mouse),window.removeEventListener("touchstart",this._touch),window.removeEventListener("touchmove",this._touch),window.removeEventListener("keydown",this._keyDown),window.removeEventListener("devicemotion",this._accelerometer)}}]),EntropyCollector}()),_export("EntropyCollector",EntropyCollector)}}}),System.register("src/search/SearchModel.js",["node_modules/systemjs-plugin-babel/babel-helpers/slicedToArray.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril/stream/stream.js","../api/main/WorkerClient","../api/common/EntityFunctions","../api/entities/tutanota/Mail","../api/Env","../api/common/TutanotaConstants","../api/common/error/DbError"],function(_export,_context){"use strict";var _slicedToArray,_classCallCheck,_createClass,stream,worker,isSameTypeRef,MailTypeRef,assertMainOrNode,NOTHING_INDEXED_TIMESTAMP,DbError,SearchModel;return _export("hasMoreResults",function(searchResult){return searchResult.moreResults.length>0||searchResult.lastReadSearchIndexRow.length>0&&searchResult.lastReadSearchIndexRow.every(function(_ref){var _ref2=_slicedToArray(_ref,2);return _ref2[0],0!==_ref2[1]})}),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs){_slicedToArray=_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonEntityFunctions){isSameTypeRef=_apiCommonEntityFunctions.isSameTypeRef},function(_apiEntitiesTutanotaMail){MailTypeRef=_apiEntitiesTutanotaMail.MailTypeRef},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_apiCommonTutanotaConstants){NOTHING_INDEXED_TIMESTAMP=_apiCommonTutanotaConstants.NOTHING_INDEXED_TIMESTAMP},function(_apiCommonErrorDbError){DbError=_apiCommonErrorDbError.DbError}],execute:function(){assertMainOrNode(),_export("SearchModel",SearchModel=function(){function SearchModel(){_classCallCheck(this,SearchModel),this.result=stream(),this.lastQuery=stream(""),this.indexingSupported=!0,this.indexState=stream({initializing:!0,mailIndexEnabled:!1,progress:0,currentMailIndexTimestamp:NOTHING_INDEXED_TIMESTAMP,indexedMailCount:0,failedIndexingUpTo:null})}return _createClass(SearchModel,[{key:"search",value:function(query,restriction,minSuggestionCount,maxResults){var _this=this;this.lastQuery(query);var result=this.result();if(result&&!isSameTypeRef(restriction.type,result.restriction.type)?this.result(null):this.indexState().progress>0&&result&&isSameTypeRef(MailTypeRef,result.restriction.type)&&this.result(null),""===query.trim()){var _result={query:query,restriction:restriction,results:[],currentIndexTimestamp:this.indexState().currentMailIndexTimestamp,lastReadSearchIndexRow:[],maxResults:0,matchWordOrder:!1,moreResults:[]};return this.result(_result),Promise.resolve(_result)}return worker.search(query,restriction,minSuggestionCount,maxResults).then(function(result){return _this.result(result),result}).catch(DbError,function(e){if(console.log("DBError while search",e),!isSameTypeRef(MailTypeRef,restriction.type)||_this.indexState().mailIndexEnabled)throw e;console.log("Mail indexing was disabled, ignoring DBError"),_this.result(null)})}},{key:"isNewSearch",value:function(query,restriction){var result=this.result();return null==result||(query!==result.query||result.restriction!==restriction&&(!isSameTypeRef(restriction.type,result.restriction.type)||restriction.start!==result.restriction.start||restriction.end!==result.restriction.end||restriction.field!==result.restriction.field||restriction.listId!==result.restriction.listId))}}]),SearchModel}()),_export("SearchModel",SearchModel)}}}),System.register("src/api/main/MainLocator.js",["./EventController","./EntropyCollector","../../search/SearchModel","../Env","./LoginController"],function(_export,_context){"use strict";var EventController,EntropyCollector,SearchModel,assertMainOrNode,logins,locator;return _export("initLocator",function(worker){locator.eventController=new EventController(logins),locator.entropyCollector=new EntropyCollector(worker),locator.search=new SearchModel}),{setters:[function(_EventController){EventController=_EventController.EventController},function(_EntropyCollector){EntropyCollector=_EntropyCollector.EntropyCollector},function(_searchSearchModel){SearchModel=_searchSearchModel.SearchModel},function(_Env){assertMainOrNode=_Env.assertMainOrNode},function(_LoginController){logins=_LoginController.logins}],execute:function(){assertMainOrNode(),_export("locator",locator={}),_export("locator",locator),"undefined"!=typeof window&&(window.tutao.locator=locator)}}}),System.register("src/api/main/WorkerClient.js",["node_modules/systemjs-plugin-babel/babel-helpers/slicedToArray.js","node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","../common/error/CryptoError","../common/WorkerProtocol","../main/UserController","../common/EntityFunctions","../Env","../entities/tutanota/TutanotaProperties","./Entity","../../native/NativeWrapper","./LoginController","./MainLocator","../../misc/ClientDetector","../common/utils/Utils","mithril/stream/stream.js","../entities/tutanota/UserSettingsGroupRoot","../common/error/RestError","../../misc/ErrorHandler"],function(_export,_context){"use strict";var _slicedToArray,_classCallCheck,_createClass,CryptoError,objToError,Queue,Request,UserController,assertMainOrNode,isMain,TutanotaPropertiesTypeRef,load,loadRoot,setup,nativeApp,logins,initLocator,locator,client,downcast,identity,stream,createUserSettingsGroupRoot,UserSettingsGroupRootTypeRef,NotFoundError,handleUncaughtError,WorkerClient,worker;return{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs){_slicedToArray=_node_modulesSystemjsPluginBabelBabelHelpersSlicedToArrayJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_commonErrorCryptoError){CryptoError=_commonErrorCryptoError.CryptoError},function(_commonWorkerProtocol){objToError=_commonWorkerProtocol.objToError,Queue=_commonWorkerProtocol.Queue,Request=_commonWorkerProtocol.Request},function(_mainUserController){UserController=_mainUserController.UserController},function(_commonEntityFunctions){_commonEntityFunctions.TypeRef},function(_Env){assertMainOrNode=_Env.assertMainOrNode,isMain=_Env.isMain},function(_entitiesTutanotaTutanotaProperties){TutanotaPropertiesTypeRef=_entitiesTutanotaTutanotaProperties.TutanotaPropertiesTypeRef},function(_Entity){load=_Entity.load,loadRoot=_Entity.loadRoot,setup=_Entity.setup},function(_nativeNativeWrapper){nativeApp=_nativeNativeWrapper.nativeApp},function(_LoginController){logins=_LoginController.logins},function(_MainLocator){initLocator=_MainLocator.initLocator,locator=_MainLocator.locator},function(_miscClientDetector){client=_miscClientDetector.client},function(_commonUtilsUtils){downcast=_commonUtilsUtils.downcast,identity=_commonUtilsUtils.identity},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_entitiesTutanotaUserSettingsGroupRoot){createUserSettingsGroupRoot=_entitiesTutanotaUserSettingsGroupRoot.createUserSettingsGroupRoot,UserSettingsGroupRootTypeRef=_entitiesTutanotaUserSettingsGroupRoot.UserSettingsGroupRootTypeRef},function(_commonErrorRestError){NotFoundError=_commonErrorRestError.NotFoundError},function(_miscErrorHandler){handleUncaughtError=_miscErrorHandler.handleUncaughtError}],execute:function(){assertMainOrNode(),_export("WorkerClient",WorkerClient=function(){function WorkerClient(){var _this=this;_classCallCheck(this,WorkerClient),this._wsConnection=stream("terminated"),this.infoMessages=stream(),initLocator(this),this._initWorker(),this.initialized.then(function(){_this._initServices()}),this._queue.setCommands({execNative:function(message){return nativeApp.invokeNative(new Request(downcast(message.args[0]),downcast(message.args[1])))},entityEvent:function(message){return locator.eventController.notificationReceived(downcast(message.args[0]),downcast(message.args[1])),Promise.resolve()},error:function(message){return handleUncaughtError(objToError(message.args[0])),Promise.resolve()},progress:function(message){return _this._progressUpdater&&_this._progressUpdater(message.args[0]),Promise.resolve()},updateIndexState:function(message){return locator.search.indexState(downcast(message.args[0])),Promise.resolve()},updateWebSocketState:function(message){return _this._wsConnection(downcast(message.args[0])),Promise.resolve()},counterUpdate:function(message){return locator.eventController.counterUpdateReceived(downcast(message.args[0])),Promise.resolve()},infoMessage:function(message){return _this.infoMessages(downcast(message.args[0])),Promise.resolve()}})}return _createClass(WorkerClient,[{key:"_initWorker",value:function(){var _this2=this;if("undefined"!=typeof Worker){var _worker=null;if(env.dist)_worker=new Worker(System.getConfig().baseURL+"WorkerBootstrap.js");else{var url=System.normalizeSync("undefined"!=typeof module?module.id:_context.id),workerUrl=url.substring(0,url.lastIndexOf("/"))+"/../worker/WorkerBootstrap.js";_worker=new Worker(workerUrl)}this._queue=new Queue(_worker),window.env.systemConfig.baseURL=System.getConfig().baseURL,window.env.systemConfig.map=System.getConfig().map;var start=(new Date).getTime();this.initialized=this._queue.postMessage(new Request("setup",[window.env,locator.entropyCollector.getInitialEntropy(),client.browserData()])).then(function(){return console.log("worker init time (ms):",(new Date).getTime()-start)}),_worker.onerror=function(e){throw new CryptoError("could not setup worker",e)}}else{var workerImpl=new(require("./../worker/WorkerImpl.js").WorkerImpl)(this,!0,client.browserData());workerImpl._queue._transport={postMessage:function(msg){return _this2._queue._handleMessage(msg)}},this._queue=new Queue({postMessage:function(msg){workerImpl._queue._handleMessage(msg)}}),this.initialized=Promise.resolve()}}},{key:"_initServices",value:function(){isMain()&&locator.entropyCollector.start(),nativeApp.init()}},{key:"generateSignupKeys",value:function(){var _this3=this,_arguments=arguments;return this.initialized.then(function(){return _this3._postRequest(new Request("generateSignupKeys",_arguments))})}},{key:"signup",value:function(keyPairs,accountType,authToken,mailAddress,password,registrationCode,currentLanguage){var _this4=this,_arguments2=arguments;return this.initialized.then(function(){return _this4._postRequest(new Request("signup",_arguments2))})}},{key:"createContactFormUserGroupData",value:function(){var _this5=this,_arguments3=arguments;return this.initialized.then(function(){return _this5._postRequest(new Request("createContactFormUserGroupData",_arguments3))})}},{key:"createContactFormUser",value:function(password,contactFormId,statisticFields){var _this6=this,_arguments4=arguments;return this.initialized.then(function(){return _this6._postRequest(new Request("createContactFormUser",_arguments4))})}},{key:"createWorkerSession",value:function(username,password,clientIdentifier,persistentSession,permanentLogin){var _this7=this,_arguments5=arguments;return this.initialized.then(function(){return _this7._postRequest(new Request("createSession",_arguments5))})}},{key:"createSession",value:function(username,password,clientIdentifier,persistentSession,permanentLogin){var _this8=this;return this.createWorkerSession(username,password,clientIdentifier,persistentSession,permanentLogin).then(function(loginData){return _this8._initUserController(loginData.user,loginData.userGroupInfo,loginData.sessionId,loginData.credentials.accessToken,persistentSession).then(function(){return loginData.credentials})})}},{key:"_initUserController",value:function(user,userGroupInfo,sessionId,accessToken,persistentSession){return Promise.all([loadRoot(TutanotaPropertiesTypeRef,user.userGroup.group),load(UserSettingsGroupRootTypeRef,user.userGroup.group).catch(NotFoundError,function(){return setup(null,Object.assign(createUserSettingsGroupRoot(),{_ownerGroup:user.userGroup.group})).then(function(){return load(UserSettingsGroupRootTypeRef,user.userGroup.group)})})]).then(function(_ref){var _ref2=_slicedToArray(_ref,2),props=_ref2[0],userSettingsGroupRoot=_ref2[1];logins.setUserController(new UserController(user,userGroupInfo,sessionId,props,accessToken,persistentSession,userSettingsGroupRoot))})}},{key:"loadExternalPasswordChannels",value:function(userId,salt){var _this9=this,_arguments6=arguments;return this.initialized.then(function(){return _this9._postRequest(new Request("loadExternalPasswordChannels",_arguments6))})}},{key:"sendExternalPasswordSms",value:function(userId,salt,phoneNumberId,languageCode,symKeyForPasswordTransmission){return this._postRequest(new Request("sendExternalPasswordSms",arguments))}},{key:"createExternalSession",value:function(userId,password,salt,clientIdentifier,persistentSession){var _this10=this,_arguments7=arguments;return this.initialized.then(function(){return _this10._postRequest(new Request("createExternalSession",_arguments7)).then(function(loginData){return _this10._initUserController(loginData.user,loginData.userGroupInfo,loginData.sessionId,loginData.credentials.accessToken,persistentSession).then(function(){return loginData.credentials})})})}},{key:"resumeSession",value:function(credentials,externalUserSalt){var _this11=this;return this._postRequest(new Request("resumeSession",arguments)).then(function(loginData){return _this11._initUserController(loginData.user,loginData.userGroupInfo,loginData.sessionId,credentials.accessToken,!0)})}},{key:"deleteSession",value:function(accessToken){return this._postRequest(new Request("deleteSession",arguments))}},{key:"changePassword",value:function(oldPassword,newPassword){return this._postRequest(new Request("changePassword",arguments))}},{key:"deleteAccount",value:function(password,reason,takeover){return this._postRequest(new Request("deleteAccount",arguments))}},{key:"createMailFolder",value:function(name,parent,ownerGroupId){return this._postRequest(new Request("createMailFolder",arguments))}},{key:"createMailDraft",value:function(subject,body,senderAddress,senderName,toRecipients,ccRecipients,bccRecipients,conversationType,previousMessageId,attachments,confidential,replyTos){return this._postRequest(new Request("createMailDraft",arguments))}},{key:"updateMailDraft",value:function(subject,body,senderAddress,senderName,toRecipients,ccRecipients,bccRecipients,attachments,confidential,draft){return this._postRequest(new Request("updateMailDraft",arguments))}},{key:"sendMailDraft",value:function(draft,recipientInfos,language){return this._postRequest(new Request("sendMailDraft",arguments))}},{key:"downloadFileContent",value:function(file){return this._postRequest(new Request("downloadFileContent",arguments))}},{key:"downloadFileContentNative",value:function(file){return this._postRequest(new Request("downloadFileContentNative",arguments))}},{key:"changeUserPassword",value:function(user,newPassword){return this._postRequest(new Request("changeUserPassword",arguments))}},{key:"changeAdminFlag",value:function(user,admin){return this._postRequest(new Request("changeAdminFlag",arguments))}},{key:"updateAdminship",value:function(groupId,newAdminGroupId){return this._postRequest(new Request("updateAdminship",arguments))}},{key:"switchFreeToPremiumGroup",value:function(){return this._postRequest(new Request("switchFreeToPremiumGroup",arguments))}},{key:"switchPremiumToFreeGroup",value:function(){return this._postRequest(new Request("switchPremiumToFreeGroup",arguments))}},{key:"updatePaymentData",value:function(businessUse,paymentInterval,invoiceData,paymentData,confirmedInvoiceCountry){return this._postRequest(new Request("updatePaymentData",arguments))}},{key:"downloadInvoice",value:function(invoiceNumber){return this._postRequest(new Request("downloadInvoice",arguments))}},{key:"readUsedUserStorage",value:function(user){return this._postRequest(new Request("readUsedUserStorage",arguments))}},{key:"readUsedGroupStorage",value:function(groupId){return this._postRequest(new Request("readUsedGroupStorage",arguments))}},{key:"deleteUser",value:function(user,restore){return this._postRequest(new Request("deleteUser",arguments))}},{key:"createMailGroup",value:function(name,mailAddress){return this._postRequest(new Request("createMailGroup",arguments))}},{key:"createLocalAdminGroup",value:function(name){return this._postRequest(new Request("createLocalAdminGroup",arguments))}},{key:"getPrice",value:function(type,count,reactivate){return this._postRequest(new Request("getPrice",arguments))}},{key:"getCurrentPrice",value:function(){return this._postRequest(new Request("getCurrentPrice",arguments))}},{key:"tryReconnectEventBus",value:function(closeIfOpen,enableAutomaticState){var delay=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this._postRequest(new Request("tryReconnectEventBus",[closeIfOpen,enableAutomaticState,delay]))}},{key:"readUsedCustomerStorage",value:function(){return this._postRequest(new Request("readUsedCustomerStorage",[logins.getUserController().user.customer]))}},{key:"readAvailableCustomerStorage",value:function(){return this._postRequest(new Request("readAvailableCustomerStorage",[logins.getUserController().user.customer]))}},{key:"addMailAlias",value:function(groupId,alias){return this._postRequest(new Request("addMailAlias",arguments))}},{key:"setMailAliasStatus",value:function(groupId,alias,restore){return this._postRequest(new Request("setMailAliasStatus",arguments))}},{key:"isMailAddressAvailable",value:function(mailAddress){return this._postRequest(new Request("isMailAddressAvailable",arguments))}},{key:"getAliasCounters",value:function(){return this._postRequest(new Request("getAliasCounters",arguments))}},{key:"loadCustomerServerProperties",value:function(){return this._postRequest(new Request("loadCustomerServerProperties",arguments))}},{key:"addSpamRule",value:function(field,type,value){return this._postRequest(new Request("addSpamRule",[field,type,value]))}},{key:"editSpamRule",value:function(spamRule){return this._postRequest(new Request("editSpamRule",[spamRule]))}},{key:"createUser",value:function(name,mailAddress,password,userIndex,overallNbrOfUsersToCreate){return this._postRequest(new Request("createUser",arguments))}},{key:"addUserToGroup",value:function(user,groupId){return this._postRequest(new Request("addUserToGroup",arguments))}},{key:"removeUserFromGroup",value:function(userId,groupId){return this._postRequest(new Request("removeUserFromGroup",arguments))}},{key:"deactivateGroup",value:function(group,restore){return this._postRequest(new Request("deactivateGroup",arguments))}},{key:"loadContactFormByPath",value:function(formId){return this._postRequest(new Request("loadContactFormByPath",arguments))}},{key:"restRequest",value:function(path,method,queryParams,headers,body,responseType,progressListener){return this._postRequest(new Request("restRequest",Array.from(arguments)))}},{key:"addDomain",value:function(domainName){return this._postRequest(new Request("addDomain",arguments))}},{key:"removeDomain",value:function(domainName){return this._postRequest(new Request("removeDomain",arguments))}},{key:"setCatchAllGroup",value:function(domainName,mailGroupId){return this._postRequest(new Request("setCatchAllGroup",arguments))}},{key:"uploadCertificate",value:function(domainName,pemCertificateChain,pemPrivateKey){return this._postRequest(new Request("uploadCertificate",arguments))}},{key:"deleteCertificate",value:function(domainName){return this._postRequest(new Request("deleteCertificate",arguments))}},{key:"generateTotpSecret",value:function(){return this._postRequest(new Request("generateTotpSecret",arguments))}},{key:"generateTotpCode",value:function(time,key){return this._postRequest(new Request("generateTotpCode",arguments))}},{key:"search",value:function(searchString,restriction,minSuggestionCount,maxResults){return this._postRequest(new Request("search",arguments))}},{key:"enableMailIndexing",value:function(){return this._postRequest(new Request("enableMailIndexing",arguments))}},{key:"disableMailIndexing",value:function(){return this._postRequest(new Request("disableMailIndexing",arguments))}},{key:"extendMailIndex",value:function(newEndTimestamp){return this._postRequest(new Request("extendMailIndex",arguments))}},{key:"cancelMailIndexing",value:function(){return this._postRequest(new Request("cancelMailIndexing",arguments))}},{key:"readCounterValue",value:function(monitorValue,ownerId){return this._postRequest(new Request("readCounterValue",arguments))}},{key:"cancelCreateSession",value:function(){return this._postRequest(new Request("cancelCreateSession",[]))}},{key:"resolveSessionKey",value:function(typeModel,instance){return this._postRequest(new Request("resolveSessionKey",arguments))}},{key:"entityRequest",value:function(typeRef,method,listId,id,entity,queryParameter){return this._postRequest(new Request("entityRequest",Array.from(arguments)))}},{key:"entityEventsReceived",value:function(data){throw new Error("must not be used")}},{key:"serviceRequest",value:function(service,method,requestEntity,responseTypeRef,queryParameter,sk){return this._postRequest(new Request("serviceRequest",Array.from(arguments)))}},{key:"entropy",value:function(_entropy){function entropy(_x){return _entropy.apply(this,arguments)}return entropy.toString=function(){return _entropy.toString()},entropy}(function(entropyCache){return this._postRequest(new Request("entropy",Array.from(arguments)))})},{key:"_postRequest",value:function(msg){if(!this.initialized.isFulfilled())throw new Error("worker has not been initialized, request: "+JSON.stringify(msg));return this._queue.postMessage(msg)}},{key:"registerProgressUpdater",value:function(updater){this._progressUpdater=updater}},{key:"unregisterProgressUpdater",value:function(updater){this._progressUpdater===updater&&(this._progressUpdater=null)}},{key:"generateSsePushIdentifer",value:function(){return this._postRequest(new Request("generateSsePushIdentifer",arguments))}},{key:"decryptUserPassword",value:function(userId,deviceToken,encryptedPassword){return this._postRequest(new Request("decryptUserPassword",arguments))}},{key:"wsConnection",value:function(){return this._wsConnection.map(identity)}},{key:"closeEventBus",value:function(closeOption){return this._queue.postMessage(new Request("closeEventBus",[closeOption]))}},{key:"getMoreSearchResults",value:function(existingResult,moreResultCount){return this._queue.postMessage(new Request("getMoreSearchResults",[existingResult,moreResultCount]))}},{key:"getRecoveryCode",value:function(password){return this._queue.postMessage(new Request("getRecoveryCode",[password]))}},{key:"createRecoveryCode",value:function(password){return this._queue.postMessage(new Request("createRecoveryCode",[password]))}},{key:"recoverLogin",value:function(emailAddress,recoverCode,newPassword,clientIdentifier){return this._queue.postMessage(new Request("recoverLogin",[emailAddress,recoverCode,newPassword,clientIdentifier]))}},{key:"resetSecondFactors",value:function(mailAddress,password,recoverCode){return this._queue.postMessage(new Request("resetSecondFactors",[mailAddress,password,recoverCode]))}},{key:"resetSession",value:function(){return this._queue.postMessage(new Request("resetSession",[]))}},{key:"reset",value:function(){return this._postRequest(new Request("reset",[]))}},{key:"createCalendarEvent",value:function(event,alarmInfo,oldEvent){return this._queue.postMessage(new Request("createCalendarEvent",[event,alarmInfo,oldEvent]))}},{key:"updateCalendarEvent",value:function(event,alarmInfo,oldEvent){return this._queue.postMessage(new Request("updateCalendarEvent",[event,alarmInfo,oldEvent]))}},{key:"addCalendar",value:function(name){return this._queue.postMessage(new Request("addCalendar",[name])).then(function(_ref3){var user=_ref3.user,group=_ref3.group;return logins.getUserController().user=user,group})}},{key:"scheduleAlarmsForNewDevice",value:function(pushIdentifier){return this._queue.postMessage(new Request("scheduleAlarmsForNewDevice",[pushIdentifier]))}},{key:"loadAlarmEvents",value:function(){return this._queue.postMessage(new Request("loadAlarmEvents",[]))}},{key:"getDomainValidationRecord",value:function(){return this._queue.postMessage(new Request("getDomainValidationRecord",[]))}},{key:"notifyVisiblityChange",value:function(visible){return this._queue.postMessage(new Request("visibilityChange",[visible]))}},{key:"getLog",value:function(){return this._queue.postMessage(new Request("getLog",[]))}},{key:"sendGroupInvitation",value:function(sharedGroupInfo,sharedGroupName,recipients,shareCapability){return this._queue.postMessage(new Request("sendGroupInvitation",[sharedGroupInfo,sharedGroupName,recipients,shareCapability]))}},{key:"acceptGroupInvitation",value:function(invitation){return this._queue.postMessage(new Request("acceptGroupInvitation",[invitation]))}},{key:"rejectGroupInvitation",value:function(receivedGroupInvitaitonId){return this._queue.postMessage(new Request("rejectGroupInvitation",[receivedGroupInvitaitonId]))}}]),WorkerClient}()),_export("WorkerClient",WorkerClient),_export("worker",worker=new WorkerClient),_export("worker",worker)}}}),System.register("src/gui/base/ProgressDialog.js",["mithril","../../api/Env","./Dialog","../animation/Animations","../../misc/LanguageViewModel","./Icon","./PasswordIndicator","mithril/stream/stream.js","../../api/main/WorkerClient","../../api/common/TutanotaConstants"],function(_export,_context){"use strict";var m,assertMainOrNode,isAdminClient,Dialog,DialogType,DefaultAnimationTime,lang,progressIcon,PasswordIndicator,stream,worker,TabIndex;function showProgressDialog(messageIdOrMessageFunction,action,progress){var progressStream=progress,progressIndicator=null;progressStream&&(progressIndicator=new PasswordIndicator(function(){return progressStream()}),progressStream.map(function(){return m.redraw()}));var progressDialog=new Dialog(DialogType.Progress,{view:function(){return m(".hide-outline",{tabindex:TabIndex.Default,oncreate:function(vnode){setTimeout(function(){vnode.dom.focus()},10)}},[m(".flex-center",progressIndicator?m(progressIndicator):progressIcon()),m("p#dialog-title",lang.getMaybeLazy(messageIdOrMessageFunction))])}}).setCloseHandler(function(){});progressDialog.show();var start=(new Date).getTime(),minDialogVisibilityMillis=isAdminClient()?0:1e3;return Promise.fromCallback(function(cb){action.then(function(result){var diff=(new Date).getTime()-start;setTimeout(function(){progressDialog.close(),setTimeout(function(){return cb(null,result)},DefaultAnimationTime)},Math.max(minDialogVisibilityMillis-diff,0))}).catch(function(e){var diff=(new Date).getTime()-start;setTimeout(function(){progressDialog.close(),setTimeout(function(){return cb(e)},DefaultAnimationTime)},Math.max(minDialogVisibilityMillis-diff,0))})})}return _export("showProgressDialog",showProgressDialog),_export("showWorkerProgressDialog",function(messageIdOrMessageFunction,action){var progress=stream(0);return worker.registerProgressUpdater(progress),showProgressDialog(messageIdOrMessageFunction,action,progress).finally(function(){worker.unregisterProgressUpdater(progress)})}),{setters:[function(_mithril){m=_mithril.default},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode,isAdminClient=_apiEnv.isAdminClient},function(_Dialog){Dialog=_Dialog.Dialog,DialogType=_Dialog.DialogType},function(_animationAnimations){DefaultAnimationTime=_animationAnimations.DefaultAnimationTime},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_Icon){progressIcon=_Icon.progressIcon},function(_PasswordIndicator){PasswordIndicator=_PasswordIndicator.PasswordIndicator},function(_mithrilStreamStreamJs){stream=_mithrilStreamStreamJs.default},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_apiCommonTutanotaConstants){TabIndex=_apiCommonTutanotaConstants.TabIndex}],execute:function(){assertMainOrNode()}}}),System.register("src/settings/AddUserDialog.js",["mithril","../misc/LanguageViewModel","../api/Env","../gui/base/TextField","../api/common/TutanotaConstants","../gui/base/Dialog","../api/main/LoginController","./PasswordForm","./SelectMailAddressForm","../api/main/Entity","../api/entities/sys/Customer","../api/entities/sys/CustomerInfo","../api/common/utils/ArrayUtils","../api/common/utils/Utils","../subscription/BuyDialog","../api/main/WorkerClient","../gui/base/ProgressDialog"],function(_export,_context){"use strict";var m,lang,assertMainOrNode,TextField,AccountType,BookingItemFeatureType,TUTANOTA_MAIL_ADDRESS_DOMAINS,Dialog,logins,PasswordForm,SelectMailAddressForm,load,CustomerTypeRef,CustomerInfoTypeRef,addAll,getCustomMailDomains,neverNull,BuyDialog,worker,showProgressDialog,showWorkerProgressDialog;function getAvailableDomains(onlyCustomDomains){return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerInfoTypeRef,customer.customerInfo).then(function(customerInfo){var availableDomains=getCustomMailDomains(customerInfo).map(function(info){return info.domain});return onlyCustomDomains||logins.getUserController().user.accountType===AccountType.STARTER||0!==availableDomains.length&&!logins.getUserController().isGlobalAdmin()||addAll(availableDomains,TUTANOTA_MAIL_ADDRESS_DOMAINS),availableDomains})})}return _export("show",function(){return getAvailableDomains().then(function(availableDomains){var nameField=new TextField("name_label",function(){return lang.get("loginNameInfoAdmin_msg")}),passwordForm=new PasswordForm(!1,!1,!1,null),mailAddressForm=new SelectMailAddressForm(availableDomains),form={view:function(){return[m(nameField),m(mailAddressForm),m(passwordForm)]}};Dialog.showActionDialog({title:lang.get("addUsers_action"),child:form,validator:function(){return mailAddressForm.getErrorMessageId()||passwordForm.getErrorMessageId()},okAction:function(dialog){showProgressDialog("pleaseWait_msg",BuyDialog.show(BookingItemFeatureType.Users,1,0,!1)).then(function(accepted){if(accepted){var p=worker.createUser(nameField.value(),mailAddressForm.getCleanMailAddress(),passwordForm.getNewPassword(),0,1);showWorkerProgressDialog(function(){return lang.get("createActionStatus_msg",{"{index}":0,"{count}":1})},p).then(dialog.close())}})}})})}),_export("getAvailableDomains",getAvailableDomains),{setters:[function(_mithril){m=_mithril.default},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_guiBaseTextField){TextField=_guiBaseTextField.TextField},function(_apiCommonTutanotaConstants){AccountType=_apiCommonTutanotaConstants.AccountType,BookingItemFeatureType=_apiCommonTutanotaConstants.BookingItemFeatureType,TUTANOTA_MAIL_ADDRESS_DOMAINS=_apiCommonTutanotaConstants.TUTANOTA_MAIL_ADDRESS_DOMAINS},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_PasswordForm){PasswordForm=_PasswordForm.PasswordForm},function(_SelectMailAddressForm){SelectMailAddressForm=_SelectMailAddressForm.SelectMailAddressForm},function(_apiMainEntity){load=_apiMainEntity.load},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_apiCommonUtilsArrayUtils){addAll=_apiCommonUtilsArrayUtils.addAll},function(_apiCommonUtilsUtils){getCustomMailDomains=_apiCommonUtilsUtils.getCustomMailDomains,neverNull=_apiCommonUtilsUtils.neverNull},function(_subscriptionBuyDialog){BuyDialog=_subscriptionBuyDialog},function(_apiMainWorkerClient){worker=_apiMainWorkerClient.worker},function(_guiBaseProgressDialog){showProgressDialog=_guiBaseProgressDialog.showProgressDialog,showWorkerProgressDialog=_guiBaseProgressDialog.showWorkerProgressDialog}],execute:function(){assertMainOrNode()}}}),System.register("src/settings/ContactFormListView.js",["node_modules/systemjs-plugin-babel/babel-helpers/classCallCheck.js","node_modules/systemjs-plugin-babel/babel-helpers/createClass.js","mithril","../gui/base/List","../api/main/Entity","../api/common/EntityFunctions","../api/Env","../misc/LanguageViewModel","../api/common/error/RestError","../gui/size","./SettingsView","../api/common/utils/LazyLoaded","./ContactFormViewer","./ContactFormEditor","../api/entities/tutanota/ContactForm","../api/common/utils/Utils","../api/entities/sys/Customer","../api/entities/sys/CustomerInfo","../api/main/LoginController","../gui/base/Dialog","../api/common/TutanotaConstants","../gui/base/Icon","../gui/base/icons/Icons","../api/entities/tutanota/CustomerContactFormGroupRoot","../contacts/ContactFormUtils","../api/main/EventController","../gui/base/ButtonN","../misc/ErrorHandlerImpl","./AddUserDialog"],function(_export,_context){"use strict";var _classCallCheck,_createClass,m,List,load,loadAll,GENERATED_MAX_ID,isSameId,assertMainOrNode,lang,NotFoundError,size,LazyLoaded,ContactFormViewer,getContactFormUrl,ContactFormEditor,ContactFormTypeRef,getWhitelabelDomain,neverNull,CustomerTypeRef,CustomerInfoTypeRef,logins,Dialog,OperationType,Icon,Icons,CustomerContactFormGroupRootTypeRef,getAdministratedGroupIds,getDefaultContactFormLanguage,isUpdateForTypeRef,ButtonN,ButtonType,showNotAvailableForFreeDialog,className,ContactFormListView,ContactFormRow;function filterContactFormsForLocalAdmin(contactForms){return logins.getUserController().isGlobalAdmin()?Promise.resolve(contactForms):getAdministratedGroupIds().then(function(allAdministratedGroupIds){return contactForms.filter(function(cf){return-1!==allAdministratedGroupIds.indexOf(cf.targetGroup)})})}return _export("filterContactFormsForLocalAdmin",filterContactFormsForLocalAdmin),{setters:[function(_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs){_classCallCheck=_node_modulesSystemjsPluginBabelBabelHelpersClassCallCheckJs.default},function(_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs){_createClass=_node_modulesSystemjsPluginBabelBabelHelpersCreateClassJs.default},function(_mithril){m=_mithril.default},function(_guiBaseList){List=_guiBaseList.List},function(_apiMainEntity){load=_apiMainEntity.load,loadAll=_apiMainEntity.loadAll},function(_apiCommonEntityFunctions){GENERATED_MAX_ID=_apiCommonEntityFunctions.GENERATED_MAX_ID,isSameId=_apiCommonEntityFunctions.isSameId},function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode},function(_miscLanguageViewModel){lang=_miscLanguageViewModel.lang},function(_apiCommonErrorRestError){NotFoundError=_apiCommonErrorRestError.NotFoundError},function(_guiSize){size=_guiSize.size},function(_SettingsView){_SettingsView.SettingsView},function(_apiCommonUtilsLazyLoaded){LazyLoaded=_apiCommonUtilsLazyLoaded.LazyLoaded},function(_ContactFormViewer){ContactFormViewer=_ContactFormViewer.ContactFormViewer,getContactFormUrl=_ContactFormViewer.getContactFormUrl},function(_ContactFormEditor){ContactFormEditor=_ContactFormEditor},function(_apiEntitiesTutanotaContactForm){ContactFormTypeRef=_apiEntitiesTutanotaContactForm.ContactFormTypeRef},function(_apiCommonUtilsUtils){getWhitelabelDomain=_apiCommonUtilsUtils.getWhitelabelDomain,neverNull=_apiCommonUtilsUtils.neverNull},function(_apiEntitiesSysCustomer){CustomerTypeRef=_apiEntitiesSysCustomer.CustomerTypeRef},function(_apiEntitiesSysCustomerInfo){CustomerInfoTypeRef=_apiEntitiesSysCustomerInfo.CustomerInfoTypeRef},function(_apiMainLoginController){logins=_apiMainLoginController.logins},function(_guiBaseDialog){Dialog=_guiBaseDialog.Dialog},function(_apiCommonTutanotaConstants){OperationType=_apiCommonTutanotaConstants.OperationType},function(_guiBaseIcon){Icon=_guiBaseIcon.Icon},function(_guiBaseIconsIcons){Icons=_guiBaseIconsIcons.Icons},function(_apiEntitiesTutanotaCustomerContactFormGroupRoot){CustomerContactFormGroupRootTypeRef=_apiEntitiesTutanotaCustomerContactFormGroupRoot.CustomerContactFormGroupRootTypeRef},function(_contactsContactFormUtils){getAdministratedGroupIds=_contactsContactFormUtils.getAdministratedGroupIds,getDefaultContactFormLanguage=_contactsContactFormUtils.getDefaultContactFormLanguage},function(_apiMainEventController){isUpdateForTypeRef=_apiMainEventController.isUpdateForTypeRef},function(_guiBaseButtonN){ButtonN=_guiBaseButtonN.ButtonN,ButtonType=_guiBaseButtonN.ButtonType},function(_miscErrorHandlerImpl){showNotAvailableForFreeDialog=_miscErrorHandlerImpl.showNotAvailableForFreeDialog},function(_AddUserDialog){_AddUserDialog}],execute:function(){assertMainOrNode(),className="group-list",_export("ContactFormListView",ContactFormListView=function(){function ContactFormListView(settingsView){var _this=this;_classCallCheck(this,ContactFormListView),this._settingsView=settingsView,this._listId=new LazyLoaded(function(){return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerContactFormGroupRootTypeRef,customer.customerGroup).then(function(root){return root.contactForms})})}),this._customerInfo=new LazyLoaded(function(){return load(CustomerTypeRef,neverNull(logins.getUserController().user.customer)).then(function(customer){return load(CustomerInfoTypeRef,customer.customerInfo)})}),this._customerInfo.getAsync(),this.list=new List({rowHeight:size.list_row_height,fetch:function(startId,count){if(startId===GENERATED_MAX_ID)return _this._listId.getAsync().then(function(listId){return loadAll(ContactFormTypeRef,listId).then(function(contactForms){return _this._setLoadedCompletely(),filterContactFormsForLocalAdmin(contactForms)})});throw new Error("fetch user group infos called for specific start id")},loadSingle:function(elementId){return _this._listId.getAsync().then(function(listId){return load(ContactFormTypeRef,[listId,elementId]).catch(NotFoundError,function(e){})})},sortCompare:function(a,b){return a.path.localeCompare(b.path)},elementSelected:function(entities,elementClicked,selectionChanged,multiSelectionActive){return _this.elementSelected(entities,elementClicked,selectionChanged,multiSelectionActive)},createVirtualRow:function(){return new ContactFormRow(_this._customerInfo)},showStatus:!1,className:className,swipe:{renderLeftSpacer:function(){return[]},renderRightSpacer:function(){return[]},swipeLeft:function(listElement){return Promise.resolve()},swipeRight:function(listElement){return Promise.resolve()}},elementsDraggable:!1,multiSelectionAllowed:!1,emptyMessage:lang.get("noEntries_msg")}),this.view=function(){return m(".flex.flex-column.fill-absolute",[m(".flex.flex-column.justify-center.plr-l.list-border-right.list-bg.list-header",m(".mr-negative-s.align-self-end",m(ButtonN,{label:"createContactForm_label",type:ButtonType.Primary,click:function(){return _this.addButtonClicked()}}))),m(".rel.flex-grow",m(_this.list))])},this.list.loadInitial()}return _createClass(ContactFormListView,[{key:"_setLoadedCompletely",value:function(){this.list.setLoadedCompletely()}},{key:"elementSelected",value:function(contactForms,elementClicked,selectionChanged,multiSelectOperation){var _this2=this;0===contactForms.length&&this._settingsView.detailsViewer?(this._settingsView.detailsViewer=null,m.redraw()):1===contactForms.length&&selectionChanged&&this._customerInfo.getAsync().then(function(customerInfo){var whitelabelDomain=getWhitelabelDomain(customerInfo);whitelabelDomain?(_this2._settingsView.detailsViewer=new ContactFormViewer(contactForms[0],whitelabelDomain.domain,function(contactFormId){return _this2.list.scrollToIdAndSelectWhenReceived(contactFormId)}),elementClicked&&_this2._settingsView.focusSettingsDetailsColumn(),m.redraw()):Dialog.error("whitelabelDomainNeeded_msg")})}},{key:"addButtonClicked",value:function(){var _this3=this;logins.getUserController().isFreeAccount()?showNotAvailableForFreeDialog(!1):ContactFormEditor.show(null,!0,function(contactFormId){return _this3.list.scrollToIdAndSelectWhenReceived(contactFormId)})}},{key:"entityEventsReceived",value:function(updates){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=updates[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var update=_step.value;this.processUpdate(update)}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator.return&&_iterator.return()}finally{if(_didIteratorError)throw _iteratorError}}}},{key:"processUpdate",value:function(update){var _this4=this,instanceListId=update.instanceListId,instanceId=update.instanceId,operation=update.operation;if(isUpdateForTypeRef(ContactFormTypeRef,update)&&this._listId.isLoaded()&&instanceListId===this._listId.getLoaded()){if(logins.getUserController().isGlobalAdmin()||update.operation===OperationType.DELETE)this.list.entityEventReceived(instanceId,operation);else{var listEntity=this.list.getEntity(instanceId);load(ContactFormTypeRef,[neverNull(instanceListId),instanceId]).then(function(cf){return getAdministratedGroupIds().then(function(allAdministratedGroupIds){listEntity?-1===allAdministratedGroupIds.indexOf(cf.targetGroup)?_this4.list.entityEventReceived(instanceId,OperationType.DELETE):_this4.list.entityEventReceived(instanceId,operation):-1!==allAdministratedGroupIds.indexOf(cf.targetGroup)&&_this4.list.entityEventReceived(instanceId,OperationType.CREATE)})})}this._customerInfo.isLoaded()&&getWhitelabelDomain(this._customerInfo.getLoaded())&&this._settingsView.detailsViewer&&operation===OperationType.UPDATE&&isSameId(this._settingsView.detailsViewer.contactForm._id,[neverNull(instanceListId),instanceId])&&load(ContactFormTypeRef,[neverNull(instanceListId),instanceId]).then(function(updatedContactForm){_this4._settingsView.detailsViewer=new ContactFormViewer(updatedContactForm,neverNull(getWhitelabelDomain(_this4._customerInfo.getLoaded())).domain,function(contactFormId){return _this4.list.scrollToIdAndSelectWhenReceived(contactFormId)}),m.redraw()})}else isUpdateForTypeRef(CustomerInfoTypeRef,update)&&this._customerInfo.isLoaded()&&isSameId(this._customerInfo.getLoaded()._id,[neverNull(instanceListId),instanceId])&&operation===OperationType.UPDATE?(this._customerInfo.reset(),this._customerInfo.getAsync()):isUpdateForTypeRef(CustomerTypeRef,update)&&this._customerInfo.isLoaded()&&operation===OperationType.UPDATE&&(this._customerInfo.reset(),this._customerInfo.getAsync())}}]),ContactFormListView}()),_export("ContactFormListView",ContactFormListView),_export("ContactFormRow",ContactFormRow=function(){function ContactFormRow(customerInfo){_classCallCheck(this,ContactFormRow),this.top=0,this.entity=null,this._customerInfo=customerInfo}return _createClass(ContactFormRow,[{key:"update",value:function(contactForm,selected){if(this.domElement&&(selected?this.domElement.classList.add("row-selected"):this.domElement.classList.remove("row-selected"),this._domPageTitle.textContent=getDefaultContactFormLanguage(contactForm.languages).pageTitle,this._customerInfo.isLoaded())){var whitelabelDomain=getWhitelabelDomain(this._customerInfo.getLoaded());whitelabelDomain&&(this._domUrl.textContent=getContactFormUrl(whitelabelDomain.domain,contactForm.path))}}},{key:"render",value:function(){var _this5=this;return[m(".top",[m(".name",{oncreate:function(vnode){return _this5._domPageTitle=vnode.dom}})]),m(".bottom.flex-space-between",[m("small.mail-address",{oncreate:function(vnode){return _this5._domUrl=vnode.dom}}),m(".icons.flex",[m(Icon,{icon:Icons.Trash,oncreate:function(vnode){return _this5._domDeletedIcon=vnode.dom},style:{display:"none"},class:"svg-list-accent-fg"})])])]}}]),ContactFormRow}()),_export("ContactFormRow",ContactFormRow)}}}),System.register("src/subscription/terms.js",["../api/Env"],function(_export,_context){"use strict";var assertMainOrNode;return{setters:[function(_apiEnv){assertMainOrNode=_apiEnv.assertMainOrNode}],execute:function(){assertMainOrNode(),_export("terms_de",'<section id="terms-de" class="content">\n    <h3>Allgemeine Geschäftsbedingungen (AGB) der Tutao GmbH</h3>\n    <h4>1. Allgemeines, Geltungsbereich</h4>\n    <p>1.1 Die Tutao GmbH, Adresse: Deisterstr. 17a, 30449 Hannover, E-Mail:\n        hello@tutao.de, Telefon: 0511 202801-0 (im Folgenden Tutao),\n        erbringt alle Lieferungen und Leistungen ausschließlich auf Grundlage\n        dieser Allgemeinen Geschäftsbedingungen (AGB).</p>\n    <p>1.2 Diese AGB gelten sowohl für Unternehmer gem. § 14 BGB\n        (im Folgenden Geschäftskunden) als auch für Verbraucher gem. § 13\n        BGB (im Folgenden Privatkunden). Privatkunde ist jede natürliche Person,\n        die ein Rechtsgeschäft zu einem Zwecke abschließt, der weder ihrer\n        gewerblichen noch ihrer selbstständigen beruflichen Tätigkeit zugerechnet werden kann.</p>\n    <p>1.3 Für Geschäftskunden haben diese AGB für alle zukünftigen Geschäfte\n        mit Tutao Geltung.</p>\n    <p>1.4 Von diesen AGB insgesamt oder teilweise abweichende\n        Geschäftsbedingungen von Geschäftskunden werden nicht anerkannt, es sei denn,\n        diesen wurde von Tutao schriftlich zugestimmt. Die AGB von Tutao\n        gelten auch dann ausschließlich, wenn in Kenntnis entgegenstehender\n        Geschäftsbedingungen des Kunden von Tutao Leistungen vorbehaltlos\n        erbracht werden.</p>\n    <h4>2. Vertragsschluss</h4>\n    <p>2.1 Der Antrag des Kunden auf Abschluss des beabsichtigten Vertrags\n        besteht entweder in der Absendung einer elektronischen Erklärung oder\n        in der Übermittlung des Auftragsformulars in schriftlicher Form an\n        Tutao, soweit dies angeboten wird. Der Vertrag kommt durch die Bereitstellung\n        des Accounts durch Tutao zustande.</p>\n    <h4>3. Widerrufsbelehrung</h4>\n    <p>3.1 Sofern der Privatkunde den Vertrag über das Internet abgeschlossen\n        hat (Fernabsatzvertrag), steht dem Kunden das nachfolgend beschriebene\n        gesetzliche Widerrufsrecht zu:</p>\n    <hr>\n    <p><strong>Widerrufsbelehrung</strong></p>\n    <p><strong>Widerrufsrecht</strong></p>\n    <p>Sie haben das Recht, binnen vierzehn Tagen ohne Angabe von Gründen\n        diesen Vertrag zu widerrufen. Die Widerrufsfrist beträgt vierzehn Tage\n        ab dem Tag des Vertragsabschlusses. Um Ihr Widerrufsrecht auszuüben,\n        müssen Sie uns</p>\n    <p>Tutao GmbH<br>\n        Deisterstr. 17a<br>\n        30449 Hannover<br>\n        Deutschland</p>\n    <p>Telefon: +49 511 202801-0<br>\n        Telefax: +49 511 202801-19 oder<br>\n        E-Mail: hello@tutao.de</p>\n    <p>mittels einer eindeutigen Erklärung (z.B. ein mit der Post versandter\n        Brief, Telefax oder E-Mail) über Ihren Entschluss, diesen Vertrag zu\n        widerrufen, informieren. Sie können dafür das beigefügte\n        Muster-Widerrufsformular verwenden, das jedoch nicht vorgeschrieben\n        ist.</p>\n    <p>Zur Wahrung der Widerrufsfrist reicht es aus, dass Sie die Mitteilung\n        über die Ausübung des Widerrufsrechts vor Ablauf der Widerrufsfrist\n        absenden.</p>\n    <p><strong>Folgen des Widerrufs</strong></p>\n    <p>Wenn Sie diesen Vertrag widerrufen, haben wir Ihnen alle Zahlungen,\n        die wir von Ihnen erhalten haben, einschließlich der Lieferkosten (mit\n        Ausnahme der zusätzlichen Kosten, die sich daraus ergeben, dass Sie\n        eine andere Art der Lieferung als die von uns angebotene, günstigste\n        Standardlieferung gewählt haben), unverzüglich und spätestens binnen\n        vierzehn Tagen ab dem Tag zurückzuzahlen, an dem die Mitteilung über\n        Ihren Widerruf dieses Vertrags bei uns eingegangen ist. Für diese\n        Rückzahlung verwenden wir dasselbe Zahlungsmittel, das Sie bei der\n        ursprünglichen Transaktion eingesetzt haben, es sei denn, mit Ihnen\n        wurde ausdrücklich etwas anderes vereinbart; in keinem Fall werden\n        Ihnen wegen dieser Rückzahlung Entgelte berechnet.</p>\n    <p>Haben Sie verlangt, dass die Dienstleistungen während der\n        Widerrufsfrist beginnen soll, so haben Sie uns einen angemessenen\n        Betrag zu zahlen, der dem Anteil der bis zu dem Zeitpunkt, zu dem Sie\n        uns von der Ausübung des Widerrufsrechts hinsichtlich dieses Vertrags\n        unterrichten, bereits erbrachten Dienstleistungen im Vergleich zum\n        Gesamtumfang der im Vertrag vorgesehenen Dienstleistungen entspricht.</p>\n    <p><strong>Ende der Widerrufsbelehrung</strong></p>\n    <hr>\n    <p><strong>Muster-Widerrufsformular</strong></p>\n    <p>(Wenn Sie den Vertrag widerrufen wollen, dann können Sie dieses\n        Formular ausfüllen und an uns zurücksenden.)</p>\n    <p>An<br>\n        Tutao GmbH<br>\n        Deisterstr. 17a<br>\n        30449 Hannover<br>\n        Deutschland</p>\n    <p>Telefax: +49 511 202801-19 oder<br>\n        E-Mail: hello@tutao.de</p>\n    <p>Hiermit widerrufe(n) ich/wir* den von mir/uns* abgeschlossenen Vertrag\n        über den Kauf der folgenden Waren*/die Erbringung der folgenden\n        Dienstleistung*:</p>\n    <p>Bestellt am*/erhalten am*: ______________________</p>\n    <p>Name des Privatkunden: ______________________</p>\n    <p>Anschrift des Privatkunden: ______________________</p>\n    <p>Tutanota-E-Mail-Adresse des Privatkunden: ______________________</p>\n    <p><br>\n        Unterschrift des Privatkunden (nur bei Mitteilung auf Papier):\n        ______________________</p>\n    <p><br>\n        Datum: ______________________</p>\n    <p>*) Unzutreffendes streichen.</p>\n    <hr>\n    <h4>4. Vertragsgegenstand und Vertragsänderung</h4>\n    <p>4.1 Tutao stellt dem Kunden entsprechend der jeweiligen\n        Leistungsbeschreibung des gewählten Tarifs das betriebsbereite System\n        Tutanota zur Verfügung. Die Verfügbarkeit beträgt 99 % im\n        Jahresmittel, bezogen auf 24 Stunden täglich, sieben Tage die\n        Woche. Von der Verfügbarkeit ausgenommen sind Zeiten, in denen\n        Tutanota aufgrund von technischen oder sonstigen Problemen, die nicht\n        im Einflussbereich von Tutao liegen (höhere Gewalt, Verschulden\n        Dritter etc.), nicht zu erreichen ist. Tutao führt regelmäßig\n        Wartungs- und Softwarepflegearbeiten an den Systemen durch. Zu diesem\n        Zwecke kann Tutao Leistungen unter Berücksichtigung der Belange des\n        Kunden vorübergehend einstellen oder beschränken, soweit objektive\n        Gründe dieses rechtfertigen. Diese Arbeiten werden soweit wie möglich\n        in nutzungsarmen Zeiten, insbesondere freitags bis sonntags, jeweils\n        22:00 – 06:00 Uhr (CET), durchgeführt. Sofern für Tutao absehbar ist,\n        dass Ausfallzeiten für Wartung und Softwarepflege länger als drei\n        Stunden dauern, wird Tutao dies dem Kunden eines zahlungspflichtigen\n        Dienstes mindestens drei Tage vor Beginn der jeweiligen Arbeiten mitteilen.\n        Tutao ist für die Verfügbarkeit nur insoweit verantwortlich, als diese\n        auf den von ihr betriebenen Teil der Systeme zurückzuführen ist.</p>\n    <p>4.2 Soweit in der jeweiligen Leistungsbeschreibung des gewählten\n        Tarifs eine bestimmte Speicherkapazität genannt ist, gilt diese für\n        den gesamten, gemäß Leistungsbeschreibung zur Verfügung stehenden\n        Speicherplatz und dient unter anderem auch der Speicherung von\n        Meta-Daten (Datei-Historie etc.).</p>\n    <p>4.3 Tutao bleibt das Recht vorbehalten, Leistungen zu erweitern und\n        Verbesserungen vorzunehmen, wenn diese dem technischen Fortschritt\n        dienen, notwendig erscheinen, um Missbrauch zu verhindern, oder Tutao\n        aufgrund gesetzlicher Vorschriften hierzu verpflichtet ist. Sonstige\n        Änderungen des Vertragsinhalts, einschließlich dieser AGB, kann Tutao\n        – mit Zustimmung des Kunden – vornehmen, sofern die Änderung unter\n        Berücksichtigung der Interessen von Tutao für den Kunden zumutbar\n        ist. Unzumutbar ist insbesondere jede Vertragsänderung, die eine\n        Reduzierung der vertraglichen Hauptleistungen von Tutao zur Folge\n        hat. Besteht die Änderung des Vertrags in einer Erhöhung der vom\n        Kunden zu entrichtenden Entgelte, so richtet sich deren Zulässigkeit\n        nach Ziffer 8.5 dieser AGB. Die Zustimmung zur Änderung des Vertrags\n        gilt als erteilt, wenn der Kunde der Änderung nicht innerhalb eines\n        Monats nach Zugang der Änderungsmitteilung widerspricht. Tutao\n        verpflichtet sich, den Kunden im Zuge der Änderungsmitteilung auf die\n        Folgen eines unterlassenen Widerspruchs hinzuweisen.</p>\n    <p>4.4 Freiwillige, unentgeltliche Dienste und Leistungen von Tutao, die\n        ausdrücklich als solche bezeichnet und nicht Teil der\n        Leistungsbeschreibung sind, können von Tutao jederzeit eingestellt\n        werden. Tutao wird bei Änderungen und der Einstellung kostenloser\n        Dienste und Leistungen auf die berechtigten Interessen des Kunden\n        Rücksicht nehmen.</p>\n    <p>4.5 Tutao hat das Recht, sich zur Leistungserbringung jederzeit und in\n        beliebigem Umfang Dritter zu bedienen.</p>\n    <p>4.6 Kostenfreie Tarife dürfen nur von Privatkunden verwendet werden. Die geschäftliche Nutzung ist nur\n        in kostenpflichtigen Tarifen erlaubt, außer dies ist im jeweiligen Tarif anders angegeben.</p>\n    <p>4.7. Jeder natürlichen Person ist es untersagt mehr als einen kostenfreien Tutanota-Account für den\n        Privatgebrauch zu registrieren. Für weitere Accounts muss ein kostenpflichtiger Tarif gewählt werden,\n        in dem weitere Benutzer-Accounts oder Aliasse angelegt werden können.</p>\n    <p>4.8. Tutao ist berechtigt, dem Kunden Sicherheitshinweise und Informationen zu Verträgen mit dem Kunden,\n     zu Produkt-Updates, zur Tutao GmbH, zu anderen eigenen Produkten und Produkten von Partnernunternehmen\n      anzuzeigen. Partnerunternehmen sind ausschließlich Unternehmen, die von der Tutao GmbH empfohlen werden,\n       weil diese sich für Menschenrechte, Datenschutz oder Privatsphäre einsetzen.</p>\n    <h4>5. Vertragslaufzeit, Vertragsverlängerung und -kündigung, Einstellung der Leistung</h4>\n    <p>5.1 Soweit sich nicht aus der jeweiligen Leistungsbeschreibung etwas\n        Anderes ergibt, läuft der Vertrag auf unbestimmte Zeit. Der Vertrag\n        ist für beide Vertragspartner mit einer Frist von einem Monat zum\n        Ablauf eines jeden gebuchten Abrechnungszeitraums kündbar. Wenn keine Kündigung\n        erfolgt, verlängert sich der Vertrag automatisch um den gewählten Abrechnungszeitraum.</p>\n    <p>5.2 Unberührt bleibt das Recht beider Vertragsparteien zur fristlosen\n        Kündigung aus wichtigem Grund. Ein wichtiger Grund für Tutao ist\n        insbesondere dann gegeben, wenn mindestens einer der folgenden\n        Sachverhalte vorliegt: der Kunde verstößt trotz Abmahnung schuldhaft\n        gegen eine vertragliche Pflicht (zum Beispiel gegen 8.4 dieser AGB),\n        der Kunde beseitigt trotz Abmahnung nicht innerhalb angemessener Frist\n        eine Vertrags- oder Rechtsverletzung. Eine Abmahnung ist entbehrlich,\n        wenn es sich um einen Verstoß handelt, der eine Fortsetzung des\n        Vertrags für Tutao unzumutbar macht.</p>\n    <p>5.3 Die Kündigung zum jeweiligen Tarif zusätzlich gewählter Optionen,\n        insbesondere zusätzlicher Accounts und Speicherplatz, lässt das\n        Vertragsverhältnis insgesamt unberührt.</p>\n    <p>5.4 Die außerordentliche Kündigung bedarf zu ihrer\n        Wirksamkeit der Schriftform. Die ordentliche Kündigung des Kunden\n        erfolgt durch das Löschen des letzten Administrationsaccounts\n        in den Einstellungen der Anwendung.</p>\n    <p>5.5 Nach Beendigung des Vertragsverhältnisses ist Tutao zur Erbringung\n        der vertraglichen Leistungen nicht mehr verpflichtet. Die rechtzeitige\n        Speicherung und Sicherung der Daten liegt daher in der Verantwortung\n        des Kunden.</p>\n    <p>5.6. Tutao ist berechtigt den Vertrag bei Nutzung eines kostenfreien Tarifs ohne Einhaltung einer Frist zu\n        kündigen, wenn der Account sechs Monate nicht verwendet wurde.</p>\n    <h4>6. Allgemeine Pflichten des Kunden</h4>\n    <p>6.1 Geschäftskunden sind verpflichtet, Tutao den vollständigen Namen und\n        eine ladungsfähige Postanschrift (keine Postfach- oder sonstige\n        anonyme Adresse) anzugeben. Der Kunde versichert,\n        dass alle an Tutao mitgeteilten Daten richtig und vollständig\n        sind.</p>\n    <p>6.2 Privatkunden sind bei der Buchung eines kostenpflichtigen Tarifs\n        verpflichtet, das Land des aktuellen Wohnsitzes anzugeben.</p>\n    <p>6.3 Der Kunde hat bei Änderungen die Daten unverzüglich\n        in der Anwendung zu aktualisieren.</p>\n    <h4>7. E-Mail-Empfang und –Versand, Verbot für „Spam“-E-Mails</h4>\n    <p>7.1 Tutao hat das Recht, die Maximalgröße der zu versendenden E-Mails\n        jeweils auf einen angemessenen Wert zu beschränken. Soweit sich aus\n        der jeweiligen Leistungsbeschreibung nichts anderes ergibt, beträgt\n        dieser Wert 20 MB.</p>\n    <p>7.2 Der Versand von E-Mails ist unzulässig, soweit es sich um einen\n        massenhaften Versand von E-Mails an Empfänger ohne deren Einwilligung\n        handelt und/oder es sich um eine Werbe-E-Mail handelt und eine\n        Einwilligung des Empfängers nicht vorliegt obwohl diese erforderlich\n        ist (insgesamt nachfolgend als „Spam“ bezeichnet). Der Nachweis einer\n        Einwilligung (vgl. § 7 Abs. 2 UWG) des jeweiligen Empfängers obliegt\n        dem Kunden.</p>\n    <p>7.3 Dem Kunden ist untersagt, über das System mehr als 100 E-Mails\n        pro Stunde je Account oder sogenannte „Paidmails“ bzw. E-Mails mit\n        denen ein „Referral-System“ beworben wird, zu versenden.</p>\n    <h4>8. Entgeltzahlung und Rechnungsstellung, Entgelterhöhung, Zahlungsverzug, Entgelterstattung</h4>\n    <p>8.1 Die Höhe der vom Kunden an Tutao zu bezahlenden Entgelte und der\n        jeweilige Abrechnungszeitraum ergeben sich aus der\n        Leistungsbeschreibung des vom Kunden gewählten Tarifs. Die\n        nutzungsunabhängigen Entgelte werden je nach gewähltem Abrechnungszeitraum\n        monatlich bzw. jährlich im Voraus fällig, die nutzungsabhängigen Entgelte\n        mit Rechnungsstellung.</p>\n    <p>8.2 Die Rechnungsstellung erfolgt online durch die elektronische\n        Zustellung der Rechnung. Die Rechnung gilt dem Kunden als zugegangen,\n        wenn sie für ihn elektronisch abrufbar und damit in seinen\n        Verfügungsbereich gelangt ist (z.B. per E-Mail). Tutao bleibt es unbenommen alternativ\n        zur Online-Rechnung die Rechnungsstellung postalisch vorzunehmen. Ein\n        Anspruch des Kunden auf Übersendung einer Rechnung auf dem Postwege\n        besteht jedoch nicht.</p>\n    <p>8.3 Der Kunde ermächtigt Tutao, die vom Kunden zu erbringenden\n        Zahlungen zu Lasten eines vom Kunden angegebenen Kontos\n        (z.B. Bankkonto, Kreditkarte, Paypal) einzuziehen. Der Kunde hat für\n        ausreichende Deckung des Kontos Sorge zu tragen. Erfolgt eine vom\n        Kunden zu vertretende Rückbuchung, ist der Kunde verpflichtet,\n        Tutao die hierfür anfallenden Gebühren zu erstatten. Geschäftskunden\n        können die Zahlung auf Rechnung wählen.</p>\n    <p>8.4 Befindet sich der Kunde mit einer Zahlung für zwei\n        aufeinanderfolgende Monate in Verzug, so ist Tutao berechtigt, den\n        Vertrag ohne Einhaltung einer Frist zu kündigen. Gleiches gilt, sofern\n        der Kunde sich über einen Zeitraum von mehr als zwei Monaten mit der\n        Zahlung in Höhe eines Betrags in Verzug befindet, der die Grundgebühr\n        für zwei Monate erreicht.</p>\n    <p>8.5 Tutao ist berechtigt, die Entgelte angemessen zu erhöhen. In jedem\n        Fall angemessen ist insoweit eine jährliche Erhöhung um höchstens 5\n        %. Die Entgelterhöhung bedarf der Zustimmung des Kunden. Die\n        Zustimmung gilt als erteilt, wenn der Kunde der Erhöhung nicht binnen\n        eines Monats nach Zugang der Änderungsmitteilung widerspricht. Tutao\n        ist verpflichtet, den Kunden mit der Änderungsmitteilung auf die\n        Folgen eines unterlassenen Widerspruchs hinzuweisen. Widerspricht der\n        Kunde der Preiserhöhung, steht Tutao ein Sonderkündigungsrecht zu.</p>\n    <p>8.6 Vorausbezahlte Entgelte werden dem Kunden erstattet, wenn der\n        Vertrag vor Ablauf des Abrechnungszeitraums durch Tutao gekündigt wird.\n        Im Falle einer wirksamen außerordentlichen Kündigung (Ziffer 5.2) durch Tutao hat\n        Tutao Anspruch auf Zahlung des Entgelts bis zum nächstmöglichen\n        ordentlichen Kündigungszeitpunkt.</p>\n    <h4>9. Leistungsstörungen</h4>\n    <p>9.1 Für Leistungsstörungen ist Tutao nur verantwortlich soweit diese\n        die von Tutao nach Ziffer 4.1 zu erbringenden Leistungen betreffen.</p>\n    <p>9.2 Störungen wird Tutao im Rahmen der technischen und betrieblichen\n        Möglichkeiten beseitigen. Der Kunde ist verpflichtet, Tutao für ihn\n        erkennbare Störungen unverzüglich anzuzeigen\n        („Störungsmeldung“). Erfolgt die Beseitigung der Störung nicht\n        innerhalb eines angemessenen Zeitraums, hat der Kunde Tutao eine\n        angemessene Nachfrist zu setzen. Wird die Störung innerhalb dieser\n        Nachfrist nicht beseitigt, bleibt dem Kunden das Recht vorbehalten,\n        wahlweise den Vertrag zu kündigen oder die Herabsetzung der\n        Vergütung zu verlangen. Bei einer die\n        Funktionstauglichkeit nicht einschränkenden unerheblichen Abweichung\n        der Leistung kann der Kunde nur die Herabsetzung der monatlichen\n        Vergütung verlangen. Etwaige Ansprüche nach Ziffer 10 bleiben hiervon\n        unberührt.</p>\n    <p>9.3 Im Falle höherer Gewalt ist Tutao von der Leistungspflicht\n        befreit. Hierzu zählen insbesondere rechtmäßige Arbeitskampfmaßnahmen,\n        auch in Drittbetrieben und behördliche Maßnahmen, soweit nicht von\n        Tutao verschuldet.</p>\n    <h4>10. Haftung von Tutao</h4>\n    <p>10.1 Eine Haftung von Tutao besteht ausschließlich im Rahmen der\n        Ziffern 10.2 bis 10.8. Die folgenden Haftungsbestimmungen gelten dabei\n        für Ansprüche aus jeglichem Rechtsgrund.</p>\n    <p>10.2 Tutao haftet dem Kunden für Schäden unbegrenzt, die von ihm oder\n        einem seiner Erfüllungsgehilfen oder gesetzlichen Vertreter\n        vorsätzlich oder grob fahrlässig verursacht werden. Bei Schäden aus\n        der Verletzung des Lebens, des Körpers oder der Gesundheit ist die\n        Haftung auch bei einer einfachen Pflichtverletzung von Tutao oder\n        eines seiner gesetzlichen Vertreter oder Erfüllungsgehilfen der Höhe\n        nach unbegrenzt. Ebenso der Höhe nach unbegrenzt ist die Haftung für\n        Schäden, die auf schwerwiegendes Organisationsverschulden von Tutao\n        zurückzuführen sind, sowie für Schäden, die durch das Fehlen einer\n        garantierten Beschaffenheit hervorgerufen werden.</p>\n    <p>10.3 Soweit nicht Ziffer 10.2 eingreift, haftet Tutao bei der\n        Verletzung wesentlicher Vertragspflichten der Höhe nach begrenzt auf\n        den vertragstypisch vorhersehbaren Schaden. Wesentliche\n        Vertragspflichten sind Pflichten, die der Vertrag Tutao nach seinem\n        Inhalt zur Erreichung des Vertragszwecks auferlegt und deren Erfüllung\n        die ordnungsgemäße Durchführung des Vertrags überhaupt erst\n        ermöglichen und auf deren Einhaltung der Kunde regelmäßig vertrauen\n        darf.</p>\n    <p>10.4 Bei einem von Tutao verschuldeten Datenverlust, haftet Tutao\n        ausschließlich für die Kosten der Rücksicherung und Wiederherstellung\n        von Daten, die auch bei einer ordnungsgemäß erfolgten Sicherung der\n        Daten verloren gegangen wären. Eine Haftung besteht jedoch nur im\n        Rahmen der Haftungsregelungen dieser AGB.</p>\n    <p>10.5 Die Haftung für entgangenen Gewinn wird ausgeschlossen.</p>\n    <p>10.6 Die Haftung nach dem Produkthaftungsgesetz bleibt von den\n        vorstehenden Haftungsregelungen unberührt.</p>\n    <p>10.7 Im Falle, dass das System als kostenlose Version\n        (d. h. gebührenfrei) zur Verfügung gestellt wurde, übernimmt Tutao in\n        Übereinstimmung mit den vorstehenden Regelungen nur für vorsätzliche\n        und arglistige Handlungen Haftung.</p>\n    <p>10.8 Tutao haftet nicht für Inhalte und Aktivitäten der Nutzer.</p>\n    <h4>11. Sperrung, Voraussetzungen und Aufhebung der Sperrung, Kostenerstattung</h4>\n    <p>11.1 Liegt ein schuldhaftes Verhalten des Kunden oder ein diesem\n        zurechenbares Verhalten Dritter vor, das gegen geltendes Deutsches\n        Recht, insbesondere gegen Vorschriften des Strafgesetzbuches oder\n        Jugendschutzes, oder diese AGB verstößt, kann Tutao eine vollständige oder\n        teilweise Sperrung der Dienste vornehmen. Das Recht zur fristlosen\n        Kündigung gemäß Ziffer 5.2 dieser AGB bleibt hiervon unberührt.</p>\n    <p>11.2 Durch eine Sperrung wird der Kunde nicht von seiner Verpflichtung\n        entbunden, die vereinbarten Entgelte zu entrichten. Besteht für Tutao\n        eine Mitteilungspflicht, so genügt es, wenn Tutao die jeweiligen\n        Mitteilungen per E-Mail an die E-Mail-Adresse des Kunden sendet. Für\n        die Sperrung und für die Aufhebung der Sperrung kann Tutao jeweils das\n        hierfür vereinbarte Entgelt (derzeit 50,00 Euro inkl. gesetzl. USt.)\n        berechnen („Sperr- und Entsperrgebühr“).</p>\n    <p>11.3 Soweit Tutao von Dritten wegen eines\n        schuldhaften Verhaltens des Kunden oder ein diesem zurechenbaren\n        Verhaltens Dritter in Anspruch genommen wird, das Tutao zur Sperrung\n        berechtigt, verpflichtet sich der Kunde, Tutao von allen Ansprüchen\n        freizustellen und diejenigen Kosten zu tragen, die durch die\n        Inanspruchnahme des rechtswidrigen Zustands entstanden sind.</p>\n    <h4>12. Nutzungsrechte</h4>\n    <p>12.1 Tutao räumt dem Kunden für die Dauer des Vertrags ein einfaches,\n        nicht übertragbares und nicht unterlizenzierbares Recht zur Nutzung\n        der zur Durchführung der Leistungen erforderlichen Software von Tutao\n        und deren Erweiterungen zum eigenen, internen Gebrauch ein. Die\n        Software ist urheberrechtlich geschützt. Soweit es nach dem\n        Urhebergesetz oder vertraglich nicht ausdrücklich gestattet ist, darf\n        der Kunde kein Reverse-Engineering, keine Disassemblierung und keine\n        Dekompilierung der Software durchführen oder durch Dritte durchführen\n        lassen.</p>\n    <h4>13. Datenschutz</h4>\n    <p>13.1 Sofern vom Kunden angegeben, erhebt, verarbeitet und nutzt Tutao\n        personenbezogene Daten des Kunden. Weitere Informationen zur Datenverarbeitung\n        und zum Datenschutz ergeben sich aus der Datenschutzerklärung von Tutao.</p>\n    <h4>14. Gerichtsstand, anwendbares Recht</h4>\n    <p>14.1 Es gilt das Recht der Bundesrepublik Deutschland. Unberührt\n        bleiben zwingende Vorschriften des Staates, in dem Privatkunden (=Verbraucher)\n        ihren gewöhnlichen Aufenthalt haben. Im Verkehr mit\n        Privatkunden innerhalb der Europäischen Union kann auch das Recht am\n        Wohnsitz des Privatkunden anwendbar sein, sofern es sich zwingend um\n        verbraucherrechtliche Vorschriften handelt.</p>\n    <p>14.2 Gerichtsstand für sämtliche Ansprüche aus den Vertragsbeziehungen\n        zwischen den Vertragsparteien sich ergebenden Streitigkeiten,\n        insbesondere über das Zustandekommen, die Abwicklung oder die\n        Beendigung des Vertrags ist – soweit der Kunde Vollkaufmann,\n        juristische Person des öffentlichen Rechts oder öffentlich-rechtliches\n        Sondervermögen ist – Hannover, Deutschland. Tutao kann den Kunden wahlweise auch an\n        dessen allgemeinem Gerichtsstand verklagen.</p>\n    <p>14.3. Die Geltung des Übereinkommens der Vereinten Nationen über\n        Verträge über den internationalen Warenkauf (UN-Kaufrecht) ist\n        ausgeschlossen, auch im grenzüberschreitenden Lieferverkehr.</p>\n    <h4>15. Aufrechnung, Zurückbehaltung, Salvatorische Klausel</h4>\n    <p>15.1 Mit Forderungen von Tutao kann der Kunde nur aufrechnen, soweit\n        diese unwidersprochen oder rechtskräftig festgestellt sind. Die\n        Geltendmachung eines Zurückbehaltungsrechts steht dem Kunden nur wegen\n        Gegenansprüchen zu, die aus dem Vertragsverhältnis mit Tutao\n        resultieren.</p>\n    <p>15.2 Sollten Bestimmungen dieser AGB und/oder des Vertrags unwirksam\n        sein oder werden, so berührt dies die Wirksamkeit der übrigen\n        Bestimmungen nicht. Die Vertragsparteien verpflichten sich, anstelle\n        einer unwirksamen Bestimmung eine gültige Vereinbarung zu treffen,\n        deren wirtschaftlicher Erfolg dem der unwirksamen so weit wie möglich\n        nahe kommt.</p>\n</section>'),_export("terms_de",'<section id="terms-de" class="content">\n    <h3>Allgemeine Geschäftsbedingungen (AGB) der Tutao GmbH</h3>\n    <h4>1. Allgemeines, Geltungsbereich</h4>\n    <p>1.1 Die Tutao GmbH, Adresse: Deisterstr. 17a, 30449 Hannover, E-Mail:\n        hello@tutao.de, Telefon: 0511 202801-0 (im Folgenden Tutao),\n        erbringt alle Lieferungen und Leistungen ausschließlich auf Grundlage\n        dieser Allgemeinen Geschäftsbedingungen (AGB).</p>\n    <p>1.2 Diese AGB gelten sowohl für Unternehmer gem. § 14 BGB\n        (im Folgenden Geschäftskunden) als auch für Verbraucher gem. § 13\n        BGB (im Folgenden Privatkunden). Privatkunde ist jede natürliche Person,\n        die ein Rechtsgeschäft zu einem Zwecke abschließt, der weder ihrer\n        gewerblichen noch ihrer selbstständigen beruflichen Tätigkeit zugerechnet werden kann.</p>\n    <p>1.3 Für Geschäftskunden haben diese AGB für alle zukünftigen Geschäfte\n        mit Tutao Geltung.</p>\n    <p>1.4 Von diesen AGB insgesamt oder teilweise abweichende\n        Geschäftsbedingungen von Geschäftskunden werden nicht anerkannt, es sei denn,\n        diesen wurde von Tutao schriftlich zugestimmt. Die AGB von Tutao\n        gelten auch dann ausschließlich, wenn in Kenntnis entgegenstehender\n        Geschäftsbedingungen des Kunden von Tutao Leistungen vorbehaltlos\n        erbracht werden.</p>\n    <h4>2. Vertragsschluss</h4>\n    <p>2.1 Der Antrag des Kunden auf Abschluss des beabsichtigten Vertrags\n        besteht entweder in der Absendung einer elektronischen Erklärung oder\n        in der Übermittlung des Auftragsformulars in schriftlicher Form an\n        Tutao, soweit dies angeboten wird. Der Vertrag kommt durch die Bereitstellung\n        des Accounts durch Tutao zustande.</p>\n    <h4>3. Widerrufsbelehrung</h4>\n    <p>3.1 Sofern der Privatkunde den Vertrag über das Internet abgeschlossen\n        hat (Fernabsatzvertrag), steht dem Kunden das nachfolgend beschriebene\n        gesetzliche Widerrufsrecht zu:</p>\n    <hr>\n    <p><strong>Widerrufsbelehrung</strong></p>\n    <p><strong>Widerrufsrecht</strong></p>\n    <p>Sie haben das Recht, binnen vierzehn Tagen ohne Angabe von Gründen\n        diesen Vertrag zu widerrufen. Die Widerrufsfrist beträgt vierzehn Tage\n        ab dem Tag des Vertragsabschlusses. Um Ihr Widerrufsrecht auszuüben,\n        müssen Sie uns</p>\n    <p>Tutao GmbH<br>\n        Deisterstr. 17a<br>\n        30449 Hannover<br>\n        Deutschland</p>\n    <p>Telefon: +49 511 202801-0<br>\n        Telefax: +49 511 202801-19 oder<br>\n        E-Mail: hello@tutao.de</p>\n    <p>mittels einer eindeutigen Erklärung (z.B. ein mit der Post versandter\n        Brief, Telefax oder E-Mail) über Ihren Entschluss, diesen Vertrag zu\n        widerrufen, informieren. Sie können dafür das beigefügte\n        Muster-Widerrufsformular verwenden, das jedoch nicht vorgeschrieben\n        ist.</p>\n    <p>Zur Wahrung der Widerrufsfrist reicht es aus, dass Sie die Mitteilung\n        über die Ausübung des Widerrufsrechts vor Ablauf der Widerrufsfrist\n        absenden.</p>\n    <p><strong>Folgen des Widerrufs</strong></p>\n    <p>Wenn Sie diesen Vertrag widerrufen, haben wir Ihnen alle Zahlungen,\n        die wir von Ihnen erhalten haben, einschließlich der Lieferkosten (mit\n        Ausnahme der zusätzlichen Kosten, die sich daraus ergeben, dass Sie\n        eine andere Art der Lieferung als die von uns angebotene, günstigste\n        Standardlieferung gewählt haben), unverzüglich und spätestens binnen\n        vierzehn Tagen ab dem Tag zurückzuzahlen, an dem die Mitteilung über\n        Ihren Widerruf dieses Vertrags bei uns eingegangen ist. Für diese\n        Rückzahlung verwenden wir dasselbe Zahlungsmittel, das Sie bei der\n        ursprünglichen Transaktion eingesetzt haben, es sei denn, mit Ihnen\n        wurde ausdrücklich etwas anderes vereinbart; in keinem Fall werden\n        Ihnen wegen dieser Rückzahlung Entgelte berechnet.</p>\n    <p>Haben Sie verlangt, dass die Dienstleistungen während der\n        Widerrufsfrist beginnen soll, so haben Sie uns einen angemessenen\n        Betrag zu zahlen, der dem Anteil der bis zu dem Zeitpunkt, zu dem Sie\n        uns von der Ausübung des Widerrufsrechts hinsichtlich dieses Vertrags\n        unterrichten, bereits erbrachten Dienstleistungen im Vergleich zum\n        Gesamtumfang der im Vertrag vorgesehenen Dienstleistungen entspricht.</p>\n    <p><strong>Ende der Widerrufsbelehrung</strong></p>\n    <hr>\n    <p><strong>Muster-Widerrufsformular</strong></p>\n    <p>(Wenn Sie den Vertrag widerrufen wollen, dann können Sie dieses\n        Formular ausfüllen und an uns zurücksenden.)</p>\n    <p>An<br>\n        Tutao GmbH<br>\n        Deisterstr. 17a<br>\n        30449 Hannover<br>\n        Deutschland</p>\n    <p>Telefax: +49 511 202801-19 oder<br>\n        E-Mail: hello@tutao.de</p>\n    <p>Hiermit widerrufe(n) ich/wir* den von mir/uns* abgeschlossenen Vertrag\n        über den Kauf der folgenden Waren*/die Erbringung der folgenden\n        Dienstleistung*:</p>\n    <p>Bestellt am*/erhalten am*: ______________________</p>\n    <p>Name des Privatkunden: ______________________</p>\n    <p>Anschrift des Privatkunden: ______________________</p>\n    <p>Tutanota-E-Mail-Adresse des Privatkunden: ______________________</p>\n    <p><br>\n        Unterschrift des Privatkunden (nur bei Mitteilung auf Papier):\n        ______________________</p>\n    <p><br>\n        Datum: ______________________</p>\n    <p>*) Unzutreffendes streichen.</p>\n    <hr>\n    <h4>4. Vertragsgegenstand und Vertragsänderung</h4>\n    <p>4.1 Tutao stellt dem Kunden entsprechend der jeweiligen\n        Leistungsbeschreibung des gewählten Tarifs das betriebsbereite System\n        Tutanota zur Verfügung. Die Verfügbarkeit beträgt 99 % im\n        Jahresmittel, bezogen auf 24 Stunden täglich, sieben Tage die\n        Woche. Von der Verfügbarkeit ausgenommen sind Zeiten, in denen\n        Tutanota aufgrund von technischen oder sonstigen Problemen, die nicht\n        im Einflussbereich von Tutao liegen (höhere Gewalt, Verschulden\n        Dritter etc.), nicht zu erreichen ist. Tutao führt regelmäßig\n        Wartungs- und Softwarepflegearbeiten an den Systemen durch. Zu diesem\n        Zwecke kann Tutao Leistungen unter Berücksichtigung der Belange des\n        Kunden vorübergehend einstellen oder beschränken, soweit objektive\n        Gründe dieses rechtfertigen. Diese Arbeiten werden soweit wie möglich\n        in nutzungsarmen Zeiten, insbesondere freitags bis sonntags, jeweils\n        22:00 – 06:00 Uhr (CET), durchgeführt. Sofern für Tutao absehbar ist,\n        dass Ausfallzeiten für Wartung und Softwarepflege länger als drei\n        Stunden dauern, wird Tutao dies dem Kunden eines zahlungspflichtigen\n        Dienstes mindestens drei Tage vor Beginn der jeweiligen Arbeiten mitteilen.\n        Tutao ist für die Verfügbarkeit nur insoweit verantwortlich, als diese\n        auf den von ihr betriebenen Teil der Systeme zurückzuführen ist.</p>\n    <p>4.2 Soweit in der jeweiligen Leistungsbeschreibung des gewählten\n        Tarifs eine bestimmte Speicherkapazität genannt ist, gilt diese für\n        den gesamten, gemäß Leistungsbeschreibung zur Verfügung stehenden\n        Speicherplatz und dient unter anderem auch der Speicherung von\n        Meta-Daten (Datei-Historie etc.).</p>\n    <p>4.3 Tutao bleibt das Recht vorbehalten, Leistungen zu erweitern und\n        Verbesserungen vorzunehmen, wenn diese dem technischen Fortschritt\n        dienen, notwendig erscheinen, um Missbrauch zu verhindern, oder Tutao\n        aufgrund gesetzlicher Vorschriften hierzu verpflichtet ist. Sonstige\n        Änderungen des Vertragsinhalts, einschließlich dieser AGB, kann Tutao\n        – mit Zustimmung des Kunden – vornehmen, sofern die Änderung unter\n        Berücksichtigung der Interessen von Tutao für den Kunden zumutbar\n        ist. Unzumutbar ist insbesondere jede Vertragsänderung, die eine\n        Reduzierung der vertraglichen Hauptleistungen von Tutao zur Folge\n        hat. Besteht die Änderung des Vertrags in einer Erhöhung der vom\n        Kunden zu entrichtenden Entgelte, so richtet sich deren Zulässigkeit\n        nach Ziffer 8.5 dieser AGB. Die Zustimmung zur Änderung des Vertrags\n        gilt als erteilt, wenn der Kunde der Änderung nicht innerhalb eines\n        Monats nach Zugang der Änderungsmitteilung widerspricht. Tutao\n        verpflichtet sich, den Kunden im Zuge der Änderungsmitteilung auf die\n        Folgen eines unterlassenen Widerspruchs hinzuweisen.</p>\n    <p>4.4 Freiwillige, unentgeltliche Dienste und Leistungen von Tutao, die\n        ausdrücklich als solche bezeichnet und nicht Teil der\n        Leistungsbeschreibung sind, können von Tutao jederzeit eingestellt\n        werden. Tutao wird bei Änderungen und der Einstellung kostenloser\n        Dienste und Leistungen auf die berechtigten Interessen des Kunden\n        Rücksicht nehmen.</p>\n    <p>4.5 Tutao hat das Recht, sich zur Leistungserbringung jederzeit und in\n        beliebigem Umfang Dritter zu bedienen.</p>\n    <p>4.6 Kostenfreie Tarife dürfen nur von Privatkunden verwendet werden. Die geschäftliche Nutzung ist nur\n        in kostenpflichtigen Tarifen erlaubt, außer dies ist im jeweiligen Tarif anders angegeben.</p>\n    <p>4.7. Jeder natürlichen Person ist es untersagt mehr als einen kostenfreien Tutanota-Account für den\n        Privatgebrauch zu registrieren. Für weitere Accounts muss ein kostenpflichtiger Tarif gewählt werden,\n        in dem weitere Benutzer-Accounts oder Aliasse angelegt werden können.</p>\n    <p>4.8. Tutao ist berechtigt, dem Kunden Sicherheitshinweise und Informationen zu Verträgen mit dem Kunden,\n     zu Produkt-Updates, zur Tutao GmbH, zu anderen eigenen Produkten und Produkten von Partnernunternehmen\n      anzuzeigen. Partnerunternehmen sind ausschließlich Unternehmen, die von der Tutao GmbH empfohlen werden,\n       weil diese sich für Menschenrechte, Datenschutz oder Privatsphäre einsetzen.</p>\n    <h4>5. Vertragslaufzeit, Vertragsverlängerung und -kündigung, Einstellung der Leistung</h4>\n    <p>5.1 Soweit sich nicht aus der jeweiligen Leistungsbeschreibung etwas\n        Anderes ergibt, läuft der Vertrag auf unbestimmte Zeit. Der Vertrag\n        ist für beide Vertragspartner mit einer Frist von einem Monat zum\n        Ablauf eines jeden gebuchten Abrechnungszeitraums kündbar. Wenn keine Kündigung\n        erfolgt, verlängert sich der Vertrag automatisch um den gewählten Abrechnungszeitraum.</p>\n    <p>5.2 Unberührt bleibt das Recht beider Vertragsparteien zur fristlosen\n        Kündigung aus wichtigem Grund. Ein wichtiger Grund für Tutao ist\n        insbesondere dann gegeben, wenn mindestens einer der folgenden\n        Sachverhalte vorliegt: der Kunde verstößt trotz Abmahnung schuldhaft\n        gegen eine vertragliche Pflicht (zum Beispiel gegen 8.4 dieser AGB),\n        der Kunde beseitigt trotz Abmahnung nicht innerhalb angemessener Frist\n        eine Vertrags- oder Rechtsverletzung. Eine Abmahnung ist entbehrlich,\n        wenn es sich um einen Verstoß handelt, der eine Fortsetzung des\n        Vertrags für Tutao unzumutbar macht.</p>\n    <p>5.3 Die Kündigung zum jeweiligen Tarif zusätzlich gewählter Optionen,\n        insbesondere zusätzlicher Accounts und Speicherplatz, lässt das\n        Vertragsverhältnis insgesamt unberührt.</p>\n    <p>5.4 Die außerordentliche Kündigung bedarf zu ihrer\n        Wirksamkeit der Schriftform. Die ordentliche Kündigung des Kunden\n        erfolgt durch das Löschen des letzten Administrationsaccounts\n        in den Einstellungen der Anwendung.</p>\n    <p>5.5 Nach Beendigung des Vertragsverhältnisses ist Tutao zur Erbringung\n        der vertraglichen Leistungen nicht mehr verpflichtet. Die rechtzeitige\n        Speicherung und Sicherung der Daten liegt daher in der Verantwortung\n        des Kunden.</p>\n    <p>5.6. Tutao ist berechtigt den Vertrag bei Nutzung eines kostenfreien Tarifs ohne Einhaltung einer Frist zu\n        kündigen, wenn der Account sechs Monate nicht verwendet wurde.</p>\n    <h4>6. Allgemeine Pflichten des Kunden</h4>\n    <p>6.1 Geschäftskunden sind verpflichtet, Tutao den vollständigen Namen und\n        eine ladungsfähige Postanschrift (keine Postfach- oder sonstige\n        anonyme Adresse) anzugeben. Der Kunde versichert,\n        dass alle an Tutao mitgeteilten Daten richtig und vollständig\n        sind.</p>\n    <p>6.2 Privatkunden sind bei der Buchung eines kostenpflichtigen Tarifs\n        verpflichtet, das Land des aktuellen Wohnsitzes anzugeben.</p>\n    <p>6.3 Der Kunde hat bei Änderungen die Daten unverzüglich\n        in der Anwendung zu aktualisieren.</p>\n    <h4>7. E-Mail-Empfang und –Versand, Verbot für „Spam“-E-Mails</h4>\n    <p>7.1 Tutao hat das Recht, die Maximalgröße der zu versendenden E-Mails\n        jeweils auf einen angemessenen Wert zu beschränken. Soweit sich aus\n        der jeweiligen Leistungsbeschreibung nichts anderes ergibt, beträgt\n        dieser Wert 20 MB.</p>\n    <p>7.2 Der Versand von E-Mails ist unzulässig, soweit es sich um einen\n        massenhaften Versand von E-Mails an Empfänger ohne deren Einwilligung\n        handelt und/oder es sich um eine Werbe-E-Mail handelt und eine\n        Einwilligung des Empfängers nicht vorliegt obwohl diese erforderlich\n        ist (insgesamt nachfolgend als „Spam“ bezeichnet). Der Nachweis einer\n        Einwilligung (vgl. § 7 Abs. 2 UWG) des jeweiligen Empfängers obliegt\n        dem Kunden.</p>\n    <p>7.3 Dem Kunden ist untersagt, über das System mehr als 100 E-Mails\n        pro Stunde je Account oder sogenannte „Paidmails“ bzw. E-Mails mit\n        denen ein „Referral-System“ beworben wird, zu versenden.</p>\n    <h4>8. Entgeltzahlung und Rechnungsstellung, Entgelterhöhung, Zahlungsverzug, Entgelterstattung</h4>\n    <p>8.1 Die Höhe der vom Kunden an Tutao zu bezahlenden Entgelte und der\n        jeweilige Abrechnungszeitraum ergeben sich aus der\n        Leistungsbeschreibung des vom Kunden gewählten Tarifs. Die\n        nutzungsunabhängigen Entgelte werden je nach gewähltem Abrechnungszeitraum\n        monatlich bzw. jährlich im Voraus fällig, die nutzungsabhängigen Entgelte\n        mit Rechnungsstellung.</p>\n    <p>8.2 Die Rechnungsstellung erfolgt online durch die elektronische\n        Zustellung der Rechnung. Die Rechnung gilt dem Kunden als zugegangen,\n        wenn sie für ihn elektronisch abrufbar und damit in seinen\n        Verfügungsbereich gelangt ist (z.B. per E-Mail). Tutao bleibt es unbenommen alternativ\n        zur Online-Rechnung die Rechnungsstellung postalisch vorzunehmen. Ein\n        Anspruch des Kunden auf Übersendung einer Rechnung auf dem Postwege\n        besteht jedoch nicht.</p>\n    <p>8.3 Der Kunde ermächtigt Tutao, die vom Kunden zu erbringenden\n        Zahlungen zu Lasten eines vom Kunden angegebenen Kontos\n        (z.B. Bankkonto, Kreditkarte, Paypal) einzuziehen. Der Kunde hat für\n        ausreichende Deckung des Kontos Sorge zu tragen. Erfolgt eine vom\n        Kunden zu vertretende Rückbuchung, ist der Kunde verpflichtet,\n        Tutao die hierfür anfallenden Gebühren zu erstatten. Geschäftskunden\n        können die Zahlung auf Rechnung wählen.</p>\n    <p>8.4 Befindet sich der Kunde mit einer Zahlung für zwei\n        aufeinanderfolgende Monate in Verzug, so ist Tutao berechtigt, den\n        Vertrag ohne Einhaltung einer Frist zu kündigen. Gleiches gilt, sofern\n        der Kunde sich über einen Zeitraum von mehr als zwei Monaten mit der\n        Zahlung in Höhe eines Betrags in Verzug befindet, der die Grundgebühr\n        für zwei Monate erreicht.</p>\n    <p>8.5 Tutao ist berechtigt, die Entgelte angemessen zu erhöhen. In jedem\n        Fall angemessen ist insoweit eine jährliche Erhöhung um höchstens 5\n        %. Die Entgelterhöhung bedarf der Zustimmung des Kunden. Die\n        Zustimmung gilt als erteilt, wenn der Kunde der Erhöhung nicht binnen\n        eines Monats nach Zugang der Änderungsmitteilung widerspricht. Tutao\n        ist verpflichtet, den Kunden mit der Änderungsmitteilung auf die\n        Folgen eines unterlassenen Widerspruchs hinzuweisen. Widerspricht der\n        Kunde der Preiserhöhung, steht Tutao ein Sonderkündigungsrecht zu.</p>\n    <p>8.6 Vorausbezahlte Entgelte werden dem Kunden erstattet, wenn der\n        Vertrag vor Ablauf des Abrechnungszeitraums durch Tutao gekündigt wird.\n        Im Falle einer wirksamen außerordentlichen Kündigung (Ziffer 5.2) durch Tutao hat\n        Tutao Anspruch auf Zahlung des Entgelts bis zum nächstmöglichen\n        ordentlichen Kündigungszeitpunkt.</p>\n    <h4>9. Leistungsstörungen</h4>\n    <p>9.1 Für Leistungsstörungen ist Tutao nur verantwortlich soweit diese\n        die von Tutao nach Ziffer 4.1 zu erbringenden Leistungen betreffen.</p>\n    <p>9.2 Störungen wird Tutao im Rahmen der technischen und betrieblichen\n        Möglichkeiten beseitigen. Der Kunde ist verpflichtet, Tutao für ihn\n        erkennbare Störungen unverzüglich anzuzeigen\n        („Störungsmeldung“). Erfolgt die Beseitigung der Störung nicht\n        innerhalb eines angemessenen Zeitraums, hat der Kunde Tutao eine\n        angemessene Nachfrist zu setzen. Wird die Störung innerhalb dieser\n        Nachfrist nicht beseitigt, bleibt dem Kunden das Recht vorbehalten,\n        wahlweise den Vertrag zu kündigen oder die Herabsetzung der\n        Vergütung zu verlangen. Bei einer die\n        Funktionstauglichkeit nicht einschränkenden unerheblichen Abweichung\n        der Leistung kann der Kunde nur die Herabsetzung der monatlichen\n        Vergütung verlangen. Etwaige Ansprüche nach Ziffer 10 bleiben hiervon\n        unberührt.</p>\n    <p>9.3 Im Falle höherer Gewalt ist Tutao von der Leistungspflicht\n        befreit. Hierzu zählen insbesondere rechtmäßige Arbeitskampfmaßnahmen,\n        auch in Drittbetrieben und behördliche Maßnahmen, soweit nicht von\n        Tutao verschuldet.</p>\n    <h4>10. Haftung von Tutao</h4>\n    <p>10.1 Eine Haftung von Tutao besteht ausschließlich im Rahmen der\n        Ziffern 10.2 bis 10.8. Die folgenden Haftungsbestimmungen gelten dabei\n        für Ansprüche aus jeglichem Rechtsgrund.</p>\n    <p>10.2 Tutao haftet dem Kunden für Schäden unbegrenzt, die von ihm oder\n        einem seiner Erfüllungsgehilfen oder gesetzlichen Vertreter\n        vorsätzlich oder grob fahrlässig verursacht werden. Bei Schäden aus\n        der Verletzung des Lebens, des Körpers oder der Gesundheit ist die\n        Haftung auch bei einer einfachen Pflichtverletzung von Tutao oder\n        eines seiner gesetzlichen Vertreter oder Erfüllungsgehilfen der Höhe\n        nach unbegrenzt. Ebenso der Höhe nach unbegrenzt ist die Haftung für\n        Schäden, die auf schwerwiegendes Organisationsverschulden von Tutao\n        zurückzuführen sind, sowie für Schäden, die durch das Fehlen einer\n        garantierten Beschaffenheit hervorgerufen werden.</p>\n    <p>10.3 Soweit nicht Ziffer 10.2 eingreift, haftet Tutao bei der\n        Verletzung wesentlicher Vertragspflichten der Höhe nach begrenzt auf\n        den vertragstypisch vorhersehbaren Schaden. Wesentliche\n        Vertragspflichten sind Pflichten, die der Vertrag Tutao nach seinem\n        Inhalt zur Erreichung des Vertragszwecks auferlegt und deren Erfüllung\n        die ordnungsgemäße Durchführung des Vertrags überhaupt erst\n        ermöglichen und auf deren Einhaltung der Kunde regelmäßig vertrauen\n        darf.</p>\n    <p>10.4 Bei einem von Tutao verschuldeten Datenverlust, haftet Tutao\n        ausschließlich für die Kosten der Rücksicherung und Wiederherstellung\n        von Daten, die auch bei einer ordnungsgemäß erfolgten Sicherung der\n        Daten verloren gegangen wären. Eine Haftung besteht jedoch nur im\n        Rahmen der Haftungsregelungen dieser AGB.</p>\n    <p>10.5 Die Haftung für entgangenen Gewinn wird ausgeschlossen.</p>\n    <p>10.6 Die Haftung nach dem Produkthaftungsgesetz bleibt von den\n        vorstehenden Haftungsregelungen unberührt.</p>\n    <p>10.7 Im Falle, dass das System als kostenlose Version\n        (d. h. gebührenfrei) zur Verfügung gestellt wurde, übernimmt Tutao in\n        Übereinstimmung mit den vorstehenden Regelungen nur für vorsätzliche\n        und arglistige Handlungen Haftung.</p>\n    <p>10.8 Tutao haftet nicht für Inhalte und Aktivitäten der Nutzer.</p>\n    <h4>11. Sperrung, Voraussetzungen und Aufhebung der Sperrung, Kostenerstattung</h4>\n    <p>11.1 Liegt ein schuldhaftes Verhalten des Kunden oder ein diesem\n        zurechenbares Verhalten Dritter vor, das gegen geltendes Deutsches\n        Recht, insbesondere gegen Vorschriften des Strafgesetzbuches oder\n        Jugendschutzes, oder diese AGB verstößt, kann Tutao eine vollständige oder\n        teilweise Sperrung der Dienste vornehmen. Das Recht zur fristlosen\n        Kündigung gemäß Ziffer 5.2 dieser AGB bleibt hiervon unberührt.</p>\n    <p>11.2 Durch eine Sperrung wird der Kunde nicht von seiner Verpflichtung\n        entbunden, die vereinbarten Entgelte zu entrichten. Besteht für Tutao\n        eine Mitteilungspflicht, so genügt es, wenn Tutao die jeweiligen\n        Mitteilungen per E-Mail an die E-Mail-Adresse des Kunden sendet. Für\n        die Sperrung und für die Aufhebung der Sperrung kann Tutao jeweils das\n        hierfür vereinbarte Entgelt (derzeit 50,00 Euro inkl. gesetzl. USt.)\n        berechnen („Sperr- und Entsperrgebühr“).</p>\n    <p>11.3 Soweit Tutao von Dritten wegen eines\n        schuldhaften Verhaltens des Kunden oder ein diesem zurechenbaren\n        Verhaltens Dritter in Anspruch genommen wird, das Tutao zur Sperrung\n        berechtigt, verpflichtet sich der Kunde, Tutao von allen Ansprüchen\n        freizustellen und diejenigen Kosten zu tragen, die durch die\n        Inanspruchnahme des rechtswidrigen Zustands entstanden sind.</p>\n    <h4>12. Nutzungsrechte</h4>\n    <p>12.1 Tutao räumt dem Kunden für die Dauer des Vertrags ein einfaches,\n        nicht übertragbares und nicht unterlizenzierbares Recht zur Nutzung\n        der zur Durchführung der Leistungen erforderlichen Software von Tutao\n        und deren Erweiterungen zum eigenen, internen Gebrauch ein. Die\n        Software ist urheberrechtlich geschützt. Soweit es nach dem\n        Urhebergesetz oder vertraglich nicht ausdrücklich gestattet ist, darf\n        der Kunde kein Reverse-Engineering, keine Disassemblierung und keine\n        Dekompilierung der Software durchführen oder durch Dritte durchführen\n        lassen.</p>\n    <h4>13. Datenschutz</h4>\n    <p>13.1 Sofern vom Kunden angegeben, erhebt, verarbeitet und nutzt Tutao\n        personenbezogene Daten des Kunden. Weitere Informationen zur Datenverarbeitung\n        und zum Datenschutz ergeben sich aus der Datenschutzerklärung von Tutao.</p>\n    <h4>14. Gerichtsstand, anwendbares Recht</h4>\n    <p>14.1 Es gilt das Recht der Bundesrepublik Deutschland. Unberührt\n        bleiben zwingende Vorschriften des Staates, in dem Privatkunden (=Verbraucher)\n        ihren gewöhnlichen Aufenthalt haben. Im Verkehr mit\n        Privatkunden innerhalb der Europäischen Union kann auch das Recht am\n        Wohnsitz des Privatkunden anwendbar sein, sofern es sich zwingend um\n        verbraucherrechtliche Vorschriften handelt.</p>\n    <p>14.2 Gerichtsstand für sämtliche Ansprüche aus den Vertragsbeziehungen\n        zwischen den Vertragsparteien sich ergebenden Streitigkeiten,\n        insbesondere über das Zustandekommen, die Abwicklung oder die\n        Beendigung des Vertrags ist – soweit der Kunde Vollkaufmann,\n        juristische Person des öffentlichen Rechts oder öffentlich-rechtliches\n        Sondervermögen ist – Hannover, Deutschland. Tutao kann den Kunden wahlweise auch an\n        dessen allgemeinem Gerichtsstand verklagen.</p>\n    <p>14.3. Die Geltung des Übereinkommens der Vereinten Nationen über\n        Verträge über den internationalen Warenkauf (UN-Kaufrecht) ist\n        ausgeschlossen, auch im grenzüberschreitenden Lieferverkehr.</p>\n    <h4>15. Aufrechnung, Zurückbehaltung, Salvatorische Klausel</h4>\n    <p>15.1 Mit Forderungen von Tutao kann der Kunde nur aufrechnen, soweit\n        diese unwidersprochen oder rechtskräftig festgestellt sind. Die\n        Geltendmachung eines Zurückbehaltungsrechts steht dem Kunden nur wegen\n        Gegenansprüchen zu, die aus dem Vertragsverhältnis mit Tutao\n        resultieren.</p>\n    <p>15.2 Sollten Bestimmungen dieser AGB und/oder des Vertrags unwirksam\n        sein oder werden, so berührt dies die Wirksamkeit der übrigen\n        Bestimmungen nicht. Die Vertragsparteien verpflichten sich, anstelle\n        einer unwirksamen Bestimmung eine gültige Vereinbarung zu treffen,\n        deren wirtschaftlicher Erfolg dem der unwirksamen so weit wie möglich\n        nahe kommt.</p>\n</section>'),_export("privacy_de",'<section id="privacy-de" class="content">\n    <h3>Datenschutzerklärung der Tutao GmbH, Hannover</h3>\n    <p><strong>Stand: 25. Mai 2018</strong></p>\n    <h4>Allgemeines</h4>\n    <p>Wir sind für den Schutz Ihrer personenbezogenen Daten verantwortlich und nehmen diese Verantwortung sehr ernst.\n        Aus diesem Grund</p>\n    <ul>\n        <li>ist Tutanota basierend auf Datenschutzgrundsätzen "Datenminimierung" und "Privacy by design" entwickelt\n            worden,\n        </li>\n        <li>werden alle Nutzerdaten in Tutanota Ende-zu-Ende verschlüsselt gespeichert (mit Außnahme von E-Mail-Adressen\n            der\n            Benutzer sowie Absender und Empfänger von E-Mails),\n        </li>\n        <li>sind bei uns geeignete technische und organisatorische Maßnahmen im Einsatz, die Ihre Daten bestmöglich\n            schützen,\n        </li>\n        <li>werden alle Daten in ISO 27001 zertifizierten Rechenzentren in Deutschland gespeichert.</li>\n    </ul>\n    <p>Die Verarbeitung personenbezogener Daten erfolgt stets im Einklang mit der Datenschutz-Grundverordnung (DSGVO)\n        sowie mit\n        den für die Tutao GmbH geltenden landesspezifischen Datenschutzbestimmungen.</p>\n    <p>Für Ihre Fragen zum Thema Datenschutz stehen wir Ihnen jederzeit gern zur Verfügung. Per E-Mail können Sie uns\n        wie folgt\n        erreichen: hello@tutao.de.</p>\n    <h4>Name und Anschrift des für die Verarbeitung Verantwortlichen</h4>\n    <p>Tutao GmbH<br>Deisterstr. 17a<br>30449 Hannover<br>Deutschland</p>\n    <p>E-Mail-Adresse: hello@tutao.de</p>\n    <h4>Personenbezogene Daten</h4>\n    <p>Alle von unser verarbeiteten personenbezogenen Daten werden von uns sicher aufbewahrt und somit vor\n        unberechtigten\n        Zugriffen geschützt.</p>\n    <p>Zur Begründung eines Vertragsverhältnisses, und zur Leistungserbringung wird</p>\n    <ul>\n        <li>die neu registrierte E-Mail-Adresse</li>\n    </ul>\n    <p>als Bestandsdatum erfasst.</p>\n    <p>Für die Rechnungsstellung und Bestimmung der Umsatzsteuer werden bei kostenpflichtigen Produktvarianten</p>\n    <ul>\n        <li>der Sitz des Kunden (Land)</li>\n        <li>die Rechnungsadresse (für Privatkunden optional)</li>\n        <li>die USt-IdNr. (nur für Geschäftskunden bestimmter Länder)</li>\n    </ul>\n    <p>als Bestandsdaten erfasst.</p>\n    <p>Zur Abwicklung von Zahlungen werden, je nach gewählter Zahlungsart, die folgenden Zahlungsdaten (Bestandsdaten)\n        erfasst:</p>\n    <ul>\n        <li>Bankverbindung (Kontonummer und BLZ bzw. IBAN/BIC, ggf. Bankname, Kontoinhaber),</li>\n        <li>Kreditkartendaten,</li>\n        <li>der PayPal-Nutzername.</li>\n    </ul>\n    <p>Diese Bestandsdaten werden zur Erfüllung des Vertrages mit dem Kunden nach Art. 6 DSGVO 1. b) verarbeitet. Zur\n        Abwicklung von Lastschriften geben wir Ihre Bankverbindung an das beauftragte Kreditinstitut weiter. Zur\n        Abwicklung\n        von PayPal-Zahlungen geben wir Ihre PayPal-Zahlungsdaten an PayPal (Europe) weiter.</p>\n    <ul>\n        <li>Adresse: PayPal (Europe) S.à r.l. et Cie, S.C.A.,22-24 Boulevard Royal, L-2449 Luxembourg</li>\n        <li>Datenschutzerkärung: <a href="https://www.paypal.com/de/webapps/mpp/ua/privacy-prev">https://www.paypal.com/de/webapps/mpp/ua/privacy-prev</a>\n        </li>\n        <li>Kontakt für Fragen zum Datenschutz: <a href="https://www.paypal.com/de/selfhelp/contact/email/privacy">https://www.paypal.com/de/selfhelp/contact/email/privacy</a>\n        </li>\n    </ul>\n    <p>Zur Abwicklung von Kreditkartenzahlungen werden Ihre Kreditkartendaten zur Auftragsverarbeitung an unseren\n        Zahlungsdienstleister <a href="https://www.braintreepayments.com/">Braintree</a> weitergegeben. Hierbei handelt\n        es sich\n        um eine Übermittlung von personenbezogenen Daten an ein Drittland (USA). Ein mit Braintree geschlossener\n        Vertrag sieht geeignete Garantien vor und stellt sicher, dass die weitergegebenen Daten nur im Einklang mit der\n        DSGVO und lediglich zur Abwicklung von Zahlungen verwendet werden. Dieser Vertrag kann hier eingesehen\n        werden: <a href="https://www.braintreepayments.com/assets/Braintree-PSA-Model-Clauses-March2018.pdf">https://www.braintreepayments.com/assets/Braintree-PSA-Model-Clauses-March2018.pdf</a>\n    </p>\n    <p>Tutanota stellt Dienste zur Speicherung, Bearbeitung, Darstellung und zum elektronischen Versand von Daten\n        bereit, wie\n        z.B. E-Mail-Service, Kontaktverwaltung und Datenablage. Diese Inhaltsdaten werden freiwillig in Tutanota vom\n        Kunden\n        abgelegt. Beim Anlegen eines Tutanota-Accounts geben Sie uns die Einwilligung zu der Verarbeitung dieser Daten\n        nach\n        Art. 6 DSGVO 1. a). Alle textuellen Inhalte werden verschlüsselt für den Nutzer und dessen Kommunikationspartner\n        gespeichert, so dass die Tutao GmbH selbst keinen Zugriff auf diese Daten hat. Diese Daten können vom Kunden\n        selbst gelöscht werden.</p>\n    <p>Zur Aufrechterhaltung des Mailserver-Betriebs, zur Fehlerdiagnose und zur Verhinderung von Missbrauch werden\n        Mail-Server-Logs maximal 7 Tage gespeichert. Diese enthalten Sender- und Empfänger-E-Mail-Adressen sowie den\n        Zeitpunkt der Verbindung, jedoch keine IP-Adressen der Kunden. Diese Speicherung erfolgt zur Wahrung der\n        berechtigten\n        Interessen des Verantwortlichen nach Art. 6 DSGVO 1. f).</p>\n    <p>Zur Sicherstellung des Betriebs, zur Verhinderung von Missbrauch und zur Besucherauswertung werden IP-Adressen\n        der\n        Kunden verarbeitet. Eine Speicherung erfolgt nur für anonymisierte und damit nicht mehr personenbezogene\n        IP-Adressen.\n        Diese Verarbeitung erfolgt zur Wahrung der berechtigten Interessen des Verantwortlichen nach Art. 6 DSGVO 1.\n        f).</p>\n    <p>Mit Ausnahme der Zahlungsdaten werden wir Ihre personenbezogenen Daten inklusive der E-Mail-Adresse nicht an\n        Dritte\n        weitergeben. Jedoch können wir rechtlich verpflichtet werden Inhaltsdaten (bei Vorlage eines gültigen deutschen\n        Gerichtsbeschlusses) sowie Bestandsdaten an Strafverfolgungsbehörden auszuliefern. Es erfolgt kein Verkauf von\n        Daten.</p>\n    <h4>Zeitraum der Datenspeicherung</h4>\n    <p>Alle personenbezogenen Daten werden 30 Tage nach Beendigung des Vertragsverhältnisses gelöscht, sofern dem im\n        Einzelfall\n        nicht besondere Gründe entgegenstehen. Soweit Kunden gegen die Höhe der in der Rechnung gestellten\n        Leistungsentgelte\n        Einwendungen erhoben haben, dürfen die Abrechnungsdaten gespeichert werden, bis die Einwendungen abschließend\n        geklärt sind. Ferner können Bestandsdaten bis zum Ablauf von zwei Jahren gespeichert bleiben, sofern\n        Beschwerdebearbeitungen sowie sonstige Gründe einer ordnungsgemäßen Abwicklung des Vertragsverhältnisses dies\n        erfordern. Im Übrigen darf die Löschung von Bestands- und Abrechnungsdaten unterbleiben, soweit dies gesetzliche\n        Regelungen vorsehen oder die Verfolgung von Ansprüchen dies erfordert. Auftragsbezogene Daten und die damit\n        verbundenen Adressen werden mit Rücksicht auf steuer-, vertrags- und handelsrechtliche Aufbewahrungsfristen\n        gespeichert und nach Ablauf dieser Fristen gelöscht.</p>\n    <h4>Rechte der betroffenen Person</h4>\n    <p>Soweit Sie uns eine Einwilligung zur Verarbeitung Ihrer personenbezogenen Daten gegeben haben, möchten wir\n        Sie darauf hinweisen, dass Sie Ihre Einwilligung jederzeit mit Wirkung für die Zukunft widerrufen können.\n        Auf Verlangen werden wir Ihnen unentgeltlich Auskunft über die zu Ihrer Person gespeicherten Daten erteilen.\n        Wenn Sie dies wünschen, senden Sie bitte eine Nachricht an hello@tutao.de. Ebenso sind wir verpflichtet, auf\n        Verlangen die über Sie gespeicherten Daten zu löschen, zu berichtigen oder ihre Verarbeitung einzuschränken.\n        Außerdem können Sie <strong>Widerspruch gegen die Verarbeitung Ihrer personenbezogenen Daten einlegen</strong>\n        sowie\n        Beschwerde bei einer Datenschutzaufsichtsbehörde und bei der Bundesbeauftragten oder dem Bundesbeauftragten\n        für den Datenschutz und die Informationsfreiheit (Husarenstr. 30, 53117 Bonn) einreichen. Sie können von\n        Ihrem Recht auf Datenübertragbarkeit Gebrauch machen, indem Sie Ihre bei uns gespeicherten Daten aus Tutanota\n        exportieren.</p>\n    <h4>Cookies</h4>\n    <p>Wir verwenden keine Cookies.</p>\n    <h4>Kontaktmöglichkeit über die Internetseite</h4>\n    <p>Wir bieten über unsere Internetseite die Möglichkeit per E-Mail oder über ein Kontaktformular mit uns in Kontakt\n        zu treten. Die so freiwilling an uns übermittelten personenbezogenen Daten werden automatisch gespeichert und\n        nur\n        für Zwecke der Bearbeitung und der Kontaktaufnahme zur betroffenen Person verwendet. Es erfolgt keine Weitergabe\n        dieser personenbezogenen Daten an Dritte.</p>\n</section>'),_export("privacy_de",'<section id="privacy-de" class="content">\n    <h3>Datenschutzerklärung der Tutao GmbH, Hannover</h3>\n    <p><strong>Stand: 25. Mai 2018</strong></p>\n    <h4>Allgemeines</h4>\n    <p>Wir sind für den Schutz Ihrer personenbezogenen Daten verantwortlich und nehmen diese Verantwortung sehr ernst.\n        Aus diesem Grund</p>\n    <ul>\n        <li>ist Tutanota basierend auf Datenschutzgrundsätzen "Datenminimierung" und "Privacy by design" entwickelt\n            worden,\n        </li>\n        <li>werden alle Nutzerdaten in Tutanota Ende-zu-Ende verschlüsselt gespeichert (mit Außnahme von E-Mail-Adressen\n            der\n            Benutzer sowie Absender und Empfänger von E-Mails),\n        </li>\n        <li>sind bei uns geeignete technische und organisatorische Maßnahmen im Einsatz, die Ihre Daten bestmöglich\n            schützen,\n        </li>\n        <li>werden alle Daten in ISO 27001 zertifizierten Rechenzentren in Deutschland gespeichert.</li>\n    </ul>\n    <p>Die Verarbeitung personenbezogener Daten erfolgt stets im Einklang mit der Datenschutz-Grundverordnung (DSGVO)\n        sowie mit\n        den für die Tutao GmbH geltenden landesspezifischen Datenschutzbestimmungen.</p>\n    <p>Für Ihre Fragen zum Thema Datenschutz stehen wir Ihnen jederzeit gern zur Verfügung. Per E-Mail können Sie uns\n        wie folgt\n        erreichen: hello@tutao.de.</p>\n    <h4>Name und Anschrift des für die Verarbeitung Verantwortlichen</h4>\n    <p>Tutao GmbH<br>Deisterstr. 17a<br>30449 Hannover<br>Deutschland</p>\n    <p>E-Mail-Adresse: hello@tutao.de</p>\n    <h4>Personenbezogene Daten</h4>\n    <p>Alle von unser verarbeiteten personenbezogenen Daten werden von uns sicher aufbewahrt und somit vor\n        unberechtigten\n        Zugriffen geschützt.</p>\n    <p>Zur Begründung eines Vertragsverhältnisses, und zur Leistungserbringung wird</p>\n    <ul>\n        <li>die neu registrierte E-Mail-Adresse</li>\n    </ul>\n    <p>als Bestandsdatum erfasst.</p>\n    <p>Für die Rechnungsstellung und Bestimmung der Umsatzsteuer werden bei kostenpflichtigen Produktvarianten</p>\n    <ul>\n        <li>der Sitz des Kunden (Land)</li>\n        <li>die Rechnungsadresse (für Privatkunden optional)</li>\n        <li>die USt-IdNr. (nur für Geschäftskunden bestimmter Länder)</li>\n    </ul>\n    <p>als Bestandsdaten erfasst.</p>\n    <p>Zur Abwicklung von Zahlungen werden, je nach gewählter Zahlungsart, die folgenden Zahlungsdaten (Bestandsdaten)\n        erfasst:</p>\n    <ul>\n        <li>Bankverbindung (Kontonummer und BLZ bzw. IBAN/BIC, ggf. Bankname, Kontoinhaber),</li>\n        <li>Kreditkartendaten,</li>\n        <li>der PayPal-Nutzername.</li>\n    </ul>\n    <p>Diese Bestandsdaten werden zur Erfüllung des Vertrages mit dem Kunden nach Art. 6 DSGVO 1. b) verarbeitet. Zur\n        Abwicklung von Lastschriften geben wir Ihre Bankverbindung an das beauftragte Kreditinstitut weiter. Zur\n        Abwicklung\n        von PayPal-Zahlungen geben wir Ihre PayPal-Zahlungsdaten an PayPal (Europe) weiter.</p>\n    <ul>\n        <li>Adresse: PayPal (Europe) S.à r.l. et Cie, S.C.A.,22-24 Boulevard Royal, L-2449 Luxembourg</li>\n        <li>Datenschutzerkärung: <a href="https://www.paypal.com/de/webapps/mpp/ua/privacy-prev">https://www.paypal.com/de/webapps/mpp/ua/privacy-prev</a>\n        </li>\n        <li>Kontakt für Fragen zum Datenschutz: <a href="https://www.paypal.com/de/selfhelp/contact/email/privacy">https://www.paypal.com/de/selfhelp/contact/email/privacy</a>\n        </li>\n    </ul>\n    <p>Zur Abwicklung von Kreditkartenzahlungen werden Ihre Kreditkartendaten zur Auftragsverarbeitung an unseren\n        Zahlungsdienstleister <a href="https://www.braintreepayments.com/">Braintree</a> weitergegeben. Hierbei handelt\n        es sich\n        um eine Übermittlung von personenbezogenen Daten an ein Drittland (USA). Ein mit Braintree geschlossener\n        Vertrag sieht geeignete Garantien vor und stellt sicher, dass die weitergegebenen Daten nur im Einklang mit der\n        DSGVO und lediglich zur Abwicklung von Zahlungen verwendet werden. Dieser Vertrag kann hier eingesehen\n        werden: <a href="https://www.braintreepayments.com/assets/Braintree-PSA-Model-Clauses-March2018.pdf">https://www.braintreepayments.com/assets/Braintree-PSA-Model-Clauses-March2018.pdf</a>\n    </p>\n    <p>Tutanota stellt Dienste zur Speicherung, Bearbeitung, Darstellung und zum elektronischen Versand von Daten\n        bereit, wie\n        z.B. E-Mail-Service, Kontaktverwaltung und Datenablage. Diese Inhaltsdaten werden freiwillig in Tutanota vom\n        Kunden\n        abgelegt. Beim Anlegen eines Tutanota-Accounts geben Sie uns die Einwilligung zu der Verarbeitung dieser Daten\n        nach\n        Art. 6 DSGVO 1. a). Alle textuellen Inhalte werden verschlüsselt für den Nutzer und dessen Kommunikationspartner\n        gespeichert, so dass die Tutao GmbH selbst keinen Zugriff auf diese Daten hat. Diese Daten können vom Kunden\n        selbst gelöscht werden.</p>\n    <p>Zur Aufrechterhaltung des Mailserver-Betriebs, zur Fehlerdiagnose und zur Verhinderung von Missbrauch werden\n        Mail-Server-Logs maximal 7 Tage gespeichert. Diese enthalten Sender- und Empfänger-E-Mail-Adressen sowie den\n        Zeitpunkt der Verbindung, jedoch keine IP-Adressen der Kunden. Diese Speicherung erfolgt zur Wahrung der\n        berechtigten\n        Interessen des Verantwortlichen nach Art. 6 DSGVO 1. f).</p>\n    <p>Zur Sicherstellung des Betriebs, zur Verhinderung von Missbrauch und zur Besucherauswertung werden IP-Adressen\n        der\n        Kunden verarbeitet. Eine Speicherung erfolgt nur für anonymisierte und damit nicht mehr personenbezogene\n        IP-Adressen.\n        Diese Verarbeitung erfolgt zur Wahrung der berechtigten Interessen des Verantwortlichen nach Art. 6 DSGVO 1.\n        f).</p>\n    <p>Mit Ausnahme der Zahlungsdaten werden wir Ihre personenbezogenen Daten inklusive der E-Mail-Adresse nicht an\n        Dritte\n        weitergeben. Jedoch können wir rechtlich verpflichtet werden Inhaltsdaten (bei Vorlage eines gültigen deutschen\n        Gerichtsbeschlusses) sowie Bestandsdaten an Strafverfolgungsbehörden auszuliefern. Es erfolgt kein Verkauf von\n        Daten.</p>\n    <h4>Zeitraum der Datenspeicherung</h4>\n    <p>Alle personenbezogenen Daten werden 30 Tage nach Beendigung des Vertragsverhältnisses gelöscht, sofern dem im\n        Einzelfall\n        nicht besondere Gründe entgegenstehen. Soweit Kunden gegen die Höhe der in der Rechnung gestellten\n        Leistungsentgelte\n        Einwendungen erhoben haben, dürfen die Abrechnungsdaten gespeichert werden, bis die Einwendungen abschließend\n        geklärt sind. Ferner können Bestandsdaten bis zum Ablauf von zwei Jahren gespeichert bleiben, sofern\n        Beschwerdebearbeitungen sowie sonstige Gründe einer ordnungsgemäßen Abwicklung des Vertragsverhältnisses dies\n        erfordern. Im Übrigen darf die Löschung von Bestands- und Abrechnungsdaten unterbleiben, soweit dies gesetzliche\n        Regelungen vorsehen oder die Verfolgung von Ansprüchen dies erfordert. Auftragsbezogene Daten und die damit\n        verbundenen Adressen werden mit Rücksicht auf steuer-, vertrags- und handelsrechtliche Aufbewahrungsfristen\n        gespeichert und nach Ablauf dieser Fristen gelöscht.</p>\n    <h4>Rechte der betroffenen Person</h4>\n    <p>Soweit Sie uns eine Einwilligung zur Verarbeitung Ihrer personenbezogenen Daten gegeben haben, möchten wir\n        Sie darauf hinweisen, dass Sie Ihre Einwilligung jederzeit mit Wirkung für die Zukunft widerrufen können.\n        Auf Verlangen werden wir Ihnen unentgeltlich Auskunft über die zu Ihrer Person gespeicherten Daten erteilen.\n        Wenn Sie dies wünschen, senden Sie bitte eine Nachricht an hello@tutao.de. Ebenso sind wir verpflichtet, auf\n        Verlangen die über Sie gespeicherten Daten zu löschen, zu berichtigen oder ihre Verarbeitung einzuschränken.\n        Außerdem können Sie <strong>Widerspruch gegen die Verarbeitung Ihrer personenbezogenen Daten einlegen</strong>\n        sowie\n        Beschwerde bei einer Datenschutzaufsichtsbehörde und bei der Bundesbeauftragten oder dem Bundesbeauftragten\n        für den Datenschutz und die Informationsfreiheit (Husarenstr. 30, 53117 Bonn) einreichen. Sie können von\n        Ihrem Recht auf Datenübertragbarkeit Gebrauch machen, indem Sie Ihre bei uns gespeicherten Daten aus Tutanota\n        exportieren.</p>\n    <h4>Cookies</h4>\n    <p>Wir verwenden keine Cookies.</p>\n    <h4>Kontaktmöglichkeit über die Internetseite</h4>\n    <p>Wir bieten über unsere Internetseite die Möglichkeit per E-Mail oder über ein Kontaktformular mit uns in Kontakt\n        zu treten. Die so freiwilling an uns übermittelten personenbezogenen Daten werden automatisch gespeichert und\n        nur\n        für Zwecke der Bearbeitung und der Kontaktaufnahme zur betroffenen Person verwendet. Es erfolgt keine Weitergabe\n        dieser personenbezogenen Daten an Dritte.</p>\n</section>'),_export("terms_en",'\n<section id="terms-en" class="content">\n    <h3>Terms and Conditions of Tutao GmbH</h3>\n    <p>These General Terms and Conditions are provided in English for your convenience. Please note that in case of a dispute or discrepancy\n\tbetween the German Terms and Conditions and the English translation, the German version shall prevail.</em></p>\n    <p>&nbsp;</p>\n    <h4>1. General, scope</h4>\n    <p>1.1 The Tutao GmbH Address: Deisterstr. 17a, 30449 Hanover, e-mail:\n        hello@tutao.de, phone: +49 511 202801-0 (hereafter Tutao)\n        provides all deliveries and services solely on the basis of these\n        Terms and Conditions.</p>\n    <p>1.2 These Terms and Conditions apply to entrepreneurs according to § 14 BGB\n        (German Civil Code) (hereafter business customers) as wells as to consumers\n        according to § 13 BGB (German Civil Code) (hereafter private customers).\n        A consumer is any natural person entering into a legal transaction for a\n        purpose that cannot be attributed to their commercial or to their independent\n        vocational activity.</p>\n    <p>1.3 For business users these Terms and Conditions are valid for all future\n        business with Tutao.</p>\n    <p>1.4 Terms and Conditions of the business user that differ from Tutao\'s Terms and\n        Conditions completely or in parts are not recognized, unless Tutao accepts them\n        with a written statement. The Terms and Conditions of Tutao also apply exclusively\n        if Tutao unconditionally renders a service in the knowledge of conflicting Terms\n        and Conditions of the customer.</p>\n    <h4>2. Conclusion of contract</h4>\n    <p>2.1 The customer sends the request on completion of the proposed\n        contract either by dispatching an electronic statement or by\n        transmitting the order form in writing to Tutao if this is\n        offered. The contract is concluded with the allocation of an\n        account by Tutao.</p>\n    <h4>3. Notice of cancellation</h4>\n    <p>3.1 If the customer is a private customer and the contract was concluded\n        exclusively by means of distance communication (distance selling\n        contract), the private customer has the statutory right of withdrawal\n        described below:</p>\n    <hr>\n    <p><strong>Notice of cancellation</strong></p>\n    <p><strong>Right of withdrawal</strong></p>\n    <p>You have the right to cancel this contract within fourteen days\n        without giving any reason. The withdrawal period is fourteen days from\n        the date of contract. To exercise your right of cancellation, you must\n        notify us</p>\n    <p>Tutao GmbH<br>\n        Deisterstr. 17a<br>\n        30449 Hanover<br>\n        Germany</p>\n    <p>Phone: +49 511 202801-0<br>\n        Fax: +49 511 202801-19 or<br>\n        Email: hello@tutao.de</p>\n    <p>with a clear statement (eg a letter sent via post, a fax or an email)\n        of your decision to withdraw from this contract. You can use the\n        attached model withdrawal form. However this is not mandatory.</p>\n    <p>In order to observe the withdrawal period it is sufficient to send the\n        notice claiming the right of withdrawal within the withdrawal period.</p>\n    <p><strong>Results of Withdrawal</strong></p>\n    <p>If you withdraw from this contract, we have to return all payments\n        that we have received from you including delivery costs (with the\n        exception of the additional costs arising from the fact that you have\n        chosen a more expensive type of delivery other than the standard\n        delivery offered by us) which must be repaid immediately at the latest\n        within fourteen days from the date on which we have received your\n        notice of cancellation of this contract. For this repayment we use the\n        same method of payment that you have used for the initial transaction,\n        unless you explicitly agreed otherwise; in any case you will not be\n        charged fees for this repayment.</p>\n    <p>In case that you have required the services to start during the\n        withdrawal period, you have to pay us a reasonable amount compared to\n        the full extent of the service covered in this contract for the\n        service already provided to you up to the date on which you notify us\n        of the right of withdrawal of this contract.</p>\n    <p><strong>End of Notice of cancellation</strong></p>\n    <hr>\n    <p><strong>Model form for withdrawal</strong></p>\n    <p>(If you want to withdraw from the contract, you can fill in this form\n        and send it back to us.)</p>\n    <p>To<br>\n        Tutao GmbH<br>\n        Deisterstr. 17a<br>\n        30449 Hanover<br>\n        Germany</p>\n    <p>Fax: +49 511 202801-19 or<br>\n        Email: hello@tutao.de</p>\n    <p>Hereby I/we* give notice that I/we* withdraw from my/our* agreement of\n        sale of the following goods*/provision of the following service*:</p>\n    <p>Ordered on*/received on*: ______________________</p>\n    <p>Name of customer(s): ______________________</p>\n    <p>Address of customer(s): ______________________</p>\n    <p>Tutanota e-mail address of the customer(s):\n        ______________________</p>\n    <p><br>\n        Signature of customer(s) (only if sent on paper):\n        ______________________</p>\n    <p><br>\n        Date: ______________________</p>\n    <p>*) Delete as applicable.</p>\n    <hr>\n    <h4>4. Subject of the contract and alteration of the contract</h4>\n    <p>4.1 Tutao provides the customer with the system Tutanota in accordance\n        to the respective service descriptions of the selected tariff. The availability\n        is 99 % annual average, in regards to 24 hours per day, seven days per week.\n        Exempt from this availability are time periods, during which Tutanota is not\n        available due to technical or other issues that do not lie in the sphere of\n        influence of Tutao (force majeure, fault of third parties, etc.).\n        Tutao conducts a regular maintenance of the software and the system. For\n        this purpose Tutao can adjust or limit services temporarily while\n        taking into account the interests of the customer as long as objective reasons\n        justify it. If possible this work will be conducted during non-peak hours,\n        particularly Fridays to Sundays, between 10:00 pm and 06:00 am (CET). If Tutao\n        estimates that the time for maintenance and software updates will lead to a\n        downtime of more than three hours, Tutao will inform all paying customers\n        three days in advance. Tutao is only responsible for the availability if it\n        is effected by the part of the system operated by Tutao.</p>\n    <p>4.2 If in the respective service description of the selected tariff a\n        certain amount of storage space is defined, this applies to the entire\n        available storage space according to the service description and is\n        used, among other things, for the storage of metadata (file history,\n        etc.).</p>\n    <p>4.3 Tutao retains the right to extend services and make improvements\n        if these are pertinent to the technical progress, if these seem to be\n        necessary to prevent abuse, or if Tutao is required to do so by\n        law. With the consent of the customer, Tutao can conduct other changes\n        in the content of the contract, including these Terms and Conditions,\n        if the change is reasonable to the customer taking into account the\n        interests of Tutao. Particularly unacceptable is any contract change\n        that results in a reduction of a principal contractual service offered\n        by Tutao. If the alteration of the contract results in increased fees\n        payable by the customer, the admissibility of this is regulated under\n        Clause 8.5 of these Terms and Conditions. The approval of the\n        alteration of the contract is deemed as granted if the customer does\n        not object to the alteration within one month after receiving the\n        notification of the alteration. Tutao agrees to notify the customer in\n        the course of the alteration notification of the consequences of\n        non-objection.</p>\n    <p>4.4 Voluntary and unpaid services and benefits of Tutao which\n        explicitly are described as such and are not part of the service\n        description can be cancelled by Tutao at any time. Upon alterations\n        and cancellation of free services Tutao will take into account the\n        legitimate interests of the customers.</p>\n    <p>4.5 Tutao has the right to use services of third parties for the\n        service provision at any time and in any amount.</p>\n    <p>4.6 Free of charge versions of Tutanota are only allowed to be used by private customers. Business use is\n        only allowed in paid versions of Tutanota, except this is stated differently in the respective tariff.</p>\n    <p>4.7. Each natural person is prohibited to sign up for more than one free of charge Tutanota account\n        for private use. For additional accounts a paid tariff must be selected which allows adding aliases and user\n        accounts.</p>\n    <p>4.8. Tutao has the right to show its customers security notices as well as information in regards\n\t to contracts with the customers, to product updates, to Tutao GmbH, to other products and to products \n\t of partners. Partners are exclusively companies that can be recommended by Tutao GmbH because they\n\t  advocate human rights, data protection or privacy.</p>\n    <h4>5. Term of contract, contract renewal and contract termination, termination of services</h4>\n    <p>5.1 Unless stated otherwise in the respective service description, the\n        contract is effective for an indefinite time. The agreement may be\n        terminated by either party with a notice period of one month prior to the\n        end of each billing period. If the contract is not terminated, the\n        contract is automatically renewed with the same billing period.</p>\n    <p>5.2 This does not affect the right of either party to terminate the\n        contract without previous notice of a cause. A cause for Tutao is\n        particularly given if at least one of the following situations occur:\n        despite warning the customer culpably violates a contractual\n        obligation (for example against 8.4 of these Terms and Conditions),\n        despite warning the customer does not eliminate a\n        violation of contract or of law within a reasonable period of time. A warning is\n        not necessary if there is a violation that makes a continuation of the\n        contract for Tutao unreasonable.</p>\n    <p>5.3 The termination of additional options, particularly additional accounts or\n        storage space, of the respective tariff leaves the general contract\n        unaffected.</p>\n    <p>5.4 The extraordinary termination shall be effective only in writing.\n        The ordinary termination by the customer is carried out with the deletion\n        of the last administrative account within the Settings of the application.</p>\n    <p>5.5 After termination of the contract, Tutao is no longer obligated to\n        provide the contractual services. The timely storage and backup of the\n        data, is the customer\'s responsibility.</p>\n    <p>5.6. Tutao is entitled to terminate the contract without notice in case of a free of charge tariff if the account\n        was not used for at least six months.</p>\n    <h4>6. General obligations of the customer</h4>\n    <p>6.1 Business customers are obliged to state their full name and a complete\n        address required for a summons (not a post box or another anonymous\n        address). The customer assures that all data\n        communicated to Tutao are correct and complete. </p>\n    <p>6.2 Upon booking a paid version of Tutanota, private customers are\n        obliged to state the country of their current domicile.</p>\n    <p>6.3 The customer is obliged to update this information in the application as soon\n        as it changes.</p>\n    <h4>7. Email receiving and sending, ban on spam emails</h4>\n    <p>7.1 Tutao has the right to limit the maximum size of emails to be sent\n        to an appropriate size. If in the respective service description it is\n        not stated otherwise, the max. email size is 20 MB.</p>\n    <p>7.2 The sending of emails is inadmissible if it is a mass-mailing to\n        recipients without their consent and/or if it is a promotional email\n        and consent of the recipient is not given even though this is required\n        (hereafter referred to as spam). Proof of consent (see § 7 paragraph\n        2 UWG (Act Against Unfair Competition)) of each recipient rests with\n        the customer.</p>\n    <p>7.3 The customer is prohibited to send more than 100 emails per\n        hour per account or to send so-called paid emails or\n        emails that advertise a referral system.</p>\n    <h4>8. Payment and invoicing, payment increase, delay of payment, payment refund</h4>\n    <p>8.1 The amounts to be paid by the customer to Tutao and the respective\n        billing period result from the service description of the selected\n        tariff by the customer. Usage-independent fees are payable in advance\n        of the chosen billing period, usage-dependent fees are charged with an invoice.</p>\n    <p>8.2 Invoices are issued online through the electronic delivery of the\n        invoice. The invoice shall be deemed as delivered to the customer as\n        soon as it is available electronically and hence reachable for\n        him (e.g. sent to his mailbox). Tutao retains the right to send the invoice via post.\n        However it is not required that the customer\n        receives a printed invoice through the post.</p>\n    <p>8.3 The customer authorizes Tutao to collect the charges to be paid by\n        the customer from an account (e.g. banking account, credit card, PayPal)\n        specified by the customer. The customer\n        has to take care of sufficient funding in the account. If there is a chargeback caused by the\n        customer, the customer is obligated to reimburse Tutao the occurring\n        banking fees. Business customers may choose to pay on invoice.</p>\n    <p>8.4 If the customer falls behind payment for two consecutive months,\n        Tutao is entitled to terminate the contract without notice. The same\n        applies if the customer falls behind payment of an amount that reaches\n        the basic fee for two months over a period of more than two months.</p>\n    <p>8.5 Tutao is entitled to increase the fees reasonably. Considered as\n        reasonable is an annual increase to the extent of 5% at most. The fee\n        increase will be subject to the approval of the customer.\n        Tutao is obliged to notify\n        the customer of the price change (e.g. via email). The consent of the customer\n        shall be deemed as granted if the customer does not object to the\n        increase within one month of notification. If the customer contradicts the price increase, Tutao\n        has a special right of termination.</p>\n    <p>8.6 Prepaid fees are refunded to the customer if Tutao ends the contract\n        prior to the end of the billing period. In case of an effective\n        extraordinary termination (Clause 5.2) by Tutao, Tutao is entitled to receive the\n        payment of the fee until the next possible ordinary termination date.</p>\n    <h4>9. Disturbances of service</h4>\n    <p>9.1 Tutao is only responsible for disturbances of services if these\n        apply to services to be performed by Tutao referred to under Clause\n        4.1.</p>\n    <p>9.2 Tutao will eliminate disturbances according to technical and\n        operational capabilities. The customer is obliged to notify Tutao of\n        disturbances observable by him immediately (malfunction\n        information). If the disturbance is not eliminated within a\n        reasonable amount of time, the customer shall set a reasonable\n        additional respite. If the disturbance is not corrected within this\n        respite, the customer retains the right to terminate the contract or\n        to demand a reduction of the monthly fee. If the disturbance only\n        results in a deviation of the service and does not limit its\n        functionality, the customer can only demand a reduction of the\n        fee. Any claims made under Clause 10 shall remain unaffected.</p>\n    <p>9.3 In the event of force majeure Tutao is exempt from\n        liability. These include in particular lawful industrial action, also\n        in third party companies as well as regulatory measures, if not caused\n        by Tutao.</p>\n    <h4>10. Liability of Tutao</h4>\n    <p>10.1 The liability of Tutao exists solely in the context of Clauses\n        10.2 to 10.8. The following liability provisions apply to claims\n        resulting from any legal reason.</p>\n    <p>10.2 Tutao is liable to the customer for damages without limit caused\n        intentionally or by gross negligence by him or by one of its\n        assistants or legal representatives. In case of damages arising from\n        injury to life, body or health, liability is unlimited even when\n        caused by a simple breach of duty by Tutao or one of its legal\n        representatives or assistants. Similarly, the liability is unlimited\n        for damages that are due to serious organizational faults of Tutao,\n        and for damages caused by the lack of a guaranteed quality.</p>\n    <p>10.3 Unless covered by Clause 10.2, Tutao is liable for the violation\n        of essential contractual obligations; the amount of liability is\n        limited to the typically foreseeable damage. Essential contractual\n        obligations are obligations imposed on Tutao by the content of the\n        contract for achieving the purpose of the contract and the fulfillment\n        of which enable the proper execution of the contract in the first\n        place and on whose regular compliance the customer can rely on.</p>\n    <p>10.4 For data loss caused by Tutao, Tutao is only liable for the costs\n        that result from recovering of the data that would have also been lost despite\n        performing appropriate data backup measurements. A liability is limited to the liability\n        regulations of these Terms and Conditions.</p>\n    <p>10.5. The liability for any lost profit is excluded.</p>\n    <p>10.6 The liability under the Produkthaftungsgesetz\n        shall remain unaffected by the preceding liability\n        provisions. (The Product Liability Act is a German law that defines the liability of a producer of a\n        product.)</p>\n    <p>10.7 In the event that the system was provided as a free version (i.e.\n        free of charge), Tutao accepts liability in accordance with the above\n        provisions only for willful and malicious acts.</p>\n    <p>10.8 Tutao is not liable for the content or the activities of its users.</p>\n    <h4>11. Blocking, requirements of unblocking, reimbursement</h4>\n    <p>11.1 If there is a culpable conduct of the customer or of a third\n        party attributable to this customer which is violating any German law,\n        in particular provisions of the Criminal Code or for the protection of\n        the youth, or these Terms and Conditions, Tutao can block the complete\n        service or parts of it. The right to terminate the contract without\n        notice in accordance to Clause 5.2 of these Terms and Conditions\n        remains unaffected.</p>\n    <p>11.2 The customer is not released from his obligation to pay the\n        agreed fees by a blockage. If there is a disclosure required of Tutao,\n        it is sufficient for Tutao to send the respective releases via email\n        to the email address of the customer. For the blocking and the\n        unblocking Tutao can in each case impose the agreed fee (currently\n        50,00 EUR incl. purchase tax).</p>\n    <p>11.3 Insofar as Tutao is engaged by third parties because of a culpable conduct of the customer or of a third\n        party attributable to this customer that authorizes Tutao for\n        blocking, the customer discharges Tutao from all claims and is obliged\n        to carry the costs that occurred due to the unlawful situation.</p>\n    <h4>12. Licenses</h4>\n    <p>12.1 Tutao grants the customer for the duration of the contract, a\n        simple, non-transferable, non-sublicensable right to use the required\n        software to perform the services of Tutao and their extensions for its\n        own internal use. The software is protected by copyright. Unless\n        explicitly permitted by the Copyright Act or by contract, the customer\n        may not reverse engineer, decompile or disassemble the software\n        himself or have that done by a third party.</p>\n    <h4>13. Privacy</h4>\n    <p>13.1 If provided by the customer, Tutao collects, processes and uses\n        personal data of the customer.\n        For more information on data processing and data protection\n        see the Data Privacy Statement of Tutao.</p>\n    <h4>14. Jurisdiction, law applicable</h4>\n    <p>14.1 The laws of the Federal Republic of Germany shall apply. This\n        does not affect mandatory provisions of the country in which private customers\n        who are consumers have their main residence. In all communications\n        with consumers within the European Union the law of the domicile\n        country of the consumer may also be used, provided that mandatory\n        consumer laws are applicable.</p>\n    <p>14.2 The place of jurisdiction for demands resulting from differences\n        between the parties to a contract, in particular about the conclusion of a contract,\n        its execution or its termination - insofar as the customer is a general merchant,\n        a corporate body under public law, or a separate estate under public law - is Hanover,\n        Germany. Tutao can also choose to sue the customer at his place of general jurisdiction.</p>\n    <p>14.3. The validity of the United Nations Convention on Contracts for\n        the International Sale of Goods (CISG) is excluded, even in\n        cross-border deliveries.</p>\n    <h4>15. Charging, withholding, severability clause</h4>\n    <p>15.1 The customer can only charge up against outstanding debits of Tutao\n        if these are not objected to or legally established. The customer is only\n        entitled to the enforcement of a right of retention for counterclaims that\n        result from the contractual relationship with Tutao.</p>\n    <p>15.2 In case that Clauses of these Terms and Conditions and/or the contract\n        is invalid, this does not affect the validity of the remaining Clauses.\n        The parties to a contract oblige to agree on a valid Clause - that in\n        its commercial success matches the invalid one as closely\n        as possible - to replace the invalid one.</p>\n</section>'),_export("terms_en",'\n<section id="terms-en" class="content">\n    <h3>Terms and Conditions of Tutao GmbH</h3>\n    <p>These General Terms and Conditions are provided in English for your convenience. Please note that in case of a dispute or discrepancy\n\tbetween the German Terms and Conditions and the English translation, the German version shall prevail.</em></p>\n    <p>&nbsp;</p>\n    <h4>1. General, scope</h4>\n    <p>1.1 The Tutao GmbH Address: Deisterstr. 17a, 30449 Hanover, e-mail:\n        hello@tutao.de, phone: +49 511 202801-0 (hereafter Tutao)\n        provides all deliveries and services solely on the basis of these\n        Terms and Conditions.</p>\n    <p>1.2 These Terms and Conditions apply to entrepreneurs according to § 14 BGB\n        (German Civil Code) (hereafter business customers) as wells as to consumers\n        according to § 13 BGB (German Civil Code) (hereafter private customers).\n        A consumer is any natural person entering into a legal transaction for a\n        purpose that cannot be attributed to their commercial or to their independent\n        vocational activity.</p>\n    <p>1.3 For business users these Terms and Conditions are valid for all future\n        business with Tutao.</p>\n    <p>1.4 Terms and Conditions of the business user that differ from Tutao\'s Terms and\n        Conditions completely or in parts are not recognized, unless Tutao accepts them\n        with a written statement. The Terms and Conditions of Tutao also apply exclusively\n        if Tutao unconditionally renders a service in the knowledge of conflicting Terms\n        and Conditions of the customer.</p>\n    <h4>2. Conclusion of contract</h4>\n    <p>2.1 The customer sends the request on completion of the proposed\n        contract either by dispatching an electronic statement or by\n        transmitting the order form in writing to Tutao if this is\n        offered. The contract is concluded with the allocation of an\n        account by Tutao.</p>\n    <h4>3. Notice of cancellation</h4>\n    <p>3.1 If the customer is a private customer and the contract was concluded\n        exclusively by means of distance communication (distance selling\n        contract), the private customer has the statutory right of withdrawal\n        described below:</p>\n    <hr>\n    <p><strong>Notice of cancellation</strong></p>\n    <p><strong>Right of withdrawal</strong></p>\n    <p>You have the right to cancel this contract within fourteen days\n        without giving any reason. The withdrawal period is fourteen days from\n        the date of contract. To exercise your right of cancellation, you must\n        notify us</p>\n    <p>Tutao GmbH<br>\n        Deisterstr. 17a<br>\n        30449 Hanover<br>\n        Germany</p>\n    <p>Phone: +49 511 202801-0<br>\n        Fax: +49 511 202801-19 or<br>\n        Email: hello@tutao.de</p>\n    <p>with a clear statement (eg a letter sent via post, a fax or an email)\n        of your decision to withdraw from this contract. You can use the\n        attached model withdrawal form. However this is not mandatory.</p>\n    <p>In order to observe the withdrawal period it is sufficient to send the\n        notice claiming the right of withdrawal within the withdrawal period.</p>\n    <p><strong>Results of Withdrawal</strong></p>\n    <p>If you withdraw from this contract, we have to return all payments\n        that we have received from you including delivery costs (with the\n        exception of the additional costs arising from the fact that you have\n        chosen a more expensive type of delivery other than the standard\n        delivery offered by us) which must be repaid immediately at the latest\n        within fourteen days from the date on which we have received your\n        notice of cancellation of this contract. For this repayment we use the\n        same method of payment that you have used for the initial transaction,\n        unless you explicitly agreed otherwise; in any case you will not be\n        charged fees for this repayment.</p>\n    <p>In case that you have required the services to start during the\n        withdrawal period, you have to pay us a reasonable amount compared to\n        the full extent of the service covered in this contract for the\n        service already provided to you up to the date on which you notify us\n        of the right of withdrawal of this contract.</p>\n    <p><strong>End of Notice of cancellation</strong></p>\n    <hr>\n    <p><strong>Model form for withdrawal</strong></p>\n    <p>(If you want to withdraw from the contract, you can fill in this form\n        and send it back to us.)</p>\n    <p>To<br>\n        Tutao GmbH<br>\n        Deisterstr. 17a<br>\n        30449 Hanover<br>\n        Germany</p>\n    <p>Fax: +49 511 202801-19 or<br>\n        Email: hello@tutao.de</p>\n    <p>Hereby I/we* give notice that I/we* withdraw from my/our* agreement of\n        sale of the following goods*/provision of the following service*:</p>\n    <p>Ordered on*/received on*: ______________________</p>\n    <p>Name of customer(s): ______________________</p>\n    <p>Address of customer(s): ______________________</p>\n    <p>Tutanota e-mail address of the customer(s):\n        ______________________</p>\n    <p><br>\n        Signature of customer(s) (only if sent on paper):\n        ______________________</p>\n    <p><br>\n        Date: ______________________</p>\n    <p>*) Delete as applicable.</p>\n    <hr>\n    <h4>4. Subject of the contract and alteration of the contract</h4>\n    <p>4.1 Tutao provides the customer with the system Tutanota in accordance\n        to the respective service descriptions of the selected tariff. The availability\n        is 99 % annual average, in regards to 24 hours per day, seven days per week.\n        Exempt from this availability are time periods, during which Tutanota is not\n        available due to technical or other issues that do not lie in the sphere of\n        influence of Tutao (force majeure, fault of third parties, etc.).\n        Tutao conducts a regular maintenance of the software and the system. For\n        this purpose Tutao can adjust or limit services temporarily while\n        taking into account the interests of the customer as long as objective reasons\n        justify it. If possible this work will be conducted during non-peak hours,\n        particularly Fridays to Sundays, between 10:00 pm and 06:00 am (CET). If Tutao\n        estimates that the time for maintenance and software updates will lead to a\n        downtime of more than three hours, Tutao will inform all paying customers\n        three days in advance. Tutao is only responsible for the availability if it\n        is effected by the part of the system operated by Tutao.</p>\n    <p>4.2 If in the respective service description of the selected tariff a\n        certain amount of storage space is defined, this applies to the entire\n        available storage space according to the service description and is\n        used, among other things, for the storage of metadata (file history,\n        etc.).</p>\n    <p>4.3 Tutao retains the right to extend services and make improvements\n        if these are pertinent to the technical progress, if these seem to be\n        necessary to prevent abuse, or if Tutao is required to do so by\n        law. With the consent of the customer, Tutao can conduct other changes\n        in the content of the contract, including these Terms and Conditions,\n        if the change is reasonable to the customer taking into account the\n        interests of Tutao. Particularly unacceptable is any contract change\n        that results in a reduction of a principal contractual service offered\n        by Tutao. If the alteration of the contract results in increased fees\n        payable by the customer, the admissibility of this is regulated under\n        Clause 8.5 of these Terms and Conditions. The approval of the\n        alteration of the contract is deemed as granted if the customer does\n        not object to the alteration within one month after receiving the\n        notification of the alteration. Tutao agrees to notify the customer in\n        the course of the alteration notification of the consequences of\n        non-objection.</p>\n    <p>4.4 Voluntary and unpaid services and benefits of Tutao which\n        explicitly are described as such and are not part of the service\n        description can be cancelled by Tutao at any time. Upon alterations\n        and cancellation of free services Tutao will take into account the\n        legitimate interests of the customers.</p>\n    <p>4.5 Tutao has the right to use services of third parties for the\n        service provision at any time and in any amount.</p>\n    <p>4.6 Free of charge versions of Tutanota are only allowed to be used by private customers. Business use is\n        only allowed in paid versions of Tutanota, except this is stated differently in the respective tariff.</p>\n    <p>4.7. Each natural person is prohibited to sign up for more than one free of charge Tutanota account\n        for private use. For additional accounts a paid tariff must be selected which allows adding aliases and user\n        accounts.</p>\n    <p>4.8. Tutao has the right to show its customers security notices as well as information in regards\n\t to contracts with the customers, to product updates, to Tutao GmbH, to other products and to products \n\t of partners. Partners are exclusively companies that can be recommended by Tutao GmbH because they\n\t  advocate human rights, data protection or privacy.</p>\n    <h4>5. Term of contract, contract renewal and contract termination, termination of services</h4>\n    <p>5.1 Unless stated otherwise in the respective service description, the\n        contract is effective for an indefinite time. The agreement may be\n        terminated by either party with a notice period of one month prior to the\n        end of each billing period. If the contract is not terminated, the\n        contract is automatically renewed with the same billing period.</p>\n    <p>5.2 This does not affect the right of either party to terminate the\n        contract without previous notice of a cause. A cause for Tutao is\n        particularly given if at least one of the following situations occur:\n        despite warning the customer culpably violates a contractual\n        obligation (for example against 8.4 of these Terms and Conditions),\n        despite warning the customer does not eliminate a\n        violation of contract or of law within a reasonable period of time. A warning is\n        not necessary if there is a violation that makes a continuation of the\n        contract for Tutao unreasonable.</p>\n    <p>5.3 The termination of additional options, particularly additional accounts or\n        storage space, of the respective tariff leaves the general contract\n        unaffected.</p>\n    <p>5.4 The extraordinary termination shall be effective only in writing.\n        The ordinary termination by the customer is carried out with the deletion\n        of the last administrative account within the Settings of the application.</p>\n    <p>5.5 After termination of the contract, Tutao is no longer obligated to\n        provide the contractual services. The timely storage and backup of the\n        data, is the customer\'s responsibility.</p>\n    <p>5.6. Tutao is entitled to terminate the contract without notice in case of a free of charge tariff if the account\n        was not used for at least six months.</p>\n    <h4>6. General obligations of the customer</h4>\n    <p>6.1 Business customers are obliged to state their full name and a complete\n        address required for a summons (not a post box or another anonymous\n        address). The customer assures that all data\n        communicated to Tutao are correct and complete. </p>\n    <p>6.2 Upon booking a paid version of Tutanota, private customers are\n        obliged to state the country of their current domicile.</p>\n    <p>6.3 The customer is obliged to update this information in the application as soon\n        as it changes.</p>\n    <h4>7. Email receiving and sending, ban on spam emails</h4>\n    <p>7.1 Tutao has the right to limit the maximum size of emails to be sent\n        to an appropriate size. If in the respective service description it is\n        not stated otherwise, the max. email size is 20 MB.</p>\n    <p>7.2 The sending of emails is inadmissible if it is a mass-mailing to\n        recipients without their consent and/or if it is a promotional email\n        and consent of the recipient is not given even though this is required\n        (hereafter referred to as spam). Proof of consent (see § 7 paragraph\n        2 UWG (Act Against Unfair Competition)) of each recipient rests with\n        the customer.</p>\n    <p>7.3 The customer is prohibited to send more than 100 emails per\n        hour per account or to send so-called paid emails or\n        emails that advertise a referral system.</p>\n    <h4>8. Payment and invoicing, payment increase, delay of payment, payment refund</h4>\n    <p>8.1 The amounts to be paid by the customer to Tutao and the respective\n        billing period result from the service description of the selected\n        tariff by the customer. Usage-independent fees are payable in advance\n        of the chosen billing period, usage-dependent fees are charged with an invoice.</p>\n    <p>8.2 Invoices are issued online through the electronic delivery of the\n        invoice. The invoice shall be deemed as delivered to the customer as\n        soon as it is available electronically and hence reachable for\n        him (e.g. sent to his mailbox). Tutao retains the right to send the invoice via post.\n        However it is not required that the customer\n        receives a printed invoice through the post.</p>\n    <p>8.3 The customer authorizes Tutao to collect the charges to be paid by\n        the customer from an account (e.g. banking account, credit card, PayPal)\n        specified by the customer. The customer\n        has to take care of sufficient funding in the account. If there is a chargeback caused by the\n        customer, the customer is obligated to reimburse Tutao the occurring\n        banking fees. Business customers may choose to pay on invoice.</p>\n    <p>8.4 If the customer falls behind payment for two consecutive months,\n        Tutao is entitled to terminate the contract without notice. The same\n        applies if the customer falls behind payment of an amount that reaches\n        the basic fee for two months over a period of more than two months.</p>\n    <p>8.5 Tutao is entitled to increase the fees reasonably. Considered as\n        reasonable is an annual increase to the extent of 5% at most. The fee\n        increase will be subject to the approval of the customer.\n        Tutao is obliged to notify\n        the customer of the price change (e.g. via email). The consent of the customer\n        shall be deemed as granted if the customer does not object to the\n        increase within one month of notification. If the customer contradicts the price increase, Tutao\n        has a special right of termination.</p>\n    <p>8.6 Prepaid fees are refunded to the customer if Tutao ends the contract\n        prior to the end of the billing period. In case of an effective\n        extraordinary termination (Clause 5.2) by Tutao, Tutao is entitled to receive the\n        payment of the fee until the next possible ordinary termination date.</p>\n    <h4>9. Disturbances of service</h4>\n    <p>9.1 Tutao is only responsible for disturbances of services if these\n        apply to services to be performed by Tutao referred to under Clause\n        4.1.</p>\n    <p>9.2 Tutao will eliminate disturbances according to technical and\n        operational capabilities. The customer is obliged to notify Tutao of\n        disturbances observable by him immediately (malfunction\n        information). If the disturbance is not eliminated within a\n        reasonable amount of time, the customer shall set a reasonable\n        additional respite. If the disturbance is not corrected within this\n        respite, the customer retains the right to terminate the contract or\n        to demand a reduction of the monthly fee. If the disturbance only\n        results in a deviation of the service and does not limit its\n        functionality, the customer can only demand a reduction of the\n        fee. Any claims made under Clause 10 shall remain unaffected.</p>\n    <p>9.3 In the event of force majeure Tutao is exempt from\n        liability. These include in particular lawful industrial action, also\n        in third party companies as well as regulatory measures, if not caused\n        by Tutao.</p>\n    <h4>10. Liability of Tutao</h4>\n    <p>10.1 The liability of Tutao exists solely in the context of Clauses\n        10.2 to 10.8. The following liability provisions apply to claims\n        resulting from any legal reason.</p>\n    <p>10.2 Tutao is liable to the customer for damages without limit caused\n        intentionally or by gross negligence by him or by one of its\n        assistants or legal representatives. In case of damages arising from\n        injury to life, body or health, liability is unlimited even when\n        caused by a simple breach of duty by Tutao or one of its legal\n        representatives or assistants. Similarly, the liability is unlimited\n        for damages that are due to serious organizational faults of Tutao,\n        and for damages caused by the lack of a guaranteed quality.</p>\n    <p>10.3 Unless covered by Clause 10.2, Tutao is liable for the violation\n        of essential contractual obligations; the amount of liability is\n        limited to the typically foreseeable damage. Essential contractual\n        obligations are obligations imposed on Tutao by the content of the\n        contract for achieving the purpose of the contract and the fulfillment\n        of which enable the proper execution of the contract in the first\n        place and on whose regular compliance the customer can rely on.</p>\n    <p>10.4 For data loss caused by Tutao, Tutao is only liable for the costs\n        that result from recovering of the data that would have also been lost despite\n        performing appropriate data backup measurements. A liability is limited to the liability\n        regulations of these Terms and Conditions.</p>\n    <p>10.5. The liability for any lost profit is excluded.</p>\n    <p>10.6 The liability under the Produkthaftungsgesetz\n        shall remain unaffected by the preceding liability\n        provisions. (The Product Liability Act is a German law that defines the liability of a producer of a\n        product.)</p>\n    <p>10.7 In the event that the system was provided as a free version (i.e.\n        free of charge), Tutao accepts liability in accordance with the above\n        provisions only for willful and malicious acts.</p>\n    <p>10.8 Tutao is not liable for the content or the activities of its users.</p>\n    <h4>11. Blocking, requirements of unblocking, reimbursement</h4>\n    <p>11.1 If there is a culpable conduct of the customer or of a third\n        party attributable to this customer which is violating any German law,\n        in particular provisions of the Criminal Code or for the protection of\n        the youth, or these Terms and Conditions, Tutao can block the complete\n        service or parts of it. The right to terminate the contract without\n        notice in accordance to Clause 5.2 of these Terms and Conditions\n        remains unaffected.</p>\n    <p>11.2 The customer is not released from his obligation to pay the\n        agreed fees by a blockage. If there is a disclosure required of Tutao,\n        it is sufficient for Tutao to send the respective releases via email\n        to the email address of the customer. For the blocking and the\n        unblocking Tutao can in each case impose the agreed fee (currently\n        50,00 EUR incl. purchase tax).</p>\n    <p>11.3 Insofar as Tutao is engaged by third parties because of a culpable conduct of the customer or of a third\n        party attributable to this customer that authorizes Tutao for\n        blocking, the customer discharges Tutao from all claims and is obliged\n        to carry the costs that occurred due to the unlawful situation.</p>\n    <h4>12. Licenses</h4>\n    <p>12.1 Tutao grants the customer for the duration of the contract, a\n        simple, non-transferable, non-sublicensable right to use the required\n        software to perform the services of Tutao and their extensions for its\n        own internal use. The software is protected by copyright. Unless\n        explicitly permitted by the Copyright Act or by contract, the customer\n        may not reverse engineer, decompile or disassemble the software\n        himself or have that done by a third party.</p>\n    <h4>13. Privacy</h4>\n    <p>13.1 If provided by the customer, Tutao collects, processes and uses\n        personal data of the customer.\n        For more information on data processing and data protection\n        see the Data Privacy Statement of Tutao.</p>\n    <h4>14. Jurisdiction, law applicable</h4>\n    <p>14.1 The laws of the Federal Republic of Germany shall apply. This\n        does not affect mandatory provisions of the country in which private customers\n        who are consumers have their main residence. In all communications\n        with consumers within the European Union the law of the domicile\n        country of the consumer may also be used, provided that mandatory\n        consumer laws are applicable.</p>\n    <p>14.2 The place of jurisdiction for demands resulting from differences\n        between the parties to a contract, in particular about the conclusion of a contract,\n        its execution or its termination - insofar as the customer is a general merchant,\n        a corporate body under public law, or a separate estate under public law - is Hanover,\n        Germany. Tutao can also choose to sue the customer at his place of general jurisdiction.</p>\n    <p>14.3. The validity of the United Nations Convention on Contracts for\n        the International Sale of Goods (CISG) is excluded, even in\n        cross-border deliveries.</p>\n    <h4>15. Charging, withholding, severability clause</h4>\n    <p>15.1 The customer can only charge up against outstanding debits of Tutao\n        if these are not objected to or legally established. The customer is only\n        entitled to the enforcement of a right of retention for counterclaims that\n        result from the contractual relationship with Tutao.</p>\n    <p>15.2 In case that Clauses of these Terms and Conditions and/or the contract\n        is invalid, this does not affect the validity of the remaining Clauses.\n        The parties to a contract oblige to agree on a valid Clause - that in\n        its commercial success matches the invalid one as closely\n        as possible - to replace the invalid one.</p>\n</section>'),_export("privacy_en",'<section id="privacy-en" class="content">\n    <h3>Privacy Statement of Tutao GmbH</h3>\n    <p><em>This Data Privacy Statement is provided in English for your\n        convenience. Please note that in case of a dispute or discrepancy\n        between the German Data Privacy Statement and the English translation,\n        the German version shall prevail.</em></p>\n    <p><strong>Status: May 25, 2018</strong></p>\n    <h4>General</h4>\n    <p>We are responsible for the protection of your personal data, and we\n        take this responsibility very seriously. Therefore</p>\n    <ul>\n        <li>Tutanota is based on the data privacy principles "data minimization" and "privacy by design",</li>\n        <li>all user data is stored end-to-end encrypted in Tutanota (except for email addresses of users as well as\n            senders and recipients of emails),\n        </li>\n        <li>we have technical and organizational measures in place which protect your data best possible,</li>\n        <li>all data is stored in ISO 27001 certified data centers in Germany.</li>\n    </ul>\n    <p>Processing of personal data takes place in compliance with the General Data Protection Regulation (GDPR) as well\n        as with the local data protection laws applicable to the Tutao GmbH.</p>\n    <p>We are always at your disposal for any questions about privacy. Please contact us via email:\n        hello@tutao.de.</p>\n    <h4>Name und Address of the controller</h4>\n    <p>Tutao GmbH<br>Deisterstr. 17a<br>30449 Hannover<br>Germany</p>\n    <p>Email address: hello@tutao.de</p>\n    <h4>Personal data</h4>\n    <p>All personal data is kept securely by us and thus protected from unauthorized access.</p>\n    <p>For the initiation of a contractual relationship and for service provision we collect</p>\n    <ul>\n        <li>the newly registered email address</li>\n    </ul>\n    <p>as inventory data.</p>\n    <p>For invoicing and determining the VAT we collect for paid product variants</p>\n    <ul>\n        <li>the domicile of the customer (country)</li>\n        <li>the invoicing address (for private users optional)</li>\n        <li>the VAT identification number (only for business customers of some countries)</li>\n    </ul>\n    <p>as inventory data.</p>\n    <p>For the transaction of payments we collect depending on the chosen payment method the\n        following payment data (inventory data):</p>\n    <ul>\n        <li>Banking details (account number and sort code and IBAN/BIC, if necessary bank name, account holder),</li>\n        <li>credit card data,</li>\n        <li>PayPal user name.</li>\n    </ul>\n    <p>This inventory data is processed for the performance of the contract with the customer according to Art. 6 GDPR\n        1. b). For the execution of direct debiting we will share your banking details with the authorized credit\n        institution. For the execution of PayPal payments we will share your PayPal data with PayPal (Europe).</p>\n    <ul>\n        <li>Address: PayPal (Europe) S.à r.l. et Cie, S.C.A.,22-24 Boulevard Royal, L-2449 Luxembourg</li>\n        <li>Privacy statement: <a href="https://www.paypal.com/uk/webapps/mpp/ua/privacy-prev">https://www.paypal.com/uk/webapps/mpp/ua/privacy-prev</a>\n        </li>\n        <li>Contact for questions about privacy: <a href="https://www.paypal.com/en/selfhelp/contact/email/privacy">https://www.paypal.com/en/selfhelp/contact/email/privacy</a>\n        </li>\n    </ul>\n    <p>For the execution of credit card payments your credit card data will be shared with our payment service provider\n        <a href="https://www.braintreepayments.com/">Braintree</a>. This includes the transfer of personal data into a\n        third country (USA). An agreement entered into with Braintree defines appropriate safeguards and demands that\n        the data is only processed in compliance with the GDPR and only for the purpose of execution of payments. This\n        agreement can be examined here: <a\n                href="https://www.braintreepayments.com/assets/Braintree-PSA-Model-Clauses-March2018.pdf">https://www.braintreepayments.com/assets/Braintree-PSA-Model-Clauses-March2018.pdf</a>\n    </p>\n    <p>Tutanota provides services for saving, editing, presentation and electronic transmission of data, such as email\n        service, contact management and data storage. This content data is voluntarily entered into Tutanota by the\n        customer. When signing up for a Tutanota account, you give consent to the processing of this data according to\n        Art. 6 DSGVO 1. a). All textual content is encrypted for the user and its communication partners in a way that\n        even Tutao GmbH has no access to the data. This data can be deleted by the user.</p>\n    <p>In order to maintain email server operations, for error diagnosis and for prevention of abuse, mail server logs\n        are stored max. 7 days. These logs contain sender and recipient email addresses and time of connection but no\n        customer IP addresses. Storage takes place for the purposes of the legitimate interests pursued by the\n        controller according to Art. 6 DSGVO 1. f).</p>\n    <p>In order to maintain operations, for prevention of abuse and and for visitors analysis, IP addresses of users are\n        processed. Storage only takes place for IP addresses made anonymous which are therefore not personal data any\n        more. This processing takes place for the purposes of the legitimate interests pursued by the controller\n        according to Art. 6 DSGVO 1. f).</p>\n    <p>With the exception of payment data, we will not disclose your personal data including your email address to third\n        parties. However, we can be legally bound to provide content data (in case of a valid German court order) and\n        inventory data to prosecution services. There will be no sale of data.</p>\n    <h4>Period of data storage</h4>\n    <p>The personal data shall be deleted no later than 30 days after termination of the contract,\n        unless specific reasons to the contrary\n        apply in an individual case. In case a customer objected to the amount of the charged fees,\n        the accounting data may be stored until the objections are terminally\n        clarified. Furthermore, inventory data can be stored for up to two\n        years if the handling of a complaint and other reasons require this\n        for an orderly settlement of the contract. Moreover the deletion of\n        inventory and billing data may be omitted provided that legal\n        regulations or the prosecution of claims require this. Order-related\n        data and the addresses associated with the order are stored in respect\n        to tax, contract and commercial law retention periods and erased at\n        the end of those periods.</p>\n    <h4>Rights of the data subject</h4>\n    <p>Insofar that you have given us your consent to process your personal\n        data, we would like to point out that you can withdraw your consent for\n        the future at any time. Upon request we will inform you about\n        the data we have stored about you free of charge. Please send a message with\n        your request to hello@tutao.de. In addition we are obliged to\n        delete, to correct or to restrict processing of the data stored about you upon\n        request. Additionally, you may <strong>object to the processing of your personal data</strong> as well as to\n        lodge a complaint with a supervisory authority and the federal commissioner for data privacy of Germany\n        (Husarenstr. 30, 53117 Bonn). You can make use of your right to data portability by exporting your personal data\n        stored with us in Tutanota.</p>\n    <h4>Cookies</h4>\n    <p>We do not use cookies.</p>\n    <h4>Contact from web page</h4>\n    <p>On our web pages we offer the opportunity to get in contact with us via email or contact form. In doing so\n        personal data is voluntarily transferred to us, stored automatically and only used for the purpose of dealing\n        with the request and getting in contact with the affected person. We will not disclose this personal data to\n        third parties.</p>\n</section>'),_export("privacy_en",'<section id="privacy-en" class="content">\n    <h3>Privacy Statement of Tutao GmbH</h3>\n    <p><em>This Data Privacy Statement is provided in English for your\n        convenience. Please note that in case of a dispute or discrepancy\n        between the German Data Privacy Statement and the English translation,\n        the German version shall prevail.</em></p>\n    <p><strong>Status: May 25, 2018</strong></p>\n    <h4>General</h4>\n    <p>We are responsible for the protection of your personal data, and we\n        take this responsibility very seriously. Therefore</p>\n    <ul>\n        <li>Tutanota is based on the data privacy principles "data minimization" and "privacy by design",</li>\n        <li>all user data is stored end-to-end encrypted in Tutanota (except for email addresses of users as well as\n            senders and recipients of emails),\n        </li>\n        <li>we have technical and organizational measures in place which protect your data best possible,</li>\n        <li>all data is stored in ISO 27001 certified data centers in Germany.</li>\n    </ul>\n    <p>Processing of personal data takes place in compliance with the General Data Protection Regulation (GDPR) as well\n        as with the local data protection laws applicable to the Tutao GmbH.</p>\n    <p>We are always at your disposal for any questions about privacy. Please contact us via email:\n        hello@tutao.de.</p>\n    <h4>Name und Address of the controller</h4>\n    <p>Tutao GmbH<br>Deisterstr. 17a<br>30449 Hannover<br>Germany</p>\n    <p>Email address: hello@tutao.de</p>\n    <h4>Personal data</h4>\n    <p>All personal data is kept securely by us and thus protected from unauthorized access.</p>\n    <p>For the initiation of a contractual relationship and for service provision we collect</p>\n    <ul>\n        <li>the newly registered email address</li>\n    </ul>\n    <p>as inventory data.</p>\n    <p>For invoicing and determining the VAT we collect for paid product variants</p>\n    <ul>\n        <li>the domicile of the customer (country)</li>\n        <li>the invoicing address (for private users optional)</li>\n        <li>the VAT identification number (only for business customers of some countries)</li>\n    </ul>\n    <p>as inventory data.</p>\n    <p>For the transaction of payments we collect depending on the chosen payment method the\n        following payment data (inventory data):</p>\n    <ul>\n        <li>Banking details (account number and sort code and IBAN/BIC, if necessary bank name, account holder),</li>\n        <li>credit card data,</li>\n        <li>PayPal user name.</li>\n    </ul>\n    <p>This inventory data is processed for the performance of the contract with the customer according to Art. 6 GDPR\n        1. b). For the execution of direct debiting we will share your banking details with the authorized credit\n        institution. For the execution of PayPal payments we will share your PayPal data with PayPal (Europe).</p>\n    <ul>\n        <li>Address: PayPal (Europe) S.à r.l. et Cie, S.C.A.,22-24 Boulevard Royal, L-2449 Luxembourg</li>\n        <li>Privacy statement: <a href="https://www.paypal.com/uk/webapps/mpp/ua/privacy-prev">https://www.paypal.com/uk/webapps/mpp/ua/privacy-prev</a>\n        </li>\n        <li>Contact for questions about privacy: <a href="https://www.paypal.com/en/selfhelp/contact/email/privacy">https://www.paypal.com/en/selfhelp/contact/email/privacy</a>\n        </li>\n    </ul>\n    <p>For the execution of credit card payments your credit card data will be shared with our payment service provider\n        <a href="https://www.braintreepayments.com/">Braintree</a>. This includes the transfer of personal data into a\n        third country (USA). An agreement entered into with Braintree defines appropriate safeguards and demands that\n        the data is only processed in compliance with the GDPR and only for the purpose of execution of payments. This\n        agreement can be examined here: <a\n                href="https://www.braintreepayments.com/assets/Braintree-PSA-Model-Clauses-March2018.pdf">https://www.braintreepayments.com/assets/Braintree-PSA-Model-Clauses-March2018.pdf</a>\n    </p>\n    <p>Tutanota provides services for saving, editing, presentation and electronic transmission of data, such as email\n        service, contact management and data storage. This content data is voluntarily entered into Tutanota by the\n        customer. When signing up for a Tutanota account, you give consent to the processing of this data according to\n        Art. 6 DSGVO 1. a). All textual content is encrypted for the user and its communication partners in a way that\n        even Tutao GmbH has no access to the data. This data can be deleted by the user.</p>\n    <p>In order to maintain email server operations, for error diagnosis and for prevention of abuse, mail server logs\n        are stored max. 7 days. These logs contain sender and recipient email addresses and time of connection but no\n        customer IP addresses. Storage takes place for the purposes of the legitimate interests pursued by the\n        controller according to Art. 6 DSGVO 1. f).</p>\n    <p>In order to maintain operations, for prevention of abuse and and for visitors analysis, IP addresses of users are\n        processed. Storage only takes place for IP addresses made anonymous which are therefore not personal data any\n        more. This processing takes place for the purposes of the legitimate interests pursued by the controller\n        according to Art. 6 DSGVO 1. f).</p>\n    <p>With the exception of payment data, we will not disclose your personal data including your email address to third\n        parties. However, we can be legally bound to provide content data (in case of a valid German court order) and\n        inventory data to prosecution services. There will be no sale of data.</p>\n    <h4>Period of data storage</h4>\n    <p>The personal data shall be deleted no later than 30 days after termination of the contract,\n        unless specific reasons to the contrary\n        apply in an individual case. In case a customer objected to the amount of the charged fees,\n        the accounting data may be stored until the objections are terminally\n        clarified. Furthermore, inventory data can be stored for up to two\n        years if the handling of a complaint and other reasons require this\n        for an orderly settlement of the contract. Moreover the deletion of\n        inventory and billing data may be omitted provided that legal\n        regulations or the prosecution of claims require this. Order-related\n        data and the addresses associated with the order are stored in respect\n        to tax, contract and commercial law retention periods and erased at\n        the end of those periods.</p>\n    <h4>Rights of the data subject</h4>\n    <p>Insofar that you have given us your consent to process your personal\n        data, we would like to point out that you can withdraw your consent for\n        the future at any time. Upon request we will inform you about\n        the data we have stored about you free of charge. Please send a message with\n        your request to hello@tutao.de. In addition we are obliged to\n        delete, to correct or to restrict processing of the data stored about you upon\n        request. Additionally, you may <strong>object to the processing of your personal data</strong> as well as to\n        lodge a complaint with a supervisory authority and the federal commissioner for data privacy of Germany\n        (Husarenstr. 30, 53117 Bonn). You can make use of your right to data portability by exporting your personal data\n        stored with us in Tutanota.</p>\n    <h4>Cookies</h4>\n    <p>We do not use cookies.</p>\n    <h4>Contact from web page</h4>\n    <p>On our web pages we offer the opportunity to get in contact with us via email or contact form. In doing so\n        personal data is voluntarily transferred to us, stored automatically and only used for the purpose of dealing\n        with the request and getting in contact with the affected person. We will not disclose this personal data to\n        third parties.</p>\n</section>')}}});
//# sourceMappingURL=main.js.map