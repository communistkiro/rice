#!/bin/zsh
# pape setter
pape() {
local a s c l f d;
while getopts 'h' a; do case $a in (*) 
less -F <<HEREDOC
NAME
    pape - wallpaper setter

SYNOPSIS
    pape 

DESCRIPTION
    Browse your filesystem, looking for image formats, choose one or hit enter to get a 
    random selection from current directory, change feh's background setting options with 
    'bgopt', exit when you're content. 'slide' sets random files from either current directory 
    only or recursively, and will halt on SIGINT (^C). 
    

HEREDOC
return 1;;esac; done;

a=( # feh bg options
  '--bg-center'
  '--bg-fill'
  '--bg-max'
  '--bg-scale'
  '--bg-tile'
);
setopt nonomatch;
c=~/im/wp; # starting directory
cd $c;
l=$(stty -a | head -n1 | pcre2grep -o1 'rows (\d+)');
while true; do 
  # [ -d $c ] && { f=($(ls -ap $c | pcre2grep -v '/')); d=($(ls -ap $c | pcre2grep '/' | pcre2grep -v '^\./')) };
  [ -d $c ] && { f=(*(D-^/)); [ $f[1] = '*(D-^/)' ] && f[1]=(); d=(*(D-/)); [ $d[1] = '*(D-/)' ] && d[1]=(); } ;
  c=$(printf "%s\n" '..' "${d[@]}" "${f[@]}" 'opts' 'rand' 'slide' | fzy -l $((l-1)) -p "$(pwd) ") || break;
  if [ -d $c ]; then cd $c && c=.;
  elif [ -f $c ]; then feh ${s:-${a[4]}} $c || break;
  elif [ $c = opts ]; then s=$(printf "%s\n" "${(@)a}" | fzy -l 5 -p 'options ') && feh ${s:-${a[4]}} "$(pcre2grep -o1 "'(.*)'" ~/.fehbg)";
  elif [ $c = rand ]; then feh ${s:-${a[4]}} ${f[$((RANDOM % $#f + 1))]} || break;
  elif [ $c = slide ]; then while true; do feh ${s:-${a[4]}} ${f[$((RANDOM % $#f + 1))]}; sleep .75; done;
  fi;
done;
setopt nomatch;
}